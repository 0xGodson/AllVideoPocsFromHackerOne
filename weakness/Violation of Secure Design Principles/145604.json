{"id":145604,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xNDU2MDQ=","url":"https://hackerone.com/reports/145604","title":"Avatar image upload and bypass  real image verification ","state":"Closed","substate":"informative","readable_substate":"Informative","created_at":"2016-06-18T01:50:10.608Z","submitted_at":"2016-06-18T01:50:10.608Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"dremos","url":"/dremos","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/018/998/3db17cec7563a3d33ed4fe7931996917e13998c8_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":13291,"url":"https://hackerone.com/nextcloud","handle":"nextcloud","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Nextcloud","twitter_handle":"nextclouders","website":"https://nextcloud.com","about":"Access, share and protect your files, calendars, contacts, communication \u0026 more at home and in your enterprise."}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2017-01-15T22:07:23.197Z","bug_reporter_agreed_on_going_public_at":"2017-01-15T22:07:23.165Z","team_member_agreed_on_going_public_at":"2016-06-20T21:05:12.896Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Hi\n\nWe can bypass Avatar Upload image verification and extension  uploading a php file or any other extension binding a valide  jpeg image  , there is no risk for the moment because the avatar is renamed to avatar_upload on the remote server , but it ll be nice to secure this part of code .\n\nExample  \n---------------\nhere is the same file with two different extension : \n\nhttp://91.121.108.101/image1.jpg\nhttp://91.121.108.101/image1.php      \u003c== execute php code inside the image \n\n1) download image1.jpg\n\n2) as you can see  if you open the file image1.jpg  file on notepad it hide php code ( phpinfo(); function in this case .\n\n3) rename image1.jpg to image1.php  , and try to upload it on the avatar upload form , it pass the verification  .\n\nThis verification is not enought in this  file :  /core/controller/avatarcontroller.php  \n\n\n\tif ($image-\u003evalid()) {\n\t\t\t\t$mimeType = $image-\u003emimeType();\n\t\t\t\tif ($mimeType !== 'image/jpeg' \u0026\u0026 $mimeType !== 'image/png') {\n\t\t\t\t\treturn new DataResponse(\n\t\t\t\t\t\t['data' =\u003e ['message' =\u003e $this-\u003el-\u003et('Unknown filetype')]],\n\t\t\t\t\t\tHttp::STATUS_OK,\n\t\t\t\t\t\t$headers\n\t\t\t\t\t);\n\t\t\t\t}\n\n\n","vulnerability_information_html":"\u003cp\u003eHi\u003c/p\u003e\n\n\u003cp\u003eWe can bypass Avatar Upload image verification and extension  uploading a php file or any other extension binding a valide  jpeg image  , there is no risk for the moment because the avatar is renamed to avatar_upload on the remote server , but it ll be nice to secure this part of code .\u003c/p\u003e\n\n\u003ch2 id=\"example\"\u003eExample  \u003c/h2\u003e\n\n\u003cp\u003ehere is the same file with two different extension : \u003c/p\u003e\n\n\u003cp\u003e\u003ca title=\"http://91.121.108.101/image1.jpg\" href=\"/redirect?url=http%3A%2F%2F91.121.108.101%2Fimage1.jpg\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttp://91.121.108.101/image1.jpg\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003cbr\u003e\n\u003ca title=\"http://91.121.108.101/image1.php\" href=\"/redirect?url=http%3A%2F%2F91.121.108.101%2Fimage1.php\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttp://91.121.108.101/image1.php\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e      \u0026lt;== execute php code inside the image \u003c/p\u003e\n\n\u003cp\u003e1) download image1.jpg\u003c/p\u003e\n\n\u003cp\u003e2) as you can see  if you open the file image1.jpg  file on notepad it hide php code ( phpinfo(); function in this case .\u003c/p\u003e\n\n\u003cp\u003e3) rename image1.jpg to image1.php  , and try to upload it on the avatar upload form , it pass the verification  .\u003c/p\u003e\n\n\u003cp\u003eThis verification is not enought in this  file :  /core/controller/avatarcontroller.php  \u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eif ($image-\u0026gt;valid()) {\n            $mimeType = $image-\u0026gt;mimeType();\n            if ($mimeType !== \u0026#39;image/jpeg\u0026#39; \u0026amp;\u0026amp; $mimeType !== \u0026#39;image/png\u0026#39;) {\n                return new DataResponse(\n                    [\u0026#39;data\u0026#39; =\u0026gt; [\u0026#39;message\u0026#39; =\u0026gt; $this-\u0026gt;l-\u0026gt;t(\u0026#39;Unknown filetype\u0026#39;)]],\n                    Http::STATUS_OK,\n                    $headers\n                );\n            }\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","weakness":{"id":57,"name":"Violation of Secure Design Principles"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":3,"voters":["dremos","japz","spetr0x"],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1020549,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks a lot for reporting this potential issue back to us!\n\nOur security team will take a look at this issue as soon as possible. We will reply to your report within 72 hours, usually much faster. For obvious reasons we'd like to ask you to not disclose this issue to any other party.","markdown_message":"\u003cp\u003eThanks a lot for reporting this potential issue back to us!\u003c/p\u003e\n\n\u003cp\u003eOur security team will take a look at this issue as soon as possible. We will reply to your report within 72 hours, usually much faster. For obvious reasons we\u0026#39;d like to ask you to not disclose this issue to any other party.\u003c/p\u003e\n","automated_response":true,"created_at":"2016-06-18T01:50:11.020Z","updated_at":"2016-06-18T01:50:11.020Z","actor":{"url":"/nextcloud","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Nextcloud"}},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1023154,"is_internal":false,"editable":false,"type":"Activities::BugInformative","message":"Based on your initial description, there do not appear to be any security implications as a direct result of this behavior. If you disagree, please reply with additional information describing your reasoning. Including a working proof-of-concept can be incredibly helpful in our assessment of these claims.","markdown_message":"\u003cp\u003eBased on your initial description, there do not appear to be any security implications as a direct result of this behavior. If you disagree, please reply with additional information describing your reasoning. Including a working proof-of-concept can be incredibly helpful in our assessment of these claims.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-06-19T09:54:26.480Z","updated_at":"2016-06-19T09:54:26.480Z","actor":{"username":"lukasreschke","cleared":false,"url":"/lukasreschke","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/037/891/e7fea4d5383dc07d1fe767b02f3bda2bc7639c63_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1025541,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"requested to disclose this report publicly.\nWould You Mind ?\n\n","markdown_message":"\u003cp\u003erequested to disclose this report publicly.\u003cbr\u003e\nWould You Mind ?\u003c/p\u003e\n","automated_response":false,"created_at":"2016-06-20T20:59:27.662Z","updated_at":"2016-06-20T20:59:27.662Z","actor":{"username":"dremos","cleared":false,"url":"/dremos","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/018/998/3db17cec7563a3d33ed4fe7931996917e13998c8_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1025553,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Sure.","markdown_message":"\u003cp\u003eSure.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-06-20T21:05:12.923Z","updated_at":"2016-06-20T21:05:12.923Z","first_to_agree":true,"actor":{"username":"lukasreschke","cleared":false,"url":"/lukasreschke","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/037/891/e7fea4d5383dc07d1fe767b02f3bda2bc7639c63_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1421767,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-01-15T22:07:23.182Z","updated_at":"2017-01-15T22:07:23.182Z","actor":{"username":"dremos","cleared":false,"url":"/dremos","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/018/998/3db17cec7563a3d33ed4fe7931996917e13998c8_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1421768,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-01-15T22:07:23.211Z","updated_at":"2017-01-15T22:07:23.211Z","actor":{"username":"dremos","cleared":false,"url":"/dremos","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/018/998/3db17cec7563a3d33ed4fe7931996917e13998c8_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}