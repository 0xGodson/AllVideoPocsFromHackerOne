{"id":137756,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xMzc3NTY=","url":"https://hackerone.com/reports/137756","title":"Cache poisoning for okhttp ","state":"Closed","substate":"informative","readable_substate":"Informative","created_at":"2016-05-11T06:54:13.587Z","submitted_at":"2016-05-11T06:54:13.587Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"nvolcz","url":"/nvolcz","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/075/752/192d7bf6824fa46dd0ac2500c99efa3463dc5172_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":1644,"url":"https://hackerone.com/square-open-source","handle":"square-open-source","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/001/644/902e831617282e2da7c1cb7aeecf24117b9004a5_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/001/644/902e831617282e2da7c1cb7aeecf24117b9004a5_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Square Open Source","twitter_handle":"SquareEng","website":"https://github.com/square","about":""}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2016-08-31T04:05:23.772Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2016-07-15T17:06:17.503Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"If an attacker can control the Host header this can be used to poison the cache. This becomes extra dangerous if the library were to be used to build a caching proxy.","vulnerability_information_html":"\u003cp\u003eIf an attacker can control the Host header this can be used to poison the cache. This becomes extra dangerous if the library were to be used to build a caching proxy.\u003c/p\u003e\n","weakness":{"id":57,"name":"Violation of Secure Design Principles"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":92688,"file_name":"Cache_poisoning_for_okhttp.pdf","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/092/688/715ff0d00db04a33a88733a4c9aeeb2f7a59a4c7/Cache_poisoning_for_okhttp.pdf?response-content-disposition=attachment%3B%20filename%3D%22Cache_poisoning_for_okhttp.pdf%22%3B%20filename%2A%3DUTF-8%27%27Cache_poisoning_for_okhttp.pdf\u0026response-content-type=application%2Fpdf\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQWS7SVX5C%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T042659Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCICTltBX5kZS78yzw3IUUt%2Fa035OzgQ2vLu8U1ZxOKGilAiEAqT8jxmclsgLwaEL5fi7C70iqLwP7J3SWF5ypfn%2Fn%2BdUqtAMIVBABGgwwMTM2MTkyNzQ4NDkiDGRWkSc4Hmgq8mMXKCqRA0Pq%2Bzgh6dptjyRB4GzYO9sir45RVm0RyvFSB8lDBYTBiDIVL0nR3Ah5epkHqGDZZEh0G%2BfKYu%2FWpfgxJl7qllLzKg%2BOA0izVs9KPgQdxk0VWwW%2FPKL2ZT4v%2FSNRvF7rPUbZ7WhGTZqx0%2BinzKM%2BO6lDyXZKNKMzhjRnIFdI7Th01c4ma39imTXQDmxc%2FNzHFK40lrkAbTZoTlcq%2BsnIcIRSB0h4GHasXhR5OHx8rifULR7sVKHDcZMCzSYjrtagaKs9I81LEzlSbEGxIQar2MK%2BZBwmpT57aT%2F1nIOoa%2FlH5nfP4Ihcv4Mqfp19pFx8mlVoMe%2FTEx0pqNuC4lGQXowSDJKBcSjrYM6ouddZWfwY6R4O8X69XqZawGSrmBiXyAVG%2BDj895xbDJhiOXMvqkvSfsEzIfvcaHAzshzNZjFT3yiN4h81wfUF3QuLc6DHCTt1MPDYiUB8I7UCQ8wJxW4pg3xTnHqSwUeqww3YY8RFfsgvfp9PzGJ1s4vReFrzuzYVanpT22oz4w33z29yMPmMMO21qv8FOusBOsYr4rmEPt9wYTc2WNI63vM9u2VUhGNHafH2%2Fh3q6i%2BwJ0u2HLCQd44aqHfWZ%2Bc8hzInEQnRNrZf7owYuE4cHiraWaOsNJjfOEJBZu5nzzun4JSk7801NfOqa1zcgLMWOwyWJCtalb9fGn6qhwTWTBMzsOFHc661yyW%2FaqejCIRf6%2BwNOGhO8kc%2BEhEIq0iydp5k4rlMRKlFJPFlphrQYGeZgYr9TM%2FVgHlN%2Bx4Oxtcg1UwCGXMGiV%2BqXzeMEmO%2FdxKETdJJvF%2BEaJSsF0r1i7s8g61czrgyi9MKMpia%2Fg6ovVFkrvHOejV96g%3D%3D\u0026X-Amz-Signature=9abc5df9cbc364772e14e92f579f880455c2cec5bfbc64a71ad0e11feacb24ad","file_size":454873,"type":"application/pdf"}],"allow_singular_disclosure_at":null,"vote_count":1,"voters":["dyabla"],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":951395,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for your report. Could you elaborate on how this affects actual users of the library? Note that OkHttp is a client-side library only, and is not meant for server implementations. ","markdown_message":"\u003cp\u003eThank you for your report. Could you elaborate on how this affects actual users of the library? Note that OkHttp is a client-side library only, and is not meant for server implementations. \u003c/p\u003e\n","automated_response":false,"created_at":"2016-05-11T18:33:11.360Z","updated_at":"2016-05-11T18:33:11.360Z","actor":{"username":"css","cleared":false,"url":"/css","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/008/658/c79df8b4265e62f73fa43e0fdd2eec7eb0acf62f_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"square-open-source","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":952774,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Certainly! I'm fully aware that this is only a client-side library and this exploit heavily depends on how the library is used. That said I still believe that a modern HTTP library like okhttp should prevent this kind of usage.\nThis finding assumes that the attacker has some way to inject arbitrary header or manipulate the Host header in the client. This is quite common to my understanding, ex. https://cwe.mitre.org/data/definitions/113.html.\nAssuming this:\n1. An attacker inject his own malicious domain into the host header\n2. The server will respond will (in most cases) respond with a HTTP Perm move to the evil domain\n3. The library will follow the redirect and cache the response (haven't research if the path itself is cached)\n4. All following request (w/o the evil host header) to the good site will hit the cache for the evil domain\n\nThe problem lies in that the client does not error when there is an missmatch between the domains in the URL and host header.","markdown_message":"\u003cp\u003eCertainly! I\u0026#39;m fully aware that this is only a client-side library and this exploit heavily depends on how the library is used. That said I still believe that a modern HTTP library like okhttp should prevent this kind of usage.\u003cbr\u003e\nThis finding assumes that the attacker has some way to inject arbitrary header or manipulate the Host header in the client. This is quite common to my understanding, ex. \u003ca title=\"https://cwe.mitre.org/data/definitions/113.html\" href=\"/redirect?url=https%3A%2F%2Fcwe.mitre.org%2Fdata%2Fdefinitions%2F113.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://cwe.mitre.org/data/definitions/113.html\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003cbr\u003e\nAssuming this:\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003eAn attacker inject his own malicious domain into the host header\u003c/li\u003e\n\u003cli\u003eThe server will respond will (in most cases) respond with a HTTP Perm move to the evil domain\u003c/li\u003e\n\u003cli\u003eThe library will follow the redirect and cache the response (haven\u0026#39;t research if the path itself is cached)\u003c/li\u003e\n\u003cli\u003eAll following request (w/o the evil host header) to the good site will hit the cache for the evil domain\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eThe problem lies in that the client does not error when there is an missmatch between the domains in the URL and host header.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-05-12T10:02:53.012Z","updated_at":"2016-05-12T10:02:53.012Z","actor":{"username":"nvolcz","cleared":false,"url":"/nvolcz","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/075/752/192d7bf6824fa46dd0ac2500c99efa3463dc5172_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"square-open-source","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":952929,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"OkHttpClient instances should not be shared between mutually-distrusting applications. There are several places where we’ve made decisions to improve performance, to make the API easier, or simplify our implementation that depend on this assumption.\n\nI’m aware of no users that use OkHttp in this way. Attempting to harden it for this use case makes other things worse. For example, there are developers who currently use the Host header override to work-around DNS problems.\n\nMy preference is to improve our documentation to emphasize that this code is not designed to work with hostile-callers.","markdown_message":"\u003cp\u003eOkHttpClient instances should not be shared between mutually-distrusting applications. There are several places where we’ve made decisions to improve performance, to make the API easier, or simplify our implementation that depend on this assumption.\u003c/p\u003e\n\n\u003cp\u003eI’m aware of no users that use OkHttp in this way. Attempting to harden it for this use case makes other things worse. For example, there are developers who currently use the Host header override to work-around DNS problems.\u003c/p\u003e\n\n\u003cp\u003eMy preference is to improve our documentation to emphasize that this code is not designed to work with hostile-callers.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-05-12T11:26:01.339Z","updated_at":"2016-05-12T11:26:01.339Z","actor":{"username":"jessewilson","cleared":false,"url":"/jessewilson","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"square-open-source","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":958735,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I see what you are saying and I can agree that this scenario is unlikely. But a library cannot assume that all the users understand these security implications. It happened to SquidProxy, it could very well happen to a okhttp user. Another example is the JDBC API, it was assumed that input was to be verified before passed on, but in reality most developers don't have time to reflect on this kind of documentation.\nI believe that the performance impact of adding security checks is a non issue and the API would not have to be changed. \nCould you expand on how the Host header is used to work around DNS problems? Does it rely on servers responding with HTTP Perm move?","markdown_message":"\u003cp\u003eI see what you are saying and I can agree that this scenario is unlikely. But a library cannot assume that all the users understand these security implications. It happened to SquidProxy, it could very well happen to a okhttp user. Another example is the JDBC API, it was assumed that input was to be verified before passed on, but in reality most developers don\u0026#39;t have time to reflect on this kind of documentation.\u003cbr\u003e\nI believe that the performance impact of adding security checks is a non issue and the API would not have to be changed. \u003cbr\u003e\nCould you expand on how the Host header is used to work around DNS problems? Does it rely on servers responding with HTTP Perm move?\u003c/p\u003e\n","automated_response":false,"created_at":"2016-05-16T08:41:09.452Z","updated_at":"2016-05-16T08:41:09.452Z","actor":{"username":"nvolcz","cleared":false,"url":"/nvolcz","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/075/752/192d7bf6824fa46dd0ac2500c99efa3463dc5172_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"square-open-source","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1041833,"is_internal":false,"editable":false,"type":"Activities::BugInformative","message":"Thank you for taking the time to report this @nvolcz, but we've decided to leave the API as it is for now. ","markdown_message":"\u003cp\u003eThank you for taking the time to report this \u003ca href=\"/nvolcz\"\u003e@nvolcz\u003c/a\u003e, but we\u0026#39;ve decided to leave the API as it is for now. \u003c/p\u003e\n","automated_response":false,"created_at":"2016-06-27T21:51:45.065Z","updated_at":"2016-06-27T21:51:45.065Z","actor":{"username":"css","cleared":false,"url":"/css","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/008/658/c79df8b4265e62f73fa43e0fdd2eec7eb0acf62f_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"square-open-source","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1055484,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"What are the terms about posting about this \"information\" publicly? I would very much like to post this to my own blog :-)","markdown_message":"\u003cp\u003eWhat are the terms about posting about this \u0026quot;information\u0026quot; publicly? I would very much like to post this to my own blog :-)\u003c/p\u003e\n","automated_response":false,"created_at":"2016-07-06T12:08:33.955Z","updated_at":"2016-07-06T12:08:33.955Z","actor":{"username":"nvolcz","cleared":false,"url":"/nvolcz","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/075/752/192d7bf6824fa46dd0ac2500c99efa3463dc5172_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"square-open-source","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1070856,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Feel free to post this information on your blog. Telling your readers about our libraries sharp edges might help them write better code.","markdown_message":"\u003cp\u003eFeel free to post this information on your blog. Telling your readers about our libraries sharp edges might help them write better code.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-07-15T17:06:17.539Z","updated_at":"2016-07-15T17:06:17.539Z","first_to_agree":true,"actor":{"username":"alokmenghrajani","cleared":false,"url":"/alokmenghrajani","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/008/663/15433a8e00b4c83f236ae346eb728c7c2dc5ce1d_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"square-open-source","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1099571,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for the collaboration. It has been an pleasant experience.","markdown_message":"\u003cp\u003eThank you for the collaboration. It has been an pleasant experience.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-08-01T13:13:01.235Z","updated_at":"2016-08-01T13:13:01.235Z","actor":{"username":"nvolcz","cleared":false,"url":"/nvolcz","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/075/752/192d7bf6824fa46dd0ac2500c99efa3463dc5172_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"square-open-source","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1163927,"is_internal":false,"editable":false,"type":"Activities::ManuallyDisclosed","message":"","markdown_message":"","automated_response":false,"created_at":"2016-08-31T04:05:23.669Z","updated_at":"2016-08-31T04:05:23.669Z","actor":{"username":"css","cleared":false,"url":"/css","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/008/658/c79df8b4265e62f73fa43e0fdd2eec7eb0acf62f_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"square-open-source","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}