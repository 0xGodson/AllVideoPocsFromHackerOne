{"id":396493,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8zOTY0OTM=","url":"https://hackerone.com/reports/396493","title":"Reflected DOM XSS on www.starbucks.co.uk","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2018-08-17T11:25:53.034Z","submitted_at":"2018-08-17T11:25:53.034Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"bayotop","url":"/bayotop","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/036/633/10a34b6ba8511f5ae6c9664bafcd04aeb25982f8_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":1989,"url":"https://hackerone.com/starbucks","handle":"starbucks","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/001/989/c9aa38cf3b1a91daa085d31e23d23f34cd1874df_original./3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/001/989/c9aa38cf3b1a91daa085d31e23d23f34cd1874df_original./eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Starbucks","twitter_handle":"Starbucks","website":"http://www.starbucks.com","about":"Inspiring and nurturing the human spirit -- one person, one cup, one neighborhood at a time."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2020-06-16T21:21:07.555Z","bug_reporter_agreed_on_going_public_at":"2020-05-22T13:39:52.031Z","team_member_agreed_on_going_public_at":"2020-06-16T21:21:07.452Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"**Summary:**\n\n`www.starbucks.co.uk` is vulnerable to reflected DOM XSS due to 2 seemingly unexploitable issues. The first issue is unfixed for over a year now, #252908, the second issue originates in a 3rd party module called prettyPhoto. \n\n**Description:**\n\nVisiting the following link results in a JavaScript alert (use Firefox or Edge, Chrome's XSS Auditor blocks this particular payload):\n\n`https://www.starbucks.co.uk/shop/card/egift/thank-you/anything%2522onclick=%2522confirm(document.domain)#!\\'\\,\\*\\,/1`\n\nThis is possible because:\n\n1. there is a seemingly harmless HTML attribute injection into a `\u003clink rel=\"canonical\"\u003e` element (unfixed for over a year, see #252908) and\n2. the prettyPhoto JavaScript module allows to trigger the `click` event on any existing HTML element.\n\nThe following is done by prettyPhoto in https://www.starbucks.com/static/resource/shop_js/676938998_en-US:\n\n```js\nfunction d() {\n  url = location.href;\n  hashtag = (url.indexOf(\"#!\") != -1) ? decodeURI(url.substring(url.indexOf(\"#!\") + 2, url.length)) : false;\n  return hashtag\n}\n\nhashIndex = d();\nhashRel = hashIndex;\nhashIndex = hashIndex.substring(hashIndex.indexOf(\"/\") + 1, hashIndex.length - 1);\nhashRel = hashRel.substring(0, hashRel.indexOf(\"/\"));\nhashIndex = parseInt(hashIndex);\nhashRel = hashRel.replace(/([ #;\u0026,.+*~\\':\"!^$[\\]()=\u003e|\\/])/g, \"\\\\$1\");\nsetTimeout(function() {\n  b(\"a[rel^='\" + hashRel + \"']:eq(\" + hashIndex + \")\").trigger(\"click\")\n}, 50)\n```\n\nNotice how the user-controlled `hashRel` variable is [sanitized to prevent DOM XSS](https://www.saotn.org/prettyphoto-dom-based-xss/#how-to-fix-prettyphoto-dom-based-xss) in a quite obscure manner. It only works because it prefixes `=` with a `\\` ruining all standard DOM XSS payloads known to me. Also notice that `\\` is **not** escaped which means that it's possible to inject arbitrary valid jQuery selectors.\n\nCombining these two issues makes it possible to execute arbitrary JavaScript, by injecting an `onclick` HTML attribute into the `\u003clink rel=\"canonical\"\u003e` element and triggering it via the prettyPhoto JavaScript module by setting `hashRel` to `\\'\\,\\*\\,`. Due to the used jQuery version and it's lax parsing the following triggers the `click` event on all existing elements:\n\n```js\n$(\"a[rel^='\\\\\\\\'\\\\\\\\,\\\\\\\\*\\\\\\\\,']:eq(NaN)\").trigger(\"click\")\n```\n\n**Steps To Reproduce:**\n\nTested on latest Firefox and Edge:\n\n1. `https://www.starbucks.co.uk/shop/card/egift/thank-you/anything%2522onclick=%2522confirm(document.domain)#!\\'\\,\\*\\,/1`\n\n**Recommendation:**\n\nRegarding the HTML attribute injection I suggested a fix in #252908. Regarding prettyPhoto, I don't believe it's actively maintained anymore so a customization will be necessary in my opinion. White-listing allowed characters in `hashRel` is the way to go with something like `\\w+`.\n\n## Impact\n\nAttackers can execute arbitrary JavaScript in the victims' browsing context by tricking them into visiting an URL under the attackers' control. I believe you are aware of the dangers of XSS, but I am more then happy to show an actual exploit if needed.","vulnerability_information_html":"\u003cp\u003e\u003cstrong\u003eSummary:\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003ewww.starbucks.co.uk\u003c/code\u003e is vulnerable to reflected DOM XSS due to 2 seemingly unexploitable issues. The first issue is unfixed for over a year now, \u003ca href=\"/reports/252908\"\u003e#252908\u003c/a\u003e, the second issue originates in a 3rd party module called prettyPhoto. \u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eDescription:\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eVisiting the following link results in a JavaScript alert (use Firefox or Edge, Chrome\u0026#39;s XSS Auditor blocks this particular payload):\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003ehttps://www.starbucks.co.uk/shop/card/egift/thank-you/anything%2522onclick=%2522confirm(document.domain)#!\\\u0026#39;\\,\\*\\,/1\u003c/code\u003e\u003c/p\u003e\n\n\u003cp\u003eThis is possible because:\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003ethere is a seemingly harmless HTML attribute injection into a \u003ccode\u003e\u0026lt;link rel=\u0026quot;canonical\u0026quot;\u0026gt;\u003c/code\u003e element (unfixed for over a year, see \u003ca href=\"/reports/252908\"\u003e#252908\u003c/a\u003e) and\u003c/li\u003e\n\u003cli\u003ethe prettyPhoto JavaScript module allows to trigger the \u003ccode\u003eclick\u003c/code\u003e event on any existing HTML element.\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eThe following is done by prettyPhoto in \u003ca title=\"https://www.starbucks.com/static/resource/shop_js/676938998_en-US:\" href=\"/redirect?url=https%3A%2F%2Fwww.starbucks.com%2Fstatic%2Fresource%2Fshop_js%2F676938998_en-US%3A\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://www.starbucks.com/static/resource/shop_js/676938998_en-US:\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight javascript\"\u003e\u003ccode\u003e\u003cspan class=\"kd\"\u003efunction\u003c/span\u003e \u003cspan class=\"nx\"\u003ed\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003eurl\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003elocation\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ehref\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003ehashtag\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eurl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eindexOf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003e#!\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"nb\"\u003edecodeURI\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eurl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003esubstring\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eurl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eindexOf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003e#!\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eurl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003elength\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003ehashtag\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"nx\"\u003ehashIndex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ed\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"nx\"\u003ehashRel\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ehashIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"nx\"\u003ehashIndex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ehashIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003esubstring\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ehashIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eindexOf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003e/\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ehashIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003elength\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"nx\"\u003ehashRel\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ehashRel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003esubstring\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ehashRel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eindexOf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003e/\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003cspan class=\"nx\"\u003ehashIndex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eparseInt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ehashIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"nx\"\u003ehashRel\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ehashRel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ereplace\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"sr\"\u003e/\u003c/span\u003e\u003cspan class=\"se\"\u003e([\u003c/span\u003e\u003cspan class=\"sr\"\u003e #;\u0026amp;,.+*~\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#39;\u003c/span\u003e\u003cspan class=\"sr\"\u003e:\u0026quot;!^$[\u003c/span\u003e\u003cspan class=\"se\"\u003e\\]\u003c/span\u003e\u003cspan class=\"sr\"\u003e()=\u0026gt;|\u003c/span\u003e\u003cspan class=\"se\"\u003e\\/])\u003c/span\u003e\u003cspan class=\"sr\"\u003e/g\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\\\u003c/span\u003e\u003cspan class=\"s2\"\u003e$1\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"nx\"\u003esetTimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003efunction\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003ea[rel^=\u0026#39;\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003ehashRel\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#39;]:eq(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003ehashIndex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003e)\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nx\"\u003etrigger\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003eclick\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"mi\"\u003e50\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eNotice how the user-controlled \u003ccode\u003ehashRel\u003c/code\u003e variable is \u003ca href=\"/redirect?url=https%3A%2F%2Fwww.saotn.org%2Fprettyphoto-dom-based-xss%2F%23how-to-fix-prettyphoto-dom-based-xss\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003esanitized to prevent DOM XSS\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e in a quite obscure manner. It only works because it prefixes \u003ccode\u003e=\u003c/code\u003e with a \u003ccode\u003e\\\u003c/code\u003e ruining all standard DOM XSS payloads known to me. Also notice that \u003ccode\u003e\\\u003c/code\u003e is \u003cstrong\u003enot\u003c/strong\u003e escaped which means that it\u0026#39;s possible to inject arbitrary valid jQuery selectors.\u003c/p\u003e\n\n\u003cp\u003eCombining these two issues makes it possible to execute arbitrary JavaScript, by injecting an \u003ccode\u003eonclick\u003c/code\u003e HTML attribute into the \u003ccode\u003e\u0026lt;link rel=\u0026quot;canonical\u0026quot;\u0026gt;\u003c/code\u003e element and triggering it via the prettyPhoto JavaScript module by setting \u003ccode\u003ehashRel\u003c/code\u003e to \u003ccode\u003e\\\u0026#39;\\,\\*\\,\u003c/code\u003e. Due to the used jQuery version and it\u0026#39;s lax parsing the following triggers the \u003ccode\u003eclick\u003c/code\u003e event on all existing elements:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight javascript\"\u003e\u003ccode\u003e\u003cspan class=\"nx\"\u003e$\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003ea[rel^=\u0026#39;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\\\\\\\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\\\\\\\u003c/span\u003e\u003cspan class=\"s2\"\u003e,\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\\\\\\\u003c/span\u003e\u003cspan class=\"s2\"\u003e*\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\\\\\\\u003c/span\u003e\u003cspan class=\"s2\"\u003e,\u0026#39;]:eq(NaN)\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nx\"\u003etrigger\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003eclick\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003eSteps To Reproduce:\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eTested on latest Firefox and Edge:\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003ehttps://www.starbucks.co.uk/shop/card/egift/thank-you/anything%2522onclick=%2522confirm(document.domain)#!\\\u0026#39;\\,\\*\\,/1\u003c/code\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e\u003cstrong\u003eRecommendation:\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eRegarding the HTML attribute injection I suggested a fix in \u003ca href=\"/reports/252908\"\u003e#252908\u003c/a\u003e. Regarding prettyPhoto, I don\u0026#39;t believe it\u0026#39;s actively maintained anymore so a customization will be necessary in my opinion. White-listing allowed characters in \u003ccode\u003ehashRel\u003c/code\u003e is the way to go with something like \u003ccode\u003e\\w+\u003c/code\u003e.\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eAttackers can execute arbitrary JavaScript in the victims\u0026#39; browsing context by tricking them into visiting an URL under the attackers\u0026#39; control. I believe you are aware of the dangers of XSS, but I am more then happy to show an actual exploit if needed.\u003c/p\u003e\n","bounty_amount":"250.0","formatted_bounty":"$250","weakness":{"id":61,"name":"Cross-site Scripting (XSS) - Reflected"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2020-06-21T13:39:52.101Z","allow_singular_disclosure_after":-16474249.142551405,"singular_disclosure_allowed":true,"vote_count":11,"voters":["wh0ru","brahim_boufakri01","e4366eolywrgpidfbio","mygf","leonishan","d4rkm4tter","potatosalad420","user923413253","mideno","komic_sans","and 1 more..."],"severity":{"rating":"medium","author_type":"User"},"structured_scope":{"databaseId":13017,"asset_type":"URL","asset_identifier":"www.starbucks.co.uk","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":3213734,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @bayotop,\n\nThank you for your submission. We have received your report.\n\nBest regards,\n@thefrog\n\nSecurity Analyst\n**HackerOne**","markdown_message":"\u003cp\u003eHi \u003ca href=\"/bayotop\"\u003e@bayotop\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eThank you for your submission. We have received your report.\u003c/p\u003e\n\n\u003cp\u003eBest regards,\u003cbr\u003e\n\u003ca href=\"/thefrog\"\u003e@thefrog\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eSecurity Analyst\u003cbr\u003e\n\u003cstrong\u003eHackerOne\u003c/strong\u003e\u003c/p\u003e\n","automated_response":false,"created_at":"2018-08-18T11:54:24.131Z","updated_at":"2018-08-18T11:54:24.131Z","actor":{"username":"thefrog","cleared":false,"url":"/thefrog","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/246/015/2eead02646771af4df7aa20c21edb7d5dc99d3da_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"starbucks","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3222819,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Hi @bayotop, Thank you for your report. We are working with our internal team to prioritize the fix for  #252908 and will be working with the team for this XSS new issue on prettyPhoto javascript module. We will get back once we receive an update on either of the above issues. Thanks much for your patience and for your report.\n\n@ristretto","markdown_message":"\u003cp\u003eHi \u003ca href=\"/bayotop\"\u003e@bayotop\u003c/a\u003e, Thank you for your report. We are working with our internal team to prioritize the fix for  \u003ca href=\"/reports/252908\"\u003e#252908\u003c/a\u003e and will be working with the team for this XSS new issue on prettyPhoto javascript module. We will get back once we receive an update on either of the above issues. Thanks much for your patience and for your report.\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"/ristretto\"\u003e@ristretto\u003c/a\u003e\u003c/p\u003e\n","automated_response":false,"created_at":"2018-08-20T22:21:33.889Z","updated_at":"2018-08-20T22:21:33.889Z","actor":{"username":"ristretto","cleared":false,"url":"/ristretto","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"starbucks","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3222822,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2018-08-20T22:22:27.458Z","updated_at":"2018-08-20T22:22:27.458Z","actor":{"url":"/starbucks","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/001/989/c9aa38cf3b1a91daa085d31e23d23f34cd1874df_original./eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Starbucks"}},"bounty_amount":"250.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"starbucks","collaborator":{"username":"bayotop","url":"/bayotop"},"actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4238399,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @bayotop,\n\nAre you still able to repro this issue? To me, it looks like the WAF is picking up and blocking the encoded quotes, but I'm having a hard time confirming whether the root cause has been fixed (I expect not).\n\nThanks,\n@shadegrown ","markdown_message":"\u003cp\u003eHi \u003ca href=\"/bayotop\"\u003e@bayotop\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eAre you still able to repro this issue? To me, it looks like the WAF is picking up and blocking the encoded quotes, but I\u0026#39;m having a hard time confirming whether the root cause has been fixed (I expect not).\u003c/p\u003e\n\n\u003cp\u003eThanks,\u003cbr\u003e\n\u003ca href=\"/shadegrown\"\u003e@shadegrown\u003c/a\u003e \u003c/p\u003e\n","automated_response":false,"created_at":"2019-03-01T20:20:53.432Z","updated_at":"2019-03-01T20:20:53.432Z","actor":{"username":"shadegrown","cleared":false,"url":"/shadegrown","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/241/256/c58560470742940abd59de20f14746b5f8b2dcd2_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"starbucks","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4300422,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @shadegrown,\n\nNone of the root causes is fixed. You can verify that the injection in the link element is still possible via: `https://www.starbucks.co.uk/shop/card/egift/thank-you/anything%2522`. The vulnerable `prettyPhoto` module is still there too. \n\nThe PoC is no longer working because the WAF is now triggering on `onclick=` in the path. This seems like a typical Starbucks fix :)\n\nFeel free to close this as resolved if you want (this was done in the past and I would submit a bypass as a new issue). If the team (hey Starbucks!) feels like fixing the root cause instead, please let me know. Thanks! ","markdown_message":"\u003cp\u003eHi \u003ca href=\"/shadegrown\"\u003e@shadegrown\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eNone of the root causes is fixed. You can verify that the injection in the link element is still possible via: \u003ccode\u003ehttps://www.starbucks.co.uk/shop/card/egift/thank-you/anything%2522\u003c/code\u003e. The vulnerable \u003ccode\u003eprettyPhoto\u003c/code\u003e module is still there too. \u003c/p\u003e\n\n\u003cp\u003eThe PoC is no longer working because the WAF is now triggering on \u003ccode\u003eonclick=\u003c/code\u003e in the path. This seems like a typical Starbucks fix :)\u003c/p\u003e\n\n\u003cp\u003eFeel free to close this as resolved if you want (this was done in the past and I would submit a bypass as a new issue). If the team (hey Starbucks!) feels like fixing the root cause instead, please let me know. Thanks! \u003c/p\u003e\n","automated_response":false,"created_at":"2019-03-11T14:23:37.873Z","updated_at":"2019-03-11T14:23:37.873Z","actor":{"username":"bayotop","cleared":false,"url":"/bayotop","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/036/633/10a34b6ba8511f5ae6c9664bafcd04aeb25982f8_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"starbucks","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4643627,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @shadegrown, \n\nI was playing around with the current state and found a bypass eventually (Firefox):\n\n`https://www.starbucks.co.uk/shop/card/egift/thank-you/anything%2522on%2563lick=%2522confirm(document.domain)#!\\'\\,\\*\\,/1`\n \nThought I'd share it right away as a new issue doesn't really make sense in my opinion. Happy to add more information if you need any. ","markdown_message":"\u003cp\u003eHi \u003ca href=\"/shadegrown\"\u003e@shadegrown\u003c/a\u003e, \u003c/p\u003e\n\n\u003cp\u003eI was playing around with the current state and found a bypass eventually (Firefox):\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003ehttps://www.starbucks.co.uk/shop/card/egift/thank-you/anything%2522on%2563lick=%2522confirm(document.domain)#!\\\u0026#39;\\,\\*\\,/1\u003c/code\u003e\u003c/p\u003e\n\n\u003cp\u003eThought I\u0026#39;d share it right away as a new issue doesn\u0026#39;t really make sense in my opinion. Happy to add more information if you need any. \u003c/p\u003e\n","automated_response":false,"created_at":"2019-04-25T18:14:43.146Z","updated_at":"2019-04-25T18:14:43.146Z","actor":{"username":"bayotop","cleared":false,"url":"/bayotop","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/036/633/10a34b6ba8511f5ae6c9664bafcd04aeb25982f8_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"starbucks","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4812617,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@bayotop I'm still not able to reproduce the issue. Can you please check if you can still repro the issue ?","markdown_message":"\u003cp\u003e\u003ca href=\"/bayotop\"\u003e@bayotop\u003c/a\u003e I\u0026#39;m still not able to reproduce the issue. Can you please check if you can still repro the issue ?\u003c/p\u003e\n","automated_response":false,"created_at":"2019-05-10T22:10:22.388Z","updated_at":"2019-05-10T22:10:22.388Z","actor":{"username":"nitrobr3w","cleared":false,"url":"/nitrobr3w","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"starbucks","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4812705,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @nitrobr3w,\n\nSeems that one of the root causes is fixed: `%2522` is no longer included back in the response as `\"` (the reflected URL is being trimmed). This implies that #252908 isn't reproducible either. For the sake of completeness, I'll have to mention that the vulnerable prettyPhoto library is still being used.","markdown_message":"\u003cp\u003eHi \u003ca href=\"/nitrobr3w\"\u003e@nitrobr3w\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eSeems that one of the root causes is fixed: \u003ccode\u003e%2522\u003c/code\u003e is no longer included back in the response as \u003ccode\u003e\u0026quot;\u003c/code\u003e (the reflected URL is being trimmed). This implies that \u003ca href=\"/reports/252908\"\u003e#252908\u003c/a\u003e isn\u0026#39;t reproducible either. For the sake of completeness, I\u0026#39;ll have to mention that the vulnerable prettyPhoto library is still being used.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-05-10T22:41:24.821Z","updated_at":"2019-05-10T22:42:58.697Z","actor":{"username":"bayotop","cleared":false,"url":"/bayotop","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/036/633/10a34b6ba8511f5ae6c9664bafcd04aeb25982f8_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"starbucks","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5019375,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Hi @bayotop,\n\nThanks for hanging in there with us on this one! We really appreciate your patience. We have validated the fix and can no longer reproduce the issue, so I'm going to close this as resolved.\n\nThank you again for the report!\n@shadegrown ","markdown_message":"\u003cp\u003eHi \u003ca href=\"/bayotop\"\u003e@bayotop\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eThanks for hanging in there with us on this one! We really appreciate your patience. We have validated the fix and can no longer reproduce the issue, so I\u0026#39;m going to close this as resolved.\u003c/p\u003e\n\n\u003cp\u003eThank you again for the report!\u003cbr\u003e\n\u003ca href=\"/shadegrown\"\u003e@shadegrown\u003c/a\u003e \u003c/p\u003e\n","automated_response":false,"created_at":"2019-06-06T20:31:33.068Z","updated_at":"2019-06-06T20:31:33.068Z","actor":{"username":"shadegrown","cleared":false,"url":"/shadegrown","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/241/256/c58560470742940abd59de20f14746b5f8b2dcd2_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"bayotop","url":"/bayotop"},"genius_execution_id":null,"team_handle":"starbucks","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5020036,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @shadegrown,\n\nI double-checked the fix and I'm still not able to reproduce. However, my last comment turns out to be incomplete. \n\nThe root cause seems to be addressed only on this one particular page that includes the prettyPhoto module (since the injection in `\u003clink rel=\"injection\"` happens site wide). I assume this is the reason why @252908 is still open. Just thought I'd mention that for the sake of completeness. Here's a link to demonstrate what I mean:\n\n`https://www.starbucks.co.uk/shop/card/egift/thank-you/anything/a%2522`\n\nRegardless, I believe closing this as resolved is correct. Thank you and see you on the next one!","markdown_message":"\u003cp\u003eHi \u003ca href=\"/shadegrown\"\u003e@shadegrown\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eI double-checked the fix and I\u0026#39;m still not able to reproduce. However, my last comment turns out to be incomplete. \u003c/p\u003e\n\n\u003cp\u003eThe root cause seems to be addressed only on this one particular page that includes the prettyPhoto module (since the injection in \u003ccode\u003e\u0026lt;link rel=\u0026quot;injection\u0026quot;\u003c/code\u003e happens site wide). I assume this is the reason why \u003ca href=\"/252908\"\u003e@252908\u003c/a\u003e is still open. Just thought I\u0026#39;d mention that for the sake of completeness. Here\u0026#39;s a link to demonstrate what I mean:\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003ehttps://www.starbucks.co.uk/shop/card/egift/thank-you/anything/a%2522\u003c/code\u003e\u003c/p\u003e\n\n\u003cp\u003eRegardless, I believe closing this as resolved is correct. Thank you and see you on the next one!\u003c/p\u003e\n","automated_response":false,"created_at":"2019-06-06T21:39:31.661Z","updated_at":"2019-06-06T21:40:05.654Z","actor":{"username":"bayotop","cleared":false,"url":"/bayotop","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/036/633/10a34b6ba8511f5ae6c9664bafcd04aeb25982f8_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"starbucks","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8079924,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-05-22T13:39:52.069Z","updated_at":"2020-05-22T13:39:52.069Z","first_to_agree":true,"actor":{"username":"bayotop","cleared":false,"url":"/bayotop","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/036/633/10a34b6ba8511f5ae6c9664bafcd04aeb25982f8_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"starbucks","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8312571,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-06-16T21:21:07.477Z","updated_at":"2020-06-16T21:21:07.477Z","actor":{"username":"agedsumatra","cleared":false,"url":"/agedsumatra","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/yjUg6PZmutR2o3qPxEP2MT1J/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"starbucks","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8312572,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-06-16T21:21:07.581Z","updated_at":"2020-06-16T21:21:07.581Z","actor":{"username":"agedsumatra","cleared":false,"url":"/agedsumatra","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/yjUg6PZmutR2o3qPxEP2MT1J/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"starbucks","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"id":23025,"category":"team","content":"bayotop discovered a reflected DOM XSS on www.starbucks.co.uk.\n@bayotop — thank you for reporting this vulnerability and for confirming the resolution.","can_view?":true,"can_edit?":false,"content_html":"\u003cp\u003ebayotop discovered a reflected DOM XSS on \u003ca href=\"/redirect?url=http%3A%2F%2Fwww.starbucks.co.uk\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ewww.starbucks.co.uk\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003cbr\u003e\n\u003ca href=\"/bayotop\"\u003e@bayotop\u003c/a\u003e — thank you for reporting this vulnerability and for confirming the resolution.\u003c/p\u003e\n"},{"category":"researcher","can_view?":true,"can_create?":false}]}