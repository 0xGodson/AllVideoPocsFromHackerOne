{"id":897606,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC84OTc2MDY=","url":"https://hackerone.com/reports/897606","title":"[3DS][SSL][SDK] Unchecked number of audio channels in Mobiclip SDK leads to RCE in eShop movie player","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2020-06-13T16:19:42.423Z","submitted_at":"2020-06-13T16:19:42.423Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"mrnbayoh","url":"/mrnbayoh","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/189/059/1c4c4bf47adafcca63b8256be5721d27653948a2_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":16634,"url":"https://hackerone.com/nintendo","handle":"nintendo","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/016/634/999cefca933756faeeb2ea39c07557943437c94f_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/016/634/999cefca933756faeeb2ea39c07557943437c94f_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Nintendo","twitter_handle":"","website":"http://www.nintendo.com","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"no-content","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2020-12-18T12:12:31.117Z","bug_reporter_agreed_on_going_public_at":"2020-12-18T09:53:47.409Z","team_member_agreed_on_going_public_at":"2020-12-18T12:12:31.039Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"","vulnerability_information_html":"","bounty_amount":"3200.0","formatted_bounty":"$3,200","weakness":{"id":5,"name":"Heap Overflow"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":36,"voters":["dee-see","prophet","mrnbayoh","rahsec","mygf","powerjacobb1","reemer","0xrohadi","since2003","exploit_db","and 26 more..."],"severity":{"rating":"high","score":8.6,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"none","user_interaction":"none","scope":"unchanged","confidentiality":"low","integrity":"low","availability":"high"}},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":8285289,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2020-06-14T04:59:17.199Z","updated_at":"2020-06-14T04:59:17.199Z","actor":{"username":"mrnbayoh","cleared":false,"url":"/mrnbayoh","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/189/059/1c4c4bf47adafcca63b8256be5721d27653948a2_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nintendo","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8341338,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2020-06-19T10:11:14.195Z","updated_at":"2020-06-19T10:11:14.195Z","actor":{"username":"tattsun","cleared":false,"url":"/tattsun","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nintendo","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8341352,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2020-06-19T10:12:52.701Z","updated_at":"2020-06-19T10:12:52.701Z","actor":{"username":"tattsun","cleared":false,"url":"/tattsun","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nintendo","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9536658,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2020-10-16T02:40:17.989Z","updated_at":"2020-10-16T02:40:17.989Z","actor":{"url":"/nintendo","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/016/634/999cefca933756faeeb2ea39c07557943437c94f_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Nintendo"}},"bounty_amount":"3200.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"nintendo","collaborator":{"username":"mrnbayoh","url":"/mrnbayoh"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9536666,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","markdown_message":"","automated_response":false,"created_at":"2020-10-16T02:43:23.276Z","updated_at":"2020-10-16T02:43:23.276Z","actor":{"username":"tattsun","cleared":false,"url":"/tattsun","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"mrnbayoh","url":"/mrnbayoh"},"genius_execution_id":null,"team_handle":"nintendo","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9896652,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2020-11-23T10:24:33.987Z","updated_at":"2020-11-23T10:24:33.987Z","actor":{"username":"mrnbayoh","cleared":false,"url":"/mrnbayoh","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/189/059/1c4c4bf47adafcca63b8256be5721d27653948a2_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nintendo","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9968629,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2020-12-01T03:04:23.409Z","updated_at":"2020-12-01T03:04:23.409Z","actor":{"username":"tattsun","cleared":false,"url":"/tattsun","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nintendo","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":10127530,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2020-12-17T02:28:13.036Z","updated_at":"2020-12-17T02:28:13.036Z","actor":{"username":"tattsun","cleared":false,"url":"/tattsun","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nintendo","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":10141731,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-12-18T09:53:47.427Z","updated_at":"2020-12-18T09:53:47.427Z","first_to_agree":true,"actor":{"username":"mrnbayoh","cleared":false,"url":"/mrnbayoh","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/189/059/1c4c4bf47adafcca63b8256be5721d27653948a2_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nintendo","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":10143076,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-12-18T12:12:31.058Z","updated_at":"2020-12-18T12:12:31.058Z","actor":{"username":"tattsun","cleared":false,"url":"/tattsun","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nintendo","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":10143077,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-12-18T12:12:31.139Z","updated_at":"2020-12-18T12:12:31.139Z","actor":{"username":"tattsun","cleared":false,"url":"/tattsun","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nintendo","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"id":25907,"category":"team","content":"-","can_view?":true,"can_edit?":false,"content_html":"\u003cp\u003e-\u003c/p\u003e\n"},{"id":25891,"category":"researcher","content":"#Affected Systems\n- Platform: (New) Nintendo 3DS\n- Region: ALL\n- System version: 11.13 (latest at the time of writing)\n\n#Description\nThe Mobiclip SDK used for parsing moflex videos does not check the number of audio channels in an audio stream. This leads to a miscalculation of free space remaining in a heap buffer, and then a buffer overflow.\n\n#Vulnerability\nThe `mw::mo::helper::PcmAudioPresentation::GetNextAudioDataPtr` function is used to calculate the address where the incoming audio data should be copied before getting processed:\n```\nvoid* GetNextAudioDataPtr(audio_presentation* ap, uint32_t data_size) {\n    int64_t offset = ap-\u003ebufferOffset;\n    int64_t already_played = GetTotalSamplePlayed(ap-\u003esoundId); //this is calculated like this: (previous_data_length / (nb_channels*2))\n    int64_t already_played_bytes = already_played \u003c\u003c ap-\u003eaudioStreamInfo-\u003enbChannels;\n\n    uint32_t free_space = ap-\u003ebufferSize - (uint32_t)(offset - already_played_bytes);\n    uint32_t remaining_space = ap-\u003ebufferSize - offset;\n\n    if(remaining_space \u003c data_size) {\n        offset = 0;\n        free_space -= remaining_space; \n    }\n    if(free_space \u003c data_size)\n        return NULL; \n    return ap-\u003ebuffer + offset;\n}\n```\n\nWe can see that to get the number of already used bytes in the audio buffer it first gets the number of \"audio units\" already used (number of shorts in PCM16 format). This is done by calling the `GetTotalSamplePlayed` function, which relies on the `GetSampleLength` function. Thus, the `already_played` value is calculated like this for PCM16 data: `previous_data_length / (nb_channels*2)`. This is the number of PCM16 data units that have already been processed.\nThen to get the number of bytes already processed, `already_played_bytes` is calculated based on `already_played` like this: `already_played_bytes = already_played \u003c\u003c nb_channels`, which is equivalent to `already_played_bytes = already_played * pow(2, nb_channels)`. When the number of channels is 1 or 2, this is correct because `2 * nb_channels = pow(2, nb_channels)`. However the number of channels is provided by video files and is not checked, thus it is possible to set a number of channels greater than 2 (up to 256).\nWhen the number of channels is greater than 2, ` pow(2, nb_channels) \u003e 2 * nb_channels`, thus the calculation of `free_space` becomes incorrect and can be far greater than the real free space remaining. One can for example set the number of already processed data and the number of channels such that `already_played_bytes = 0x8XXXXXXX` which is enough to totally bypass the size check.\n\n## Impact\n\nBecause of [#894922](https://hackerone.com/reports/894922), anyone can exploit this vulnerability and get remote code execution in usermode under the eShop application.\nMoreover, this could potentially(?) be exploited without any SSL flaw by someone able to submit games to the eShop catalog, however since I don't know the validation process and checks performed, I cannot ensure this is possible.\nNote that one can exploit this vulnerability without any noticeable change to the eShop application behavior. This means the user has no way to know something bad is happening before launching the video playback.\n","can_view?":true,"can_edit?":false,"content_html":"\u003ch1 id=\"affected-systems\"\u003eAffected Systems\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003ePlatform: (New) Nintendo 3DS\u003c/li\u003e\n\u003cli\u003eRegion: ALL\u003c/li\u003e\n\u003cli\u003eSystem version: 11.13 (latest at the time of writing)\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1 id=\"description\"\u003eDescription\u003c/h1\u003e\n\n\u003cp\u003eThe Mobiclip SDK used for parsing moflex videos does not check the number of audio channels in an audio stream. This leads to a miscalculation of free space remaining in a heap buffer, and then a buffer overflow.\u003c/p\u003e\n\n\u003ch1 id=\"vulnerability\"\u003eVulnerability\u003c/h1\u003e\n\n\u003cp\u003eThe \u003ccode\u003emw::mo::helper::PcmAudioPresentation::GetNextAudioDataPtr\u003c/code\u003e function is used to calculate the address where the incoming audio data should be copied before getting processed:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003evoid* GetNextAudioDataPtr(audio_presentation* ap, uint32_t data_size) {\n    int64_t offset = ap-\u0026gt;bufferOffset;\n    int64_t already_played = GetTotalSamplePlayed(ap-\u0026gt;soundId); //this is calculated like this: (previous_data_length / (nb_channels*2))\n    int64_t already_played_bytes = already_played \u0026lt;\u0026lt; ap-\u0026gt;audioStreamInfo-\u0026gt;nbChannels;\n\n    uint32_t free_space = ap-\u0026gt;bufferSize - (uint32_t)(offset - already_played_bytes);\n    uint32_t remaining_space = ap-\u0026gt;bufferSize - offset;\n\n    if(remaining_space \u0026lt; data_size) {\n        offset = 0;\n        free_space -= remaining_space; \n    }\n    if(free_space \u0026lt; data_size)\n        return NULL; \n    return ap-\u0026gt;buffer + offset;\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eWe can see that to get the number of already used bytes in the audio buffer it first gets the number of \u0026quot;audio units\u0026quot; already used (number of shorts in PCM16 format). This is done by calling the \u003ccode\u003eGetTotalSamplePlayed\u003c/code\u003e function, which relies on the \u003ccode\u003eGetSampleLength\u003c/code\u003e function. Thus, the \u003ccode\u003ealready_played\u003c/code\u003e value is calculated like this for PCM16 data: \u003ccode\u003eprevious_data_length / (nb_channels*2)\u003c/code\u003e. This is the number of PCM16 data units that have already been processed.\u003cbr\u003e\nThen to get the number of bytes already processed, \u003ccode\u003ealready_played_bytes\u003c/code\u003e is calculated based on \u003ccode\u003ealready_played\u003c/code\u003e like this: \u003ccode\u003ealready_played_bytes = already_played \u0026lt;\u0026lt; nb_channels\u003c/code\u003e, which is equivalent to \u003ccode\u003ealready_played_bytes = already_played * pow(2, nb_channels)\u003c/code\u003e. When the number of channels is 1 or 2, this is correct because \u003ccode\u003e2 * nb_channels = pow(2, nb_channels)\u003c/code\u003e. However the number of channels is provided by video files and is not checked, thus it is possible to set a number of channels greater than 2 (up to 256).\u003cbr\u003e\nWhen the number of channels is greater than 2, \u003ccode\u003epow(2, nb_channels) \u0026gt; 2 * nb_channels\u003c/code\u003e, thus the calculation of \u003ccode\u003efree_space\u003c/code\u003e becomes incorrect and can be far greater than the real free space remaining. One can for example set the number of already processed data and the number of channels such that \u003ccode\u003ealready_played_bytes = 0x8XXXXXXX\u003c/code\u003e which is enough to totally bypass the size check.\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eBecause of \u003ca href=\"https://hackerone.com/reports/894922\"\u003e#894922\u003c/a\u003e, anyone can exploit this vulnerability and get remote code execution in usermode under the eShop application.\u003cbr\u003e\nMoreover, this could potentially(?) be exploited without any SSL flaw by someone able to submit games to the eShop catalog, however since I don\u0026#39;t know the validation process and checks performed, I cannot ensure this is possible.\u003cbr\u003e\nNote that one can exploit this vulnerability without any noticeable change to the eShop application behavior. This means the user has no way to know something bad is happening before launching the video playback.\u003c/p\u003e\n"}]}