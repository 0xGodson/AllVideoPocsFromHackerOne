{"id":755354,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC83NTUzNTQ=","url":"https://hackerone.com/reports/755354","title":"Prevent XSS when passing a parameter directly into link_to ","state":"Closed","substate":"informative","severity_rating":"low","readable_substate":"Informative","created_at":"2019-12-10T18:00:07.892Z","submitted_at":"2019-12-10T18:00:07.892Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"speleding","url":"/speleding","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/vJRkCxyKWpQqekuvyr1WFKec/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":22,"url":"https://hackerone.com/rails","handle":"rails","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/022/5e2b46658c8b86bed62f574d8e1793f353cbbc63_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/022/5e2b46658c8b86bed62f574d8e1793f353cbbc63_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Ruby on Rails","twitter_handle":null,"website":"http://rubyonrails.org/security","about":"Web development that doesn't hurt."}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2020-05-13T18:19:25.408Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2020-05-12T16:38:42.187Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"*Note: I would say this is perhaps more of a feature request than an actual vulnerability, but Rafael França deleted this from GitHub and asked to submit it here instead*\n\nIn a rails views it's easy to accidentally create an XSS vulnerability by using the following in a template:\n`\u003c%= link_to 'Back', params[:back] %\u003e`\n\nDoing this exposes the app to an attack that can easily be demonstrated by simply adding this to URL of that view:\n`?back=javascript%3Aalert%28boom%29%3B`\n\nI think it would be good if rails detects this situation and filters the link_to parameter if it's from an untrusted source. The attached two-line patch does this by only allowing the HTTP(S) protocol in that case.\n\n## Impact\n\nIf a programmer inadvertently passes a parameter directly into link_to then this would leave his site open to an XSS attack. Since rails filters untrusted parameters in many other situations it may not be apparent to the casual observer that link_to does not filter javascript.","vulnerability_information_html":"\u003cp\u003e\u003cem\u003eNote: I would say this is perhaps more of a feature request than an actual vulnerability, but Rafael França deleted this from GitHub and asked to submit it here instead\u003c/em\u003e\u003c/p\u003e\n\n\u003cp\u003eIn a rails views it\u0026#39;s easy to accidentally create an XSS vulnerability by using the following in a template:\u003cbr\u003e\n\u003ccode\u003e\u0026lt;%= link_to \u0026#39;Back\u0026#39;, params[:back] %\u0026gt;\u003c/code\u003e\u003c/p\u003e\n\n\u003cp\u003eDoing this exposes the app to an attack that can easily be demonstrated by simply adding this to URL of that view:\u003cbr\u003e\n\u003ccode\u003e?back=javascript%3Aalert%28boom%29%3B\u003c/code\u003e\u003c/p\u003e\n\n\u003cp\u003eI think it would be good if rails detects this situation and filters the link_to parameter if it\u0026#39;s from an untrusted source. The attached two-line patch does this by only allowing the HTTP(S) protocol in that case.\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eIf a programmer inadvertently passes a parameter directly into link_to then this would leave his site open to an XSS attack. Since rails filters untrusted parameters in many other situations it may not be apparent to the casual observer that link_to does not filter javascript.\u003c/p\u003e\n","weakness":{"id":63,"name":"Cross-site Scripting (XSS) - DOM"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":656072,"file_name":"Prevent_XSS_when_passing_param_directly_into_link_to.patch","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/V97WNmtmEepCjFWqSc5c5tCT?response-content-disposition=attachment%3B%20filename%3D%22Prevent_XSS_when_passing_param_directly_into_link_to.patch%22%3B%20filename%2A%3DUTF-8%27%27Prevent_XSS_when_passing_param_directly_into_link_to.patch\u0026response-content-type=text%2Fx-patch\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQZNBK7XE3%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T064702Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIDJ7z4CmMY3RV8XLMfdiTISQ9S1r9LCcJaOgCsH72FPNAiEAuja%2BBBclEzFTidjiCeJDfo4MzChKrB6582xpvIRZVHkqtAMIVxABGgwwMTM2MTkyNzQ4NDkiDKF6a0ltLoRnSbls0yqRA3RGeXBNEYkcjQZeQFx3bgZwO3IO2Lrw6zpAqUNvB9kgtFfucTajkpiHPbxlEXUipMBgdqwocs7gTZt2N3PS5ofO0SiwdnSDzloAVKwvO0XxAw38SFZ70tsG2d%2FGMwjmhna0T8MpEDx2rGBrOrmMGD%2BxUltiSMg5RbP4rOtmNv8ar9c6C5QMOqO65NG11MRvC%2BWmpwVTu7rYIfx6VqNqNYuYBj3X8lrkAIj49fYyj6hO9J%2B192rAZcrZy%2Fw%2FVAObxfNeR4Ody9MGHCied9SDXd94Id6OVnLovmWuyeU9tqRxlCjsbK8JU%2BX4cPpzzLv2M%2BXo9FPZzDo%2BJsudoZ%2FGhP8gGO7tqmufjBlUJeCMc7PJwExjkANhZZ8jsuHUnG6x0ut5DHPqdKpuFrdIEEkM54WZUmpVWXhr4FFAQpHmxo5CDioZ8fJISU03lWiVZsNHNUNL9JvOP%2F9r%2BD39N6cKvQsPj88OjMOdSwqmXok7EmQpEHjQJD7E2qU3u9NYOegEnJbeEDovuNzvrAFxWCR8Jb54MPSEq%2F8FOusBO2kLVSIwkWtiWhkMaF2Er8oC8IS3vbK0bWd1vKM6%2B7NbNWRuqTnvJZaJWfp3F9jcm3FnwzYHZTcGXifg17Nbzb0roUgfsHPeorCwFQWH5sgSgHT2%2FWJtKCiy%2Bq70tsC4rbZb9rhONxp4U1mUQ1FHptDEi7qq4G0IX8as4zxX7lD6kdQWT5OzW%2B1QZT5nCSKbiYjBuLsBWu7yufMUkemOm2u4kDIOdccYg1ZGDofBPx4GFA%2B8IOAMP3e7bz6rUgxMr2NMjzX%2Byr%2FFaK2EDYbEgcI81le58BokeFu68wlopZbfnJvFia1ReCQe1Q%3D%3D\u0026X-Amz-Signature=c9ad4c86be814bd9e03bf5b229b95fd0767c970e71b6404a1efec71d6d510756","file_size":560,"type":"text/x-patch"}],"allow_singular_disclosure_at":null,"vote_count":2,"voters":["brahim_boufakri01","mr_assassin"],"severity":{"rating":"low","author_type":"User"},"structured_scope":{"databaseId":160,"asset_type":"SOURCE_CODE","asset_identifier":"https://github.com/rails/rails","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":6515518,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for the report.\n\nI just tried your patch and it doesn't fix the issue. `param[:back]` is just a regular string, not a safer buffer, so the code in the patch will not apply.\n\nWe are aware of this issue for a while, and we did investigate ways to solve it. We didn't came up with any way to solve this issue without wrapping every value in params in an object, what would possibly break a lot of code.\n\nDo you have any other suggestions on how to fix this problem?","markdown_message":"\u003cp\u003eThank you for the report.\u003c/p\u003e\n\n\u003cp\u003eI just tried your patch and it doesn\u0026#39;t fix the issue. \u003ccode\u003eparam[:back]\u003c/code\u003e is just a regular string, not a safer buffer, so the code in the patch will not apply.\u003c/p\u003e\n\n\u003cp\u003eWe are aware of this issue for a while, and we did investigate ways to solve it. We didn\u0026#39;t came up with any way to solve this issue without wrapping every value in params in an object, what would possibly break a lot of code.\u003c/p\u003e\n\n\u003cp\u003eDo you have any other suggestions on how to fix this problem?\u003c/p\u003e\n","automated_response":false,"created_at":"2019-12-10T18:27:59.501Z","updated_at":"2019-12-10T18:28:51.174Z","actor":{"username":"rafaelfranca","cleared":false,"url":"/rafaelfranca","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/981/dd3b6bb41f9c33e3448ebbc47303f5a135f25105_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6515519,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2019-12-10T18:28:10.892Z","updated_at":"2019-12-10T18:28:10.892Z","actor":{"username":"rafaelfranca","cleared":false,"url":"/rafaelfranca","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/981/dd3b6bb41f9c33e3448ebbc47303f5a135f25105_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6515856,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Ah, I see there was a mistake in my setup that had turned the param into a SafeBuffer, sorry. Thanks for taking a look.\n\nAnother option I considered would be to only allow the http protocol on the String class unless there is an \"only_http =\u003e false\" parameter present. That might break apps relying on the current behaviour so we could trigger a deprecation warning when link_to is used with: a String \u0026\u0026 not an http URL \u0026\u0026 does not have that parameter. Then refuse to work in a future update.\n\n(Checking if a string is a valid http URL is a bit expensive, but for this purpose I think we can get away with something like `start_with?('/') || start_with?('http') || start_with?('#')` although that misses the edge case where someone wants to link relative to the current page, so not starting with /).","markdown_message":"\u003cp\u003eAh, I see there was a mistake in my setup that had turned the param into a SafeBuffer, sorry. Thanks for taking a look.\u003c/p\u003e\n\n\u003cp\u003eAnother option I considered would be to only allow the http protocol on the String class unless there is an \u0026quot;only_http =\u0026gt; false\u0026quot; parameter present. That might break apps relying on the current behaviour so we could trigger a deprecation warning when link_to is used with: a String \u0026amp;\u0026amp; not an http URL \u0026amp;\u0026amp; does not have that parameter. Then refuse to work in a future update.\u003c/p\u003e\n\n\u003cp\u003e(Checking if a string is a valid http URL is a bit expensive, but for this purpose I think we can get away with something like \u003ccode\u003estart_with?(\u0026#39;/\u0026#39;) || start_with?(\u0026#39;http\u0026#39;) || start_with?(\u0026#39;#\u0026#39;)\u003c/code\u003e although that misses the edge case where someone wants to link relative to the current page, so not starting with /).\u003c/p\u003e\n","automated_response":false,"created_at":"2019-12-10T19:11:27.564Z","updated_at":"2019-12-10T19:11:27.564Z","actor":{"username":"speleding","cleared":false,"url":"/speleding","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/vJRkCxyKWpQqekuvyr1WFKec/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":6515960,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Adding an \"only_http\" option to link_to is a bit tricky though, it would be confusing to indicate that it's an option that applies to the String and not to the html options. So another idea could be to only allow non-http Strings if they are frozen. This is a bit hacky but easy enough to implement and explain in the warning when someone passes a non-frozen non-http String","markdown_message":"\u003cp\u003eAdding an \u0026quot;only_http\u0026quot; option to link_to is a bit tricky though, it would be confusing to indicate that it\u0026#39;s an option that applies to the String and not to the html options. So another idea could be to only allow non-http Strings if they are frozen. This is a bit hacky but easy enough to implement and explain in the warning when someone passes a non-frozen non-http String\u003c/p\u003e\n","automated_response":false,"created_at":"2019-12-10T19:27:37.157Z","updated_at":"2019-12-10T19:27:37.157Z","actor":{"username":"speleding","cleared":false,"url":"/speleding","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/vJRkCxyKWpQqekuvyr1WFKec/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7978458,"is_internal":false,"editable":false,"type":"Activities::BugInformative","message":"Hi @speleding,\n\nThank you for the report and for your patience. Unfortunately I don't think there is a viable fix here that will allow developer flexibility and backwards compatibility while also disallowing the `javascript:` scheme entirely. The `link_to` helper currently does not have opinions regarding which schemes are acceptable, and this is unlikely to change in the future. For this reason, we will be closing this report as informative. Additionally, we will be requesting disclosure on this report so that this behaviour is publicly documented.","markdown_message":"\u003cp\u003eHi \u003ca href=\"/speleding\"\u003e@speleding\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eThank you for the report and for your patience. Unfortunately I don\u0026#39;t think there is a viable fix here that will allow developer flexibility and backwards compatibility while also disallowing the \u003ccode\u003ejavascript:\u003c/code\u003e scheme entirely. The \u003ccode\u003elink_to\u003c/code\u003e helper currently does not have opinions regarding which schemes are acceptable, and this is unlikely to change in the future. For this reason, we will be closing this report as informative. Additionally, we will be requesting disclosure on this report so that this behaviour is publicly documented.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-05-12T16:38:12.487Z","updated_at":"2020-05-12T16:38:12.487Z","actor":{"username":"jack_mccracken","cleared":false,"url":"/jack_mccracken","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/164/342/6543dc397b4dbb2c24dc81f92a42de654a3e6a99_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7978465,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Requesting full disclosure. Let us know if you would rather limited disclosure or no disclosure.","markdown_message":"\u003cp\u003eRequesting full disclosure. Let us know if you would rather limited disclosure or no disclosure.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-05-12T16:38:42.215Z","updated_at":"2020-05-12T16:38:42.215Z","first_to_agree":true,"actor":{"username":"jack_mccracken","cleared":false,"url":"/jack_mccracken","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/164/342/6543dc397b4dbb2c24dc81f92a42de654a3e6a99_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7978624,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@jack_mccracken Yes, I agree that fixing this in a backwards compatible way would be tricky. And it's fine to disclose this, of course.","markdown_message":"\u003cp\u003e\u003ca href=\"/jack_mccracken\"\u003e@jack_mccracken\u003c/a\u003e Yes, I agree that fixing this in a backwards compatible way would be tricky. And it\u0026#39;s fine to disclose this, of course.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-05-12T17:00:07.342Z","updated_at":"2020-05-12T17:00:07.342Z","actor":{"username":"speleding","cleared":false,"url":"/speleding","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/vJRkCxyKWpQqekuvyr1WFKec/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7992447,"is_internal":false,"editable":false,"type":"Activities::ManuallyDisclosed","message":"","markdown_message":"","automated_response":false,"created_at":"2020-05-13T18:19:25.328Z","updated_at":"2020-05-13T18:19:25.328Z","actor":{"username":"tenderlove","cleared":false,"url":"/tenderlove","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/318/60d828744b5d16813ecbf975fdc453dc4a933f4f_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}