{"id":1032086,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xMDMyMDg2","url":"https://hackerone.com/reports/1032086","title":"csi-snapshot-controller crashes when processing VolumeSnapshot with non-existing PVC","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2020-11-12T07:20:20.713Z","submitted_at":"2020-11-12T07:20:20.753Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"piqin","url":"/piqin","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":39386,"url":"https://hackerone.com/kubernetes","handle":"kubernetes","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/039/386/486f4380e09776d05a912ca9f46be23f72fe8197_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/039/386/486f4380e09776d05a912ca9f46be23f72fe8197_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Kubernetes","twitter_handle":"kubernetesio","website":"https://kubernetes.io/","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":["CVE-2020-8569"],"singular_disclosure_disabled":false,"disclosed_at":"2020-12-03T01:31:59.488Z","bug_reporter_agreed_on_going_public_at":"2020-12-03T01:31:59.390Z","team_member_agreed_on_going_public_at":"2020-12-02T21:23:14.050Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Report Submission Form\n\nI was asked by Kubernetes Product Security and H1 Employee @turtle_shell to open a new report with the same details as report #995699.\n\n# Summary:\ncsi-snapshot-controller crashes when processing VolumeSnapshot with non-existing PVC\n\n# Kubernetes Version:\n1.19\n\n# Component Version:\nsnapshot-controller from external-snapshotter repo ver 3.0.0\nhttps://github.com/kubernetes-csi/external-snapshotter/releases/tag/v3.0.0\n\n# Steps To Reproduce:\n1.   Install Kubernetes 1.19 with snapshot-controller v3.0.0\n2.   Create VolumeSnapshot object with empty spec.volumeSnapshotClass and spec.source.persistentVolumeClaimName = \u003cnon-existing PVC name \n\n    ```\n    apiVersion: snapshot.storage.k8s.io/v1beta1\n    kind: VolumeSnapshot\n    metadata:\n      name: new-snapshot\n    spec:\n      source:\n        persistentVolumeClaimName: blabla\n    ```\n3.   watch snapshot-controller die\n\n# Supporting Material/References:\n[list any additional material (e.g. screenshots, logs, etc.)]\n\nsnapshot-controller log:\n\n    E0929 06:42:38.147021       1 snapshot_controller_base.go:338] checkAndUpdateSnapshotClass failed to setDefaultClass the snapshot source PVC name is not specified\n    E0929 06:42:38.147118       1 runtime.go:78] Observed a panic: \"invalid memory address or nil pointer dereference\" (runtime error: invalid memory address or nil pointer dereference)\n    goroutine 161 [running]:\n    k8s.io/apimachinery/pkg/util/runtime.logPanic(0x1446fc0, 0x201e670)\n            /go/src/github.com/kubernetes-csi/external-snapshotter/vendor/k8s.io/apimachinery/pkg/util/runtime/runtime.go:74 +0xa6\n    k8s.io/apimachinery/pkg/util/runtime.HandleCrash(0x0, 0x0, 0x0)\n        /go/src/github.com/kubernetes-csi/external-snapshotter/vendor/k8s.io/apimachinery/pkg/util/runtime/runtime.go:48 +0x89\n    panic(0x1446fcit sh0, 0x201e670)\n        /usr/lib/golang/src/runtime/panic.go:969 +0x175\n    github.com/kubernetes-csi/external-snapshotter/v3/pkg/common-controller.(*csiSnapshotCommonController).syncSnapshotByKey(0xc0001f8e00, 0xc0006a6ae0, 0x19, 0x0, 0xbc)\n        /go/src/github.com/kubernetes-csi/external-snapshotter/pkg/common-controller/snapshot_controller_base.go:215 +0x9d7\n    github.com/kubernetes-csi/external-snapshotter/v3/pkg/common-controller.(*csiSnapshotCommonController).snapshotWorker(0xc0001f8e00)\n        /go/src/github.com/kubernetes-csi/external-snapshotter/pkg/common-controller/snapshot_controller_base.go:188 +0xed\n    k8s.io/apimachinery/pkg/util/wait.BackoffUntil.func1(0xc0006ba8b0)\n        /go/src/github.com/kubernetes-csi/external-snapshotter/vendor/k8s.io/apimachinery/pkg/util/wait/wait.go:155 +0x5f\n    k8s.io/apimachinery/pkg/util/wait.BackoffUntil(0xc0006ba8b0, 0x1774260, 0xc0001f0030, 0x1, 0xc00002a1e0)\n        /go/src/github.com/kubernetes-csi/external-snapshotter/vendor/k8s.io/apimachinery/pkg/util/wait/wait.go:156 +0xad\n    k8s.io/apimachinery/pkg/util/wait.JitterUntil(0xc0006ba8b0, 0x0, 0x0, 0x1, 0xc00002a1e0)\n        /go/src/github.com/kubernetes-csi/external-snapshotter/vendor/k8s.io/apimachinery/pkg/util/wait/wait.go:133 +0x98\n    k8s.io/apimachinery/pkg/util/wait.Until(0xc0006ba8b0, 0x0, 0xc00002a1e0)\n        /go/src/github.com/kubernetes-csi/external-snapshotter/vendor/k8s.io/apimachinery/pkg/util/wait/wait.go:90 +0x4d\n    created by it shgithub.com/kubernetes-csi/external-snapshotter/v3/pkg/common-controller.(*csiSnapshotCommonController).Run\n        /go/src/github.com/kubernetes-csi/external-snapshotter/pkg/common-controller/snapshot_controller_base.go:139 +0x2ae\n    panic: runtime error: invalid memory address or nil pointer dereference [recovered]\n            panic: runtime error: invalid memory address or nil pointer dereference\n    [signal SIGSEGV: segmentation violation code=0x1 addr=0xa0 pc=0x12b1d97]\n\n## Impact\n\nDoS of snapshot-controller. It's restarted by Kubernetes, but it dies processing the same VolumeSnapshot again and again.\n\n* Users can't create snapshots of their volumes.\n* Kubernetes (snapshot-controller) does not clean up VolumeSnapshotContent objects when user deletes a VolumeSnapshot and its Retain policy is Delete.\n\nAll other Kubernetes functionality is not impacted.","vulnerability_information_html":"\u003cp\u003eReport Submission Form\u003c/p\u003e\n\n\u003cp\u003eI was asked by Kubernetes Product Security and H1 Employee \u003ca href=\"/turtle_shell\"\u003e@turtle_shell\u003c/a\u003e to open a new report with the same details as report \u003ca href=\"/reports/995699\"\u003e#995699\u003c/a\u003e.\u003c/p\u003e\n\n\u003ch1 id=\"summary\"\u003eSummary:\u003c/h1\u003e\n\n\u003cp\u003ecsi-snapshot-controller crashes when processing VolumeSnapshot with non-existing PVC\u003c/p\u003e\n\n\u003ch1 id=\"kubernetes-version\"\u003eKubernetes Version:\u003c/h1\u003e\n\n\u003cp\u003e1.19\u003c/p\u003e\n\n\u003ch1 id=\"component-version\"\u003eComponent Version:\u003c/h1\u003e\n\n\u003cp\u003esnapshot-controller from external-snapshotter repo ver 3.0.0\u003cbr\u003e\n\u003ca title=\"https://github.com/kubernetes-csi/external-snapshotter/releases/tag/v3.0.0\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fkubernetes-csi%2Fexternal-snapshotter%2Freleases%2Ftag%2Fv3.0.0\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/kubernetes-csi/external-snapshotter/releases/tag/v3.0.0\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1 id=\"steps-to-reproduce\"\u003eSteps To Reproduce:\u003c/h1\u003e\n\n\u003col\u003e\n\u003cli\u003e  Install Kubernetes 1.19 with snapshot-controller v3.0.0\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eCreate VolumeSnapshot object with empty spec.volumeSnapshotClass and spec.source.persistentVolumeClaimName = \u0026lt;non-existing PVC name \u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eapiVersion: snapshot.storage.k8s.io/v1beta1\nkind: VolumeSnapshot\nmetadata:\n  name: new-snapshot\nspec:\n  source:\n    persistentVolumeClaimName: blabla\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003ewatch snapshot-controller die\u003c/p\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch1 id=\"supporting-material-references\"\u003eSupporting Material/References:\u003c/h1\u003e\n\n\u003cp\u003e[list any additional material (e.g. screenshots, logs, etc.)]\u003c/p\u003e\n\n\u003cp\u003esnapshot-controller log:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eE0929 06:42:38.147021       1 snapshot_controller_base.go:338] checkAndUpdateSnapshotClass failed to setDefaultClass the snapshot source PVC name is not specified\nE0929 06:42:38.147118       1 runtime.go:78] Observed a panic: \u0026quot;invalid memory address or nil pointer dereference\u0026quot; (runtime error: invalid memory address or nil pointer dereference)\ngoroutine 161 [running]:\nk8s.io/apimachinery/pkg/util/runtime.logPanic(0x1446fc0, 0x201e670)\n        /go/src/github.com/kubernetes-csi/external-snapshotter/vendor/k8s.io/apimachinery/pkg/util/runtime/runtime.go:74 +0xa6\nk8s.io/apimachinery/pkg/util/runtime.HandleCrash(0x0, 0x0, 0x0)\n    /go/src/github.com/kubernetes-csi/external-snapshotter/vendor/k8s.io/apimachinery/pkg/util/runtime/runtime.go:48 +0x89\npanic(0x1446fcit sh0, 0x201e670)\n    /usr/lib/golang/src/runtime/panic.go:969 +0x175\ngithub.com/kubernetes-csi/external-snapshotter/v3/pkg/common-controller.(*csiSnapshotCommonController).syncSnapshotByKey(0xc0001f8e00, 0xc0006a6ae0, 0x19, 0x0, 0xbc)\n    /go/src/github.com/kubernetes-csi/external-snapshotter/pkg/common-controller/snapshot_controller_base.go:215 +0x9d7\ngithub.com/kubernetes-csi/external-snapshotter/v3/pkg/common-controller.(*csiSnapshotCommonController).snapshotWorker(0xc0001f8e00)\n    /go/src/github.com/kubernetes-csi/external-snapshotter/pkg/common-controller/snapshot_controller_base.go:188 +0xed\nk8s.io/apimachinery/pkg/util/wait.BackoffUntil.func1(0xc0006ba8b0)\n    /go/src/github.com/kubernetes-csi/external-snapshotter/vendor/k8s.io/apimachinery/pkg/util/wait/wait.go:155 +0x5f\nk8s.io/apimachinery/pkg/util/wait.BackoffUntil(0xc0006ba8b0, 0x1774260, 0xc0001f0030, 0x1, 0xc00002a1e0)\n    /go/src/github.com/kubernetes-csi/external-snapshotter/vendor/k8s.io/apimachinery/pkg/util/wait/wait.go:156 +0xad\nk8s.io/apimachinery/pkg/util/wait.JitterUntil(0xc0006ba8b0, 0x0, 0x0, 0x1, 0xc00002a1e0)\n    /go/src/github.com/kubernetes-csi/external-snapshotter/vendor/k8s.io/apimachinery/pkg/util/wait/wait.go:133 +0x98\nk8s.io/apimachinery/pkg/util/wait.Until(0xc0006ba8b0, 0x0, 0xc00002a1e0)\n    /go/src/github.com/kubernetes-csi/external-snapshotter/vendor/k8s.io/apimachinery/pkg/util/wait/wait.go:90 +0x4d\ncreated by it shgithub.com/kubernetes-csi/external-snapshotter/v3/pkg/common-controller.(*csiSnapshotCommonController).Run\n    /go/src/github.com/kubernetes-csi/external-snapshotter/pkg/common-controller/snapshot_controller_base.go:139 +0x2ae\npanic: runtime error: invalid memory address or nil pointer dereference [recovered]\n        panic: runtime error: invalid memory address or nil pointer dereference\n[signal SIGSEGV: segmentation violation code=0x1 addr=0xa0 pc=0x12b1d97]\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eDoS of snapshot-controller. It\u0026#39;s restarted by Kubernetes, but it dies processing the same VolumeSnapshot again and again.\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eUsers can\u0026#39;t create snapshots of their volumes.\u003c/li\u003e\n\u003cli\u003eKubernetes (snapshot-controller) does not clean up VolumeSnapshotContent objects when user deletes a VolumeSnapshot and its Retain policy is Delete.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eAll other Kubernetes functionality is not impacted.\u003c/p\u003e\n","bounty_amount":"500.0","formatted_bounty":"$500","weakness":{"id":51,"name":"NULL Pointer Dereference"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2021-01-01T21:23:14.136Z","allow_singular_disclosure_after":321023.623681766,"singular_disclosure_allowed":false,"vote_count":15,"voters":["sw33tlie","prophet","h4x0r-dz","cryptographer","vijay5647","7005indian-bs","phxt","itsmekriss","imtiaz0x","n1cotheh4cker","and 5 more..."],"severity":{"rating":"medium","author_type":"User"},"structured_scope":{"databaseId":34432,"asset_type":"SOURCE_CODE","asset_identifier":"github.com/kubernetes-csi","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":9803588,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey @piqin - Thanks for the submission. Your report is currently being reviewed and the HackerOne triage team will get back to you once there is additional information to share.","markdown_message":"\u003cp\u003eHey \u003ca href=\"/piqin\"\u003e@piqin\u003c/a\u003e - Thanks for the submission. Your report is currently being reviewed and the HackerOne triage team will get back to you once there is additional information to share.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-11-12T15:50:05.546Z","updated_at":"2020-11-12T15:50:05.546Z","actor":{"username":"tuxedo","cleared":false,"url":"/tuxedo","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/9G6pgB95of3ikt3prqQunAfD/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":true,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"kubernetes","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":9806842,"is_internal":false,"editable":false,"type":"Activities::CveIdAdded","message":"","markdown_message":"","automated_response":false,"created_at":"2020-11-12T20:22:09.843Z","updated_at":"2020-11-12T20:22:09.843Z","cve_ids":["CVE-2020-8569"],"actor":{"username":"jk1joel","cleared":false,"url":"/jk1joel","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"kubernetes","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9806864,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"We asked @piqin to open this report so we could award the bounty to her as she originally discovered the issue reported in report #995699.","markdown_message":"\u003cp\u003eWe asked \u003ca href=\"/piqin\"\u003e@piqin\u003c/a\u003e to open this report so we could award the bounty to her as she originally discovered the issue reported in report \u003ca href=\"/reports/995699\"\u003e#995699\u003c/a\u003e.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-11-12T20:26:36.597Z","updated_at":"2020-11-12T20:26:36.597Z","actor":{"username":"jk1joel","cleared":false,"url":"/jk1joel","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"kubernetes","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9916523,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2020-11-24T19:59:53.192Z","updated_at":"2020-11-24T19:59:53.192Z","actor":{"url":"/kubernetes","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/039/386/486f4380e09776d05a912ca9f46be23f72fe8197_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Kubernetes"}},"bounty_amount":"500.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"kubernetes","collaborator":{"username":"piqin","url":"/piqin"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9989118,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Public announcement: https://groups.google.com/g/kubernetes-security-announce/c/1EzCr1qUxxU","markdown_message":"\u003cp\u003ePublic announcement: \u003ca title=\"https://groups.google.com/g/kubernetes-security-announce/c/1EzCr1qUxxU\" href=\"/redirect?url=https%3A%2F%2Fgroups.google.com%2Fg%2Fkubernetes-security-announce%2Fc%2F1EzCr1qUxxU\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://groups.google.com/g/kubernetes-security-announce/c/1EzCr1qUxxU\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n","automated_response":false,"created_at":"2020-12-02T21:23:05.880Z","updated_at":"2020-12-02T21:23:05.880Z","actor":{"username":"tallclair","cleared":false,"url":"/tallclair","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/418/594/6bbb78252759e1d1c1d67be48b7d7470926730de_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"piqin","url":"/piqin"},"genius_execution_id":null,"team_handle":"kubernetes","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9989119,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-12-02T21:23:14.071Z","updated_at":"2020-12-02T21:23:14.071Z","first_to_agree":true,"actor":{"username":"tallclair","cleared":false,"url":"/tallclair","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/418/594/6bbb78252759e1d1c1d67be48b7d7470926730de_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"kubernetes","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9990041,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-12-03T01:31:59.419Z","updated_at":"2020-12-03T01:31:59.419Z","actor":{"username":"piqin","cleared":false,"url":"/piqin","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"kubernetes","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9990042,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-12-03T01:31:59.517Z","updated_at":"2020-12-03T01:31:59.517Z","actor":{"username":"piqin","cleared":false,"url":"/piqin","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"kubernetes","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}