{"id":88395,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC84ODM5NQ==","url":"https://hackerone.com/reports/88395","title":"Information leakage through Graphviz blocks","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2015-09-11T01:18:57.641Z","submitted_at":"2015-09-11T01:18:57.641Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"jbeta","url":"/jbeta","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/039/121/4bec56bea4aee1feb6535cb0727421420ab1e874_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":18,"url":"https://hackerone.com/phabricator","handle":"phabricator","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Phabricator","twitter_handle":"phabricator","website":"http://phacility.com/phabricator/","about":"Phabricator is a collection of open source web applications that help software companies build better software."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2015-09-13T19:55:14.805Z","bug_reporter_agreed_on_going_public_at":"2015-09-13T19:55:14.657Z","team_member_agreed_on_going_public_at":"2015-09-13T19:52:48.153Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"(This report amounts to *Unsandboxed Command Execution Considered Harmful*, which you already suspected: https://secure.phabricator.com/T7785)\r\n\r\nGraphviz blocks can be used to view a render of any image file readable by the webserver, through the `image` and `shapefile` graph node attributes. This alone leaks some information (for example, installed software packages), and may help bypass access restrictions on Phabricator image files (if local disk file storage is used and the path is somehow known to the attacker).\r\n\r\nCombined with a strategically-placed syntax error in the graph specification to get to the `dot` error output, these attributes can more generally be used by an attacker to test for existence and readability of any file in the server.\r\n\r\nSteps to reproduce\r\n================\r\n* Install Graphviz along with Phabricator\r\n* Paste the attached snippet in a Remarkup field\r\n* Experience slight feelings of unease and discomfort\r\n\r\nImpact\r\n======\r\nNormally, just the limited information disclosure described above. In (what I imagine to be) a typical Phabricator installation, not even that: it is probably fully defused by the fact that `dot` is not present. However, some users may have installed Graphviz for purposes unrelated to Phabricator, unaware of the security implications.\r\n\r\nIn general, `dot` is much more complex than `cowsay` and running it unsandboxed increases your attack surface in a significant way. Besides Graphviz bugs, you will also have to worry about any libraries that Graphviz plugins use, especially for complex image formats such as PostScript and SVG.\r\n\r\n(In fact, current `dot` **will** happily tell GhostScript to run a PS file that may contain arbitrary commands. This requires a specific *\"dot with gs support + old gs\"* setup not found in any current distro AFAIK.)","vulnerability_information_html":"\u003cp\u003e(This report amounts to \u003cem\u003eUnsandboxed Command Execution Considered Harmful\u003c/em\u003e, which you already suspected: \u003ca title=\"https://secure.phabricator.com/T7785\" href=\"/redirect?url=https%3A%2F%2Fsecure.phabricator.com%2FT7785\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://secure.phabricator.com/T7785\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e)\u003c/p\u003e\n\n\u003cp\u003eGraphviz blocks can be used to view a render of any image file readable by the webserver, through the \u003ccode\u003eimage\u003c/code\u003e and \u003ccode\u003eshapefile\u003c/code\u003e graph node attributes. This alone leaks some information (for example, installed software packages), and may help bypass access restrictions on Phabricator image files (if local disk file storage is used and the path is somehow known to the attacker).\u003c/p\u003e\n\n\u003cp\u003eCombined with a strategically-placed syntax error in the graph specification to get to the \u003ccode\u003edot\u003c/code\u003e error output, these attributes can more generally be used by an attacker to test for existence and readability of any file in the server.\u003c/p\u003e\n\n\u003ch1 id=\"steps-to-reproduce\"\u003eSteps to reproduce\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003eInstall Graphviz along with Phabricator\u003c/li\u003e\n\u003cli\u003ePaste the attached snippet in a Remarkup field\u003c/li\u003e\n\u003cli\u003eExperience slight feelings of unease and discomfort\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1 id=\"impact\"\u003eImpact\u003c/h1\u003e\n\n\u003cp\u003eNormally, just the limited information disclosure described above. In (what I imagine to be) a typical Phabricator installation, not even that: it is probably fully defused by the fact that \u003ccode\u003edot\u003c/code\u003e is not present. However, some users may have installed Graphviz for purposes unrelated to Phabricator, unaware of the security implications.\u003c/p\u003e\n\n\u003cp\u003eIn general, \u003ccode\u003edot\u003c/code\u003e is much more complex than \u003ccode\u003ecowsay\u003c/code\u003e and running it unsandboxed increases your attack surface in a significant way. Besides Graphviz bugs, you will also have to worry about any libraries that Graphviz plugins use, especially for complex image formats such as PostScript and SVG.\u003c/p\u003e\n\n\u003cp\u003e(In fact, current \u003ccode\u003edot\u003c/code\u003e \u003cstrong\u003ewill\u003c/strong\u003e happily tell GhostScript to run a PS file that may contain arbitrary commands. This requires a specific \u003cem\u003e\u0026quot;dot with gs support + old gs\u0026quot;\u003c/em\u003e setup not found in any current distro AFAIK.)\u003c/p\u003e\n","bounty_amount":"300.0","formatted_bounty":"$300","weakness":{"id":18,"name":"Information Disclosure"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":53457,"file_name":"phab-graphviz-poc.remarkup","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/053/457/a4398e1dddb1e8feb0eae018b1d9130dcef8ec91/phab-graphviz-poc.remarkup?response-content-disposition=attachment%3B%20filename%3D%22phab-graphviz-poc.remarkup%22%3B%20filename%2A%3DUTF-8%27%27phab-graphviz-poc.remarkup\u0026response-content-type=text%2Fplain\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQS4MXLS4F%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T070543Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ3%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQCdPyDr833HeXJwYpWjpt%2BE8j%2FssC2h5%2FlaE7mZngOMiQIhAIhVLq5AR6H%2BIAtKS0YClrr2gxSJzGl8%2FZmOeT68dbjNKrQDCFYQARoMMDEzNjE5Mjc0ODQ5IgyLw4q7eiVATMCuJ5oqkQNRnoM2%2F7QfXwU%2Fz3OKzDhPBavarq1CsKnppYIDxpxowNYh40iJGbW36kruwk7Up1vRvNyltjF5q8qwhzaGeQZ%2BiAxZXfxuO%2B2Kcrl44J%2BblDlgfJxT%2FhANHqEJ52YkeCqL%2F8Jog8rViNOOl6oETOov%2FmlWe%2BSn52SY6oPYBRdYu%2BBKeiMV8Z7HXhpAE7juI1J25wS6dso8QH7RSAhNGIs8Y8svP20AF0GCUvT57CvEpTEKNmlMu6qBfLwB6pdnFPVBhYyN%2FfIE4%2FQa2wOG4EtJYFQfTQjLwttTt9CYHJbPWKgJsiqZWwvzgG5RucysYaY1Dvc5h%2B9x16jomi9UPmmxblIqy%2BUz9R8kd2FgetX%2B5J5YRu%2FIt1eM4Pmo0vWG1EERVUZkvMX57A4jS5kp%2F0ojOEF2BB5VpPswd3ts8BMSrW%2BwRyh9hJwmvOT24d%2FVDV1XlH12OfiqXYDHqfINlxhQS6ahBnjyeup6YaEdMK6oUB8ZRQCgIyT6ugHXy7R98squWf9jBVCuea8OVuecORCfgjCE76r%2FBTrqAVa%2BDcEKB0%2FoTap54OIKsextuoDcyV%2B5vaIZrhq52EXThW%2BXIbAp6mSkhzoWUgjsywl0H1o%2FDaG%2BNn3BBVN%2BRn45Quca4CUlobnDZ4s%2FQCgf9Z7bonFsVRNiD0YQAXIATjx%2FHm9NSP5TZgVxAil%2FiJbzMr5CzCPucZqQZHGinQXPFIlAHaN7P8LEs1k%2BYLHWhoCxufAjr4F07sxUlcZob%2BG%2FmA%2B1KCCNdIEo%2B%2BJY954m5YuWhqgrGS3SilW7Zv%2FcvslV9aFtJ6DgZI3AgcMDa3advxrZKKcSBi8tFdkDhjvGZZWiwX118rNoAQ%3D%3D\u0026X-Amz-Signature=626ce3b2200c56778c3e53b6ccc02337f4be6fc1883e2491576c55baefaad46f","file_size":635,"type":"text/plain"}],"allow_singular_disclosure_at":"2015-10-13T19:52:48.320Z","allow_singular_disclosure_after":-164459574.74121723,"singular_disclosure_allowed":true,"vote_count":0,"voters":[],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":584595,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for the report! Yeah, this is approximately the kind of thing that I imagined might exist.\n\nI think the way forward is probably just to remove these commands from the core, since the approach is unsafe and expecting end users to configure sandbox environments in a safe way is impractical. Building these rules in the first place was likely an error in judgement on my part.\n\nI think we can write safe PHP implementations of `cowsay` and `figlet` in a few hours since they're fluff, but there's probably not much to be done for `dot`. We can throw it up on \"Community Resources\" and stamp it with a bunch of \"inherently insecure\" warnings for installs that use it and don't care about the security implications. At some point, we can find or build some similar feature with a more appropriate trust model.\n\nThis week's release has a lot of stuff happening already, and these attacks are not particularly severe, and removing these features will require some documentation/guidance for installs. Consequently, I'm not planning to address this in the next 24 hours, but can likely sort it out on Saturday if nothing catches on fire (that is, I anticipate fixing this within about 48 hours).","markdown_message":"\u003cp\u003eThanks for the report! Yeah, this is approximately the kind of thing that I imagined might exist.\u003c/p\u003e\n\n\u003cp\u003eI think the way forward is probably just to remove these commands from the core, since the approach is unsafe and expecting end users to configure sandbox environments in a safe way is impractical. Building these rules in the first place was likely an error in judgement on my part.\u003c/p\u003e\n\n\u003cp\u003eI think we can write safe PHP implementations of \u003ccode\u003ecowsay\u003c/code\u003e and \u003ccode\u003efiglet\u003c/code\u003e in a few hours since they\u0026#39;re fluff, but there\u0026#39;s probably not much to be done for \u003ccode\u003edot\u003c/code\u003e. We can throw it up on \u0026quot;Community Resources\u0026quot; and stamp it with a bunch of \u0026quot;inherently insecure\u0026quot; warnings for installs that use it and don\u0026#39;t care about the security implications. At some point, we can find or build some similar feature with a more appropriate trust model.\u003c/p\u003e\n\n\u003cp\u003eThis week\u0026#39;s release has a lot of stuff happening already, and these attacks are not particularly severe, and removing these features will require some documentation/guidance for installs. Consequently, I\u0026#39;m not planning to address this in the next 24 hours, but can likely sort it out on Saturday if nothing catches on fire (that is, I anticipate fixing this within about 48 hours).\u003c/p\u003e\n","automated_response":false,"created_at":"2015-09-11T01:42:49.599Z","updated_at":"2015-09-11T01:42:49.599Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":586586,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Just a quick update: a lot of unrelated stuff came up today so I think I won't actually get to this until tomorrow.","markdown_message":"\u003cp\u003eJust a quick update: a lot of unrelated stuff came up today so I think I won\u0026#39;t actually get to this until tomorrow.\u003c/p\u003e\n","automated_response":false,"created_at":"2015-09-12T22:58:15.322Z","updated_at":"2015-09-12T22:58:15.322Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":586640,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Oh there's no rush.\n\nI expect a *very* low bodycount due to this bug.","markdown_message":"\u003cp\u003eOh there\u0026#39;s no rush.\u003c/p\u003e\n\n\u003cp\u003eI expect a \u003cem\u003every\u003c/em\u003e low bodycount due to this bug.\u003c/p\u003e\n","automated_response":false,"created_at":"2015-09-13T03:34:36.067Z","updated_at":"2015-09-13T03:34:36.067Z","actor":{"username":"jbeta","cleared":false,"url":"/jbeta","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/039/121/4bec56bea4aee1feb6535cb0727421420ab1e874_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":586986,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"I believe this is now defused in the upstream. Guidance for installs is here:\n\nhttps://secure.phabricator.com/T9408\n\nBriefly: `cowsay` and `figlet` now have pure PHP implementations. `dot` has been removed as I see no way to make it safe and or write an alternate renderer in a reasonable amount of time.","markdown_message":"\u003cp\u003eI believe this is now defused in the upstream. Guidance for installs is here:\u003c/p\u003e\n\n\u003cp\u003e\u003ca title=\"https://secure.phabricator.com/T9408\" href=\"/redirect?url=https%3A%2F%2Fsecure.phabricator.com%2FT9408\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://secure.phabricator.com/T9408\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eBriefly: \u003ccode\u003ecowsay\u003c/code\u003e and \u003ccode\u003efiglet\u003c/code\u003e now have pure PHP implementations. \u003ccode\u003edot\u003c/code\u003e has been removed as I see no way to make it safe and or write an alternate renderer in a reasonable amount of time.\u003c/p\u003e\n","automated_response":false,"created_at":"2015-09-13T19:37:12.745Z","updated_at":"2015-09-13T19:37:12.745Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"jbeta","url":"/jbeta"},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":586990,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"In assessing an award amount, I am primarily considering the relatively low severity of the attack (usually, minor information disclosure about system state), the moderate complexity in executing it (usually, the attacker must have an account and the administrator must have installed `dot`), and the upstream's suspicions that attacks in this vein were likely to exist.","markdown_message":"\u003cp\u003eIn assessing an award amount, I am primarily considering the relatively low severity of the attack (usually, minor information disclosure about system state), the moderate complexity in executing it (usually, the attacker must have an account and the administrator must have installed \u003ccode\u003edot\u003c/code\u003e), and the upstream\u0026#39;s suspicions that attacks in this vein were likely to exist.\u003c/p\u003e\n","automated_response":false,"created_at":"2015-09-13T19:51:36.673Z","updated_at":"2015-09-13T19:51:36.673Z","actor":{"url":"/phabricator","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Phabricator"}},"bounty_amount":"300.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"phabricator","collaborator":{"username":"jbeta","url":"/jbeta"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":586991,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"The fixes for this issue and guidance for installs are now publicly available, so it can be disclosed at any time.\n\nThanks again!","markdown_message":"\u003cp\u003eThe fixes for this issue and guidance for installs are now publicly available, so it can be disclosed at any time.\u003c/p\u003e\n\n\u003cp\u003eThanks again!\u003c/p\u003e\n","automated_response":false,"created_at":"2015-09-13T19:52:48.186Z","updated_at":"2015-09-13T19:52:48.186Z","first_to_agree":true,"actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":586992,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Thanks for the bounty!\n\nAs always: a pleasure reporting to you guys.","markdown_message":"\u003cp\u003eThanks for the bounty!\u003c/p\u003e\n\n\u003cp\u003eAs always: a pleasure reporting to you guys.\u003c/p\u003e\n","automated_response":false,"created_at":"2015-09-13T19:55:14.696Z","updated_at":"2015-09-13T19:55:14.696Z","actor":{"username":"jbeta","cleared":false,"url":"/jbeta","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/039/121/4bec56bea4aee1feb6535cb0727421420ab1e874_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":586993,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2015-09-13T19:55:14.831Z","updated_at":"2015-09-13T19:55:14.831Z","actor":{"username":"jbeta","cleared":false,"url":"/jbeta","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/039/121/4bec56bea4aee1feb6535cb0727421420ab1e874_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}