{"id":282339,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yODIzMzk=","url":"https://hackerone.com/reports/282339","title":"Cross-domain linkability when system time changed in Tor Browser","state":"Closed","substate":"informative","severity_rating":"low","readable_substate":"Informative","created_at":"2017-10-24T08:59:56.241Z","submitted_at":"2017-10-24T08:59:56.241Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"xiaoyinl","url":"/xiaoyinl","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/018/322/771e7ba50572621c57e02f8eed8f23fc362c4e52_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":1800,"url":"https://hackerone.com/torproject","handle":"torproject","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/001/800/6e575d0a9127b91e83833cf4a9e6be6e8b30cbc3_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/001/800/6e575d0a9127b91e83833cf4a9e6be6e8b30cbc3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Tor","twitter_handle":"torproject","website":"https://www.torproject.org/","about":"Anonymity Online"}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2017-10-26T11:30:53.199Z","bug_reporter_agreed_on_going_public_at":"2017-10-26T08:51:16.921Z","team_member_agreed_on_going_public_at":"2017-10-26T11:30:53.119Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"This report is inspired by #257942. That report uses `languagechange` event as an indicator for different tabs to link multiple visits to a single user. This report uses another trick to achieve the same thing.\n\nMalicious websites keeps reading `Date.now()` inside a `setInterval` loop with a short interval (the PoC uses 3000 ms). Normally, the values of `Date.now()` between two consecutive iterations should differ by around 3000 ms (i.e. 2900 ms - 3100 ms). However, if the user's system time changes (either by user's manual modification or by some program's auto clock synchronization), the websites can detect this change, because the time difference between two iterations are likely to be larger than 3000 ms. In this case the script can send a log to the malicious server with the current and previous timestamp. Since it is very unlikely that two users change their system clocks at the same time and with the same old/new time pair, it is possible to link the same user on different domains.\n\nPoC:\n1. Open https://xiaoyinl.github.io/dds24f/tals.html and https://jsfiddle.net/a4faupwj/ on two different tabs in Tor Browser.\n2. Change the computer's system time to more than 4 seconds later or a few seconds earlier.\n3. Check the output from the two websites.\n\nI think this issue is probably more severe than #257942, because the time change can happen without user action. There is a paper describing how major operating systems synchronize the system time and that most of the time synchronization protocol is vulnerable to MITM attacks.[1] The frequency of clock synchronization ranges from minutes to hours. The fact that Tor decreases timing precision to 100 ms doesn't really matter. Although I didn't test, I feel that if the user's clock lags more than 0.3 second right before a clock synchronization, using `setInterval(100ms)` should be able to detect that.\n\nTo fix this, the only feasible way I can think of is to prohibit non-active tabs from calling `Date.now()`.\n\n[1] https://www.blackhat.com/docs/eu-14/materials/eu-14-Selvi-Bypassing-HTTP-Strict-Transport-Security-wp.pdf","vulnerability_information_html":"\u003cp\u003eThis report is inspired by \u003ca href=\"/reports/257942\"\u003e#257942\u003c/a\u003e. That report uses \u003ccode\u003elanguagechange\u003c/code\u003e event as an indicator for different tabs to link multiple visits to a single user. This report uses another trick to achieve the same thing.\u003c/p\u003e\n\n\u003cp\u003eMalicious websites keeps reading \u003ccode\u003eDate.now()\u003c/code\u003e inside a \u003ccode\u003esetInterval\u003c/code\u003e loop with a short interval (the PoC uses 3000 ms). Normally, the values of \u003ccode\u003eDate.now()\u003c/code\u003e between two consecutive iterations should differ by around 3000 ms (i.e. 2900 ms - 3100 ms). However, if the user\u0026#39;s system time changes (either by user\u0026#39;s manual modification or by some program\u0026#39;s auto clock synchronization), the websites can detect this change, because the time difference between two iterations are likely to be larger than 3000 ms. In this case the script can send a log to the malicious server with the current and previous timestamp. Since it is very unlikely that two users change their system clocks at the same time and with the same old/new time pair, it is possible to link the same user on different domains.\u003c/p\u003e\n\n\u003cp\u003ePoC:\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003eOpen \u003ca title=\"https://xiaoyinl.github.io/dds24f/tals.html\" href=\"/redirect?url=https%3A%2F%2Fxiaoyinl.github.io%2Fdds24f%2Ftals.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://xiaoyinl.github.io/dds24f/tals.html\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e and \u003ca title=\"https://jsfiddle.net/a4faupwj/\" href=\"/redirect?url=https%3A%2F%2Fjsfiddle.net%2Fa4faupwj%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://jsfiddle.net/a4faupwj/\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e on two different tabs in Tor Browser.\u003c/li\u003e\n\u003cli\u003eChange the computer\u0026#39;s system time to more than 4 seconds later or a few seconds earlier.\u003c/li\u003e\n\u003cli\u003eCheck the output from the two websites.\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eI think this issue is probably more severe than \u003ca href=\"/reports/257942\"\u003e#257942\u003c/a\u003e, because the time change can happen without user action. There is a paper describing how major operating systems synchronize the system time and that most of the time synchronization protocol is vulnerable to MITM attacks.[1] The frequency of clock synchronization ranges from minutes to hours. The fact that Tor decreases timing precision to 100 ms doesn\u0026#39;t really matter. Although I didn\u0026#39;t test, I feel that if the user\u0026#39;s clock lags more than 0.3 second right before a clock synchronization, using \u003ccode\u003esetInterval(100ms)\u003c/code\u003e should be able to detect that.\u003c/p\u003e\n\n\u003cp\u003eTo fix this, the only feasible way I can think of is to prohibit non-active tabs from calling \u003ccode\u003eDate.now()\u003c/code\u003e.\u003c/p\u003e\n\n\u003cp\u003e[1] \u003ca title=\"https://www.blackhat.com/docs/eu-14/materials/eu-14-Selvi-Bypassing-HTTP-Strict-Transport-Security-wp.pdf\" href=\"/redirect?url=https%3A%2F%2Fwww.blackhat.com%2Fdocs%2Feu-14%2Fmaterials%2Feu-14-Selvi-Bypassing-HTTP-Strict-Transport-Security-wp.pdf\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://www.blackhat.com/docs/eu-14/materials/eu-14-Selvi-Bypassing-HTTP-Strict-Transport-Security-wp.pdf\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n","weakness":{"id":46,"name":"Privacy Violation"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":0,"voters":[],"severity":{"rating":"low","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":2098141,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Add screenshots ","markdown_message":"\u003cp\u003eAdd screenshots \u003c/p\u003e\n","automated_response":false,"created_at":"2017-10-24T09:01:34.639Z","updated_at":"2017-10-24T09:01:34.639Z","actor":{"username":"xiaoyinl","cleared":true,"url":"/xiaoyinl","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/018/322/771e7ba50572621c57e02f8eed8f23fc362c4e52_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"attachments":[{"id":232244,"filename":"time_change_2.png","type":"image/png","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/232/244/53c713df9c607a6d5bc5413e5e02bc113ab2f866/time_change_2.png?response-content-disposition=attachment%3B%20filename%3D%22time_change_2.png%22%3B%20filename%2A%3DUTF-8%27%27time_change_2.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQSFCZ3AEE%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T052241Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJFMEMCIHWigdtf4V6jrDm66WbPrvAwAjkDkGwq6jJxHgkhTBQkAh8Pm59QJ1DW90Nm%2BqUZrqPeSIGh%2B3OcvgtVLmg10uTMKrQDCFQQARoMMDEzNjE5Mjc0ODQ5IgwfS9%2FiGaxXJhRExaMqkQM%2FioQKCRd2GEb49HBlLXjeVg1H%2FoNlCjm1k0hMZ2xM%2B0x4lmIPMnshxiw4gyq5WOKYTVNGzovcoxlJKVWJ0J8ot8jIAdBOEwL1e8YBnNwskpBMy96aUxeRhk0v3RC6PmoKg5jI4Qx3q41XFLoVNJzGZBMLXknGm%2FL%2F3r3TBQO0a%2Bho9Lw4jX%2FmwWvHj8d64twZuZ4naqUS%2FC5%2FMe%2BCb7di7nj2LrLyNCU3mwVZhuZqaKYU7%2BmpmzDXhPe6vg3i0Ag1ETmf%2B4HHFKIzD1arTf4NVMuk53Qk2BUuVm8UMmZQPvicVaLBXLt7ccHpSlZil%2FS4s09xyNkmhqsb4joFjYvki4ZCYJgj6f2HgZ9j5I5jB%2BkNBEx91sV072LTXsJZGus5vwgFqmgq6%2FLSGoCBv5WZ1%2FGuoZfgjyzvsmoBX8uKpu1MK2cCSfK2OOw%2BdQcJ893qtedMSb3E%2FljNUxJf3ge6DsNwKlGjDwu7tV2CwK5eoC8nnGnfgTFitfIQRa0%2BQ7r2Yiwaq1V%2FfpNlnllKKKKFFDD1uar%2FBTrtAcWSVbs%2BpUxv20hwqIlkNrNvMi6wkgf%2BLXOkTSYmrhZJiEvr012n0TMdj9Lpp5lSBvt%2BFmQOWfNxpY3OJBDwcWAiZ%2F2ed9lHQZ21qGQ3nsQfbuRvBliy0SDSXu3rFk%2F2YIvbptRB1WpaAx7N%2FhS0S%2Bs17TOirrod7lqA3UzbN3XBtY1r%2BegR7%2FcG%2BpTuKL1SZFmW4odML8bsKnPb2rSlOtAfW6UI5KEpZRuNPIpftSdXrAErjdLnGLehSWx7Q2Iysd3y2wS8%2BnA6TfU%2Fr7xOl0wvkOaOhwXKDLm%2BA5oHA3Mxg%2F%2FTNCq8BPNgEALt%2FQ%3D%3D\u0026X-Amz-Signature=df3deeb20431644b477a13f68c6fc4d977a5ce80e8a617a1b26f8982b988aef4"},{"id":232243,"filename":"time_change_1.png","type":"image/png","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/232/243/369d738566caf6cb76b40b1801914662ba23acf4/time_change_1.png?response-content-disposition=attachment%3B%20filename%3D%22time_change_1.png%22%3B%20filename%2A%3DUTF-8%27%27time_change_1.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQSFCZ3AEE%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T052241Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJFMEMCIHWigdtf4V6jrDm66WbPrvAwAjkDkGwq6jJxHgkhTBQkAh8Pm59QJ1DW90Nm%2BqUZrqPeSIGh%2B3OcvgtVLmg10uTMKrQDCFQQARoMMDEzNjE5Mjc0ODQ5IgwfS9%2FiGaxXJhRExaMqkQM%2FioQKCRd2GEb49HBlLXjeVg1H%2FoNlCjm1k0hMZ2xM%2B0x4lmIPMnshxiw4gyq5WOKYTVNGzovcoxlJKVWJ0J8ot8jIAdBOEwL1e8YBnNwskpBMy96aUxeRhk0v3RC6PmoKg5jI4Qx3q41XFLoVNJzGZBMLXknGm%2FL%2F3r3TBQO0a%2Bho9Lw4jX%2FmwWvHj8d64twZuZ4naqUS%2FC5%2FMe%2BCb7di7nj2LrLyNCU3mwVZhuZqaKYU7%2BmpmzDXhPe6vg3i0Ag1ETmf%2B4HHFKIzD1arTf4NVMuk53Qk2BUuVm8UMmZQPvicVaLBXLt7ccHpSlZil%2FS4s09xyNkmhqsb4joFjYvki4ZCYJgj6f2HgZ9j5I5jB%2BkNBEx91sV072LTXsJZGus5vwgFqmgq6%2FLSGoCBv5WZ1%2FGuoZfgjyzvsmoBX8uKpu1MK2cCSfK2OOw%2BdQcJ893qtedMSb3E%2FljNUxJf3ge6DsNwKlGjDwu7tV2CwK5eoC8nnGnfgTFitfIQRa0%2BQ7r2Yiwaq1V%2FfpNlnllKKKKFFDD1uar%2FBTrtAcWSVbs%2BpUxv20hwqIlkNrNvMi6wkgf%2BLXOkTSYmrhZJiEvr012n0TMdj9Lpp5lSBvt%2BFmQOWfNxpY3OJBDwcWAiZ%2F2ed9lHQZ21qGQ3nsQfbuRvBliy0SDSXu3rFk%2F2YIvbptRB1WpaAx7N%2FhS0S%2Bs17TOirrod7lqA3UzbN3XBtY1r%2BegR7%2FcG%2BpTuKL1SZFmW4odML8bsKnPb2rSlOtAfW6UI5KEpZRuNPIpftSdXrAErjdLnGLehSWx7Q2Iysd3y2wS8%2BnA6TfU%2Fr7xOl0wvkOaOhwXKDLm%2BA5oHA3Mxg%2F%2FTNCq8BPNgEALt%2FQ%3D%3D\u0026X-Amz-Signature=4af4eaea51802976f847120486acd3dcdf93c8f3ad3a9b98ac1a8794f24f1fbb"}],"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2104126,"is_internal":false,"editable":false,"type":"Activities::BugInformative","message":"Just restricting `Date.now()` won't help. There is a bunch of other ways to create implicit timers that can't be defeated that way. See: https://www.torproject.org/projects/torbrowser/design/#fingerprinting-linkability  \"15. Timing-based Side Channels\" in section \"Specific Fingerprinting Defenses in the Tor Browser\".\n\nThat said I think the bug report is out of scope if you have MitM capabilities to change the system time in mind. (see: https://www.torproject.org/projects/torbrowser/design/#attacks \"4. Remotely or locally exploit browser and/or OS\"\n```\nFor the purposes of the browser itself, we limit the scope of this adversary to one that has passive forensic access to the disk after browsing activity has taken place.\n```\nThere seems to be no way to prevent that from the browser side. The same holds for a user changing the system time. I mean we could show them a popup or notification asking \"Hey, did you just change the system time? That's dangerous because of...\" but even that would be too late.","markdown_message":"\u003cp\u003eJust restricting \u003ccode\u003eDate.now()\u003c/code\u003e won\u0026#39;t help. There is a bunch of other ways to create implicit timers that can\u0026#39;t be defeated that way. See: \u003ca title=\"https://www.torproject.org/projects/torbrowser/design/#fingerprinting-linkability\" href=\"/redirect?url=https%3A%2F%2Fwww.torproject.org%2Fprojects%2Ftorbrowser%2Fdesign%2F%23fingerprinting-linkability\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://www.torproject.org/projects/torbrowser/design/#fingerprinting-linkability\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e  \u0026quot;15. Timing-based Side Channels\u0026quot; in section \u0026quot;Specific Fingerprinting Defenses in the Tor Browser\u0026quot;.\u003c/p\u003e\n\n\u003cp\u003eThat said I think the bug report is out of scope if you have MitM capabilities to change the system time in mind. (see: \u003ca title=\"https://www.torproject.org/projects/torbrowser/design/#attacks\" href=\"/redirect?url=https%3A%2F%2Fwww.torproject.org%2Fprojects%2Ftorbrowser%2Fdesign%2F%23attacks\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://www.torproject.org/projects/torbrowser/design/#attacks\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e \u0026quot;4. Remotely or locally exploit browser and/or OS\u0026quot;\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eFor the purposes of the browser itself, we limit the scope of this adversary to one that has passive forensic access to the disk after browsing activity has taken place.\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThere seems to be no way to prevent that from the browser side. The same holds for a user changing the system time. I mean we could show them a popup or notification asking \u0026quot;Hey, did you just change the system time? That\u0026#39;s dangerous because of...\u0026quot; but even that would be too late.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-10-26T08:03:56.221Z","updated_at":"2017-10-26T08:03:56.221Z","actor":{"username":"geko","cleared":false,"url":"/geko","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2104194,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Actually I didn't mean to give the adversaries MitM capabilities. My point is the malicious websites just wait and hope that the system time happens to be a few hundred milliseconds behind the standard time when the OS synchronize the clock, or the users manually change the clock.\n\nThat said, I see your point that such attack is unlikely to succeed and there's no way to prevent. Can we disclose this report?\n","markdown_message":"\u003cp\u003eActually I didn\u0026#39;t mean to give the adversaries MitM capabilities. My point is the malicious websites just wait and hope that the system time happens to be a few hundred milliseconds behind the standard time when the OS synchronize the clock, or the users manually change the clock.\u003c/p\u003e\n\n\u003cp\u003eThat said, I see your point that such attack is unlikely to succeed and there\u0026#39;s no way to prevent. Can we disclose this report?\u003c/p\u003e\n","automated_response":false,"created_at":"2017-10-26T08:51:16.938Z","updated_at":"2017-10-26T08:51:16.938Z","first_to_agree":true,"actor":{"username":"xiaoyinl","cleared":true,"url":"/xiaoyinl","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/018/322/771e7ba50572621c57e02f8eed8f23fc362c4e52_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2104471,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-10-26T11:30:53.155Z","updated_at":"2017-10-26T11:30:53.155Z","actor":{"username":"geko","cleared":false,"url":"/geko","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2104472,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-10-26T11:30:53.251Z","updated_at":"2017-10-26T11:30:53.251Z","actor":{"username":"geko","cleared":false,"url":"/geko","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"torproject","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}