{"id":508894,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC81MDg4OTQ=","url":"https://hackerone.com/reports/508894","title":"Vulnerability in GoldSource Engine allows to upload and run an arbitrary DLL on client","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2019-03-13T00:29:26.137Z","submitted_at":"2019-03-13T00:29:26.137Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"kohtep2010","url":"/kohtep2010","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/ZLr6Jvt7ixmtsP1vjXVwpdye/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":23363,"url":"https://hackerone.com/valve","handle":"valve","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/023/363/c78d46a7d0ea39e3a15a7c19c1a48634f2571eb9_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/023/363/c78d46a7d0ea39e3a15a7c19c1a48634f2571eb9_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Valve","twitter_handle":"","website":"https://www.valvesoftware.com","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"no-content","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2020-03-25T22:02:00.522Z","bug_reporter_agreed_on_going_public_at":"2020-03-08T09:27:09.594Z","team_member_agreed_on_going_public_at":"2020-03-25T22:02:00.371Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"","vulnerability_information_html":"","bounty_amount":"1000.0","formatted_bounty":"$1,000","weakness":{"id":76,"name":"Malware"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":10,"voters":["njbooher","mvc","spam404","romesful","mygf","brodie_codie","s4nderdevelopment","mr_teejay","fatzombi","hupernikao"],"severity":{"rating":"high","author_type":"Team"},"structured_scope":{"databaseId":1289,"asset_type":"DOWNLOADABLE_EXECUTABLES","asset_identifier":"hl.exe","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":4322417,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2019-03-14T11:56:18.764Z","updated_at":"2019-03-14T11:56:18.764Z","actor":{"username":"nasr0x01","cleared":false,"url":"/nasr0x01","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/386/674/ec2e2c825a554851c42c122ffd61aa8f18b08174_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4322422,"is_internal":false,"editable":false,"type":"Activities::BugNeedsMoreInfo","message":"","markdown_message":"","automated_response":false,"created_at":"2019-03-14T11:58:28.162Z","updated_at":"2019-03-14T11:58:28.162Z","actor":{"username":"nasr0x01","cleared":false,"url":"/nasr0x01","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/386/674/ec2e2c825a554851c42c122ffd61aa8f18b08174_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4322517,"is_internal":false,"editable":false,"type":"Activities::BugNew","message":"","markdown_message":"","automated_response":false,"created_at":"2019-03-14T12:28:05.519Z","updated_at":"2019-03-14T12:28:05.519Z","actor":{"username":"kohtep2010","cleared":false,"url":"/kohtep2010","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ZLr6Jvt7ixmtsP1vjXVwpdye/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4333990,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","markdown_message":"","automated_response":false,"created_at":"2019-03-15T20:16:24.970Z","updated_at":"2019-03-15T20:16:24.970Z","additional_data":{},"actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4333991,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2019-03-15T20:16:26.491Z","updated_at":"2019-03-15T20:16:26.491Z","actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4334105,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2019-03-15T20:45:46.845Z","updated_at":"2019-03-15T20:45:46.845Z","actor":{"username":"kohtep2010","cleared":false,"url":"/kohtep2010","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ZLr6Jvt7ixmtsP1vjXVwpdye/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4335018,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2019-03-16T02:00:47.499Z","updated_at":"2019-03-16T02:00:47.499Z","actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4335026,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2019-03-16T02:05:06.832Z","updated_at":"2019-03-16T02:05:06.832Z","actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4335116,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2019-03-16T03:13:05.574Z","updated_at":"2019-03-16T03:13:05.574Z","actor":{"username":"kohtep2010","cleared":false,"url":"/kohtep2010","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ZLr6Jvt7ixmtsP1vjXVwpdye/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4336965,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2019-03-16T13:12:28.447Z","updated_at":"2019-03-16T13:12:28.447Z","actor":{"username":"nasr0x01","cleared":false,"url":"/nasr0x01","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/386/674/ec2e2c825a554851c42c122ffd61aa8f18b08174_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4629842,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2019-04-23T21:19:34.187Z","updated_at":"2019-04-23T21:19:34.187Z","actor":{"url":"/valve","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/023/363/c78d46a7d0ea39e3a15a7c19c1a48634f2571eb9_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Valve"}},"bounty_amount":"1000.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"valve","collaborator":{"username":"kohtep2010","url":"/kohtep2010"},"actor_is_team_member":true,"actor_is_concealed_member":true},{"id":4629843,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","markdown_message":"","automated_response":false,"created_at":"2019-04-23T21:19:50.703Z","updated_at":"2019-04-23T21:19:50.703Z","actor":{"username":"percybysshe","cleared":false,"url":"/percybysshe","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/vuZfWG7XewsudrWa6NCkyxkZ/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"kohtep2010","url":"/kohtep2010"},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":7255069,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-03-08T09:27:09.610Z","updated_at":"2020-03-08T09:27:09.610Z","first_to_agree":true,"actor":{"username":"kohtep2010","cleared":false,"url":"/kohtep2010","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ZLr6Jvt7ixmtsP1vjXVwpdye/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7442246,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-03-25T22:02:00.406Z","updated_at":"2020-03-25T22:02:00.406Z","actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7442247,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-03-25T22:02:00.551Z","updated_at":"2020-03-25T22:02:00.551Z","actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"id":20876,"category":"team","content":"###Introduction\n\nGreetings. In GoldSource Engine there is a vulnerability that allows to run an arbitrary DLL on the client, using the flaws in the file downloading system.\n\n###Description\n\nPart of the problem is hidden in the **CL_BatchResourceRequest** function. This is a client function that is responsible for adding a list of server files to the download queue. Files added to the queue can be of different types: sound, model, decal, generic, eventscript, skin. Before adding to the queue, some types of resources are tested for validity using the **IsSafeFileToDownload** function. This is where the problem arises.\n\n**IsSafeFileToDownload** function is used only in generic resources, all other types rely only on the **CL_CheckFile** check, which has a very poor set of rules, according to IDA pseudocode for 7960 engine build:\n\n```if ( Q_strstr(pFileName, \"..\") || Q_strstr(pFileName, \"server.cfg\") )\n{\n  Con_DPrintf(\"Refusing to download a path with '..'\\n\");\n  return 1;\n}```\n\nAs you can see, only the presence of double-dot and the file name server.cfg substrings in the variable pFileName are checked.\n\nFile transfer under the server-\u003eclient scheme can be done in two ways:\n\n* With the help of netchan (UDP);\n* Using HTTP.\n\nOf course, if we try to transfer the file using the first method, we will fail, because when the file is downloaded, IsSafeFileToDownload is still will be executed in **Netchan_CopyFileFragments** function, although the progress of the file transfer will be shown.\n\n{F440411}\n\nBut this does not apply to the second method, where the file will be downloaded fairly quickly and will not pass any verification function.\n\nSuch architecture creates security holes. Thus, the server has the ability to upload any file to the mod folder on the client, bypassing the IsSafeFileToDownload filter. You can upload any file, from the autoexec.cfg script to the TrackerUI.dll library, which is loaded by the client.dll library in the **Initialize** function. There is no such library in the vanilla Half-Life 1 and Counter-Strike 1.6 games, which allows you to upload malware library on the any mod.\n\n###How to reproduce\n\n1. Specify the sv_downloadurl console variable for the client to download the file using the HTTP protocol (http://127.0.0.1 will be enough for local tests).\n2. In the **SV_CreateResourceList** function, call the following code: ```SV_AddResource (t_eventscript, filename, FS_FileSize (filename), RES_FATALIFMISSING, 0);```, where **filename** is the name of a file with a forbidden extension, for example, **bin\\TrackerUI.dll**.\n3. Upload bin\\TrackerUI.dll to the hosting specified in sv_downloadurl.\n4. Connect to the server.\n\nAs a result, client will download the library bin\\TrackerUI.dll, which should not be downloaded, following the IsSafeFileToDownload rules, and will be loaded the next time the game starts.\n\n###Possible solutions\n\nReplace the **CL_CheckFile** function code above with the following one:\n\n```if (! IsSafeFileToDownload (pFileName) )\n{\nCon_DPrintf (\"Refusing to download restricted file.\\n\");\nreturn 1;\n}```\n\n## Impact\n\nServer has the ability to arrange a massive infection of the players by spreading a malware library.","can_view?":true,"can_edit?":false,"content_html":"\u003ch3 id=\"introduction\"\u003eIntroduction\u003c/h3\u003e\n\n\u003cp\u003eGreetings. In GoldSource Engine there is a vulnerability that allows to run an arbitrary DLL on the client, using the flaws in the file downloading system.\u003c/p\u003e\n\n\u003ch3 id=\"description\"\u003eDescription\u003c/h3\u003e\n\n\u003cp\u003ePart of the problem is hidden in the \u003cstrong\u003eCL_BatchResourceRequest\u003c/strong\u003e function. This is a client function that is responsible for adding a list of server files to the download queue. Files added to the queue can be of different types: sound, model, decal, generic, eventscript, skin. Before adding to the queue, some types of resources are tested for validity using the \u003cstrong\u003eIsSafeFileToDownload\u003c/strong\u003e function. This is where the problem arises.\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eIsSafeFileToDownload\u003c/strong\u003e function is used only in generic resources, all other types rely only on the \u003cstrong\u003eCL_CheckFile\u003c/strong\u003e check, which has a very poor set of rules, according to IDA pseudocode for 7960 engine build:\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eif ( Q_strstr(pFileName, \u0026quot;..\u0026quot;) || Q_strstr(pFileName, \u0026quot;server.cfg\u0026quot;) )\u003cbr\u003e\n{\u003cbr\u003e\n  Con_DPrintf(\u0026quot;Refusing to download a path with \u0026#39;..\u0026#39;\\n\u0026quot;);\u003cbr\u003e\n  return 1;\u003cbr\u003e\n}\u003c/code\u003e\u003c/p\u003e\n\n\u003cp\u003eAs you can see, only the presence of double-dot and the file name server.cfg substrings in the variable pFileName are checked.\u003c/p\u003e\n\n\u003cp\u003eFile transfer under the server-\u0026gt;client scheme can be done in two ways:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eWith the help of netchan (UDP);\u003c/li\u003e\n\u003cli\u003eUsing HTTP.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eOf course, if we try to transfer the file using the first method, we will fail, because when the file is downloaded, IsSafeFileToDownload is still will be executed in \u003cstrong\u003eNetchan_CopyFileFragments\u003c/strong\u003e function, although the progress of the file transfer will be shown.\u003c/p\u003e\n\n\u003cp\u003e{F440411}\u003c/p\u003e\n\n\u003cp\u003eBut this does not apply to the second method, where the file will be downloaded fairly quickly and will not pass any verification function.\u003c/p\u003e\n\n\u003cp\u003eSuch architecture creates security holes. Thus, the server has the ability to upload any file to the mod folder on the client, bypassing the IsSafeFileToDownload filter. You can upload any file, from the autoexec.cfg script to the TrackerUI.dll library, which is loaded by the client.dll library in the \u003cstrong\u003eInitialize\u003c/strong\u003e function. There is no such library in the vanilla Half-Life 1 and Counter-Strike 1.6 games, which allows you to upload malware library on the any mod.\u003c/p\u003e\n\n\u003ch3 id=\"how-to-reproduce\"\u003eHow to reproduce\u003c/h3\u003e\n\n\u003col\u003e\n\u003cli\u003eSpecify the sv_downloadurl console variable for the client to download the file using the HTTP protocol (\u003ca title=\"http://127.0.0.1\" href=\"/redirect?url=http%3A%2F%2F127.0.0.1\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttp://127.0.0.1\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e will be enough for local tests).\u003c/li\u003e\n\u003cli\u003eIn the \u003cstrong\u003eSV_CreateResourceList\u003c/strong\u003e function, call the following code: \u003ccode\u003eSV_AddResource (t_eventscript, filename, FS_FileSize (filename), RES_FATALIFMISSING, 0);\u003c/code\u003e, where \u003cstrong\u003efilename\u003c/strong\u003e is the name of a file with a forbidden extension, for example, \u003cstrong\u003ebin\\TrackerUI.dll\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003eUpload bin\\TrackerUI.dll to the hosting specified in sv_downloadurl.\u003c/li\u003e\n\u003cli\u003eConnect to the server.\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eAs a result, client will download the library bin\\TrackerUI.dll, which should not be downloaded, following the IsSafeFileToDownload rules, and will be loaded the next time the game starts.\u003c/p\u003e\n\n\u003ch3 id=\"possible-solutions\"\u003ePossible solutions\u003c/h3\u003e\n\n\u003cp\u003eReplace the \u003cstrong\u003eCL_CheckFile\u003c/strong\u003e function code above with the following one:\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eif (! IsSafeFileToDownload (pFileName) )\u003cbr\u003e\n{\u003cbr\u003e\nCon_DPrintf (\u0026quot;Refusing to download restricted file.\\n\u0026quot;);\u003cbr\u003e\nreturn 1;\u003cbr\u003e\n}\u003c/code\u003e\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eServer has the ability to arrange a massive infection of the players by spreading a malware library.\u003c/p\u003e\n"},{"category":"researcher","can_view?":true,"can_create?":false}]}