{"id":31756,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8zMTc1Ng==","url":"https://hackerone.com/reports/31756","title":"Drupal 7 pre auth sql injection and remote code execution","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2014-10-17T10:50:36.095Z","submitted_at":"2014-10-17T10:50:36.095Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"shorst","url":"/shorst","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/013/129/b3a8bbba666ff094324c34395e9cf0afa6bf08be_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":20,"url":"https://hackerone.com/internet","handle":"internet","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/e3e1c58882b2645d9108ec102731a354cbf5852e_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/e3e1c58882b2645d9108ec102731a354cbf5852e_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"The Internet","twitter_handle":null,"website":"","about":"Hack all the things."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2015-04-06T09:40:09.432Z","bug_reporter_agreed_on_going_public_at":"2015-04-06T09:40:07.380Z","team_member_agreed_on_going_public_at":"2015-04-06T02:21:41.959Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"# Motivation\r\nI found a SQL Injection bug in Drupal \u003c 7.32. Which can lead to a code execution. \r\n\r\nYou need not have any user or knowledge of the targeted site.\r\n\r\nSince Drupal is used as they state by \"millions of websites and applications\" I thought about applying for this bug bounty.\r\n\r\n# The Bug\r\nDrupal uses Prepared Statements to secure the SQL Querys from Injections. To handle IN statements they created a expandArguments function, which uses the Array keys to create names for the placeholders. \r\n\r\n    foreach ($data as $i =\u003e $value) {\r\n          [...]\r\n          $new_keys[$key . '_' . $i] = $value;\r\n    }\r\n\r\nThe function assumes that it is called with an array which has no keys. Example:\r\n\r\n    db_query(\"SELECT * FROM {users} where name IN (:name)\", array(':name'=\u003earray('user1','user2')));\r\n\r\nWhich results in this SQL Statement\r\n\r\n    SELECT * from users where name IN (:name_0, :name_1)\r\n\r\nwith the parameters name_0 = user1 and name_1 = user2.\r\n\r\nThe Problem occurs, if the array has keys, which are no integers. Example:\r\n\r\n    db_query(\"SELECT * FROM {users} where name IN (:name)\", array(':name'=\u003earray('test) -- ' =\u003e 'user1','test' =\u003e 'user2')));\r\n\r\nthis results in an exploitable SQL query:\r\n\r\n     SELECT * FROM users WHERE name IN (:name_test) -- , :name_test )\r\n\r\nwith parameters :name_test = user2.\r\n\r\nSince Drupal uses PDO, multi-queries are allowed. So this SQL Injection can be used to insert arbitrary data in the database, dump or modify existing data or drop the whole database.\r\n\r\nWith the possibility to INSERT arbitrary data into the database an attacker can execute any PHP code through a manipulated Session and Drupal features with callbacks.\r\n\r\n# Advisory\r\nhttps://www.sektioneins.de/advisories/advisory-012014-drupal-pre-auth-sql-injection-vulnerability.html\r\n\r\n# CVE Information\r\nThe Common Vulnerabilities and Exposures project (cve.mitre.org) has assigned the name CVE-2014-3704 to this vulnerability.\r\n\r\n# Poc\r\nI included two PoCs. The first creates one request to create a session which has Admin privileges (UserID 1). The second executes code with only one request and destroys the session afterwards to not create a new Database entry. Some parts of the Second PoC were discovered with help of my coworker Stefan Esser.","vulnerability_information_html":"\u003ch1 id=\"motivation\"\u003eMotivation\u003c/h1\u003e\n\n\u003cp\u003eI found a SQL Injection bug in Drupal \u0026lt; 7.32. Which can lead to a code execution. \u003c/p\u003e\n\n\u003cp\u003eYou need not have any user or knowledge of the targeted site.\u003c/p\u003e\n\n\u003cp\u003eSince Drupal is used as they state by \u0026quot;millions of websites and applications\u0026quot; I thought about applying for this bug bounty.\u003c/p\u003e\n\n\u003ch1 id=\"the-bug\"\u003eThe Bug\u003c/h1\u003e\n\n\u003cp\u003eDrupal uses Prepared Statements to secure the SQL Querys from Injections. To handle IN statements they created a expandArguments function, which uses the Array keys to create names for the placeholders. \u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eforeach ($data as $i =\u0026gt; $value) {\n      [...]\n      $new_keys[$key . \u0026#39;_\u0026#39; . $i] = $value;\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe function assumes that it is called with an array which has no keys. Example:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003edb_query(\u0026quot;SELECT * FROM {users} where name IN (:name)\u0026quot;, array(\u0026#39;:name\u0026#39;=\u0026gt;array(\u0026#39;user1\u0026#39;,\u0026#39;user2\u0026#39;)));\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eWhich results in this SQL Statement\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eSELECT * from users where name IN (:name_0, :name_1)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003ewith the parameters name_0 = user1 and name_1 = user2.\u003c/p\u003e\n\n\u003cp\u003eThe Problem occurs, if the array has keys, which are no integers. Example:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003edb_query(\u0026quot;SELECT * FROM {users} where name IN (:name)\u0026quot;, array(\u0026#39;:name\u0026#39;=\u0026gt;array(\u0026#39;test) -- \u0026#39; =\u0026gt; \u0026#39;user1\u0026#39;,\u0026#39;test\u0026#39; =\u0026gt; \u0026#39;user2\u0026#39;)));\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003ethis results in an exploitable SQL query:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e SELECT * FROM users WHERE name IN (:name_test) -- , :name_test )\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003ewith parameters :name_test = user2.\u003c/p\u003e\n\n\u003cp\u003eSince Drupal uses PDO, multi-queries are allowed. So this SQL Injection can be used to insert arbitrary data in the database, dump or modify existing data or drop the whole database.\u003c/p\u003e\n\n\u003cp\u003eWith the possibility to INSERT arbitrary data into the database an attacker can execute any PHP code through a manipulated Session and Drupal features with callbacks.\u003c/p\u003e\n\n\u003ch1 id=\"advisory\"\u003eAdvisory\u003c/h1\u003e\n\n\u003cp\u003e\u003ca title=\"https://www.sektioneins.de/advisories/advisory-012014-drupal-pre-auth-sql-injection-vulnerability.html\" href=\"/redirect?url=https%3A%2F%2Fwww.sektioneins.de%2Fadvisories%2Fadvisory-012014-drupal-pre-auth-sql-injection-vulnerability.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://www.sektioneins.de/advisories/advisory-012014-drupal-pre-auth-sql-injection-vulnerability.html\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1 id=\"cve-information\"\u003eCVE Information\u003c/h1\u003e\n\n\u003cp\u003eThe Common Vulnerabilities and Exposures project (cve.mitre.org) has assigned the name CVE-2014-3704 to this vulnerability.\u003c/p\u003e\n\n\u003ch1 id=\"poc\"\u003ePoc\u003c/h1\u003e\n\n\u003cp\u003eI included two PoCs. The first creates one request to create a session which has Admin privileges (UserID 1). The second executes code with only one request and destroys the session afterwards to not create a new Database entry. Some parts of the Second PoC were discovered with help of my coworker Stefan Esser.\u003c/p\u003e\n","bounty_amount":"3000.0","formatted_bounty":"$3,000","weakness":{"id":67,"name":"SQL Injection"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":18972,"file_name":"poc.tgz","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/018/972/a84ca61f69d55f4a9c37e47021cdbfd9277bfd70/poc.tgz?response-content-disposition=attachment%3B%20filename%3D%22poc.tgz%22%3B%20filename%2A%3DUTF-8%27%27poc.tgz\u0026response-content-type=application%2Fx-gzip\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQR35GR77K%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T053351Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ3%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQCkRanG9z5zVLdCyDzQPrLE3FYUPIiibXLrC%2FbV7ethQgIgW3VYr7ML9zFS7keXgTden2zkvr6xtk%2Bwqk4LfHGPkcUqtAMIVhABGgwwMTM2MTkyNzQ4NDkiDCiVagLxMUVikdnfsCqRA2ESo%2FIThyM%2BI3TCZtigaox50Q4zhKxTQUgUM4jlR9ukMcmdu%2BCIgxqNXnFit2GwvZneedN1j%2Bbb2Lf%2Fk9LJIBloG0%2BBQ0DIW5llPzhlHBsf8qtXHgtlw3rsN1B9wIqRFFMGG4erHLHiQ927dumft3fH4WdUWWVFhaFZW%2Bw4BBxYga3%2FaAi3ovDfVVALXK5%2BpCaFWVs%2FpaNk%2FyE3nUH75JZvja1tpNt%2F6qsqsoaXl8ySebrstQXUEOB%2Be7AzgomPo1txxlxQRCWAxLJ91zb%2F8zbc4Mpqm3pYwpxNZNRMuJXf4gzHggFM%2F7EkopM926Hsh9N4eLnJ1YBbqX5nnqAx55PEzHirbBxZ31aDZRbfbmB1%2BCiOEV8iMEpwvIsyUZuOSffvpzs7Qe3dj2pI6zhzA0wUT5LPywpwV5LVDQwbGng87pA%2Bgtcg27onS7Jn48hXv6UkYG%2FjlBuSEho0agiNLjv8bIxpSHhah2llBo0iC%2FiJ6%2FmqISjfYpqB%2FXgA1aFX1J8VmBmDpEvse7vhRyn5GK%2BNMMjyqv8FOusBHTvY1UWZJTekbF8f0h5%2Fm9EETlkX57JGosj1P6za%2F%2BD1YhhGhxzYMqBjP4hJZrSDsKea8vBxlLbsPJ8Zp1AAhrC9YRtCof2hTYz2%2BhsURQSGCBeuFyIDmWSH5JQoO43ilJhDzyewxnrYD%2BeM5KfEX4%2Fn5D9vBPxSv0EAr8PalTK5ZAcoJBHWWJ9pMQRjAqFKZVsT5TOjOi1OL0hsm4jWxfvejzxF5%2F3DrF%2BlMwOzwjOAJZgOrX0soe5jTVlSMpmCtRzgiDMIQz0P5TQyzi0oxvgKgrkhIF7bwqbkYqDYIH4z2J2IflgXhzV%2BUQ%3D%3D\u0026X-Amz-Signature=b830a43e183399d835985efaaf0d6ae905fbc7d95321d267b0737711aaf7cf4a","file_size":6223,"type":"application/x-gzip"}],"allow_singular_disclosure_at":"2015-05-06T02:21:42.364Z","allow_singular_disclosure_after":-178341128.75445867,"singular_disclosure_allowed":true,"vote_count":9,"voters":["naategh","pavanw3b","harshjoshi_10","nihilo","jonanv","pavan97","nakjarak","safisec","0x-"],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":153776,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Two weeks after the Bug the Drupal Security Team released this statement:\n\n *Automated attacks began compromising Drupal 7 websites that were not patched or updated to Drupal 7.32 within hours of the announcement of SA-CORE-2014-005 - Drupal core - SQL injection. You should proceed under the assumption that every Drupal 7 website was compromised unless updated or patched before Oct 15th, 11pm UTC, that is 7 hours after the announcement.*\n\nThis is why I wrote some additional infos about the Bug and two PoCs to our website: https://www.sektioneins.de/blog/14-11-03-drupal-sql-injection-vulnerability-PoC.html","markdown_message":"\u003cp\u003eTwo weeks after the Bug the Drupal Security Team released this statement:\u003c/p\u003e\n\n\u003cp\u003e\u003cem\u003eAutomated attacks began compromising Drupal 7 websites that were not patched or updated to Drupal 7.32 within hours of the announcement of SA-CORE-2014-005 - Drupal core - SQL injection. You should proceed under the assumption that every Drupal 7 website was compromised unless updated or patched before Oct 15th, 11pm UTC, that is 7 hours after the announcement.\u003c/em\u003e\u003c/p\u003e\n\n\u003cp\u003eThis is why I wrote some additional infos about the Bug and two PoCs to our website: \u003ca title=\"https://www.sektioneins.de/blog/14-11-03-drupal-sql-injection-vulnerability-PoC.html\" href=\"/redirect?url=https%3A%2F%2Fwww.sektioneins.de%2Fblog%2F14-11-03-drupal-sql-injection-vulnerability-PoC.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://www.sektioneins.de/blog/14-11-03-drupal-sql-injection-vulnerability-PoC.html\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n","automated_response":false,"created_at":"2014-11-04T21:31:11.551Z","updated_at":"2014-11-04T21:31:11.551Z","actor":{"username":"shorst","cleared":false,"url":"/shorst","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/129/b3a8bbba666ff094324c34395e9cf0afa6bf08be_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"internet","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":161690,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"We don't currently offer bounties on Drupal vulnerabilities, but this one might have been severe enough for an exception. I'll nominate to the panel and get back to you shortly. Thanks!","markdown_message":"\u003cp\u003eWe don\u0026#39;t currently offer bounties on Drupal vulnerabilities, but this one might have been severe enough for an exception. I\u0026#39;ll nominate to the panel and get back to you shortly. Thanks!\u003c/p\u003e\n","automated_response":false,"created_at":"2014-11-17T06:34:27.914Z","updated_at":"2014-11-17T06:34:27.914Z","actor":{"username":"arice","cleared":false,"url":"/arice","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/83152cb2d070f3f6a63c1b61bae47257722b5ad2_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"internet","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":320573,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"hey, wanted to ask if there is any news? BR","markdown_message":"\u003cp\u003ehey, wanted to ask if there is any news? BR\u003c/p\u003e\n","automated_response":false,"created_at":"2015-01-29T15:49:47.527Z","updated_at":"2015-01-29T15:49:47.527Z","actor":{"username":"shorst","cleared":false,"url":"/shorst","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/129/b3a8bbba666ff094324c34395e9cf0afa6bf08be_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"internet","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":372802,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","markdown_message":"","automated_response":false,"created_at":"2015-04-06T02:20:11.315Z","updated_at":"2015-04-06T02:20:11.315Z","actor":{"username":"arice","cleared":false,"url":"/arice","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/83152cb2d070f3f6a63c1b61bae47257722b5ad2_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"reporter":{"username":"shorst","url":"/shorst"},"genius_execution_id":null,"team_handle":"internet","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":372804,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"We went in circles for a bit on this one given that it's an unusual bounty for the program, but the severity and active exploitation observed here warrant an exception. Thanks for the great find!","markdown_message":"\u003cp\u003eWe went in circles for a bit on this one given that it\u0026#39;s an unusual bounty for the program, but the severity and active exploitation observed here warrant an exception. Thanks for the great find!\u003c/p\u003e\n","automated_response":false,"created_at":"2015-04-06T02:21:36.211Z","updated_at":"2015-04-06T02:21:36.211Z","actor":{"url":"/internet","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/e3e1c58882b2645d9108ec102731a354cbf5852e_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"The Internet"}},"bounty_amount":"3000.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"internet","collaborator":{"username":"shorst","url":"/shorst"},"actor_is_team_member":false,"actor_is_concealed_member":false},{"id":372805,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2015-04-06T02:21:42.035Z","updated_at":"2015-04-06T02:21:42.035Z","first_to_agree":true,"actor":{"username":"arice","cleared":false,"url":"/arice","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/83152cb2d070f3f6a63c1b61bae47257722b5ad2_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"internet","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":372956,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2015-04-06T09:40:07.837Z","updated_at":"2015-04-06T09:40:07.837Z","actor":{"username":"shorst","cleared":false,"url":"/shorst","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/129/b3a8bbba666ff094324c34395e9cf0afa6bf08be_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"internet","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":372957,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2015-04-06T09:40:09.464Z","updated_at":"2015-04-06T09:40:09.464Z","actor":{"username":"shorst","cleared":false,"url":"/shorst","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/129/b3a8bbba666ff094324c34395e9cf0afa6bf08be_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"internet","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}