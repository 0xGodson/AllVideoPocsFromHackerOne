{"id":737163,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC83MzcxNjM=","url":"https://hackerone.com/reports/737163","title":"SSRF - Image Sources in HTML Snippets - 727234 bypass","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2019-11-14T02:33:45.493Z","submitted_at":"2019-11-14T02:33:45.493Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"zhutyra","url":"/zhutyra","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":8906,"url":"https://hackerone.com/open-xchange","handle":"open-xchange","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/JtYLEsu5yRZxGitSmAjeAFtK/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/JtYLEsu5yRZxGitSmAjeAFtK/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Open-Xchange","twitter_handle":"openxchange","website":"https://www.open-xchange.com/","about":"Messaging, collaboration and office productivity software for service providers"}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2020-02-20T10:46:55.948Z","bug_reporter_agreed_on_going_public_at":"2020-02-20T10:46:55.870Z","team_member_agreed_on_going_public_at":"2020-02-19T13:41:53.341Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"This is about incomplete fix for my recent bug #727234.\n\nIn short, the **/ajax/snippet?action=import** endpoint allows to create HTML snippets. URLs of images are extracted from HTML and their content is fetched and attached to created snippet. For more details please see #727234.\n\nWith the fix applied, the URL is validated before accessed. However only *initial* address is checked. If this initially valid location redirects to another location, this *replacement* location isn't checked and still can be any internal address, effectively bypassing the validation.\n```\nhttp://attacker.com/looks/safe --\u003e http://internal/insecure\n```\n\nAgain a demo program is attached and should produce output like this:\n```\nhttp://localhost:22/\nno error\nhttp://localhost:23/\nAn I/O error occurred: Connection refused (Connection refused)\nhttp://localhost:443/\nInvalid or harmful image data detected.\nhttp://localhost:444/\nAn I/O error occurred: Connection refused (Connection refused)\n```\n\n## Impact\n\nAn attacker can trigger requests to internal resources and observer results.","vulnerability_information_html":"\u003cp\u003eThis is about incomplete fix for my recent bug \u003ca href=\"/reports/727234\"\u003e#727234\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003eIn short, the \u003cstrong\u003e/ajax/snippet?action=import\u003c/strong\u003e endpoint allows to create HTML snippets. URLs of images are extracted from HTML and their content is fetched and attached to created snippet. For more details please see \u003ca href=\"/reports/727234\"\u003e#727234\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003eWith the fix applied, the URL is validated before accessed. However only \u003cem\u003einitial\u003c/em\u003e address is checked. If this initially valid location redirects to another location, this \u003cem\u003ereplacement\u003c/em\u003e location isn\u0026#39;t checked and still can be any internal address, effectively bypassing the validation.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003ehttp://attacker.com/looks/safe --\u0026gt; http://internal/insecure\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAgain a demo program is attached and should produce output like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003ehttp://localhost:22/\nno error\nhttp://localhost:23/\nAn I/O error occurred: Connection refused (Connection refused)\nhttp://localhost:443/\nInvalid or harmful image data detected.\nhttp://localhost:444/\nAn I/O error occurred: Connection refused (Connection refused)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eAn attacker can trigger requests to internal resources and observer results.\u003c/p\u003e\n","bounty_amount":"400.0","formatted_bounty":"$400","weakness":{"id":68,"name":"Server-Side Request Forgery (SSRF)"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":633866,"file_name":"ox-snippets-redir.py","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/cSkmKdDD1Ddm7CjYJh7WXdtP?response-content-disposition=attachment%3B%20filename%3D%22ox-snippets-redir.py%22%3B%20filename%2A%3DUTF-8%27%27ox-snippets-redir.py\u0026response-content-type=text%2Fx-python\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQSUJSTWNA%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T064429Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDC4LZo82wc2eCvBFlhjwE027CwJoHB88%2BMK2v03JEf7AIgTsNTuR7XI5zLkpcU%2F192zliPMALv25wXWHyoW56mHW0qtAMIVRABGgwwMTM2MTkyNzQ4NDkiDDQxd6Ep%2FudaJolhjiqRA%2FV9m3Q5qTHiEf%2B0F56QxIa0FX4xcw3kyVQ754zuEWG6%2FFHm5u50c%2FkjIZTK4iokf%2F5bg8%2F9lzPcfaf%2FlyMeeuZQiIR66c8Q0ZynlQYFFg39COCCRcmQH0rk4Py7SioeZK1WX50szdnMCAEBM0%2FYGIJRFlpJYz5%2BF7cuCEDZDVFz70QPaeLM9Aq2Hp0OWlaD%2BlKU2Ya8oXmKGTVLeV6xTf66mRdzvW8I4qKgZpByKnAcip5WWnkttPjUxPiLaEeZ%2BClnUyHZas2bB1iPmPH0rQXcKWbTOq%2BJJm8xX%2FgqtqSgjGTmncJVZJxe0UaRUPXS%2BxPh0KYERT9Te4D5sREOcmaPJ0lojWm5AuNIxK3S30FeTamdldG5jOgcjm7r6e2HjWcB7yfe4%2BCsYd2eVLbbXk95jZRHQohr%2B7Z9YEqq00TUANe07BXm%2FKoAPBMy0bYQHYmVJaGS31XhmN6DRKUn5mwwU6NQ87eIymigu48swQSaSOa0S3Ve15n99tYKCLxw%2FqcLrXK9DmAPRXyB2cTH85tpMJ7Qqv8FOusB0TY7T%2F8PPlS9Pw17cj5sLPnZSdHFb4OJ7xNuArhvZUxC%2FDdQIpfgbN40hDHy3r94ejzq63ULcWroBoxExSJ8F%2BIqLrT2jEE%2BHYV9rJ3uN20mlrWN07M1wfpVQeu7mZyiWu%2BTKEOjyLznji7d3Efn7A1SwzF%2FWi11RcA9%2BGeNTFCiOeyJRV4JWopx6NNi8TVr6hBraJmZeqXIUCIj4yW%2BvdbZ%2F7b%2BDWNq1S8BMna3Htt9r6lmeANRYdDH%2BkiA2F6n7nJrrrNm3hF7NHjHy1GdUin3XffXKseDfHdRNqxNelH1SrChi2zziLtHrQ%3D%3D\u0026X-Amz-Signature=1736b330b0c4c2a8047c90c519b8673b5298423900247ce0d5444779aa5979af","file_size":1504,"type":"text/x-python"}],"allow_singular_disclosure_at":null,"vote_count":41,"voters":["a_d_a_m","cutoffurmind","enixium","mygf","an0nym0us","nessun00x","khizer47","cryptographer","jaimin","millenniumx","and 31 more..."],"severity":{"rating":"medium","author_type":"User"},"structured_scope":{"databaseId":551,"asset_type":"URL","asset_identifier":"sandbox.open-xchange.com","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":6302032,"is_internal":false,"editable":false,"type":"Activities::ReportTitleUpdated","message":"","markdown_message":"","automated_response":false,"created_at":"2019-11-14T02:38:06.740Z","updated_at":"2019-11-14T02:38:06.740Z","additional_data":{"old_title":"SSRF - Image Sources in HTML Attachments - 727234 bypass","new_title":"SSRF - Image Sources in HTML Snippets - 727234 bypass"},"actor":{"username":"zhutyra","cleared":false,"url":"/zhutyra","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":6302843,"is_internal":false,"editable":false,"type":"Activities::BugInformative","message":"Hi, the fix for #727234 is not deployed to sandbox.open-xchange.com yet.","markdown_message":"\u003cp\u003eHi, the fix for \u003ca href=\"/reports/727234\"\u003e#727234\u003c/a\u003e is not deployed to sandbox.open-xchange.com yet.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-11-14T07:04:31.412Z","updated_at":"2019-11-14T07:04:31.412Z","actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6305518,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hello,\n\nit was fixed in this commit [81d9652d7a4675bed3d7bf6a7403de23f424ca16](https://gitlab.open-xchange.com/middleware/core/commit/81d9652d7a4675bed3d7bf6a7403de23f424ca16)\n*Fix for bug 67931: Only allow URLs for certain protocols and deny for localhost/loopback address*\n\nWhich was soon after my bug report and without further activity since then, presumably considered complete.\n\nVersion on sandbox is `7.10.3 Rev0 (2019-11-04)` which indeed does contain this fix and is bypassable as I described here.","markdown_message":"\u003cp\u003eHello,\u003c/p\u003e\n\n\u003cp\u003eit was fixed in this commit \u003ca href=\"/redirect?url=https%3A%2F%2Fgitlab.open-xchange.com%2Fmiddleware%2Fcore%2Fcommit%2F81d9652d7a4675bed3d7bf6a7403de23f424ca16\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003e81d9652d7a4675bed3d7bf6a7403de23f424ca16\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003cbr\u003e\n\u003cem\u003eFix for bug 67931: Only allow URLs for certain protocols and deny for localhost/loopback address\u003c/em\u003e\u003c/p\u003e\n\n\u003cp\u003eWhich was soon after my bug report and without further activity since then, presumably considered complete.\u003c/p\u003e\n\n\u003cp\u003eVersion on sandbox is \u003ccode\u003e7.10.3 Rev0 (2019-11-04)\u003c/code\u003e which indeed does contain this fix and is bypassable as I described here.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-11-14T14:25:54.258Z","updated_at":"2019-11-14T14:25:54.258Z","actor":{"username":"zhutyra","cleared":false,"url":"/zhutyra","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":6313329,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I'm sorry, indeed someone has updated sandbox with development code.","markdown_message":"\u003cp\u003eI\u0026#39;m sorry, indeed someone has updated sandbox with development code.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-11-15T09:09:57.199Z","updated_at":"2019-11-15T09:09:57.199Z","actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6313334,"is_internal":false,"editable":false,"type":"Activities::BugReopened","message":"","markdown_message":"","automated_response":false,"created_at":"2019-11-15T09:10:02.273Z","updated_at":"2019-11-15T09:10:02.273Z","actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6313535,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2019-11-15T09:25:49.545Z","updated_at":"2019-11-15T09:25:49.545Z","actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6353558,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"We solved this vulnerability internally and will provide a backport to in-production releases during the next weeks.\n\nWe're in the process of transferring funds to H1 to provide your compensation, please stand by.","markdown_message":"\u003cp\u003eWe solved this vulnerability internally and will provide a backport to in-production releases during the next weeks.\u003c/p\u003e\n\n\u003cp\u003eWe\u0026#39;re in the process of transferring funds to H1 to provide your compensation, please stand by.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-11-20T07:34:03.773Z","updated_at":"2019-11-20T07:34:03.773Z","actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"zhutyra","url":"/zhutyra"},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6419953,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Sorry you had to wait for the bounty!","markdown_message":"\u003cp\u003eSorry you had to wait for the bounty!\u003c/p\u003e\n","automated_response":false,"created_at":"2019-11-27T11:31:09.318Z","updated_at":"2019-11-27T11:31:09.318Z","actor":{"url":"/open-xchange","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/JtYLEsu5yRZxGitSmAjeAFtK/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Open-Xchange"}},"bounty_amount":"400.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"open-xchange","collaborator":{"username":"zhutyra","url":"/zhutyra"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6423123,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for the bounty.","markdown_message":"\u003cp\u003eThank you for the bounty.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-11-27T16:51:46.845Z","updated_at":"2019-11-27T16:51:46.845Z","actor":{"username":"zhutyra","cleared":false,"url":"/zhutyra","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7090510,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-02-19T13:41:53.360Z","updated_at":"2020-02-19T13:41:53.360Z","first_to_agree":true,"actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7099007,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-02-20T10:46:55.898Z","updated_at":"2020-02-20T10:46:55.898Z","actor":{"username":"zhutyra","cleared":false,"url":"/zhutyra","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7099008,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-02-20T10:46:55.969Z","updated_at":"2020-02-20T10:46:55.969Z","actor":{"username":"zhutyra","cleared":false,"url":"/zhutyra","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}