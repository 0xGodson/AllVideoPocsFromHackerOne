{"id":39428,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8zOTQyOA==","url":"https://hackerone.com/reports/39428","title":"Phabricator Phame Blog Skins Local File Inclusion","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2014-12-15T15:52:43.735Z","submitted_at":"2014-12-15T15:52:43.735Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"nullsub","url":"/nullsub","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/012/470/2fbec5598f656107a3ddd37f9e0f563a6494f29b_original.jpeg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":18,"url":"https://hackerone.com/phabricator","handle":"phabricator","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Phabricator","twitter_handle":"phabricator","website":"http://phacility.com/phabricator/","about":"Phabricator is a collection of open source web applications that help software companies build better software."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2015-01-14T18:50:23.905Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2014-12-15T18:50:18.747Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Phabricator's Phame blog allows users to set a skin.\r\n\r\nAn attacker with the ability to upload files to the server can exploit this LFI vulnerability to gain remote code execution through Phabricator and thus, gain access to Phabricator's data. Common scenarios may include:\r\n\r\n- A box serving Phabricator and other web application that would allow uploading files to controlled paths.\r\n- A box where the attacker can log in through ssh as a restricted user (not having access to Phabricator's files, but having access to write in /tmp, for instance)\r\n- etc ...\r\n\r\nWhile testing, I used the following request to create a blog:\r\n\r\n```\r\nPOST /phame/blog/new/ HTTP/1.1\r\nHost: phabricator\r\nUser-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:33.0) Gecko/20100101 Firefox/33.0\r\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\nAccept-Language: en-GB,en;q=0.5\r\nAccept-Encoding: gzip, deflate\r\nReferer: http://phabricator.48bits.com/phame/blog/new/\r\nCookie: phsid=o36kfovszv6sqpbjheacicu2ykx25lqoh5iepeit; phusr=guest\r\nConnection: keep-alive\r\nContent-Type: application/x-www-form-urlencoded\r\nContent-Length: 254\r\n\r\n__csrf__=B%40acbxwmgk39152b45fd9eff2e\u0026__form__=1\u0026name=xxxx\u0026description=bla\u0026can_view=users\u0026can_edit=users\u0026can_join=users\u0026custom_domain=\u0026skin=%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%74%6d%70%2f%74%65%73%74\r\n```\r\n\r\nThat makes phabricator try to load the skin template php files from:\r\n\r\n/var/www/phabricator/phabricator/externals/skins/../../../../../../../../../../tmp/test/\r\n\r\nIn order to exploit the vulnerability a valid skin structure must exist at the specified location, I have simply copied the oblivious skin and modified it to output a phpinfo() within the header.php script with the expected results.\r\n\r\nProposed fix:\r\n\r\nPhabricator should verify that the skin's path is not outside its own root.\r\n\r\n","vulnerability_information_html":"\u003cp\u003ePhabricator\u0026#39;s Phame blog allows users to set a skin.\u003c/p\u003e\n\n\u003cp\u003eAn attacker with the ability to upload files to the server can exploit this LFI vulnerability to gain remote code execution through Phabricator and thus, gain access to Phabricator\u0026#39;s data. Common scenarios may include:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eA box serving Phabricator and other web application that would allow uploading files to controlled paths.\u003c/li\u003e\n\u003cli\u003eA box where the attacker can log in through ssh as a restricted user (not having access to Phabricator\u0026#39;s files, but having access to write in /tmp, for instance)\u003c/li\u003e\n\u003cli\u003eetc ...\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eWhile testing, I used the following request to create a blog:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003ePOST /phame/blog/new/ HTTP/1.1\nHost: phabricator\nUser-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:33.0) Gecko/20100101 Firefox/33.0\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\nAccept-Language: en-GB,en;q=0.5\nAccept-Encoding: gzip, deflate\nReferer: http://phabricator.48bits.com/phame/blog/new/\nCookie: phsid=o36kfovszv6sqpbjheacicu2ykx25lqoh5iepeit; phusr=guest\nConnection: keep-alive\nContent-Type: application/x-www-form-urlencoded\nContent-Length: 254\n\n__csrf__=B%40acbxwmgk39152b45fd9eff2e\u0026amp;__form__=1\u0026amp;name=xxxx\u0026amp;description=bla\u0026amp;can_view=users\u0026amp;can_edit=users\u0026amp;can_join=users\u0026amp;custom_domain=\u0026amp;skin=%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%74%6d%70%2f%74%65%73%74\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThat makes phabricator try to load the skin template php files from:\u003c/p\u003e\n\n\u003cp\u003e/var/www/phabricator/phabricator/externals/skins/../../../../../../../../../../tmp/test/\u003c/p\u003e\n\n\u003cp\u003eIn order to exploit the vulnerability a valid skin structure must exist at the specified location, I have simply copied the oblivious skin and modified it to output a phpinfo() within the header.php script with the expected results.\u003c/p\u003e\n\n\u003cp\u003eProposed fix:\u003c/p\u003e\n\n\u003cp\u003ePhabricator should verify that the skin\u0026#39;s path is not outside its own root.\u003c/p\u003e\n","bounty_amount":"500.0","formatted_bounty":"$500","weakness":{"id":70,"name":"Code Injection"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2015-01-14T18:50:18.868Z","allow_singular_disclosure_after":-187959591.38931936,"singular_disclosure_allowed":true,"vote_count":0,"voters":[],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":178572,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Some more thoughts... there are things that I haven't tested yet (wanted to report you straight away) , but you may be able to shed some light with:                                                               \n                   \n- I believe users with the ability to write to a repository may also be able to exploit this.  \n- Not sure how files are stored locally if not using MySQL but that could be another avenue to gain RCE by users.\n\n","markdown_message":"\u003cp\u003eSome more thoughts... there are things that I haven\u0026#39;t tested yet (wanted to report you straight away) , but you may be able to shed some light with:                                                               \u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eI believe users with the ability to write to a repository may also be able to exploit this.\u003cbr\u003e\n\u003c/li\u003e\n\u003cli\u003eNot sure how files are stored locally if not using MySQL but that could be another avenue to gain RCE by users.\u003c/li\u003e\n\u003c/ul\u003e\n","automated_response":false,"created_at":"2014-12-15T16:03:44.958Z","updated_at":"2014-12-15T16:03:44.958Z","actor":{"username":"nullsub","cleared":false,"url":"/nullsub","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/470/2fbec5598f656107a3ddd37f9e0f563a6494f29b_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":178687,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks, confirming...","markdown_message":"\u003cp\u003eThanks, confirming...\u003c/p\u003e\n","automated_response":false,"created_at":"2014-12-15T18:08:58.776Z","updated_at":"2014-12-15T18:08:58.776Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":178701,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I was able to reproduce this by following your instructions. Nice catch! Fix out for review:\n\nhttps://secure.phabricator.com/D10992","markdown_message":"\u003cp\u003eI was able to reproduce this by following your instructions. Nice catch! Fix out for review:\u003c/p\u003e\n\n\u003cp\u003e\u003ca title=\"https://secure.phabricator.com/D10992\" href=\"/redirect?url=https%3A%2F%2Fsecure.phabricator.com%2FD10992\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://secure.phabricator.com/D10992\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n","automated_response":false,"created_at":"2014-12-15T18:27:36.284Z","updated_at":"2014-12-15T18:27:36.284Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":178711,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks!, just checked your fix, it looks fine to me now.","markdown_message":"\u003cp\u003eThanks!, just checked your fix, it looks fine to me now.\u003c/p\u003e\n","automated_response":false,"created_at":"2014-12-15T18:36:17.644Z","updated_at":"2014-12-15T18:36:17.644Z","actor":{"username":"nullsub","cleared":false,"url":"/nullsub","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/470/2fbec5598f656107a3ddd37f9e0f563a6494f29b_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":178712,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"This is now fixed in HEAD:\n\nhttps://secure.phabricator.com/rP2037979142cb2e8b5edb8dc2361567c755bb7396","markdown_message":"\u003cp\u003eThis is now fixed in HEAD:\u003c/p\u003e\n\n\u003cp\u003e\u003ca title=\"https://secure.phabricator.com/rP2037979142cb2e8b5edb8dc2361567c755bb7396\" href=\"/redirect?url=https%3A%2F%2Fsecure.phabricator.com%2FrP2037979142cb2e8b5edb8dc2361567c755bb7396\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://secure.phabricator.com/rP2037979142cb2e8b5edb8dc2361567c755bb7396\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n","automated_response":false,"created_at":"2014-12-15T18:42:27.382Z","updated_at":"2014-12-15T18:42:27.382Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"nullsub","url":"/nullsub"},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":178723,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"This vulnerability is severe, but two factors that make it difficult to exploit partially mitigate it:\n\n  - Phame is a \"prototype\" application, and not installed by default. Prototype applications are heavily caveated in the documentation (https://secure.phabricator.com/book/phabricator/article/prototypes/).\n  - The attacker would also need to write to local disk, and need some control over file paths. I don't believe an attacker -- even one with substantial access -- could normally perform these writes. They could write to disk if `storage.local-file-path` is configured, but can not reconfigure it without CLI access and can not control written paths (I believe this would prevent them from writing a valid-looking skin which Phabricator would actually load). They could push to a repository, but repositories are normally stored in bare mode, so the actual files do not exist on disk (e.g., under git, they are compressed and stored as objects). As you mention, an attacker with existing access to the machine could easily do these writes, but that's unusual in most configurations of Phabricator.\n\n","markdown_message":"\u003cp\u003eThis vulnerability is severe, but two factors that make it difficult to exploit partially mitigate it:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003ePhame is a \u0026quot;prototype\u0026quot; application, and not installed by default. Prototype applications are heavily caveated in the documentation (\u003ca title=\"https://secure.phabricator.com/book/phabricator/article/prototypes/\" href=\"/redirect?url=https%3A%2F%2Fsecure.phabricator.com%2Fbook%2Fphabricator%2Farticle%2Fprototypes%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://secure.phabricator.com/book/phabricator/article/prototypes/\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e).\u003c/li\u003e\n\u003cli\u003eThe attacker would also need to write to local disk, and need some control over file paths. I don\u0026#39;t believe an attacker -- even one with substantial access -- could normally perform these writes. They could write to disk if \u003ccode\u003estorage.local-file-path\u003c/code\u003e is configured, but can not reconfigure it without CLI access and can not control written paths (I believe this would prevent them from writing a valid-looking skin which Phabricator would actually load). They could push to a repository, but repositories are normally stored in bare mode, so the actual files do not exist on disk (e.g., under git, they are compressed and stored as objects). As you mention, an attacker with existing access to the machine could easily do these writes, but that\u0026#39;s unusual in most configurations of Phabricator.\u003c/li\u003e\n\u003c/ul\u003e\n","automated_response":false,"created_at":"2014-12-15T18:49:35.752Z","updated_at":"2014-12-15T18:49:35.752Z","actor":{"url":"/phabricator","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Phabricator"}},"bounty_amount":"500.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"phabricator","collaborator":{"username":"nullsub","url":"/nullsub"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":178725,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"The fix for this issue is publicly available, so it can be disclosed at any time.\n\nThanks for the report!","markdown_message":"\u003cp\u003eThe fix for this issue is publicly available, so it can be disclosed at any time.\u003c/p\u003e\n\n\u003cp\u003eThanks for the report!\u003c/p\u003e\n","automated_response":false,"created_at":"2014-12-15T18:50:18.764Z","updated_at":"2014-12-15T18:50:18.764Z","first_to_agree":true,"actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":178732,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for the bounty and for your clarifications","markdown_message":"\u003cp\u003eThanks for the bounty and for your clarifications\u003c/p\u003e\n","automated_response":false,"created_at":"2014-12-15T18:53:08.489Z","updated_at":"2014-12-15T18:53:08.489Z","actor":{"username":"nullsub","cleared":false,"url":"/nullsub","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/470/2fbec5598f656107a3ddd37f9e0f563a6494f29b_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":310665,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2015-01-14T18:50:24.602Z","updated_at":"2015-01-14T18:50:24.602Z","actor":{"url":"/phabricator","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Phabricator"}},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}