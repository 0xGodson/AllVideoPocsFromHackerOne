{"id":282176,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yODIxNzY=","url":"https://hackerone.com/reports/282176","title":"Unauthenticated hidden groups disclosure via Ajax groups search","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2017-10-23T17:52:58.780Z","submitted_at":"2017-10-23T17:52:58.780Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"jdgrimes","url":"/jdgrimes","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/009/109/d46d46e7dd9a78c3bd46390279cd42d1c1e76124_original.jpeg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":55,"url":"https://hackerone.com/wordpress","handle":"wordpress","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/055/f114d1d31f904e3b903cd99a6cf566bb531f8401_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/055/f114d1d31f904e3b903cd99a6cf566bb531f8401_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"WordPress","twitter_handle":"wordpress","website":"https://wordpress.org/","about":"Beautiful sites of any kind."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2017-11-02T19:05:57.285Z","bug_reporter_agreed_on_going_public_at":"2017-11-02T18:20:32.850Z","team_member_agreed_on_going_public_at":"2017-11-02T19:05:57.107Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"*Note: this issue was previously submitted to `security@wordpress.org`, because I did not have the rep to submit it here. That was cleared up with HackerOne, so I am now submitting the issue here, at @aaroncampbell's direction.*\n\n## Summary\n\nIt is possible for an unauthenticated user to view the title, description, avatar, time of last activity, and membership count of hidden groups. This is possible via the Ajax groups search feature, due to a failure to properly encode user-supplied values when incorporating them into the query string within the Ajax handler. This allows the user to pass args to the groups query that they aren't intended to be able to use. Specifically, the `show_hidden` query arg may be used to show hidden groups.\n\n## Technical details\n\nGroups in BuddyPress can have one of three different statuses: `public`, `private`, or `hidden`. Public and private groups are publicly queryable, by default, although private groups cannot be joined without an invitation. Hidden groups are not only restricted like private groups, but are also hidden in queries, unless a user has moderator capabilities.\n\nThe `BP_Groups_Group::get()` method is used to query for groups. Of particular interest are the `status` and `show_hidden` query args:\n\n```php\n\u003c?php\n     if ( ! empty( $r['status'] ) ) {\n        if ( ! is_array( $r['status'] ) ) {\n           $r['status'] = preg_split( '/[\\s,]+/', $r['status'] );\n        }\n        $r['status'] = array_map( 'sanitize_title', $r['status'] );\n        $status_in = \"'\" . implode( \"','\", $r['status'] ) . \"'\";\n        $where_conditions['status'] = \"g.status IN ({$status_in})\";\n     } elseif ( empty( $r['show_hidden'] ) ) {\n        $where_conditions['hidden'] = \"g.status != 'hidden'\";\n     }\n```\n\nAs you can see, there are no restrictions applied as to who can use these args within the method itself. So any code which allows arbitrary query args to be passed to that method by users without proper permissions is vulnerable to hidden groups disclosure.\n\nThe only place where the method is called in that manner is in its wrapper function, `groups_get_groups()`, which in turn is used by `BP_Groups_Template` to get the groups to display in a groups template. It does not accept the `status` query arg, but does allow `show_hidden`.\n\n`BP_Groups_Template::__construct()` does contain this code:\n\n```php\n\u003c?php\n     if ( bp_current_user_can( 'bp_moderate' ) || ( is_user_logged_in() \u0026\u0026 $user_id == bp_loggedin_user_id() ) ) {\n        $show_hidden = true;\n     }\n```\n\nHowever, note that this doesn't prevent `$show_hidden` from being passed in as `true` even if the condition isn't met. Thus, the class is still vulnerable if we can find a way to pass the `show_hidden` arg into it.\n\nThe groups template class is utilized only by `bp_has_groups()`, which is used in the groups template files to set up a groups query. The `bp_has_groups()` function accepts an array of query args to be passed to it, although usually that feature either isn't used or it isn't possible to pass arbitrary args in.\n\nHowever, there are two places of particular interest. The first is in `buddypress/bp-templates/bp-legacy/buddypress/groups/groups-loop.php` on line 26:\n\n```php\n\u003c?php if ( bp_has_groups( bp_ajax_querystring( 'groups' ) ) ) : ?\u003e\n```\n\nThe value returned by the `bp_ajax_querystring()` function is determined via the `'bp_ajax_querystring'` filter. For the Legacy template pack, the `bp_legacy_theme_ajax_querystring()` function is hooked to that filter to supply the value.\n\n`bp_legacy_theme_ajax_querystring()` is located in `buddypress/bp-templates/bp-legacy/buddypress-functions.php`, and most of it is pretty well hardened against this kind of issue, properly sanitizing the user-supplied values. However, on line 692, it does this:\n\n```php\n\u003c?php\n  // Activity stream filtering on action.\n  if ( ! empty( $_BP_COOKIE['bp-' . $object . '-filter'] ) \u0026\u0026 '-1' != $_BP_COOKIE['bp-' . $object . '-filter'] ) {\n     $qs[] = 'type=' . $_BP_COOKIE['bp-' . $object . '-filter'];\n\n     // ...\n  }\n```\n\nThe value of `$_BP_COOKIE` can be set via `$_POST['cookie']` (line 675):\n\n```php\n\u003c?php\n  // Set up the cookies passed on this AJAX request. Store a local var to avoid conflicts.\n  if ( ! empty( $_POST['cookie'] ) ) {\n     $_BP_COOKIE = wp_parse_args( str_replace( '; ', '\u0026', urldecode( $_POST['cookie'] ) ) );\n  } else {\n     $_BP_COOKIE = \u0026$_COOKIE;\n  }\n```\n\nThe `bp-$object-scope` is also vulnerable on line 714:\n\n```php\n\u003c?php\n  if ( ! empty( $_BP_COOKIE['bp-' . $object . '-scope'] ) ) {\n\n     //...\n\n     // Activity stream scope only on activity directory.\n     if ( 'all' != $_BP_COOKIE['bp-' . $object . '-scope'] \u0026\u0026 ! bp_displayed_user_id() \u0026\u0026 ! bp_is_single_item() )\n        $qs[] = 'scope=' . $_BP_COOKIE['bp-' . $object . '-scope'];\n  }\n```\n\nThe solution is to wrap the values in `urlencode()`, as is done with `$_POST['search_terms']` on line 734.\n\n```php\n\u003c?php\n\n     $qs[] = 'type=' . urlencode( $_BP_COOKIE['bp-' . $object . '-filter'] );\n\n     $qs[] = 'scope=' . urlencode( $_BP_COOKIE['bp-' . $object . '-scope'] );\n```\n\nThe BuddyPress Default theme also suffers from the same problems, in `bp_dtheme_ajax_querystring()` (`buddypress/bp-themes/bp-default/groups/groups-loop.php` uses `bp_has_groups( bp_ajax_querystring( 'groups' ) )` as the Legacy template pack does). In that function, however, `$_POST['search_terms']` is also a vector, since it isn't passed through `urlencode()` (`buddypress/bp-themes/bp-default/_inc/ajax.php` line 137):\n\n```php\n\u003c?php\n  $object_search_text = bp_get_search_default_text( $object );\n  if ( ! empty( $_POST['search_terms'] ) \u0026\u0026 $object_search_text != $_POST['search_terms'] \u0026\u0026 'false' != $_POST['search_terms'] \u0026\u0026 'undefined' != $_POST['search_terms'] )\n     $qs[] = 'search_terms=' . $_POST['search_terms'];\n```\n\n## POC\n\nSend a `POST` request to `/wp-admin/admin-ajax.php` with the following body:\n\n```\naction=groups_filter\u0026cookie=bp-groups-filter%253D%252526show_hidden%3D1\u0026object=groups\n```\n\n`bp-groups-filter` can be replaced with `bp-groups-scope` to the same effect:\n\n```\naction=groups_filter\u0026cookie=bp-groups-scope%253D%252526show_hidden%3D1\u0026object=groups\n```","vulnerability_information_html":"\u003cp\u003e\u003cem\u003eNote: this issue was previously submitted to \u003ccode\u003esecurity@wordpress.org\u003c/code\u003e, because I did not have the rep to submit it here. That was cleared up with HackerOne, so I am now submitting the issue here, at \u003ca href=\"/aaroncampbell\"\u003e@aaroncampbell\u003c/a\u003e\u0026#39;s direction.\u003c/em\u003e\u003c/p\u003e\n\n\u003ch2 id=\"summary\"\u003eSummary\u003c/h2\u003e\n\n\u003cp\u003eIt is possible for an unauthenticated user to view the title, description, avatar, time of last activity, and membership count of hidden groups. This is possible via the Ajax groups search feature, due to a failure to properly encode user-supplied values when incorporating them into the query string within the Ajax handler. This allows the user to pass args to the groups query that they aren\u0026#39;t intended to be able to use. Specifically, the \u003ccode\u003eshow_hidden\u003c/code\u003e query arg may be used to show hidden groups.\u003c/p\u003e\n\n\u003ch2 id=\"technical-details\"\u003eTechnical details\u003c/h2\u003e\n\n\u003cp\u003eGroups in BuddyPress can have one of three different statuses: \u003ccode\u003epublic\u003c/code\u003e, \u003ccode\u003eprivate\u003c/code\u003e, or \u003ccode\u003ehidden\u003c/code\u003e. Public and private groups are publicly queryable, by default, although private groups cannot be joined without an invitation. Hidden groups are not only restricted like private groups, but are also hidden in queries, unless a user has moderator capabilities.\u003c/p\u003e\n\n\u003cp\u003eThe \u003ccode\u003eBP_Groups_Group::get()\u003c/code\u003e method is used to query for groups. Of particular interest are the \u003ccode\u003estatus\u003c/code\u003e and \u003ccode\u003eshow_hidden\u003c/code\u003e query args:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight php\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e\u0026lt;?php\u003c/span\u003e\n     \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"o\"\u003e!\u003c/span\u003e \u003cspan class=\"k\"\u003eempty\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"nv\"\u003e$r\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;status\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"o\"\u003e!\u003c/span\u003e \u003cspan class=\"nb\"\u003eis_array\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"nv\"\u003e$r\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;status\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n           \u003cspan class=\"nv\"\u003e$r\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;status\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003epreg_split\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;/[\\s,]+/\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nv\"\u003e$r\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;status\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"nv\"\u003e$r\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;status\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003earray_map\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;sanitize_title\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nv\"\u003e$r\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;status\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"nv\"\u003e$status_in\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;\u0026#39;\u0026quot;\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"nb\"\u003eimplode\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;\u0026#39;,\u0026#39;\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nv\"\u003e$r\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;status\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;\u0026#39;\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"nv\"\u003e$where_conditions\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;status\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;g.status IN (\u003c/span\u003e\u003cspan class=\"si\"\u003e{\u003c/span\u003e\u003cspan class=\"nv\"\u003e$status_in\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e)\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelseif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"k\"\u003eempty\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"nv\"\u003e$r\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;show_hidden\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nv\"\u003e$where_conditions\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;hidden\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;g.status != \u0026#39;hidden\u0026#39;\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAs you can see, there are no restrictions applied as to who can use these args within the method itself. So any code which allows arbitrary query args to be passed to that method by users without proper permissions is vulnerable to hidden groups disclosure.\u003c/p\u003e\n\n\u003cp\u003eThe only place where the method is called in that manner is in its wrapper function, \u003ccode\u003egroups_get_groups()\u003c/code\u003e, which in turn is used by \u003ccode\u003eBP_Groups_Template\u003c/code\u003e to get the groups to display in a groups template. It does not accept the \u003ccode\u003estatus\u003c/code\u003e query arg, but does allow \u003ccode\u003eshow_hidden\u003c/code\u003e.\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eBP_Groups_Template::__construct()\u003c/code\u003e does contain this code:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight php\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e\u0026lt;?php\u003c/span\u003e\n     \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"nx\"\u003ebp_current_user_can\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;bp_moderate\u0026#39;\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"nx\"\u003eis_user_logged_in\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nv\"\u003e$user_id\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"nx\"\u003ebp_loggedin_user_id\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nv\"\u003e$show_hidden\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eHowever, note that this doesn\u0026#39;t prevent \u003ccode\u003e$show_hidden\u003c/code\u003e from being passed in as \u003ccode\u003etrue\u003c/code\u003e even if the condition isn\u0026#39;t met. Thus, the class is still vulnerable if we can find a way to pass the \u003ccode\u003eshow_hidden\u003c/code\u003e arg into it.\u003c/p\u003e\n\n\u003cp\u003eThe groups template class is utilized only by \u003ccode\u003ebp_has_groups()\u003c/code\u003e, which is used in the groups template files to set up a groups query. The \u003ccode\u003ebp_has_groups()\u003c/code\u003e function accepts an array of query args to be passed to it, although usually that feature either isn\u0026#39;t used or it isn\u0026#39;t possible to pass arbitrary args in.\u003c/p\u003e\n\n\u003cp\u003eHowever, there are two places of particular interest. The first is in \u003ccode\u003ebuddypress/bp-templates/bp-legacy/buddypress/groups/groups-loop.php\u003c/code\u003e on line 26:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight php\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e\u0026lt;?php\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"nx\"\u003ebp_has_groups\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"nx\"\u003ebp_ajax_querystring\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;groups\u0026#39;\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"cp\"\u003e?\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe value returned by the \u003ccode\u003ebp_ajax_querystring()\u003c/code\u003e function is determined via the \u003ccode\u003e\u0026#39;bp_ajax_querystring\u0026#39;\u003c/code\u003e filter. For the Legacy template pack, the \u003ccode\u003ebp_legacy_theme_ajax_querystring()\u003c/code\u003e function is hooked to that filter to supply the value.\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003ebp_legacy_theme_ajax_querystring()\u003c/code\u003e is located in \u003ccode\u003ebuddypress/bp-templates/bp-legacy/buddypress-functions.php\u003c/code\u003e, and most of it is pretty well hardened against this kind of issue, properly sanitizing the user-supplied values. However, on line 692, it does this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight php\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e\u0026lt;?php\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// Activity stream filtering on action.\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"o\"\u003e!\u003c/span\u003e \u003cspan class=\"k\"\u003eempty\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"nv\"\u003e$_BP_COOKIE\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;bp-\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"nv\"\u003e$object\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;-filter\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;-1\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"nv\"\u003e$_BP_COOKIE\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;bp-\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"nv\"\u003e$object\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;-filter\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"nv\"\u003e$qs\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;type=\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"nv\"\u003e$_BP_COOKIE\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;bp-\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"nv\"\u003e$object\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;-filter\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\n     \u003cspan class=\"c1\"\u003e// ...\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe value of \u003ccode\u003e$_BP_COOKIE\u003c/code\u003e can be set via \u003ccode\u003e$_POST[\u0026#39;cookie\u0026#39;]\u003c/code\u003e (line 675):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight php\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e\u0026lt;?php\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// Set up the cookies passed on this AJAX request. Store a local var to avoid conflicts.\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"o\"\u003e!\u003c/span\u003e \u003cspan class=\"k\"\u003eempty\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"nv\"\u003e$_POST\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;cookie\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"nv\"\u003e$_BP_COOKIE\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ewp_parse_args\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"nb\"\u003estr_replace\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;; \u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\u0026amp;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eurldecode\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"nv\"\u003e$_POST\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;cookie\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"nv\"\u003e$_BP_COOKIE\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$_COOKIE\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe \u003ccode\u003ebp-$object-scope\u003c/code\u003e is also vulnerable on line 714:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight php\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e\u0026lt;?php\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"o\"\u003e!\u003c/span\u003e \u003cspan class=\"k\"\u003eempty\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"nv\"\u003e$_BP_COOKIE\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;bp-\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"nv\"\u003e$object\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;-scope\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\n     \u003cspan class=\"c1\"\u003e//...\u003c/span\u003e\n\n     \u003cspan class=\"c1\"\u003e// Activity stream scope only on activity directory.\u003c/span\u003e\n     \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;all\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"nv\"\u003e$_BP_COOKIE\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;bp-\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"nv\"\u003e$object\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;-scope\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"o\"\u003e!\u003c/span\u003e \u003cspan class=\"nx\"\u003ebp_displayed_user_id\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"o\"\u003e!\u003c/span\u003e \u003cspan class=\"nx\"\u003ebp_is_single_item\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"nv\"\u003e$qs\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;scope=\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"nv\"\u003e$_BP_COOKIE\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;bp-\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"nv\"\u003e$object\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;-scope\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe solution is to wrap the values in \u003ccode\u003eurlencode()\u003c/code\u003e, as is done with \u003ccode\u003e$_POST[\u0026#39;search_terms\u0026#39;]\u003c/code\u003e on line 734.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight php\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e\u0026lt;?php\u003c/span\u003e\n\n     \u003cspan class=\"nv\"\u003e$qs\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;type=\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"nb\"\u003eurlencode\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"nv\"\u003e$_BP_COOKIE\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;bp-\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"nv\"\u003e$object\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;-filter\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n     \u003cspan class=\"nv\"\u003e$qs\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;scope=\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"nb\"\u003eurlencode\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"nv\"\u003e$_BP_COOKIE\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;bp-\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"nv\"\u003e$object\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;-scope\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe BuddyPress Default theme also suffers from the same problems, in \u003ccode\u003ebp_dtheme_ajax_querystring()\u003c/code\u003e (\u003ccode\u003ebuddypress/bp-themes/bp-default/groups/groups-loop.php\u003c/code\u003e uses \u003ccode\u003ebp_has_groups( bp_ajax_querystring( \u0026#39;groups\u0026#39; ) )\u003c/code\u003e as the Legacy template pack does). In that function, however, \u003ccode\u003e$_POST[\u0026#39;search_terms\u0026#39;]\u003c/code\u003e is also a vector, since it isn\u0026#39;t passed through \u003ccode\u003eurlencode()\u003c/code\u003e (\u003ccode\u003ebuddypress/bp-themes/bp-default/_inc/ajax.php\u003c/code\u003e line 137):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight php\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e\u0026lt;?php\u003c/span\u003e\n  \u003cspan class=\"nv\"\u003e$object_search_text\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ebp_get_search_default_text\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"nv\"\u003e$object\u003c/span\u003e \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"o\"\u003e!\u003c/span\u003e \u003cspan class=\"k\"\u003eempty\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"nv\"\u003e$_POST\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;search_terms\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nv\"\u003e$object_search_text\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"nv\"\u003e$_POST\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;search_terms\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;false\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"nv\"\u003e$_POST\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;search_terms\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;undefined\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"nv\"\u003e$_POST\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;search_terms\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e\n     \u003cspan class=\"nv\"\u003e$qs\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;search_terms=\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"nv\"\u003e$_POST\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;search_terms\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"poc\"\u003ePOC\u003c/h2\u003e\n\n\u003cp\u003eSend a \u003ccode\u003ePOST\u003c/code\u003e request to \u003ccode\u003e/wp-admin/admin-ajax.php\u003c/code\u003e with the following body:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eaction=groups_filter\u0026amp;cookie=bp-groups-filter%253D%252526show_hidden%3D1\u0026amp;object=groups\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003ebp-groups-filter\u003c/code\u003e can be replaced with \u003ccode\u003ebp-groups-scope\u003c/code\u003e to the same effect:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eaction=groups_filter\u0026amp;cookie=bp-groups-scope%253D%252526show_hidden%3D1\u0026amp;object=groups\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","bounty_amount":"275.0","formatted_bounty":"$275","weakness":{"id":26,"name":"Improper Access Control - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-12-02T18:20:32.928Z","allow_singular_disclosure_after":-96980527.23736167,"singular_disclosure_allowed":true,"vote_count":5,"voters":["bl4de","skansing","eveeez","japz","b4155f7c29acd42c27d007a"],"severity":{"rating":"medium","score":6.1,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"none","user_interaction":"none","scope":"unchanged","confidentiality":"low","integrity":"none","availability":"none"}},"structured_scope":{"databaseId":2751,"asset_type":"SOURCE_CODE","asset_identifier":"BuddyPress Core","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":2098608,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2017-10-24T11:47:43.237Z","updated_at":"2017-10-24T11:47:43.237Z","actor":{"username":"johnbillion","cleared":false,"url":"/johnbillion","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/014/083/8a397390a09844d8b0657ea57e4203abd852bb2e_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2098634,"is_internal":false,"editable":false,"type":"Activities::BugNeedsMoreInfo","message":"@jdgrimes A question for you from @boonebgorges in the aforementioned email thread:\n\nI've reviewed and confirmed your report about hidden group disclosure. One question. You say that the bp-default theme has an additional exploit vector at the 'search_terms' parameter, because it's not urlencoded() before being sent to the template functions (bp_has_groups(), etc). I can't reproduce this. bp_dtheme_ajax_querystring() pulls 'search_terms' directly from $_POST, not the urldecoded $BP_COOKIE, and so its values continue to be URL encoded when the querystring is reassembled. See https://github.com/buddypress/BP-Default/blob/28530c63212c81458bbb0c3e4f10333943810fd7/_inc/ajax.php#L136. Could you please confirm, or let me know if I'm missing something?","markdown_message":"\u003cp\u003e\u003ca href=\"/jdgrimes\"\u003e@jdgrimes\u003c/a\u003e A question for you from \u003ca href=\"/boonebgorges\"\u003e@boonebgorges\u003c/a\u003e in the aforementioned email thread:\u003c/p\u003e\n\n\u003cp\u003eI\u0026#39;ve reviewed and confirmed your report about hidden group disclosure. One question. You say that the bp-default theme has an additional exploit vector at the \u0026#39;search_terms\u0026#39; parameter, because it\u0026#39;s not urlencoded() before being sent to the template functions (bp_has_groups(), etc). I can\u0026#39;t reproduce this. bp_dtheme_ajax_querystring() pulls \u0026#39;search_terms\u0026#39; directly from $_POST, not the urldecoded $BP_COOKIE, and so its values continue to be URL encoded when the querystring is reassembled. See \u003ca title=\"https://github.com/buddypress/BP-Default/blob/28530c63212c81458bbb0c3e4f10333943810fd7/_inc/ajax.php#L136\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fbuddypress%2FBP-Default%2Fblob%2F28530c63212c81458bbb0c3e4f10333943810fd7%2F_inc%2Fajax.php%23L136\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/buddypress/BP-Default/blob/28530c63212c81458bbb0c3e4f10333943810fd7/_inc/ajax.php#L136\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e. Could you please confirm, or let me know if I\u0026#39;m missing something?\u003c/p\u003e\n","automated_response":false,"created_at":"2017-10-24T11:49:46.852Z","updated_at":"2017-10-24T11:49:46.852Z","actor":{"username":"johnbillion","cleared":false,"url":"/johnbillion","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/014/083/8a397390a09844d8b0657ea57e4203abd852bb2e_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2098647,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@jdgrimes followed up privately about that last question.\n\nI'll have an update soon about patches and plans.","markdown_message":"\u003cp\u003e\u003ca href=\"/jdgrimes\"\u003e@jdgrimes\u003c/a\u003e followed up privately about that last question.\u003c/p\u003e\n\n\u003cp\u003eI\u0026#39;ll have an update soon about patches and plans.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-10-24T11:57:51.046Z","updated_at":"2017-10-24T11:57:51.046Z","actor":{"username":"boonebgorges","cleared":false,"url":"/boonebgorges","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2098866,"is_internal":false,"editable":false,"type":"Activities::BugNew","message":"@johnbillion I forgot to reply to all when responding to that question from @boonebgorges via email. For posterity, here is my response:\n\n\u003e I had not tested this before, but I just tested it now and I can confirm that search_terms is vulnerable. All I had to do was go to the groups page and type \u0026show_hidden=1 into the search box, and I was shown the hidden group. I have a feeling that you were probably sending double-encoded values to it in your tests, which is why it wasn't working for you. I believe that the $_POST values are automatically decoded by PHP, which is why this works even though urldecode() isn't being applied by BP. (So the $BP_COOKIE value as actually double-decoded, which is why the values passed to those other places need to be double-encoded.)\n\n@boonebgorges replied that he had indeed been testing with double-encoded values, that he was now able to confirm this attack vector, and that patches were currently being reviewed by the team.","markdown_message":"\u003cp\u003e\u003ca href=\"/johnbillion\"\u003e@johnbillion\u003c/a\u003e I forgot to reply to all when responding to that question from \u003ca href=\"/boonebgorges\"\u003e@boonebgorges\u003c/a\u003e via email. For posterity, here is my response:\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003eI had not tested this before, but I just tested it now and I can confirm that search_terms is vulnerable. All I had to do was go to the groups page and type \u0026amp;show_hidden=1 into the search box, and I was shown the hidden group. I have a feeling that you were probably sending double-encoded values to it in your tests, which is why it wasn\u0026#39;t working for you. I believe that the $_POST values are automatically decoded by PHP, which is why this works even though urldecode() isn\u0026#39;t being applied by BP. (So the $BP_COOKIE value as actually double-decoded, which is why the values passed to those other places need to be double-encoded.)\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e\u003ca href=\"/boonebgorges\"\u003e@boonebgorges\u003c/a\u003e replied that he had indeed been testing with double-encoded values, that he was now able to confirm this attack vector, and that patches were currently being reviewed by the team.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-10-24T12:28:48.509Z","updated_at":"2017-10-24T12:28:48.509Z","actor":{"username":"jdgrimes","cleared":false,"url":"/jdgrimes","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/009/109/d46d46e7dd9a78c3bd46390279cd42d1c1e76124_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2108806,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @jdgrimes - Thanks for your patience while the BP team took a closer look at your report.\n\nWe've prepared two patches, one for BuddyPress itself and one for the bp-default theme (which we maintain in a separate repo and pull in only at build time). They're attached to this ticket. If you've got a moment, please look them over to verify that they address the vulnerability.\n\nWe are currently planning to release BuddyPress 2.9.2, which will contain this fix as well as those in #263694, on Thursday, November 2. I'll update this ticket if anything changes in the meantime.","markdown_message":"\u003cp\u003eHi \u003ca href=\"/jdgrimes\"\u003e@jdgrimes\u003c/a\u003e - Thanks for your patience while the BP team took a closer look at your report.\u003c/p\u003e\n\n\u003cp\u003eWe\u0026#39;ve prepared two patches, one for BuddyPress itself and one for the bp-default theme (which we maintain in a separate repo and pull in only at build time). They\u0026#39;re attached to this ticket. If you\u0026#39;ve got a moment, please look them over to verify that they address the vulnerability.\u003c/p\u003e\n\n\u003cp\u003eWe are currently planning to release BuddyPress 2.9.2, which will contain this fix as well as those in \u003ca href=\"/reports/263694\"\u003e#263694\u003c/a\u003e, on Thursday, November 2. I\u0026#39;ll update this ticket if anything changes in the meantime.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-10-27T17:19:43.972Z","updated_at":"2017-10-27T17:19:43.972Z","actor":{"username":"boonebgorges","cleared":false,"url":"/boonebgorges","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"attachments":[{"id":233520,"filename":"bp-default-show-hidden.diff","type":"text/x-diff","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/233/520/6d646038d09f1f4cdb838bf2e384060ea62944b3/bp-default-show-hidden.diff?response-content-disposition=attachment%3B%20filename%3D%22bp-default-show-hidden.diff%22%3B%20filename%2A%3DUTF-8%27%27bp-default-show-hidden.diff\u0026response-content-type=text%2Fx-diff\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQRAVCXZTG%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T052240Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ3%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQCDC1SbghdXLcy9ot06DANg74r5EiCC3XZ9CQGAdi%2BmbgIhALBQDzrYaszHyI6V41WOAEV%2Fa%2FxVgBgdKj18DrlZlW1RKrQDCFYQARoMMDEzNjE5Mjc0ODQ5IgxgXaQ5tEaz15kO93YqkQPMn8lqJM5b%2F2UF4vgQzRZODqw%2FjPEjzpD61mE7LpyVCQKuiixef4EDRyTs5YaVZ%2BSeI6BYbm829Q00SoHZnAn9tGULy0VEKf9Lyq8uAs7eAOStN9gpb9p9GsQ2vxpwHzC%2F%2FjQuXDX8lTd6eIkj3L4VFhPdt4MGf%2FwzTbeirX69pmEGa7VpqUl%2BzQFSRmiyNkLz0iIRuGyUxcUtEFnAa4dcYImN8d5Xmzj3VKwszN5CZZekG0f6wVgiDQt2PU05Sm4mXV8F7Zsd2gCjxy0LByxZo8wVIQRR7XpJjeAXw7Y%2BrcntwG4VG16O2JBB13PV47avtAluDB7xEmxCn7fC%2B0gCkgtqX5FvemeTqZkzDj%2BNAE87%2BEwY1GKygDSgK%2BDrUlCwwYU%2FB1k9vGEpOa46oz6dP6MWDopeRWpW%2Fh2qwIShnMsIk%2BmfjH9n%2FnOGNwWwQp93Hlr6OPw%2F8tYLstkLZrNH3jzkkWMoWcsrv71HzpJiG6RZtm22uXPNaQTbmOYqMX%2BCryjdGcVIctKAsj5EliP0zjCb4Kr%2FBTrqAW3ufL%2FR%2FpkxPRO%2BUhyyvDPzgPmCSraR2g7lBy3KlX6LZ3JukP4SRvLInSvSu0w4T7VQh0EVNyALDb1flUgqzAKwYanyEiiHqHeCF6g4fX5%2Fuz8knjUQsnKmjOQfBtyaMe0qlW%2BHWCfwsR%2Fh2SNKi%2BVT7%2FCT2Ct%2Fia0RQuGDOtTr7KGlRg89Qz6oCZtR4isqOEM5yt6saYHHNTOAelO07weXRwFwKuKqmrZYMA5sa9p7XKqJAwmjMWMyFxAcEDHOluiNcMsa9JfilicFsycW11kxP5ZdIbUgRRdK1IdlTu3Ykx5X3L1RmsfWjw%3D%3D\u0026X-Amz-Signature=d91835a2e689a01d0ef71ef4c4d5e551695a991334a8702e57b2b7f3289cdc08"},{"id":233519,"filename":"show-hidden.diff","type":"text/x-diff","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/233/519/11c65bacbcfa601211cec1054125d7d7c1b030b3/show-hidden.diff?response-content-disposition=attachment%3B%20filename%3D%22show-hidden.diff%22%3B%20filename%2A%3DUTF-8%27%27show-hidden.diff\u0026response-content-type=text%2Fx-diff\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQRAVCXZTG%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T052240Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ3%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQCDC1SbghdXLcy9ot06DANg74r5EiCC3XZ9CQGAdi%2BmbgIhALBQDzrYaszHyI6V41WOAEV%2Fa%2FxVgBgdKj18DrlZlW1RKrQDCFYQARoMMDEzNjE5Mjc0ODQ5IgxgXaQ5tEaz15kO93YqkQPMn8lqJM5b%2F2UF4vgQzRZODqw%2FjPEjzpD61mE7LpyVCQKuiixef4EDRyTs5YaVZ%2BSeI6BYbm829Q00SoHZnAn9tGULy0VEKf9Lyq8uAs7eAOStN9gpb9p9GsQ2vxpwHzC%2F%2FjQuXDX8lTd6eIkj3L4VFhPdt4MGf%2FwzTbeirX69pmEGa7VpqUl%2BzQFSRmiyNkLz0iIRuGyUxcUtEFnAa4dcYImN8d5Xmzj3VKwszN5CZZekG0f6wVgiDQt2PU05Sm4mXV8F7Zsd2gCjxy0LByxZo8wVIQRR7XpJjeAXw7Y%2BrcntwG4VG16O2JBB13PV47avtAluDB7xEmxCn7fC%2B0gCkgtqX5FvemeTqZkzDj%2BNAE87%2BEwY1GKygDSgK%2BDrUlCwwYU%2FB1k9vGEpOa46oz6dP6MWDopeRWpW%2Fh2qwIShnMsIk%2BmfjH9n%2FnOGNwWwQp93Hlr6OPw%2F8tYLstkLZrNH3jzkkWMoWcsrv71HzpJiG6RZtm22uXPNaQTbmOYqMX%2BCryjdGcVIctKAsj5EliP0zjCb4Kr%2FBTrqAW3ufL%2FR%2FpkxPRO%2BUhyyvDPzgPmCSraR2g7lBy3KlX6LZ3JukP4SRvLInSvSu0w4T7VQh0EVNyALDb1flUgqzAKwYanyEiiHqHeCF6g4fX5%2Fuz8knjUQsnKmjOQfBtyaMe0qlW%2BHWCfwsR%2Fh2SNKi%2BVT7%2FCT2Ct%2Fia0RQuGDOtTr7KGlRg89Qz6oCZtR4isqOEM5yt6saYHHNTOAelO07weXRwFwKuKqmrZYMA5sa9p7XKqJAwmjMWMyFxAcEDHOluiNcMsa9JfilicFsycW11kxP5ZdIbUgRRdK1IdlTu3Ykx5X3L1RmsfWjw%3D%3D\u0026X-Amz-Signature=3175ef1bd39a7de6bc28dc5f4b0076d31ea42225cfe84e9917300eda8b322f8e"}],"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2109319,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I've tested both patches and they appear to fix the issue.","markdown_message":"\u003cp\u003eI\u0026#39;ve tested both patches and they appear to fix the issue.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-10-27T20:53:55.684Z","updated_at":"2017-10-27T20:53:55.684Z","actor":{"username":"jdgrimes","cleared":false,"url":"/jdgrimes","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/009/109/d46d46e7dd9a78c3bd46390279cd42d1c1e76124_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2109689,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2017-10-28T00:57:51.504Z","updated_at":"2017-10-28T00:57:51.504Z","actor":{"username":"iandunn","cleared":false,"url":"/iandunn","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/974/01bc1d097002b7eff8eddba98990e094553b1eac_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2126270,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Fixed in BP 2.9.2 https://buddypress.org/2017/11/buddypress-2-9-2-security-and-maintenance-release/","markdown_message":"\u003cp\u003eFixed in BP 2.9.2 \u003ca title=\"https://buddypress.org/2017/11/buddypress-2-9-2-security-and-maintenance-release/\" href=\"/redirect?url=https%3A%2F%2Fbuddypress.org%2F2017%2F11%2Fbuddypress-2-9-2-security-and-maintenance-release%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://buddypress.org/2017/11/buddypress-2-9-2-security-and-maintenance-release/\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n","automated_response":false,"created_at":"2017-11-02T16:39:06.005Z","updated_at":"2017-11-02T16:39:06.005Z","actor":{"username":"boonebgorges","cleared":false,"url":"/boonebgorges","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"jdgrimes","url":"/jdgrimes"},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2128771,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-11-02T18:20:32.891Z","updated_at":"2017-11-02T18:20:32.891Z","first_to_agree":true,"actor":{"username":"jdgrimes","cleared":false,"url":"/jdgrimes","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/009/109/d46d46e7dd9a78c3bd46390279cd42d1c1e76124_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2129033,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-11-02T19:05:57.184Z","updated_at":"2017-11-02T19:05:57.184Z","actor":{"username":"boonebgorges","cleared":false,"url":"/boonebgorges","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2129034,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-11-02T19:05:57.343Z","updated_at":"2017-11-02T19:05:57.343Z","actor":{"username":"boonebgorges","cleared":false,"url":"/boonebgorges","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2144132,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2017-11-08T20:59:40.804Z","updated_at":"2017-11-08T20:59:40.804Z","actor":{"url":"/wordpress","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/055/f114d1d31f904e3b903cd99a6cf566bb531f8401_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"WordPress"}},"bounty_amount":"225.0","bounty_currency":"usd","bonus_amount":"50.0","genius_execution_id":null,"team_handle":"wordpress","collaborator":{"username":"jdgrimes","url":"/jdgrimes"},"actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}