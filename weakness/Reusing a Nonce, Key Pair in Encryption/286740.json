{"id":286740,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yODY3NDA=","url":"https://hackerone.com/reports/286740","title":"Key Reinstallation Attacks: Breaking WPA2 by forcing nonce reuse","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2017-11-02T22:08:43.565Z","submitted_at":"2017-11-02T22:08:43.565Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"vanhoefm","url":"/vanhoefm","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/213/790/7848e49f4bf38d979e45468f3470dca88f3613c5_original.jpeg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":20,"url":"https://hackerone.com/internet","handle":"internet","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/e3e1c58882b2645d9108ec102731a354cbf5852e_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/e3e1c58882b2645d9108ec102731a354cbf5852e_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"The Internet","twitter_handle":null,"website":"","about":"Hack all the things."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":["CVE-2017-13077","CVE-2017-13078","CVE-2017-13079","CVE-2017-13080","CVE-2017-13081","CVE-2017-13082","CVE-2017-13084","CVE-2017-13086","CVE-2017-13087","CVE-2017-13088"],"singular_disclosure_disabled":false,"disclosed_at":"2017-11-03T00:37:55.335Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2017-11-03T00:34:22.612Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Full background information is at [krackattacks.com](https://www.krackattacks.com) and all detailed information can be found in our [research paper](https://papers.mathyvanhoef.com/ccs2017.pdf).\n\n# Key Reinstallation Attack: 4-way handshake example\n\nWe use the 4-way handshake to illustrate the idea behind key reinstallation attacks (CVE-2017-13077).\nNote that in practice, all protected Wi-Fi network rely on the 4-way handshake to derive a fresh session key (PTK) from some shared secret.\n\n### Step 1. Channel-based man-in-the-middle and initial handshake messages:\n\n* The adversary clones the access point (AP) on a different channel. Say the real AP is on channel 6, and it will be cloned on channel 1.\n* The adversary uses Channel Switch Announcements to force victims into connecting to the cloned AP on channel 1.\n* The adversary forwards the first three message of the 4-way handshake between the client and AP (i.e. the adversary fowards frames over the different channels).\n* After the client receives message 3 of the handshake, it will install the fresh session key (PTK) for the first time.\n\n### Step 2. Triggering a key reinstallation:\n\n* The attacker does not forward message 4 of the handshake to the AP, effectively blocking it.\n* As a result, the AP will retransmit message 3 to the client.\n* After the client receives message 3, it responds with message 4. In practice all clients encrypt this retransmitted message 4 at the link layer. Note that it's encrypted because message 4 an ordinary data frame, and the victim has already installed the session key to encrypt data frames (recall end of step 1). The victim will **use a nonce value of 1 to encrypt** message 4.\n* After sending message 4, the client will reinstall the session key. This **resets the transmit nonce** to zero.\n\n### Step 3. Abusing nonce reuse:\n\n* When the client now transmit a normal encrypted data frame, it will increment the nonce counter, and then **reuse the nonce value 1 when encrypting the data frame**.\n* We can derive known keystream from the encrypted retransmitted message 4 (recall step 2), and use this to decrypt parts of the just transmitted encrypted data frame.\n* Other predictable packets (ARP, DHCP, HTML, and so on) can be used to obtain additional known plaintext and keystream, which can in turn be used to decrypt more and bigger packets.\n\nThe above example attack against the 4-way handshake is also illustrated in my [CCS'17 presentation](https://papers.mathyvanhoef.com/ccs2017-slides.pdf).\n\n# Other handshakes\n\nOther Wi-Fi handshakes or features that were found to be vulnerable to key reinstallation attacks are:\n- Reinstallation of group keys in the 4-way handshake: CVE-2017-13078 and CVE-2017-13079\n- The group key handshake: CVE-2017-13080 and CVE-2017-13081\n- The Fast BSS Transition (FT) handshake: CVE-2017-13082\n- The PeerKey handshake: CVE-2017-13084\n- The Tunneled Direct-Link Setup (TDLS) handshake: CVE-2017-13086\n- Handling of Wireless Network Management (WNM) Sleep Mode Response frame: CVE-2017-13087 and CVE-2017-13088.\n\n# Countermeasures\n\nImplementations can be updated to prevent key reinstallation attacks in a backwards-compatible manner.\n\nAs an additional mitigation, an access point can also prevent most attacks against vulnerable clients.\nIn particular, attacks against the 4-way handshake can be prevented by not retransmitting message 3.\nSimilarly, attacks against the group key handshake can be prevented by not retransmitting message 1 of the group key handshake. Alternatively, the access point can retransmit these two handshake messages using the previously used EAPOL-Key replay counter.\n\n# Additional Contributions\n\n- We helped with writing several [patches for hostap](https://w1.fi/security/2017-1/), which is used in Linux, Android, and several professional APs.\n- We wrote most parts of the [patch to OpenBSD](https://ftp.openbsd.org/pub/OpenBSD/patches/6.1/common/027_net80211_replay.patch.sig).\n- We created vulnerability test tools to detect if devices are vulnerable. [The Wi-Fi Alliance](https://www.wi-fi.org/news-events/newsroom/wi-fi-alliance-security-update) is using these to [test if new products are affected](https://www.wi-fi.org/security-update-october-2017) or not. These test tools will be released publically once they are stable enough.","vulnerability_information_html":"\u003cp\u003eFull background information is at \u003ca href=\"/redirect?url=https%3A%2F%2Fwww.krackattacks.com\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ekrackattacks.com\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e and all detailed information can be found in our \u003ca href=\"/redirect?url=https%3A%2F%2Fpapers.mathyvanhoef.com%2Fccs2017.pdf\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eresearch paper\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003c/p\u003e\n\n\u003ch1 id=\"key-reinstallation-attack-4-way-handshake-example\"\u003eKey Reinstallation Attack: 4-way handshake example\u003c/h1\u003e\n\n\u003cp\u003eWe use the 4-way handshake to illustrate the idea behind key reinstallation attacks (CVE-2017-13077).\u003cbr\u003e\nNote that in practice, all protected Wi-Fi network rely on the 4-way handshake to derive a fresh session key (PTK) from some shared secret.\u003c/p\u003e\n\n\u003ch3 id=\"step-1-channel-based-man-in-the-middle-and-initial-handshake-messages\"\u003eStep 1. Channel-based man-in-the-middle and initial handshake messages:\u003c/h3\u003e\n\n\u003cul\u003e\n\u003cli\u003eThe adversary clones the access point (AP) on a different channel. Say the real AP is on channel 6, and it will be cloned on channel 1.\u003c/li\u003e\n\u003cli\u003eThe adversary uses Channel Switch Announcements to force victims into connecting to the cloned AP on channel 1.\u003c/li\u003e\n\u003cli\u003eThe adversary forwards the first three message of the 4-way handshake between the client and AP (i.e. the adversary fowards frames over the different channels).\u003c/li\u003e\n\u003cli\u003eAfter the client receives message 3 of the handshake, it will install the fresh session key (PTK) for the first time.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3 id=\"step-2-triggering-a-key-reinstallation\"\u003eStep 2. Triggering a key reinstallation:\u003c/h3\u003e\n\n\u003cul\u003e\n\u003cli\u003eThe attacker does not forward message 4 of the handshake to the AP, effectively blocking it.\u003c/li\u003e\n\u003cli\u003eAs a result, the AP will retransmit message 3 to the client.\u003c/li\u003e\n\u003cli\u003eAfter the client receives message 3, it responds with message 4. In practice all clients encrypt this retransmitted message 4 at the link layer. Note that it\u0026#39;s encrypted because message 4 an ordinary data frame, and the victim has already installed the session key to encrypt data frames (recall end of step 1). The victim will \u003cstrong\u003euse a nonce value of 1 to encrypt\u003c/strong\u003e message 4.\u003c/li\u003e\n\u003cli\u003eAfter sending message 4, the client will reinstall the session key. This \u003cstrong\u003eresets the transmit nonce\u003c/strong\u003e to zero.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3 id=\"step-3-abusing-nonce-reuse\"\u003eStep 3. Abusing nonce reuse:\u003c/h3\u003e\n\n\u003cul\u003e\n\u003cli\u003eWhen the client now transmit a normal encrypted data frame, it will increment the nonce counter, and then \u003cstrong\u003ereuse the nonce value 1 when encrypting the data frame\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003eWe can derive known keystream from the encrypted retransmitted message 4 (recall step 2), and use this to decrypt parts of the just transmitted encrypted data frame.\u003c/li\u003e\n\u003cli\u003eOther predictable packets (ARP, DHCP, HTML, and so on) can be used to obtain additional known plaintext and keystream, which can in turn be used to decrypt more and bigger packets.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eThe above example attack against the 4-way handshake is also illustrated in my \u003ca href=\"/redirect?url=https%3A%2F%2Fpapers.mathyvanhoef.com%2Fccs2017-slides.pdf\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eCCS\u0026#39;17 presentation\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003c/p\u003e\n\n\u003ch1 id=\"other-handshakes\"\u003eOther handshakes\u003c/h1\u003e\n\n\u003cp\u003eOther Wi-Fi handshakes or features that were found to be vulnerable to key reinstallation attacks are:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eReinstallation of group keys in the 4-way handshake: CVE-2017-13078 and CVE-2017-13079\u003c/li\u003e\n\u003cli\u003eThe group key handshake: CVE-2017-13080 and CVE-2017-13081\u003c/li\u003e\n\u003cli\u003eThe Fast BSS Transition (FT) handshake: CVE-2017-13082\u003c/li\u003e\n\u003cli\u003eThe PeerKey handshake: CVE-2017-13084\u003c/li\u003e\n\u003cli\u003eThe Tunneled Direct-Link Setup (TDLS) handshake: CVE-2017-13086\u003c/li\u003e\n\u003cli\u003eHandling of Wireless Network Management (WNM) Sleep Mode Response frame: CVE-2017-13087 and CVE-2017-13088.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1 id=\"countermeasures\"\u003eCountermeasures\u003c/h1\u003e\n\n\u003cp\u003eImplementations can be updated to prevent key reinstallation attacks in a backwards-compatible manner.\u003c/p\u003e\n\n\u003cp\u003eAs an additional mitigation, an access point can also prevent most attacks against vulnerable clients.\u003cbr\u003e\nIn particular, attacks against the 4-way handshake can be prevented by not retransmitting message 3.\u003cbr\u003e\nSimilarly, attacks against the group key handshake can be prevented by not retransmitting message 1 of the group key handshake. Alternatively, the access point can retransmit these two handshake messages using the previously used EAPOL-Key replay counter.\u003c/p\u003e\n\n\u003ch1 id=\"additional-contributions\"\u003eAdditional Contributions\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003eWe helped with writing several \u003ca href=\"/redirect?url=https%3A%2F%2Fw1.fi%2Fsecurity%2F2017-1%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003epatches for hostap\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e, which is used in Linux, Android, and several professional APs.\u003c/li\u003e\n\u003cli\u003eWe wrote most parts of the \u003ca href=\"/redirect?url=https%3A%2F%2Fftp.openbsd.org%2Fpub%2FOpenBSD%2Fpatches%2F6.1%2Fcommon%2F027_net80211_replay.patch.sig\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003epatch to OpenBSD\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003eWe created vulnerability test tools to detect if devices are vulnerable. \u003ca href=\"/redirect?url=https%3A%2F%2Fwww.wi-fi.org%2Fnews-events%2Fnewsroom%2Fwi-fi-alliance-security-update\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eThe Wi-Fi Alliance\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e is using these to \u003ca href=\"/redirect?url=https%3A%2F%2Fwww.wi-fi.org%2Fsecurity-update-october-2017\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003etest if new products are affected\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e or not. These test tools will be released publically once they are stable enough.\u003c/li\u003e\n\u003c/ul\u003e\n","bounty_amount":"25000.0","formatted_bounty":"$25,000","weakness":{"id":37,"name":"Reusing a Nonce, Key Pair in Encryption"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-12-03T00:34:22.692Z","allow_singular_disclosure_after":-96958193.81795661,"singular_disclosure_allowed":true,"vote_count":188,"voters":["irek","jokebookservice1","ratiometric","irvinlim","mirchr","snellejelle","rmzsx","rlaneth","arneswinnen","sp1d3rs","and 178 more..."],"severity":{"rating":"medium","score":6.8,"author_type":"Team","metrics":{"attack_vector":"adjacent","attack_complexity":"high","privileges_required":"none","user_interaction":"none","scope":"unchanged","confidentiality":"high","integrity":"high","availability":"none"}},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":2130346,"is_internal":false,"editable":false,"type":"Activities::CveIdAdded","message":"","markdown_message":"","automated_response":false,"created_at":"2017-11-03T00:29:50.261Z","updated_at":"2017-11-03T00:29:50.261Z","cve_ids":["CVE-2017-13077","CVE-2017-13078","CVE-2017-13079","CVE-2017-13080","CVE-2017-13081","CVE-2017-13082","CVE-2017-13084","CVE-2017-13086","CVE-2017-13087","CVE-2017-13088"],"actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"internet","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2130349,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","markdown_message":"","automated_response":false,"created_at":"2017-11-03T00:31:04.302Z","updated_at":"2017-11-03T00:31:04.302Z","additional_data":{"old_severity":null,"new_severity":"Medium (6.8)","old_severity_id":null,"new_severity_id":92000},"actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"internet","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2130350,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2017-11-03T00:34:05.564Z","updated_at":"2017-11-03T00:34:05.564Z","actor":{"url":"/internet","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/e3e1c58882b2645d9108ec102731a354cbf5852e_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"The Internet"}},"bounty_amount":"25000.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"internet","collaborator":{"username":"vanhoefm","url":"/vanhoefm"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2130351,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","markdown_message":"","automated_response":false,"created_at":"2017-11-03T00:34:17.147Z","updated_at":"2017-11-03T00:34:17.147Z","actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"reporter":{"username":"vanhoefm","url":"/vanhoefm"},"genius_execution_id":null,"team_handle":"internet","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2130352,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-11-03T00:34:22.638Z","updated_at":"2017-11-03T00:34:22.638Z","first_to_agree":true,"actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"internet","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2130357,"is_internal":false,"editable":false,"type":"Activities::ManuallyDisclosed","message":"","markdown_message":"","automated_response":false,"created_at":"2017-11-03T00:37:54.913Z","updated_at":"2017-11-03T00:37:54.913Z","actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"internet","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}