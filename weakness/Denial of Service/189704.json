{"id":189704,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xODk3MDQ=","url":"https://hackerone.com/reports/189704","title":"Segmentation fault due to invalid memory access in codegen when using break with the 127th argument a constant","state":"Closed","substate":"duplicate","readable_substate":"Duplicate","created_at":"2016-12-09T03:40:49.614Z","submitted_at":"2016-12-09T03:40:49.614Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"haquaman","url":"/haquaman","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/017/646/07cbfc394d4d3432eb95cf9735f225ea803090bb_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":15668,"url":"https://hackerone.com/shopify-scripts","handle":"shopify-scripts","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"shopify-scripts","twitter_handle":"","website":"","about":""}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2016-12-17T20:48:31.714Z","bug_reporter_agreed_on_going_public_at":"2016-12-17T20:13:31.247Z","team_member_agreed_on_going_public_at":"2016-12-17T20:48:31.681Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Crash file is:\n\n```\nbreak 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,CRASH\n```\n\nThis is 126 0's, then a constant. The 0's can be anything valid, and the constant just has to be a constant. Doesn't matter if it is defined or not. \n\nCauses a segfault with the following backtrace:\n```\nASAN:SIGSEGV\n=================================================================\n==813==ERROR: AddressSanitizer: SEGV on unknown address 0x0000000002ad (pc 0x00000063edfc bp 0x7ffe98e8cfe0 sp 0x7ffe98e8ce20 T0)\n    #0 0x63edfb in codegen /root/mruby-fixes/mrbgems/mruby-compiler/core/codegen.c:1221:39\n    #1 0x6818e5 in gen_values /root/mruby-fixes/mrbgems/mruby-compiler/core/codegen.c:821:9\n    #2 0x643cae in codegen /root/mruby-fixes/mrbgems/mruby-compiler/core/codegen.c:1596:11\n    #3 0x64a94d in loop_break /root/mruby-fixes/mrbgems/mruby-compiler/core/codegen.c:2853:5\n    #4 0x64a94d in codegen /root/mruby-fixes/mrbgems/mruby-compiler/core/codegen.c:2001\n    #5 0x64c8d8 in codegen /root/mruby-fixes/mrbgems/mruby-compiler/core/codegen.c:1239:7\n    #6 0x67a4b9 in scope_body /root/mruby-fixes/mrbgems/mruby-compiler/core/codegen.c:720:3\n    #7 0x63f3ef in codegen /root/mruby-fixes/mrbgems/mruby-compiler/core/codegen.c:1540:5\n    #8 0x63d870 in mrb_generate_code /root/mruby-fixes/mrbgems/mruby-compiler/core/codegen.c:2925:5\n    #9 0x5c0b4d in mrb_load_exec /root/mruby-fixes/mrbgems/mruby-compiler/core/parse.y:5723:10\n    #10 0x4e437b in main /root/mruby-fixes/mrbgems/mruby-bin-mruby/tools/mruby/mruby.c:232:11\n    #11 0x7fae55836ec4  (/lib/x86_64-linux-gnu/libc.so.6+0x21ec4)\n    #12 0x43d116 in _start (/root/mruby-fixes/bin/mruby+0x43d116)\n\nAddressSanitizer can not provide additional info.\nSUMMARY: AddressSanitizer: SEGV /root/mruby-fixes/mrbgems/mruby-compiler/core/codegen.c:1221 codegen\n==813==ABORTING\n\n```\n\nLooking through, looks like in `gen_values`, n loops up to 126 (on the constant node), so takes the first if block, val isn't set, so takes the else inside there, but `t-\u003ecar-\u003ecdr` points to a invalid memory address so when `codegen` dereferences `tree`, it segfaults.\n\n```\n$ lldb ./mruby/bin/mruby crash.rb\n(lldb) target create \"./mruby/bin/mruby\"\nCurrent executable set to './mruby/bin/mruby' (x86_64).\n(lldb) settings set -- target.run-args  \"crash.rb\"\n(lldb) r\nProcess 58614 launched: './mruby/bin/mruby' (x86_64)\nProcess 58614 stopped\n* thread #1: tid = 0x612a08, 0x000000010005c3f1 mruby`codegen(s=0x000000010101cc20, tree=0x000000000000029b, val=0) + 129 at codegen.c:1221, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x2ad)\n    frame #0: 0x000000010005c3f1 mruby`codegen(s=0x000000010101cc20, tree=0x000000000000029b, val=0) + 129 at codegen.c:1221\n   1218     return;\n   1219   }\n   1220\n-\u003e 1221   if (s-\u003eirep \u0026\u0026 s-\u003efilename_index != tree-\u003efilename_index) {\n   1222     s-\u003eirep-\u003efilename = mrb_parser_get_filename(s-\u003eparser, s-\u003efilename_index);\n   1223     mrb_debug_info_append_file(s-\u003emrb, s-\u003eirep, s-\u003edebug_start_pos, s-\u003epc);\n   1224     s-\u003edebug_start_pos = s-\u003epc;\n(lldb) up\nframe #1: 0x000000010006581a mruby`gen_values(s=0x000000010101cc20, t=0x00000001010170d4, val=0) + 762 at codegen.c:821\n   818          }\n   819        }\n   820        else {\n-\u003e 821          codegen(s, t-\u003ecar-\u003ecdr, NOVAL);\n   822          t = t-\u003ecdr;\n   823          while (t) {\n   824            codegen(s, t-\u003ecar, NOVAL);\n(lldb) p *t-\u003ecar\n(mrb_ast_node) $0 = {\n  car = 0x000000000000002c\n  cdr = 0x000000000000029b\n  lineno = 1\n  filename_index = 0\n}\n(lldb) p n\n(int) $1 = 126\n(lldb) p is_splat\n(int) $2 = 0\n(lldb) p val\n(int) $3 = 0\n(lldb) q\nQuitting LLDB will kill one or more processes. Do you really want to proceed: [Y/n] y\n\n```\n\nSo this is showing that that 127th argument to break isn't set right. I printed out `t-\u003ecar` for each `codegen` call, and it shows for the above, we get a the usual start (CFUNC, BEGIN, etc), then NODE_BREAK, followed by 126 NODE_INT's, then the segfault happens (`tree` points to invalid memory). \n\nI changed the constant to some other values, and found that `t-\u003ecar` was clearly overflowing for other values, `0.0` (`NODE_FLOAT`), was always a value of `3157552`, rather than `52`. A `NODE_INT` varied, but one value was `-197952842`, not `51`. same with `NODE_STR`, `NODE_DSTR`, `NODE_REGX`, a *non-empty* `NODE_ARRAY`, a `NODE_FCALL`, `NODE_CALL`.... You get the picture. Weirdly only the `NODE_FLOAT` always kept the same value...\n\nI've just found that a NODE_LVAR also crashes, such as this example crash file:\n\n```\ncrash=1\nbreak 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,crash\n```\n\n\nHaven't got a patch for this one yet, just wanted to file it.\n\nCheers,\n\nHugh\n","vulnerability_information_html":"\u003cp\u003eCrash file is:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003ebreak 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,CRASH\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis is 126 0\u0026#39;s, then a constant. The 0\u0026#39;s can be anything valid, and the constant just has to be a constant. Doesn\u0026#39;t matter if it is defined or not. \u003c/p\u003e\n\n\u003cp\u003eCauses a segfault with the following backtrace:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eASAN:SIGSEGV\n=================================================================\n==813==ERROR: AddressSanitizer: SEGV on unknown address 0x0000000002ad (pc 0x00000063edfc bp 0x7ffe98e8cfe0 sp 0x7ffe98e8ce20 T0)\n    #0 0x63edfb in codegen /root/mruby-fixes/mrbgems/mruby-compiler/core/codegen.c:1221:39\n    #1 0x6818e5 in gen_values /root/mruby-fixes/mrbgems/mruby-compiler/core/codegen.c:821:9\n    #2 0x643cae in codegen /root/mruby-fixes/mrbgems/mruby-compiler/core/codegen.c:1596:11\n    #3 0x64a94d in loop_break /root/mruby-fixes/mrbgems/mruby-compiler/core/codegen.c:2853:5\n    #4 0x64a94d in codegen /root/mruby-fixes/mrbgems/mruby-compiler/core/codegen.c:2001\n    #5 0x64c8d8 in codegen /root/mruby-fixes/mrbgems/mruby-compiler/core/codegen.c:1239:7\n    #6 0x67a4b9 in scope_body /root/mruby-fixes/mrbgems/mruby-compiler/core/codegen.c:720:3\n    #7 0x63f3ef in codegen /root/mruby-fixes/mrbgems/mruby-compiler/core/codegen.c:1540:5\n    #8 0x63d870 in mrb_generate_code /root/mruby-fixes/mrbgems/mruby-compiler/core/codegen.c:2925:5\n    #9 0x5c0b4d in mrb_load_exec /root/mruby-fixes/mrbgems/mruby-compiler/core/parse.y:5723:10\n    #10 0x4e437b in main /root/mruby-fixes/mrbgems/mruby-bin-mruby/tools/mruby/mruby.c:232:11\n    #11 0x7fae55836ec4  (/lib/x86_64-linux-gnu/libc.so.6+0x21ec4)\n    #12 0x43d116 in _start (/root/mruby-fixes/bin/mruby+0x43d116)\n\nAddressSanitizer can not provide additional info.\nSUMMARY: AddressSanitizer: SEGV /root/mruby-fixes/mrbgems/mruby-compiler/core/codegen.c:1221 codegen\n==813==ABORTING\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eLooking through, looks like in \u003ccode\u003egen_values\u003c/code\u003e, n loops up to 126 (on the constant node), so takes the first if block, val isn\u0026#39;t set, so takes the else inside there, but \u003ccode\u003et-\u0026gt;car-\u0026gt;cdr\u003c/code\u003e points to a invalid memory address so when \u003ccode\u003ecodegen\u003c/code\u003e dereferences \u003ccode\u003etree\u003c/code\u003e, it segfaults.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e$ lldb ./mruby/bin/mruby crash.rb\n(lldb) target create \u0026quot;./mruby/bin/mruby\u0026quot;\nCurrent executable set to \u0026#39;./mruby/bin/mruby\u0026#39; (x86_64).\n(lldb) settings set -- target.run-args  \u0026quot;crash.rb\u0026quot;\n(lldb) r\nProcess 58614 launched: \u0026#39;./mruby/bin/mruby\u0026#39; (x86_64)\nProcess 58614 stopped\n* thread #1: tid = 0x612a08, 0x000000010005c3f1 mruby`codegen(s=0x000000010101cc20, tree=0x000000000000029b, val=0) + 129 at codegen.c:1221, queue = \u0026#39;com.apple.main-thread\u0026#39;, stop reason = EXC_BAD_ACCESS (code=1, address=0x2ad)\n    frame #0: 0x000000010005c3f1 mruby`codegen(s=0x000000010101cc20, tree=0x000000000000029b, val=0) + 129 at codegen.c:1221\n   1218     return;\n   1219   }\n   1220\n-\u0026gt; 1221   if (s-\u0026gt;irep \u0026amp;\u0026amp; s-\u0026gt;filename_index != tree-\u0026gt;filename_index) {\n   1222     s-\u0026gt;irep-\u0026gt;filename = mrb_parser_get_filename(s-\u0026gt;parser, s-\u0026gt;filename_index);\n   1223     mrb_debug_info_append_file(s-\u0026gt;mrb, s-\u0026gt;irep, s-\u0026gt;debug_start_pos, s-\u0026gt;pc);\n   1224     s-\u0026gt;debug_start_pos = s-\u0026gt;pc;\n(lldb) up\nframe #1: 0x000000010006581a mruby`gen_values(s=0x000000010101cc20, t=0x00000001010170d4, val=0) + 762 at codegen.c:821\n   818          }\n   819        }\n   820        else {\n-\u0026gt; 821          codegen(s, t-\u0026gt;car-\u0026gt;cdr, NOVAL);\n   822          t = t-\u0026gt;cdr;\n   823          while (t) {\n   824            codegen(s, t-\u0026gt;car, NOVAL);\n(lldb) p *t-\u0026gt;car\n(mrb_ast_node) $0 = {\n  car = 0x000000000000002c\n  cdr = 0x000000000000029b\n  lineno = 1\n  filename_index = 0\n}\n(lldb) p n\n(int) $1 = 126\n(lldb) p is_splat\n(int) $2 = 0\n(lldb) p val\n(int) $3 = 0\n(lldb) q\nQuitting LLDB will kill one or more processes. Do you really want to proceed: [Y/n] y\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eSo this is showing that that 127th argument to break isn\u0026#39;t set right. I printed out \u003ccode\u003et-\u0026gt;car\u003c/code\u003e for each \u003ccode\u003ecodegen\u003c/code\u003e call, and it shows for the above, we get a the usual start (CFUNC, BEGIN, etc), then NODE_BREAK, followed by 126 NODE_INT\u0026#39;s, then the segfault happens (\u003ccode\u003etree\u003c/code\u003e points to invalid memory). \u003c/p\u003e\n\n\u003cp\u003eI changed the constant to some other values, and found that \u003ccode\u003et-\u0026gt;car\u003c/code\u003e was clearly overflowing for other values, \u003ccode\u003e0.0\u003c/code\u003e (\u003ccode\u003eNODE_FLOAT\u003c/code\u003e), was always a value of \u003ccode\u003e3157552\u003c/code\u003e, rather than \u003ccode\u003e52\u003c/code\u003e. A \u003ccode\u003eNODE_INT\u003c/code\u003e varied, but one value was \u003ccode\u003e-197952842\u003c/code\u003e, not \u003ccode\u003e51\u003c/code\u003e. same with \u003ccode\u003eNODE_STR\u003c/code\u003e, \u003ccode\u003eNODE_DSTR\u003c/code\u003e, \u003ccode\u003eNODE_REGX\u003c/code\u003e, a \u003cem\u003enon-empty\u003c/em\u003e \u003ccode\u003eNODE_ARRAY\u003c/code\u003e, a \u003ccode\u003eNODE_FCALL\u003c/code\u003e, \u003ccode\u003eNODE_CALL\u003c/code\u003e.... You get the picture. Weirdly only the \u003ccode\u003eNODE_FLOAT\u003c/code\u003e always kept the same value...\u003c/p\u003e\n\n\u003cp\u003eI\u0026#39;ve just found that a NODE_LVAR also crashes, such as this example crash file:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003ecrash=1\nbreak 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,crash\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eHaven\u0026#39;t got a patch for this one yet, just wanted to file it.\u003c/p\u003e\n\n\u003cp\u003eCheers,\u003c/p\u003e\n\n\u003cp\u003eHugh\u003c/p\u003e\n","weakness":{"id":48,"name":"Denial of Service"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":2,"voters":["eveeez","spetr0x"],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1352765,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Crash files.","markdown_message":"\u003cp\u003eCrash files.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-12-09T03:41:35.551Z","updated_at":"2016-12-09T03:41:35.551Z","actor":{"username":"haquaman","cleared":false,"url":"/haquaman","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/017/646/07cbfc394d4d3432eb95cf9735f225ea803090bb_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"attachments":[{"id":141912,"filename":"crash-189704-variable.rb","type":"text/plain","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/141/912/286bef8e1495a93f1a27a90af3b5f96d0f2a7465/crash-189704-variable.rb?response-content-disposition=attachment%3B%20filename%3D%22crash-189704-variable.rb%22%3B%20filename%2A%3DUTF-8%27%27crash-189704-variable.rb\u0026response-content-type=text%2Fplain\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ4IZIDGEJ%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T044847Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIHgvhPRXI%2B7x6zNGnfFbWtzZacTUlKPt3VwSApQji3YyAiEA2Y%2FuJ72LgjXuchHTkycORzGcHp9y6ZUl%2BeyKz%2FFfjlAqtAMIVBABGgwwMTM2MTkyNzQ4NDkiDHblJHa0bCSVtoiX8yqRA7Ct%2F1l8ihdf2xXnJNUaJGv7nq%2F1b1xXdqHLpOjb5bN22Ac%2BQjHl%2Bna1KjqQx0Qu8Fcs0WQUm6dGPZbHLiP%2FRkIHh6FlY41MtajX39mvBrMgWCmioQD4vc7NSsiqHLG4GmvgnIM0wWXfwwv%2Fmq%2BjRWJQacOyz7e9kYXzI%2BQkViUKmcuV48xoXGswHYXnPSqKC6IqSk0Rgc6j2xAmne60g5PNHQf%2BehWLSoXupow19n2vF%2BE4dhw1ZLX%2B9fBct02t5%2B41MEA5z30yhC52UxDX9%2BedHi3rXpTTyV%2FX%2BWfdeGSGSqmwrTAcipCpz01NR%2Fkk3srD5BLQB%2B6BdeDlwwcltfcgYdKO39yRPNyZePA9ihdN%2B4YHA7%2FY9ufCPbEevGDvtv3mVStbES31aUOxSmGNj%2B8fMMJqFBAtD4Qx54l8UFyMf%2BQ8PPbA0OLpU9rjip1L0zxevK6IGISP%2FPlDldWsNQvfi1Xn6QvRkmL1ANNGXqycx5MDUJExPyV801VOQ68%2FfbB87Cmdd8xIJWUNtmpsIgDtMO2wqv8FOusBRxy8OOzTGCKFydY5xn2aZtaPj3obazs55j%2BS5FoY%2BdkqAuB4pbyPDlTBBI%2Fe4ZIYYBH9t51VaQaRwrhKPTTntuBcC2b5uuKcGXYq9rnIAgbUHulNqSoxgZep0wAjzrLEFeECcDfqDCjG1QyXJkGQyq3UjLElJNKzeGgK4y5hW9emXis3wfoUPLixiL7W8M52b0Q9HQrT0RxnkkNSLj7aPyOAVCPImHNwjJ%2FI2KIbB5iD4e9PbxcHFvjKgkNUQh2pESECovpzx%2BAz7wsT%2FUMRieGT%2BFtMt1o90%2BewPxe95i025ZqzwWI1aVcXtA%3D%3D\u0026X-Amz-Signature=a4ab2844089d3b20e8d1804483e305484b5fb8367bf49c0428a5c1fbe6822e95"},{"id":141911,"filename":"crash-189704-constant.rb","type":"text/plain","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/141/911/1be20919e4f22156d8ca3eca7a62029ee28f4fc7/crash-189704-constant.rb?response-content-disposition=attachment%3B%20filename%3D%22crash-189704-constant.rb%22%3B%20filename%2A%3DUTF-8%27%27crash-189704-constant.rb\u0026response-content-type=text%2Fplain\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ4IZIDGEJ%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T044847Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIHgvhPRXI%2B7x6zNGnfFbWtzZacTUlKPt3VwSApQji3YyAiEA2Y%2FuJ72LgjXuchHTkycORzGcHp9y6ZUl%2BeyKz%2FFfjlAqtAMIVBABGgwwMTM2MTkyNzQ4NDkiDHblJHa0bCSVtoiX8yqRA7Ct%2F1l8ihdf2xXnJNUaJGv7nq%2F1b1xXdqHLpOjb5bN22Ac%2BQjHl%2Bna1KjqQx0Qu8Fcs0WQUm6dGPZbHLiP%2FRkIHh6FlY41MtajX39mvBrMgWCmioQD4vc7NSsiqHLG4GmvgnIM0wWXfwwv%2Fmq%2BjRWJQacOyz7e9kYXzI%2BQkViUKmcuV48xoXGswHYXnPSqKC6IqSk0Rgc6j2xAmne60g5PNHQf%2BehWLSoXupow19n2vF%2BE4dhw1ZLX%2B9fBct02t5%2B41MEA5z30yhC52UxDX9%2BedHi3rXpTTyV%2FX%2BWfdeGSGSqmwrTAcipCpz01NR%2Fkk3srD5BLQB%2B6BdeDlwwcltfcgYdKO39yRPNyZePA9ihdN%2B4YHA7%2FY9ufCPbEevGDvtv3mVStbES31aUOxSmGNj%2B8fMMJqFBAtD4Qx54l8UFyMf%2BQ8PPbA0OLpU9rjip1L0zxevK6IGISP%2FPlDldWsNQvfi1Xn6QvRkmL1ANNGXqycx5MDUJExPyV801VOQ68%2FfbB87Cmdd8xIJWUNtmpsIgDtMO2wqv8FOusBRxy8OOzTGCKFydY5xn2aZtaPj3obazs55j%2BS5FoY%2BdkqAuB4pbyPDlTBBI%2Fe4ZIYYBH9t51VaQaRwrhKPTTntuBcC2b5uuKcGXYq9rnIAgbUHulNqSoxgZep0wAjzrLEFeECcDfqDCjG1QyXJkGQyq3UjLElJNKzeGgK4y5hW9emXis3wfoUPLixiL7W8M52b0Q9HQrT0RxnkkNSLj7aPyOAVCPImHNwjJ%2FI2KIbB5iD4e9PbxcHFvjKgkNUQh2pESECovpzx%2BAz7wsT%2FUMRieGT%2BFtMt1o90%2BewPxe95i025ZqzwWI1aVcXtA%3D%3D\u0026X-Amz-Signature=be836b16c7ae0f4c17db13f9e871f68751e03b1c640972485c64111ca5656bbb"}],"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1352767,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Oh what was I saying, I did have a patch for this. It was to not bother doing a codegen if you are just going to do a raise directly after it. Like so:\n\n```\ndiff --git a/mrbgems/mruby-compiler/core/codegen.c b/mrbgems/mruby-compiler/core/codegen.c\nindex 891c4f6..5ef7c83 100644\n--- a/mrbgems/mruby-compiler/core/codegen.c\n+++ b/mrbgems/mruby-compiler/core/codegen.c\n@@ -2850,7 +2850,6 @@ static void\n loop_break(codegen_scope *s, node *tree)\n {\n   if (!s-\u003eloop) {\n-    codegen(s, tree, NOVAL);\n     raise_error(s, \"unexpected break\");\n   }\n   else {\n```\n\nNow gets this:\n\n```\n$ ./mruby/bin/mruby crash-189704-constant.rb\ntrace:\n        [0] crash-189704-constant.rb:1\nLocalJumpError: unexpected break\n```","markdown_message":"\u003cp\u003eOh what was I saying, I did have a patch for this. It was to not bother doing a codegen if you are just going to do a raise directly after it. Like so:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight diff\"\u003e\u003ccode\u003e\u003cspan class=\"gh\"\u003ediff --git a/mrbgems/mruby-compiler/core/codegen.c b/mrbgems/mruby-compiler/core/codegen.c\nindex 891c4f6..5ef7c83 100644\n\u003c/span\u003e\u003cspan class=\"gd\"\u003e--- a/mrbgems/mruby-compiler/core/codegen.c\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+++ b/mrbgems/mruby-compiler/core/codegen.c\n\u003c/span\u003e\u003cspan class=\"p\"\u003e@@ -2850,7 +2850,6 @@\u003c/span\u003e static void\n loop_break(codegen_scope *s, node *tree)\n {\n   if (!s-\u0026gt;loop) {\n\u003cspan class=\"gd\"\u003e-    codegen(s, tree, NOVAL);\n\u003c/span\u003e     raise_error(s, \u0026quot;unexpected break\u0026quot;);\n   }\n   else {\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eNow gets this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e$ ./mruby/bin/mruby crash-189704-constant.rb\ntrace:\n        [0] crash-189704-constant.rb:1\nLocalJumpError: unexpected break\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","automated_response":false,"created_at":"2016-12-09T03:43:48.283Z","updated_at":"2016-12-09T03:43:48.283Z","actor":{"username":"haquaman","cleared":false,"url":"/haquaman","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/017/646/07cbfc394d4d3432eb95cf9735f225ea803090bb_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"attachments":[{"id":141914,"filename":"bug-189704.patch","type":"text/x-diff","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/141/914/064b2aefefb01cc20aa7612e70b406f2d8fa27a1/bug-189704.patch?response-content-disposition=attachment%3B%20filename%3D%22bug-189704.patch%22%3B%20filename%2A%3DUTF-8%27%27bug-189704.patch\u0026response-content-type=text%2Fx-diff\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ4IZIDGEJ%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T044847Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIHgvhPRXI%2B7x6zNGnfFbWtzZacTUlKPt3VwSApQji3YyAiEA2Y%2FuJ72LgjXuchHTkycORzGcHp9y6ZUl%2BeyKz%2FFfjlAqtAMIVBABGgwwMTM2MTkyNzQ4NDkiDHblJHa0bCSVtoiX8yqRA7Ct%2F1l8ihdf2xXnJNUaJGv7nq%2F1b1xXdqHLpOjb5bN22Ac%2BQjHl%2Bna1KjqQx0Qu8Fcs0WQUm6dGPZbHLiP%2FRkIHh6FlY41MtajX39mvBrMgWCmioQD4vc7NSsiqHLG4GmvgnIM0wWXfwwv%2Fmq%2BjRWJQacOyz7e9kYXzI%2BQkViUKmcuV48xoXGswHYXnPSqKC6IqSk0Rgc6j2xAmne60g5PNHQf%2BehWLSoXupow19n2vF%2BE4dhw1ZLX%2B9fBct02t5%2B41MEA5z30yhC52UxDX9%2BedHi3rXpTTyV%2FX%2BWfdeGSGSqmwrTAcipCpz01NR%2Fkk3srD5BLQB%2B6BdeDlwwcltfcgYdKO39yRPNyZePA9ihdN%2B4YHA7%2FY9ufCPbEevGDvtv3mVStbES31aUOxSmGNj%2B8fMMJqFBAtD4Qx54l8UFyMf%2BQ8PPbA0OLpU9rjip1L0zxevK6IGISP%2FPlDldWsNQvfi1Xn6QvRkmL1ANNGXqycx5MDUJExPyV801VOQ68%2FfbB87Cmdd8xIJWUNtmpsIgDtMO2wqv8FOusBRxy8OOzTGCKFydY5xn2aZtaPj3obazs55j%2BS5FoY%2BdkqAuB4pbyPDlTBBI%2Fe4ZIYYBH9t51VaQaRwrhKPTTntuBcC2b5uuKcGXYq9rnIAgbUHulNqSoxgZep0wAjzrLEFeECcDfqDCjG1QyXJkGQyq3UjLElJNKzeGgK4y5hW9emXis3wfoUPLixiL7W8M52b0Q9HQrT0RxnkkNSLj7aPyOAVCPImHNwjJ%2FI2KIbB5iD4e9PbxcHFvjKgkNUQh2pESECovpzx%2BAz7wsT%2FUMRieGT%2BFtMt1o90%2BewPxe95i025ZqzwWI1aVcXtA%3D%3D\u0026X-Amz-Signature=7c8c0835cf4f5379ab6c23408dd74084ecf176996c06ecd65db5e29a594e168b"}],"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1352775,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Also affected `mruby-engine`, but that patch fixes it as well.\n\n```\n$ ./bin/sandbox crash-189704-constant.rb\n./bin/sandbox:20: [BUG] Segmentation fault at 0x00000000000268\nruby 2.3.0p0 (2015-12-25 revision 53290) [x86_64-darwin15]\n\n-- Crash Report log information --------------------------------------------\n   See Crash Report log file under the one of following:\n     * ~/Library/Logs/CrashReporter\n     * /Library/Logs/CrashReporter\n     * ~/Library/Logs/DiagnosticReports\n     * /Library/Logs/DiagnosticReports\n   for more details.\nDon't forget to include the above Crash Report log file in bug reports.\n\n-- Control frame information -----------------------------------------------\nc:0003 p:---- s:0011 e:000010 CFUNC  :sandbox_eval\nc:0002 p:0214 s:0006 E:001f00 EVAL   ./bin/sandbox:21 [FINISH]\nc:0001 p:0000 s:0002 E:001350 (none) [FINISH]\n\n-- Ruby level backtrace information ----------------------------------------\n./bin/sandbox:20:in `\u003cmain\u003e'\n./bin/sandbox:20:in `sandbox_eval'\n\n-- Machine register context ------------------------------------------------\n rax: 0x0000000000000000 rbx: 0x0000000000000256 rcx: 0x000000010224ec50\n rdx: 0x0000000000000000 rdi: 0x000000010224ec50 rsi: 0x0000000000000256\n rbp: 0x00007fff5e45cee0 rsp: 0x00007fff5e45ce50  r8: 0x0000000102214b60\n  r9: 0x0000000000000006 r10: 0x0000000000000000 r11: 0x00000001021f3000\n r12: 0x0000000000000000 r13: 0x000000010224ec50 r14: 0x000000010224a39c\n r15: 0x000000000000007e rip: 0x00000001021096e5 rfl: 0x0000000000010206\n\n-- C level backtrace information -------------------------------------------\n0   ruby                                0x000000010193f5d4 rb_vm_bugreport + 388\n1   ruby                                0x00000001017e1023 rb_bug_context + 483\n2   ruby                                0x00000001018b4653 sigsegv + 83\n3   libsystem_platform.dylib            0x00007fff912e252a _sigtramp + 26\n4   mruby_engine.bundle                 0x00000001021096e5 codegen + 53\n5   ???                                 0x0000000000000000 0x0 + 0\n\n-- Other runtime information -----------------------------------------------\n\n* Loaded script: ./bin/sandbox\n\n* Loaded features:\n\n    0 enumerator.so\n    1 thread.rb\n    2 rational.so\n    3 complex.so\n\u003csnip various gems\u003e\n  185 /Users/\u003csnip\u003e/mruby-engine/lib/mruby_engine/mruby_engine.bundle\n  186 /Users/\u003csnip\u003e/mruby-engine/lib/mruby_engine.rb\n\n[NOTE]\nYou may have encountered a bug in the Ruby interpreter or extension libraries.\nBug reports are welcome.\nFor details: http://www.ruby-lang.org/bugreport.html\n\nAbort trap: 6\n\n```\n\nAfter patch:\n\n```\n$ ./bin/sandbox crash-189704-constant.rb\n./bin/sandbox:20:in `sandbox_eval': unexpected break (MRubyEngine::EngineRuntimeError)\n  from ./bin/sandbox:20:in `\u003cmain\u003e'\n```\n\nCheers,\n\nHugh","markdown_message":"\u003cp\u003eAlso affected \u003ccode\u003emruby-engine\u003c/code\u003e, but that patch fixes it as well.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e$ ./bin/sandbox crash-189704-constant.rb\n./bin/sandbox:20: [BUG] Segmentation fault at 0x00000000000268\nruby 2.3.0p0 (2015-12-25 revision 53290) [x86_64-darwin15]\n\n-- Crash Report log information --------------------------------------------\n   See Crash Report log file under the one of following:\n     * ~/Library/Logs/CrashReporter\n     * /Library/Logs/CrashReporter\n     * ~/Library/Logs/DiagnosticReports\n     * /Library/Logs/DiagnosticReports\n   for more details.\nDon\u0026#39;t forget to include the above Crash Report log file in bug reports.\n\n-- Control frame information -----------------------------------------------\nc:0003 p:---- s:0011 e:000010 CFUNC  :sandbox_eval\nc:0002 p:0214 s:0006 E:001f00 EVAL   ./bin/sandbox:21 [FINISH]\nc:0001 p:0000 s:0002 E:001350 (none) [FINISH]\n\n-- Ruby level backtrace information ----------------------------------------\n./bin/sandbox:20:in `\u0026lt;main\u0026gt;\u0026#39;\n./bin/sandbox:20:in `sandbox_eval\u0026#39;\n\n-- Machine register context ------------------------------------------------\n rax: 0x0000000000000000 rbx: 0x0000000000000256 rcx: 0x000000010224ec50\n rdx: 0x0000000000000000 rdi: 0x000000010224ec50 rsi: 0x0000000000000256\n rbp: 0x00007fff5e45cee0 rsp: 0x00007fff5e45ce50  r8: 0x0000000102214b60\n  r9: 0x0000000000000006 r10: 0x0000000000000000 r11: 0x00000001021f3000\n r12: 0x0000000000000000 r13: 0x000000010224ec50 r14: 0x000000010224a39c\n r15: 0x000000000000007e rip: 0x00000001021096e5 rfl: 0x0000000000010206\n\n-- C level backtrace information -------------------------------------------\n0   ruby                                0x000000010193f5d4 rb_vm_bugreport + 388\n1   ruby                                0x00000001017e1023 rb_bug_context + 483\n2   ruby                                0x00000001018b4653 sigsegv + 83\n3   libsystem_platform.dylib            0x00007fff912e252a _sigtramp + 26\n4   mruby_engine.bundle                 0x00000001021096e5 codegen + 53\n5   ???                                 0x0000000000000000 0x0 + 0\n\n-- Other runtime information -----------------------------------------------\n\n* Loaded script: ./bin/sandbox\n\n* Loaded features:\n\n    0 enumerator.so\n    1 thread.rb\n    2 rational.so\n    3 complex.so\n\u0026lt;snip various gems\u0026gt;\n  185 /Users/\u0026lt;snip\u0026gt;/mruby-engine/lib/mruby_engine/mruby_engine.bundle\n  186 /Users/\u0026lt;snip\u0026gt;/mruby-engine/lib/mruby_engine.rb\n\n[NOTE]\nYou may have encountered a bug in the Ruby interpreter or extension libraries.\nBug reports are welcome.\nFor details: http://www.ruby-lang.org/bugreport.html\n\nAbort trap: 6\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAfter patch:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e$ ./bin/sandbox crash-189704-constant.rb\n./bin/sandbox:20:in `sandbox_eval\u0026#39;: unexpected break (MRubyEngine::EngineRuntimeError)\n  from ./bin/sandbox:20:in `\u0026lt;main\u0026gt;\u0026#39;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eCheers,\u003c/p\u003e\n\n\u003cp\u003eHugh\u003c/p\u003e\n","automated_response":false,"created_at":"2016-12-09T03:47:37.602Z","updated_at":"2016-12-09T03:47:37.602Z","actor":{"username":"haquaman","cleared":false,"url":"/haquaman","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/017/646/07cbfc394d4d3432eb95cf9735f225ea803090bb_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1354165,"is_internal":false,"editable":false,"type":"Activities::BugDuplicate","message":"Thank you for your report. We previously discovered this issue internally, and it has already been patched in our production environment. We hadn't submitted the patch upstream yet, but we have done that now: https://github.com/mruby/mruby/pull/3338\n\nSorry about the delay in pushing that upstream.","markdown_message":"\u003cp\u003eThank you for your report. We previously discovered this issue internally, and it has already been patched in our production environment. We hadn\u0026#39;t submitted the patch upstream yet, but we have done that now: \u003ca title=\"https://github.com/mruby/mruby/pull/3338\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fmruby%2Fmruby%2Fpull%2F3338\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/mruby/mruby/pull/3338\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eSorry about the delay in pushing that upstream.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-12-09T16:09:05.610Z","updated_at":"2016-12-09T16:09:05.610Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1354860,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Oh interesting i couldn't get it to work with next. I tried as i saw that was generating the same call_args in code.y\n\nShame about duplicate. Serves me right for not reporting when i found it the other week.","markdown_message":"\u003cp\u003eOh interesting i couldn\u0026#39;t get it to work with next. I tried as i saw that was generating the same call_args in code.y\u003c/p\u003e\n\n\u003cp\u003eShame about duplicate. Serves me right for not reporting when i found it the other week.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-12-09T20:38:07.240Z","updated_at":"2016-12-09T20:38:07.240Z","actor":{"username":"haquaman","cleared":false,"url":"/haquaman","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/017/646/07cbfc394d4d3432eb95cf9735f225ea803090bb_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1371665,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Care to disclose?","markdown_message":"\u003cp\u003eCare to disclose?\u003c/p\u003e\n","automated_response":false,"created_at":"2016-12-17T20:13:31.271Z","updated_at":"2016-12-17T20:13:31.271Z","first_to_agree":true,"actor":{"username":"haquaman","cleared":false,"url":"/haquaman","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/017/646/07cbfc394d4d3432eb95cf9735f225ea803090bb_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1371701,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Sure!","markdown_message":"\u003cp\u003eSure!\u003c/p\u003e\n","automated_response":false,"created_at":"2016-12-17T20:48:31.699Z","updated_at":"2016-12-17T20:48:31.699Z","actor":{"username":"francoischagnon","cleared":false,"url":"/francoischagnon","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/168/5d577fe97283a5483331257b629b6287ed4d287b_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1371702,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2016-12-17T20:48:31.728Z","updated_at":"2016-12-17T20:48:31.728Z","actor":{"username":"francoischagnon","cleared":false,"url":"/francoischagnon","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/168/5d577fe97283a5483331257b629b6287ed4d287b_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}