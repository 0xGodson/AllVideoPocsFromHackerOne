{"id":200387,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yMDAzODc=","url":"https://hackerone.com/reports/200387","title":"Incorrect code generation with redo inside NODE_RESCUE.","state":"Closed","substate":"resolved","severity_rating":"low","readable_substate":"Resolved","created_at":"2017-01-22T18:09:42.398Z","submitted_at":"2017-01-22T18:09:42.398Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"dgaletic","url":"/dgaletic","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":15668,"url":"https://hackerone.com/shopify-scripts","handle":"shopify-scripts","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"shopify-scripts","twitter_handle":"","website":"","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2017-02-28T13:30:14.189Z","bug_reporter_agreed_on_going_public_at":"2017-02-28T13:30:14.146Z","team_member_agreed_on_going_public_at":"2017-02-27T23:30:32.152Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"The following code causes mruby to use up all available memory:\n\n`class A redo\nrescue c\nend`\n\nFollowing the execution, we see the code in codegen.c jumping between\nCASE(OP_ONERR) and CASE(OP_JMP). CASE(OP_ONERR) uses realloc to double\nthe size of mrb-\u003ec-\u003erescue, and since it is stuck in an infinite loop\nbetween the two instructions, it runs out of memory.\n\nThe problematic jump is visible in the bytcode (emphasis added).\n\n00001 NODE_SCOPE:\n00001   NODE_BEGIN:\n00001     NODE_CLASS:\n00003       :A\n00003       body:\n00001         NODE_RESCUE:\n00003           body:\n00001             NODE_BEGIN:\n00001               NODE_REDO\n00003           rescue:\n00003             handle classes:\n00002               NODE_FCALL:\n00002                 NODE_SELF\n00002                 method='c' (670)\n00003             rescue body:\n00003               NODE_BEGIN:\n\nirep 0x715200 nregs=3 nlocals=1 pools=0 syms=1 reps=1\n    1 000 OP_LOADNIL    R1\n    1 001 OP_LOADNIL    R2\n    1 002 OP_CLASS      R1      :A\n    1 003 OP_EXEC       R1      I(+1)\n    1 004 OP_STOP\n\nirep 0x71b400 nregs=4 nlocals=1 pools=0 syms=2 reps=0\n    **1 000 OP_ONERR      003**   \u003c------- Infinite loop\n    **1 001 OP_JMP        000**   \u003c------- created here.\n    1 002 OP_JMP        013\n    1 003 OP_RESCUE     R1\n    2 004 OP_LOADSELF   R2\n    2 005 OP_SEND       R2      :c      0\n    2 006 OP_MOVE       R3      R1\n    2 007 OP_SEND       R2      :===    1\n    2 008 OP_JMPIF      R2      010\n    2 009 OP_JMP        012\n    3 010 OP_LOADNIL    R1\n    3 011 OP_JMP        014\n    3 012 OP_RAISE      R1\n    3 013 OP_POPERR     1\n    3 014 OP_RETURN     R1      return\n\nTesting the same code with MRI Ruby shows that MRI Ruby rejects it as a syntax\nerror. It would seem MRI Ruby forbids the use of `redo` in the context of\n`rescue` so the patch below disallows the related LOOP_* types. The test suite\nruns successfully with the patch. The bug is mitigated inside the mruby-engine\nsandbox because it triggers the instruction quota.\n\n```\n--- a/mrbgems/mruby-compiler/core/codegen.c\n+++ b/mrbgems/mruby-compiler/core/codegen.c\n@@ -2031,7 +2031,7 @@ codegen(codegen_scope *s, node *tree, int val)\n     break;\n \n   case NODE_REDO:\n-    if (!s-\u003eloop) {\n+    if (!s-\u003eloop || s-\u003eloop-\u003etype == LOOP_BEGIN || s-\u003eloop-\u003etype == LOOP_RESCUE) {\n       raise_error(s, \"unexpected redo\");\n     }\n     else {\n```\n","vulnerability_information_html":"\u003cp\u003eThe following code causes mruby to use up all available memory:\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eclass A redo\u003cbr\u003e\nrescue c\u003cbr\u003e\nend\u003c/code\u003e\u003c/p\u003e\n\n\u003cp\u003eFollowing the execution, we see the code in codegen.c jumping between\u003cbr\u003e\nCASE(OP_ONERR) and CASE(OP_JMP). CASE(OP_ONERR) uses realloc to double\u003cbr\u003e\nthe size of mrb-\u0026gt;c-\u0026gt;rescue, and since it is stuck in an infinite loop\u003cbr\u003e\nbetween the two instructions, it runs out of memory.\u003c/p\u003e\n\n\u003cp\u003eThe problematic jump is visible in the bytcode (emphasis added).\u003c/p\u003e\n\n\u003cp\u003e00001 NODE_SCOPE:\u003cbr\u003e\n00001   NODE_BEGIN:\u003cbr\u003e\n00001     NODE_CLASS:\u003cbr\u003e\n00003       :A\u003cbr\u003e\n00003       body:\u003cbr\u003e\n00001         NODE_RESCUE:\u003cbr\u003e\n00003           body:\u003cbr\u003e\n00001             NODE_BEGIN:\u003cbr\u003e\n00001               NODE_REDO\u003cbr\u003e\n00003           rescue:\u003cbr\u003e\n00003             handle classes:\u003cbr\u003e\n00002               NODE_FCALL:\u003cbr\u003e\n00002                 NODE_SELF\u003cbr\u003e\n00002                 method=\u0026#39;c\u0026#39; (670)\u003cbr\u003e\n00003             rescue body:\u003cbr\u003e\n00003               NODE_BEGIN:\u003c/p\u003e\n\n\u003cp\u003eirep 0x715200 nregs=3 nlocals=1 pools=0 syms=1 reps=1\u003cbr\u003e\n    1 000 OP_LOADNIL    R1\u003cbr\u003e\n    1 001 OP_LOADNIL    R2\u003cbr\u003e\n    1 002 OP_CLASS      R1      :A\u003cbr\u003e\n    1 003 OP_EXEC       R1      I(+1)\u003cbr\u003e\n    1 004 OP_STOP\u003c/p\u003e\n\n\u003cp\u003eirep 0x71b400 nregs=4 nlocals=1 pools=0 syms=2 reps=0\u003cbr\u003e\n    \u003cstrong\u003e1 000 OP_ONERR      003\u003c/strong\u003e   \u0026lt;------- Infinite loop\u003cbr\u003e\n    \u003cstrong\u003e1 001 OP_JMP        000\u003c/strong\u003e   \u0026lt;------- created here.\u003cbr\u003e\n    1 002 OP_JMP        013\u003cbr\u003e\n    1 003 OP_RESCUE     R1\u003cbr\u003e\n    2 004 OP_LOADSELF   R2\u003cbr\u003e\n    2 005 OP_SEND       R2      :c      0\u003cbr\u003e\n    2 006 OP_MOVE       R3      R1\u003cbr\u003e\n    2 007 OP_SEND       R2      :===    1\u003cbr\u003e\n    2 008 OP_JMPIF      R2      010\u003cbr\u003e\n    2 009 OP_JMP        012\u003cbr\u003e\n    3 010 OP_LOADNIL    R1\u003cbr\u003e\n    3 011 OP_JMP        014\u003cbr\u003e\n    3 012 OP_RAISE      R1\u003cbr\u003e\n    3 013 OP_POPERR     1\u003cbr\u003e\n    3 014 OP_RETURN     R1      return\u003c/p\u003e\n\n\u003cp\u003eTesting the same code with MRI Ruby shows that MRI Ruby rejects it as a syntax\u003cbr\u003e\nerror. It would seem MRI Ruby forbids the use of \u003ccode\u003eredo\u003c/code\u003e in the context of\u003cbr\u003e\n\u003ccode\u003erescue\u003c/code\u003e so the patch below disallows the related LOOP_* types. The test suite\u003cbr\u003e\nruns successfully with the patch. The bug is mitigated inside the mruby-engine\u003cbr\u003e\nsandbox because it triggers the instruction quota.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight diff\"\u003e\u003ccode\u003e\u003cspan class=\"gd\"\u003e--- a/mrbgems/mruby-compiler/core/codegen.c\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+++ b/mrbgems/mruby-compiler/core/codegen.c\n\u003c/span\u003e\u003cspan class=\"p\"\u003e@@ -2031,7 +2031,7 @@\u003c/span\u003e codegen(codegen_scope *s, node *tree, int val)\n     break;\n\n   case NODE_REDO:\n\u003cspan class=\"gd\"\u003e-    if (!s-\u0026gt;loop) {\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+    if (!s-\u0026gt;loop || s-\u0026gt;loop-\u0026gt;type == LOOP_BEGIN || s-\u0026gt;loop-\u0026gt;type == LOOP_RESCUE) {\n\u003c/span\u003e       raise_error(s, \u0026quot;unexpected redo\u0026quot;);\n     }\n     else {\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","bounty_amount":"100.0","formatted_bounty":"$100","weakness":{"id":48,"name":"Denial of Service"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":154258,"file_name":"0001-Fix-incorrect-code-generation-with-redo-inside-NODE_.patch","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/154/258/ce6d3f538a4a9f1ce241c078b3eed528a411f0ee/0001-Fix-incorrect-code-generation-with-redo-inside-NODE_.patch?response-content-disposition=attachment%3B%20filename%3D%220001-Fix-incorrect-code-generation-with-redo-inside-NODE_.patch%22%3B%20filename%2A%3DUTF-8%27%270001-Fix-incorrect-code-generation-with-redo-inside-NODE_.patch\u0026response-content-type=text%2Fx-diff\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ2CQCXB7P%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T045304Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJj%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQCKfc9uxh22FGIBSKNqNzEdwAGilNzlyCJlRQkk6L7ywwIgTF9zV46T%2F8NjN%2BIYnxBP9uKa%2FXVMex8eb6F8QfoW3wEqtAMIURABGgwwMTM2MTkyNzQ4NDkiDJ5ZNSNolCYK8UaqCyqRAzNhE%2Fm3zPdEHRm5WUEnZo0COkaeE9dAwJeLRl1TZ11d43Lhd%2FMikAINQoGyi4r4ILldIaNgVmSsjmb0fcorizPel9Yzwr4cFLsZOlxR5w1wIcH9%2B%2FXSVM%2FPyc6y3YiLMP%2BnfwLJ7AL67U%2BsYNgwrwRQCUMORslIWy4Bee0CRE37pQRcD%2BpnBGoZEqEgw%2FHEeFzSipLRBmOXQXxK8U%2FyZbCwKI3Y7jZdrKPqHfhEodvEeD0Wwknnt5JRb8OwCuT7%2BjnXPx7Ftl6fh7ZHEZSimVCNgNXHtQ7MayTMvGyEcE%2FGEdWIy%2BvUTFD59Sbk%2B4fSP5XGoClsVLqX8UQRsOAbpYFv8pGdRWsta2NjZfh4swj28Z1ENJENNBr0wiLwpBy4s4wlkmS86icFZ53iBsI3EOJmZJ5DZ5redWS7l%2BgYoOpzpgENRZcaEYNEAzZuOnjhHMp0RSoAnDuPybSiBCQrW8JftW%2Buq0QzjkbBqzj7nPJ0%2FbXQQzRl4pJZycpxagVMpzjAmvRed9%2BHfODrR1Wa1B9bMPDlqf8FOusBVFGMNirRKMu5AkI7qGagYnYSG4HpDqpKcH5QuM0jUoRkB5r%2BZWkCPAsBHe6t6p0Cfzk0IF3j5b1WbHsN2UHZ8rtF%2BtQ%2F7OawY4eFB8qp9BuOlUA1okg7%2BXvgui2gDL6mFoU2mzqz8v%2BmiFTIaBj8QjYyPX%2Ft4bj%2FyE7%2BzfsRuoeKoPtREJbjscDMF4yK366F0eCTIiw1cnRHt2i638RsSrY3MoN%2BD241aZxfV0getVCLrP4EjZE1CMOAzzhsZEa%2B%2BPrZg0WXd5TN40IoVxY7vjGdJo5rtxp6xBPK%2FbNPk5gPBu93zpBV2vOdiQ%3D%3D\u0026X-Amz-Signature=5ff4cbbede585b9c6cc3c4e7133426d05c99e8c0bda602ea0ec1b7c7e4b82e94","file_size":825,"type":"text/x-diff"}],"allow_singular_disclosure_at":"2017-03-29T23:30:32.185Z","allow_singular_disclosure_after":-118387352.25123055,"singular_disclosure_allowed":true,"vote_count":2,"voters":["eveeez","spetr0x"],"severity":{"rating":"low","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1437143,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for reporting this bug! This is an automated response to let you know that we've received your issue, and we'll process it as soon as possible.\n\nDue to the large volume of reports we have received, it may take us up to three weeks to respond. Thank you for your patience!","markdown_message":"\u003cp\u003eThank you for reporting this bug! This is an automated response to let you know that we\u0026#39;ve received your issue, and we\u0026#39;ll process it as soon as possible.\u003c/p\u003e\n\n\u003cp\u003eDue to the large volume of reports we have received, it may take us up to three weeks to respond. Thank you for your patience!\u003c/p\u003e\n","automated_response":true,"created_at":"2017-01-22T18:09:42.582Z","updated_at":"2017-01-22T18:09:42.582Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"shopify-scripts"}},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1456595,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thank you for the detailed report. We've opened the issue upstream: https://github.com/mruby/mruby/issues/3422","markdown_message":"\u003cp\u003eThank you for the detailed report. We\u0026#39;ve opened the issue upstream: \u003ca title=\"https://github.com/mruby/mruby/issues/3422\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fmruby%2Fmruby%2Fissues%2F3422\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/mruby/mruby/issues/3422\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n","automated_response":false,"created_at":"2017-02-01T17:10:24.348Z","updated_at":"2017-02-01T17:10:24.348Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1461741,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Edit: Ignore this; accidentally posted here, and I don't see a \"delete comment\" option.","markdown_message":"\u003cp\u003eEdit: Ignore this; accidentally posted here, and I don\u0026#39;t see a \u0026quot;delete comment\u0026quot; option.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-02-03T21:20:54.711Z","updated_at":"2017-02-03T21:23:50.811Z","actor":{"username":"dgaletic","cleared":true,"url":"/dgaletic","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1499526,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thanks again for your report. This was resolved upstream in https://github.com/mruby/mruby/commit/ecb6ac8b4aca56582ebed3e955178a0ad6c77d5d\n\nOur next round of bounty decisions will take place within two weeks, so we'll be in touch with you again soon.","markdown_message":"\u003cp\u003eThanks again for your report. This was resolved upstream in \u003ca title=\"https://github.com/mruby/mruby/commit/ecb6ac8b4aca56582ebed3e955178a0ad6c77d5d\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fmruby%2Fmruby%2Fcommit%2Fecb6ac8b4aca56582ebed3e955178a0ad6c77d5d\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/mruby/mruby/commit/ecb6ac8b4aca56582ebed3e955178a0ad6c77d5d\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eOur next round of bounty decisions will take place within two weeks, so we\u0026#39;ll be in touch with you again soon.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-02-22T15:57:16.273Z","updated_at":"2017-02-22T15:57:16.273Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"dgaletic","url":"/dgaletic"},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1509645,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks for helping improve the security of the MRuby project!","markdown_message":"\u003cp\u003eThanks for helping improve the security of the MRuby project!\u003c/p\u003e\n","automated_response":false,"created_at":"2017-02-27T23:30:25.962Z","updated_at":"2017-02-27T23:30:25.962Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"shopify-scripts"}},"bounty_amount":"100.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"shopify-scripts","collaborator":{"username":"dgaletic","url":"/dgaletic"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1509646,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-02-27T23:30:32.168Z","updated_at":"2017-02-27T23:30:32.168Z","first_to_agree":true,"actor":{"username":"andrewdunbar","cleared":false,"url":"/andrewdunbar","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/164/5b0e89675ed6dbb9df87223e9f8f58e2125bb56b_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1510924,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-02-28T13:30:14.172Z","updated_at":"2017-02-28T13:30:14.172Z","actor":{"username":"dgaletic","cleared":true,"url":"/dgaletic","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1510925,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-02-28T13:30:14.203Z","updated_at":"2017-02-28T13:30:14.203Z","actor":{"username":"dgaletic","cleared":true,"url":"/dgaletic","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}