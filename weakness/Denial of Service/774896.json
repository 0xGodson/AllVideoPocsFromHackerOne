{"id":774896,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC83NzQ4OTY=","url":"https://hackerone.com/reports/774896","title":"Kubelet resource exhaustion attack via metric label cardinality explosion from unauthenticated requests","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2020-01-14T18:01:27.545Z","submitted_at":"2020-01-14T18:01:27.545Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"mr_incompetent","url":"/mr_incompetent","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/MocsZSz46DMkf2Q9gdr3xw4w/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":39386,"url":"https://hackerone.com/kubernetes","handle":"kubernetes","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/039/386/486f4380e09776d05a912ca9f46be23f72fe8197_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/039/386/486f4380e09776d05a912ca9f46be23f72fe8197_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Kubernetes","twitter_handle":"kubernetesio","website":"https://kubernetes.io/","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":["CVE-2020-8551"],"singular_disclosure_disabled":false,"disclosed_at":"2020-10-31T10:26:46.443Z","bug_reporter_agreed_on_going_public_at":"2020-10-31T10:26:46.363Z","team_member_agreed_on_going_public_at":"2020-10-30T21:29:10.410Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Report Submission Form\n\n## Summary:\nMalicious clients can potentially DOS a kubelet by sending a high amount of specially crafted requests to the kubelet's HTTP server. \n\nFor each request the kubelet updates/sets 3 metrics:\n- [kubelet_http_requests_total (Counter)](https://github.com/kubernetes/kubernetes/blob/v1.17.0/pkg/kubelet/server/metrics/metrics.go#L33-L44)\n- [kubelet_http_requests_duration_seconds (Histogram with 7 buckets)](https://github.com/kubernetes/kubernetes/blob/v1.17.0/pkg/kubelet/server/metrics/metrics.go#L46-L56)\n- [kubelet_http_inflight_requests (Counter)](https://github.com/kubernetes/kubernetes/blob/v1.17.0/pkg/kubelet/server/metrics/metrics.go#L58-L66)\n\nEach metric has the label `path` which will contain the path of each request.\nIt does not matter if the request is authenticated or not - The metrics will be set/updated regardless.\nWith each unique path, the kubelet creates 16 new time series.\nBy sending a high amount of requests with random path values, the kubelet's memory usage will grow and eventually the kubelet will get OOM killed.\n\nIt's also possible that the kubelet evicts all workloads before being OOM killed (Which might be worse than an OOM kill) \n\nThe corresponding kubelet server code: https://github.com/kubernetes/kubernetes/blob/v1.17.0/pkg/kubelet/server/server.go#L859-L865\n\n## Kubernetes Version:\n- v1.17.0 kubeadm (tested)\n- v1.16.4 kubeadm (tested)\n- v1.15.7 kubeadm (tested)\n\n## Component Version:\nKubelet\n\n## Steps To Reproduce:\n```bash\nNODE_NAME=\"my-poor-node\"\nNODE_IP=\"192.168.1.100\"\n\n# Perform random requests from an unauthenticated client\ncurl --insecure https://${NODE_IP}:10250/foo\ncurl --insecure https://${NODE_IP}:10250/bar\ncurl --insecure https://${NODE_IP}:10250/baz\n\n# Run in a dedicated shell to be able to get the metrics\nkubectl proxy\n\n# Load metrics from node\n# For each path (foo, bar, baz) 16 time series got created\ncurl http://127.0.0.1:8001/api/v1/nodes/${NODE_NAME}/proxy/metrics 2\u003e\u00261 | grep 'kubelet_http_requests_total\\|kubelet_http_requests_duration_seconds\\|kubelet_http_inflight_requests'\n\n# Perform more random requests \u0026 see the output of the metrics endpoint to grow.\n```\n\n## Supporting Material/References:\n\nA gist with an additional go tool which spams the kubelet\nhttps://gist.github.com/mrIncompetent/c6cbe483298c36668374363baf52a35d\n\n## Impact\n\nKill the kubelet / Make the kubelet consume all resources so it starts to evict pods.","vulnerability_information_html":"\u003cp\u003eReport Submission Form\u003c/p\u003e\n\n\u003ch2 id=\"summary\"\u003eSummary:\u003c/h2\u003e\n\n\u003cp\u003eMalicious clients can potentially DOS a kubelet by sending a high amount of specially crafted requests to the kubelet\u0026#39;s HTTP server. \u003c/p\u003e\n\n\u003cp\u003eFor each request the kubelet updates/sets 3 metrics:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fkubernetes%2Fkubernetes%2Fblob%2Fv1.17.0%2Fpkg%2Fkubelet%2Fserver%2Fmetrics%2Fmetrics.go%23L33-L44\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ekubelet_http_requests_total (Counter)\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fkubernetes%2Fkubernetes%2Fblob%2Fv1.17.0%2Fpkg%2Fkubelet%2Fserver%2Fmetrics%2Fmetrics.go%23L46-L56\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ekubelet_http_requests_duration_seconds (Histogram with 7 buckets)\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fkubernetes%2Fkubernetes%2Fblob%2Fv1.17.0%2Fpkg%2Fkubelet%2Fserver%2Fmetrics%2Fmetrics.go%23L58-L66\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ekubelet_http_inflight_requests (Counter)\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eEach metric has the label \u003ccode\u003epath\u003c/code\u003e which will contain the path of each request.\u003cbr\u003e\nIt does not matter if the request is authenticated or not - The metrics will be set/updated regardless.\u003cbr\u003e\nWith each unique path, the kubelet creates 16 new time series.\u003cbr\u003e\nBy sending a high amount of requests with random path values, the kubelet\u0026#39;s memory usage will grow and eventually the kubelet will get OOM killed.\u003c/p\u003e\n\n\u003cp\u003eIt\u0026#39;s also possible that the kubelet evicts all workloads before being OOM killed (Which might be worse than an OOM kill) \u003c/p\u003e\n\n\u003cp\u003eThe corresponding kubelet server code: \u003ca title=\"https://github.com/kubernetes/kubernetes/blob/v1.17.0/pkg/kubelet/server/server.go#L859-L865\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fkubernetes%2Fkubernetes%2Fblob%2Fv1.17.0%2Fpkg%2Fkubelet%2Fserver%2Fserver.go%23L859-L865\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/kubernetes/kubernetes/blob/v1.17.0/pkg/kubelet/server/server.go#L859-L865\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2 id=\"kubernetes-version\"\u003eKubernetes Version:\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003ev1.17.0 kubeadm (tested)\u003c/li\u003e\n\u003cli\u003ev1.16.4 kubeadm (tested)\u003c/li\u003e\n\u003cli\u003ev1.15.7 kubeadm (tested)\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"component-version\"\u003eComponent Version:\u003c/h2\u003e\n\n\u003cp\u003eKubelet\u003c/p\u003e\n\n\u003ch2 id=\"steps-to-reproduce\"\u003eSteps To Reproduce:\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight shell\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003eNODE_NAME\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;my-poor-node\u0026quot;\u003c/span\u003e\n\u003cspan class=\"nv\"\u003eNODE_IP\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;192.168.1.100\u0026quot;\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e# Perform random requests from an unauthenticated client\u003c/span\u003e\ncurl \u003cspan class=\"nt\"\u003e--insecure\u003c/span\u003e https://\u003cspan class=\"k\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eNODE_IP\u003c/span\u003e\u003cspan class=\"k\"\u003e}\u003c/span\u003e:10250/foo\ncurl \u003cspan class=\"nt\"\u003e--insecure\u003c/span\u003e https://\u003cspan class=\"k\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eNODE_IP\u003c/span\u003e\u003cspan class=\"k\"\u003e}\u003c/span\u003e:10250/bar\ncurl \u003cspan class=\"nt\"\u003e--insecure\u003c/span\u003e https://\u003cspan class=\"k\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eNODE_IP\u003c/span\u003e\u003cspan class=\"k\"\u003e}\u003c/span\u003e:10250/baz\n\n\u003cspan class=\"c\"\u003e# Run in a dedicated shell to be able to get the metrics\u003c/span\u003e\nkubectl proxy\n\n\u003cspan class=\"c\"\u003e# Load metrics from node\u003c/span\u003e\n\u003cspan class=\"c\"\u003e# For each path (foo, bar, baz) 16 time series got created\u003c/span\u003e\ncurl http://127.0.0.1:8001/api/v1/nodes/\u003cspan class=\"k\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eNODE_NAME\u003c/span\u003e\u003cspan class=\"k\"\u003e}\u003c/span\u003e/proxy/metrics 2\u0026gt;\u0026amp;1 | \u003cspan class=\"nb\"\u003egrep\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;kubelet_http_requests_total\\|kubelet_http_requests_duration_seconds\\|kubelet_http_inflight_requests\u0026#39;\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e# Perform more random requests \u0026amp; see the output of the metrics endpoint to grow.\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"supporting-material-references\"\u003eSupporting Material/References:\u003c/h2\u003e\n\n\u003cp\u003eA gist with an additional go tool which spams the kubelet\u003cbr\u003e\n\u003ca title=\"https://gist.github.com/mrIncompetent/c6cbe483298c36668374363baf52a35d\" href=\"/redirect?url=https%3A%2F%2Fgist.github.com%2FmrIncompetent%2Fc6cbe483298c36668374363baf52a35d\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://gist.github.com/mrIncompetent/c6cbe483298c36668374363baf52a35d\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eKill the kubelet / Make the kubelet consume all resources so it starts to evict pods.\u003c/p\u003e\n","bounty_amount":"1000.0","formatted_bounty":"$1,000","weakness":{"id":48,"name":"Denial of Service"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2020-11-29T21:29:10.543Z","allow_singular_disclosure_after":-2539259.594872592,"singular_disclosure_allowed":true,"vote_count":9,"voters":["mygf","exploit_db","sa1tama0","m0ti0nl3ss_","kevin163com","hexachroma","karca","yrobla","trizoo"],"severity":{"rating":"medium","score":5.0,"author_type":"Team","metrics":{"attack_vector":"adjacent","attack_complexity":"low","privileges_required":"none","user_interaction":"none","scope":"unchanged","confidentiality":"none","integrity":"none","availability":"low"}},"structured_scope":{"databaseId":32459,"asset_type":"SOURCE_CODE","asset_identifier":"https://github.com/kubernetes/kubernetes","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":6770433,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2020-01-14T18:36:00.815Z","updated_at":"2020-01-14T18:36:00.815Z","actor":{"username":"tallclair","cleared":false,"url":"/tallclair","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/418/594/6bbb78252759e1d1c1d67be48b7d7470926730de_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"kubernetes","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6955147,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","markdown_message":"","automated_response":false,"created_at":"2020-02-04T00:11:16.574Z","updated_at":"2020-02-04T00:11:16.574Z","additional_data":{"old_severity":null,"new_severity":"Medium (5.0)","old_severity_id":null,"new_severity_id":624384},"actor":{"username":"tallclair","cleared":false,"url":"/tallclair","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/418/594/6bbb78252759e1d1c1d67be48b7d7470926730de_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"kubernetes","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6955349,"is_internal":false,"editable":false,"type":"Activities::CveIdAdded","message":"","markdown_message":"","automated_response":false,"created_at":"2020-02-04T01:44:10.555Z","updated_at":"2020-02-04T01:44:10.555Z","cve_ids":["CVE-2020-8551"],"actor":{"username":"tallclair","cleared":false,"url":"/tallclair","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/418/594/6bbb78252759e1d1c1d67be48b7d7470926730de_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"kubernetes","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6955353,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2020-02-04T01:45:53.070Z","updated_at":"2020-02-04T01:45:53.070Z","actor":{"url":"/kubernetes","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/039/386/486f4380e09776d05a912ca9f46be23f72fe8197_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Kubernetes"}},"bounty_amount":"1000.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"kubernetes","collaborator":{"username":"mr_incompetent","url":"/mr_incompetent"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6964857,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2020-02-05T00:41:55.319Z","updated_at":"2020-02-05T00:41:55.319Z","actor":{"username":"tallclair","cleared":false,"url":"/tallclair","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/418/594/6bbb78252759e1d1c1d67be48b7d7470926730de_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"kubernetes","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7577189,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thanks for your submission!","markdown_message":"\u003cp\u003eThanks for your submission!\u003c/p\u003e\n","automated_response":false,"created_at":"2020-04-07T19:48:30.745Z","updated_at":"2020-04-07T19:48:30.745Z","actor":{"username":"jk1joel","cleared":false,"url":"/jk1joel","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"mr_incompetent","url":"/mr_incompetent"},"genius_execution_id":null,"team_handle":"kubernetes","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9688173,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-10-30T21:29:10.446Z","updated_at":"2020-10-30T21:29:10.446Z","first_to_agree":true,"actor":{"username":"tallclair","cleared":false,"url":"/tallclair","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/418/594/6bbb78252759e1d1c1d67be48b7d7470926730de_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"kubernetes","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9690645,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-10-31T10:26:46.389Z","updated_at":"2020-10-31T10:26:46.389Z","actor":{"username":"mr_incompetent","cleared":false,"url":"/mr_incompetent","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/MocsZSz46DMkf2Q9gdr3xw4w/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"kubernetes","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9690646,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-10-31T10:26:46.708Z","updated_at":"2020-10-31T10:26:46.708Z","actor":{"username":"mr_incompetent","cleared":false,"url":"/mr_incompetent","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/MocsZSz46DMkf2Q9gdr3xw4w/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"kubernetes","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}