{"id":109959,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xMDk5NTk=","url":"https://hackerone.com/reports/109959","title":"Extended policy checks are buggy","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2016-01-11T12:02:19.183Z","submitted_at":"2016-01-11T12:02:19.183Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"fnqgpc","url":"/fnqgpc","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":18,"url":"https://hackerone.com/phabricator","handle":"phabricator","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Phabricator","twitter_handle":"phabricator","website":"http://phacility.com/phabricator/","about":"Phabricator is a collection of open source web applications that help software companies build better software."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2016-01-11T15:10:48.719Z","bug_reporter_agreed_on_going_public_at":"2016-01-11T15:10:48.626Z","team_member_agreed_on_going_public_at":"2016-01-11T15:08:47.541Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Mongoose. This issue is in the class PhabricatorPolicyFilter, lines 324, 338 and 339. The code refers to the index $key (a leftover from a previous foreach loop) where it should refer to $extended_key.\n\nThis will lead to all policy checks being skipped after $extended_objects[$key] is filtered out. I'm not sure if this has any consequences in practice, since the extended policy interface seems to have a limited use. Maybe it would be more serious having subprojects?\n\nI can imagine a risk for the differential revisions: if any of the repositories failed to load (no idea if that can happen), the bugs in lines 338 and 339 would filter out the revision at $extended_objects[$key], and all the other revisions would then skip the checks.","vulnerability_information_html":"\u003cp\u003eMongoose. This issue is in the class PhabricatorPolicyFilter, lines 324, 338 and 339. The code refers to the index $key (a leftover from a previous foreach loop) where it should refer to $extended_key.\u003c/p\u003e\n\n\u003cp\u003eThis will lead to all policy checks being skipped after $extended_objects[$key] is filtered out. I\u0026#39;m not sure if this has any consequences in practice, since the extended policy interface seems to have a limited use. Maybe it would be more serious having subprojects?\u003c/p\u003e\n\n\u003cp\u003eI can imagine a risk for the differential revisions: if any of the repositories failed to load (no idea if that can happen), the bugs in lines 338 and 339 would filter out the revision at $extended_objects[$key], and all the other revisions would then skip the checks.\u003c/p\u003e\n","bounty_amount":"300.0","formatted_bounty":"$300","original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2016-02-10T15:08:47.612Z","allow_singular_disclosure_after":-154098436.4696265,"singular_disclosure_allowed":true,"vote_count":0,"voters":[],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":752494,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks, looking at this now.","markdown_message":"\u003cp\u003eThanks, looking at this now.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-11T12:21:55.898Z","updated_at":"2016-01-11T12:21:55.898Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":752595,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I was able to sneak something through the extended policy checks by carefully crafting an input list with a mixture of capability checks. Fix out for review:\n\nhttps://secure.phabricator.com/D14993\n\nBecause `$key` is *usually* the last object examined (since it was the last index in the earlier loop), this bug almost always just causes us to just do more work than we need to (at least, in theory) rather than causing policy violations. However, by mixing capability groups in the input list, I can force `$key` to be examined sooner (as part of an earlier capability group) and sneak later objects through the filter.\n\nI believe this has no security impact in the application today: as far as I know, we do not perform any checks which mix capability tests, and I believe we don't even perform any meaningful checks on more than one object with a single policy extension today. This case (checking just one object) isn't impacted since `$key` and `$extended_key` will always be the same.\n\nThat said, I agree that it is very likely that future changes (like subprojects) would have hit this in a way that created a real security issue. It's possible that I would have caught it before then, but I think I'm giving myself too much credit to suggest that it was anything short of *nearly inevitable* that this would eventually become an issue with material impact.","markdown_message":"\u003cp\u003eI was able to sneak something through the extended policy checks by carefully crafting an input list with a mixture of capability checks. Fix out for review:\u003c/p\u003e\n\n\u003cp\u003e\u003ca title=\"https://secure.phabricator.com/D14993\" href=\"/redirect?url=https%3A%2F%2Fsecure.phabricator.com%2FD14993\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://secure.phabricator.com/D14993\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eBecause \u003ccode\u003e$key\u003c/code\u003e is \u003cem\u003eusually\u003c/em\u003e the last object examined (since it was the last index in the earlier loop), this bug almost always just causes us to just do more work than we need to (at least, in theory) rather than causing policy violations. However, by mixing capability groups in the input list, I can force \u003ccode\u003e$key\u003c/code\u003e to be examined sooner (as part of an earlier capability group) and sneak later objects through the filter.\u003c/p\u003e\n\n\u003cp\u003eI believe this has no security impact in the application today: as far as I know, we do not perform any checks which mix capability tests, and I believe we don\u0026#39;t even perform any meaningful checks on more than one object with a single policy extension today. This case (checking just one object) isn\u0026#39;t impacted since \u003ccode\u003e$key\u003c/code\u003e and \u003ccode\u003e$extended_key\u003c/code\u003e will always be the same.\u003c/p\u003e\n\n\u003cp\u003eThat said, I agree that it is very likely that future changes (like subprojects) would have hit this in a way that created a real security issue. It\u0026#39;s possible that I would have caught it before then, but I think I\u0026#39;m giving myself too much credit to suggest that it was anything short of \u003cem\u003enearly inevitable\u003c/em\u003e that this would eventually become an issue with material impact.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-11T13:02:55.648Z","updated_at":"2016-01-11T13:02:55.648Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":752776,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for your attention. The patch looks fine.","markdown_message":"\u003cp\u003eThank you for your attention. The patch looks fine.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-11T14:26:19.220Z","updated_at":"2016-01-11T14:26:19.220Z","actor":{"username":"fnqgpc","cleared":false,"url":"/fnqgpc","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":752827,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"This is now available in `master`:\n\nhttps://secure.phabricator.com/rPf59ebf4c09598e5f02657a4037c822b64a306646","markdown_message":"\u003cp\u003eThis is now available in \u003ccode\u003emaster\u003c/code\u003e:\u003c/p\u003e\n\n\u003cp\u003e\u003ca title=\"https://secure.phabricator.com/rPf59ebf4c09598e5f02657a4037c822b64a306646\" href=\"/redirect?url=https%3A%2F%2Fsecure.phabricator.com%2FrPf59ebf4c09598e5f02657a4037c822b64a306646\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://secure.phabricator.com/rPf59ebf4c09598e5f02657a4037c822b64a306646\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-11T15:05:14.042Z","updated_at":"2016-01-11T15:05:14.042Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"fnqgpc","url":"/fnqgpc"},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":752832,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Although issues normally must normally be exploitable to qualify for an award, I'm awarding this one because it is an unusual issue that was likely to have had an impact eventually.","markdown_message":"\u003cp\u003eAlthough issues normally must normally be exploitable to qualify for an award, I\u0026#39;m awarding this one because it is an unusual issue that was likely to have had an impact eventually.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-11T15:07:47.181Z","updated_at":"2016-01-11T15:07:47.181Z","actor":{"url":"/phabricator","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Phabricator"}},"bounty_amount":"300.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"phabricator","collaborator":{"username":"fnqgpc","url":"/fnqgpc"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":752833,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Details on this issue are publicly available in the commit log and it has no apparent impact in practice, so it can be disclosed at any time.","markdown_message":"\u003cp\u003eDetails on this issue are publicly available in the commit log and it has no apparent impact in practice, so it can be disclosed at any time.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-11T15:08:47.560Z","updated_at":"2016-01-11T15:08:47.560Z","first_to_agree":true,"actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":752834,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks again! Let us know if you catch anything else.","markdown_message":"\u003cp\u003eThanks again! Let us know if you catch anything else.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-11T15:09:09.186Z","updated_at":"2016-01-11T15:09:09.186Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":752835,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Thanks!","markdown_message":"\u003cp\u003eThanks!\u003c/p\u003e\n","automated_response":false,"created_at":"2016-01-11T15:10:48.653Z","updated_at":"2016-01-11T15:10:48.653Z","actor":{"username":"fnqgpc","cleared":false,"url":"/fnqgpc","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":752836,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2016-01-11T15:10:48.739Z","updated_at":"2016-01-11T15:10:48.739Z","actor":{"username":"fnqgpc","cleared":false,"url":"/fnqgpc","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}