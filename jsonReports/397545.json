{"id":397545,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8zOTc1NDU=","url":"https://hackerone.com/reports/397545","title":"Malformed .BMP file in Counter-Strike 1.6 may cause shellcode injection","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2018-08-21T06:33:12.777Z","submitted_at":"2018-08-21T06:33:12.777Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"kohtep2010","url":"/kohtep2010","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/ZLr6Jvt7ixmtsP1vjXVwpdye/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":23363,"url":"https://hackerone.com/valve","handle":"valve","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/023/363/c78d46a7d0ea39e3a15a7c19c1a48634f2571eb9_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/023/363/c78d46a7d0ea39e3a15a7c19c1a48634f2571eb9_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Valve","twitter_handle":"","website":"https://www.valvesoftware.com","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2020-02-27T18:43:10.663Z","bug_reporter_agreed_on_going_public_at":"2019-03-23T07:10:55.347Z","team_member_agreed_on_going_public_at":"2020-02-27T18:43:10.579Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"With the vulnerability of the GoldSource Engine, the server is able to perform remote code execution on the client, overwriting the stack when reading the BMP file. The problem is in the LoadBMP8 function, which is executed when the player connects to the server, by loading the \"overviews\\%MAPNAME%.bmp\" file. If we send a badly formed file to this function, then we will be able to rewrite the stack of the function by setting the own code in the stack and passing program control to it.\n\nI've wrote a program that compiles file like that. The shellcode, which runs on the stack, starts the \"calc.exe\" process with the WinExec function.\n\nFor the client to execute this file, the server must send this file to the client. The server can do this if map that is not present on the client is launched. The server must load a map with random name, for example, \"definitely_missing_client_map.bsp\". In this case, the name of the BMP file must also be \"definitely_missing_client_map.bmp\" and it must be in \"overviews\" folder. You also must create the \"overviews\\definitely_missing_client_map.txt\" file, which is overview description. The nonstandard name of the map prompts the client to download the missing files (bsp, bmp and txt). Upon completion, when the client is able to see the map, the BMP file will be loaded and the binary code from BMP file will be executed on the stack.\n\nI've attached the source code of \"compiler\" to the message. You can find more detailed instructions in the code comments. You need to compile this project in \"Release\" configuration and then start this project. After that, malformed \"de_dust2.bmp\" file will be produced.\n\n## Impact\n\nAn attacker can execute remote code on the client's machine.","vulnerability_information_html":"\u003cp\u003eWith the vulnerability of the GoldSource Engine, the server is able to perform remote code execution on the client, overwriting the stack when reading the BMP file. The problem is in the LoadBMP8 function, which is executed when the player connects to the server, by loading the \u0026quot;overviews\\%MAPNAME%.bmp\u0026quot; file. If we send a badly formed file to this function, then we will be able to rewrite the stack of the function by setting the own code in the stack and passing program control to it.\u003c/p\u003e\n\n\u003cp\u003eI\u0026#39;ve wrote a program that compiles file like that. The shellcode, which runs on the stack, starts the \u0026quot;calc.exe\u0026quot; process with the WinExec function.\u003c/p\u003e\n\n\u003cp\u003eFor the client to execute this file, the server must send this file to the client. The server can do this if map that is not present on the client is launched. The server must load a map with random name, for example, \u0026quot;definitely_missing_client_map.bsp\u0026quot;. In this case, the name of the BMP file must also be \u0026quot;definitely_missing_client_map.bmp\u0026quot; and it must be in \u0026quot;overviews\u0026quot; folder. You also must create the \u0026quot;overviews\\definitely_missing_client_map.txt\u0026quot; file, which is overview description. The nonstandard name of the map prompts the client to download the missing files (bsp, bmp and txt). Upon completion, when the client is able to see the map, the BMP file will be loaded and the binary code from BMP file will be executed on the stack.\u003c/p\u003e\n\n\u003cp\u003eI\u0026#39;ve attached the source code of \u0026quot;compiler\u0026quot; to the message. You can find more detailed instructions in the code comments. You need to compile this project in \u0026quot;Release\u0026quot; configuration and then start this project. After that, malformed \u0026quot;de_dust2.bmp\u0026quot; file will be produced.\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eAn attacker can execute remote code on the client\u0026#39;s machine.\u003c/p\u003e\n","bounty_amount":"2000.0","formatted_bounty":"$2,000","weakness":{"id":3,"name":"Classic Buffer Overflow"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":335941,"file_name":"HL1-BmpSploit.zip","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/335/941/c10d065018feaa13fba5bd38cdc1ca222006ea04/HL1-BmpSploit.zip?response-content-disposition=attachment%3B%20filename%3D%22HL1-BmpSploit.zip%22%3B%20filename%2A%3DUTF-8%27%27HL1-BmpSploit.zip\u0026response-content-type=application%2Fzip\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ2QYQVMVU%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T055058Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJj%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQC3%2FsiyUovDMMRPwfmXSSMky3lQNd33wh1MrBmbWJC8HQIhAOSX92QvRr3Mllw0zHuI%2FUP9sF%2FDNWps6wYRKsfiEgbIKrQDCFEQARoMMDEzNjE5Mjc0ODQ5IgyayWzpgkc86ZJmRDMqkQNBHcx9TN8Qq3EOCDOHxZVSoo84ar5w931vjsPd%2BYQ3i%2Bx9eqo2ZtgVN1Jmoq8zs6hsL0mQ%2F20wJFKZixbR7HjPc8i4juMIQlnM8TPeS1SJgwLfpmO12sSyoWk3fn%2BevsZ74MOTjvipPhl7l4ysY7gvLSMb%2F%2FbZmlTb%2BRp9ew5nOoiXNI8oQZMkhOihsn1Q92Wzljmz7rLHf0SWhEVdMvtgNqYyJz%2FGfq5QgT7Ex9q0a8OeRuv2WivmkS0ItLzdLr4AZp8G9M8TS3hFKV7sBxW2jeQmBIgcwsfh6l5Kj2o1EeFByIjeAOeU8CtQvJjf1AYwsXig5iiWG1PDqO74ZMYim9a1AVJfIRMHELC9hgi%2BNRVkqsPBurY%2BhFIchB3A6MS0Fup9FcpwDiSPwMu92UsjrPwWcQSy7wF8W7uVHoWmYKo2Jie7uXX2WbkNvQn%2BVJkd%2ByJui6LuEsoOf46y4OUr9by1ZfOQEMvwaiEcDXAKt7msARgVRUaigRb1ZF8hYom2qPLbi%2BKKBIE%2FJ21mcK79gjDj36n%2FBTrqAbyLw6dOEWEdRc%2BQghV%2BGs0mxf6YcBEQ0xaDSLE5OQXQJX90aqhTYFzi15%2BtXM5rF%2FkTq%2FNonb0szkAGwKve9Fh2LyQ%2F7WBSh9XEjPVQ%2B94j5PqLLrVbqfO7RsbRpSefivNmepJrQv52y49fC1tTXoR893JVWe1bnDoXfPRtykz2CLE1WIUrJm7g0MwlQ4%2FYhjLC7FTb6WIejkEPZ0nJdYi90iaGNGoKuvlj2kpGsqCTPjBW8Vhu9R9qXAbPR%2Bj24hpsPhyGFzBe%2F1%2BqYcze%2B4BoEFO8hgcUAqm5L0zeqYMYIdqkfREAB0cTeQ%3D%3D\u0026X-Amz-Signature=90fea4b4d84531c295d2d80ded1f5cd0082341505b5f07e593f7d0ffd5fee83e","file_size":9421,"type":"application/zip"}],"allow_singular_disclosure_at":null,"vote_count":316,"voters":["fygonzalo","njbooher","kekkegenkai","overjt","keshavkejriwal","putsi","sultancad","mvc","a_d_a_m","securitychops","and 306 more..."],"severity":{"rating":"high","score":8.8,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"none","user_interaction":"required","scope":"unchanged","confidentiality":"high","integrity":"high","availability":"high"}},"structured_scope":{"databaseId":1289,"asset_type":"DOWNLOADABLE_EXECUTABLES","asset_identifier":"hl.exe","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":3226933,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2018-08-21T18:08:47.049Z","updated_at":"2018-08-21T18:08:47.049Z","actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3228195,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @kohtep, thanks for the submission, this is definitely a valid RCE vector.\n\nWere you able to force the client to download the overview files without specifying them in a RES file for the map? I was able to trigger to automatic download and loading of the bitmap but not with following your steps exactly. If I only create a nonexistant BSP file, BMP and overview description file only the BSP downloads on connection to the server. It's only once I create a RES file to accompany the BSP file and reference the BMP and overview description that those download as well. Not that this is a problem with regards to issue, just something additional I found while reproducing the bug.","markdown_message":"\u003cp\u003eHi \u003ca href=\"/kohtep\"\u003e@kohtep\u003c/a\u003e, thanks for the submission, this is definitely a valid RCE vector.\u003c/p\u003e\n\n\u003cp\u003eWere you able to force the client to download the overview files without specifying them in a RES file for the map? I was able to trigger to automatic download and loading of the bitmap but not with following your steps exactly. If I only create a nonexistant BSP file, BMP and overview description file only the BSP downloads on connection to the server. It\u0026#39;s only once I create a RES file to accompany the BSP file and reference the BMP and overview description that those download as well. Not that this is a problem with regards to issue, just something additional I found while reproducing the bug.\u003c/p\u003e\n","automated_response":false,"created_at":"2018-08-21T22:20:51.802Z","updated_at":"2018-08-21T22:20:51.802Z","actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3228877,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hello! I did not use RES files to force the client to download the rest of the files other than BSP (if I understood you correctly). The way I described in the message worked for me, and it seemed to me the simplest. I think that you can also try to upload files to client using engine functions Netchan_CreateFileFragments/Netchan_CreateFileFragmentsFromBuffer, which allow you to transfer files in both directions.","markdown_message":"\u003cp\u003eHello! I did not use RES files to force the client to download the rest of the files other than BSP (if I understood you correctly). The way I described in the message worked for me, and it seemed to me the simplest. I think that you can also try to upload files to client using engine functions Netchan_CreateFileFragments/Netchan_CreateFileFragmentsFromBuffer, which allow you to transfer files in both directions.\u003c/p\u003e\n","automated_response":false,"created_at":"2018-08-22T04:38:47.435Z","updated_at":"2018-08-22T04:39:44.245Z","actor":{"username":"kohtep2010","cleared":false,"url":"/kohtep2010","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ZLr6Jvt7ixmtsP1vjXVwpdye/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3242731,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2018-08-25T00:03:28.076Z","updated_at":"2018-08-25T00:03:28.076Z","actor":{"url":"/valve","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/023/363/c78d46a7d0ea39e3a15a7c19c1a48634f2571eb9_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Valve"}},"bounty_amount":"2000.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"valve","collaborator":{"username":"kohtep2010","url":"/kohtep2010"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3242732,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","markdown_message":"","automated_response":false,"created_at":"2018-08-25T00:03:38.237Z","updated_at":"2018-08-25T00:03:38.237Z","actor":{"username":"jonp","cleared":false,"url":"/jonp","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/203/578/6de63d2fdd8c70309cf4326359d3e816a7633b5c_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"kohtep2010","url":"/kohtep2010"},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4376674,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Hi! Looks like fix for problem was implemented in recent engine update, so I would like to request report disclosure.","markdown_message":"\u003cp\u003eHi! Looks like fix for problem was implemented in recent engine update, so I would like to request report disclosure.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-03-23T07:10:55.385Z","updated_at":"2019-03-23T07:10:55.385Z","first_to_agree":true,"actor":{"username":"kohtep2010","cleared":false,"url":"/kohtep2010","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ZLr6Jvt7ixmtsP1vjXVwpdye/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7168234,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-02-27T18:43:10.598Z","updated_at":"2020-02-27T18:43:10.598Z","actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7168235,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-02-27T18:43:10.676Z","updated_at":"2020-02-27T18:43:10.676Z","actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}