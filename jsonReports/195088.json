{"id":195088,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xOTUwODg=","url":"https://hackerone.com/reports/195088","title":"Every user can delete public deploy keys","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2017-01-01T18:10:30.371Z","submitted_at":"2017-01-01T18:10:30.371Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"jobert","url":"/jobert","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":264,"url":"https://hackerone.com/gitlab","handle":"gitlab","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"GitLab","twitter_handle":"gitlab","website":"https://about.gitlab.com","about":"A single application for the entire software development lifecycle."}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2017-01-23T23:09:52.996Z","bug_reporter_agreed_on_going_public_at":"2017-01-23T20:47:24.215Z","team_member_agreed_on_going_public_at":"2017-01-23T23:09:52.947Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"# Vulnerability details\nA GitLab instance can have public deploy keys that project admins can use for their project. An attacker can delete these public keys used by other users to deploy code.\n\n# Impact\nDeleting these shared deploy keys may stop users to deploy their code.\n\n# Proof of concept\nMake sure the GitLab instance has a public deploy key. Lets assume it has ID 1. Now sign in as a normal user and follow the steps below.\n\n1. Create a new project called `test`\n2. Go to http://gitlab-instance/user/test/deploy_keys\n3. Go to the `Public deploy keys available to any project` section and click the `Enable` button for the public deploy key\n4. Create an access token for the API for your own account\n5. Request `/api/v3/projects`, get the ID number for the project `test`\n6. Request `/api/v3/projects/:project_id/deploy_keys`, you'll see the public deploy key\n7. Send a `DELETE` request to `/api/v3/projects/:project_id/deploy_keys/:id - this will delete the public (shared) deploy key, not the relationship between the project and the key. Below is a copy of the request and response.\n\n**Request**\n```\ncurl -X DELETE -H \"Private-Token: AAAA\" http://gitlab-instance/api/v3/projects/1/deploy_keys/1\n```\n\n\n**Response**\n```\n{\"id\":1,\"user_id\":null,\"created_at\":\"\u003cremoved\u003e\",\"updated_at\":\"\u003cremoved\u003e\",\"key\":\"\u003ckey\u003e\",\"title\":\"\u003ctitle\u003e\",\"fingerprint\":\"72:bb:e9:cc:04:dc:64:b9:a3:e7:c2:26:8f:f2:ed:df\",\"public\":true}\n```\n\nThe root cause of this problem lies in the following lines of code:\n\n**lib/api/deploy_keys.rb**\n```ruby\ndelete \":id/#{path}/:key_id\" do\n  key = user_project.deploy_keys.find(params[:key_id])\n  key.destroy\nend\n```\n\nThe `destroy` method will be called on the shared deploy key instead of on the relationship.\n\n# Remediation advice\nInstead of removing the entire object, remove the relationship instead when it's a public deploy key.","vulnerability_information_html":"\u003ch1 id=\"vulnerability-details\"\u003eVulnerability details\u003c/h1\u003e\n\n\u003cp\u003eA GitLab instance can have public deploy keys that project admins can use for their project. An attacker can delete these public keys used by other users to deploy code.\u003c/p\u003e\n\n\u003ch1 id=\"impact\"\u003eImpact\u003c/h1\u003e\n\n\u003cp\u003eDeleting these shared deploy keys may stop users to deploy their code.\u003c/p\u003e\n\n\u003ch1 id=\"proof-of-concept\"\u003eProof of concept\u003c/h1\u003e\n\n\u003cp\u003eMake sure the GitLab instance has a public deploy key. Lets assume it has ID 1. Now sign in as a normal user and follow the steps below.\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003eCreate a new project called \u003ccode\u003etest\u003c/code\u003e\n\u003c/li\u003e\n\u003cli\u003eGo to \u003ca title=\"http://gitlab-instance/user/test/deploy_keys\" href=\"/redirect?url=http%3A%2F%2Fgitlab-instance%2Fuser%2Ftest%2Fdeploy_keys\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttp://gitlab-instance/user/test/deploy_keys\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003eGo to the \u003ccode\u003ePublic deploy keys available to any project\u003c/code\u003e section and click the \u003ccode\u003eEnable\u003c/code\u003e button for the public deploy key\u003c/li\u003e\n\u003cli\u003eCreate an access token for the API for your own account\u003c/li\u003e\n\u003cli\u003eRequest \u003ccode\u003e/api/v3/projects\u003c/code\u003e, get the ID number for the project \u003ccode\u003etest\u003c/code\u003e\n\u003c/li\u003e\n\u003cli\u003eRequest \u003ccode\u003e/api/v3/projects/:project_id/deploy_keys\u003c/code\u003e, you\u0026#39;ll see the public deploy key\u003c/li\u003e\n\u003cli\u003eSend a \u003ccode\u003eDELETE\u003c/code\u003e request to `/api/v3/projects/:project_id/deploy_keys/:id - this will delete the public (shared) deploy key, not the relationship between the project and the key. Below is a copy of the request and response.\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e\u003cstrong\u003eRequest\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003ecurl -X DELETE -H \u0026quot;Private-Token: AAAA\u0026quot; http://gitlab-instance/api/v3/projects/1/deploy_keys/1\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003eResponse\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e{\u0026quot;id\u0026quot;:1,\u0026quot;user_id\u0026quot;:null,\u0026quot;created_at\u0026quot;:\u0026quot;\u0026lt;removed\u0026gt;\u0026quot;,\u0026quot;updated_at\u0026quot;:\u0026quot;\u0026lt;removed\u0026gt;\u0026quot;,\u0026quot;key\u0026quot;:\u0026quot;\u0026lt;key\u0026gt;\u0026quot;,\u0026quot;title\u0026quot;:\u0026quot;\u0026lt;title\u0026gt;\u0026quot;,\u0026quot;fingerprint\u0026quot;:\u0026quot;72:bb:e9:cc:04:dc:64:b9:a3:e7:c2:26:8f:f2:ed:df\u0026quot;,\u0026quot;public\u0026quot;:true}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe root cause of this problem lies in the following lines of code:\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003elib/api/deploy_keys.rb\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight ruby\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003edelete\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;:id/\u003c/span\u003e\u003cspan class=\"si\"\u003e#{\u003c/span\u003e\u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e/:key_id\u0026quot;\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e\n  \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003euser_project\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003edeploy_keys\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003efind\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eparams\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"ss\"\u003e:key_id\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n  \u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003edestroy\u003c/span\u003e\n\u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe \u003ccode\u003edestroy\u003c/code\u003e method will be called on the shared deploy key instead of on the relationship.\u003c/p\u003e\n\n\u003ch1 id=\"remediation-advice\"\u003eRemediation advice\u003c/h1\u003e\n\n\u003cp\u003eInstead of removing the entire object, remove the relationship instead when it\u0026#39;s a public deploy key.\u003c/p\u003e\n","weakness":{"id":75,"name":"Privilege Escalation"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-02-22T20:47:24.312Z","allow_singular_disclosure_after":-121421028.41521819,"singular_disclosure_allowed":true,"vote_count":12,"voters":["derision","bogdantcaciuc","ayoubfathi_","mpz","eveeez","kieran","japz","spetr0x","cryptosector","arice","and 2 more..."],"severity":{"rating":"medium","score":6.5,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"low","user_interaction":"none","scope":"unchanged","confidentiality":"none","integrity":"none","availability":"high"}},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1393768,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thanks Jobert!\n\nI've opened confidential issue https://gitlab.com/gitlab-org/gitlab-ce/issues/26243 and will keep you updated on our progress.","markdown_message":"\u003cp\u003eThanks Jobert!\u003c/p\u003e\n\n\u003cp\u003eI\u0026#39;ve opened confidential issue \u003ca title=\"https://gitlab.com/gitlab-org/gitlab-ce/issues/26243\" href=\"/redirect?url=https%3A%2F%2Fgitlab.com%2Fgitlab-org%2Fgitlab-ce%2Fissues%2F26243\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://gitlab.com/gitlab-org/gitlab-ce/issues/26243\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e and will keep you updated on our progress.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-01-01T18:45:54.238Z","updated_at":"2017-01-01T18:45:54.238Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1437145,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"A patch for this vulnerability is scheduled to go out in a security release tomorrow. I'll update the issue here when it does. Thanks for the report!","markdown_message":"\u003cp\u003eA patch for this vulnerability is scheduled to go out in a security release tomorrow. I\u0026#39;ll update the issue here when it does. Thanks for the report!\u003c/p\u003e\n","automated_response":false,"created_at":"2017-01-22T18:10:54.113Z","updated_at":"2017-01-22T18:10:54.113Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1439310,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"We've released a patch for this vulnerability today: https://about.gitlab.com/2017/01/23/gitlab-8-dot-16-dot-1-security-release/\n\nThanks again!","markdown_message":"\u003cp\u003eWe\u0026#39;ve released a patch for this vulnerability today: \u003ca title=\"https://about.gitlab.com/2017/01/23/gitlab-8-dot-16-dot-1-security-release/\" href=\"/redirect?url=https%3A%2F%2Fabout.gitlab.com%2F2017%2F01%2F23%2Fgitlab-8-dot-16-dot-1-security-release%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://about.gitlab.com/2017/01/23/gitlab-8-dot-16-dot-1-security-release/\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eThanks again!\u003c/p\u003e\n","automated_response":false,"created_at":"2017-01-23T20:45:01.808Z","updated_at":"2017-01-23T20:45:01.808Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"jobert","url":"/jobert"},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1439322,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-01-23T20:47:24.257Z","updated_at":"2017-01-23T20:47:24.257Z","first_to_agree":true,"actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1439697,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-01-23T23:09:52.969Z","updated_at":"2017-01-23T23:09:52.969Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1439698,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-01-23T23:09:53.011Z","updated_at":"2017-01-23T23:09:53.011Z","actor":{"username":"briann","cleared":false,"url":"/briann","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}