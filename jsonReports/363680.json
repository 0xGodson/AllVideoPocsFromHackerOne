{"id":363680,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8zNjM2ODA=","url":"https://hackerone.com/reports/363680","title":"Constant-time comparison is not always implemented; critical areas are vulnerable to key-timing attacks","state":"Closed","substate":"resolved","severity_rating":"critical","readable_substate":"Resolved","created_at":"2018-06-09T08:51:57.047Z","submitted_at":"2018-06-09T08:51:57.047Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"anonimal","url":"/anonimal","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/040/857/f23cc3be09a21e17bc43975987c10ba2b6427239_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":7731,"url":"https://hackerone.com/monero","handle":"monero","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/007/731/55634f7fcd917725c7a5771cc6e7c9b4d5fe0c22_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/007/731/55634f7fcd917725c7a5771cc6e7c9b4d5fe0c22_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":false,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Monero","twitter_handle":"monero","website":"https://getmonero.org","about":" Monero: the secure, private, untraceable cryptocurrency"}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2018-08-06T15:13:53.417Z","bug_reporter_agreed_on_going_public_at":"2018-07-27T10:55:40.203Z","team_member_agreed_on_going_public_at":"2018-08-06T15:13:53.306Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"In my most superficial of reviews, constant-time comparison appears to not be globally implemented (at a glance, only implemented within the ref10 implementation).\n\nWith that said, the following areas either appear to be vulnerable, or are potentially vulnerable, to key-timing attacks:\n\n1. Containers used for RingCT (in particular, the key struct) as deployed throughout RingCT\n2. The definition and implementations of `CRYPTO_MAKE_COMPARABLE`\n3. `equalKeys` in rctOps.cpp, whose comparison speed appears to be relative to its available hardware\n\nFor points 1 and 2, as a steadfast rule; do **NOT** use `memcmp` when comparing cryptographic secrets (or any cryptographic material for that matter). For point 3, be careful with conditional branches which can be optimized or subject to speculative execution. One possible fix for point 3 is to perform an XOR of all the bytes in both buffers, and then compare the result (see kovri below).\n\nAs the literature states, key timing vulnerabilities can range from somewhat-trivial to extremely-difficult to exploit. For this report, I cannot assess a difficulty. For an active attack, monero has a very simple yet friendly network layer which I *imagine* could make remote execution *somewhat* easier (depending on the context and application) but, I don't have PoC. Now, at the local level for, let's say, a malicious node that wants to forge X before sending to the next peer, the results could be easier to attain (again, no PoC).\n\nThis was only the most superficial of reviews - so please forgive any assumptions or inaccuracies on my part. If I had more time with this issue, I would love to look deeper in order to provide a more details and to assert a monero PoC. Unfortunately, I am too busy with kovri - but I hope that this report will at least raises awareness.\n\nMitigation:\n\n- Use a function which provides constant-time comparison. For example, [kovri has a crypto++ solution](https://github.com/monero-project/kovri/issues/895) at its disposal.\n\n## Impact\n\nAt first glance, a forged RingCT signature - but the extent of the problem could be possibly extended to other areas (to be determined).","vulnerability_information_html":"\u003cp\u003eIn my most superficial of reviews, constant-time comparison appears to not be globally implemented (at a glance, only implemented within the ref10 implementation).\u003c/p\u003e\n\n\u003cp\u003eWith that said, the following areas either appear to be vulnerable, or are potentially vulnerable, to key-timing attacks:\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003eContainers used for RingCT (in particular, the key struct) as deployed throughout RingCT\u003c/li\u003e\n\u003cli\u003eThe definition and implementations of \u003ccode\u003eCRYPTO_MAKE_COMPARABLE\u003c/code\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eequalKeys\u003c/code\u003e in rctOps.cpp, whose comparison speed appears to be relative to its available hardware\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eFor points 1 and 2, as a steadfast rule; do \u003cstrong\u003eNOT\u003c/strong\u003e use \u003ccode\u003ememcmp\u003c/code\u003e when comparing cryptographic secrets (or any cryptographic material for that matter). For point 3, be careful with conditional branches which can be optimized or subject to speculative execution. One possible fix for point 3 is to perform an XOR of all the bytes in both buffers, and then compare the result (see kovri below).\u003c/p\u003e\n\n\u003cp\u003eAs the literature states, key timing vulnerabilities can range from somewhat-trivial to extremely-difficult to exploit. For this report, I cannot assess a difficulty. For an active attack, monero has a very simple yet friendly network layer which I \u003cem\u003eimagine\u003c/em\u003e could make remote execution \u003cem\u003esomewhat\u003c/em\u003e easier (depending on the context and application) but, I don\u0026#39;t have PoC. Now, at the local level for, let\u0026#39;s say, a malicious node that wants to forge X before sending to the next peer, the results could be easier to attain (again, no PoC).\u003c/p\u003e\n\n\u003cp\u003eThis was only the most superficial of reviews - so please forgive any assumptions or inaccuracies on my part. If I had more time with this issue, I would love to look deeper in order to provide a more details and to assert a monero PoC. Unfortunately, I am too busy with kovri - but I hope that this report will at least raises awareness.\u003c/p\u003e\n\n\u003cp\u003eMitigation:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eUse a function which provides constant-time comparison. For example, \u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fmonero-project%2Fkovri%2Fissues%2F895\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ekovri has a crypto++ solution\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e at its disposal.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eAt first glance, a forged RingCT signature - but the extent of the problem could be possibly extended to other areas (to be determined).\u003c/p\u003e\n","weakness":{"id":39,"name":"Missing Required Cryptographic Step"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2018-08-26T10:55:40.318Z","allow_singular_disclosure_after":-73939703.38599013,"singular_disclosure_allowed":true,"vote_count":6,"voters":["mygf","apapedulimu","cryptographer","anomalroil","misspan","jrballi"],"severity":{"rating":"critical","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":2871540,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2018-06-11T22:10:39.429Z","updated_at":"2018-06-11T22:10:39.429Z","actor":{"username":"anonimal","cleared":false,"url":"/anonimal","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/040/857/f23cc3be09a21e17bc43975987c10ba2b6427239_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2900446,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"There's a patch in https://github.com/monero-project/monero/pull/3999, though it's a bit overeager maybe, I'm not sure checking all these types is really required. It might also have non negligible effect on performance. Additionally, performance tests don't show much effect in comparing equal or unequal-on-every-byte keys with memcmp.","markdown_message":"\u003cp\u003eThere\u0026#39;s a patch in \u003ca title=\"https://github.com/monero-project/monero/pull/3999\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fmonero-project%2Fmonero%2Fpull%2F3999\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/monero-project/monero/pull/3999\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e, though it\u0026#39;s a bit overeager maybe, I\u0026#39;m not sure checking all these types is really required. It might also have non negligible effect on performance. Additionally, performance tests don\u0026#39;t show much effect in comparing equal or unequal-on-every-byte keys with memcmp.\u003c/p\u003e\n","automated_response":false,"created_at":"2018-06-18T10:05:35.830Z","updated_at":"2018-06-18T10:05:35.830Z","actor":{"username":"moneromooo","cleared":false,"url":"/moneromooo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2926277,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"\u003eAdditionally, performance tests don't show much effect in comparing equal or unequal-on-every-byte keys with memcmp\n\nThe environment may need to be specialized, meaning something that wouldn't be detected with either the current performance tests or with the hardware that you are using with said tests. I don't know, TBD.\n\nEither way, thanks for patching.","markdown_message":"\u003cblockquote\u003e\n\u003cp\u003eAdditionally, performance tests don\u0026#39;t show much effect in comparing equal or unequal-on-every-byte keys with memcmp\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eThe environment may need to be specialized, meaning something that wouldn\u0026#39;t be detected with either the current performance tests or with the hardware that you are using with said tests. I don\u0026#39;t know, TBD.\u003c/p\u003e\n\n\u003cp\u003eEither way, thanks for patching.\u003c/p\u003e\n","automated_response":false,"created_at":"2018-06-23T23:54:06.258Z","updated_at":"2018-06-23T23:54:06.258Z","actor":{"username":"anonimal","cleared":false,"url":"/anonimal","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/040/857/f23cc3be09a21e17bc43975987c10ba2b6427239_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3105121,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"This has been resolved in https://github.com/monero-project/monero/pull/3999.\n\nConsidering my position, I'm opting out of receiving any bounty payout. May the bounty fund live long and prosper.","markdown_message":"\u003cp\u003eThis has been resolved in \u003ca title=\"https://github.com/monero-project/monero/pull/3999\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fmonero-project%2Fmonero%2Fpull%2F3999\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/monero-project/monero/pull/3999\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003eConsidering my position, I\u0026#39;m opting out of receiving any bounty payout. May the bounty fund live long and prosper.\u003c/p\u003e\n","automated_response":false,"created_at":"2018-07-27T10:55:27.658Z","updated_at":"2018-07-27T10:55:27.658Z","actor":{"username":"anonimal","cleared":false,"url":"/anonimal","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/040/857/f23cc3be09a21e17bc43975987c10ba2b6427239_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"anonimal","url":"/anonimal"},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3105122,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2018-07-27T10:55:40.247Z","updated_at":"2018-07-27T10:55:40.247Z","first_to_agree":true,"actor":{"username":"anonimal","cleared":false,"url":"/anonimal","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/040/857/f23cc3be09a21e17bc43975987c10ba2b6427239_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3151411,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Setting to disclosed as as requested.","markdown_message":"\u003cp\u003eSetting to disclosed as as requested.\u003c/p\u003e\n","automated_response":false,"created_at":"2018-08-06T15:13:53.334Z","updated_at":"2018-08-06T15:13:53.334Z","actor":{"username":"moneromooo","cleared":false,"url":"/moneromooo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3151412,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2018-08-06T15:13:53.445Z","updated_at":"2018-08-06T15:13:53.445Z","actor":{"username":"moneromooo","cleared":false,"url":"/moneromooo","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"monero","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}