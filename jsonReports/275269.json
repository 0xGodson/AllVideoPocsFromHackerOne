{"id":275269,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yNzUyNjk=","url":"https://hackerone.com/reports/275269","title":"Gem signature forgery","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2017-10-06T23:57:17.767Z","submitted_at":"2017-10-06T23:57:17.767Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"plover","url":"/plover","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":8212,"url":"https://hackerone.com/rubygems","handle":"rubygems","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/008/212/e65eca09896d23bc029c08d3147a79a48ec1ee2f_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/008/212/e65eca09896d23bc029c08d3147a79a48ec1ee2f_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"RubyGems","twitter_handle":"rubygems_status","website":"https://rubygems.org","about":"RubyGems.org is the Ruby communityâ€™s gem hosting service."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2018-08-03T20:23:47.955Z","bug_reporter_agreed_on_going_public_at":"2018-07-04T20:23:31.159Z","team_member_agreed_on_going_public_at":null,"comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"# Summary\n\nInconsistencies in how `gem` processes gem files make it possible to reuse a signature from an existing signed gem and apply it to arbitrary contents. The forged gem will install even with `-P HighSecurity`.\n\nThe attached file multi_json-1.12.2.gem is a forged version of the genuine [multi_json-1.12.2.gem](https://rubygems.org/gems/multi_json/versions/1.12.2) gem with faked contents (just a single text file called HACKED). Here is how to check it. You must first trust the original developer's public key.\n```\n$ gem --version\n2.5.2\n$ wget https://raw.githubusercontent.com/intridea/multi_json/master/certs/rwz.pem\n$ gem cert --add rwz.pem\nAdded '/CN=pavel/DC=pravosud/DC=com'\n$ gem install --install-dir install -P HighSecurity multi_json-1.12.2.gem\nSuccessfully installed multi_json-1.12.2\n1 gem installed\n$ ls install/gems/multi_json-1.12.2/\nHACKED\n```\n\n\n# Details\n\nThe vulnerability stems from inconsistencies in how `gem` interprets the entries of the tar container. A tar file may contain multiple entries with the same name. When there are two data.tar.gz entries, for example, `gem` will honor the *second* one when verifying the signature, but the *first* one when installing files. The proof of concept gem uses this trick: it prepends an additional data.tar.gz entry to the genuine multi_json-1.12.2.gem. (The attached forge-gem.sh script was used to make it.)\n```\n$ tar tvf multi_json-1.12.2.gem\n-r--r--r-- wheel/wheel     163 2017-10-05 16:05 data.tar.gz\n-r--r--r-- wheel/wheel    1840 2017-09-04 21:51 metadata.gz\n-r--r--r-- wheel/wheel     256 2017-09-04 21:51 metadata.gz.sig\n-r--r--r-- wheel/wheel   16908 2017-09-04 21:51 data.tar.gz\n-r--r--r-- wheel/wheel     256 2017-09-04 21:51 data.tar.gz.sig\n-r--r--r-- wheel/wheel     270 2017-09-04 21:51 checksums.yaml.gz\n-r--r--r-- wheel/wheel     256 2017-09-04 21:51 checksums.yaml.gz.sig\n```\n\nA similar bug affects checksums.yaml.gz: checksums are read from the first such entry, while the signature is verified on the last. This table summarizes the inconsistencies:\n\n| file              | `extract_files` uses | `verify` uses |\n|-------------------|----------------------|---------------|\n| data.tar.gz       | first                | last          |\n| checksums.yaml.gz | first                | last          |\n| metadata.gz       | last                 | last          |\n\n\n## Source code references\n\nHere are the pieces of code that are responsible for the inconsistencies in processing.\n\n[`extract_files`](https://github.com/rubygems/rubygems/blob/v2.6.13/lib/rubygems/package.rb#L334-L350) takes the *first* data.tar.gz entry:\n```\n  def extract_files destination_dir, pattern = \"*\"\n    verify unless @spec\n\n    FileUtils.mkdir_p destination_dir\n\n    @gem.with_read_io do |io|\n      reader = Gem::Package::TarReader.new io\n\n      reader.each do |entry|\n        next unless entry.full_name == 'data.tar.gz'\n\n        extract_tar_gz entry, destination_dir, pattern\n\n        return # ignore further entries\n      end\n    end\n  end\n```\n\n[`read_checksums`](https://github.com/rubygems/rubygems/blob/v2.6.13/lib/rubygems/package.rb#L466-L474) [seeks](https://github.com/rubygems/rubygems/blob/v2.6.13/lib/rubygems/package/tar_reader.rb#L109-L119) to the *first* checksums.yaml.gz entry:\n```\n  def read_checksums gem\n    Gem.load_yaml\n\n    @checksums = gem.seek 'checksums.yaml.gz' do |entry|\n      Zlib::GzipReader.wrap entry do |gz_io|\n        YAML.load gz_io.read\n      end\n    end\n  end\n```\n\n[`verify_files`](https://github.com/rubygems/rubygems/blob/v2.6.13/lib/rubygems/package.rb#L593-L606) and [`verify_entry`](https://github.com/rubygems/rubygems/blob/v2.6.13/lib/rubygems/package.rb#L566-L588) iterate over all entries in the tar file, filling in `@signatures` and `@digests`. In the case of entries with duplicate names, it overwrites previous values, meaning that the *last* result wins. `verify_entry` also handles metadata.gz, calling [`load_spec`](https://github.com/rubygems/rubygems/blob/v2.6.13/lib/rubygems/package.rb#L436-L450) afresh each time:\n```\n  def verify_entry entry\n    file_name = entry.full_name\n    @files \u003c\u003c file_name\n\n    case file_name\n    when /\\.sig$/ then\n      @signatures[$`] = entry.read if @security_policy\n      return\n    else\n      digest entry\n    end\n\n    case file_name\n    when /^metadata(.gz)?$/ then\n      load_spec entry\n    when 'data.tar.gz' then\n      verify_gz entry\n    end\n  rescue =\u003e e\n    message = \"package is corrupt, exception while verifying: \" +\n              \"#{e.message} (#{e.class})\"\n    raise Gem::Package::FormatError.new message, @gem\n  end\n```\n[`verify_checksums`](https://github.com/rubygems/rubygems/blob/v2.6.13/lib/rubygems/package.rb#L548-L561) and [`verify_signatures`](https://github.com/rubygems/rubygems/blob/v2.6.13/lib/rubygems/security/policy.rb#L283-L291) operate only on the precomputed `@checksums`, `@signatures`, and `@digests`.\n\nIncidentally, [`get_metadata`](https://github.com/rubygems/rubygems/blob/v2.6.13/lib/rubygems/commands/unpack_command.rb#L161-L177), used by the `unpack` command, has its own extractor for metadata.gz, but it happens to grab the last entry, just like `verify_files`.\n\n\n# Mitigation\n\nThe attached patch 0001-Add-tests-that-Gem-Package-verify-checks-duplicate-f.patch adds two new tests (both currently failing) that check signature verification when bogus files come before or after the genuine files.\n\nThe essential mitigation is to ensure that there is no ambiguity when processing a tar file that has multiple entries for the same file name. E.g., \"data.tar.gz\" must refer to one and only one entry in the tar file. One way to do it would be to set a policy in the code: e.g., last entry always wins (which would be consistent with the `tar` command). But that would be hard to enforce, especially in new code going forward. Another way would be not to permit duplicate entries; e.g., `verify_entry` could check whenever it is about to overwrite something in `@signatures`, `@digests`, or `@spec`, and return an error. This needs some care, as metadata and metadata.gz are both processed equivalently. It is possible, using symlinks, to create entries that effectively point to the same file, even though the paths differ; e.g.:\n```\ndata.tar.gz\ndir/ -\u003e ..\ndir/data.tar.gz\n```\nBut this shouldn't be a problem for `gem`, as long as it continues to use strict string equality with unadorned paths like `\"data.tar.gz\"`.\n\nEven when this bug is fixed, a weaker form of signature forgery is possible. There is nothing in a gem file that binds data.tar.gz and metadata.gz together: they are signed independently. It is possible to mix and match files from different signed gems. Suppose a signed gem example-1.0 has a security vulnerability, and the authors release a new signed update example-1.1. Someone (perhaps a malicious rubygems.org admin) could forge a gem containing data.tar.gz from example-1.0 and metadata.gz from example-1.1. Users would think they are running the updated code, but they are still running the old vulnerable code. Fixing this weaker form of forgery seems like it would require a redesign of the signature format. Ideally, the signature would be over the entire gem, and verified before any unpacking.\n\nIt seems that not many people are sign their gems or verify signatures. For most users the possibility of signature forgery doesn't put them at additional risk beyond the (already risky) status quo. The flaw affects only those users who use the `MediumSecurity` or `HighSecurity` profiles.\n\n\n# Attachments\n\n- **multi_json-1.12.2.gem** is a gem with a forged signature.\n- **0001-Add-tests-that-Gem-Package-verify-checks-duplicate-f.patch** adds tests for specific instances of gem files that contain multiple entries with the same name.\n- **forge-gem.sh** takes an existing signed gem and produces a forged gem containing an arbitrary data.tar.gz file.\n\nHow to run forge-gem.sh:\n```\n$ gem fetch multi_json\n$ mkdir orig\n$ mv multi_json-1.12.2.gem orig/\n$ echo hacked \u003e HACKED\n$ tar czf data.tar.gz HACKED\n$ ./forge-gem.sh orig/multi_json-1.12.2.gem data.tar.gz forged.gem\n```\nBe aware that if the original multi_json-1.12.2.gem and the new forged.gem are both in the same directory, then `gem install ./forged.gem` willâ€”for some reasonâ€”install multi_json-1.12.2.gem instead. You have to hide the original file in another directory first.\n","vulnerability_information_html":"\u003ch1 id=\"summary\"\u003eSummary\u003c/h1\u003e\n\n\u003cp\u003eInconsistencies in how \u003ccode\u003egem\u003c/code\u003e processes gem files make it possible to reuse a signature from an existing signed gem and apply it to arbitrary contents. The forged gem will install even with \u003ccode\u003e-P HighSecurity\u003c/code\u003e.\u003c/p\u003e\n\n\u003cp\u003eThe attached file multi_json-1.12.2.gem is a forged version of the genuine \u003ca href=\"/redirect?url=https%3A%2F%2Frubygems.org%2Fgems%2Fmulti_json%2Fversions%2F1.12.2\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003emulti_json-1.12.2.gem\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e gem with faked contents (just a single text file called HACKED). Here is how to check it. You must first trust the original developer\u0026#39;s public key.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e$ gem --version\n2.5.2\n$ wget https://raw.githubusercontent.com/intridea/multi_json/master/certs/rwz.pem\n$ gem cert --add rwz.pem\nAdded \u0026#39;/CN=pavel/DC=pravosud/DC=com\u0026#39;\n$ gem install --install-dir install -P HighSecurity multi_json-1.12.2.gem\nSuccessfully installed multi_json-1.12.2\n1 gem installed\n$ ls install/gems/multi_json-1.12.2/\nHACKED\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch1 id=\"details\"\u003eDetails\u003c/h1\u003e\n\n\u003cp\u003eThe vulnerability stems from inconsistencies in how \u003ccode\u003egem\u003c/code\u003e interprets the entries of the tar container. A tar file may contain multiple entries with the same name. When there are two data.tar.gz entries, for example, \u003ccode\u003egem\u003c/code\u003e will honor the \u003cem\u003esecond\u003c/em\u003e one when verifying the signature, but the \u003cem\u003efirst\u003c/em\u003e one when installing files. The proof of concept gem uses this trick: it prepends an additional data.tar.gz entry to the genuine multi_json-1.12.2.gem. (The attached forge-gem.sh script was used to make it.)\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e$ tar tvf multi_json-1.12.2.gem\n-r--r--r-- wheel/wheel     163 2017-10-05 16:05 data.tar.gz\n-r--r--r-- wheel/wheel    1840 2017-09-04 21:51 metadata.gz\n-r--r--r-- wheel/wheel     256 2017-09-04 21:51 metadata.gz.sig\n-r--r--r-- wheel/wheel   16908 2017-09-04 21:51 data.tar.gz\n-r--r--r-- wheel/wheel     256 2017-09-04 21:51 data.tar.gz.sig\n-r--r--r-- wheel/wheel     270 2017-09-04 21:51 checksums.yaml.gz\n-r--r--r-- wheel/wheel     256 2017-09-04 21:51 checksums.yaml.gz.sig\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eA similar bug affects checksums.yaml.gz: checksums are read from the first such entry, while the signature is verified on the last. This table summarizes the inconsistencies:\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003efile\u003c/th\u003e\n\u003cth\u003e\n\u003ccode\u003eextract_files\u003c/code\u003e uses\u003c/th\u003e\n\u003cth\u003e\n\u003ccode\u003everify\u003c/code\u003e uses\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003edata.tar.gz\u003c/td\u003e\n\u003ctd\u003efirst\u003c/td\u003e\n\u003ctd\u003elast\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003echecksums.yaml.gz\u003c/td\u003e\n\u003ctd\u003efirst\u003c/td\u003e\n\u003ctd\u003elast\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003emetadata.gz\u003c/td\u003e\n\u003ctd\u003elast\u003c/td\u003e\n\u003ctd\u003elast\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003ch2 id=\"source-code-references\"\u003eSource code references\u003c/h2\u003e\n\n\u003cp\u003eHere are the pieces of code that are responsible for the inconsistencies in processing.\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Frubygems%2Frubygems%2Fblob%2Fv2.6.13%2Flib%2Frubygems%2Fpackage.rb%23L334-L350\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003e\u003ccode\u003eextract_files\u003c/code\u003e\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e takes the \u003cem\u003efirst\u003c/em\u003e data.tar.gz entry:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e  def extract_files destination_dir, pattern = \u0026quot;*\u0026quot;\n    verify unless @spec\n\n    FileUtils.mkdir_p destination_dir\n\n    @gem.with_read_io do |io|\n      reader = Gem::Package::TarReader.new io\n\n      reader.each do |entry|\n        next unless entry.full_name == \u0026#39;data.tar.gz\u0026#39;\n\n        extract_tar_gz entry, destination_dir, pattern\n\n        return # ignore further entries\n      end\n    end\n  end\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Frubygems%2Frubygems%2Fblob%2Fv2.6.13%2Flib%2Frubygems%2Fpackage.rb%23L466-L474\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003e\u003ccode\u003eread_checksums\u003c/code\u003e\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e \u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Frubygems%2Frubygems%2Fblob%2Fv2.6.13%2Flib%2Frubygems%2Fpackage%2Ftar_reader.rb%23L109-L119\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eseeks\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e to the \u003cem\u003efirst\u003c/em\u003e checksums.yaml.gz entry:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e  def read_checksums gem\n    Gem.load_yaml\n\n    @checksums = gem.seek \u0026#39;checksums.yaml.gz\u0026#39; do |entry|\n      Zlib::GzipReader.wrap entry do |gz_io|\n        YAML.load gz_io.read\n      end\n    end\n  end\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Frubygems%2Frubygems%2Fblob%2Fv2.6.13%2Flib%2Frubygems%2Fpackage.rb%23L593-L606\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003e\u003ccode\u003everify_files\u003c/code\u003e\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e and \u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Frubygems%2Frubygems%2Fblob%2Fv2.6.13%2Flib%2Frubygems%2Fpackage.rb%23L566-L588\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003e\u003ccode\u003everify_entry\u003c/code\u003e\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e iterate over all entries in the tar file, filling in \u003ccode\u003e@signatures\u003c/code\u003e and \u003ccode\u003e@digests\u003c/code\u003e. In the case of entries with duplicate names, it overwrites previous values, meaning that the \u003cem\u003elast\u003c/em\u003e result wins. \u003ccode\u003everify_entry\u003c/code\u003e also handles metadata.gz, calling \u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Frubygems%2Frubygems%2Fblob%2Fv2.6.13%2Flib%2Frubygems%2Fpackage.rb%23L436-L450\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003e\u003ccode\u003eload_spec\u003c/code\u003e\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e afresh each time:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e  def verify_entry entry\n    file_name = entry.full_name\n    @files \u0026lt;\u0026lt; file_name\n\n    case file_name\n    when /\\.sig$/ then\n      @signatures[$`] = entry.read if @security_policy\n      return\n    else\n      digest entry\n    end\n\n    case file_name\n    when /^metadata(.gz)?$/ then\n      load_spec entry\n    when \u0026#39;data.tar.gz\u0026#39; then\n      verify_gz entry\n    end\n  rescue =\u0026gt; e\n    message = \u0026quot;package is corrupt, exception while verifying: \u0026quot; +\n              \u0026quot;#{e.message} (#{e.class})\u0026quot;\n    raise Gem::Package::FormatError.new message, @gem\n  end\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Frubygems%2Frubygems%2Fblob%2Fv2.6.13%2Flib%2Frubygems%2Fpackage.rb%23L548-L561\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003e\u003ccode\u003everify_checksums\u003c/code\u003e\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e and \u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Frubygems%2Frubygems%2Fblob%2Fv2.6.13%2Flib%2Frubygems%2Fsecurity%2Fpolicy.rb%23L283-L291\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003e\u003ccode\u003everify_signatures\u003c/code\u003e\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e operate only on the precomputed \u003ccode\u003e@checksums\u003c/code\u003e, \u003ccode\u003e@signatures\u003c/code\u003e, and \u003ccode\u003e@digests\u003c/code\u003e.\u003c/p\u003e\n\n\u003cp\u003eIncidentally, \u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Frubygems%2Frubygems%2Fblob%2Fv2.6.13%2Flib%2Frubygems%2Fcommands%2Funpack_command.rb%23L161-L177\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003e\u003ccode\u003eget_metadata\u003c/code\u003e\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e, used by the \u003ccode\u003eunpack\u003c/code\u003e command, has its own extractor for metadata.gz, but it happens to grab the last entry, just like \u003ccode\u003everify_files\u003c/code\u003e.\u003c/p\u003e\n\n\u003ch1 id=\"mitigation\"\u003eMitigation\u003c/h1\u003e\n\n\u003cp\u003eThe attached patch 0001-Add-tests-that-Gem-Package-verify-checks-duplicate-f.patch adds two new tests (both currently failing) that check signature verification when bogus files come before or after the genuine files.\u003c/p\u003e\n\n\u003cp\u003eThe essential mitigation is to ensure that there is no ambiguity when processing a tar file that has multiple entries for the same file name. E.g., \u0026quot;data.tar.gz\u0026quot; must refer to one and only one entry in the tar file. One way to do it would be to set a policy in the code: e.g., last entry always wins (which would be consistent with the \u003ccode\u003etar\u003c/code\u003e command). But that would be hard to enforce, especially in new code going forward. Another way would be not to permit duplicate entries; e.g., \u003ccode\u003everify_entry\u003c/code\u003e could check whenever it is about to overwrite something in \u003ccode\u003e@signatures\u003c/code\u003e, \u003ccode\u003e@digests\u003c/code\u003e, or \u003ccode\u003e@spec\u003c/code\u003e, and return an error. This needs some care, as metadata and metadata.gz are both processed equivalently. It is possible, using symlinks, to create entries that effectively point to the same file, even though the paths differ; e.g.:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003edata.tar.gz\ndir/ -\u0026gt; ..\ndir/data.tar.gz\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eBut this shouldn\u0026#39;t be a problem for \u003ccode\u003egem\u003c/code\u003e, as long as it continues to use strict string equality with unadorned paths like \u003ccode\u003e\u0026quot;data.tar.gz\u0026quot;\u003c/code\u003e.\u003c/p\u003e\n\n\u003cp\u003eEven when this bug is fixed, a weaker form of signature forgery is possible. There is nothing in a gem file that binds data.tar.gz and metadata.gz together: they are signed independently. It is possible to mix and match files from different signed gems. Suppose a signed gem example-1.0 has a security vulnerability, and the authors release a new signed update example-1.1. Someone (perhaps a malicious rubygems.org admin) could forge a gem containing data.tar.gz from example-1.0 and metadata.gz from example-1.1. Users would think they are running the updated code, but they are still running the old vulnerable code. Fixing this weaker form of forgery seems like it would require a redesign of the signature format. Ideally, the signature would be over the entire gem, and verified before any unpacking.\u003c/p\u003e\n\n\u003cp\u003eIt seems that not many people are sign their gems or verify signatures. For most users the possibility of signature forgery doesn\u0026#39;t put them at additional risk beyond the (already risky) status quo. The flaw affects only those users who use the \u003ccode\u003eMediumSecurity\u003c/code\u003e or \u003ccode\u003eHighSecurity\u003c/code\u003e profiles.\u003c/p\u003e\n\n\u003ch1 id=\"attachments\"\u003eAttachments\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003cstrong\u003emulti_json-1.12.2.gem\u003c/strong\u003e is a gem with a forged signature.\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003e0001-Add-tests-that-Gem-Package-verify-checks-duplicate-f.patch\u003c/strong\u003e adds tests for specific instances of gem files that contain multiple entries with the same name.\u003c/li\u003e\n\u003cli\u003e\n\u003cstrong\u003eforge-gem.sh\u003c/strong\u003e takes an existing signed gem and produces a forged gem containing an arbitrary data.tar.gz file.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eHow to run forge-gem.sh:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e$ gem fetch multi_json\n$ mkdir orig\n$ mv multi_json-1.12.2.gem orig/\n$ echo hacked \u0026gt; HACKED\n$ tar czf data.tar.gz HACKED\n$ ./forge-gem.sh orig/multi_json-1.12.2.gem data.tar.gz forged.gem\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eBe aware that if the original multi_json-1.12.2.gem and the new forged.gem are both in the same directory, then \u003ccode\u003egem install ./forged.gem\u003c/code\u003e willâ€”for some reasonâ€”install multi_json-1.12.2.gem instead. You have to hide the original file in another directory first.\u003c/p\u003e\n","bounty_amount":"1000.0","formatted_bounty":"$1,000","weakness":{"id":32,"name":"Cryptographic Issues - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":227013,"file_name":"multi_json-1.12.2.gem","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/227/013/f89fa0fa02e595d89bf4e2a641308061555de204/multi_json-1.12.2.gem?response-content-disposition=attachment%3B%20filename%3D%22multi_json-1.12.2.gem%22%3B%20filename%2A%3DUTF-8%27%27multi_json-1.12.2.gem\u0026response-content-type=application%2Fx-tar\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQTGH7D7G4%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T052040Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIF3bZwIuJVbBath9RBAagycfg6N290U9MaBDwIhhNMqjAiEA5QJFTUjUu%2BelINQ8mBSRMtPAJunx%2FkQdIQYoGvxoAn0qtAMIVRABGgwwMTM2MTkyNzQ4NDkiDKWCtAdrSoxlUzEo5CqRA2KbCK2gb0cQjXvMxG7rxH%2BqkR2WSbvaIs%2FZazFNKw1eZW2WrZTy5Q04uSJp6R8rbsBzRSLIFhyP9QTQMq5P15qLdwXnZbOxNVoADzWwgfUfGt%2BOwI%2BEjM3ovXNd1aGU0Ee1TBGk3LBN3uQ8ppV7Xii57PrmCtM4dm9usXbAaaa8f8QiQFPH1YTkHf%2FPe1cgMlFNJFqSrmu3ZMinUb9pxpphywkYT29wP%2Fak4Sy9A3St63iqnDzi8wrdG9%2FGdB7M03pSeaVTcH99G5j%2FqMpFpJxYN8TNlglA1OWgt7QlVOqnq65zCp4szGmwzF1FrjkS%2Bp3wB27lGxlw0v79ozRdwRBFBFvrSgSeToK8vpEBIlnO4uogSsVneM6zoYfyQw3%2F6HqcPg9mVWJmJS4QLMpQTMd%2FMeYn%2F%2Ffl2Vt%2Bb0X2rNtQPeWMGpzHpq6XAiCjZ%2F33fJuN%2B3j9Lmo023GSXKu%2B%2FkZTBp3waVREDqE%2BNeB30X8ZT5%2BW0bqtpGbJe8ig5jtSZzprCWg9v84Utvz3uaa%2Bcjz7MJPPqv8FOusBEHCYkRstnRk5lzIXoX3CRWjAJcL61b1gmhmecG%2Fow23IgJkGaQ5%2B%2FkCWvGrt4rLn9BlUKR84X6ifbCLPwMQevITvtVqg1wdT%2FzOjUyHnqnZVOyLFoqLXk9MNjw1VTb%2FmSNp%2Bd5NsBD5KiAAd50U1%2F1jl5yoSrl0DpEi6Yzv0bFigmUQPNRZeTImBJ2V75RxXBbDSoevWuBT70W%2F8%2BsoyTMqti7McilmsidA1BnI1f8HDTyMQGIoexlo%2BO7e5AiNtCUboKL2ZiertWXe5cEVF9mAVgHpVtz7pIIElyyZjsKslJzP%2B5WRhYUkMYg%3D%3D\u0026X-Amz-Signature=642cafda1bff71ac31f552128550f32db8f4aa0928d55c7c850672a5075b98a6","file_size":30720,"type":"application/x-tar"},{"id":227014,"file_name":"0001-Add-tests-that-Gem-Package-verify-checks-duplicate-f.patch","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/227/014/d70774534929603debdfecb454f877374ccaf4f2/0001-Add-tests-that-Gem-Package-verify-checks-duplicate-f.patch?response-content-disposition=attachment%3B%20filename%3D%220001-Add-tests-that-Gem-Package-verify-checks-duplicate-f.patch%22%3B%20filename%2A%3DUTF-8%27%270001-Add-tests-that-Gem-Package-verify-checks-duplicate-f.patch\u0026response-content-type=text%2Fx-diff\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQTGH7D7G4%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T052040Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIF3bZwIuJVbBath9RBAagycfg6N290U9MaBDwIhhNMqjAiEA5QJFTUjUu%2BelINQ8mBSRMtPAJunx%2FkQdIQYoGvxoAn0qtAMIVRABGgwwMTM2MTkyNzQ4NDkiDKWCtAdrSoxlUzEo5CqRA2KbCK2gb0cQjXvMxG7rxH%2BqkR2WSbvaIs%2FZazFNKw1eZW2WrZTy5Q04uSJp6R8rbsBzRSLIFhyP9QTQMq5P15qLdwXnZbOxNVoADzWwgfUfGt%2BOwI%2BEjM3ovXNd1aGU0Ee1TBGk3LBN3uQ8ppV7Xii57PrmCtM4dm9usXbAaaa8f8QiQFPH1YTkHf%2FPe1cgMlFNJFqSrmu3ZMinUb9pxpphywkYT29wP%2Fak4Sy9A3St63iqnDzi8wrdG9%2FGdB7M03pSeaVTcH99G5j%2FqMpFpJxYN8TNlglA1OWgt7QlVOqnq65zCp4szGmwzF1FrjkS%2Bp3wB27lGxlw0v79ozRdwRBFBFvrSgSeToK8vpEBIlnO4uogSsVneM6zoYfyQw3%2F6HqcPg9mVWJmJS4QLMpQTMd%2FMeYn%2F%2Ffl2Vt%2Bb0X2rNtQPeWMGpzHpq6XAiCjZ%2F33fJuN%2B3j9Lmo023GSXKu%2B%2FkZTBp3waVREDqE%2BNeB30X8ZT5%2BW0bqtpGbJe8ig5jtSZzprCWg9v84Utvz3uaa%2Bcjz7MJPPqv8FOusBEHCYkRstnRk5lzIXoX3CRWjAJcL61b1gmhmecG%2Fow23IgJkGaQ5%2B%2FkCWvGrt4rLn9BlUKR84X6ifbCLPwMQevITvtVqg1wdT%2FzOjUyHnqnZVOyLFoqLXk9MNjw1VTb%2FmSNp%2Bd5NsBD5KiAAd50U1%2F1jl5yoSrl0DpEi6Yzv0bFigmUQPNRZeTImBJ2V75RxXBbDSoevWuBT70W%2F8%2BsoyTMqti7McilmsidA1BnI1f8HDTyMQGIoexlo%2BO7e5AiNtCUboKL2ZiertWXe5cEVF9mAVgHpVtz7pIIElyyZjsKslJzP%2B5WRhYUkMYg%3D%3D\u0026X-Amz-Signature=cec28d0ee6e95781b45a99614cb53afa3733d1ab39ecd9f2ed9f6bd3efe5bf87","file_size":4961,"type":"text/x-diff"},{"id":227015,"file_name":"forge-gem.sh","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/227/015/2b53fef97a7f9a8b1e9ba80fedf2dad0c036acf8/forge-gem.sh?response-content-disposition=attachment%3B%20filename%3D%22forge-gem.sh%22%3B%20filename%2A%3DUTF-8%27%27forge-gem.sh\u0026response-content-type=text%2Fx-shellscript\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQTGH7D7G4%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T052040Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIF3bZwIuJVbBath9RBAagycfg6N290U9MaBDwIhhNMqjAiEA5QJFTUjUu%2BelINQ8mBSRMtPAJunx%2FkQdIQYoGvxoAn0qtAMIVRABGgwwMTM2MTkyNzQ4NDkiDKWCtAdrSoxlUzEo5CqRA2KbCK2gb0cQjXvMxG7rxH%2BqkR2WSbvaIs%2FZazFNKw1eZW2WrZTy5Q04uSJp6R8rbsBzRSLIFhyP9QTQMq5P15qLdwXnZbOxNVoADzWwgfUfGt%2BOwI%2BEjM3ovXNd1aGU0Ee1TBGk3LBN3uQ8ppV7Xii57PrmCtM4dm9usXbAaaa8f8QiQFPH1YTkHf%2FPe1cgMlFNJFqSrmu3ZMinUb9pxpphywkYT29wP%2Fak4Sy9A3St63iqnDzi8wrdG9%2FGdB7M03pSeaVTcH99G5j%2FqMpFpJxYN8TNlglA1OWgt7QlVOqnq65zCp4szGmwzF1FrjkS%2Bp3wB27lGxlw0v79ozRdwRBFBFvrSgSeToK8vpEBIlnO4uogSsVneM6zoYfyQw3%2F6HqcPg9mVWJmJS4QLMpQTMd%2FMeYn%2F%2Ffl2Vt%2Bb0X2rNtQPeWMGpzHpq6XAiCjZ%2F33fJuN%2B3j9Lmo023GSXKu%2B%2FkZTBp3waVREDqE%2BNeB30X8ZT5%2BW0bqtpGbJe8ig5jtSZzprCWg9v84Utvz3uaa%2Bcjz7MJPPqv8FOusBEHCYkRstnRk5lzIXoX3CRWjAJcL61b1gmhmecG%2Fow23IgJkGaQ5%2B%2FkCWvGrt4rLn9BlUKR84X6ifbCLPwMQevITvtVqg1wdT%2FzOjUyHnqnZVOyLFoqLXk9MNjw1VTb%2FmSNp%2Bd5NsBD5KiAAd50U1%2F1jl5yoSrl0DpEi6Yzv0bFigmUQPNRZeTImBJ2V75RxXBbDSoevWuBT70W%2F8%2BsoyTMqti7McilmsidA1BnI1f8HDTyMQGIoexlo%2BO7e5AiNtCUboKL2ZiertWXe5cEVF9mAVgHpVtz7pIIElyyZjsKslJzP%2B5WRhYUkMYg%3D%3D\u0026X-Amz-Signature=786e037f71543f192d07495a74a9dc67620550a4a6601ac05bde909cb3477919","file_size":908,"type":"text/x-shellscript"}],"allow_singular_disclosure_at":"2018-08-03T20:23:31.255Z","allow_singular_disclosure_after":-75891429.70706685,"singular_disclosure_allowed":true,"vote_count":16,"voters":["barbie_girl","foobar7","z3t","michiel","haones","mygf","eveeez","apapedulimu","khizer47","japz","and 6 more..."],"severity":{"rating":"medium","score":5.5,"author_type":"User","metrics":{"attack_vector":"local","attack_complexity":"low","privileges_required":"high","user_interaction":"required","scope":"changed","confidentiality":"none","integrity":"high","availability":"none"}},"structured_scope":{"databaseId":2043,"asset_type":"SOURCE_CODE","asset_identifier":"https://github.com/rubygems/rubygems","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":2050562,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for submitting this report to RubyGems. Our team will review and investigate the issue. Please note that only issues in the rubygems library are eligible for our bug bounty program.","markdown_message":"\u003cp\u003eThanks for submitting this report to RubyGems. Our team will review and investigate the issue. Please note that only issues in the rubygems library are eligible for our bug bounty program.\u003c/p\u003e\n","automated_response":true,"created_at":"2017-10-06T23:57:18.014Z","updated_at":"2017-10-06T23:57:18.014Z","actor":{"url":"/rubygems","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/008/212/e65eca09896d23bc029c08d3147a79a48ec1ee2f_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"RubyGems"}},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2299404,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@plover we have a fix developed for this, just waiting on someone to have the time to do a security patch release","markdown_message":"\u003cp\u003e\u003ca href=\"/plover\"\u003e@plover\u003c/a\u003e we have a fix developed for this, just waiting on someone to have the time to do a security patch release\u003c/p\u003e\n","automated_response":false,"created_at":"2018-01-19T04:00:59.096Z","updated_at":"2018-01-19T04:00:59.096Z","actor":{"username":"segiddins","cleared":false,"url":"/segiddins","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2377063,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2018-02-12T23:51:06.362Z","updated_at":"2018-02-12T23:51:06.362Z","actor":{"username":"claudijd","cleared":false,"url":"/claudijd","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/131/3c373767fbd4f34648ab754b0f692fb718bfb8e5_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2395876,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Credit for this bug also goes to Nathan Malkin (nmalkin). We were working as a team.","markdown_message":"\u003cp\u003eCredit for this bug also goes to Nathan Malkin (nmalkin). We were working as a team.\u003c/p\u003e\n","automated_response":false,"created_at":"2018-02-18T06:34:11.892Z","updated_at":"2018-02-18T06:34:11.892Z","actor":{"username":"plover","cleared":false,"url":"/plover","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2413749,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Congrats on finding this bug. ðŸŽ‰","markdown_message":"\u003cp\u003eCongrats on finding this bug. ðŸŽ‰\u003c/p\u003e\n","automated_response":false,"created_at":"2018-02-22T00:09:50.981Z","updated_at":"2018-02-22T00:10:21.354Z","actor":{"url":"/rubygems","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/008/212/e65eca09896d23bc029c08d3147a79a48ec1ee2f_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"RubyGems"}},"bounty_amount":"1000.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"rubygems","collaborator":{"username":"plover","url":"/plover"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2919899,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"This bug was fixed in RubyGems 2.7.6\n\nhttp://blog.rubygems.org/2018/02/15/2.7.6-released.html\n\nThanks!","markdown_message":"\u003cp\u003eThis bug was fixed in RubyGems 2.7.6\u003c/p\u003e\n\n\u003cp\u003e\u003ca title=\"http://blog.rubygems.org/2018/02/15/2.7.6-released.html\" href=\"/redirect?url=http%3A%2F%2Fblog.rubygems.org%2F2018%2F02%2F15%2F2.7.6-released.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttp://blog.rubygems.org/2018/02/15/2.7.6-released.html\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eThanks!\u003c/p\u003e\n","automated_response":false,"created_at":"2018-06-22T07:30:49.297Z","updated_at":"2018-06-22T07:30:49.297Z","actor":{"username":"sonalkr132","cleared":false,"url":"/sonalkr132","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/110/393/d14955d9a0ac015bfba8df495ebf3c8b9f6f87cd_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"plover","url":"/plover"},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2988933,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2018-07-04T20:23:31.200Z","updated_at":"2018-07-04T20:23:31.200Z","first_to_agree":true,"actor":{"username":"plover","cleared":false,"url":"/plover","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3138748,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2018-08-03T20:23:47.996Z","updated_at":"2018-08-03T20:23:47.996Z","actor":{"url":"/rubygems","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/008/212/e65eca09896d23bc029c08d3147a79a48ec1ee2f_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"RubyGems"}},"genius_execution_id":null,"team_handle":"rubygems","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}