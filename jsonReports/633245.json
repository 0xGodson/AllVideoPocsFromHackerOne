{"id":633245,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC82MzMyNDU=","url":"https://hackerone.com/reports/633245","title":"Delete permission can be added on reshare","state":"Closed","substate":"resolved","severity_rating":"low","readable_substate":"Resolved","created_at":"2019-07-01T16:12:45.510Z","submitted_at":"2019-07-01T16:12:45.510Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"phil-davis","url":"/phil-davis","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":13291,"url":"https://hackerone.com/nextcloud","handle":"nextcloud","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Nextcloud","twitter_handle":"nextclouders","website":"https://nextcloud.com","about":"Access, share and protect your files, calendars, contacts, communication \u0026 more at home and in your enterprise."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2019-09-03T13:14:41.352Z","bug_reporter_agreed_on_going_public_at":"2019-09-03T13:14:41.279Z","team_member_agreed_on_going_public_at":"2019-09-03T12:08:51.151Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"user0 creates folder /test\nuser0 creates file /test/file.txt\nuser0 shares folder /test with user1 with read+share permissions (17)\nuser1 receives the folder /test and can read-download /test/file.txt but not delete - good\nuser1 uses the sharing API to share folder /test with user2, and specifies read(1)+reshare(16)+delete(8)=permissions 25 e.g.\n\ncurl --user user1:user1 \"http://172.17.0.1:8081/ocs/v1.php/apps/files_sharing/api/v1/shares\" -H \"OCS-APIRequest: true\"  -X POST --data 'path=/test\u0026shareType=0\u0026shareWith=user2\u0026permissions=25'\n\nuser2 deletes /test/file.txt\n\ncurl --user user2:user2 \"http://172.17.0.1:8081/remote.php/dav/files/user2/test/file.txt\" -H \"OCS-APIRequest: true\" -X DELETE\n\nor with the webUI.\n\nThis seems to be a side-effect of https://github.com/nextcloud/server/blob/master/lib/private/Files/View.php#L1389 \n\n```\n\t\t\tif ($mount instanceof MoveableMount \u0026\u0026 $internalPath === '') {\n\t\t\t\t$data['permissions'] |= \\OCP\\Constants::PERMISSION_DELETE;\n\t\t\t}\n```\nwhich seems to be there so that a user that receives a share gets \"implied delete\" access to the share \"root\" so that they can unshare. (They cannot really delete the whole received share, when they \"delete\" they are actually just \"unsharing\". But when they reshare on to `user2` then this \"implied delete\" is able to be passed on.\n\nThe problem also happens if user1 shares with a group, and adds the delete permission. Users in the group can delete files. user1 can share with a group that they are already a member of. That gives user1 delete access to the files in the folder.\n\n## Impact\n\nA malicious user can reshare any received share, adding the delete permission to the reshare. Thus giving themselves (if they are in the group) or the end-user the ability to delete files of the first user.\n\nThe scenario works with current server master. I guess it will work with 16.* release...","vulnerability_information_html":"\u003cp\u003euser0 creates folder /test\u003cbr\u003e\nuser0 creates file /test/file.txt\u003cbr\u003e\nuser0 shares folder /test with user1 with read+share permissions (17)\u003cbr\u003e\nuser1 receives the folder /test and can read-download /test/file.txt but not delete - good\u003cbr\u003e\nuser1 uses the sharing API to share folder /test with user2, and specifies read(1)+reshare(16)+delete(8)=permissions 25 e.g.\u003c/p\u003e\n\n\u003cp\u003ecurl --user user1:user1 \u0026quot;\u003ca title=\"http://172.17.0.1:8081/ocs/v1.php/apps/files_sharing/api/v1/shares\" href=\"/redirect?url=http%3A%2F%2F172.17.0.1%3A8081%2Focs%2Fv1.php%2Fapps%2Ffiles_sharing%2Fapi%2Fv1%2Fshares\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttp://172.17.0.1:8081/ocs/v1.php/apps/files_sharing/api/v1/shares\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u0026quot; -H \u0026quot;OCS-APIRequest: true\u0026quot;  -X POST --data \u0026#39;path=/test\u0026amp;shareType=0\u0026amp;shareWith=user2\u0026amp;permissions=25\u0026#39;\u003c/p\u003e\n\n\u003cp\u003euser2 deletes /test/file.txt\u003c/p\u003e\n\n\u003cp\u003ecurl --user user2:user2 \u0026quot;\u003ca title=\"http://172.17.0.1:8081/remote.php/dav/files/user2/test/file.txt\" href=\"/redirect?url=http%3A%2F%2F172.17.0.1%3A8081%2Fremote.php%2Fdav%2Ffiles%2Fuser2%2Ftest%2Ffile.txt\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttp://172.17.0.1:8081/remote.php/dav/files/user2/test/file.txt\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u0026quot; -H \u0026quot;OCS-APIRequest: true\u0026quot; -X DELETE\u003c/p\u003e\n\n\u003cp\u003eor with the webUI.\u003c/p\u003e\n\n\u003cp\u003eThis seems to be a side-effect of \u003ca title=\"https://github.com/nextcloud/server/blob/master/lib/private/Files/View.php#L1389\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fnextcloud%2Fserver%2Fblob%2Fmaster%2Flib%2Fprivate%2FFiles%2FView.php%23L1389\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/nextcloud/server/blob/master/lib/private/Files/View.php#L1389\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e \u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e            if ($mount instanceof MoveableMount \u0026amp;\u0026amp; $internalPath === \u0026#39;\u0026#39;) {\n                $data[\u0026#39;permissions\u0026#39;] |= \\OCP\\Constants::PERMISSION_DELETE;\n            }\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003ewhich seems to be there so that a user that receives a share gets \u0026quot;implied delete\u0026quot; access to the share \u0026quot;root\u0026quot; so that they can unshare. (They cannot really delete the whole received share, when they \u0026quot;delete\u0026quot; they are actually just \u0026quot;unsharing\u0026quot;. But when they reshare on to \u003ccode\u003euser2\u003c/code\u003e then this \u0026quot;implied delete\u0026quot; is able to be passed on.\u003c/p\u003e\n\n\u003cp\u003eThe problem also happens if user1 shares with a group, and adds the delete permission. Users in the group can delete files. user1 can share with a group that they are already a member of. That gives user1 delete access to the files in the folder.\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eA malicious user can reshare any received share, adding the delete permission to the reshare. Thus giving themselves (if they are in the group) or the end-user the ability to delete files of the first user.\u003c/p\u003e\n\n\u003cp\u003eThe scenario works with current server master. I guess it will work with 16.* release...\u003c/p\u003e\n","bounty_amount":"100.0","formatted_bounty":"$100","weakness":{"id":75,"name":"Privilege Escalation"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2019-10-03T12:08:51.235Z","allow_singular_disclosure_after":-39118974.19808485,"singular_disclosure_allowed":true,"vote_count":13,"voters":["secator","sameerphad72","mygf","z41b1337_","cryptographer","st3fan","youssef-xf7","watchdogg","formerslice","dkmr","and 3 more..."],"severity":{"rating":"low","score":3.5,"author_type":"Team","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"low","user_interaction":"required","scope":"unchanged","confidentiality":"none","integrity":"none","availability":"low"}},"structured_scope":{"databaseId":13,"asset_type":"SOURCE_CODE","asset_identifier":"nextcloud/server","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":5230323,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks a lot for reporting this potential issue back to us!\n\nOur security team will take a look at this issue as soon as possible. We will reply to your report within 72 hours, usually much faster. For obvious reasons we'd like to ask you to not disclose this issue to any other party.","markdown_message":"\u003cp\u003eThanks a lot for reporting this potential issue back to us!\u003c/p\u003e\n\n\u003cp\u003eOur security team will take a look at this issue as soon as possible. We will reply to your report within 72 hours, usually much faster. For obvious reasons we\u0026#39;d like to ask you to not disclose this issue to any other party.\u003c/p\u003e\n","automated_response":true,"created_at":"2019-07-01T16:12:49.240Z","updated_at":"2019-07-01T16:12:49.240Z","actor":{"url":"/nextcloud","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Nextcloud"}},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5237064,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2019-07-02T09:04:49.631Z","updated_at":"2019-07-02T09:04:49.631Z","actor":{"username":"nickvergessen","cleared":false,"url":"/nickvergessen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5717547,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","markdown_message":"","automated_response":false,"created_at":"2019-09-03T12:07:15.200Z","updated_at":"2019-09-03T12:07:15.200Z","additional_data":{"old_severity":null,"new_severity":"Low (3.5)","old_severity_id":null,"new_severity_id":507317},"actor":{"username":"nickvergessen","cleared":false,"url":"/nickvergessen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5717549,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"This was fixed back in July already:\nhttps://github.com/nextcloud/server/pull/16186","markdown_message":"\u003cp\u003eThis was fixed back in July already:\u003cbr\u003e\n\u003ca title=\"https://github.com/nextcloud/server/pull/16186\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fnextcloud%2Fserver%2Fpull%2F16186\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/nextcloud/server/pull/16186\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n","automated_response":false,"created_at":"2019-09-03T12:07:22.273Z","updated_at":"2019-09-03T12:07:22.273Z","actor":{"username":"nickvergessen","cleared":false,"url":"/nickvergessen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"phil-davis","url":"/phil-davis"},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5717552,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2019-09-03T12:07:49.225Z","updated_at":"2019-09-03T12:07:49.225Z","actor":{"url":"/nextcloud","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/013/291/68f57538488b5716cdeeb6b78955f9e46685bc09_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Nextcloud"}},"bounty_amount":"100.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"nextcloud","collaborator":{"username":"phil-davis","url":"/phil-davis"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5717559,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Thanks a lot for your report again. This has been resolved in our latest maintenance releases and we're working on the advisories at the moment.\n\nPlease let us know how you'd like to be credited in our official advisory. We require the following information:\n\n- Name / Pseudonym\n- Email address (optional)\n- Website (optional)\n- Company (optional)","markdown_message":"\u003cp\u003eThanks a lot for your report again. This has been resolved in our latest maintenance releases and we\u0026#39;re working on the advisories at the moment.\u003c/p\u003e\n\n\u003cp\u003ePlease let us know how you\u0026#39;d like to be credited in our official advisory. We require the following information:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eName / Pseudonym\u003c/li\u003e\n\u003cli\u003eEmail address (optional)\u003c/li\u003e\n\u003cli\u003eWebsite (optional)\u003c/li\u003e\n\u003cli\u003eCompany (optional)\u003c/li\u003e\n\u003c/ul\u003e\n","automated_response":false,"created_at":"2019-09-03T12:08:51.174Z","updated_at":"2019-09-03T12:08:51.174Z","first_to_agree":true,"actor":{"username":"nickvergessen","cleared":false,"url":"/nickvergessen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5717870,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Name: Phil Davis\nEmail address: phil@jankaritech.com\nWebsite: www.jankaritech.com\nCompany JankariTech Pvt Ltd","markdown_message":"\u003cp\u003eName: Phil Davis\u003cbr\u003e\nEmail address: \u003ca title=\"phil@jankaritech.com\" href=\"mailto:phil@jankaritech.com\" rel=\"nofollow noopener noreferrer\"\u003ephil@jankaritech.com\u003c/a\u003e\u003cbr\u003e\nWebsite: \u003ca href=\"/redirect?url=http%3A%2F%2Fwww.jankaritech.com\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ewww.jankaritech.com\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003cbr\u003e\nCompany JankariTech Pvt Ltd\u003c/p\u003e\n","automated_response":false,"created_at":"2019-09-03T13:03:54.559Z","updated_at":"2019-09-03T13:03:54.559Z","actor":{"username":"phil-davis","cleared":false,"url":"/phil-davis","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5717946,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"The bug has also been fixed in ownCloud for release 10.3.0 which has public alpha releases available. So it should be fine to disclose this - it is also effectively disclosed in the ownCloud process anyway, and by the Nextcloud fix that has been released.","markdown_message":"\u003cp\u003eThe bug has also been fixed in ownCloud for release 10.3.0 which has public alpha releases available. So it should be fine to disclose this - it is also effectively disclosed in the ownCloud process anyway, and by the Nextcloud fix that has been released.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-09-03T13:14:41.305Z","updated_at":"2019-09-03T13:14:41.305Z","actor":{"username":"phil-davis","cleared":false,"url":"/phil-davis","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5717947,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2019-09-03T13:14:41.372Z","updated_at":"2019-09-03T13:14:41.372Z","actor":{"username":"phil-davis","cleared":false,"url":"/phil-davis","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"nextcloud","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}