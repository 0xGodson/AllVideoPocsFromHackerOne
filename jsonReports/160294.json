{"id":160294,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xNjAyOTQ=","url":"https://hackerone.com/reports/160294","title":"Memory Leakage In exif_process_IFD_in_TIFF (CVE-2016-7128)","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2016-08-18T01:06:22.439Z","submitted_at":"2016-08-18T01:06:22.439Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"hoangnguyen","url":"/hoangnguyen","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/074/688/42c5ca5265ff965283d70fc52df2681dfd648d44_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":29,"url":"https://hackerone.com/ibb-php","handle":"ibb-php","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/029/99087dbbdf52fc3ce3acbf16aa33a5c4f5e2c111_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/029/99087dbbdf52fc3ce3acbf16aa33a5c4f5e2c111_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"PHP (IBB)","twitter_handle":"","website":"http://www.php.net","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2019-11-12T09:31:33.041Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2019-10-13T09:31:32.148Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"I found some vulnerable code that leads to the memory leak in exif_process_IFD_in_TIFF. Let take look at code chunk : \n```\nif (!ImageInfo-\u003eThumbnail.data \u0026\u0026 ImageInfo-\u003eThumbnail.offset \u0026\u0026 ImageInfo-\u003eThumbnail.size \u0026\u0026 ImageInfo-\u003eread_thumbnail) {\n\tImageInfo-\u003eThumbnail.data = safe_emalloc(ImageInfo-\u003eThumbnail.size, 1, 0);\n\tphp_stream_seek(ImageInfo-\u003einfile, ImageInfo-\u003eThumbnail.offset, SEEK_SET);\n\tfgot = php_stream_read(ImageInfo-\u003einfile, ImageInfo-\u003eThumbnail.data, ImageInfo-\u003eThumbnail.size);\n\tif (fgot \u003c ImageInfo-\u003eThumbnail.size) {\n\t\tEXIF_ERRLOG_THUMBEOF(ImageInfo)\n\t}\n\texif_thumbnail_build(ImageInfo);\n}\n```\nBecause lack of checking ImageInfo-\u003eThumbnail.offset if an attack set ImageInfo-\u003eThumbnail.offset larger than ImageInfo-\u003eFileSize then *php_stream_read* return 0 to fgot, because  EXIF_ERRLOG_THUMBEOF was defined as : \n```\n#define EXIF_ERRLOG_THUMBEOF(ImageInfo)   exif_error_docref(NULL EXIFERR_CC, ImageInfo, E_WARNING, \"%s\", EXIF_ERROR_THUMBEOF);\n\n```\nAs you can see there is no exit after this error is output.\nAfter that exif_thumbnail_build(ImageInfo) is called. Because this thumbnail I applied is IMAGE_FILETYPE_JPEG so exif_thumbnail_build will return without error.\n\nFinally ImageInfo-\u003eThumbnail.data is no fill by user data that lead to information leak like below, an attacker can leak address and then use it to bypass some protection such as PIE, ASLR,...\n\nHere the tiff file : https://drive.google.com/open?id=0B0D1DYQpkA9UVGE5QlJaNnIxb1E\n\nAffect : Linux, Mac Os X,Windows\nTest script:\n---------------\n\u003c?php\n\t$exif = exif_read_data('exif/gen.tiff',0,0,true);\n\tvar_dump($exif);\n\n\t$thumb = $exif['THUMBNAIL']['THUMBNAIL'];\n\techo bin2hex($thumb);\n?\u003e\n\nActual result:\n--------------\n```\n$./php exif.php\n\nWarning: exif_read_data(gen.tiff): Thumbnail goes IFD boundary or end of file reached in /vagrant_extend/audit/exif.php on line 2\n\nWarning: exif_read_data(gen.tiff): Error in TIFF: filesize(x04E2) less than start of IFD dir(x829A0004) in /vagrant_extend/audit/exif.php on line 2\narray(11) {\n  [\"FileName\"]=\u003e\n  string(8) \"gen.tiff\"\n  [\"FileDateTime\"]=\u003e\n  int(1468986539)\n  [\"FileSize\"]=\u003e\n  int(1250)\n  [\"FileType\"]=\u003e\n  int(7)\n  [\"MimeType\"]=\u003e\n  string(10) \"image/tiff\"\n  [\"SectionsFound\"]=\u003e\n  string(30) \"ANY_TAG, IFD0, THUMBNAIL, EXIF\"\n  [\"COMPUTED\"]=\u003e\n  array(10) {\n    [\"html\"]=\u003e\n    string(24) \"width=\"128\" height=\"132\"\"\n    [\"Height\"]=\u003e\n    int(132)\n    [\"Width\"]=\u003e\n    int(128)\n    [\"IsColor\"]=\u003e\n    int(0)\n    [\"ByteOrderMotorola\"]=\u003e\n    int(0)\n    [\"ApertureFNumber\"]=\u003e\n    string(5) \"f/1.0\"\n    [\"Thumbnail.FileType\"]=\u003e\n    int(2)\n    [\"Thumbnail.MimeType\"]=\u003e\n    string(10) \"image/jpeg\"\n    [\"Thumbnail.Height\"]=\u003e\n    int(132)\n    [\"Thumbnail.Width\"]=\u003e\n    int(128)\n  }\n  [\"XResolution\"]=\u003e\n  string(21) \"1414812756/1414812756\"\n  [\"THUMBNAIL\"]=\u003e\n  array(5) {\n    [\"ImageWidth\"]=\u003e\n    int(128)\n    [\"ImageLength\"]=\u003e\n    int(132)\n    [\"JPEGInterchangeFormat\"]=\u003e\n    int(1280)\n    [\"JPEGInterchangeFormatLength\"]=\u003e\n    int(200)\n    [\"THUMBNAIL\"]=\u003e\n    string(200) \"\" # leak leak\n  }\n  [\"ExposureTime\"]=\u003e\n  string(21) \"1414812756/1414812756\"\n  [\"FNumber\"]=\u003e\n  string(21) \"1414812756/1414812756\"\n}\n00c2a7081e7f000000000.... =\u003e leak leak (00c2a7081e7f =\u003e 0x7f1e08a7c200)\n```\nBug here : https://bugs.php.net/bug.php?id=72627","vulnerability_information_html":"\u003cp\u003eI found some vulnerable code that leads to the memory leak in exif_process_IFD_in_TIFF. Let take look at code chunk : \u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eif (!ImageInfo-\u0026gt;Thumbnail.data \u0026amp;\u0026amp; ImageInfo-\u0026gt;Thumbnail.offset \u0026amp;\u0026amp; ImageInfo-\u0026gt;Thumbnail.size \u0026amp;\u0026amp; ImageInfo-\u0026gt;read_thumbnail) {\n    ImageInfo-\u0026gt;Thumbnail.data = safe_emalloc(ImageInfo-\u0026gt;Thumbnail.size, 1, 0);\n    php_stream_seek(ImageInfo-\u0026gt;infile, ImageInfo-\u0026gt;Thumbnail.offset, SEEK_SET);\n    fgot = php_stream_read(ImageInfo-\u0026gt;infile, ImageInfo-\u0026gt;Thumbnail.data, ImageInfo-\u0026gt;Thumbnail.size);\n    if (fgot \u0026lt; ImageInfo-\u0026gt;Thumbnail.size) {\n        EXIF_ERRLOG_THUMBEOF(ImageInfo)\n    }\n    exif_thumbnail_build(ImageInfo);\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eBecause lack of checking ImageInfo-\u0026gt;Thumbnail.offset if an attack set ImageInfo-\u0026gt;Thumbnail.offset larger than ImageInfo-\u0026gt;FileSize then \u003cem\u003ephp_stream_read\u003c/em\u003e return 0 to fgot, because  EXIF_ERRLOG_THUMBEOF was defined as : \u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e#define EXIF_ERRLOG_THUMBEOF(ImageInfo)   exif_error_docref(NULL EXIFERR_CC, ImageInfo, E_WARNING, \u0026quot;%s\u0026quot;, EXIF_ERROR_THUMBEOF);\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAs you can see there is no exit after this error is output.\u003cbr\u003e\nAfter that exif_thumbnail_build(ImageInfo) is called. Because this thumbnail I applied is IMAGE_FILETYPE_JPEG so exif_thumbnail_build will return without error.\u003c/p\u003e\n\n\u003cp\u003eFinally ImageInfo-\u0026gt;Thumbnail.data is no fill by user data that lead to information leak like below, an attacker can leak address and then use it to bypass some protection such as PIE, ASLR,...\u003c/p\u003e\n\n\u003cp\u003eHere the tiff file : \u003ca title=\"https://drive.google.com/open?id=0B0D1DYQpkA9UVGE5QlJaNnIxb1E\" href=\"/redirect?url=https%3A%2F%2Fdrive.google.com%2Fopen%3Fid%3D0B0D1DYQpkA9UVGE5QlJaNnIxb1E\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://drive.google.com/open?id=0B0D1DYQpkA9UVGE5QlJaNnIxb1E\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eAffect : Linux, Mac Os X,Windows\u003c/p\u003e\n\n\u003ch2 id=\"test-script\"\u003eTest script:\u003c/h2\u003e\n\n\u003cp\u003e\u0026lt;?php\u003cbr\u003e\n    $exif = exif_read_data(\u0026#39;exif/gen.tiff\u0026#39;,0,0,true);\u003cbr\u003e\n    var_dump($exif);\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e$thumb = $exif[\u0026#39;THUMBNAIL\u0026#39;][\u0026#39;THUMBNAIL\u0026#39;];\necho bin2hex($thumb);\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e?\u0026gt;\u003c/p\u003e\n\n\u003ch2 id=\"actual-result\"\u003eActual result:\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e$./php exif.php\n\nWarning: exif_read_data(gen.tiff): Thumbnail goes IFD boundary or end of file reached in /vagrant_extend/audit/exif.php on line 2\n\nWarning: exif_read_data(gen.tiff): Error in TIFF: filesize(x04E2) less than start of IFD dir(x829A0004) in /vagrant_extend/audit/exif.php on line 2\narray(11) {\n  [\u0026quot;FileName\u0026quot;]=\u0026gt;\n  string(8) \u0026quot;gen.tiff\u0026quot;\n  [\u0026quot;FileDateTime\u0026quot;]=\u0026gt;\n  int(1468986539)\n  [\u0026quot;FileSize\u0026quot;]=\u0026gt;\n  int(1250)\n  [\u0026quot;FileType\u0026quot;]=\u0026gt;\n  int(7)\n  [\u0026quot;MimeType\u0026quot;]=\u0026gt;\n  string(10) \u0026quot;image/tiff\u0026quot;\n  [\u0026quot;SectionsFound\u0026quot;]=\u0026gt;\n  string(30) \u0026quot;ANY_TAG, IFD0, THUMBNAIL, EXIF\u0026quot;\n  [\u0026quot;COMPUTED\u0026quot;]=\u0026gt;\n  array(10) {\n    [\u0026quot;html\u0026quot;]=\u0026gt;\n    string(24) \u0026quot;width=\u0026quot;128\u0026quot; height=\u0026quot;132\u0026quot;\u0026quot;\n    [\u0026quot;Height\u0026quot;]=\u0026gt;\n    int(132)\n    [\u0026quot;Width\u0026quot;]=\u0026gt;\n    int(128)\n    [\u0026quot;IsColor\u0026quot;]=\u0026gt;\n    int(0)\n    [\u0026quot;ByteOrderMotorola\u0026quot;]=\u0026gt;\n    int(0)\n    [\u0026quot;ApertureFNumber\u0026quot;]=\u0026gt;\n    string(5) \u0026quot;f/1.0\u0026quot;\n    [\u0026quot;Thumbnail.FileType\u0026quot;]=\u0026gt;\n    int(2)\n    [\u0026quot;Thumbnail.MimeType\u0026quot;]=\u0026gt;\n    string(10) \u0026quot;image/jpeg\u0026quot;\n    [\u0026quot;Thumbnail.Height\u0026quot;]=\u0026gt;\n    int(132)\n    [\u0026quot;Thumbnail.Width\u0026quot;]=\u0026gt;\n    int(128)\n  }\n  [\u0026quot;XResolution\u0026quot;]=\u0026gt;\n  string(21) \u0026quot;1414812756/1414812756\u0026quot;\n  [\u0026quot;THUMBNAIL\u0026quot;]=\u0026gt;\n  array(5) {\n    [\u0026quot;ImageWidth\u0026quot;]=\u0026gt;\n    int(128)\n    [\u0026quot;ImageLength\u0026quot;]=\u0026gt;\n    int(132)\n    [\u0026quot;JPEGInterchangeFormat\u0026quot;]=\u0026gt;\n    int(1280)\n    [\u0026quot;JPEGInterchangeFormatLength\u0026quot;]=\u0026gt;\n    int(200)\n    [\u0026quot;THUMBNAIL\u0026quot;]=\u0026gt;\n    string(200) \u0026quot;\u0026quot; # leak leak\n  }\n  [\u0026quot;ExposureTime\u0026quot;]=\u0026gt;\n  string(21) \u0026quot;1414812756/1414812756\u0026quot;\n  [\u0026quot;FNumber\u0026quot;]=\u0026gt;\n  string(21) \u0026quot;1414812756/1414812756\u0026quot;\n}\n00c2a7081e7f000000000.... =\u0026gt; leak leak (00c2a7081e7f =\u0026gt; 0x7f1e08a7c200)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eBug here : \u003ca title=\"https://bugs.php.net/bug.php?id=72627\" href=\"/redirect?url=https%3A%2F%2Fbugs.php.net%2Fbug.php%3Fid%3D72627\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://bugs.php.net/bug.php?id=72627\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n","bounty_amount":"1000.0","formatted_bounty":"$1,000","weakness":{"id":2,"name":"Memory Corruption - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2019-11-12T09:31:32.248Z","allow_singular_disclosure_after":-35665524.484325,"singular_disclosure_allowed":true,"vote_count":2,"voters":["dyabla","hackerlex"],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1205755,"is_internal":false,"editable":false,"type":"Activities::ReportTitleUpdated","message":"","markdown_message":"","automated_response":false,"created_at":"2016-09-20T04:36:08.520Z","updated_at":"2016-09-20T04:36:08.520Z","additional_data":{"old_title":"Memory Leakage In exif_process_IFD_in_TIFF","new_title":"Memory Leakage In exif_process_IFD_in_TIFF (CVE-2016-7128)"},"actor":{"username":"arice","cleared":false,"url":"/arice","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/83152cb2d070f3f6a63c1b61bae47257722b5ad2_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"ibb-php","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1205756,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","markdown_message":"","automated_response":false,"created_at":"2016-09-20T04:36:22.241Z","updated_at":"2016-09-20T04:36:22.241Z","actor":{"username":"arice","cleared":false,"url":"/arice","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/83152cb2d070f3f6a63c1b61bae47257722b5ad2_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"reporter":{"username":"hoangnguyen","url":"/hoangnguyen"},"genius_execution_id":null,"team_handle":"ibb-php","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1205757,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2016-09-20T04:36:27.750Z","updated_at":"2016-09-20T04:36:27.750Z","actor":{"url":"/ibb-php","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/029/99087dbbdf52fc3ce3acbf16aa33a5c4f5e2c111_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"PHP (IBB)"}},"bounty_amount":"1000.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"ibb-php","collaborator":{"username":"hoangnguyen","url":"/hoangnguyen"},"actor_is_team_member":false,"actor_is_concealed_member":false},{"id":6026230,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2019-10-13T09:31:32.168Z","updated_at":"2019-10-13T09:31:32.168Z","first_to_agree":true,"actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"ibb-php","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6285785,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2019-11-12T09:31:33.055Z","updated_at":"2019-11-12T09:31:33.055Z","actor":{"url":"/ibb-php","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/029/99087dbbdf52fc3ce3acbf16aa33a5c4f5e2c111_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"PHP (IBB)"}},"genius_execution_id":null,"team_handle":"ibb-php","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}