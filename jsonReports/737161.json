{"id":737161,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC83MzcxNjE=","url":"https://hackerone.com/reports/737161","title":"SSRF - URL Attachments - 725307 bypass","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2019-11-14T02:25:52.227Z","submitted_at":"2019-11-14T02:25:52.227Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"zhutyra","url":"/zhutyra","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":8906,"url":"https://hackerone.com/open-xchange","handle":"open-xchange","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/JtYLEsu5yRZxGitSmAjeAFtK/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/JtYLEsu5yRZxGitSmAjeAFtK/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Open-Xchange","twitter_handle":"openxchange","website":"https://www.open-xchange.com/","about":"Messaging, collaboration and office productivity software for service providers"}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2020-02-20T10:46:12.873Z","bug_reporter_agreed_on_going_public_at":"2020-02-20T10:46:12.831Z","team_member_agreed_on_going_public_at":"2020-02-19T13:41:13.583Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"This is about incomplete fix for my recent bug #725307.\n\nIn short, the **/ajax/attachment?action=attach** endpoint allows to create URL based attachments. Content of specified URL is fetched and used as attachment body. For more details please see #725307.\n\nWith the fix applied, the URL is validated before accessed. However only *initial* address is checked. If this initially valid location redirects to another location, this *replacement* location isn't checked and still can be any internal address, effectively bypassing the validation.\n```\nhttp://attacker.com/looks/safe --\u003e http://internal/insecure\n```\n\nAgain demo program is attached and should produce output like this:\n```\nhttp://localhost:22/\nAn I/O error occurred: Invalid Http response\nhttp://localhost:23/\nAn I/O error occurred: Connection refused (Connection refused)\nhttp://localhost:443/\nattachment id 6\nhttp://localhost:444/\nAn I/O error occurred: Connection refused (Connection refused)\n```\n\n## Impact\n\nAn attacker can trigger requests to internal resources and retrieve the response contents.","vulnerability_information_html":"\u003cp\u003eThis is about incomplete fix for my recent bug \u003ca href=\"/reports/725307\"\u003e#725307\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003eIn short, the \u003cstrong\u003e/ajax/attachment?action=attach\u003c/strong\u003e endpoint allows to create URL based attachments. Content of specified URL is fetched and used as attachment body. For more details please see \u003ca href=\"/reports/725307\"\u003e#725307\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003eWith the fix applied, the URL is validated before accessed. However only \u003cem\u003einitial\u003c/em\u003e address is checked. If this initially valid location redirects to another location, this \u003cem\u003ereplacement\u003c/em\u003e location isn\u0026#39;t checked and still can be any internal address, effectively bypassing the validation.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003ehttp://attacker.com/looks/safe --\u0026gt; http://internal/insecure\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAgain demo program is attached and should produce output like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003ehttp://localhost:22/\nAn I/O error occurred: Invalid Http response\nhttp://localhost:23/\nAn I/O error occurred: Connection refused (Connection refused)\nhttp://localhost:443/\nattachment id 6\nhttp://localhost:444/\nAn I/O error occurred: Connection refused (Connection refused)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eAn attacker can trigger requests to internal resources and retrieve the response contents.\u003c/p\u003e\n","bounty_amount":"400.0","formatted_bounty":"$400","weakness":{"id":68,"name":"Server-Side Request Forgery (SSRF)"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":633856,"file_name":"ox-urlatt-redir.py","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/dR4it4pi2S5TgkSdSqmgBBmj?response-content-disposition=attachment%3B%20filename%3D%22ox-urlatt-redir.py%22%3B%20filename%2A%3DUTF-8%27%27ox-urlatt-redir.py\u0026response-content-type=text%2Fx-python\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ3Q6GNRX4%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T064427Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ7%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIB%2F4DOSXz4Uk7JQqVyIKOhXYFqWTxcD44Z3HdHcn0dvKAiEA3PYdLzeI5Kv3E9WFbSVqd%2BUBlw0212Xg7H3tNiixN5gqtAMIVxABGgwwMTM2MTkyNzQ4NDkiDIUObNP5fEX8bJXBsSqRA%2BL7Z0plmhSxsMHnrb83ftPuhWkgvNoQbpQ66ErJF8Tab4HbvnqeuplpQgE7hhKtqBYOEsdafEq0r9zNmqA7m92b%2BxDq63GNbNVm2hS%2FrGlDOjkNPC4s9Y9jvsKbOyEaodYyGTaNp7nXzoPtsVsXWu3VzjV5rY1%2FOniQ2%2B1s8ySEdTjZaRHk8P%2FwXbNfsl1hT2TAe2rleD%2BZ%2BVAaUzHyFNU%2F1mQkQNOozyUs%2B0kWyLXo4oDuk2v6G%2B%2B%2BOffGDFiu%2F5vFGTwCcw9LcpG50TBnwx2MYUfVFlGDhzFRqqeFnE8%2BVLdMRhVxgbXYhePjinuq12WCpDVAhCJNj8IR3wEJ1%2FQoonHq3u3s4Fjef1%2Bw%2BXtypskg56dqBrrGLe95zM0RechJC4u4kZN3x7RKFnUe%2BQTgA2fsU4g%2FeYbY51bNGPKZw3ELWdMZpvEwvawS7vQJcERLBBN%2FFBpdyPI7tU9GTieNVwCAMdziMkUN3bUc%2BsG8%2BbAIpsp1R0fqA4Zzh1fBBmHnAwvAA0nggtgLe0MkU7v1MNiFq%2F8FOusBRvYvRZdkMedUg2M4tNHIP5rUiGXbyy3g4wRqI3QxmX%2FtfXzpLdSUg3BMdPDmPj8jrIy0bzAIMzEhANIb5ri2Nz0%2FfFqmnJ3rjk8e005Fnv5uK088J0m7HFCYIe7hgj40pmM5UNmkGs30hxAnycAlyRaDL94ttdw5SqAS%2FW4MMrRVIliym5o9kruL0SoyWZC0kQciksSypgYXswzm%2BAeZve49Cnzr6ikwTN3S7tncfj0WMJznDG890QvBL3O7QjntIQ6Hf9oANAQjphy38wZSi3%2FB45i5bX5Kr2E9NKFLEy5UWui5G%2BmfVfaVyg%3D%3D\u0026X-Amz-Signature=9a627f21e78ff641a104b1b2c1e60b76f81f1e225b010a6a31813261260d675b","file_size":3026,"type":"text/x-python"}],"allow_singular_disclosure_at":null,"vote_count":36,"voters":["a_d_a_m","ibruteforce","alexeypetrenko","mygf","an0nym0us","realtess","nessun00x","cyberunit","st00rm","cryptographer","and 26 more..."],"severity":{"rating":"medium","author_type":"User"},"structured_scope":{"databaseId":551,"asset_type":"URL","asset_identifier":"sandbox.open-xchange.com","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":6302806,"is_internal":false,"editable":false,"type":"Activities::BugInformative","message":"Hi, the fix for #725307 is not deployed to sandbox.open-xchange.com yet.","markdown_message":"\u003cp\u003eHi, the fix for \u003ca href=\"/reports/725307\"\u003e#725307\u003c/a\u003e is not deployed to sandbox.open-xchange.com yet.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-11-14T07:04:00.341Z","updated_at":"2019-11-14T07:04:00.341Z","actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6305524,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hello,\n\nit was fixed in this commit [17effeda5c37ebc0eaa936a0fcca5df8cee81f7f](https://gitlab.open-xchange.com/middleware/core/commit/17effeda5c37ebc0eaa936a0fcca5df8cee81f7f)\n*Fix for Bug #67871: Added protocol whitelist and host blacklist.*\n\nWhich was soon after my bug report and without further activity since then, presumably considered complete.\n\nVersion on sandbox is `7.10.3 Rev0 (2019-11-04)` which indeed does contain this fix and is bypassable as I described here.\n","markdown_message":"\u003cp\u003eHello,\u003c/p\u003e\n\n\u003cp\u003eit was fixed in this commit \u003ca href=\"/redirect?url=https%3A%2F%2Fgitlab.open-xchange.com%2Fmiddleware%2Fcore%2Fcommit%2F17effeda5c37ebc0eaa936a0fcca5df8cee81f7f\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003e17effeda5c37ebc0eaa936a0fcca5df8cee81f7f\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003cbr\u003e\n\u003cem\u003eFix for Bug \u003ca href=\"/reports/67871\"\u003e#67871\u003c/a\u003e: Added protocol whitelist and host blacklist.\u003c/em\u003e\u003c/p\u003e\n\n\u003cp\u003eWhich was soon after my bug report and without further activity since then, presumably considered complete.\u003c/p\u003e\n\n\u003cp\u003eVersion on sandbox is \u003ccode\u003e7.10.3 Rev0 (2019-11-04)\u003c/code\u003e which indeed does contain this fix and is bypassable as I described here.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-11-14T14:27:21.937Z","updated_at":"2019-11-14T14:27:21.937Z","actor":{"username":"zhutyra","cleared":false,"url":"/zhutyra","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":6313326,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I'm sorry, indeed someone has updated sandbox with development code.","markdown_message":"\u003cp\u003eI\u0026#39;m sorry, indeed someone has updated sandbox with development code.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-11-15T09:09:30.074Z","updated_at":"2019-11-15T09:09:30.074Z","actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6313327,"is_internal":false,"editable":false,"type":"Activities::BugReopened","message":"","markdown_message":"","automated_response":false,"created_at":"2019-11-15T09:09:37.701Z","updated_at":"2019-11-15T09:09:37.701Z","actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6313521,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2019-11-15T09:23:54.884Z","updated_at":"2019-11-15T09:23:54.884Z","actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6353557,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"We solved this vulnerability internally and will provide a backport to in-production releases during the next weeks.\n\nWe're in the process of transferring funds to H1 to provide your compensation, please stand by.","markdown_message":"\u003cp\u003eWe solved this vulnerability internally and will provide a backport to in-production releases during the next weeks.\u003c/p\u003e\n\n\u003cp\u003eWe\u0026#39;re in the process of transferring funds to H1 to provide your compensation, please stand by.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-11-20T07:33:45.581Z","updated_at":"2019-11-20T07:33:45.581Z","actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"zhutyra","url":"/zhutyra"},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6419956,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2019-11-27T11:31:20.597Z","updated_at":"2019-11-27T11:31:20.597Z","actor":{"url":"/open-xchange","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/JtYLEsu5yRZxGitSmAjeAFtK/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Open-Xchange"}},"bounty_amount":"400.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"open-xchange","collaborator":{"username":"zhutyra","url":"/zhutyra"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6423125,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for the bounty.","markdown_message":"\u003cp\u003eThank you for the bounty.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-11-27T16:52:01.349Z","updated_at":"2019-11-27T16:52:01.349Z","actor":{"username":"zhutyra","cleared":false,"url":"/zhutyra","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7090502,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-02-19T13:41:13.603Z","updated_at":"2020-02-19T13:41:13.603Z","first_to_agree":true,"actor":{"username":"mheiland","cleared":false,"url":"/mheiland","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/425JKsXEnCYsDU1VA48SXXZV/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7098993,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hello,\n\nI looked at it and I would note that redirects can be to relative URLs which should be resolved to full URLs and that a limit on number of redirects might be a good idea.\n\nBut the SSRF is fixed.","markdown_message":"\u003cp\u003eHello,\u003c/p\u003e\n\n\u003cp\u003eI looked at it and I would note that redirects can be to relative URLs which should be resolved to full URLs and that a limit on number of redirects might be a good idea.\u003c/p\u003e\n\n\u003cp\u003eBut the SSRF is fixed.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-02-20T10:45:57.521Z","updated_at":"2020-02-20T10:45:57.521Z","actor":{"username":"zhutyra","cleared":false,"url":"/zhutyra","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7098996,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-02-20T10:46:12.852Z","updated_at":"2020-02-20T10:46:12.852Z","actor":{"username":"zhutyra","cleared":false,"url":"/zhutyra","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7098997,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-02-20T10:46:12.889Z","updated_at":"2020-02-20T10:46:12.889Z","actor":{"username":"zhutyra","cleared":false,"url":"/zhutyra","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}