{"id":227762,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yMjc3NjI=","url":"https://hackerone.com/reports/227762","title":"Heap Overflow in fiber_switch triggered from Fiber.transfer","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2017-05-11T18:53:52.394Z","submitted_at":"2017-05-11T18:53:52.394Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"avisaven","url":"/avisaven","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":15668,"url":"https://hackerone.com/shopify-scripts","handle":"shopify-scripts","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"shopify-scripts","twitter_handle":"","website":"","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2017-05-30T14:37:06.630Z","bug_reporter_agreed_on_going_public_at":"2017-05-30T02:26:25.564Z","team_member_agreed_on_going_public_at":"2017-05-30T14:37:06.530Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"It appears as if my recommendations were ignored in the GitHub issue, so I've repeated the issue here.\n\n# PoC\n\n\tFiber.new{}.transfer(\n\t\t0,0,0,0,0,0,0,0,0,0,\n\t\t0,0,0,0,0,0,0,0,0,0,\n\t\t0,0,0,0,0,0,0,0,0,0,\n\t\t0,0,0,0,0,0,0,0,0,0,\n\t\t0,0,0,0,0,0,0,0,0,0,\n\t\t0,0,0,0,0,0,0,0,0,0,\n\t\t0,0,0,0,0)\n\n# Explanation\nThe cause of this is that in mrbgems/mruby-fiber/src/fiber.c the stack Fiber stack is initialized lines 90-96 to a default of 64 (FIBER_STACK_INIT_SIZE), however in fiber_switch lines 191-198, if the Fiber's status is currently MRB_FIBER_CREATED, then it will copy the arguments provided from fiber_transfer irregardless of whether or not there are more arguments than 64 (the PoC doesn't need ~127 arguments, anything 64 or above will work!). The quick fix would be to make sure that theres not more than 64 arguments passed to fiber_transfer.\n\n# Solution\n\n\tdiff --git a/mrbgems/mruby-fiber/src/fiber.c b/mrbgems/mruby-fiber/src/fiber.c\n\tindex bd1d09d4..2d0fc39a 100644\n\t--- a/mrbgems/mruby-fiber/src/fiber.c\n\t+++ b/mrbgems/mruby-fiber/src/fiber.c\n\t@@ -188,6 +188,9 @@ fiber_switch(mrb_state *mrb, mrb_value self, mrb_int len, const mrb_value *a, mr\n\t   mrb-\u003ec-\u003estatus = resume ? MRB_FIBER_RESUMED : MRB_FIBER_TRANSFERRED;\n\t   c-\u003eprev = resume ? mrb-\u003ec : (c-\u003eprev ? c-\u003eprev : mrb-\u003eroot_c);\n\t   if (c-\u003estatus == MRB_FIBER_CREATED) {\n\t+    if (len \u003e= FIBER_STACK_INIT_SIZE) {\n\t+      mrb_raise(mrb, E_FIBER_ERROR, \"too many arguments to fiber\");\n\t+    }\n\t     mrb_value *b = c-\u003estack+1;\n\t     mrb_value *e = b + len;","vulnerability_information_html":"\u003cp\u003eIt appears as if my recommendations were ignored in the GitHub issue, so I\u0026#39;ve repeated the issue here.\u003c/p\u003e\n\n\u003ch1 id=\"poc\"\u003ePoC\u003c/h1\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eFiber.new{}.transfer(\n    0,0,0,0,0,0,0,0,0,0,\n    0,0,0,0,0,0,0,0,0,0,\n    0,0,0,0,0,0,0,0,0,0,\n    0,0,0,0,0,0,0,0,0,0,\n    0,0,0,0,0,0,0,0,0,0,\n    0,0,0,0,0,0,0,0,0,0,\n    0,0,0,0,0)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch1 id=\"explanation\"\u003eExplanation\u003c/h1\u003e\n\n\u003cp\u003eThe cause of this is that in mrbgems/mruby-fiber/src/fiber.c the stack Fiber stack is initialized lines 90-96 to a default of 64 (FIBER_STACK_INIT_SIZE), however in fiber_switch lines 191-198, if the Fiber\u0026#39;s status is currently MRB_FIBER_CREATED, then it will copy the arguments provided from fiber_transfer irregardless of whether or not there are more arguments than 64 (the PoC doesn\u0026#39;t need ~127 arguments, anything 64 or above will work!). The quick fix would be to make sure that theres not more than 64 arguments passed to fiber_transfer.\u003c/p\u003e\n\n\u003ch1 id=\"solution\"\u003eSolution\u003c/h1\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight diff\"\u003e\u003ccode\u003e\u003cspan class=\"gh\"\u003ediff --git a/mrbgems/mruby-fiber/src/fiber.c b/mrbgems/mruby-fiber/src/fiber.c\nindex bd1d09d4..2d0fc39a 100644\n\u003c/span\u003e\u003cspan class=\"gd\"\u003e--- a/mrbgems/mruby-fiber/src/fiber.c\n\u003c/span\u003e\u003cspan class=\"gi\"\u003e+++ b/mrbgems/mruby-fiber/src/fiber.c\n\u003c/span\u003e\u003cspan class=\"p\"\u003e@@ -188,6 +188,9 @@\u003c/span\u003e fiber_switch(mrb_state *mrb, mrb_value self, mrb_int len, const mrb_value *a, mr\n   mrb-\u0026gt;c-\u0026gt;status = resume ? MRB_FIBER_RESUMED : MRB_FIBER_TRANSFERRED;\n   c-\u0026gt;prev = resume ? mrb-\u0026gt;c : (c-\u0026gt;prev ? c-\u0026gt;prev : mrb-\u0026gt;root_c);\n   if (c-\u0026gt;status == MRB_FIBER_CREATED) {\n\u003cspan class=\"gi\"\u003e+    if (len \u0026gt;= FIBER_STACK_INIT_SIZE) {\n+      mrb_raise(mrb, E_FIBER_ERROR, \u0026quot;too many arguments to fiber\u0026quot;);\n+    }\n\u003c/span\u003e     mrb_value *b = c-\u0026gt;stack+1;\n     mrb_value *e = b + len;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","bounty_amount":"100.0","formatted_bounty":"$100","weakness":{"id":5,"name":"Heap Overflow"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-06-29T02:26:25.621Z","allow_singular_disclosure_after":-110515020.31274769,"singular_disclosure_allowed":true,"vote_count":3,"voters":["eveeez","0xspade","spetr0x"],"severity":{"rating":"high","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1668749,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for reporting this bug! This is an automated response to let you know that we've received your issue, and we'll process it as soon as possible.\n\nDue to the large volume of reports we have received, it may take us up to two weeks to respond. Thank you for your patience!","markdown_message":"\u003cp\u003eThank you for reporting this bug! This is an automated response to let you know that we\u0026#39;ve received your issue, and we\u0026#39;ll process it as soon as possible.\u003c/p\u003e\n\n\u003cp\u003eDue to the large volume of reports we have received, it may take us up to two weeks to respond. Thank you for your patience!\u003c/p\u003e\n","automated_response":true,"created_at":"2017-05-11T18:53:52.552Z","updated_at":"2017-05-11T18:53:52.552Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"shopify-scripts"}},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1668954,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thank you for your report.\n\nThe MRuby maintainers haven't worked on the project much over the past couple weeks, so it could be they're busy with other things. Hopefully they will respond to your comments soon. In the meantime I'll triage your report here. Since you've added some useful analysis and a proposed fix, we may consider splitting the reward with the original reporter once a fix is in place.","markdown_message":"\u003cp\u003eThank you for your report.\u003c/p\u003e\n\n\u003cp\u003eThe MRuby maintainers haven\u0026#39;t worked on the project much over the past couple weeks, so it could be they\u0026#39;re busy with other things. Hopefully they will respond to your comments soon. In the meantime I\u0026#39;ll triage your report here. Since you\u0026#39;ve added some useful analysis and a proposed fix, we may consider splitting the reward with the original reporter once a fix is in place.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-05-11T20:33:22.700Z","updated_at":"2017-05-11T20:33:22.700Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1701216,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thanks again for tracking down the root cause and proposing a fix. As you probably already saw, the MRuby project implemented a fix similar to your proposed patch:\n\nhttps://github.com/mruby/mruby/commit/ac442bc1df2ec26729077ed8d57342cb5c494a21\nhttps://github.com/mruby/mruby/commit/7e4731655fecd953d3a5f8830267be6e79ab3b00\n\nOur next round of bounty decisions will take place within two weeks, so we'll be in touch with you again soon.","markdown_message":"\u003cp\u003eThanks again for tracking down the root cause and proposing a fix. As you probably already saw, the MRuby project implemented a fix similar to your proposed patch:\u003c/p\u003e\n\n\u003cp\u003e\u003ca title=\"https://github.com/mruby/mruby/commit/ac442bc1df2ec26729077ed8d57342cb5c494a21\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fmruby%2Fmruby%2Fcommit%2Fac442bc1df2ec26729077ed8d57342cb5c494a21\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/mruby/mruby/commit/ac442bc1df2ec26729077ed8d57342cb5c494a21\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003cbr\u003e\n\u003ca title=\"https://github.com/mruby/mruby/commit/7e4731655fecd953d3a5f8830267be6e79ab3b00\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fmruby%2Fmruby%2Fcommit%2F7e4731655fecd953d3a5f8830267be6e79ab3b00\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/mruby/mruby/commit/7e4731655fecd953d3a5f8830267be6e79ab3b00\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eOur next round of bounty decisions will take place within two weeks, so we\u0026#39;ll be in touch with you again soon.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-05-25T17:18:20.525Z","updated_at":"2017-05-25T17:18:20.525Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"avisaven","url":"/avisaven"},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1708029,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks for helping improve the security of Shopify!","markdown_message":"\u003cp\u003eThanks for helping improve the security of Shopify!\u003c/p\u003e\n","automated_response":false,"created_at":"2017-05-29T19:22:10.219Z","updated_at":"2017-05-29T19:22:10.219Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"shopify-scripts"}},"bounty_amount":"100.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"shopify-scripts","collaborator":{"username":"avisaven","url":"/avisaven"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1708440,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-05-30T02:26:25.586Z","updated_at":"2017-05-30T02:26:25.586Z","first_to_agree":true,"actor":{"username":"avisaven","cleared":false,"url":"/avisaven","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1709656,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-05-30T14:37:06.589Z","updated_at":"2017-05-30T14:37:06.589Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1709657,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-05-30T14:37:06.647Z","updated_at":"2017-05-30T14:37:06.647Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1709670,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Awesome! Thanks so much for everything!","markdown_message":"\u003cp\u003eAwesome! Thanks so much for everything!\u003c/p\u003e\n","automated_response":false,"created_at":"2017-05-30T14:38:46.081Z","updated_at":"2017-05-30T14:38:46.081Z","actor":{"username":"avisaven","cleared":false,"url":"/avisaven","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}