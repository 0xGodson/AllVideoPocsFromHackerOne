{"id":167888,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xNjc4ODg=","url":"https://hackerone.com/reports/167888","title":"Uninitialized Thumbail Data Leads To Memory Leakage in exif_process_IFD_in_TIFF","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2016-09-13T03:12:37.859Z","submitted_at":"2016-09-13T03:12:37.859Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"hoangnguyen","url":"/hoangnguyen","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/074/688/42c5ca5265ff965283d70fc52df2681dfd648d44_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":29,"url":"https://hackerone.com/ibb-php","handle":"ibb-php","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/029/99087dbbdf52fc3ce3acbf16aa33a5c4f5e2c111_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/029/99087dbbdf52fc3ce3acbf16aa33a5c4f5e2c111_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"PHP (IBB)","twitter_handle":"","website":"http://www.php.net","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2019-11-12T09:27:23.211Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2019-10-13T09:27:14.740Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"I found other code chunk that leads to memory leakage.\n```\n\texif_process_IFD_in_TIFF(ImageInfo, entry_offset, sub_section_index);\n\tif (section_index!=SECTION_THUMBNAIL \u0026\u0026 entry_tag==TAG_SUB_IFD) {\n\t\tif (ImageInfo-\u003eThumbnail.filetype != IMAGE_FILETYPE_UNKNOWN\n\t\t\u0026\u0026  ImageInfo-\u003eThumbnail.size\n\t\t\u0026\u0026  ImageInfo-\u003eThumbnail.offset\n\t\t\u0026\u0026  ImageInfo-\u003eread_thumbnail\n\t\t) {\n#ifdef EXIF_DEBUG\n\t\t\texif_error_docref(NULL EXIFERR_CC, ImageInfo, E_NOTICE, \"%s THUMBNAIL @0x%04X + 0x%04X\", ImageInfo-\u003eThumbnail.data ? \"Ignore\" : \"Read\", ImageInfo-\u003eThumbnail.offset, ImageInfo-\u003eThumbnail.size);\n#endif\n\t\t\tif (!ImageInfo-\u003eThumbnail.data) {\n\t\t\t\tImageInfo-\u003eThumbnail.data = safe_emalloc(ImageInfo-\u003eThumbnail.size, 1, 0);\n\t\t\t\tphp_stream_seek(ImageInfo-\u003einfile, ImageInfo-\u003eThumbnail.offset, SEEK_SET);\n\t\t\t\tfgot = php_stream_read(ImageInfo-\u003einfile, ImageInfo-\u003eThumbnail.data, ImageInfo-\u003eThumbnail.size);\n\t\t\t\tif (fgot \u003c ImageInfo-\u003eThumbnail.size) {\n\t\t\t\t\tEXIF_ERRLOG_THUMBEOF(ImageInfo)\n\t\t\t\t}\n\t\t\t\texif_thumbnail_build(ImageInfo);\n\t\t\t}\n\t\t}\n\t}\n```\nAs you can see this code is processing SUB_IFD_TAG and not verify offset of Thumbnail data. Because lack of checking ImageInfo-\u003eThumbnail.offset if an attack set ImageInfo-\u003eThumbnail.offset larger than ImageInfo-\u003eFileSize then *php_stream_read* return 0 to fgot, because  EXIF_ERRLOG_THUMBEOF was defined as : \n```\n#define EXIF_ERRLOG_THUMBEOF(ImageInfo)   exif_error_docref(NULL EXIFERR_CC, ImageInfo, E_WARNING, \"%s\", EXIF_ERROR_THUMBEOF);\n\n```\nAs you can see there is no exit after this error is output.\n\nThis bug does same problem with this bug i reported before https://bugs.php.net/bug.php?id=72627\n\nHere tiff file : https://drive.google.com/file/d/0B0D1DYQpkA9USUt4c2ZBT21SWE0/view?usp=sharing\n\nBug here : https://bugs.php.net/bug.php?id=72926","vulnerability_information_html":"\u003cp\u003eI found other code chunk that leads to memory leakage.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e    exif_process_IFD_in_TIFF(ImageInfo, entry_offset, sub_section_index);\n    if (section_index!=SECTION_THUMBNAIL \u0026amp;\u0026amp; entry_tag==TAG_SUB_IFD) {\n        if (ImageInfo-\u0026gt;Thumbnail.filetype != IMAGE_FILETYPE_UNKNOWN\n        \u0026amp;\u0026amp;  ImageInfo-\u0026gt;Thumbnail.size\n        \u0026amp;\u0026amp;  ImageInfo-\u0026gt;Thumbnail.offset\n        \u0026amp;\u0026amp;  ImageInfo-\u0026gt;read_thumbnail\n        ) {\n#ifdef EXIF_DEBUG\n            exif_error_docref(NULL EXIFERR_CC, ImageInfo, E_NOTICE, \u0026quot;%s THUMBNAIL @0x%04X + 0x%04X\u0026quot;, ImageInfo-\u0026gt;Thumbnail.data ? \u0026quot;Ignore\u0026quot; : \u0026quot;Read\u0026quot;, ImageInfo-\u0026gt;Thumbnail.offset, ImageInfo-\u0026gt;Thumbnail.size);\n#endif\n            if (!ImageInfo-\u0026gt;Thumbnail.data) {\n                ImageInfo-\u0026gt;Thumbnail.data = safe_emalloc(ImageInfo-\u0026gt;Thumbnail.size, 1, 0);\n                php_stream_seek(ImageInfo-\u0026gt;infile, ImageInfo-\u0026gt;Thumbnail.offset, SEEK_SET);\n                fgot = php_stream_read(ImageInfo-\u0026gt;infile, ImageInfo-\u0026gt;Thumbnail.data, ImageInfo-\u0026gt;Thumbnail.size);\n                if (fgot \u0026lt; ImageInfo-\u0026gt;Thumbnail.size) {\n                    EXIF_ERRLOG_THUMBEOF(ImageInfo)\n                }\n                exif_thumbnail_build(ImageInfo);\n            }\n        }\n    }\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAs you can see this code is processing SUB_IFD_TAG and not verify offset of Thumbnail data. Because lack of checking ImageInfo-\u0026gt;Thumbnail.offset if an attack set ImageInfo-\u0026gt;Thumbnail.offset larger than ImageInfo-\u0026gt;FileSize then \u003cem\u003ephp_stream_read\u003c/em\u003e return 0 to fgot, because  EXIF_ERRLOG_THUMBEOF was defined as : \u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e#define EXIF_ERRLOG_THUMBEOF(ImageInfo)   exif_error_docref(NULL EXIFERR_CC, ImageInfo, E_WARNING, \u0026quot;%s\u0026quot;, EXIF_ERROR_THUMBEOF);\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAs you can see there is no exit after this error is output.\u003c/p\u003e\n\n\u003cp\u003eThis bug does same problem with this bug i reported before \u003ca title=\"https://bugs.php.net/bug.php?id=72627\" href=\"/redirect?url=https%3A%2F%2Fbugs.php.net%2Fbug.php%3Fid%3D72627\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://bugs.php.net/bug.php?id=72627\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eHere tiff file : \u003ca title=\"https://drive.google.com/file/d/0B0D1DYQpkA9USUt4c2ZBT21SWE0/view?usp=sharing\" href=\"/redirect?url=https%3A%2F%2Fdrive.google.com%2Ffile%2Fd%2F0B0D1DYQpkA9USUt4c2ZBT21SWE0%2Fview%3Fusp%3Dsharing\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://drive.google.com/file/d/0B0D1DYQpkA9USUt4c2ZBT21SWE0/view?usp=sharing\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eBug here : \u003ca title=\"https://bugs.php.net/bug.php?id=72926\" href=\"/redirect?url=https%3A%2F%2Fbugs.php.net%2Fbug.php%3Fid%3D72926\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://bugs.php.net/bug.php?id=72926\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n","bounty_amount":"1000.0","formatted_bounty":"$1,000","weakness":{"id":2,"name":"Memory Corruption - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2019-11-12T09:27:14.809Z","allow_singular_disclosure_after":-35665952.39315434,"singular_disclosure_allowed":true,"vote_count":5,"voters":["geeknik","dyabla","aloloha","shredit","gsanskar"],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1205759,"is_internal":false,"editable":false,"type":"Activities::BugDuplicate","message":"","markdown_message":"","automated_response":false,"created_at":"2016-09-20T04:36:56.495Z","updated_at":"2016-09-20T04:36:56.495Z","original_report_id":160294,"actor":{"username":"arice","cleared":false,"url":"/arice","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/83152cb2d070f3f6a63c1b61bae47257722b5ad2_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"ibb-php","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1206368,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"this bug is difference with #160294, pls read carefully :)","markdown_message":"\u003cp\u003ethis bug is difference with \u003ca href=\"/reports/160294\"\u003e#160294\u003c/a\u003e, pls read carefully :)\u003c/p\u003e\n","automated_response":false,"created_at":"2016-09-20T09:51:43.358Z","updated_at":"2016-09-20T09:51:43.358Z","actor":{"username":"hoangnguyen","cleared":false,"url":"/hoangnguyen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/074/688/42c5ca5265ff965283d70fc52df2681dfd648d44_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"ibb-php","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1206376,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@arice can you read this bug care fully, this bug is the same with #160294 but occurred in difference place ","markdown_message":"\u003cp\u003e\u003ca href=\"/arice\"\u003e@arice\u003c/a\u003e can you read this bug care fully, this bug is the same with \u003ca href=\"/reports/160294\"\u003e#160294\u003c/a\u003e but occurred in difference place \u003c/p\u003e\n","automated_response":false,"created_at":"2016-09-20T09:55:02.512Z","updated_at":"2016-09-20T09:55:02.512Z","actor":{"username":"hoangnguyen","cleared":false,"url":"/hoangnguyen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/074/688/42c5ca5265ff965283d70fc52df2681dfd648d44_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"ibb-php","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1210083,"is_internal":false,"editable":false,"type":"Activities::HackerRequestedMediation","message":"I think my bug #167888 is different with bug #160294\n- The code path to hit vulnerability  #160294 is the processing tag IFD_Thumbnail\n- The code path to reach vulnerability #167888 is an other code path, which is process TAG_SUB_IFD (an other TIFF TAG)\n- If you look at this 2 patch:\n    + https://github.com/php/php-src/commit/a2fdf0f4135f5a29e613c1c6c53d378dc6ff7bed for bug #167888 it patched 17 days ago, right after i reported bug #167888\n   + https://gist.github.com/anonymous/99b4cc71096d54075cf1cc91caf3266e for bug #160294 is patched a month ago, this patch is not cover bug #167888.\n\nFor more details please read this link: https://bugs.php.net/bug.php?id=72926 PHP project manager agree with me that this bug #167888 is not #160294 and assign this bug is SecBug\n","markdown_message":"\u003cp\u003eI think my bug \u003ca href=\"/reports/167888\"\u003e#167888\u003c/a\u003e is different with bug \u003ca href=\"/reports/160294\"\u003e#160294\u003c/a\u003e\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eThe code path to hit vulnerability  \u003ca href=\"/reports/160294\"\u003e#160294\u003c/a\u003e is the processing tag IFD_Thumbnail\u003c/li\u003e\n\u003cli\u003eThe code path to reach vulnerability \u003ca href=\"/reports/167888\"\u003e#167888\u003c/a\u003e is an other code path, which is process TAG_SUB_IFD (an other TIFF TAG)\u003c/li\u003e\n\u003cli\u003eIf you look at this 2 patch:\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ca title=\"https://github.com/php/php-src/commit/a2fdf0f4135f5a29e613c1c6c53d378dc6ff7bed\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fphp%2Fphp-src%2Fcommit%2Fa2fdf0f4135f5a29e613c1c6c53d378dc6ff7bed\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/php/php-src/commit/a2fdf0f4135f5a29e613c1c6c53d378dc6ff7bed\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e for bug \u003ca href=\"/reports/167888\"\u003e#167888\u003c/a\u003e it patched 17 days ago, right after i reported bug \u003ca href=\"/reports/167888\"\u003e#167888\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca title=\"https://gist.github.com/anonymous/99b4cc71096d54075cf1cc91caf3266e\" href=\"/redirect?url=https%3A%2F%2Fgist.github.com%2Fanonymous%2F99b4cc71096d54075cf1cc91caf3266e\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://gist.github.com/anonymous/99b4cc71096d54075cf1cc91caf3266e\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e for bug \u003ca href=\"/reports/160294\"\u003e#160294\u003c/a\u003e is patched a month ago, this patch is not cover bug \u003ca href=\"/reports/167888\"\u003e#167888\u003c/a\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eFor more details please read this link: \u003ca title=\"https://bugs.php.net/bug.php?id=72926\" href=\"/redirect?url=https%3A%2F%2Fbugs.php.net%2Fbug.php%3Fid%3D72926\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://bugs.php.net/bug.php?id=72926\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e PHP project manager agree with me that this bug \u003ca href=\"/reports/167888\"\u003e#167888\u003c/a\u003e is not \u003ca href=\"/reports/160294\"\u003e#160294\u003c/a\u003e and assign this bug is SecBug\u003c/p\u003e\n","automated_response":false,"created_at":"2016-09-22T02:22:58.043Z","updated_at":"2016-09-22T02:22:58.043Z","actor":{"username":"hoangnguyen","cleared":false,"url":"/hoangnguyen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/074/688/42c5ca5265ff965283d70fc52df2681dfd648d44_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"ibb-php","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1213548,"is_internal":false,"editable":false,"type":"Activities::BugReopened","message":"","markdown_message":"","automated_response":false,"created_at":"2016-09-23T23:09:32.956Z","updated_at":"2016-09-23T23:09:32.956Z","actor":{"username":"arice","cleared":false,"url":"/arice","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/83152cb2d070f3f6a63c1b61bae47257722b5ad2_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"ibb-php","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1213549,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thanks for the updated information! Sorry for missing that the first time.","markdown_message":"\u003cp\u003eThanks for the updated information! Sorry for missing that the first time.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-09-23T23:09:56.133Z","updated_at":"2016-09-23T23:09:56.133Z","actor":{"username":"arice","cleared":false,"url":"/arice","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/020/83152cb2d070f3f6a63c1b61bae47257722b5ad2_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"reporter":{"username":"hoangnguyen","url":"/hoangnguyen"},"genius_execution_id":null,"team_handle":"ibb-php","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1213550,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2016-09-23T23:10:05.046Z","updated_at":"2016-09-23T23:10:05.046Z","actor":{"url":"/ibb-php","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/029/99087dbbdf52fc3ce3acbf16aa33a5c4f5e2c111_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"PHP (IBB)"}},"bounty_amount":"1000.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"ibb-php","collaborator":{"username":"hoangnguyen","url":"/hoangnguyen"},"actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1213613,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"thank you","markdown_message":"\u003cp\u003ethank you\u003c/p\u003e\n","automated_response":false,"created_at":"2016-09-24T00:54:24.368Z","updated_at":"2016-09-24T00:54:24.368Z","actor":{"username":"hoangnguyen","cleared":false,"url":"/hoangnguyen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/074/688/42c5ca5265ff965283d70fc52df2681dfd648d44_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"ibb-php","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":6026106,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2019-10-13T09:27:14.754Z","updated_at":"2019-10-13T09:27:14.754Z","first_to_agree":true,"actor":{"username":"reed","cleared":false,"url":"/reed","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/132/66d7eadcea16b878bb67bfd697b9542250a801a7_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"ibb-php","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6285742,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2019-11-12T09:27:23.226Z","updated_at":"2019-11-12T09:27:23.226Z","actor":{"url":"/ibb-php","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/029/99087dbbdf52fc3ce3acbf16aa33a5c4f5e2c111_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"PHP (IBB)"}},"genius_execution_id":null,"team_handle":"ibb-php","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}