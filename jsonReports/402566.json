{"id":402566,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC80MDI1NjY=","url":"https://hackerone.com/reports/402566","title":"[Half-Life 1] Malformed map name leads to memory corruption and code execution","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2018-08-29T21:36:13.687Z","submitted_at":"2018-08-29T21:36:13.687Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"kbeckmann","url":"/kbeckmann","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/063/948/e64cb44a81518d1cb14f48de27af5fa01d9c5c37_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":23363,"url":"https://hackerone.com/valve","handle":"valve","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/023/363/c78d46a7d0ea39e3a15a7c19c1a48634f2571eb9_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/023/363/c78d46a7d0ea39e3a15a7c19c1a48634f2571eb9_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Valve","twitter_handle":"","website":"https://www.valvesoftware.com","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"no-content","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2020-09-22T17:28:14.792Z","bug_reporter_agreed_on_going_public_at":"2020-09-21T15:21:21.676Z","team_member_agreed_on_going_public_at":"2020-09-22T17:28:14.655Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"","vulnerability_information_html":"","bounty_amount":"1500.0","formatted_bounty":"$1,500","weakness":{"id":3,"name":"Classic Buffer Overflow"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":156,"voters":["xdms","njbooher","xparrot","pyrrhon","moloshy","gamer7112","foobar7","mvc","xnutronex","kapkan","and 146 more..."],"severity":{"rating":"high","author_type":"Team"},"structured_scope":{"databaseId":1289,"asset_type":"DOWNLOADABLE_EXECUTABLES","asset_identifier":"hl.exe","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":3266237,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2018-08-29T22:10:58.512Z","updated_at":"2018-08-29T22:10:58.512Z","actor":{"username":"kbeckmann","cleared":false,"url":"/kbeckmann","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/063/948/e64cb44a81518d1cb14f48de27af5fa01d9c5c37_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3266246,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2018-08-29T22:13:06.792Z","updated_at":"2018-08-29T22:13:06.792Z","actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3266371,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2018-08-29T23:01:02.441Z","updated_at":"2018-08-29T23:01:02.441Z","actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3266372,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","markdown_message":"","automated_response":false,"created_at":"2018-08-29T23:01:07.414Z","updated_at":"2018-08-29T23:01:07.414Z","additional_data":{},"actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3266426,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2018-08-29T23:23:30.040Z","updated_at":"2018-08-29T23:23:30.040Z","actor":{"username":"kbeckmann","cleared":false,"url":"/kbeckmann","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/063/948/e64cb44a81518d1cb14f48de27af5fa01d9c5c37_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3277558,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2018-08-31T22:37:15.457Z","updated_at":"2018-08-31T22:37:15.457Z","actor":{"username":"kbeckmann","cleared":false,"url":"/kbeckmann","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/063/948/e64cb44a81518d1cb14f48de27af5fa01d9c5c37_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3341335,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2018-09-15T10:04:30.508Z","updated_at":"2018-09-15T10:04:30.508Z","actor":{"username":"kbeckmann","cleared":false,"url":"/kbeckmann","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/063/948/e64cb44a81518d1cb14f48de27af5fa01d9c5c37_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3779594,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2018-12-06T20:55:09.969Z","updated_at":"2018-12-06T20:55:09.969Z","actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3988552,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2019-01-16T18:59:03.120Z","updated_at":"2019-01-16T18:59:03.120Z","actor":{"username":"kbeckmann","cleared":false,"url":"/kbeckmann","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/063/948/e64cb44a81518d1cb14f48de27af5fa01d9c5c37_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4116848,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2019-02-08T19:46:40.888Z","updated_at":"2019-02-08T19:46:40.888Z","actor":{"url":"/valve","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/023/363/c78d46a7d0ea39e3a15a7c19c1a48634f2571eb9_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Valve"}},"bounty_amount":"1500.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"valve","collaborator":{"username":"kbeckmann","url":"/kbeckmann"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4116996,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2019-02-08T20:21:17.829Z","updated_at":"2019-02-08T20:21:17.829Z","actor":{"username":"kbeckmann","cleared":false,"url":"/kbeckmann","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/063/948/e64cb44a81518d1cb14f48de27af5fa01d9c5c37_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4284530,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2019-03-08T10:03:38.800Z","updated_at":"2019-03-08T10:03:38.800Z","actor":{"username":"nasr0x01","cleared":false,"url":"/nasr0x01","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/386/674/ec2e2c825a554851c42c122ffd61aa8f18b08174_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4482999,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","markdown_message":"","automated_response":false,"created_at":"2019-04-05T00:41:54.297Z","updated_at":"2019-04-05T00:41:54.297Z","actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"kbeckmann","url":"/kbeckmann"},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9279305,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-09-21T15:21:21.709Z","updated_at":"2020-09-21T15:21:21.709Z","first_to_agree":true,"actor":{"username":"kbeckmann","cleared":false,"url":"/kbeckmann","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/063/948/e64cb44a81518d1cb14f48de27af5fa01d9c5c37_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":9296638,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-09-22T17:28:14.677Z","updated_at":"2020-09-22T17:28:14.677Z","actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":9296639,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-09-22T17:28:14.823Z","updated_at":"2020-09-22T17:28:14.823Z","actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"id":24561,"category":"team","content":"A stack overflow takes place when map names with malformed names are listed which can be used to execute arbitrary code.\n\nI made a Proof of Concept that executes gnome-calculator on Linux.\n\nThis was tested on `Half Life` 2018-08-29 on Linux, Ubuntu 18.04.\n\nTo reproduce:\n- Extract the attached zip-file in the /valve/maps directory.\n- Start `Half-Life`.\n- Open the console and type `maps *`. This lists the installed maps.\n- `gnome-calculator` should now execute.\n\nYou may also use the python script to generate a malformed mapname with the exploit.\n\nPlease see the enclosed video for a demonstration.\n\n# Details about the bug\nThe callstack when the stack is overwritten is the following:\n\n```\n#4  0xf7c982d8 in sprintf () from /usr/lib32/libc.so.6\n#5  0xf6454504 in COM_ListMaps (pszSubString=0x0) at ../engine/common.c:2857\n#6  0xf6466f3a in Host_Maps_f () at ../engine/host_cmd.c:1511\n#7  Host_Maps_f () at ../engine/host_cmd.c:1493\n#8  0xf644e20d in Cmd_ExecuteString (\n    text=0x41414141 \u003cerror: Cannot access memory at address 0x41414141\u003e, src=\u003coptimized out\u003e)\n    at ../engine/cmd.c:1149\n#9  Cbuf_Execute () at ../engine/cmd.c:242\n#10 0xf6464ed3 in _Host_Frame (time=0.0570053197) at ../engine/host.c:1384\n#11 0xf6465382 in Host_Frame (time=0.0570053197, iState=1, stateInfo=0xffffcb6c)\n    at ../engine/host.c:1522\n#12 0xf64918c4 in CEngine::Frame (this=0xf66a88c0 \u003cg_Engine\u003e) at ../engine/sys_engine.cpp:245\n#13 0xf648f3a3 in RunListenServer (instance=0x0, \n    basedir=0x804b220 \u003cszBaseDir\u003e \"/home/konrad/.local/share/Steam/steamapps/common/Half-Life\", cmdline=0x80534d0 \"/home/konrad/.local/share/Steam/steamapps/common/Half-Life/hl_linux\", \n    postRestartCmdLineArgs=0x804d360 \u003cmain::szNewCommandParams\u003e \"\", launcherFactory=\n    0x8049350 \u003cCreateInterfaceLocal(char const*, int*)\u003e, filesystemFactory=\n    0xf76ccad0 \u003cCreateInterface(char const*, int*)\u003e) at ../engine/sys_dll2.cpp:946\n#14 0x08048d67 in main (argc=1, argv=0xffffcda4) at ../launcher/launcher.cpp:439\n```\n\n## Impact\n\nIf a user installs the crafted map file and runs `maps *` in the console, then custom code can get executed that is not written by Valve, e.g. malware.\n","can_view?":true,"can_edit?":false,"content_html":"\u003cp\u003eA stack overflow takes place when map names with malformed names are listed which can be used to execute arbitrary code.\u003c/p\u003e\n\n\u003cp\u003eI made a Proof of Concept that executes gnome-calculator on Linux.\u003c/p\u003e\n\n\u003cp\u003eThis was tested on \u003ccode\u003eHalf Life\u003c/code\u003e 2018-08-29 on Linux, Ubuntu 18.04.\u003c/p\u003e\n\n\u003cp\u003eTo reproduce:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eExtract the attached zip-file in the /valve/maps directory.\u003c/li\u003e\n\u003cli\u003eStart \u003ccode\u003eHalf-Life\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eOpen the console and type \u003ccode\u003emaps *\u003c/code\u003e. This lists the installed maps.\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003egnome-calculator\u003c/code\u003e should now execute.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eYou may also use the python script to generate a malformed mapname with the exploit.\u003c/p\u003e\n\n\u003cp\u003ePlease see the enclosed video for a demonstration.\u003c/p\u003e\n\n\u003ch1 id=\"details-about-the-bug\"\u003eDetails about the bug\u003c/h1\u003e\n\n\u003cp\u003eThe callstack when the stack is overwritten is the following:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e#4  0xf7c982d8 in sprintf () from /usr/lib32/libc.so.6\n#5  0xf6454504 in COM_ListMaps (pszSubString=0x0) at ../engine/common.c:2857\n#6  0xf6466f3a in Host_Maps_f () at ../engine/host_cmd.c:1511\n#7  Host_Maps_f () at ../engine/host_cmd.c:1493\n#8  0xf644e20d in Cmd_ExecuteString (\n    text=0x41414141 \u0026lt;error: Cannot access memory at address 0x41414141\u0026gt;, src=\u0026lt;optimized out\u0026gt;)\n    at ../engine/cmd.c:1149\n#9  Cbuf_Execute () at ../engine/cmd.c:242\n#10 0xf6464ed3 in _Host_Frame (time=0.0570053197) at ../engine/host.c:1384\n#11 0xf6465382 in Host_Frame (time=0.0570053197, iState=1, stateInfo=0xffffcb6c)\n    at ../engine/host.c:1522\n#12 0xf64918c4 in CEngine::Frame (this=0xf66a88c0 \u0026lt;g_Engine\u0026gt;) at ../engine/sys_engine.cpp:245\n#13 0xf648f3a3 in RunListenServer (instance=0x0, \n    basedir=0x804b220 \u0026lt;szBaseDir\u0026gt; \u0026quot;/home/konrad/.local/share/Steam/steamapps/common/Half-Life\u0026quot;, cmdline=0x80534d0 \u0026quot;/home/konrad/.local/share/Steam/steamapps/common/Half-Life/hl_linux\u0026quot;, \n    postRestartCmdLineArgs=0x804d360 \u0026lt;main::szNewCommandParams\u0026gt; \u0026quot;\u0026quot;, launcherFactory=\n    0x8049350 \u0026lt;CreateInterfaceLocal(char const*, int*)\u0026gt;, filesystemFactory=\n    0xf76ccad0 \u0026lt;CreateInterface(char const*, int*)\u0026gt;) at ../engine/sys_dll2.cpp:946\n#14 0x08048d67 in main (argc=1, argv=0xffffcda4) at ../launcher/launcher.cpp:439\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eIf a user installs the crafted map file and runs \u003ccode\u003emaps *\u003c/code\u003e in the console, then custom code can get executed that is not written by Valve, e.g. malware.\u003c/p\u003e\n"},{"category":"researcher","can_view?":true,"can_create?":false}]}