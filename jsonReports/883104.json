{"id":883104,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC84ODMxMDQ=","url":"https://hackerone.com/reports/883104","title":"Directory traversal allows execution of arbitrary binaries usign doveadm exec","state":"Closed","substate":"informative","readable_substate":"Informative","created_at":"2020-05-26T19:57:21.249Z","submitted_at":"2020-05-26T19:57:21.249Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"eirini","url":"/eirini","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":8906,"url":"https://hackerone.com/open-xchange","handle":"open-xchange","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/JtYLEsu5yRZxGitSmAjeAFtK/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/JtYLEsu5yRZxGitSmAjeAFtK/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Open-Xchange","twitter_handle":"openxchange","website":"https://www.open-xchange.com/","about":"Messaging, collaboration and office productivity software for service providers"}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2020-06-23T20:16:22.460Z","bug_reporter_agreed_on_going_public_at":"2020-06-23T20:16:22.430Z","team_member_agreed_on_going_public_at":"2020-06-22T08:32:59.100Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Both the doveadm-exec man page and the [online manual](https://wiki.dovecot.org/Tools/Doveadm/Exec) specify that it can be used to execute commands from Dovecot's libexec_dir (which sounds like an implicit security boundary). I recently ran across a situation where doveadm-exec was whitelisted in sudoers to be run as root.  I realized it was possible to do a directory traversal and run an arbitrary binary as root.\n\n```\n$ sudo doveadm exec ../../../bin/bash\n#\n```\nI discovered this on Ubuntu 20.04 LTS with Dovecot 2.3.7.2 (3c910f64b).\n\n## Impact\n\nIn case doveadm is run under sudo, it would allow an adversary to execute arbitrary binaries as root.","vulnerability_information_html":"\u003cp\u003eBoth the doveadm-exec man page and the \u003ca href=\"/redirect?url=https%3A%2F%2Fwiki.dovecot.org%2FTools%2FDoveadm%2FExec\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eonline manual\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e specify that it can be used to execute commands from Dovecot\u0026#39;s libexec_dir (which sounds like an implicit security boundary). I recently ran across a situation where doveadm-exec was whitelisted in sudoers to be run as root.  I realized it was possible to do a directory traversal and run an arbitrary binary as root.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e$ sudo doveadm exec ../../../bin/bash\n#\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eI discovered this on Ubuntu 20.04 LTS with Dovecot 2.3.7.2 (3c910f64b).\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eIn case doveadm is run under sudo, it would allow an adversary to execute arbitrary binaries as root.\u003c/p\u003e\n","weakness":{"id":19,"name":"Path Traversal"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":2,"voters":["brahim_boufakri01","exception"],"structured_scope":{"databaseId":42899,"asset_type":"SOURCE_CODE","asset_identifier":"https://github.com/dovecot/core","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":8112673,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I guess it could be good .. but even if this is fixed, there are other ways of gaining a root shell via \"doveadm exec\". For example something like: \"doveadm exec imap -o mail_plugin_dir=/tmp/plugins -o mail_plugins=root_shell_plugin\"\n\ndoveadm in general isn't designed to be run in restricted sudo / setuid environments.","markdown_message":"\u003cp\u003eI guess it could be good .. but even if this is fixed, there are other ways of gaining a root shell via \u0026quot;doveadm exec\u0026quot;. For example something like: \u0026quot;doveadm exec imap -o mail_plugin_dir=/tmp/plugins -o mail_plugins=root_shell_plugin\u0026quot;\u003c/p\u003e\n\n\u003cp\u003edoveadm in general isn\u0026#39;t designed to be run in restricted sudo / setuid environments.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-05-26T23:10:02.183Z","updated_at":"2020-05-26T23:10:02.183Z","actor":{"username":"tss","cleared":false,"url":"/tss","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8118101,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"True, there seem to be various ways to execute arbitrary commands using doveadm. Unfortunately, the \"doveadm in general isn't designed to be run in restricted sudo / setuid environments\" message does not seem to have reached the audience. If you look on StackOverflow and GitHub, there's a good number of people and projects using it with sudo. Maybe doveadm should specifically check if it is being run under sudo and warn/abort if that's the case?\n\nAlso, regardless of the different ways to execute commands, I'd argue the path traversal is still a bug - the intent seems to be to run from libexec_dir only (as documented). Maybe this should be fixed regardless or the documentation should clarify that it allows for running other binaries as well?","markdown_message":"\u003cp\u003eTrue, there seem to be various ways to execute arbitrary commands using doveadm. Unfortunately, the \u0026quot;doveadm in general isn\u0026#39;t designed to be run in restricted sudo / setuid environments\u0026quot; message does not seem to have reached the audience. If you look on StackOverflow and GitHub, there\u0026#39;s a good number of people and projects using it with sudo. Maybe doveadm should specifically check if it is being run under sudo and warn/abort if that\u0026#39;s the case?\u003c/p\u003e\n\n\u003cp\u003eAlso, regardless of the different ways to execute commands, I\u0026#39;d argue the path traversal is still a bug - the intent seems to be to run from libexec_dir only (as documented). Maybe this should be fixed regardless or the documentation should clarify that it allows for running other binaries as well?\u003c/p\u003e\n","automated_response":false,"created_at":"2020-05-27T11:59:57.648Z","updated_at":"2020-05-27T11:59:57.648Z","actor":{"username":"eirini","cleared":false,"url":"/eirini","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8118351,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I just thought of a really way to do basically the same:\n\ndoveadm -o libexec_dir=/bin exec bash\n\nBut yes, I think we'll fix the directory traversal by just disallowing '/' entirely in the binary name.\n\nI'm not sure what to do about the generic problem though. It could be of course documented in various places, but I'm not sure if people will actually read that documentation. I don't think we can detect if sudo is being used safely (sudo doveadm for users being able to run any sudo commands) vs unsafely (restricting sudo to only certain commands). And some people probably want to intentionally run it in unsafe ways..","markdown_message":"\u003cp\u003eI just thought of a really way to do basically the same:\u003c/p\u003e\n\n\u003cp\u003edoveadm -o libexec_dir=/bin exec bash\u003c/p\u003e\n\n\u003cp\u003eBut yes, I think we\u0026#39;ll fix the directory traversal by just disallowing \u0026#39;/\u0026#39; entirely in the binary name.\u003c/p\u003e\n\n\u003cp\u003eI\u0026#39;m not sure what to do about the generic problem though. It could be of course documented in various places, but I\u0026#39;m not sure if people will actually read that documentation. I don\u0026#39;t think we can detect if sudo is being used safely (sudo doveadm for users being able to run any sudo commands) vs unsafely (restricting sudo to only certain commands). And some people probably want to intentionally run it in unsafe ways..\u003c/p\u003e\n","automated_response":false,"created_at":"2020-05-27T12:30:07.954Z","updated_at":"2020-05-27T12:30:07.954Z","actor":{"username":"tss","cleared":false,"url":"/tss","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8121973,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I would say a combination of adding it to the documentation and warning whenever doveadm is being run under sudo (the users in your \"safe\"  case can then just ignore the warning, but the users in the \"unsafe\" case can then learn that it is unsafe behaviour, hopefully before putting it permanently in place in a sudoers configuration or a script, etc.) would be the best way forward. What do you think?","markdown_message":"\u003cp\u003eI would say a combination of adding it to the documentation and warning whenever doveadm is being run under sudo (the users in your \u0026quot;safe\u0026quot;  case can then just ignore the warning, but the users in the \u0026quot;unsafe\u0026quot; case can then learn that it is unsafe behaviour, hopefully before putting it permanently in place in a sudoers configuration or a script, etc.) would be the best way forward. What do you think?\u003c/p\u003e\n","automated_response":false,"created_at":"2020-05-27T18:32:00.943Z","updated_at":"2020-05-27T18:32:00.943Z","actor":{"username":"eirini","cleared":false,"url":"/eirini","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8366347,"is_internal":false,"editable":false,"type":"Activities::BugInformative","message":"Hi!\n\nWe will internally discuss what to do with this. But this will be closed as \"Informative\" as this is not really a security issue. I can see how the behaviour can be surprising though.","markdown_message":"\u003cp\u003eHi!\u003c/p\u003e\n\n\u003cp\u003eWe will internally discuss what to do with this. But this will be closed as \u0026quot;Informative\u0026quot; as this is not really a security issue. I can see how the behaviour can be surprising though.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-06-22T07:30:22.037Z","updated_at":"2020-06-22T07:30:22.037Z","actor":{"username":"akituomi","cleared":false,"url":"/akituomi","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/060/216/805d230879c8e3757d37eedddaadf9efed0a8094_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8366921,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-06-22T08:32:59.117Z","updated_at":"2020-06-22T08:32:59.117Z","first_to_agree":true,"actor":{"username":"akituomi","cleared":false,"url":"/akituomi","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/060/216/805d230879c8e3757d37eedddaadf9efed0a8094_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8389013,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-06-23T20:16:22.446Z","updated_at":"2020-06-23T20:16:22.446Z","actor":{"username":"eirini","cleared":false,"url":"/eirini","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8389014,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-06-23T20:16:22.478Z","updated_at":"2020-06-23T20:16:22.478Z","actor":{"username":"eirini","cleared":false,"url":"/eirini","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"open-xchange","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}