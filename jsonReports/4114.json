{"id":4114,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC80MTE0","url":"https://hackerone.com/reports/4114","title":"Persistent XSS: Editor link","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2014-03-16T11:30:47.494Z","submitted_at":"2014-03-16T11:30:47.494Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"tomvg","url":"/tomvg","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/088/bcadc0a4a87f5627226b724ae0dcacbee32cc3e7_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":18,"url":"https://hackerone.com/phabricator","handle":"phabricator","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Phabricator","twitter_handle":"phabricator","website":"http://phacility.com/phabricator/","about":"Phabricator is a collection of open source web applications that help software companies build better software."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2014-04-16T20:02:21.407Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2014-03-17T20:04:33.019Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"The editor link used for external applications allows scheme other than `http:` or `https:`.  Although the `phutil_tag` function checks whether the scheme is `javascript:` to prevent XSS attacks ([see GitHub](https://github.com/facebook/libphutil/blob/6b1066f7c0b34f5a485ad5d8af57792b3acae4d9/src/markup/render.php#L19)), it is straightforward to bypass this check by adding a whitespace character in between `javascript` and `:`.  For instance, clicking a link with the following value for the `href` attribute will execute arbitary JavaScript code: \r\n\r\n```\r\njavascript\r\n:alert('xss')\r\n``` \r\n(note the newline character between `javascript` and `:`).\r\n\r\n# Replication steps:\r\n\r\n* Go to `settings/panel/display/`\r\n* Press \"Save\" with network panel of console active\r\n* Copy the POST request as cURL\r\n* Use `curl` to set the `editor` parameter to `javascript%0A%3Aalert%281%29` (this is not possible to do in the browser as it strips these characters from input fields)\r\n* Go to a repository, and click \"Edit\", you should now see an alert box pop up\r\n\r\n# Attack scenarios\r\n\r\nAlthough the JavaScript code will only be executed on the user's own account, several attack scenarios are possible:\r\n\r\n1. A temporary account take-over would allow the attacker to set the editor link to include JavaScript code. Even when the victim manages to recover his account, clicking on the \"Edit\" link will  give the attacker again control over the account.\r\n2. Several login-csrf were found in Phabricator, so an attacker could have abused this (or abuse it if a similar issue arises) to login the victim into his account. The attacker could use the XSS to trick the victim into entering his own credentials\r\n\r\n# Proposed fix\r\n\r\nIn the `phutil_tag` function, first filter all non-alphanumerical characters of `$href` and then check whether it starts with `javascript:`.","vulnerability_information_html":"\u003cp\u003eThe editor link used for external applications allows scheme other than \u003ccode\u003ehttp:\u003c/code\u003e or \u003ccode\u003ehttps:\u003c/code\u003e.  Although the \u003ccode\u003ephutil_tag\u003c/code\u003e function checks whether the scheme is \u003ccode\u003ejavascript:\u003c/code\u003e to prevent XSS attacks (\u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Ffacebook%2Flibphutil%2Fblob%2F6b1066f7c0b34f5a485ad5d8af57792b3acae4d9%2Fsrc%2Fmarkup%2Frender.php%23L19\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003esee GitHub\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e), it is straightforward to bypass this check by adding a whitespace character in between \u003ccode\u003ejavascript\u003c/code\u003e and \u003ccode\u003e:\u003c/code\u003e.  For instance, clicking a link with the following value for the \u003ccode\u003ehref\u003c/code\u003e attribute will execute arbitary JavaScript code: \u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003ejavascript\n:alert(\u0026#39;xss\u0026#39;)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e(note the newline character between \u003ccode\u003ejavascript\u003c/code\u003e and \u003ccode\u003e:\u003c/code\u003e).\u003c/p\u003e\n\n\u003ch1 id=\"replication-steps\"\u003eReplication steps:\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003eGo to \u003ccode\u003esettings/panel/display/\u003c/code\u003e\n\u003c/li\u003e\n\u003cli\u003ePress \u0026quot;Save\u0026quot; with network panel of console active\u003c/li\u003e\n\u003cli\u003eCopy the POST request as cURL\u003c/li\u003e\n\u003cli\u003eUse \u003ccode\u003ecurl\u003c/code\u003e to set the \u003ccode\u003eeditor\u003c/code\u003e parameter to \u003ccode\u003ejavascript%0A%3Aalert%281%29\u003c/code\u003e (this is not possible to do in the browser as it strips these characters from input fields)\u003c/li\u003e\n\u003cli\u003eGo to a repository, and click \u0026quot;Edit\u0026quot;, you should now see an alert box pop up\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1 id=\"attack-scenarios\"\u003eAttack scenarios\u003c/h1\u003e\n\n\u003cp\u003eAlthough the JavaScript code will only be executed on the user\u0026#39;s own account, several attack scenarios are possible:\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003eA temporary account take-over would allow the attacker to set the editor link to include JavaScript code. Even when the victim manages to recover his account, clicking on the \u0026quot;Edit\u0026quot; link will  give the attacker again control over the account.\u003c/li\u003e\n\u003cli\u003eSeveral login-csrf were found in Phabricator, so an attacker could have abused this (or abuse it if a similar issue arises) to login the victim into his account. The attacker could use the XSS to trick the victim into entering his own credentials\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch1 id=\"proposed-fix\"\u003eProposed fix\u003c/h1\u003e\n\n\u003cp\u003eIn the \u003ccode\u003ephutil_tag\u003c/code\u003e function, first filter all non-alphanumerical characters of \u003ccode\u003e$href\u003c/code\u003e and then check whether it starts with \u003ccode\u003ejavascript:\u003c/code\u003e.\u003c/p\u003e\n","bounty_amount":"300.0","formatted_bounty":"$300","weakness":{"id":60,"name":"Cross-site Scripting (XSS) - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2014-04-16T19:02:13.954Z","allow_singular_disclosure_after":-211546268.04324755,"singular_disclosure_allowed":true,"vote_count":5,"voters":["realtess","fantam1","khleymu_da","cryptographer","omaratik123"],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":17158,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hmm. It looks like Safari and Firefox don't interpret \"javascript\\n:alert(1)\" as Javascript (am I setting things up wrong?), but Chrome does. IE11 also does.","markdown_message":"\u003cp\u003eHmm. It looks like Safari and Firefox don\u0026#39;t interpret \u0026quot;javascript\\n:alert(1)\u0026quot; as Javascript (am I setting things up wrong?), but Chrome does. IE11 also does.\u003c/p\u003e\n","automated_response":false,"created_at":"2014-03-16T13:44:56.003Z","updated_at":"2014-03-16T13:44:56.003Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":17160,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"That seems correct, Opera also does.\nSee [shazzer fuzz db](http://shazzer.co.uk/database/All/Characters-after-javascript-uri)\n\nNote that a character that is not matched by `\\s` in PCRE may be prepended as well; again see [fuzz db](http://shazzer.co.uk/database/All/Characters-before-javascript-uri).","markdown_message":"\u003cp\u003eThat seems correct, Opera also does.\u003cbr\u003e\nSee \u003ca href=\"/redirect?url=http%3A%2F%2Fshazzer.co.uk%2Fdatabase%2FAll%2FCharacters-after-javascript-uri\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eshazzer fuzz db\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eNote that a character that is not matched by \u003ccode\u003e\\s\u003c/code\u003e in PCRE may be prepended as well; again see \u003ca href=\"/redirect?url=http%3A%2F%2Fshazzer.co.uk%2Fdatabase%2FAll%2FCharacters-before-javascript-uri\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003efuzz db\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003c/p\u003e\n","automated_response":false,"created_at":"2014-03-16T14:04:18.425Z","updated_at":"2014-03-16T14:04:18.425Z","actor":{"username":"tomvg","cleared":false,"url":"/tomvg","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/088/bcadc0a4a87f5627226b724ae0dcacbee32cc3e7_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":17164,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks, that's helpful. I think this should fix it:\n\nhttps://secure.phabricator.com/D8548\n\nMaybe we should also whitelist editor protocols and give administrators configuration to control that. I'm hesitant to lock it down too much since I don't want to prevent users from using it with weird/obscure/future editors, but as long as administrators could configure it we could probably create a reasonable whitelist. I could imagine the editor feature opening up other attacks in the future that we don't really need to be exposed to (we do already whitelist protocols allowed in links).","markdown_message":"\u003cp\u003eThanks, that\u0026#39;s helpful. I think this should fix it:\u003c/p\u003e\n\n\u003cp\u003e\u003ca title=\"https://secure.phabricator.com/D8548\" href=\"/redirect?url=https%3A%2F%2Fsecure.phabricator.com%2FD8548\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://secure.phabricator.com/D8548\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eMaybe we should also whitelist editor protocols and give administrators configuration to control that. I\u0026#39;m hesitant to lock it down too much since I don\u0026#39;t want to prevent users from using it with weird/obscure/future editors, but as long as administrators could configure it we could probably create a reasonable whitelist. I could imagine the editor feature opening up other attacks in the future that we don\u0026#39;t really need to be exposed to (we do already whitelist protocols allowed in links).\u003c/p\u003e\n","automated_response":false,"created_at":"2014-03-16T14:30:56.578Z","updated_at":"2014-03-16T14:30:56.578Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":17334,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"That patch seems to fix the reported problem.\n\nA whitelist seems like a good idea: it should also prevent some phishing attacks after temporary account compromise (e.g. URLs with `data:` scheme or external phishing websites could trick a user into re-entering his credentials). ","markdown_message":"\u003cp\u003eThat patch seems to fix the reported problem.\u003c/p\u003e\n\n\u003cp\u003eA whitelist seems like a good idea: it should also prevent some phishing attacks after temporary account compromise (e.g. URLs with \u003ccode\u003edata:\u003c/code\u003e scheme or external phishing websites could trick a user into re-entering his credentials). \u003c/p\u003e\n","automated_response":false,"created_at":"2014-03-17T13:02:13.246Z","updated_at":"2014-03-17T13:02:13.246Z","actor":{"username":"tomvg","cleared":false,"url":"/tomvg","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/088/bcadc0a4a87f5627226b724ae0dcacbee32cc3e7_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":17438,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"The `javascript:` fix is in HEAD; this should whitelist editor protocols:\n\nhttps://secure.phabricator.com/D8551\n\nI'll close this out once that lands.","markdown_message":"\u003cp\u003eThe \u003ccode\u003ejavascript:\u003c/code\u003e fix is in HEAD; this should whitelist editor protocols:\u003c/p\u003e\n\n\u003cp\u003e\u003ca title=\"https://secure.phabricator.com/D8551\" href=\"/redirect?url=https%3A%2F%2Fsecure.phabricator.com%2FD8551\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://secure.phabricator.com/D8551\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eI\u0026#39;ll close this out once that lands.\u003c/p\u003e\n","automated_response":false,"created_at":"2014-03-17T19:00:25.153Z","updated_at":"2014-03-17T19:00:25.153Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":17452,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"This should now be fixed in HEAD.","markdown_message":"\u003cp\u003eThis should now be fixed in HEAD.\u003c/p\u003e\n","automated_response":false,"created_at":"2014-03-17T20:02:14.045Z","updated_at":"2014-03-17T20:02:14.045Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"tomvg","url":"/tomvg"},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":17454,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"I'm assessing this as relatively low-severity because it's self-XSS only and the user must click a fairly obscure link after being XSS'd.","markdown_message":"\u003cp\u003eI\u0026#39;m assessing this as relatively low-severity because it\u0026#39;s self-XSS only and the user must click a fairly obscure link after being XSS\u0026#39;d.\u003c/p\u003e\n","automated_response":false,"created_at":"2014-03-17T20:04:12.669Z","updated_at":"2014-03-17T20:04:12.669Z","actor":{"url":"/phabricator","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Phabricator"}},"bounty_amount":"300.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"phabricator","collaborator":{"username":"tomvg","url":"/tomvg"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":17455,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"This can be disclosed publicly at any time. Thanks for the report!","markdown_message":"\u003cp\u003eThis can be disclosed publicly at any time. Thanks for the report!\u003c/p\u003e\n","automated_response":false,"created_at":"2014-03-17T20:04:33.031Z","updated_at":"2014-03-17T20:04:33.031Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":31511,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2014-04-16T20:02:21.583Z","updated_at":"2014-04-16T20:02:21.583Z","actor":{"url":"/phabricator","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Phabricator"}},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}