{"id":458929,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC80NTg5Mjk=","url":"https://hackerone.com/reports/458929","title":"Malformed BSP in GoldSrc Engine may cause shellcode injection","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2018-12-07T22:20:44.175Z","submitted_at":"2018-12-07T22:20:44.175Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"kohtep2010","url":"/kohtep2010","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/ZLr6Jvt7ixmtsP1vjXVwpdye/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":23363,"url":"https://hackerone.com/valve","handle":"valve","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/023/363/c78d46a7d0ea39e3a15a7c19c1a48634f2571eb9_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/023/363/c78d46a7d0ea39e3a15a7c19c1a48634f2571eb9_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Valve","twitter_handle":"","website":"https://www.valvesoftware.com","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"no-content","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2020-03-25T22:03:24.144Z","bug_reporter_agreed_on_going_public_at":"2019-03-23T07:11:45.780Z","team_member_agreed_on_going_public_at":"2020-03-25T22:03:23.875Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"","vulnerability_information_html":"","bounty_amount":"1750.0","formatted_bounty":"$1,750","weakness":{"id":3,"name":"Classic Buffer Overflow"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":21,"voters":["njbooher","mvc","spam404","base_64","romesful","snwlol","meepmerp","lcdoninfosec","blind32","sireberalpaulsy","and 11 more..."],"severity":{"rating":"high","author_type":"User"},"structured_scope":{"databaseId":1289,"asset_type":"DOWNLOADABLE_EXECUTABLES","asset_identifier":"hl.exe","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":3788574,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2018-12-07T22:48:04.714Z","updated_at":"2018-12-07T22:48:04.714Z","actor":{"username":"kohtep2010","cleared":false,"url":"/kohtep2010","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ZLr6Jvt7ixmtsP1vjXVwpdye/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3788606,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2018-12-07T22:59:13.419Z","updated_at":"2018-12-07T22:59:13.419Z","actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":3823208,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2018-12-14T01:16:55.011Z","updated_at":"2018-12-14T01:16:55.011Z","actor":{"username":"kohtep2010","cleared":false,"url":"/kohtep2010","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ZLr6Jvt7ixmtsP1vjXVwpdye/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3884228,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2018-12-23T16:11:09.945Z","updated_at":"2018-12-23T16:11:09.945Z","actor":{"username":"kohtep2010","cleared":false,"url":"/kohtep2010","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ZLr6Jvt7ixmtsP1vjXVwpdye/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4008580,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2019-01-20T21:04:06.195Z","updated_at":"2019-01-20T21:04:06.195Z","actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4081447,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2019-02-01T19:09:05.346Z","updated_at":"2019-02-01T19:09:33.693Z","actor":{"username":"kohtep2010","cleared":false,"url":"/kohtep2010","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ZLr6Jvt7ixmtsP1vjXVwpdye/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4116840,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2019-02-08T19:45:06.227Z","updated_at":"2019-02-08T19:45:06.227Z","actor":{"url":"/valve","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/023/363/c78d46a7d0ea39e3a15a7c19c1a48634f2571eb9_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Valve"}},"bounty_amount":"1750.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"valve","collaborator":{"username":"kohtep2010","url":"/kohtep2010"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4124074,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2019-02-10T22:35:24.648Z","updated_at":"2019-02-10T22:35:24.648Z","actor":{"username":"kohtep2010","cleared":false,"url":"/kohtep2010","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ZLr6Jvt7ixmtsP1vjXVwpdye/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4254997,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2019-03-04T19:01:11.581Z","updated_at":"2019-03-04T19:06:06.913Z","actor":{"username":"kohtep2010","cleared":false,"url":"/kohtep2010","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ZLr6Jvt7ixmtsP1vjXVwpdye/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4284858,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","markdown_message":"","automated_response":false,"created_at":"2019-03-08T11:16:32.195Z","updated_at":"2019-03-08T11:16:32.195Z","actor":{"username":"nasr0x01","cleared":false,"url":"/nasr0x01","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/386/674/ec2e2c825a554851c42c122ffd61aa8f18b08174_original.jpeg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"kohtep2010","url":"/kohtep2010"},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4284894,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2019-03-08T11:31:27.713Z","updated_at":"2019-03-08T11:31:27.713Z","actor":{"username":"kohtep2010","cleared":false,"url":"/kohtep2010","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ZLr6Jvt7ixmtsP1vjXVwpdye/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4376678,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2019-03-23T07:11:45.803Z","updated_at":"2019-03-23T07:11:45.803Z","first_to_agree":true,"actor":{"username":"kohtep2010","cleared":false,"url":"/kohtep2010","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/ZLr6Jvt7ixmtsP1vjXVwpdye/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7442256,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-03-25T22:03:23.899Z","updated_at":"2020-03-25T22:03:23.899Z","actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7442257,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-03-25T22:03:24.191Z","updated_at":"2020-03-25T22:03:24.191Z","actor":{"username":"mikela","cleared":false,"url":"/mikela","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"valve","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"id":20877,"category":"team","content":"### Introduction\n\nHello. There's a vulnerability in GoldSrc Engine that allows to run arbitrary assembly code using incorrect BSP format processing.\n\n### Description\n\nThe vulnerability is found in the **UTIL_StringToIntArray** function. This function belongs to the game mod library (mp.dll/cs.so) and has the following call chain:\n\nSV_LoadEntities -\u003e ED_LoadFromFile -\u003e ED_ParseEdict -\u003e gEntityInterface.pfnKeyValue -\u003e CGameText::KeyValue -\u003e UTIL_StringToIntArray\n\nThe call of this function occurs at server start during processing of the entities of map being loaded. The vulnerability itself is a classic buffer overflow with the possibility of rewriting the return address to the address where the shellcode is located.\n\nVulnerability was tested on Windows 10 and it works successfully.\n\n### How to reproduce\n\nIn order to reproduce the vulnerability, an attacker needs to perform an entity list correction within the BSP itself. As a demonstration, I took a **35hp_2** map, which uses the **game_text** entity, into which we can write the shellcode that runs OS calculator via WinExec function. You can see shellcode implementation on the image below.\n\n{F387197}\n\nWhen client connects to the HLDS, attacker will send malformed map to it. After client completes download, server will send console command **map 35hp_2_shell** to client, which will start a local server, causing the load of malformed map and the shellcode execution, since this command is not on the stufftext filter list.\n\nTo quickly check the work of the shellcode, it is enough just to put the malformed map in the **maps** folder of any mod (I used Counter-Strike 1.6, Steam) and execute the console command 'map 35hp_2_shell' manually.\n\nI attached malformed map to report.\n\n### Possible solutions\n\nThe argument **pString** needs to be checked for length. So, if it is larger than the buffer where the string is copied, then the function must be terminated. You can also simply replace the function strcpy with strncpy.\n\n## Impact\n\nAn attacker can execute code remotely on a client machine using HLDS, or he can upload a malformed map to web-resources, that can lead to infection of users of the resource.","can_view?":true,"can_edit?":false,"content_html":"\u003ch3 id=\"introduction\"\u003eIntroduction\u003c/h3\u003e\n\n\u003cp\u003eHello. There\u0026#39;s a vulnerability in GoldSrc Engine that allows to run arbitrary assembly code using incorrect BSP format processing.\u003c/p\u003e\n\n\u003ch3 id=\"description\"\u003eDescription\u003c/h3\u003e\n\n\u003cp\u003eThe vulnerability is found in the \u003cstrong\u003eUTIL_StringToIntArray\u003c/strong\u003e function. This function belongs to the game mod library (mp.dll/cs.so) and has the following call chain:\u003c/p\u003e\n\n\u003cp\u003eSV_LoadEntities -\u0026gt; ED_LoadFromFile -\u0026gt; ED_ParseEdict -\u0026gt; gEntityInterface.pfnKeyValue -\u0026gt; CGameText::KeyValue -\u0026gt; UTIL_StringToIntArray\u003c/p\u003e\n\n\u003cp\u003eThe call of this function occurs at server start during processing of the entities of map being loaded. The vulnerability itself is a classic buffer overflow with the possibility of rewriting the return address to the address where the shellcode is located.\u003c/p\u003e\n\n\u003cp\u003eVulnerability was tested on Windows 10 and it works successfully.\u003c/p\u003e\n\n\u003ch3 id=\"how-to-reproduce\"\u003eHow to reproduce\u003c/h3\u003e\n\n\u003cp\u003eIn order to reproduce the vulnerability, an attacker needs to perform an entity list correction within the BSP itself. As a demonstration, I took a \u003cstrong\u003e35hp_2\u003c/strong\u003e map, which uses the \u003cstrong\u003egame_text\u003c/strong\u003e entity, into which we can write the shellcode that runs OS calculator via WinExec function. You can see shellcode implementation on the image below.\u003c/p\u003e\n\n\u003cp\u003e{F387197}\u003c/p\u003e\n\n\u003cp\u003eWhen client connects to the HLDS, attacker will send malformed map to it. After client completes download, server will send console command \u003cstrong\u003emap 35hp_2_shell\u003c/strong\u003e to client, which will start a local server, causing the load of malformed map and the shellcode execution, since this command is not on the stufftext filter list.\u003c/p\u003e\n\n\u003cp\u003eTo quickly check the work of the shellcode, it is enough just to put the malformed map in the \u003cstrong\u003emaps\u003c/strong\u003e folder of any mod (I used Counter-Strike 1.6, Steam) and execute the console command \u0026#39;map 35hp_2_shell\u0026#39; manually.\u003c/p\u003e\n\n\u003cp\u003eI attached malformed map to report.\u003c/p\u003e\n\n\u003ch3 id=\"possible-solutions\"\u003ePossible solutions\u003c/h3\u003e\n\n\u003cp\u003eThe argument \u003cstrong\u003epString\u003c/strong\u003e needs to be checked for length. So, if it is larger than the buffer where the string is copied, then the function must be terminated. You can also simply replace the function strcpy with strncpy.\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eAn attacker can execute code remotely on a client machine using HLDS, or he can upload a malformed map to web-resources, that can lead to infection of users of the resource.\u003c/p\u003e\n"},{"category":"researcher","can_view?":true,"can_create?":false}]}