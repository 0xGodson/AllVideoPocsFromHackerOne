{"id":148300,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xNDgzMDA=","url":"https://hackerone.com/reports/148300","title":"Full Page Caching Stored XSS Vulnerability","state":"Closed","substate":"informative","readable_substate":"Informative","created_at":"2016-06-29T22:45:02.613Z","submitted_at":"2016-06-29T22:45:02.613Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"rtyler","url":"/rtyler","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/003/634/8bce6b9bc9697494988d24ace77c83fe168a2a71_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":60,"url":"https://hackerone.com/concrete5","handle":"concrete5","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/060/c549a89ab4a3550cb9bfdeba1bee6d77e2019c7e_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/060/c549a89ab4a3550cb9bfdeba1bee6d77e2019c7e_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":false,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"concrete5","twitter_handle":"concrete5","website":"https://www.concrete5.org","about":"A simple and powerful content management system."}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2017-04-11T20:23:48.502Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2017-04-11T20:23:34.564Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"##Configuration\n\nA concrete5 site running over https on a dedicated IP address. Or any situation where you're not doing name-based virtual hosting and the web server will answer to any hostname.\n- You have full page caching enabled (likely just block output caching too).\n- Doesn't matter if you have Canonical URLs set or not.\n- In 5.7x you couldn't set [x] always render at canonical url if you want the site to always run over https (Seems that might be fixed in version 8).\n\n##Exploit\n\nTo exploit it, the attacker just overrides their hosts file to point your desired url ex:\n\n11.22.33.44 fake-site.com # with the ip of the real site that's running concrete5\n\nThen run a link spider through the site. The result is every page cache file that's generated gets stored with that fake fake-site.com url in any local links allowing the page to be rendered to subsequent visitors with the fake-site.com value as the BASE_URL.\n\nI believe you can farther exploit this by writing code to detect the expiration time and verify that full page caching is enabled by reading the \" Expires\" http response header, to get the expiration time of the cache file, then hit that page again at the appropriate time.\n\n##Fix\n\nWe should be able to fix it by requiring that a canonical url is set when certain caching options are enabled. Then make sure only that value is written when generating the cache files. Another option would be to write internal links as relative links to the cache files.  Another option would be to just give up and melt crayons on the server's cpu.\n\n##Existing Installs\n\nRecommend that either full-page caching is not used on SSL or non name-based virtual hosting setups that would not restrict rendering of the site based on the hostname headers.","vulnerability_information_html":"\u003ch2 id=\"configuration\"\u003eConfiguration\u003c/h2\u003e\n\n\u003cp\u003eA concrete5 site running over https on a dedicated IP address. Or any situation where you\u0026#39;re not doing name-based virtual hosting and the web server will answer to any hostname.\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eYou have full page caching enabled (likely just block output caching too).\u003c/li\u003e\n\u003cli\u003eDoesn\u0026#39;t matter if you have Canonical URLs set or not.\u003c/li\u003e\n\u003cli\u003eIn 5.7x you couldn\u0026#39;t set [x] always render at canonical url if you want the site to always run over https (Seems that might be fixed in version 8).\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"exploit\"\u003eExploit\u003c/h2\u003e\n\n\u003cp\u003eTo exploit it, the attacker just overrides their hosts file to point your desired url ex:\u003c/p\u003e\n\n\u003cp\u003e11.22.33.44 fake-site.com # with the ip of the real site that\u0026#39;s running concrete5\u003c/p\u003e\n\n\u003cp\u003eThen run a link spider through the site. The result is every page cache file that\u0026#39;s generated gets stored with that fake fake-site.com url in any local links allowing the page to be rendered to subsequent visitors with the fake-site.com value as the BASE_URL.\u003c/p\u003e\n\n\u003cp\u003eI believe you can farther exploit this by writing code to detect the expiration time and verify that full page caching is enabled by reading the \u0026quot; Expires\u0026quot; http response header, to get the expiration time of the cache file, then hit that page again at the appropriate time.\u003c/p\u003e\n\n\u003ch2 id=\"fix\"\u003eFix\u003c/h2\u003e\n\n\u003cp\u003eWe should be able to fix it by requiring that a canonical url is set when certain caching options are enabled. Then make sure only that value is written when generating the cache files. Another option would be to write internal links as relative links to the cache files.  Another option would be to just give up and melt crayons on the server\u0026#39;s cpu.\u003c/p\u003e\n\n\u003ch2 id=\"existing-installs\"\u003eExisting Installs\u003c/h2\u003e\n\n\u003cp\u003eRecommend that either full-page caching is not used on SSL or non name-based virtual hosting setups that would not restrict rendering of the site based on the hostname headers.\u003c/p\u003e\n","weakness":{"id":60,"name":"Cross-site Scripting (XSS) - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":1,"voters":["spetr0x"],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1065529,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi Ryan,\nSo the issue with this is that we return full paths from our url resolver always. This is to prevent something like a package doing:\n\n`file_get_contents(URL::to($_REQUEST['url']))`\n\nOn a site without a canonical url, if the user passes \"/etc/passwd\" and the url resolver returns \"/etc/passwd\" instead of \"http://canonical.com/etc/passwd\" your site will include something you don't want it to.\n\nThat said, that is probably a bit far fetched. We plan to return relative urls unless a canonical url is provided. I'll update this report when we have a working fix in a pull request.\n\nThanks,\nKorvin","markdown_message":"\u003cp\u003eHi Ryan,\u003cbr\u003e\nSo the issue with this is that we return full paths from our url resolver always. This is to prevent something like a package doing:\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003efile_get_contents(URL::to($_REQUEST[\u0026#39;url\u0026#39;]))\u003c/code\u003e\u003c/p\u003e\n\n\u003cp\u003eOn a site without a canonical url, if the user passes \u0026quot;/etc/passwd\u0026quot; and the url resolver returns \u0026quot;/etc/passwd\u0026quot; instead of \u0026quot;\u003ca title=\"http://canonical.com/etc/passwd\" href=\"/redirect?url=http%3A%2F%2Fcanonical.com%2Fetc%2Fpasswd\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttp://canonical.com/etc/passwd\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u0026quot; your site will include something you don\u0026#39;t want it to.\u003c/p\u003e\n\n\u003cp\u003eThat said, that is probably a bit far fetched. We plan to return relative urls unless a canonical url is provided. I\u0026#39;ll update this report when we have a working fix in a pull request.\u003c/p\u003e\n\n\u003cp\u003eThanks,\u003cbr\u003e\nKorvin\u003c/p\u003e\n","automated_response":false,"created_at":"2016-07-12T17:44:45.723Z","updated_at":"2016-07-12T17:44:45.723Z","actor":{"username":"korvin","cleared":false,"url":"/korvin","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/yi9xvfnDmjKpKA1reqNSwGct/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"concrete5","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1065752,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Here's a pull request that does what I described: https://github.com/concrete5/concrete5/pull/4021\n\nI'm working on getting the tests to pass.","markdown_message":"\u003cp\u003eHere\u0026#39;s a pull request that does what I described: \u003ca title=\"https://github.com/concrete5/concrete5/pull/4021\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fconcrete5%2Fconcrete5%2Fpull%2F4021\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/concrete5/concrete5/pull/4021\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eI\u0026#39;m working on getting the tests to pass.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-07-12T19:34:50.892Z","updated_at":"2016-07-12T19:34:50.892Z","actor":{"username":"korvin","cleared":false,"url":"/korvin","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/yi9xvfnDmjKpKA1reqNSwGct/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"concrete5","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1439360,"is_internal":false,"editable":false,"type":"Activities::BugInformative","message":"Ultimately the only way a fix would work for this would be to require canonical urls. That isn't something we want to do so instead we've made it easier to configure canonical urls and plan to add a dashboard page that will report common issues like this.\n","markdown_message":"\u003cp\u003eUltimately the only way a fix would work for this would be to require canonical urls. That isn\u0026#39;t something we want to do so instead we\u0026#39;ve made it easier to configure canonical urls and plan to add a dashboard page that will report common issues like this.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-01-23T20:59:03.892Z","updated_at":"2017-01-23T20:59:03.892Z","actor":{"username":"korvin","cleared":false,"url":"/korvin","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/yi9xvfnDmjKpKA1reqNSwGct/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"concrete5","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1605829,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-04-11T20:23:34.582Z","updated_at":"2017-04-11T20:23:34.582Z","first_to_agree":true,"actor":{"username":"korvin","cleared":false,"url":"/korvin","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/yi9xvfnDmjKpKA1reqNSwGct/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"concrete5","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1605830,"is_internal":false,"editable":false,"type":"Activities::ManuallyDisclosed","message":"","markdown_message":"","automated_response":false,"created_at":"2017-04-11T20:23:48.479Z","updated_at":"2017-04-11T20:23:48.479Z","actor":{"username":"korvin","cleared":false,"url":"/korvin","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/yi9xvfnDmjKpKA1reqNSwGct/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"concrete5","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}