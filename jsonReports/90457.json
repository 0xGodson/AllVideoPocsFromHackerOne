{"id":90457,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC85MDQ1Nw==","url":"https://hackerone.com/reports/90457","title":"Nested attributes reject_if proc can be circumvented by providing \"_destroy\" parameter","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2015-09-25T15:35:39.770Z","submitted_at":"2015-09-25T15:35:39.770Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"jcoyne","url":"/jcoyne","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":22,"url":"https://hackerone.com/rails","handle":"rails","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/022/5e2b46658c8b86bed62f574d8e1793f353cbbc63_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/022/5e2b46658c8b86bed62f574d8e1793f353cbbc63_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Ruby on Rails","twitter_handle":null,"website":"http://rubyonrails.org/security","about":"Web development that doesn't hurt."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"no-content","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2016-02-12T23:10:52.833Z","bug_reporter_agreed_on_going_public_at":"2016-02-12T23:10:52.621Z","team_member_agreed_on_going_public_at":"2016-02-12T18:22:14.024Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"","vulnerability_information_html":"","bounty_amount":"500.0","formatted_bounty":"$500","original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2016-03-13T18:22:14.186Z","allow_singular_disclosure_after":-151332429.01279944,"singular_disclosure_allowed":true,"vote_count":8,"voters":["jensec","eveeez","r3y","khizer47","cr4xerbik4sh","chilliesssssss7","cryptographer","hacker7176"],"severity":{"rating":"high","score":7.2,"author_type":"Team","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"none","user_interaction":"none","scope":"changed","confidentiality":"low","integrity":"low","availability":"none"}},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":700778,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2015-11-27T13:24:20.822Z","updated_at":"2015-11-27T13:24:20.822Z","actor":{"username":"pixeltrix","cleared":false,"url":"/pixeltrix","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/039/102/9b0da8bbd0acc4d73bb06f6be3e32cf87b6c4d25_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":771199,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"","markdown_message":"","automated_response":false,"created_at":"2016-01-25T18:15:30.885Z","updated_at":"2016-01-25T18:15:30.885Z","actor":{"username":"rafaelfranca","cleared":false,"url":"/rafaelfranca","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/981/dd3b6bb41f9c33e3448ebbc47303f5a135f25105_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":771226,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"","markdown_message":"","automated_response":false,"created_at":"2016-01-25T18:23:03.893Z","updated_at":"2016-01-25T18:23:03.893Z","actor":{"username":"jcoyne","cleared":false,"url":"/jcoyne","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":771815,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","markdown_message":"","automated_response":false,"created_at":"2016-01-26T01:51:33.516Z","updated_at":"2016-01-26T01:51:33.516Z","actor":{"username":"rafaelfranca","cleared":false,"url":"/rafaelfranca","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/981/dd3b6bb41f9c33e3448ebbc47303f5a135f25105_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"jcoyne","url":"/jcoyne"},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":796076,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2016-02-12T18:22:14.051Z","updated_at":"2016-02-12T18:22:14.051Z","first_to_agree":true,"actor":{"username":"rafaelfranca","cleared":false,"url":"/rafaelfranca","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/981/dd3b6bb41f9c33e3448ebbc47303f5a135f25105_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":796412,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2016-02-12T23:10:52.662Z","updated_at":"2016-02-12T23:10:52.662Z","actor":{"username":"jcoyne","cleared":false,"url":"/jcoyne","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":796413,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2016-02-12T23:10:52.855Z","updated_at":"2016-02-12T23:10:52.855Z","actor":{"username":"jcoyne","cleared":false,"url":"/jcoyne","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2202464,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","markdown_message":"","automated_response":false,"created_at":"2017-12-05T18:46:18.101Z","updated_at":"2017-12-05T18:46:18.101Z","additional_data":{},"actor":{"username":"rafaelfranca","cleared":false,"url":"/rafaelfranca","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/981/dd3b6bb41f9c33e3448ebbc47303f5a135f25105_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"rails","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":2202467,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2017-12-05T18:46:33.874Z","updated_at":"2017-12-05T18:46:33.874Z","actor":{"url":"/rails","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/022/5e2b46658c8b86bed62f574d8e1793f353cbbc63_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Ruby on Rails"}},"bounty_amount":"500.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"rails","collaborator":{"username":"jcoyne","url":"/jcoyne"},"actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"id":1249,"category":"team","content":"Nested attributes rejection proc bypass in Active Record.\n\nThere is a vulnerability in how the nested attributes feature in Active Record\nhandles updates in combination with destroy flags when destroying records is\ndisabled. This vulnerability has been assigned the CVE identifier CVE-2015-7577.\n\nVersions Affected:  3.1.0 and newer\nNot affected:       3.0.x and older\nFixed Versions:     5.0.0.beta1.1, 4.2.5.1, 4.1.14.1, 3.2.22.1\n\nImpact\n------\nWhen using the nested attributes feature in Active Record you can prevent the\ndestruction of associated records by passing the `allow_destroy: false` option\nto the `accepts_nested_attributes_for` method. However due to a change in the\ncommit [a9b4b5d][1] the `_destroy` flag prevents the `:reject_if` proc from\nbeing called because it assumes that the record will be destroyed anyway.\n\nHowever this isn't true if `:allow_destroy` is false so this leads to changes\nthat would have been rejected being applied to the record. Attackers could use\nthis do things like set attributes to invalid values and to clear all of the\nattributes amongst other things. The severity will be dependent on how the\napplication has used this feature.\n\nAll users running an affected release should either upgrade or use one of\nthe workarounds immediately.\n\nReleases\n--------\nThe FIXED releases are available at the normal locations.\n\nWorkarounds\n-----------\nIf you can't upgrade, please use the following monkey patch in an initializer\nthat is loaded before your application:\n\n```\n$ cat config/initializers/nested_attributes_bypass_fix.rb\nmodule ActiveRecord\n  module NestedAttributes\n    private\n\n    def reject_new_record?(association_name, attributes)\n      will_be_destroyed?(association_name, attributes) || call_reject_if(association_name, attributes)\n    end\n\n    def call_reject_if(association_name, attributes)\n      return false if will_be_destroyed?(association_name, attributes)\n\n      case callback = self.nested_attributes_options[association_name][:reject_if]\n      when Symbol\n        method(callback).arity == 0 ? send(callback) : send(callback, attributes)\n      when Proc\n        callback.call(attributes)\n      end\n    end\n\n    def will_be_destroyed?(association_name, attributes)\n      allow_destroy?(association_name) \u0026\u0026 has_destroy_flag?(attributes)\n    end\n\n    def allow_destroy?(association_name)\n      self.nested_attributes_options[association_name][:allow_destroy]\n    end\n  end\nend\n```\n\nPatches\n-------\nTo aid users who aren't able to upgrade immediately we have provided patches for\nthe two supported release series. They are in git-am format and consist of a\nsingle changeset.\n\n* 3-2-nested-attributes-reject-if-bypass.patch - Patch for 3.2 series\n* 4-1-nested-attributes-reject-if-bypass.patch - Patch for 4.1 series\n* 4-2-nested-attributes-reject-if-bypass.patch - Patch for 4.2 series\n* 5-0-nested-attributes-reject-if-bypass.patch - Patch for 5.0 series\n\nPlease note that only the 4.1.x and 4.2.x series are supported at present. Users\nof earlier unsupported releases are advised to upgrade as soon as possible as we\ncannot guarantee the continued availability of security fixes for unsupported\nreleases.\n\nCredits\n-------\nThank you to Justin Coyne for reporting the problem and working with us to fix it.\n\n[1]: https://github.com/rails/rails/commit/a9b4b5da7c216e4464eeb9dbd0a39ea258d64325","can_view?":true,"can_edit?":false,"content_html":"\u003cp\u003eNested attributes rejection proc bypass in Active Record.\u003c/p\u003e\n\n\u003cp\u003eThere is a vulnerability in how the nested attributes feature in Active Record\u003cbr\u003e\nhandles updates in combination with destroy flags when destroying records is\u003cbr\u003e\ndisabled. This vulnerability has been assigned the CVE identifier CVE-2015-7577.\u003c/p\u003e\n\n\u003cp\u003eVersions Affected:  3.1.0 and newer\u003cbr\u003e\nNot affected:       3.0.x and older\u003cbr\u003e\nFixed Versions:     5.0.0.beta1.1, 4.2.5.1, 4.1.14.1, 3.2.22.1\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eWhen using the nested attributes feature in Active Record you can prevent the\u003cbr\u003e\ndestruction of associated records by passing the \u003ccode\u003eallow_destroy: false\u003c/code\u003e option\u003cbr\u003e\nto the \u003ccode\u003eaccepts_nested_attributes_for\u003c/code\u003e method. However due to a change in the\u003cbr\u003e\ncommit \u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Frails%2Frails%2Fcommit%2Fa9b4b5da7c216e4464eeb9dbd0a39ea258d64325\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ea9b4b5d\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e the \u003ccode\u003e_destroy\u003c/code\u003e flag prevents the \u003ccode\u003e:reject_if\u003c/code\u003e proc from\u003cbr\u003e\nbeing called because it assumes that the record will be destroyed anyway.\u003c/p\u003e\n\n\u003cp\u003eHowever this isn\u0026#39;t true if \u003ccode\u003e:allow_destroy\u003c/code\u003e is false so this leads to changes\u003cbr\u003e\nthat would have been rejected being applied to the record. Attackers could use\u003cbr\u003e\nthis do things like set attributes to invalid values and to clear all of the\u003cbr\u003e\nattributes amongst other things. The severity will be dependent on how the\u003cbr\u003e\napplication has used this feature.\u003c/p\u003e\n\n\u003cp\u003eAll users running an affected release should either upgrade or use one of\u003cbr\u003e\nthe workarounds immediately.\u003c/p\u003e\n\n\u003ch2 id=\"releases\"\u003eReleases\u003c/h2\u003e\n\n\u003cp\u003eThe FIXED releases are available at the normal locations.\u003c/p\u003e\n\n\u003ch2 id=\"workarounds\"\u003eWorkarounds\u003c/h2\u003e\n\n\u003cp\u003eIf you can\u0026#39;t upgrade, please use the following monkey patch in an initializer\u003cbr\u003e\nthat is loaded before your application:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e$ cat config/initializers/nested_attributes_bypass_fix.rb\nmodule ActiveRecord\n  module NestedAttributes\n    private\n\n    def reject_new_record?(association_name, attributes)\n      will_be_destroyed?(association_name, attributes) || call_reject_if(association_name, attributes)\n    end\n\n    def call_reject_if(association_name, attributes)\n      return false if will_be_destroyed?(association_name, attributes)\n\n      case callback = self.nested_attributes_options[association_name][:reject_if]\n      when Symbol\n        method(callback).arity == 0 ? send(callback) : send(callback, attributes)\n      when Proc\n        callback.call(attributes)\n      end\n    end\n\n    def will_be_destroyed?(association_name, attributes)\n      allow_destroy?(association_name) \u0026amp;\u0026amp; has_destroy_flag?(attributes)\n    end\n\n    def allow_destroy?(association_name)\n      self.nested_attributes_options[association_name][:allow_destroy]\n    end\n  end\nend\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"patches\"\u003ePatches\u003c/h2\u003e\n\n\u003cp\u003eTo aid users who aren\u0026#39;t able to upgrade immediately we have provided patches for\u003cbr\u003e\nthe two supported release series. They are in git-am format and consist of a\u003cbr\u003e\nsingle changeset.\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e3-2-nested-attributes-reject-if-bypass.patch - Patch for 3.2 series\u003c/li\u003e\n\u003cli\u003e4-1-nested-attributes-reject-if-bypass.patch - Patch for 4.1 series\u003c/li\u003e\n\u003cli\u003e4-2-nested-attributes-reject-if-bypass.patch - Patch for 4.2 series\u003c/li\u003e\n\u003cli\u003e5-0-nested-attributes-reject-if-bypass.patch - Patch for 5.0 series\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003ePlease note that only the 4.1.x and 4.2.x series are supported at present. Users\u003cbr\u003e\nof earlier unsupported releases are advised to upgrade as soon as possible as we\u003cbr\u003e\ncannot guarantee the continued availability of security fixes for unsupported\u003cbr\u003e\nreleases.\u003c/p\u003e\n\n\u003ch2 id=\"credits\"\u003eCredits\u003c/h2\u003e\n\n\u003cp\u003eThank you to Justin Coyne for reporting the problem and working with us to fix it.\u003c/p\u003e\n"},{"category":"researcher","can_view?":true,"can_create?":false}]}