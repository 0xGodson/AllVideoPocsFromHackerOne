{"id":241323,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yNDEzMjM=","url":"https://hackerone.com/reports/241323","title":"woocommerce - prevent_caching() bug / bypass","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2017-06-19T13:42:48.428Z","submitted_at":"2017-06-19T13:42:48.428Z","is_member_of_team?":false,"reporter":{"disabled":true,"username":"b258ea62bf297b02afa9854","url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":111,"url":"https://hackerone.com/automattic","handle":"automattic","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/111/7f89e1ea233f92916202521a069fdbfe9eced339_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/111/7f89e1ea233f92916202521a069fdbfe9eced339_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Automattic","twitter_handle":"","website":"https://automattic.com","about":"WordPress.com, VaultPress, Akismet, Gravatar, WooCommerce, Polldaddy, Tumblr and more!"}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2017-09-16T07:52:21.202Z","bug_reporter_agreed_on_going_public_at":"2017-08-17T07:52:02.627Z","team_member_agreed_on_going_public_at":null,"comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"As guest visit the following links and look at the headers. Yup there are not caching headers in the response. \n(https://woocommerce.com/.cart/)[https://woocommerce.com/.cart/]\n(https://woocommerce.com/+cart/)[https://woocommerce.com/+cart/]\n(https://woocommerce.com/-cart/)[https://woocommerce.com/-cart/]\n\n```\naccept-ranges:bytes\nage:0\ncontent-encoding:gzip\ncontent-type:text/html; charset=UTF-8\ndate:Mon, 19 Jun 2017 13:25:20 GMT\nlink:\u003chttps://woocommerce.com/wp-json/\u003e; rel=\"https://api.w.org/\"\nlink:\u003chttps://woocommerce.com/?p=18552\u003e; rel=shortlink\nserver:nginx\nset-cookie:woocommerce_items_in_cart=1; path=/\nset-cookie:woocommerce_cart_hash=c670f81df612aa5e067bc7d1a33673da; path=/\nset-cookie:wp_woocommerce_session_241766cd983ad3375c92fb5411ecef50=159536bf377374fa447e91a16437e611%7C%7C1498051468%7C%7C1498047868%7C%7Cbfae081ff1a2c69f9e4feda8128c7579; expires=Wed, 21-Jun-2017 13:24:28 GMT; Max-Age=172748; path=/\nstatus:200\nx-cache:pass\nx-hacker:If you're reading this, you should visit automattic.com/jobs and apply to join the fun, mention this header.\nx-pingback:https://woocommerce.com/xmlrpc.php\nx-rq:vie1 87 24 3240\n```\nWhat happens?\n\nFunction `prevent_caching()` in the `class-wc-cache-helper.php` have the following line of code:\n```\nif ( stristr( trailingslashit( $_SERVER['REQUEST_URI'] ), $uri ) ) {\n```\nin order to protect the `cart`, `my-account` and `checkout` dynamic pages from being cached by caching wordpress plugins ( defines the caching constants ) or cloud proxies (sets no caching headers).\n\nBut from the wordpress itself we got the following e.g. pagename query param is passed trough `sanitize_title_with_dashes` and only thing left for successful exploitation/attack in case of woocomerce instance remains to defeat the `redirect_canonical` which is bypassed by `-`, `+` and `.` characters. This means that $_SERVER['REQUEST_URI'] will have this type of value `/+my-account/` and needle will be `/my-account/`  and this will return false ofc. :)\n\nThis way in case of existing caching plugin set up to cache the wordpress pages even for logged in users, woocommerce store that allows guests to buy products or some another cases of web setups cache  deception  attack is ready to go. \n\nFix: Don't rely on the `$_SERVER['REQUEST_URI']` param, but use it query object to get the pagename.","vulnerability_information_html":"\u003cp\u003eAs guest visit the following links and look at the headers. Yup there are not caching headers in the response. \u003cbr\u003e\n(\u003ca title=\"https://woocommerce.com/.cart/)%5Bhttps://woocommerce.com/.cart/%5D\" href=\"/redirect?url=https%3A%2F%2Fwoocommerce.com%2F.cart%2F%29%255Bhttps%3A%2F%2Fwoocommerce.com%2F.cart%2F%255D\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://woocommerce.com/.cart/)%5Bhttps://woocommerce.com/.cart/%5D\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003cbr\u003e\n(\u003ca title=\"https://woocommerce.com/+cart/)%5Bhttps://woocommerce.com/+cart/%5D\" href=\"/redirect?url=https%3A%2F%2Fwoocommerce.com%2F%2Bcart%2F%29%255Bhttps%3A%2F%2Fwoocommerce.com%2F%2Bcart%2F%255D\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://woocommerce.com/+cart/)%5Bhttps://woocommerce.com/+cart/%5D\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003cbr\u003e\n(\u003ca title=\"https://woocommerce.com/-cart/)%5Bhttps://woocommerce.com/-cart/%5D\" href=\"/redirect?url=https%3A%2F%2Fwoocommerce.com%2F-cart%2F%29%255Bhttps%3A%2F%2Fwoocommerce.com%2F-cart%2F%255D\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://woocommerce.com/-cart/)%5Bhttps://woocommerce.com/-cart/%5D\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eaccept-ranges:bytes\nage:0\ncontent-encoding:gzip\ncontent-type:text/html; charset=UTF-8\ndate:Mon, 19 Jun 2017 13:25:20 GMT\nlink:\u0026lt;https://woocommerce.com/wp-json/\u0026gt;; rel=\u0026quot;https://api.w.org/\u0026quot;\nlink:\u0026lt;https://woocommerce.com/?p=18552\u0026gt;; rel=shortlink\nserver:nginx\nset-cookie:woocommerce_items_in_cart=1; path=/\nset-cookie:woocommerce_cart_hash=c670f81df612aa5e067bc7d1a33673da; path=/\nset-cookie:wp_woocommerce_session_241766cd983ad3375c92fb5411ecef50=159536bf377374fa447e91a16437e611%7C%7C1498051468%7C%7C1498047868%7C%7Cbfae081ff1a2c69f9e4feda8128c7579; expires=Wed, 21-Jun-2017 13:24:28 GMT; Max-Age=172748; path=/\nstatus:200\nx-cache:pass\nx-hacker:If you\u0026#39;re reading this, you should visit automattic.com/jobs and apply to join the fun, mention this header.\nx-pingback:https://woocommerce.com/xmlrpc.php\nx-rq:vie1 87 24 3240\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eWhat happens?\u003c/p\u003e\n\n\u003cp\u003eFunction \u003ccode\u003eprevent_caching()\u003c/code\u003e in the \u003ccode\u003eclass-wc-cache-helper.php\u003c/code\u003e have the following line of code:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eif ( stristr( trailingslashit( $_SERVER[\u0026#39;REQUEST_URI\u0026#39;] ), $uri ) ) {\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003ein order to protect the \u003ccode\u003ecart\u003c/code\u003e, \u003ccode\u003emy-account\u003c/code\u003e and \u003ccode\u003echeckout\u003c/code\u003e dynamic pages from being cached by caching wordpress plugins ( defines the caching constants ) or cloud proxies (sets no caching headers).\u003c/p\u003e\n\n\u003cp\u003eBut from the wordpress itself we got the following e.g. pagename query param is passed trough \u003ccode\u003esanitize_title_with_dashes\u003c/code\u003e and only thing left for successful exploitation/attack in case of woocomerce instance remains to defeat the \u003ccode\u003eredirect_canonical\u003c/code\u003e which is bypassed by \u003ccode\u003e-\u003c/code\u003e, \u003ccode\u003e+\u003c/code\u003e and \u003ccode\u003e.\u003c/code\u003e characters. This means that $_SERVER[\u0026#39;REQUEST_URI\u0026#39;] will have this type of value \u003ccode\u003e/+my-account/\u003c/code\u003e and needle will be \u003ccode\u003e/my-account/\u003c/code\u003e  and this will return false ofc. :)\u003c/p\u003e\n\n\u003cp\u003eThis way in case of existing caching plugin set up to cache the wordpress pages even for logged in users, woocommerce store that allows guests to buy products or some another cases of web setups cache  deception  attack is ready to go. \u003c/p\u003e\n\n\u003cp\u003eFix: Don\u0026#39;t rely on the \u003ccode\u003e$_SERVER[\u0026#39;REQUEST_URI\u0026#39;]\u003c/code\u003e param, but use it query object to get the pagename.\u003c/p\u003e\n","bounty_amount":"150.0","formatted_bounty":"$150","original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-09-16T07:52:02.687Z","allow_singular_disclosure_after":-103670163.60836205,"singular_disclosure_allowed":true,"vote_count":9,"voters":["marcs0h","sp1d3rs","cuso4","eveeez","r3y","khizer47","alfredsaonoy","tanim__","japz"],"severity":{"rating":"medium","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1765265,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"^^ sample urls\nwoocommerce (.cart)[https://woocommerce.com/.cart/]\nwoocommerce (+cart)[https://woocommerce.com/+cart/]\nwoocommerce (-cart)[https://woocommerce.com/-cart/]\n","markdown_message":"\u003cp\u003e^^ sample urls\u003cbr\u003e\nwoocommerce (.cart)[\u003ca title=\"https://woocommerce.com/.cart/\" href=\"/redirect?url=https%3A%2F%2Fwoocommerce.com%2F.cart%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://woocommerce.com/.cart/\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e]\u003cbr\u003e\nwoocommerce (+cart)[\u003ca title=\"https://woocommerce.com/+cart/\" href=\"/redirect?url=https%3A%2F%2Fwoocommerce.com%2F%2Bcart%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://woocommerce.com/+cart/\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e]\u003cbr\u003e\nwoocommerce (-cart)[\u003ca title=\"https://woocommerce.com/-cart/\" href=\"/redirect?url=https%3A%2F%2Fwoocommerce.com%2F-cart%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://woocommerce.com/-cart/\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e]\u003c/p\u003e\n","automated_response":false,"created_at":"2017-06-19T13:45:05.747Z","updated_at":"2017-06-19T13:45:05.747Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"automattic","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1766471,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for the report, I'll forward this to the WC team for review.","markdown_message":"\u003cp\u003eThanks for the report, I\u0026#39;ll forward this to the WC team for review.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-06-19T20:08:44.091Z","updated_at":"2017-06-19T20:08:44.091Z","actor":{"username":"vortfu","cleared":false,"url":"/vortfu","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/982/1ef285fb263d30f189dc6a8038e1d5c46086e9d9_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"automattic","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1766513,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I would give more restrictive advice (wc caching advice)[https://docs.woocommerce.com/document/configuring-caching-plugins/] While they are on the issue, maybe can do something on the docs page which is first on google search. ","markdown_message":"\u003cp\u003eI would give more restrictive advice (wc caching advice)[\u003ca title=\"https://docs.woocommerce.com/document/configuring-caching-plugins/\" href=\"/redirect?url=https%3A%2F%2Fdocs.woocommerce.com%2Fdocument%2Fconfiguring-caching-plugins%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://docs.woocommerce.com/document/configuring-caching-plugins/\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e] While they are on the issue, maybe can do something on the docs page which is first on google search. \u003c/p\u003e\n","automated_response":false,"created_at":"2017-06-19T20:23:53.987Z","updated_at":"2017-06-19T20:23:53.987Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"automattic","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1794305,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I saw it fixed week ago, any troubles regarding this one? Greetings from sunny beach in Greece :)))","markdown_message":"\u003cp\u003eI saw it fixed week ago, any troubles regarding this one? Greetings from sunny beach in Greece :)))\u003c/p\u003e\n","automated_response":false,"created_at":"2017-06-30T14:49:04.369Z","updated_at":"2017-06-30T14:49:04.369Z","actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"automattic","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1815733,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","markdown_message":"","automated_response":false,"created_at":"2017-07-07T21:25:33.511Z","updated_at":"2017-07-07T21:25:33.511Z","actor":{"username":"vortfu","cleared":false,"url":"/vortfu","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/004/982/1ef285fb263d30f189dc6a8038e1d5c46086e9d9_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"b258ea62bf297b02afa9854","url":"/b258ea62bf297b02afa9854"},"genius_execution_id":null,"team_handle":"automattic","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1815734,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"","markdown_message":"","automated_response":false,"created_at":"2017-07-07T21:26:19.230Z","updated_at":"2017-07-07T21:26:19.230Z","actor":{"url":"/automattic","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/111/7f89e1ea233f92916202521a069fdbfe9eced339_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Automattic"}},"bounty_amount":"100.0","bounty_currency":"usd","bonus_amount":"50.0","genius_execution_id":null,"team_handle":"automattic","collaborator":{"username":"b258ea62bf297b02afa9854","url":"/b258ea62bf297b02afa9854"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1935348,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-08-17T07:52:02.650Z","updated_at":"2017-08-17T07:52:02.650Z","first_to_agree":true,"actor":{"username":"b258ea62bf297b02afa9854","cleared":false,"url":"/b258ea62bf297b02afa9854","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"automattic","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":2000964,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-09-16T07:52:21.232Z","updated_at":"2017-09-16T07:52:21.232Z","actor":{"url":"/automattic","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/111/7f89e1ea233f92916202521a069fdbfe9eced339_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Automattic"}},"genius_execution_id":null,"team_handle":"automattic","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}