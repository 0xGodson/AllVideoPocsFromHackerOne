{"id":181695,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8xODE2OTU=","url":"https://hackerone.com/reports/181695","title":"Undefined method_missing null pointer dereference","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2016-11-12T03:27:22.300Z","submitted_at":"2016-11-12T03:27:22.300Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"charliesome","url":"/charliesome","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/001/738/78470971e95623d272226b011823c8590ffe6cf3_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":false,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":15668,"url":"https://hackerone.com/shopify-scripts","handle":"shopify-scripts","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"paused","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"shopify-scripts","twitter_handle":"","website":"","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2016-12-17T01:03:38.615Z","bug_reporter_agreed_on_going_public_at":"2016-12-17T01:03:38.543Z","team_member_agreed_on_going_public_at":"2016-12-16T19:48:28.097Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"It's possible to segfault mruby by undefining `BasicObject#method_missing` in certain cases.\n\nThere is a fallback method_missing C function (`mrb_method_missing`) which is called in _some_ cases when the VM fails to look up the `method_missing` method:\n\n    \u003e BasicObject.remove_method(:method_missing); 1.foo\n    NoMethodError: undefined method 'foo' for 1\n\nHowever the `mrb_method_missing` fallback is not consistently used.\n\n`Kernel#__send__` calls into `mrb_funcall_with_block` in `vm.c`, which contains the following code at line 362 (as of commit 88604e39ac9c25ffdad2e3f03be26516fe866038):\n\n        c = mrb_class(mrb, self);\n        p = mrb_method_search_vm(mrb, \u0026c, mid);\n        if (!p) {\n          undef = mid;\n          mid = mrb_intern_lit(mrb, \"method_missing\");\n          p = mrb_method_search_vm(mrb, \u0026c, mid);\n          n++; argc++;\n        }\n\nIf the method search for `method_missing` fails, `p` will be a null pointer. Further down on line 380, `p` is tested with `MRB_PROC_CFUNC_P`, which deferences `p`.\n\nThis segfault can be reproduced with the following code:\n\n    BasicObject.remove_method(:method_missing)\n    1.__send__(:foo)\n\nThe method search logic in the `OP_SUPER` instruction is also buggy. The same bug can be triggered through `OP_SUPER` with the following code:\n\n    BasicObject.remove_method(:method_missing)\n\n    class A\n      def foo\n        super\n      end\n    end\n\n    A.new.foo\n\nI'm not familiar enough with the mruby VM internals to write a patch for this. It _should_ just be a matter of making sure `mrb_method_missing` is called if a `method_missing` method search fails (as the logic in `OP_SEND` instruction does).","vulnerability_information_html":"\u003cp\u003eIt\u0026#39;s possible to segfault mruby by undefining \u003ccode\u003eBasicObject#method_missing\u003c/code\u003e in certain cases.\u003c/p\u003e\n\n\u003cp\u003eThere is a fallback method_missing C function (\u003ccode\u003emrb_method_missing\u003c/code\u003e) which is called in \u003cu\u003esome\u003c/u\u003e cases when the VM fails to look up the \u003ccode\u003emethod_missing\u003c/code\u003e method:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e\u0026gt; BasicObject.remove_method(:method_missing); 1.foo\nNoMethodError: undefined method \u0026#39;foo\u0026#39; for 1\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eHowever the \u003ccode\u003emrb_method_missing\u003c/code\u003e fallback is not consistently used.\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eKernel#__send__\u003c/code\u003e calls into \u003ccode\u003emrb_funcall_with_block\u003c/code\u003e in \u003ccode\u003evm.c\u003c/code\u003e, which contains the following code at line 362 (as of commit 88604e39ac9c25ffdad2e3f03be26516fe866038):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e    c = mrb_class(mrb, self);\n    p = mrb_method_search_vm(mrb, \u0026amp;c, mid);\n    if (!p) {\n      undef = mid;\n      mid = mrb_intern_lit(mrb, \u0026quot;method_missing\u0026quot;);\n      p = mrb_method_search_vm(mrb, \u0026amp;c, mid);\n      n++; argc++;\n    }\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eIf the method search for \u003ccode\u003emethod_missing\u003c/code\u003e fails, \u003ccode\u003ep\u003c/code\u003e will be a null pointer. Further down on line 380, \u003ccode\u003ep\u003c/code\u003e is tested with \u003ccode\u003eMRB_PROC_CFUNC_P\u003c/code\u003e, which deferences \u003ccode\u003ep\u003c/code\u003e.\u003c/p\u003e\n\n\u003cp\u003eThis segfault can be reproduced with the following code:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eBasicObject.remove_method(:method_missing)\n1.__send__(:foo)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe method search logic in the \u003ccode\u003eOP_SUPER\u003c/code\u003e instruction is also buggy. The same bug can be triggered through \u003ccode\u003eOP_SUPER\u003c/code\u003e with the following code:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003eBasicObject.remove_method(:method_missing)\n\nclass A\n  def foo\n    super\n  end\nend\n\nA.new.foo\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eI\u0026#39;m not familiar enough with the mruby VM internals to write a patch for this. It \u003cu\u003eshould\u003c/u\u003e just be a matter of making sure \u003ccode\u003emrb_method_missing\u003c/code\u003e is called if a \u003ccode\u003emethod_missing\u003c/code\u003e method search fails (as the logic in \u003ccode\u003eOP_SEND\u003c/code\u003e instruction does).\u003c/p\u003e\n","bounty_amount":"8000.0","formatted_bounty":"$8,000","weakness":{"id":48,"name":"Denial of Service"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-01-15T19:48:28.122Z","allow_singular_disclosure_after":-124707429.55178915,"singular_disclosure_allowed":true,"vote_count":6,"voters":["mpz","eveeez","spetr0x","scept1c","elakrimi","no-longer-with-company"],"severity":{"rating":"high","author_type":"Team"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1298732,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","markdown_message":"","automated_response":false,"created_at":"2016-11-14T17:51:17.094Z","updated_at":"2016-11-14T17:51:17.094Z","additional_data":{"old_severity":null,"new_severity":"Medium","old_severity_id":null,"new_severity_id":7507},"actor":{"username":"bvdbijl","cleared":false,"url":"/bvdbijl","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1299332,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"Thank you for your report! We've reproduced the issue, and our engineering team is working on a fix.","markdown_message":"\u003cp\u003eThank you for your report! We\u0026#39;ve reproduced the issue, and our engineering team is working on a fix.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-14T21:47:38.134Z","updated_at":"2016-11-14T21:47:38.134Z","actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1299333,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","markdown_message":"","automated_response":false,"created_at":"2016-11-14T21:47:44.796Z","updated_at":"2016-11-14T21:47:44.796Z","additional_data":{"old_severity":"Medium","new_severity":"High","old_severity_id":7507,"new_severity_id":7543},"actor":{"username":"clayton","cleared":false,"url":"/clayton","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/YKjJrQvn996bd2n67ELXwtHt/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1307420,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Again thank you for your report! We've deployed a fix for this in our production environment as of earlier today.\n\nI'm marking this issue as resolved now but we still need to fix this bug upstream before we can assess the impact \u0026 determine a final bounty amount. This may take a few weeks since we received a large number of valid issues and we want to calibrate our payouts across all of them.","markdown_message":"\u003cp\u003eAgain thank you for your report! We\u0026#39;ve deployed a fix for this in our production environment as of earlier today.\u003c/p\u003e\n\n\u003cp\u003eI\u0026#39;m marking this issue as resolved now but we still need to fix this bug upstream before we can assess the impact \u0026amp; determine a final bounty amount. This may take a few weeks since we received a large number of valid issues and we want to calibrate our payouts across all of them.\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-18T20:45:17.717Z","updated_at":"2016-11-18T20:45:17.717Z","actor":{"username":"francoischagnon","cleared":false,"url":"/francoischagnon","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/168/5d577fe97283a5483331257b629b6287ed4d287b_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"charliesome","url":"/charliesome"},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1319250,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"We opened a PR with mruby to fix this issue: https://github.com/mruby/mruby/pull/3291/files","markdown_message":"\u003cp\u003eWe opened a PR with mruby to fix this issue: \u003ca title=\"https://github.com/mruby/mruby/pull/3291/files\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fmruby%2Fmruby%2Fpull%2F3291%2Ffiles\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/mruby/mruby/pull/3291/files\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n","automated_response":false,"created_at":"2016-11-25T16:00:46.791Z","updated_at":"2016-11-25T16:00:46.791Z","actor":{"username":"francoischagnon","cleared":false,"url":"/francoischagnon","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/168/5d577fe97283a5483331257b629b6287ed4d287b_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1370011,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks for helping improve the security of Shopify Scripts and the mruby project!","markdown_message":"\u003cp\u003eThanks for helping improve the security of Shopify Scripts and the mruby project!\u003c/p\u003e\n","automated_response":false,"created_at":"2016-12-16T19:48:21.120Z","updated_at":"2016-12-16T19:48:21.120Z","actor":{"url":"/shopify-scripts","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/015/668/ebbe467de8ef2fc936053593e1289e30f04c3b06_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"shopify-scripts"}},"bounty_amount":"8000.0","bounty_currency":"usd","genius_execution_id":null,"team_handle":"shopify-scripts","collaborator":{"username":"charliesome","url":"/charliesome"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1370012,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2016-12-16T19:48:28.110Z","updated_at":"2016-12-16T19:48:28.110Z","first_to_agree":true,"actor":{"username":"andrewdunbar","cleared":false,"url":"/andrewdunbar","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/164/5b0e89675ed6dbb9df87223e9f8f58e2125bb56b_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1370647,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2016-12-17T01:03:38.590Z","updated_at":"2016-12-17T01:03:38.590Z","actor":{"username":"charliesome","cleared":false,"url":"/charliesome","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/001/738/78470971e95623d272226b011823c8590ffe6cf3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1370648,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2016-12-17T01:03:38.634Z","updated_at":"2016-12-17T01:03:38.634Z","actor":{"username":"charliesome","cleared":false,"url":"/charliesome","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/001/738/78470971e95623d272226b011823c8590ffe6cf3_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify-scripts","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}