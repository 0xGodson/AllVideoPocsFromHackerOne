{"id":684152,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC82ODQxNTI=","url":"https://hackerone.com/reports/684152","title":"Steal all MKR from `flap` during liquidation by exploiting lack of validation in `flap.kick`","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2019-08-29T07:18:26.210Z","submitted_at":"2019-08-29T07:18:26.210Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"lucash-dev","url":"/lucash-dev","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/515/399/dd4a50c732c98417d7be59efa049e8c234259884_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":38065,"url":"https://hackerone.com/makerdao_bbp","handle":"makerdao_bbp","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/PxXdq1Fo6fX6n4fzUk31AqPD/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/PxXdq1Fo6fX6n4fzUk31AqPD/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Maker Ecosystem Growth Holdings, Inc","twitter_handle":"makerdao","website":"https://makerdao.com/","about":""}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2019-09-26T15:34:59.756Z","bug_reporter_agreed_on_going_public_at":"2019-09-26T15:34:59.686Z","team_member_agreed_on_going_public_at":"2019-09-25T17:59:15.207Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"## Summary:\nThe `flap` contract provides the ability to auction DAI for MKR. That's a fundamental functionality of the MCD system, invoked usually from the `vow` contract.\nA flaw in the validation of calls to `flap.kick`, however, allows a malicious user to create \"fake' auctions that can be later used to steal MKR from `flap` during the liquidation (`end`) phase.\n\n## Detailed description\n\nThe method `flap.kick`, used to start an auction of DAI (for MKR) in the `flap` contract, lacks any validation of the `bid` parameter. Since the method is public, a malicious user can directly invoke it, passing an arbitrary `bid` parameter -- affecting other contracts that assume this value represents the highest bid in the auction.\n\nWhile it's possible that this issue will cause other problems, in this report I'll focus on what seems to be the highest severity attack enabled by it.\n\nThe attack consists of two parts:\n\n1 - During the normal operation of the MCD system (contracts not \"caged\"), the attacker will create one or more \"fake\" auctions by calling `flap.kick`. The `bid` parameter can be arbitrarily large, and won't be validated in any way. On the other hand, the `lot` parameter can be arbitrarily small, as long as it's not zero, which means the auction can be placed with almost zero cost.\n\n2 - After governance calls `end.cage`, the auctions are stopped -- but any MKR deposited in the `flap` contract for any outstanding auction will still be there until someone calls `yank` for each one.\nAt this point, the attacker can call `flap.yank` for his own \"fake\" auctions, and that will result in him getting MKR transferred from the `flap` contract to himself -- in whatever amount was specified as `bid` in step 1.\n\nSince the attacker might no know beforehand, it would be wise for them to create multiple \"fake\" auctions. In particular, an exponential series of auctions, with `bid` values 1, 2, 4, 8, 16... will allow the attacker to extract any exact amount of MKR from the `flap` contract.\n\n\n## Steps To Reproduce:\nI've attached to this report a modified version of `end.t.sol` which contains a test (the last one, `test_steal_mkr_from_flapper`) that reproduces this attack.\n\nPlease don't hesitate to contact me if you have any trouble understanding or reproducing this issue.\n\n## Impact\n\nThis issue allows an attacker to steal arbitrary amounts of MKR deposited for auction.\nThat impact is particularly troubling, as MKR tokens are used to govern the platform, and anyone maliciously obtaining large quantities of these tokens might use them to further affect other core functionalities, potentially leading to stealing collateral, DAI etc. Also, because the same MKR token might be used for governance of future versions of the contracts, the damage might be much more enduring and harder to mitigate.\n\nGiven the above, and the minimal cost for perpetrating the attack, this issue would normally be classified as Critical. The specific policies for this program, though, won't allow for that, since this attack doesn't steal collateral directly. So, I classified the severity as High.","vulnerability_information_html":"\u003ch2 id=\"summary\"\u003eSummary:\u003c/h2\u003e\n\n\u003cp\u003eThe \u003ccode\u003eflap\u003c/code\u003e contract provides the ability to auction DAI for MKR. That\u0026#39;s a fundamental functionality of the MCD system, invoked usually from the \u003ccode\u003evow\u003c/code\u003e contract.\u003cbr\u003e\nA flaw in the validation of calls to \u003ccode\u003eflap.kick\u003c/code\u003e, however, allows a malicious user to create \u0026quot;fake\u0026#39; auctions that can be later used to steal MKR from \u003ccode\u003eflap\u003c/code\u003e during the liquidation (\u003ccode\u003eend\u003c/code\u003e) phase.\u003c/p\u003e\n\n\u003ch2 id=\"detailed-description\"\u003eDetailed description\u003c/h2\u003e\n\n\u003cp\u003eThe method \u003ccode\u003eflap.kick\u003c/code\u003e, used to start an auction of DAI (for MKR) in the \u003ccode\u003eflap\u003c/code\u003e contract, lacks any validation of the \u003ccode\u003ebid\u003c/code\u003e parameter. Since the method is public, a malicious user can directly invoke it, passing an arbitrary \u003ccode\u003ebid\u003c/code\u003e parameter -- affecting other contracts that assume this value represents the highest bid in the auction.\u003c/p\u003e\n\n\u003cp\u003eWhile it\u0026#39;s possible that this issue will cause other problems, in this report I\u0026#39;ll focus on what seems to be the highest severity attack enabled by it.\u003c/p\u003e\n\n\u003cp\u003eThe attack consists of two parts:\u003c/p\u003e\n\n\u003cp\u003e1 - During the normal operation of the MCD system (contracts not \u0026quot;caged\u0026quot;), the attacker will create one or more \u0026quot;fake\u0026quot; auctions by calling \u003ccode\u003eflap.kick\u003c/code\u003e. The \u003ccode\u003ebid\u003c/code\u003e parameter can be arbitrarily large, and won\u0026#39;t be validated in any way. On the other hand, the \u003ccode\u003elot\u003c/code\u003e parameter can be arbitrarily small, as long as it\u0026#39;s not zero, which means the auction can be placed with almost zero cost.\u003c/p\u003e\n\n\u003cp\u003e2 - After governance calls \u003ccode\u003eend.cage\u003c/code\u003e, the auctions are stopped -- but any MKR deposited in the \u003ccode\u003eflap\u003c/code\u003e contract for any outstanding auction will still be there until someone calls \u003ccode\u003eyank\u003c/code\u003e for each one.\u003cbr\u003e\nAt this point, the attacker can call \u003ccode\u003eflap.yank\u003c/code\u003e for his own \u0026quot;fake\u0026quot; auctions, and that will result in him getting MKR transferred from the \u003ccode\u003eflap\u003c/code\u003e contract to himself -- in whatever amount was specified as \u003ccode\u003ebid\u003c/code\u003e in step 1.\u003c/p\u003e\n\n\u003cp\u003eSince the attacker might no know beforehand, it would be wise for them to create multiple \u0026quot;fake\u0026quot; auctions. In particular, an exponential series of auctions, with \u003ccode\u003ebid\u003c/code\u003e values 1, 2, 4, 8, 16... will allow the attacker to extract any exact amount of MKR from the \u003ccode\u003eflap\u003c/code\u003e contract.\u003c/p\u003e\n\n\u003ch2 id=\"steps-to-reproduce\"\u003eSteps To Reproduce:\u003c/h2\u003e\n\n\u003cp\u003eI\u0026#39;ve attached to this report a modified version of \u003ccode\u003eend.t.sol\u003c/code\u003e which contains a test (the last one, \u003ccode\u003etest_steal_mkr_from_flapper\u003c/code\u003e) that reproduces this attack.\u003c/p\u003e\n\n\u003cp\u003ePlease don\u0026#39;t hesitate to contact me if you have any trouble understanding or reproducing this issue.\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eThis issue allows an attacker to steal arbitrary amounts of MKR deposited for auction.\u003cbr\u003e\nThat impact is particularly troubling, as MKR tokens are used to govern the platform, and anyone maliciously obtaining large quantities of these tokens might use them to further affect other core functionalities, potentially leading to stealing collateral, DAI etc. Also, because the same MKR token might be used for governance of future versions of the contracts, the damage might be much more enduring and harder to mitigate.\u003c/p\u003e\n\n\u003cp\u003eGiven the above, and the minimal cost for perpetrating the attack, this issue would normally be classified as Critical. The specific policies for this program, though, won\u0026#39;t allow for that, since this attack doesn\u0026#39;t steal collateral directly. So, I classified the severity as High.\u003c/p\u003e\n","bounty_amount":"10000.0","formatted_bounty":"$10,000","weakness":{"id":107,"name":"Improper Input Validation"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":569418,"file_name":"steal-mkr-flap.t.sol","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/Q45Veqfp8RMbKPKU6vDbxetm?response-content-disposition=attachment%3B%20filename%3D%22steal-mkr-flap.t.sol%22%3B%20filename%2A%3DUTF-8%27%27steal-mkr-flap.t.sol\u0026response-content-type=application%2Foctet-stream\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQRVDVIAIN%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T063748Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ3%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQCIE32Mqh2tZr%2BOU5TpCkMAcCIP7cUR4Cmx6knF0aE1pAIhANosl%2BxHV6Q%2F51LP%2Fec3HeAsrkcv3Oonagtggk2l2fcHKrQDCFYQARoMMDEzNjE5Mjc0ODQ5IgyvivkNb%2F%2FihtanvJsqkQOxVl0vet745bZV8lQI5KYtwTWpcIFAsML7JxymD3vn9i8QCWhlYeT2MW%2B9baTQMb%2BdveMhrdwbKcBh3ip%2ByweQnVl9ueQzetzoXpB5k2WZrDCF3m0PA%2BCv6ox3XmJRewIkURiq4Ztl%2BHyUPdAtuOYZDYkHGUB8OqZgDmy0YoWLDqNPzGZK7dX7v62QUuo2TiCO%2BWHnWiVN2sIAHkLQ1c0cRYR2hre0%2FHfkXdHak9EM%2FJlTAH%2BQnt3DZGo6v788Hni0I1X%2F70QyGnfzTEgA8%2Fvb6vKESyULs14SrfKtlo9En1u2T1%2B79JNxVdhJNX%2BfERg06V3dMkcO%2BhECVPAWHzRrJ3bTOIIfgttUE3yW5ViJmecveb28ezf1szEuiXvW%2BZQUdTtFctgvSq22L57hu2QitzJ%2F7EFXuPPyfSKn70goiFML2nsYjayzP2jOzI85Wf0PZwwCg%2BTr7Ldre4VPxLs2y%2BAhqKPahi9iLDrk5IVFZPWBWrmRjgRlhjIP7aYZzYQEoqoD%2F3susXDMHlsiMv8yoDDN6ar%2FBTrqAdSZzhKXhWU9aDM9pF9urQto0LgyoOSxshu8McAhBrfa%2FReNxxcISybiMxPssa8oRShR7XUSBWuVRE7CnX5MQKY6UeaUB8HDokdym3sz7IA0tuq64XmfywVqSVqOZTRnXaNG%2BObO1m4FlOQ%2FC4n%2Fbe50N8rAEPnkWd81lyuaeMezjo4O%2BlEpCZ%2ByBXnfl88Bjx8KUaMIVJ5VHQ8J6PBiG%2FjOWow2rty2SDO%2BTqlQJxjPwbenYT7WUyEPOBmi%2FZgSy9qD6EP%2B5GMYGk0q2R6LmuTGm6QPTGNHaZ%2BHqK3PMyvOo0eC1hMcq6KJ8g%3D%3D\u0026X-Amz-Signature=4776036838f39a237c36c8d45a55cbc5d66d6519fe26e13a6f0c81ea5504eb59","file_size":25099,"type":"application/octet-stream"}],"allow_singular_disclosure_at":null,"vote_count":54,"voters":["env","dittyroma","sultancad","n1m0","mashoud1122","spam404","sameerphad72","zonduu","titus","mygf","and 44 more..."],"severity":{"rating":"high","author_type":"User"},"structured_scope":{"databaseId":34664,"asset_type":"OTHER","asset_identifier":"MCD_FLAP","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":5690667,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks, lucash-dev! We will investigate and return here.","markdown_message":"\u003cp\u003eThanks, lucash-dev! We will investigate and return here.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-08-29T12:16:23.430Z","updated_at":"2019-08-29T12:16:23.430Z","actor":{"username":"lasse_y44rf","cleared":false,"url":"/lasse_y44rf","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"makerdao_bbp","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5701164,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @lucash-dev,\n\nThank you for your submission. Your report is currently being reviewed and the HackerOne triage team will get back to you once there is additional information to share.\n\nKind regards,\n@sodacan\n","markdown_message":"\u003cp\u003eHi \u003ca href=\"/lucash-dev\"\u003e@lucash-dev\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eThank you for your submission. Your report is currently being reviewed and the HackerOne triage team will get back to you once there is additional information to share.\u003c/p\u003e\n\n\u003cp\u003eKind regards,\u003cbr\u003e\n\u003ca href=\"/sodacan\"\u003e@sodacan\u003c/a\u003e\u003c/p\u003e\n","automated_response":false,"created_at":"2019-08-30T21:02:17.252Z","updated_at":"2019-08-30T21:02:17.252Z","actor":{"username":"sodacan","cleared":false,"url":"/sodacan","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/397/342/f09b69d30e08f05bbd6f12bf02200844bdf46f11_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":true,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"makerdao_bbp","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":5739469,"is_internal":false,"editable":false,"type":"Activities::BugTriaged","message":"We are investigating this and will get back to you soon","markdown_message":"\u003cp\u003eWe are investigating this and will get back to you soon\u003c/p\u003e\n","automated_response":false,"created_at":"2019-09-05T14:23:52.267Z","updated_at":"2019-09-05T14:23:52.267Z","actor":{"username":"iamchrissmith","cleared":false,"url":"/iamchrissmith","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"makerdao_bbp","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5889672,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"@lucash-dev, again, thank you much for finding this bug. \n\nWe agree with you that this does not meet the requirements of a Critical bug as it does not involve collateral.  However, because it results in MKR token being stolen, we felt it was higher than the baseline \"High\" severity award. \n\nWe implemented a fix for the bug [here]([https://github.com/makerdao/dss/pull/68](https://github.com/makerdao/dss/pull/68)), would like to disclose your report. \n\nThank you and we look forward to hearing about any other bugs you discover!","markdown_message":"\u003cp\u003e\u003ca href=\"/lucash-dev\"\u003e@lucash-dev\u003c/a\u003e, again, thank you much for finding this bug. \u003c/p\u003e\n\n\u003cp\u003eWe agree with you that this does not meet the requirements of a Critical bug as it does not involve collateral.  However, because it results in MKR token being stolen, we felt it was higher than the baseline \u0026quot;High\u0026quot; severity award. \u003c/p\u003e\n\n\u003cp\u003eWe implemented a fix for the bug [here](\u003ca href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fmakerdao%2Fdss%2Fpull%2F68\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/makerdao/dss/pull/68\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e), would like to disclose your report. \u003c/p\u003e\n\n\u003cp\u003eThank you and we look forward to hearing about any other bugs you discover!\u003c/p\u003e\n","automated_response":false,"created_at":"2019-09-25T17:57:22.505Z","updated_at":"2019-09-25T17:57:22.505Z","actor":{"url":"/makerdao_bbp","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/PxXdq1Fo6fX6n4fzUk31AqPD/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Maker Ecosystem Growth Holdings, Inc"}},"bounty_amount":"5000.0","bounty_currency":"usd","bonus_amount":"5000.0","genius_execution_id":null,"team_handle":"makerdao_bbp","collaborator":{"username":"lucash-dev","url":"/lucash-dev"},"actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5889681,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","markdown_message":"","automated_response":false,"created_at":"2019-09-25T17:59:02.530Z","updated_at":"2019-09-25T17:59:02.530Z","actor":{"username":"iamchrissmith","cleared":false,"url":"/iamchrissmith","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"lucash-dev","url":"/lucash-dev"},"genius_execution_id":null,"team_handle":"makerdao_bbp","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5889682,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2019-09-25T17:59:15.229Z","updated_at":"2019-09-25T17:59:15.229Z","first_to_agree":true,"actor":{"username":"iamchrissmith","cleared":false,"url":"/iamchrissmith","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"makerdao_bbp","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5896782,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Hi, @iamchrissmith.\n\nThank you very much for the bounty! I'm agreeing to the disclosure.\n\nHope to keep contributing to your program in the future!","markdown_message":"\u003cp\u003eHi, \u003ca href=\"/iamchrissmith\"\u003e@iamchrissmith\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003eThank you very much for the bounty! I\u0026#39;m agreeing to the disclosure.\u003c/p\u003e\n\n\u003cp\u003eHope to keep contributing to your program in the future!\u003c/p\u003e\n","automated_response":false,"created_at":"2019-09-26T15:34:59.707Z","updated_at":"2019-09-26T15:34:59.707Z","actor":{"username":"lucash-dev","cleared":true,"url":"/lucash-dev","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/515/399/dd4a50c732c98417d7be59efa049e8c234259884_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"makerdao_bbp","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":5896783,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2019-09-26T15:34:59.778Z","updated_at":"2019-09-26T15:34:59.778Z","actor":{"username":"lucash-dev","cleared":true,"url":"/lucash-dev","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/515/399/dd4a50c732c98417d7be59efa049e8c234259884_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"makerdao_bbp","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}