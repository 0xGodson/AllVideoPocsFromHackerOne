{"id":541169,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC81NDExNjk=","url":"https://hackerone.com/reports/541169","title":"GitLab::UrlBlocker validation bypass leading to full Server Side Request Forgery","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2019-04-17T09:18:36.964Z","submitted_at":"2019-04-17T09:18:36.964Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"ajxchapman","url":"/ajxchapman","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/141/831/67daf6985b76c1867ff3f442fe5910bb329ee0b4_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":264,"url":"https://hackerone.com/gitlab","handle":"gitlab","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"GitLab","twitter_handle":"gitlab","website":"https://about.gitlab.com","about":"A single application for the entire software development lifecycle."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2019-12-12T11:56:05.168Z","bug_reporter_agreed_on_going_public_at":"2019-12-11T10:18:56.271Z","team_member_agreed_on_going_public_at":"2019-12-12T11:56:05.010Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"### Summary\nThe `GitLab::UrlBlocker` IP address validation methods suffer from a Time of Check to Time of Use (ToCToU) vulnerability. The vulnerability occurs due to multiple DNS resolution requests performed before and after the checks. This issue allows a malicious authenticated user to send GET and POST HTTP requests to arbitrary hosts, including the localhost, cloud metadata services and the local network, and read the HTTP response.\n\n### Details\nThe IP address validation code in `/lib/gitlab/url_blocker.rb` resolves the IP addresses of the provided URL domain, raises an exception if the resolved IP addresses match addresses in block lists (`127.0.0.1`, `::1`, `169.254.0.0/16`, etc.) or returns `true` if the IP address do not match the block lists.\n```ruby\n  begin\n    addrs_info = Addrinfo.getaddrinfo(uri.hostname, port, nil, :STREAM).map do |addr|\n      addr.ipv6_v4mapped? ? addr.ipv6_to_ipv4 : addr\n    end\n  rescue SocketError\n    return true\n  end\n\n  validate_localhost!(addrs_info) unless allow_localhost\n  validate_loopback!(addrs_info) unless allow_localhost\n  validate_local_network!(addrs_info) unless allow_local_network\n  validate_link_local!(addrs_info) unless allow_local_network\n\n  true\nend\n```\nIf the address validates the `GitLab::HTTP` code then uses `HTTParty` to request the URL, which performs a second URL domain DNS resolution. The address validation checks can be bypassed if the URL domain resolves to a valid address for the first resolution then a forbidden address after the checks are performed. \n\nIn order to perform this attack a DNS server must be configured to resolve a domain to alternating addresses with a low (or zero) Time To Live. To demonstrate this issue I used my researchersservers project (https://github.com/ajxchapman/sshreverseshell) with the configuration in {F470655}. Output of resolving `gitlabextssrf.webhooks.pw` against this DNS resolver configuration is shown below:\n```sh\n$ dig +noall +answer gitlabextssrf.webhooks.pw\ngitlabextssrf.webhooks.pw. 0    IN      A       198.211.125.160\n$ dig +noall +answer gitlabextssrf.webhooks.pw\ngitlabextssrf.webhooks.pw. 0    IN      A       198.211.125.160\n$ dig +noall +answer gitlabextssrf.webhooks.pw\ngitlabextssrf.webhooks.pw. 0    IN      A       127.0.0.1\n$ dig +noall +answer gitlabextssrf.webhooks.pw\ngitlabextssrf.webhooks.pw. 0    IN      A       127.0.0.1\n$ dig +noall +answer gitlabextssrf.webhooks.pw\ngitlabextssrf.webhooks.pw. 0    IN      A       198.211.125.160\n```\nNotice the alternating resolved IP address and 0 ttl.\n\n### Attack scenario\nUsing the Web Hook integration functionality of a GitLab repository, this issue can be abused to send HTTP GET and POST requests to arbitrary IP addresses, with arbitrary path parameters. The following screenshot shows the response of an HTTP GET request to `http://169.254.169.254/metadata/v1.json` on a DigitalOcean droplet:\n{F470641}\n\n### Steps to reproduce\nTo demonstrate this issue I have configured the domain `gitladextssrf.webhooks.pw` to randomly resolve to either `198.211.125.160` or `127.0.0.1`.\n\n1. Create a new repository\n1. Add a commit to the repository\n1. Create a new Web Hook integration with the URL http://gitlabextssrf.webhooks.pw:9999.\n  * This may take several attempts due to the random nature of the `gitlabextssrf.webhooks.pw` DNS resolver, if it fails with a `500` error, try again until it is accepted.\n1. Log into the gitlab server and start a TCP listener on port 9999/tcp (e.g. `nc -vvn -l -p 9999`)\n1. Perform numerous parallel requests to the Web Hook test endpoint. For this I use `wfuzz`\n\n```sh\n$ ./wfuzz -X POST \\\n  -b \"_gitlab_session=\u003csession_id\u003e;\" \\\n  -d \"_method=post\u0026authenticity_token=\u003ctoken\u003e\" \\\n  -z range,0-1000 \\\n  \"https://\u003cdomain\u003e/\u003cuser\u003e/\u003crepo\u003e/hooks/\u003chook_id\u003e/test?trigger=push_events\u0026test=FUZZ\"\n```\nThe the below video demonstration of reproducing this issue:\n{F470642}\n\nAfter several requests a connection will be made to the local TCP listener on port 9999/tcp.\n\n### Impact\nThis issue allows a malicious authenticated user to send GET and POST HTTP requests from the GitLab server to arbitrary hosts (including the localhost, cloud metadata services and the local network) with arbitrary paths, and read the HTTP response. This could be abused to compromise the host (e.g. leaking AWS tokens from the metadata service), or perform reconnaissance and exploitation of hosts on the local network.\n\n### What is the current *bug* behavior?\nThe `GitLab::UrlBlocker` validation code resolves the IP addresses of a URL domain, validates them against a series of block lists, and if valid returns to the `GitLab::HTTP` module which re-resolves the URL domain in order to perform the HTTP request.\n\n### What is the expected *correct* behavior?\nThe validated resolved addresses should be returned by `GitLab::UrlBlocker` and used by `GitLab::HTTP` to make the TCP connection to the destination host.\n\n### Relevant logs and/or screenshots\nOutput of using the ToCToU bypass in a Web Hook to send a request to the DigitalOcean droplet meta data API `http://169.254.169.254/metadata/v1.json` endpoint:\n{F470641}\n\n### Output of checks\n#### Results of GitLab environment info\n```sh\n$ gitlab-rake gitlab:env:info\n\nSystem information\nSystem:         Ubuntu 18.04\nProxy:          no\nCurrent User:   git\nUsing RVM:      no\nRuby Version:   2.5.3p105\nGem Version:    2.7.6\nBundler Version:1.16.6\nRake Version:   12.3.2\nRedis Version:  3.2.12\nGit Version:    2.18.1\nSidekiq Version:5.2.5\nGo Version:     unknown\n\nGitLab information\nVersion:        11.9.8-ee\nRevision:       c9701808101\nDirectory:      /opt/gitlab/embedded/service/gitlab-rails\nDB Adapter:     postgresql\nDB Version:     9.6.11\nURL:            https://gitlabext.webhooks.pw\nHTTP Clone URL: https://gitlabext.webhooks.pw/some-group/some-project.git\nSSH Clone URL:  git@gitlabext.webhooks.pw:some-group/some-project.git\nElasticsearch:  no\nGeo:            no\nUsing LDAP:     no\nUsing Omniauth: yes\nOmniauth Providers:\n\nGitLab Shell\nVersion:        8.7.1\nRepository storage paths:\n- default:      /var/opt/gitlab/git-data/repositories\nGitLab Shell path:              /opt/gitlab/embedded/service/gitlab-shell\nGit:            /opt/gitlab/embedded/bin/git\n```\n\nI have confirmed this issue on both the official Docker image and the official `gitlab-ee` Ubuntu package (using installation instructions from https://about.gitlab.com/install/#ubuntu).\n\n## Impact\n\nThis issue allows a malicious authenticated user to send GET and POST HTTP requests from the GitLab server to arbitrary hosts (including the localhost, cloud metadata services and the local network) with arbitrary paths, and read the HTTP response. This could be abused to compromise the host (e.g. leaking AWS tokens from the metadata service), or perform reconnaissance and exploitation of hosts on the local network.","vulnerability_information_html":"\u003ch3 id=\"summary\"\u003eSummary\u003c/h3\u003e\n\n\u003cp\u003eThe \u003ccode\u003eGitLab::UrlBlocker\u003c/code\u003e IP address validation methods suffer from a Time of Check to Time of Use (ToCToU) vulnerability. The vulnerability occurs due to multiple DNS resolution requests performed before and after the checks. This issue allows a malicious authenticated user to send GET and POST HTTP requests to arbitrary hosts, including the localhost, cloud metadata services and the local network, and read the HTTP response.\u003c/p\u003e\n\n\u003ch3 id=\"details\"\u003eDetails\u003c/h3\u003e\n\n\u003cp\u003eThe IP address validation code in \u003ccode\u003e/lib/gitlab/url_blocker.rb\u003c/code\u003e resolves the IP addresses of the provided URL domain, raises an exception if the resolved IP addresses match addresses in block lists (\u003ccode\u003e127.0.0.1\u003c/code\u003e, \u003ccode\u003e::1\u003c/code\u003e, \u003ccode\u003e169.254.0.0/16\u003c/code\u003e, etc.) or returns \u003ccode\u003etrue\u003c/code\u003e if the IP address do not match the block lists.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight ruby\"\u003e\u003ccode\u003e  \u003cspan class=\"k\"\u003ebegin\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eaddrs_info\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003eAddrinfo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003egetaddrinfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euri\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ehostname\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eport\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kp\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"ss\"\u003e:STREAM\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003emap\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"n\"\u003eaddr\u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\n      \u003cspan class=\"n\"\u003eaddr\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eipv6_v4mapped?\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"n\"\u003eaddr\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eipv6_to_ipv4\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eaddr\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n  \u003cspan class=\"k\"\u003erescue\u003c/span\u003e \u003cspan class=\"no\"\u003eSocketError\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"kp\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\n  \u003cspan class=\"n\"\u003evalidate_localhost!\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eaddrs_info\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003eunless\u003c/span\u003e \u003cspan class=\"n\"\u003eallow_localhost\u003c/span\u003e\n  \u003cspan class=\"n\"\u003evalidate_loopback!\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eaddrs_info\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003eunless\u003c/span\u003e \u003cspan class=\"n\"\u003eallow_localhost\u003c/span\u003e\n  \u003cspan class=\"n\"\u003evalidate_local_network!\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eaddrs_info\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003eunless\u003c/span\u003e \u003cspan class=\"n\"\u003eallow_local_network\u003c/span\u003e\n  \u003cspan class=\"n\"\u003evalidate_link_local!\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eaddrs_info\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003eunless\u003c/span\u003e \u003cspan class=\"n\"\u003eallow_local_network\u003c/span\u003e\n\n  \u003cspan class=\"kp\"\u003etrue\u003c/span\u003e\n\u003cspan class=\"k\"\u003eend\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eIf the address validates the \u003ccode\u003eGitLab::HTTP\u003c/code\u003e code then uses \u003ccode\u003eHTTParty\u003c/code\u003e to request the URL, which performs a second URL domain DNS resolution. The address validation checks can be bypassed if the URL domain resolves to a valid address for the first resolution then a forbidden address after the checks are performed. \u003c/p\u003e\n\n\u003cp\u003eIn order to perform this attack a DNS server must be configured to resolve a domain to alternating addresses with a low (or zero) Time To Live. To demonstrate this issue I used my researchersservers project (\u003ca title=\"https://github.com/ajxchapman/sshreverseshell\" href=\"/redirect?url=https%3A%2F%2Fgithub.com%2Fajxchapman%2Fsshreverseshell\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://github.com/ajxchapman/sshreverseshell\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e) with the configuration in \u003ca class=\"markdown-attachment-link markdown-attachment-reference\" data-attachment-filename=\"41_gitlab.json\" data-attachment-link=\"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/470/655/dde8d1548d92ff35d1c94fab303b8ff2492831aa/41_gitlab.json?response-content-disposition=attachment%3B%20filename%3D%2241_gitlab.json%22%3B%20filename%2A%3DUTF-8%27%2741_gitlab.json\u0026amp;response-content-type=text%2Fplain\u0026amp;X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026amp;X-Amz-Credential=ASIAQGK6FURQSUJSTWNA%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026amp;X-Amz-Date=20201229T061636Z\u0026amp;X-Amz-Expires=3600\u0026amp;X-Amz-SignedHeaders=host\u0026amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDC4LZo82wc2eCvBFlhjwE027CwJoHB88%2BMK2v03JEf7AIgTsNTuR7XI5zLkpcU%2F192zliPMALv25wXWHyoW56mHW0qtAMIVRABGgwwMTM2MTkyNzQ4NDkiDDQxd6Ep%2FudaJolhjiqRA%2FV9m3Q5qTHiEf%2B0F56QxIa0FX4xcw3kyVQ754zuEWG6%2FFHm5u50c%2FkjIZTK4iokf%2F5bg8%2F9lzPcfaf%2FlyMeeuZQiIR66c8Q0ZynlQYFFg39COCCRcmQH0rk4Py7SioeZK1WX50szdnMCAEBM0%2FYGIJRFlpJYz5%2BF7cuCEDZDVFz70QPaeLM9Aq2Hp0OWlaD%2BlKU2Ya8oXmKGTVLeV6xTf66mRdzvW8I4qKgZpByKnAcip5WWnkttPjUxPiLaEeZ%2BClnUyHZas2bB1iPmPH0rQXcKWbTOq%2BJJm8xX%2FgqtqSgjGTmncJVZJxe0UaRUPXS%2BxPh0KYERT9Te4D5sREOcmaPJ0lojWm5AuNIxK3S30FeTamdldG5jOgcjm7r6e2HjWcB7yfe4%2BCsYd2eVLbbXk95jZRHQohr%2B7Z9YEqq00TUANe07BXm%2FKoAPBMy0bYQHYmVJaGS31XhmN6DRKUn5mwwU6NQ87eIymigu48swQSaSOa0S3Ve15n99tYKCLxw%2FqcLrXK9DmAPRXyB2cTH85tpMJ7Qqv8FOusB0TY7T%2F8PPlS9Pw17cj5sLPnZSdHFb4OJ7xNuArhvZUxC%2FDdQIpfgbN40hDHy3r94ejzq63ULcWroBoxExSJ8F%2BIqLrT2jEE%2BHYV9rJ3uN20mlrWN07M1wfpVQeu7mZyiWu%2BTKEOjyLznji7d3Efn7A1SwzF%2FWi11RcA9%2BGeNTFCiOeyJRV4JWopx6NNi8TVr6hBraJmZeqXIUCIj4yW%2BvdbZ%2F7b%2BDWNq1S8BMna3Htt9r6lmeANRYdDH%2BkiA2F6n7nJrrrNm3hF7NHjHy1GdUin3XffXKseDfHdRNqxNelH1SrChi2zziLtHrQ%3D%3D\u0026amp;X-Amz-Signature=04501e929c3d15e4794d8f23bdd0bbc568e21768afd7c4694064efaed32a4677\" data-attachment-type=\"text/plain\"\u003e41_gitlab.json (F470655)\u003c/a\u003e. Output of resolving \u003ccode\u003egitlabextssrf.webhooks.pw\u003c/code\u003e against this DNS resolver configuration is shown below:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight shell\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003edig +noall +answer gitlabextssrf.webhooks.pw\ngitlabextssrf.webhooks.pw. 0    IN      A       198.211.125.160\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003edig +noall +answer gitlabextssrf.webhooks.pw\ngitlabextssrf.webhooks.pw. 0    IN      A       198.211.125.160\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003edig +noall +answer gitlabextssrf.webhooks.pw\ngitlabextssrf.webhooks.pw. 0    IN      A       127.0.0.1\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003edig +noall +answer gitlabextssrf.webhooks.pw\ngitlabextssrf.webhooks.pw. 0    IN      A       127.0.0.1\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003edig +noall +answer gitlabextssrf.webhooks.pw\ngitlabextssrf.webhooks.pw. 0    IN      A       198.211.125.160\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eNotice the alternating resolved IP address and 0 ttl.\u003c/p\u003e\n\n\u003ch3 id=\"attack-scenario\"\u003eAttack scenario\u003c/h3\u003e\n\n\u003cp\u003eUsing the Web Hook integration functionality of a GitLab repository, this issue can be abused to send HTTP GET and POST requests to arbitrary IP addresses, with arbitrary path parameters. The following screenshot shows the response of an HTTP GET request to \u003ccode\u003ehttp://169.254.169.254/metadata/v1.json\u003c/code\u003e on a DigitalOcean droplet:\u003cbr\u003e\n\u003ca class=\"markdown-attachment-link markdown-attachment-inline-reference\" data-attachment-filename=\"Screenshot_from_2019-04-17_09-18-49.png\" data-attachment-link=\"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/470/641/30a1794b8ace50c8dab24743c5eb0336b4e3366f/Screenshot_from_2019-04-17_09-18-49.png?response-content-disposition=attachment%3B%20filename%3D%22Screenshot_from_2019-04-17_09-18-49.png%22%3B%20filename%2A%3DUTF-8%27%27Screenshot_from_2019-04-17_09-18-49.png\u0026amp;response-content-type=image%2Fpng\u0026amp;X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026amp;X-Amz-Credential=ASIAQGK6FURQSUJSTWNA%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026amp;X-Amz-Date=20201229T061636Z\u0026amp;X-Amz-Expires=3600\u0026amp;X-Amz-SignedHeaders=host\u0026amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDC4LZo82wc2eCvBFlhjwE027CwJoHB88%2BMK2v03JEf7AIgTsNTuR7XI5zLkpcU%2F192zliPMALv25wXWHyoW56mHW0qtAMIVRABGgwwMTM2MTkyNzQ4NDkiDDQxd6Ep%2FudaJolhjiqRA%2FV9m3Q5qTHiEf%2B0F56QxIa0FX4xcw3kyVQ754zuEWG6%2FFHm5u50c%2FkjIZTK4iokf%2F5bg8%2F9lzPcfaf%2FlyMeeuZQiIR66c8Q0ZynlQYFFg39COCCRcmQH0rk4Py7SioeZK1WX50szdnMCAEBM0%2FYGIJRFlpJYz5%2BF7cuCEDZDVFz70QPaeLM9Aq2Hp0OWlaD%2BlKU2Ya8oXmKGTVLeV6xTf66mRdzvW8I4qKgZpByKnAcip5WWnkttPjUxPiLaEeZ%2BClnUyHZas2bB1iPmPH0rQXcKWbTOq%2BJJm8xX%2FgqtqSgjGTmncJVZJxe0UaRUPXS%2BxPh0KYERT9Te4D5sREOcmaPJ0lojWm5AuNIxK3S30FeTamdldG5jOgcjm7r6e2HjWcB7yfe4%2BCsYd2eVLbbXk95jZRHQohr%2B7Z9YEqq00TUANe07BXm%2FKoAPBMy0bYQHYmVJaGS31XhmN6DRKUn5mwwU6NQ87eIymigu48swQSaSOa0S3Ve15n99tYKCLxw%2FqcLrXK9DmAPRXyB2cTH85tpMJ7Qqv8FOusB0TY7T%2F8PPlS9Pw17cj5sLPnZSdHFb4OJ7xNuArhvZUxC%2FDdQIpfgbN40hDHy3r94ejzq63ULcWroBoxExSJ8F%2BIqLrT2jEE%2BHYV9rJ3uN20mlrWN07M1wfpVQeu7mZyiWu%2BTKEOjyLznji7d3Efn7A1SwzF%2FWi11RcA9%2BGeNTFCiOeyJRV4JWopx6NNi8TVr6hBraJmZeqXIUCIj4yW%2BvdbZ%2F7b%2BDWNq1S8BMna3Htt9r6lmeANRYdDH%2BkiA2F6n7nJrrrNm3hF7NHjHy1GdUin3XffXKseDfHdRNqxNelH1SrChi2zziLtHrQ%3D%3D\u0026amp;X-Amz-Signature=ad33e15bbdc737f03398cf5e4a642d33d2ec4a2023fcb3a50037ca728b809000\" data-attachment-type=\"image/png\"\u003e\u003cimg src=\"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/470/641/30a1794b8ace50c8dab24743c5eb0336b4e3366f/Screenshot_from_2019-04-17_09-18-49.png?response-content-disposition=attachment%3B%20filename%3D%22Screenshot_from_2019-04-17_09-18-49.png%22%3B%20filename%2A%3DUTF-8%27%27Screenshot_from_2019-04-17_09-18-49.png\u0026amp;response-content-type=image%2Fpng\u0026amp;X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026amp;X-Amz-Credential=ASIAQGK6FURQSUJSTWNA%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026amp;X-Amz-Date=20201229T061636Z\u0026amp;X-Amz-Expires=3600\u0026amp;X-Amz-SignedHeaders=host\u0026amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDC4LZo82wc2eCvBFlhjwE027CwJoHB88%2BMK2v03JEf7AIgTsNTuR7XI5zLkpcU%2F192zliPMALv25wXWHyoW56mHW0qtAMIVRABGgwwMTM2MTkyNzQ4NDkiDDQxd6Ep%2FudaJolhjiqRA%2FV9m3Q5qTHiEf%2B0F56QxIa0FX4xcw3kyVQ754zuEWG6%2FFHm5u50c%2FkjIZTK4iokf%2F5bg8%2F9lzPcfaf%2FlyMeeuZQiIR66c8Q0ZynlQYFFg39COCCRcmQH0rk4Py7SioeZK1WX50szdnMCAEBM0%2FYGIJRFlpJYz5%2BF7cuCEDZDVFz70QPaeLM9Aq2Hp0OWlaD%2BlKU2Ya8oXmKGTVLeV6xTf66mRdzvW8I4qKgZpByKnAcip5WWnkttPjUxPiLaEeZ%2BClnUyHZas2bB1iPmPH0rQXcKWbTOq%2BJJm8xX%2FgqtqSgjGTmncJVZJxe0UaRUPXS%2BxPh0KYERT9Te4D5sREOcmaPJ0lojWm5AuNIxK3S30FeTamdldG5jOgcjm7r6e2HjWcB7yfe4%2BCsYd2eVLbbXk95jZRHQohr%2B7Z9YEqq00TUANe07BXm%2FKoAPBMy0bYQHYmVJaGS31XhmN6DRKUn5mwwU6NQ87eIymigu48swQSaSOa0S3Ve15n99tYKCLxw%2FqcLrXK9DmAPRXyB2cTH85tpMJ7Qqv8FOusB0TY7T%2F8PPlS9Pw17cj5sLPnZSdHFb4OJ7xNuArhvZUxC%2FDdQIpfgbN40hDHy3r94ejzq63ULcWroBoxExSJ8F%2BIqLrT2jEE%2BHYV9rJ3uN20mlrWN07M1wfpVQeu7mZyiWu%2BTKEOjyLznji7d3Efn7A1SwzF%2FWi11RcA9%2BGeNTFCiOeyJRV4JWopx6NNi8TVr6hBraJmZeqXIUCIj4yW%2BvdbZ%2F7b%2BDWNq1S8BMna3Htt9r6lmeANRYdDH%2BkiA2F6n7nJrrrNm3hF7NHjHy1GdUin3XffXKseDfHdRNqxNelH1SrChi2zziLtHrQ%3D%3D\u0026amp;X-Amz-Signature=ad33e15bbdc737f03398cf5e4a642d33d2ec4a2023fcb3a50037ca728b809000\" class=\"markdown-inline-image\" style=\"display: inline-block\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3 id=\"steps-to-reproduce\"\u003eSteps to reproduce\u003c/h3\u003e\n\n\u003cp\u003eTo demonstrate this issue I have configured the domain \u003ccode\u003egitladextssrf.webhooks.pw\u003c/code\u003e to randomly resolve to either \u003ccode\u003e198.211.125.160\u003c/code\u003e or \u003ccode\u003e127.0.0.1\u003c/code\u003e.\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003eCreate a new repository\u003c/li\u003e\n\u003cli\u003eAdd a commit to the repository\u003c/li\u003e\n\u003cli\u003eCreate a new Web Hook integration with the URL \u003ca title=\"http://gitlabextssrf.webhooks.pw:9999\" href=\"/redirect?url=http%3A%2F%2Fgitlabextssrf.webhooks.pw%3A9999\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttp://gitlabextssrf.webhooks.pw:9999\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e.\n\n\u003cul\u003e\n\u003cli\u003eThis may take several attempts due to the random nature of the \u003ccode\u003egitlabextssrf.webhooks.pw\u003c/code\u003e DNS resolver, if it fails with a \u003ccode\u003e500\u003c/code\u003e error, try again until it is accepted.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eLog into the gitlab server and start a TCP listener on port 9999/tcp (e.g. \u003ccode\u003enc -vvn -l -p 9999\u003c/code\u003e)\u003c/li\u003e\n\u003cli\u003ePerform numerous parallel requests to the Web Hook test endpoint. For this I use \u003ccode\u003ewfuzz\u003c/code\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight shell\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./wfuzz \u003cspan class=\"nt\"\u003e-X\u003c/span\u003e POST \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n  \u003cspan class=\"nt\"\u003e-b\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;_gitlab_session=\u0026lt;session_id\u0026gt;;\u0026quot;\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n  \u003cspan class=\"nt\"\u003e-d\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;_method=post\u0026amp;authenticity_token=\u0026lt;token\u0026gt;\u0026quot;\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n  \u003cspan class=\"nt\"\u003e-z\u003c/span\u003e range,0-1000 \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n  \u003cspan class=\"s2\"\u003e\u0026quot;https://\u0026lt;domain\u0026gt;/\u0026lt;user\u0026gt;/\u0026lt;repo\u0026gt;/hooks/\u0026lt;hook_id\u0026gt;/test?trigger=push_events\u0026amp;test=FUZZ\u0026quot;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe the below video demonstration of reproducing this issue:\u003cbr\u003e\n\u003ca class=\"markdown-attachment-link markdown-attachment-inline-reference\" data-attachment-filename=\"gitlab_ssrf.mp4\" data-attachment-link=\"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/470/642/b1de89da2206e6799e15728bb745fefa9ae0081e/gitlab_ssrf.mp4?response-content-disposition=attachment%3B%20filename%3D%22gitlab_ssrf.mp4%22%3B%20filename%2A%3DUTF-8%27%27gitlab_ssrf.mp4\u0026amp;response-content-type=video%2Fmp4\u0026amp;X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026amp;X-Amz-Credential=ASIAQGK6FURQSUJSTWNA%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026amp;X-Amz-Date=20201229T061636Z\u0026amp;X-Amz-Expires=3600\u0026amp;X-Amz-SignedHeaders=host\u0026amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDC4LZo82wc2eCvBFlhjwE027CwJoHB88%2BMK2v03JEf7AIgTsNTuR7XI5zLkpcU%2F192zliPMALv25wXWHyoW56mHW0qtAMIVRABGgwwMTM2MTkyNzQ4NDkiDDQxd6Ep%2FudaJolhjiqRA%2FV9m3Q5qTHiEf%2B0F56QxIa0FX4xcw3kyVQ754zuEWG6%2FFHm5u50c%2FkjIZTK4iokf%2F5bg8%2F9lzPcfaf%2FlyMeeuZQiIR66c8Q0ZynlQYFFg39COCCRcmQH0rk4Py7SioeZK1WX50szdnMCAEBM0%2FYGIJRFlpJYz5%2BF7cuCEDZDVFz70QPaeLM9Aq2Hp0OWlaD%2BlKU2Ya8oXmKGTVLeV6xTf66mRdzvW8I4qKgZpByKnAcip5WWnkttPjUxPiLaEeZ%2BClnUyHZas2bB1iPmPH0rQXcKWbTOq%2BJJm8xX%2FgqtqSgjGTmncJVZJxe0UaRUPXS%2BxPh0KYERT9Te4D5sREOcmaPJ0lojWm5AuNIxK3S30FeTamdldG5jOgcjm7r6e2HjWcB7yfe4%2BCsYd2eVLbbXk95jZRHQohr%2B7Z9YEqq00TUANe07BXm%2FKoAPBMy0bYQHYmVJaGS31XhmN6DRKUn5mwwU6NQ87eIymigu48swQSaSOa0S3Ve15n99tYKCLxw%2FqcLrXK9DmAPRXyB2cTH85tpMJ7Qqv8FOusB0TY7T%2F8PPlS9Pw17cj5sLPnZSdHFb4OJ7xNuArhvZUxC%2FDdQIpfgbN40hDHy3r94ejzq63ULcWroBoxExSJ8F%2BIqLrT2jEE%2BHYV9rJ3uN20mlrWN07M1wfpVQeu7mZyiWu%2BTKEOjyLznji7d3Efn7A1SwzF%2FWi11RcA9%2BGeNTFCiOeyJRV4JWopx6NNi8TVr6hBraJmZeqXIUCIj4yW%2BvdbZ%2F7b%2BDWNq1S8BMna3Htt9r6lmeANRYdDH%2BkiA2F6n7nJrrrNm3hF7NHjHy1GdUin3XffXKseDfHdRNqxNelH1SrChi2zziLtHrQ%3D%3D\u0026amp;X-Amz-Signature=b7e4c77ac9ab77c02824a98c06fd5bcfc8b69f66ede8005629e67a77d3fc673a\" data-attachment-type=\"video/mp4\"\u003e\u003cvideo controls=\"controls\" src=\"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/470/642/b1de89da2206e6799e15728bb745fefa9ae0081e/gitlab_ssrf.mp4?response-content-disposition=attachment%3B%20filename%3D%22gitlab_ssrf.mp4%22%3B%20filename%2A%3DUTF-8%27%27gitlab_ssrf.mp4\u0026amp;response-content-type=video%2Fmp4\u0026amp;X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026amp;X-Amz-Credential=ASIAQGK6FURQSUJSTWNA%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026amp;X-Amz-Date=20201229T061636Z\u0026amp;X-Amz-Expires=3600\u0026amp;X-Amz-SignedHeaders=host\u0026amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDC4LZo82wc2eCvBFlhjwE027CwJoHB88%2BMK2v03JEf7AIgTsNTuR7XI5zLkpcU%2F192zliPMALv25wXWHyoW56mHW0qtAMIVRABGgwwMTM2MTkyNzQ4NDkiDDQxd6Ep%2FudaJolhjiqRA%2FV9m3Q5qTHiEf%2B0F56QxIa0FX4xcw3kyVQ754zuEWG6%2FFHm5u50c%2FkjIZTK4iokf%2F5bg8%2F9lzPcfaf%2FlyMeeuZQiIR66c8Q0ZynlQYFFg39COCCRcmQH0rk4Py7SioeZK1WX50szdnMCAEBM0%2FYGIJRFlpJYz5%2BF7cuCEDZDVFz70QPaeLM9Aq2Hp0OWlaD%2BlKU2Ya8oXmKGTVLeV6xTf66mRdzvW8I4qKgZpByKnAcip5WWnkttPjUxPiLaEeZ%2BClnUyHZas2bB1iPmPH0rQXcKWbTOq%2BJJm8xX%2FgqtqSgjGTmncJVZJxe0UaRUPXS%2BxPh0KYERT9Te4D5sREOcmaPJ0lojWm5AuNIxK3S30FeTamdldG5jOgcjm7r6e2HjWcB7yfe4%2BCsYd2eVLbbXk95jZRHQohr%2B7Z9YEqq00TUANe07BXm%2FKoAPBMy0bYQHYmVJaGS31XhmN6DRKUn5mwwU6NQ87eIymigu48swQSaSOa0S3Ve15n99tYKCLxw%2FqcLrXK9DmAPRXyB2cTH85tpMJ7Qqv8FOusB0TY7T%2F8PPlS9Pw17cj5sLPnZSdHFb4OJ7xNuArhvZUxC%2FDdQIpfgbN40hDHy3r94ejzq63ULcWroBoxExSJ8F%2BIqLrT2jEE%2BHYV9rJ3uN20mlrWN07M1wfpVQeu7mZyiWu%2BTKEOjyLznji7d3Efn7A1SwzF%2FWi11RcA9%2BGeNTFCiOeyJRV4JWopx6NNi8TVr6hBraJmZeqXIUCIj4yW%2BvdbZ%2F7b%2BDWNq1S8BMna3Htt9r6lmeANRYdDH%2BkiA2F6n7nJrrrNm3hF7NHjHy1GdUin3XffXKseDfHdRNqxNelH1SrChi2zziLtHrQ%3D%3D\u0026amp;X-Amz-Signature=b7e4c77ac9ab77c02824a98c06fd5bcfc8b69f66ede8005629e67a77d3fc673a\" class=\"markdown-inline-image\" style=\"display: inline-block\"\u003e\u003c/video\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eAfter several requests a connection will be made to the local TCP listener on port 9999/tcp.\u003c/p\u003e\n\n\u003ch3 id=\"impact\"\u003eImpact\u003c/h3\u003e\n\n\u003cp\u003eThis issue allows a malicious authenticated user to send GET and POST HTTP requests from the GitLab server to arbitrary hosts (including the localhost, cloud metadata services and the local network) with arbitrary paths, and read the HTTP response. This could be abused to compromise the host (e.g. leaking AWS tokens from the metadata service), or perform reconnaissance and exploitation of hosts on the local network.\u003c/p\u003e\n\n\u003ch3 id=\"what-is-the-current-bug-behavior\"\u003eWhat is the current \u003cem\u003ebug\u003c/em\u003e behavior?\u003c/h3\u003e\n\n\u003cp\u003eThe \u003ccode\u003eGitLab::UrlBlocker\u003c/code\u003e validation code resolves the IP addresses of a URL domain, validates them against a series of block lists, and if valid returns to the \u003ccode\u003eGitLab::HTTP\u003c/code\u003e module which re-resolves the URL domain in order to perform the HTTP request.\u003c/p\u003e\n\n\u003ch3 id=\"what-is-the-expected-correct-behavior\"\u003eWhat is the expected \u003cem\u003ecorrect\u003c/em\u003e behavior?\u003c/h3\u003e\n\n\u003cp\u003eThe validated resolved addresses should be returned by \u003ccode\u003eGitLab::UrlBlocker\u003c/code\u003e and used by \u003ccode\u003eGitLab::HTTP\u003c/code\u003e to make the TCP connection to the destination host.\u003c/p\u003e\n\n\u003ch3 id=\"relevant-logs-and-or-screenshots\"\u003eRelevant logs and/or screenshots\u003c/h3\u003e\n\n\u003cp\u003eOutput of using the ToCToU bypass in a Web Hook to send a request to the DigitalOcean droplet meta data API \u003ccode\u003ehttp://169.254.169.254/metadata/v1.json\u003c/code\u003e endpoint:\u003cbr\u003e\n\u003ca class=\"markdown-attachment-link markdown-attachment-inline-reference\" data-attachment-filename=\"Screenshot_from_2019-04-17_09-18-49.png\" data-attachment-link=\"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/470/641/30a1794b8ace50c8dab24743c5eb0336b4e3366f/Screenshot_from_2019-04-17_09-18-49.png?response-content-disposition=attachment%3B%20filename%3D%22Screenshot_from_2019-04-17_09-18-49.png%22%3B%20filename%2A%3DUTF-8%27%27Screenshot_from_2019-04-17_09-18-49.png\u0026amp;response-content-type=image%2Fpng\u0026amp;X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026amp;X-Amz-Credential=ASIAQGK6FURQSUJSTWNA%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026amp;X-Amz-Date=20201229T061636Z\u0026amp;X-Amz-Expires=3600\u0026amp;X-Amz-SignedHeaders=host\u0026amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDC4LZo82wc2eCvBFlhjwE027CwJoHB88%2BMK2v03JEf7AIgTsNTuR7XI5zLkpcU%2F192zliPMALv25wXWHyoW56mHW0qtAMIVRABGgwwMTM2MTkyNzQ4NDkiDDQxd6Ep%2FudaJolhjiqRA%2FV9m3Q5qTHiEf%2B0F56QxIa0FX4xcw3kyVQ754zuEWG6%2FFHm5u50c%2FkjIZTK4iokf%2F5bg8%2F9lzPcfaf%2FlyMeeuZQiIR66c8Q0ZynlQYFFg39COCCRcmQH0rk4Py7SioeZK1WX50szdnMCAEBM0%2FYGIJRFlpJYz5%2BF7cuCEDZDVFz70QPaeLM9Aq2Hp0OWlaD%2BlKU2Ya8oXmKGTVLeV6xTf66mRdzvW8I4qKgZpByKnAcip5WWnkttPjUxPiLaEeZ%2BClnUyHZas2bB1iPmPH0rQXcKWbTOq%2BJJm8xX%2FgqtqSgjGTmncJVZJxe0UaRUPXS%2BxPh0KYERT9Te4D5sREOcmaPJ0lojWm5AuNIxK3S30FeTamdldG5jOgcjm7r6e2HjWcB7yfe4%2BCsYd2eVLbbXk95jZRHQohr%2B7Z9YEqq00TUANe07BXm%2FKoAPBMy0bYQHYmVJaGS31XhmN6DRKUn5mwwU6NQ87eIymigu48swQSaSOa0S3Ve15n99tYKCLxw%2FqcLrXK9DmAPRXyB2cTH85tpMJ7Qqv8FOusB0TY7T%2F8PPlS9Pw17cj5sLPnZSdHFb4OJ7xNuArhvZUxC%2FDdQIpfgbN40hDHy3r94ejzq63ULcWroBoxExSJ8F%2BIqLrT2jEE%2BHYV9rJ3uN20mlrWN07M1wfpVQeu7mZyiWu%2BTKEOjyLznji7d3Efn7A1SwzF%2FWi11RcA9%2BGeNTFCiOeyJRV4JWopx6NNi8TVr6hBraJmZeqXIUCIj4yW%2BvdbZ%2F7b%2BDWNq1S8BMna3Htt9r6lmeANRYdDH%2BkiA2F6n7nJrrrNm3hF7NHjHy1GdUin3XffXKseDfHdRNqxNelH1SrChi2zziLtHrQ%3D%3D\u0026amp;X-Amz-Signature=ad33e15bbdc737f03398cf5e4a642d33d2ec4a2023fcb3a50037ca728b809000\" data-attachment-type=\"image/png\"\u003e\u003cimg src=\"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/470/641/30a1794b8ace50c8dab24743c5eb0336b4e3366f/Screenshot_from_2019-04-17_09-18-49.png?response-content-disposition=attachment%3B%20filename%3D%22Screenshot_from_2019-04-17_09-18-49.png%22%3B%20filename%2A%3DUTF-8%27%27Screenshot_from_2019-04-17_09-18-49.png\u0026amp;response-content-type=image%2Fpng\u0026amp;X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026amp;X-Amz-Credential=ASIAQGK6FURQSUJSTWNA%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026amp;X-Amz-Date=20201229T061636Z\u0026amp;X-Amz-Expires=3600\u0026amp;X-Amz-SignedHeaders=host\u0026amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDC4LZo82wc2eCvBFlhjwE027CwJoHB88%2BMK2v03JEf7AIgTsNTuR7XI5zLkpcU%2F192zliPMALv25wXWHyoW56mHW0qtAMIVRABGgwwMTM2MTkyNzQ4NDkiDDQxd6Ep%2FudaJolhjiqRA%2FV9m3Q5qTHiEf%2B0F56QxIa0FX4xcw3kyVQ754zuEWG6%2FFHm5u50c%2FkjIZTK4iokf%2F5bg8%2F9lzPcfaf%2FlyMeeuZQiIR66c8Q0ZynlQYFFg39COCCRcmQH0rk4Py7SioeZK1WX50szdnMCAEBM0%2FYGIJRFlpJYz5%2BF7cuCEDZDVFz70QPaeLM9Aq2Hp0OWlaD%2BlKU2Ya8oXmKGTVLeV6xTf66mRdzvW8I4qKgZpByKnAcip5WWnkttPjUxPiLaEeZ%2BClnUyHZas2bB1iPmPH0rQXcKWbTOq%2BJJm8xX%2FgqtqSgjGTmncJVZJxe0UaRUPXS%2BxPh0KYERT9Te4D5sREOcmaPJ0lojWm5AuNIxK3S30FeTamdldG5jOgcjm7r6e2HjWcB7yfe4%2BCsYd2eVLbbXk95jZRHQohr%2B7Z9YEqq00TUANe07BXm%2FKoAPBMy0bYQHYmVJaGS31XhmN6DRKUn5mwwU6NQ87eIymigu48swQSaSOa0S3Ve15n99tYKCLxw%2FqcLrXK9DmAPRXyB2cTH85tpMJ7Qqv8FOusB0TY7T%2F8PPlS9Pw17cj5sLPnZSdHFb4OJ7xNuArhvZUxC%2FDdQIpfgbN40hDHy3r94ejzq63ULcWroBoxExSJ8F%2BIqLrT2jEE%2BHYV9rJ3uN20mlrWN07M1wfpVQeu7mZyiWu%2BTKEOjyLznji7d3Efn7A1SwzF%2FWi11RcA9%2BGeNTFCiOeyJRV4JWopx6NNi8TVr6hBraJmZeqXIUCIj4yW%2BvdbZ%2F7b%2BDWNq1S8BMna3Htt9r6lmeANRYdDH%2BkiA2F6n7nJrrrNm3hF7NHjHy1GdUin3XffXKseDfHdRNqxNelH1SrChi2zziLtHrQ%3D%3D\u0026amp;X-Amz-Signature=ad33e15bbdc737f03398cf5e4a642d33d2ec4a2023fcb3a50037ca728b809000\" class=\"markdown-inline-image\" style=\"display: inline-block\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3 id=\"output-of-checks\"\u003eOutput of checks\u003c/h3\u003e\n\n\u003ch4 id=\"results-of-gitlab-environment-info\"\u003eResults of GitLab environment info\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight shell\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003egitlab-rake gitlab:env:info\n\nSystem information\nSystem:         Ubuntu 18.04\nProxy:          no\nCurrent User:   git\nUsing RVM:      no\nRuby Version:   2.5.3p105\nGem Version:    2.7.6\nBundler Version:1.16.6\nRake Version:   12.3.2\nRedis Version:  3.2.12\nGit Version:    2.18.1\nSidekiq Version:5.2.5\nGo Version:     unknown\n\nGitLab information\nVersion:        11.9.8-ee\nRevision:       c9701808101\nDirectory:      /opt/gitlab/embedded/service/gitlab-rails\nDB Adapter:     postgresql\nDB Version:     9.6.11\nURL:            https://gitlabext.webhooks.pw\nHTTP Clone URL: https://gitlabext.webhooks.pw/some-group/some-project.git\nSSH Clone URL:  git@gitlabext.webhooks.pw:some-group/some-project.git\nElasticsearch:  no\nGeo:            no\nUsing LDAP:     no\nUsing Omniauth: \u003cspan class=\"nb\"\u003eyes\n\u003c/span\u003eOmniauth Providers:\n\nGitLab Shell\nVersion:        8.7.1\nRepository storage paths:\n- default:      /var/opt/gitlab/git-data/repositories\nGitLab Shell path:              /opt/gitlab/embedded/service/gitlab-shell\nGit:            /opt/gitlab/embedded/bin/git\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eI have confirmed this issue on both the official Docker image and the official \u003ccode\u003egitlab-ee\u003c/code\u003e Ubuntu package (using installation instructions from \u003ca title=\"https://about.gitlab.com/install/#ubuntu\" href=\"/redirect?url=https%3A%2F%2Fabout.gitlab.com%2Finstall%2F%23ubuntu\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://about.gitlab.com/install/#ubuntu\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e).\u003c/p\u003e\n\n\u003ch2 id=\"impact\"\u003eImpact\u003c/h2\u003e\n\n\u003cp\u003eThis issue allows a malicious authenticated user to send GET and POST HTTP requests from the GitLab server to arbitrary hosts (including the localhost, cloud metadata services and the local network) with arbitrary paths, and read the HTTP response. This could be abused to compromise the host (e.g. leaking AWS tokens from the metadata service), or perform reconnaissance and exploitation of hosts on the local network.\u003c/p\u003e\n","bounty_amount":"5000.0","formatted_bounty":"$5,000","weakness":{"id":68,"name":"Server-Side Request Forgery (SSRF)"},"original_report_id":null,"original_report_url":null,"attachments":[{"id":470641,"file_name":"Screenshot_from_2019-04-17_09-18-49.png","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/470/641/30a1794b8ace50c8dab24743c5eb0336b4e3366f/Screenshot_from_2019-04-17_09-18-49.png?response-content-disposition=attachment%3B%20filename%3D%22Screenshot_from_2019-04-17_09-18-49.png%22%3B%20filename%2A%3DUTF-8%27%27Screenshot_from_2019-04-17_09-18-49.png\u0026response-content-type=image%2Fpng\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQSUJSTWNA%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T061636Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDC4LZo82wc2eCvBFlhjwE027CwJoHB88%2BMK2v03JEf7AIgTsNTuR7XI5zLkpcU%2F192zliPMALv25wXWHyoW56mHW0qtAMIVRABGgwwMTM2MTkyNzQ4NDkiDDQxd6Ep%2FudaJolhjiqRA%2FV9m3Q5qTHiEf%2B0F56QxIa0FX4xcw3kyVQ754zuEWG6%2FFHm5u50c%2FkjIZTK4iokf%2F5bg8%2F9lzPcfaf%2FlyMeeuZQiIR66c8Q0ZynlQYFFg39COCCRcmQH0rk4Py7SioeZK1WX50szdnMCAEBM0%2FYGIJRFlpJYz5%2BF7cuCEDZDVFz70QPaeLM9Aq2Hp0OWlaD%2BlKU2Ya8oXmKGTVLeV6xTf66mRdzvW8I4qKgZpByKnAcip5WWnkttPjUxPiLaEeZ%2BClnUyHZas2bB1iPmPH0rQXcKWbTOq%2BJJm8xX%2FgqtqSgjGTmncJVZJxe0UaRUPXS%2BxPh0KYERT9Te4D5sREOcmaPJ0lojWm5AuNIxK3S30FeTamdldG5jOgcjm7r6e2HjWcB7yfe4%2BCsYd2eVLbbXk95jZRHQohr%2B7Z9YEqq00TUANe07BXm%2FKoAPBMy0bYQHYmVJaGS31XhmN6DRKUn5mwwU6NQ87eIymigu48swQSaSOa0S3Ve15n99tYKCLxw%2FqcLrXK9DmAPRXyB2cTH85tpMJ7Qqv8FOusB0TY7T%2F8PPlS9Pw17cj5sLPnZSdHFb4OJ7xNuArhvZUxC%2FDdQIpfgbN40hDHy3r94ejzq63ULcWroBoxExSJ8F%2BIqLrT2jEE%2BHYV9rJ3uN20mlrWN07M1wfpVQeu7mZyiWu%2BTKEOjyLznji7d3Efn7A1SwzF%2FWi11RcA9%2BGeNTFCiOeyJRV4JWopx6NNi8TVr6hBraJmZeqXIUCIj4yW%2BvdbZ%2F7b%2BDWNq1S8BMna3Htt9r6lmeANRYdDH%2BkiA2F6n7nJrrrNm3hF7NHjHy1GdUin3XffXKseDfHdRNqxNelH1SrChi2zziLtHrQ%3D%3D\u0026X-Amz-Signature=ad33e15bbdc737f03398cf5e4a642d33d2ec4a2023fcb3a50037ca728b809000","file_size":68517,"type":"image/png"},{"id":470642,"file_name":"gitlab_ssrf.mp4","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/470/642/b1de89da2206e6799e15728bb745fefa9ae0081e/gitlab_ssrf.mp4?response-content-disposition=attachment%3B%20filename%3D%22gitlab_ssrf.mp4%22%3B%20filename%2A%3DUTF-8%27%27gitlab_ssrf.mp4\u0026response-content-type=video%2Fmp4\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQSUJSTWNA%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T061636Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDC4LZo82wc2eCvBFlhjwE027CwJoHB88%2BMK2v03JEf7AIgTsNTuR7XI5zLkpcU%2F192zliPMALv25wXWHyoW56mHW0qtAMIVRABGgwwMTM2MTkyNzQ4NDkiDDQxd6Ep%2FudaJolhjiqRA%2FV9m3Q5qTHiEf%2B0F56QxIa0FX4xcw3kyVQ754zuEWG6%2FFHm5u50c%2FkjIZTK4iokf%2F5bg8%2F9lzPcfaf%2FlyMeeuZQiIR66c8Q0ZynlQYFFg39COCCRcmQH0rk4Py7SioeZK1WX50szdnMCAEBM0%2FYGIJRFlpJYz5%2BF7cuCEDZDVFz70QPaeLM9Aq2Hp0OWlaD%2BlKU2Ya8oXmKGTVLeV6xTf66mRdzvW8I4qKgZpByKnAcip5WWnkttPjUxPiLaEeZ%2BClnUyHZas2bB1iPmPH0rQXcKWbTOq%2BJJm8xX%2FgqtqSgjGTmncJVZJxe0UaRUPXS%2BxPh0KYERT9Te4D5sREOcmaPJ0lojWm5AuNIxK3S30FeTamdldG5jOgcjm7r6e2HjWcB7yfe4%2BCsYd2eVLbbXk95jZRHQohr%2B7Z9YEqq00TUANe07BXm%2FKoAPBMy0bYQHYmVJaGS31XhmN6DRKUn5mwwU6NQ87eIymigu48swQSaSOa0S3Ve15n99tYKCLxw%2FqcLrXK9DmAPRXyB2cTH85tpMJ7Qqv8FOusB0TY7T%2F8PPlS9Pw17cj5sLPnZSdHFb4OJ7xNuArhvZUxC%2FDdQIpfgbN40hDHy3r94ejzq63ULcWroBoxExSJ8F%2BIqLrT2jEE%2BHYV9rJ3uN20mlrWN07M1wfpVQeu7mZyiWu%2BTKEOjyLznji7d3Efn7A1SwzF%2FWi11RcA9%2BGeNTFCiOeyJRV4JWopx6NNi8TVr6hBraJmZeqXIUCIj4yW%2BvdbZ%2F7b%2BDWNq1S8BMna3Htt9r6lmeANRYdDH%2BkiA2F6n7nJrrrNm3hF7NHjHy1GdUin3XffXKseDfHdRNqxNelH1SrChi2zziLtHrQ%3D%3D\u0026X-Amz-Signature=b7e4c77ac9ab77c02824a98c06fd5bcfc8b69f66ede8005629e67a77d3fc673a","file_size":3640819,"type":"video/mp4"},{"id":470655,"file_name":"41_gitlab.json","expiring_url":"https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/000/470/655/dde8d1548d92ff35d1c94fab303b8ff2492831aa/41_gitlab.json?response-content-disposition=attachment%3B%20filename%3D%2241_gitlab.json%22%3B%20filename%2A%3DUTF-8%27%2741_gitlab.json\u0026response-content-type=text%2Fplain\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=ASIAQGK6FURQSUJSTWNA%2F20201229%2Fus-west-2%2Fs3%2Faws4_request\u0026X-Amz-Date=20201229T061636Z\u0026X-Amz-Expires=3600\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJz%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDC4LZo82wc2eCvBFlhjwE027CwJoHB88%2BMK2v03JEf7AIgTsNTuR7XI5zLkpcU%2F192zliPMALv25wXWHyoW56mHW0qtAMIVRABGgwwMTM2MTkyNzQ4NDkiDDQxd6Ep%2FudaJolhjiqRA%2FV9m3Q5qTHiEf%2B0F56QxIa0FX4xcw3kyVQ754zuEWG6%2FFHm5u50c%2FkjIZTK4iokf%2F5bg8%2F9lzPcfaf%2FlyMeeuZQiIR66c8Q0ZynlQYFFg39COCCRcmQH0rk4Py7SioeZK1WX50szdnMCAEBM0%2FYGIJRFlpJYz5%2BF7cuCEDZDVFz70QPaeLM9Aq2Hp0OWlaD%2BlKU2Ya8oXmKGTVLeV6xTf66mRdzvW8I4qKgZpByKnAcip5WWnkttPjUxPiLaEeZ%2BClnUyHZas2bB1iPmPH0rQXcKWbTOq%2BJJm8xX%2FgqtqSgjGTmncJVZJxe0UaRUPXS%2BxPh0KYERT9Te4D5sREOcmaPJ0lojWm5AuNIxK3S30FeTamdldG5jOgcjm7r6e2HjWcB7yfe4%2BCsYd2eVLbbXk95jZRHQohr%2B7Z9YEqq00TUANe07BXm%2FKoAPBMy0bYQHYmVJaGS31XhmN6DRKUn5mwwU6NQ87eIymigu48swQSaSOa0S3Ve15n99tYKCLxw%2FqcLrXK9DmAPRXyB2cTH85tpMJ7Qqv8FOusB0TY7T%2F8PPlS9Pw17cj5sLPnZSdHFb4OJ7xNuArhvZUxC%2FDdQIpfgbN40hDHy3r94ejzq63ULcWroBoxExSJ8F%2BIqLrT2jEE%2BHYV9rJ3uN20mlrWN07M1wfpVQeu7mZyiWu%2BTKEOjyLznji7d3Efn7A1SwzF%2FWi11RcA9%2BGeNTFCiOeyJRV4JWopx6NNi8TVr6hBraJmZeqXIUCIj4yW%2BvdbZ%2F7b%2BDWNq1S8BMna3Htt9r6lmeANRYdDH%2BkiA2F6n7nJrrrNm3hF7NHjHy1GdUin3XffXKseDfHdRNqxNelH1SrChi2zziLtHrQ%3D%3D\u0026X-Amz-Signature=04501e929c3d15e4794d8f23bdd0bbc568e21768afd7c4694064efaed32a4677","file_size":285,"type":"text/plain"}],"allow_singular_disclosure_at":null,"vote_count":60,"voters":["djcater","sat0shi","sultancad","sourc7","ajxchapman","dee-see","krevetk0","bull","mashoud1122","spam404","and 50 more..."],"severity":{"rating":"high","score":7.6,"author_type":"User","metrics":{"attack_vector":"network","attack_complexity":"low","privileges_required":"low","user_interaction":"none","scope":"unchanged","confidentiality":"high","integrity":"low","availability":"low"}},"structured_scope":{"databaseId":18138,"asset_type":"URL","asset_identifier":"gitlab.com","max_severity":"critical"},"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":4582663,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @ajxchapman,\n\nThank you for submitting this report. We will investigate the issue as soon as possible.\nDue to our current workload, we will get back within 20 business days with an update.\n\nPlease refrain from submitting your report or inquiring about its status through\nadditional channels, as this unnecessarily binds resources in the security team.\n\nBest regards,\nGitLab Security Team\n","markdown_message":"\u003cp\u003eHi \u003ca href=\"/ajxchapman\"\u003e@ajxchapman\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003eThank you for submitting this report. We will investigate the issue as soon as possible.\u003cbr\u003e\nDue to our current workload, we will get back within 20 business days with an update.\u003c/p\u003e\n\n\u003cp\u003ePlease refrain from submitting your report or inquiring about its status through\u003cbr\u003e\nadditional channels, as this unnecessarily binds resources in the security team.\u003c/p\u003e\n\n\u003cp\u003eBest regards,\u003cbr\u003e\nGitLab Security Team\u003c/p\u003e\n","automated_response":true,"created_at":"2019-04-17T09:21:08.187Z","updated_at":"2019-04-17T09:21:08.187Z","actor":{"username":"gitlab-securitybot","cleared":false,"url":"/gitlab-securitybot","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":true},{"id":4584361,"is_internal":false,"editable":false,"type":"Activities::BugDuplicate","message":"Hi @ajxchapman,\n\ngood finding, thank you for the well-written and thorough report! We recently received a similar report about DNS rebinding in GitLab, which unfortunately makes your report a duplicate. I added you as a participant to the original report.\n\nYou mentioned that it would be possible to access cloud metadata services. Did you find a way to access the GCP metadata endpoint on gitlab.com and obtain the response? Please let us know if you manage to escalate this finding in any way.\n\nBest regards,\nDennis","markdown_message":"\u003cp\u003eHi \u003ca href=\"/ajxchapman\"\u003e@ajxchapman\u003c/a\u003e,\u003c/p\u003e\n\n\u003cp\u003egood finding, thank you for the well-written and thorough report! We recently received a similar report about DNS rebinding in GitLab, which unfortunately makes your report a duplicate. I added you as a participant to the original report.\u003c/p\u003e\n\n\u003cp\u003eYou mentioned that it would be possible to access cloud metadata services. Did you find a way to access the GCP metadata endpoint on gitlab.com and obtain the response? Please let us know if you manage to escalate this finding in any way.\u003c/p\u003e\n\n\u003cp\u003eBest regards,\u003cbr\u003e\nDennis\u003c/p\u003e\n","automated_response":false,"created_at":"2019-04-17T14:28:02.800Z","updated_at":"2019-04-17T14:28:02.800Z","original_report_id":513098,"actor":{"username":"dappelt","cleared":false,"url":"/dappelt","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4589167,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thanks for the quick response @dappelt. I've not observed any way of getting at the GCP metadata service on gitlab.com at this time, to my understanding that requires a specific HTTP header to be set as well. If I come across any way of accessing this I'll let you know.\n\nThanks","markdown_message":"\u003cp\u003eThanks for the quick response \u003ca href=\"/dappelt\"\u003e@dappelt\u003c/a\u003e. I\u0026#39;ve not observed any way of getting at the GCP metadata service on gitlab.com at this time, to my understanding that requires a specific HTTP header to be set as well. If I come across any way of accessing this I\u0026#39;ll let you know.\u003c/p\u003e\n\n\u003cp\u003eThanks\u003c/p\u003e\n","automated_response":false,"created_at":"2019-04-18T07:58:16.021Z","updated_at":"2019-04-18T07:58:16.021Z","actor":{"username":"ajxchapman","cleared":true,"url":"/ajxchapman","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/141/831/67daf6985b76c1867ff3f442fe5910bb329ee0b4_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":4590459,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"The endpoint /v1beta1 does not require the GCP header, i.e. http://metadata.google.internal/computeMetadata/v1beta1\n\nHappy hunting","markdown_message":"\u003cp\u003eThe endpoint /v1beta1 does not require the GCP header, i.e. \u003ca title=\"http://metadata.google.internal/computeMetadata/v1beta1\" href=\"/redirect?url=http%3A%2F%2Fmetadata.google.internal%2FcomputeMetadata%2Fv1beta1\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttp://metadata.google.internal/computeMetadata/v1beta1\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eHappy hunting\u003c/p\u003e\n","automated_response":false,"created_at":"2019-04-18T09:33:28.077Z","updated_at":"2019-04-18T09:33:28.077Z","actor":{"username":"dappelt","cleared":false,"url":"/dappelt","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4994883,"is_internal":false,"editable":false,"type":"Activities::BugReopened","message":"","markdown_message":"","automated_response":false,"created_at":"2019-06-04T16:29:34.040Z","updated_at":"2019-06-04T16:29:34.040Z","actor":{"username":"estrike","cleared":false,"url":"/estrike","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4994927,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Hi @ajxchapman ,\n\nWe want to thank you again for this report. After some internal discussion, we have decided to award you with a $5000 bounty, as your report helped us to recognize that the GCP metadata token was available through this exploit. We built upon your steps to customize the attack to obtain our own tokens on `gitlab.com`. \n\nAs an immediate mitigation, we disabled the legacy GCP endpoint that would allow an attacker to obtain the token without a header. Most recently, we have patched the `GitLab::HTTP` library to use the validated IP address when making connections. This fix went out in GitLab 11.11.1.\n\nPlease let us know if you find that our patch does not mitigate your finding. For now, the issue will stay confidential as we work to address similar issues in other parts of the code base, but it will be made public 30 days after the final fix.\n\nWe look forward to your next report!\n\nBest regards,\nEthan\nSecurity Team | GitLab Inc.\n","markdown_message":"\u003cp\u003eHi \u003ca href=\"/ajxchapman\"\u003e@ajxchapman\u003c/a\u003e ,\u003c/p\u003e\n\n\u003cp\u003eWe want to thank you again for this report. After some internal discussion, we have decided to award you with a $5000 bounty, as your report helped us to recognize that the GCP metadata token was available through this exploit. We built upon your steps to customize the attack to obtain our own tokens on \u003ccode\u003egitlab.com\u003c/code\u003e. \u003c/p\u003e\n\n\u003cp\u003eAs an immediate mitigation, we disabled the legacy GCP endpoint that would allow an attacker to obtain the token without a header. Most recently, we have patched the \u003ccode\u003eGitLab::HTTP\u003c/code\u003e library to use the validated IP address when making connections. This fix went out in GitLab 11.11.1.\u003c/p\u003e\n\n\u003cp\u003ePlease let us know if you find that our patch does not mitigate your finding. For now, the issue will stay confidential as we work to address similar issues in other parts of the code base, but it will be made public 30 days after the final fix.\u003c/p\u003e\n\n\u003cp\u003eWe look forward to your next report!\u003c/p\u003e\n\n\u003cp\u003eBest regards,\u003cbr\u003e\nEthan\u003cbr\u003e\nSecurity Team | GitLab Inc.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-06-04T16:44:06.606Z","updated_at":"2019-06-04T16:44:06.606Z","actor":{"url":"/gitlab","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/000/264/8dd359f496ba6c5b97c5126dc86924a00fd7ef26_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"GitLab"}},"bounty_amount":"5000.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"gitlab","collaborator":{"username":"ajxchapman","url":"/ajxchapman"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":4994929,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Hi @ajxchapman ,\n\nI am going to mark this as Resolved, as the issue in `GitLab::UrlBlocker` has been addressed.\n\nThank you again,\nEthan\nSecurity Team | GitLab Inc.","markdown_message":"\u003cp\u003eHi \u003ca href=\"/ajxchapman\"\u003e@ajxchapman\u003c/a\u003e ,\u003c/p\u003e\n\n\u003cp\u003eI am going to mark this as Resolved, as the issue in \u003ccode\u003eGitLab::UrlBlocker\u003c/code\u003e has been addressed.\u003c/p\u003e\n\n\u003cp\u003eThank you again,\u003cbr\u003e\nEthan\u003cbr\u003e\nSecurity Team | GitLab Inc.\u003c/p\u003e\n","automated_response":false,"created_at":"2019-06-04T16:45:38.481Z","updated_at":"2019-06-04T16:45:38.481Z","actor":{"username":"estrike","cleared":false,"url":"/estrike","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"reporter":{"username":"ajxchapman","url":"/ajxchapman"},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":5002251,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi Team,  thank you for the update and reconsideration of this issue.\n\nMy initial attempts to attempt to access the GCP endpoints failed, I'm really glad you were able to build on this and further secure the GitLab platform.\n\nCheers","markdown_message":"\u003cp\u003eHi Team,  thank you for the update and reconsideration of this issue.\u003c/p\u003e\n\n\u003cp\u003eMy initial attempts to attempt to access the GCP endpoints failed, I\u0026#39;m really glad you were able to build on this and further secure the GitLab platform.\u003c/p\u003e\n\n\u003cp\u003eCheers\u003c/p\u003e\n","automated_response":false,"created_at":"2019-06-05T08:07:11.394Z","updated_at":"2019-06-05T08:07:11.394Z","actor":{"username":"ajxchapman","cleared":true,"url":"/ajxchapman","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/141/831/67daf6985b76c1867ff3f442fe5910bb329ee0b4_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":6522069,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Hi Team, can we disclose this issue?\n\nThanks","markdown_message":"\u003cp\u003eHi Team, can we disclose this issue?\u003c/p\u003e\n\n\u003cp\u003eThanks\u003c/p\u003e\n","automated_response":false,"created_at":"2019-12-11T10:18:56.292Z","updated_at":"2019-12-11T10:18:56.292Z","first_to_agree":true,"actor":{"username":"ajxchapman","cleared":true,"url":"/ajxchapman","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/141/831/67daf6985b76c1867ff3f442fe5910bb329ee0b4_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":6530473,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @ajxchapman - the attachments of your report might contain sensitive data. For example, the response from the metadata endpoint, IP addresses etc. Do you want to redact these or are you fine with disclosing the report as is?","markdown_message":"\u003cp\u003eHi \u003ca href=\"/ajxchapman\"\u003e@ajxchapman\u003c/a\u003e - the attachments of your report might contain sensitive data. For example, the response from the metadata endpoint, IP addresses etc. Do you want to redact these or are you fine with disclosing the report as is?\u003c/p\u003e\n","automated_response":false,"created_at":"2019-12-12T09:46:42.571Z","updated_at":"2019-12-12T09:46:42.571Z","actor":{"username":"dappelt","cleared":false,"url":"/dappelt","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6530786,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi @dappelt, thanks for checking. I have reviewed the report and attachments and am happy for them to be disclosed as is. Thanks!","markdown_message":"\u003cp\u003eHi \u003ca href=\"/dappelt\"\u003e@dappelt\u003c/a\u003e, thanks for checking. I have reviewed the report and attachments and am happy for them to be disclosed as is. Thanks!\u003c/p\u003e\n","automated_response":false,"created_at":"2019-12-12T10:41:40.900Z","updated_at":"2019-12-12T10:41:40.900Z","actor":{"username":"ajxchapman","cleared":true,"url":"/ajxchapman","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/141/831/67daf6985b76c1867ff3f442fe5910bb329ee0b4_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":6531170,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2019-12-12T11:56:05.053Z","updated_at":"2019-12-12T11:56:05.053Z","actor":{"username":"dappelt","cleared":false,"url":"/dappelt","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":6531171,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2019-12-12T11:56:05.192Z","updated_at":"2019-12-12T11:56:05.192Z","actor":{"username":"dappelt","cleared":false,"url":"/dappelt","profile_picture_urls":{"medium":"/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"},"hackerone_triager":false,"hackerone_employee":null},"genius_execution_id":null,"team_handle":"gitlab","actor_is_team_member":true,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}